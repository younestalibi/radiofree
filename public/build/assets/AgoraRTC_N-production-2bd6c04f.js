import{_ as zt,a as JI,h as Q2}from"./hoist-non-react-statics.cjs-a49bb17a.js";import{R as ji,r as yI,k as $_,l as Z2}from"./app-73405adc.js";import{_ as $2,a as tm,b as zI}from"./createClass-5d1a4de6.js";import{b as XI,a as II}from"./assertThisInitialized-a147f0d7.js";var tx={black:"#000",white:"#fff"};const Ku=tx;var ex={50:"#ffebee",100:"#ffcdd2",200:"#ef9a9a",300:"#e57373",400:"#ef5350",500:"#f44336",600:"#e53935",700:"#d32f2f",800:"#c62828",900:"#b71c1c",A100:"#ff8a80",A200:"#ff5252",A400:"#ff1744",A700:"#d50000"};const em=ex;var nx={50:"#fce4ec",100:"#f8bbd0",200:"#f48fb1",300:"#f06292",400:"#ec407a",500:"#e91e63",600:"#d81b60",700:"#c2185b",800:"#ad1457",900:"#880e4f",A100:"#ff80ab",A200:"#ff4081",A400:"#f50057",A700:"#c51162"};const nm=nx;var ix={50:"#e8eaf6",100:"#c5cae9",200:"#9fa8da",300:"#7986cb",400:"#5c6bc0",500:"#3f51b5",600:"#3949ab",700:"#303f9f",800:"#283593",900:"#1a237e",A100:"#8c9eff",A200:"#536dfe",A400:"#3d5afe",A700:"#304ffe"};const im=ix;var rx={50:"#e3f2fd",100:"#bbdefb",200:"#90caf9",300:"#64b5f6",400:"#42a5f5",500:"#2196f3",600:"#1e88e5",700:"#1976d2",800:"#1565c0",900:"#0d47a1",A100:"#82b1ff",A200:"#448aff",A400:"#2979ff",A700:"#2962ff"};const rm=rx;var sx={50:"#e8f5e9",100:"#c8e6c9",200:"#a5d6a7",300:"#81c784",400:"#66bb6a",500:"#4caf50",600:"#43a047",700:"#388e3c",800:"#2e7d32",900:"#1b5e20",A100:"#b9f6ca",A200:"#69f0ae",A400:"#00e676",A700:"#00c853"};const sm=sx;var ox={50:"#fff3e0",100:"#ffe0b2",200:"#ffcc80",300:"#ffb74d",400:"#ffa726",500:"#ff9800",600:"#fb8c00",700:"#f57c00",800:"#ef6c00",900:"#e65100",A100:"#ffd180",A200:"#ffab40",A400:"#ff9100",A700:"#ff6d00"};const om=ox;var ax={50:"#fafafa",100:"#f5f5f5",200:"#eeeeee",300:"#e0e0e0",400:"#bdbdbd",500:"#9e9e9e",600:"#757575",700:"#616161",800:"#424242",900:"#212121",A100:"#d5d5d5",A200:"#aaaaaa",A400:"#303030",A700:"#616161"};const Dm=ax;function am(I){return I&&$2(I)==="object"&&I.constructor===Object}function Sa(I,C){var y=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{clone:!0},g=y.clone?zt({},I):I;return am(I)&&am(C)&&Object.keys(C).forEach(function(b){b!=="__proto__"&&(am(C[b])&&b in I?g[b]=Sa(I[b],C[b],y):g[b]=C[b])}),g}function Sm(I){for(var C="https://mui.com/production-error/?code="+I,y=1;y<arguments.length;y+=1)C+="&args[]="+encodeURIComponent(arguments[y]);return"Minified Material-UI error #"+I+"; visit "+C+" for the full message."}function Pm(I){var C=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,y=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;return Math.min(Math.max(C,I),y)}function cx(I){I=I.substr(1);var C=new RegExp(".{1,".concat(I.length>=6?2:1,"}"),"g"),y=I.match(C);return y&&y[0].length===1&&(y=y.map(function(g){return g+g})),y?"rgb".concat(y.length===4?"a":"","(").concat(y.map(function(g,b){return b<3?parseInt(g,16):Math.round(parseInt(g,16)/255*1e3)/1e3}).join(", "),")"):""}function dx(I){I=po(I);var C=I,y=C.values,g=y[0],b=y[1]/100,D=y[2]/100,x=b*Math.min(D,1-D),H=function(ut){var wt=arguments.length>1&&arguments[1]!==void 0?arguments[1]:(ut+g/30)%12;return D-x*Math.max(Math.min(wt-3,9-wt,1),-1)},it="rgb",ht=[Math.round(H(0)*255),Math.round(H(8)*255),Math.round(H(4)*255)];return I.type==="hsla"&&(it+="a",ht.push(y[3])),qu({type:it,values:ht})}function po(I){if(I.type)return I;if(I.charAt(0)==="#")return po(cx(I));var C=I.indexOf("("),y=I.substring(0,C);if(["rgb","rgba","hsl","hsla"].indexOf(y)===-1)throw new Error(Sm(3,I));var g=I.substring(C+1,I.length-1).split(",");return g=g.map(function(b){return parseFloat(b)}),{type:y,values:g}}function qu(I){var C=I.type,y=I.values;return C.indexOf("rgb")!==-1?y=y.map(function(g,b){return b<3?parseInt(g,10):g}):C.indexOf("hsl")!==-1&&(y[1]="".concat(y[1],"%"),y[2]="".concat(y[2],"%")),"".concat(C,"(").concat(y.join(", "),")")}function ux(I,C){var y=AI(I),g=AI(C);return(Math.max(y,g)+.05)/(Math.min(y,g)+.05)}function AI(I){I=po(I);var C=I.type==="hsl"?po(dx(I)).values:I.values;return C=C.map(function(y){return y/=255,y<=.03928?y/12.92:Math.pow((y+.055)/1.055,2.4)}),Number((.2126*C[0]+.7152*C[1]+.0722*C[2]).toFixed(3))}function dB(I,C){return I=po(I),C=Pm(C),(I.type==="rgb"||I.type==="hsl")&&(I.type+="a"),I.values[3]=C,qu(I)}function lx(I,C){if(I=po(I),C=Pm(C),I.type.indexOf("hsl")!==-1)I.values[2]*=1-C;else if(I.type.indexOf("rgb")!==-1)for(var y=0;y<3;y+=1)I.values[y]*=1-C;return qu(I)}function hx(I,C){if(I=po(I),C=Pm(C),I.type.indexOf("hsl")!==-1)I.values[2]+=(100-I.values[2])*C;else if(I.type.indexOf("rgb")!==-1)for(var y=0;y<3;y+=1)I.values[y]+=(255-I.values[y])*C;return qu(I)}function Vr(I,C){if(I==null)return{};var y=JI(I,C),g,b;if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(I);for(b=0;b<D.length;b++)g=D[b],!(C.indexOf(g)>=0)&&Object.prototype.propertyIsEnumerable.call(I,g)&&(y[g]=I[g])}return y}var ys=["xs","sm","md","lg","xl"];function px(I){var C=I.values,y=C===void 0?{xs:0,sm:600,md:960,lg:1280,xl:1920}:C,g=I.unit,b=g===void 0?"px":g,D=I.step,x=D===void 0?5:D,H=Vr(I,["values","unit","step"]);function it(It){var vt=typeof y[It]=="number"?y[It]:It;return"@media (min-width:".concat(vt).concat(b,")")}function ht(It){var vt=ys.indexOf(It)+1,qt=y[ys[vt]];if(vt===ys.length)return it("xs");var Ie=typeof qt=="number"&&vt>0?qt:It;return"@media (max-width:".concat(Ie-x/100).concat(b,")")}function _t(It,vt){var qt=ys.indexOf(vt);return qt===ys.length-1?it(It):"@media (min-width:".concat(typeof y[It]=="number"?y[It]:It).concat(b,") and ")+"(max-width:".concat((qt!==-1&&typeof y[ys[qt+1]]=="number"?y[ys[qt+1]]:vt)-x/100).concat(b,")")}function ut(It){return _t(It,It)}function wt(It){return y[It]}return zt({keys:ys,values:y,up:it,down:ht,between:_t,only:ut,width:wt},H)}function _x(I,C,y){var g;return zt({gutters:function(){var D=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return console.warn(["Material-UI: theme.mixins.gutters() is deprecated.","You can use the source of the mixin directly:",`
      paddingLeft: theme.spacing(2),
      paddingRight: theme.spacing(2),
      [theme.breakpoints.up('sm')]: {
        paddingLeft: theme.spacing(3),
        paddingRight: theme.spacing(3),
      },
      `].join(`
`)),zt({paddingLeft:C(2),paddingRight:C(2)},D,tm({},I.up("sm"),zt({paddingLeft:C(3),paddingRight:C(3)},D[I.up("sm")])))},toolbar:(g={minHeight:56},tm(g,"".concat(I.up("xs")," and (orientation: landscape)"),{minHeight:48}),tm(g,I.up("sm"),{minHeight:64}),g)},y)}var bI={text:{primary:"rgba(0, 0, 0, 0.87)",secondary:"rgba(0, 0, 0, 0.54)",disabled:"rgba(0, 0, 0, 0.38)",hint:"rgba(0, 0, 0, 0.38)"},divider:"rgba(0, 0, 0, 0.12)",background:{paper:Ku.white,default:Dm[50]},action:{active:"rgba(0, 0, 0, 0.54)",hover:"rgba(0, 0, 0, 0.04)",hoverOpacity:.04,selected:"rgba(0, 0, 0, 0.08)",selectedOpacity:.08,disabled:"rgba(0, 0, 0, 0.26)",disabledBackground:"rgba(0, 0, 0, 0.12)",disabledOpacity:.38,focus:"rgba(0, 0, 0, 0.12)",focusOpacity:.12,activatedOpacity:.12}},cm={text:{primary:Ku.white,secondary:"rgba(255, 255, 255, 0.7)",disabled:"rgba(255, 255, 255, 0.5)",hint:"rgba(255, 255, 255, 0.5)",icon:"rgba(255, 255, 255, 0.5)"},divider:"rgba(255, 255, 255, 0.12)",background:{paper:Dm[800],default:"#303030"},action:{active:Ku.white,hover:"rgba(255, 255, 255, 0.08)",hoverOpacity:.08,selected:"rgba(255, 255, 255, 0.16)",selectedOpacity:.16,disabled:"rgba(255, 255, 255, 0.3)",disabledBackground:"rgba(255, 255, 255, 0.12)",disabledOpacity:.38,focus:"rgba(255, 255, 255, 0.12)",focusOpacity:.12,activatedOpacity:.24}};function wI(I,C,y,g){var b=g.light||g,D=g.dark||g*1.5;I[C]||(I.hasOwnProperty(y)?I[C]=I[y]:C==="light"?I.light=hx(I.main,b):C==="dark"&&(I.dark=lx(I.main,D)))}function mx(I){var C=I.primary,y=C===void 0?{light:im[300],main:im[500],dark:im[700]}:C,g=I.secondary,b=g===void 0?{light:nm.A200,main:nm.A400,dark:nm.A700}:g,D=I.error,x=D===void 0?{light:em[300],main:em[500],dark:em[700]}:D,H=I.warning,it=H===void 0?{light:om[300],main:om[500],dark:om[700]}:H,ht=I.info,_t=ht===void 0?{light:rm[300],main:rm[500],dark:rm[700]}:ht,ut=I.success,wt=ut===void 0?{light:sm[300],main:sm[500],dark:sm[700]}:ut,It=I.type,vt=It===void 0?"light":It,qt=I.contrastThreshold,Ie=qt===void 0?3:qt,Xe=I.tonalOffset,Fe=Xe===void 0?.2:Xe,bn=Vr(I,["primary","secondary","error","warning","info","success","type","contrastThreshold","tonalOffset"]);function $i(tr){var Be=ux(tr,cm.text.primary)>=Ie?cm.text.primary:bI.text.primary;return Be}var jn=function(Be){var Xn=arguments.length>1&&arguments[1]!==void 0?arguments[1]:500,er=arguments.length>2&&arguments[2]!==void 0?arguments[2]:300,Gi=arguments.length>3&&arguments[3]!==void 0?arguments[3]:700;if(Be=zt({},Be),!Be.main&&Be[Xn]&&(Be.main=Be[Xn]),!Be.main)throw new Error(Sm(4,Xn));if(typeof Be.main!="string")throw new Error(Sm(5,JSON.stringify(Be.main)));return wI(Be,"light",er,Fe),wI(Be,"dark",Gi,Fe),Be.contrastText||(Be.contrastText=$i(Be.main)),Be},dn={dark:cm,light:bI},Gn=Sa(zt({common:Ku,type:vt,primary:jn(y),secondary:jn(b,"A400","A200","A700"),error:jn(x),warning:jn(it),info:jn(_t),success:jn(wt),grey:Dm,contrastThreshold:Ie,getContrastText:$i,augmentColor:jn,tonalOffset:Fe},dn[vt]),bn);return Gn}function QI(I){return Math.round(I*1e5)/1e5}function Ex(I){return QI(I)}var OI={textTransform:"uppercase"},NI='"Roboto", "Helvetica", "Arial", sans-serif';function fx(I,C){var y=typeof C=="function"?C(I):C,g=y.fontFamily,b=g===void 0?NI:g,D=y.fontSize,x=D===void 0?14:D,H=y.fontWeightLight,it=H===void 0?300:H,ht=y.fontWeightRegular,_t=ht===void 0?400:ht,ut=y.fontWeightMedium,wt=ut===void 0?500:ut,It=y.fontWeightBold,vt=It===void 0?700:It,qt=y.htmlFontSize,Ie=qt===void 0?16:qt,Xe=y.allVariants,Fe=y.pxToRem,bn=Vr(y,["fontFamily","fontSize","fontWeightLight","fontWeightRegular","fontWeightMedium","fontWeightBold","htmlFontSize","allVariants","pxToRem"]),$i=x/14,jn=Fe||function(tr){return"".concat(tr/Ie*$i,"rem")},dn=function(Be,Xn,er,Gi,_o){return zt({fontFamily:b,fontWeight:Be,fontSize:jn(Xn),lineHeight:er},b===NI?{letterSpacing:"".concat(QI(Gi/Xn),"em")}:{},_o,Xe)},Gn={h1:dn(it,96,1.167,-1.5),h2:dn(it,60,1.2,-.5),h3:dn(_t,48,1.167,0),h4:dn(_t,34,1.235,.25),h5:dn(_t,24,1.334,0),h6:dn(wt,20,1.6,.15),subtitle1:dn(_t,16,1.75,.15),subtitle2:dn(wt,14,1.57,.1),body1:dn(_t,16,1.5,.15),body2:dn(_t,14,1.43,.15),button:dn(wt,14,1.75,.4,OI),caption:dn(_t,12,1.66,.4),overline:dn(_t,12,2.66,1,OI)};return Sa(zt({htmlFontSize:Ie,pxToRem:jn,round:Ex,fontFamily:b,fontSize:x,fontWeightLight:it,fontWeightRegular:_t,fontWeightMedium:wt,fontWeightBold:vt},Gn),bn,{clone:!1})}var gx=.2,Tx=.14,Sx=.12;function ze(){return["".concat(arguments.length<=0?void 0:arguments[0],"px ").concat(arguments.length<=1?void 0:arguments[1],"px ").concat(arguments.length<=2?void 0:arguments[2],"px ").concat(arguments.length<=3?void 0:arguments[3],"px rgba(0,0,0,").concat(gx,")"),"".concat(arguments.length<=4?void 0:arguments[4],"px ").concat(arguments.length<=5?void 0:arguments[5],"px ").concat(arguments.length<=6?void 0:arguments[6],"px ").concat(arguments.length<=7?void 0:arguments[7],"px rgba(0,0,0,").concat(Tx,")"),"".concat(arguments.length<=8?void 0:arguments[8],"px ").concat(arguments.length<=9?void 0:arguments[9],"px ").concat(arguments.length<=10?void 0:arguments[10],"px ").concat(arguments.length<=11?void 0:arguments[11],"px rgba(0,0,0,").concat(Sx,")")].join(",")}var Rx=["none",ze(0,2,1,-1,0,1,1,0,0,1,3,0),ze(0,3,1,-2,0,2,2,0,0,1,5,0),ze(0,3,3,-2,0,3,4,0,0,1,8,0),ze(0,2,4,-1,0,4,5,0,0,1,10,0),ze(0,3,5,-1,0,5,8,0,0,1,14,0),ze(0,3,5,-1,0,6,10,0,0,1,18,0),ze(0,4,5,-2,0,7,10,1,0,2,16,1),ze(0,5,5,-3,0,8,10,1,0,3,14,2),ze(0,5,6,-3,0,9,12,1,0,3,16,2),ze(0,6,6,-3,0,10,14,1,0,4,18,3),ze(0,6,7,-4,0,11,15,1,0,4,20,3),ze(0,7,8,-4,0,12,17,2,0,5,22,4),ze(0,7,8,-4,0,13,19,2,0,5,24,4),ze(0,7,9,-4,0,14,21,2,0,5,26,4),ze(0,8,9,-5,0,15,22,2,0,6,28,5),ze(0,8,10,-5,0,16,24,2,0,6,30,5),ze(0,8,11,-5,0,17,26,2,0,6,32,5),ze(0,9,11,-5,0,18,28,2,0,7,34,6),ze(0,9,12,-6,0,19,29,2,0,7,36,6),ze(0,10,13,-6,0,20,31,3,0,8,38,7),ze(0,10,13,-6,0,21,33,3,0,8,40,7),ze(0,10,14,-6,0,22,35,3,0,8,42,7),ze(0,11,14,-7,0,23,36,3,0,9,44,8),ze(0,11,15,-7,0,24,38,3,0,9,46,8)];const Cx=Rx;var vx={borderRadius:4};const yx=vx;function Rm(I,C){(C==null||C>I.length)&&(C=I.length);for(var y=0,g=new Array(C);y<C;y++)g[y]=I[y];return g}function Ix(I){if(Array.isArray(I))return Rm(I)}function Ax(I){if(typeof Symbol<"u"&&I[Symbol.iterator]!=null||I["@@iterator"]!=null)return Array.from(I)}function bx(I,C){if(I){if(typeof I=="string")return Rm(I,C);var y=Object.prototype.toString.call(I).slice(8,-1);if(y==="Object"&&I.constructor&&(y=I.constructor.name),y==="Map"||y==="Set")return Array.from(I);if(y==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(y))return Rm(I,C)}}function wx(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ox(I){return Ix(I)||Ax(I)||bx(I)||wx()}function Nx(I){var C=I.spacing||8;return typeof C=="number"?function(y){return C*y}:Array.isArray(C)?function(y){return C[y]}:typeof C=="function"?C:function(){}}function Dx(){var I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:8;if(I.mui)return I;var C=Nx({spacing:I}),y=function(){for(var b=arguments.length,D=new Array(b),x=0;x<b;x++)D[x]=arguments[x];return D.length===0?C(1):D.length===1?C(D[0]):D.map(function(H){if(typeof H=="string")return H;var it=C(H);return typeof it=="number"?"".concat(it,"px"):it}).join(" ")};return Object.defineProperty(y,"unit",{get:function(){return I}}),y.mui=!0,y}var DI={easeInOut:"cubic-bezier(0.4, 0, 0.2, 1)",easeOut:"cubic-bezier(0.0, 0, 0.2, 1)",easeIn:"cubic-bezier(0.4, 0, 1, 1)",sharp:"cubic-bezier(0.4, 0, 0.6, 1)"},PI={shortest:150,shorter:200,short:250,standard:300,complex:375,enteringScreen:225,leavingScreen:195};function LI(I){return"".concat(Math.round(I),"ms")}const Px={easing:DI,duration:PI,create:function(){var C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:["all"],y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},g=y.duration,b=g===void 0?PI.standard:g,D=y.easing,x=D===void 0?DI.easeInOut:D,H=y.delay,it=H===void 0?0:H;return Vr(y,["duration","easing","delay"]),(Array.isArray(C)?C:[C]).map(function(ht){return"".concat(ht," ").concat(typeof b=="string"?b:LI(b)," ").concat(x," ").concat(typeof it=="string"?it:LI(it))}).join(",")},getAutoHeightDuration:function(C){if(!C)return 0;var y=C/36;return Math.round((4+15*Math.pow(y,.25)+y/5)*10)}};var Lx={mobileStepper:1e3,speedDial:1050,appBar:1100,drawer:1200,modal:1300,snackbar:1400,tooltip:1500};const kx=Lx;function Mx(){for(var I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},C=I.breakpoints,y=C===void 0?{}:C,g=I.mixins,b=g===void 0?{}:g,D=I.palette,x=D===void 0?{}:D,H=I.spacing,it=I.typography,ht=it===void 0?{}:it,_t=Vr(I,["breakpoints","mixins","palette","spacing","typography"]),ut=mx(x),wt=px(y),It=Dx(H),vt=Sa({breakpoints:wt,direction:"ltr",mixins:_x(wt,It,b),overrides:{},palette:ut,props:{},shadows:Cx,typography:fx(ut,ht),spacing:It,shape:yx,transitions:Px,zIndex:kx},_t),qt=arguments.length,Ie=new Array(qt>1?qt-1:0),Xe=1;Xe<qt;Xe++)Ie[Xe-1]=arguments[Xe];return vt=Ie.reduce(function(Fe,bn){return Sa(Fe,bn)},vt),vt}var Ux=typeof Symbol=="function"&&Symbol.for;const xx=Ux?Symbol.for("mui.nested"):"__THEME_NESTED__";var Vx=["checked","disabled","error","focused","focusVisible","required","expanded","selected"];function Fx(){var I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},C=I.disableGlobal,y=C===void 0?!1:C,g=I.productionPrefix,b=g===void 0?"jss":g,D=I.seed,x=D===void 0?"":D,H=x===""?"":"".concat(x,"-"),it=0,ht=function(){return it+=1,it};return function(_t,ut){var wt=ut.options.name;if(wt&&wt.indexOf("Mui")===0&&!ut.options.link&&!y){if(Vx.indexOf(_t.key)!==-1)return"Mui-".concat(_t.key);var It="".concat(H).concat(wt,"-").concat(_t.key);return!ut.options.theme[xx]||x!==""?It:"".concat(It,"-").concat(ht())}return"".concat(H).concat(b).concat(ht())}}function Bx(I){var C=I.theme,y=I.name,g=I.props;if(!C||!C.props||!C.props[y])return g;var b=C.props[y],D;for(D in b)g[D]===void 0&&(g[D]=b[D]);return g}var kI=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},Uc=(typeof window>"u"?"undefined":kI(window))==="object"&&(typeof document>"u"?"undefined":kI(document))==="object"&&document.nodeType===9,jx={}.constructor;function Cm(I){if(I==null||typeof I!="object")return I;if(Array.isArray(I))return I.map(Cm);if(I.constructor!==jx)return I;var C={};for(var y in I)C[y]=Cm(I[y]);return C}function Lm(I,C,y){I===void 0&&(I="unnamed");var g=y.jss,b=Cm(C),D=g.plugins.onCreateRule(I,b,y);return D||(I[0],null)}var MI=function(C,y){for(var g="",b=0;b<C.length&&C[b]!=="!important";b++)g&&(g+=y),g+=C[b];return g},ho=function(C){if(!Array.isArray(C))return C;var y="";if(Array.isArray(C[0]))for(var g=0;g<C.length&&C[g]!=="!important";g++)y&&(y+=", "),y+=MI(C[g]," ");else y=MI(C,", ");return C[C.length-1]==="!important"&&(y+=" !important"),y};function Ra(I){return I&&I.format===!1?{linebreak:"",space:""}:{linebreak:`
`,space:" "}}function Nc(I,C){for(var y="",g=0;g<C;g++)y+="  ";return y+I}function Mc(I,C,y){y===void 0&&(y={});var g="";if(!C)return g;var b=y,D=b.indent,x=D===void 0?0:D,H=C.fallbacks;y.format===!1&&(x=-1/0);var it=Ra(y),ht=it.linebreak,_t=it.space;if(I&&x++,H)if(Array.isArray(H))for(var ut=0;ut<H.length;ut++){var wt=H[ut];for(var It in wt){var vt=wt[It];vt!=null&&(g&&(g+=ht),g+=Nc(It+":"+_t+ho(vt)+";",x))}}else for(var qt in H){var Ie=H[qt];Ie!=null&&(g&&(g+=ht),g+=Nc(qt+":"+_t+ho(Ie)+";",x))}for(var Xe in C){var Fe=C[Xe];Fe!=null&&Xe!=="fallbacks"&&(g&&(g+=ht),g+=Nc(Xe+":"+_t+ho(Fe)+";",x))}return!g&&!y.allowEmpty||!I?g:(x--,g&&(g=""+ht+g+ht),Nc(""+I+_t+"{"+g,x)+Nc("}",x))}var Gx=/([[\].#*$><+~=|^:(),"'`\s])/g,UI=typeof CSS<"u"&&CSS.escape,km=function(I){return UI?UI(I):I.replace(Gx,"\\$1")},ZI=function(){function I(y,g,b){this.type="style",this.isProcessed=!1;var D=b.sheet,x=b.Renderer;this.key=y,this.options=b,this.style=g,D?this.renderer=D.renderer:x&&(this.renderer=new x)}var C=I.prototype;return C.prop=function(g,b,D){if(b===void 0)return this.style[g];var x=D?D.force:!1;if(!x&&this.style[g]===b)return this;var H=b;(!D||D.process!==!1)&&(H=this.options.jss.plugins.onChangeValue(b,g,this));var it=H==null||H===!1,ht=g in this.style;if(it&&!ht&&!x)return this;var _t=it&&ht;if(_t?delete this.style[g]:this.style[g]=H,this.renderable&&this.renderer)return _t?this.renderer.removeProperty(this.renderable,g):this.renderer.setProperty(this.renderable,g,H),this;var ut=this.options.sheet;return ut&&ut.attached,this},I}(),vm=function(I){XI(C,I);function C(g,b,D){var x;x=I.call(this,g,b,D)||this;var H=D.selector,it=D.scoped,ht=D.sheet,_t=D.generateId;return H?x.selectorText=H:it!==!1&&(x.id=_t(II(II(x)),ht),x.selectorText="."+km(x.id)),x}var y=C.prototype;return y.applyTo=function(b){var D=this.renderer;if(D){var x=this.toJSON();for(var H in x)D.setProperty(b,H,x[H])}return this},y.toJSON=function(){var b={};for(var D in this.style){var x=this.style[D];typeof x!="object"?b[D]=x:Array.isArray(x)&&(b[D]=ho(x))}return b},y.toString=function(b){var D=this.options.sheet,x=D?D.options.link:!1,H=x?zt({},b,{allowEmpty:!0}):b;return Mc(this.selectorText,this.style,H)},zI(C,[{key:"selector",set:function(b){if(b!==this.selectorText){this.selectorText=b;var D=this.renderer,x=this.renderable;if(!(!x||!D)){var H=D.setSelector(x,b);H||D.replaceRule(x,this)}}},get:function(){return this.selectorText}}]),C}(ZI),Wx={onCreateRule:function(C,y,g){return C[0]==="@"||g.parent&&g.parent.type==="keyframes"?null:new vm(C,y,g)}},dm={indent:1,children:!0},Hx=/@([\w-]+)/,Kx=function(){function I(y,g,b){this.type="conditional",this.isProcessed=!1,this.key=y;var D=y.match(Hx);this.at=D?D[1]:"unknown",this.query=b.name||"@"+this.at,this.options=b,this.rules=new Ju(zt({},b,{parent:this}));for(var x in g)this.rules.add(x,g[x]);this.rules.process()}var C=I.prototype;return C.getRule=function(g){return this.rules.get(g)},C.indexOf=function(g){return this.rules.indexOf(g)},C.addRule=function(g,b,D){var x=this.rules.add(g,b,D);return x?(this.options.jss.plugins.onProcessRule(x),x):null},C.replaceRule=function(g,b,D){var x=this.rules.replace(g,b,D);return x&&this.options.jss.plugins.onProcessRule(x),x},C.toString=function(g){g===void 0&&(g=dm);var b=Ra(g),D=b.linebreak;if(g.indent==null&&(g.indent=dm.indent),g.children==null&&(g.children=dm.children),g.children===!1)return this.query+" {}";var x=this.rules.toString(g);return x?this.query+" {"+D+x+D+"}":""},I}(),Yx=/@container|@media|@supports\s+/,qx={onCreateRule:function(C,y,g){return Yx.test(C)?new Kx(C,y,g):null}},um={indent:1,children:!0},Jx=/@keyframes\s+([\w-]+)/,ym=function(){function I(y,g,b){this.type="keyframes",this.at="@keyframes",this.isProcessed=!1;var D=y.match(Jx);D&&D[1]?this.name=D[1]:this.name="noname",this.key=this.type+"-"+this.name,this.options=b;var x=b.scoped,H=b.sheet,it=b.generateId;this.id=x===!1?this.name:km(it(this,H)),this.rules=new Ju(zt({},b,{parent:this}));for(var ht in g)this.rules.add(ht,g[ht],zt({},b,{parent:this}));this.rules.process()}var C=I.prototype;return C.toString=function(g){g===void 0&&(g=um);var b=Ra(g),D=b.linebreak;if(g.indent==null&&(g.indent=um.indent),g.children==null&&(g.children=um.children),g.children===!1)return this.at+" "+this.id+" {}";var x=this.rules.toString(g);return x&&(x=""+D+x+D),this.at+" "+this.id+" {"+x+"}"},I}(),zx=/@keyframes\s+/,Xx=/\$([\w-]+)/g,Im=function(C,y){return typeof C=="string"?C.replace(Xx,function(g,b){return b in y?y[b]:g}):C},xI=function(C,y,g){var b=C[y],D=Im(b,g);D!==b&&(C[y]=D)},Qx={onCreateRule:function(C,y,g){return typeof C=="string"&&zx.test(C)?new ym(C,y,g):null},onProcessStyle:function(C,y,g){return y.type!=="style"||!g||("animation-name"in C&&xI(C,"animation-name",g.keyframes),"animation"in C&&xI(C,"animation",g.keyframes)),C},onChangeValue:function(C,y,g){var b=g.options.sheet;if(!b)return C;switch(y){case"animation":return Im(C,b.keyframes);case"animation-name":return Im(C,b.keyframes);default:return C}}},Zx=function(I){XI(C,I);function C(){return I.apply(this,arguments)||this}var y=C.prototype;return y.toString=function(b){var D=this.options.sheet,x=D?D.options.link:!1,H=x?zt({},b,{allowEmpty:!0}):b;return Mc(this.key,this.style,H)},C}(ZI),$x={onCreateRule:function(C,y,g){return g.parent&&g.parent.type==="keyframes"?new Zx(C,y,g):null}},tV=function(){function I(y,g,b){this.type="font-face",this.at="@font-face",this.isProcessed=!1,this.key=y,this.style=g,this.options=b}var C=I.prototype;return C.toString=function(g){var b=Ra(g),D=b.linebreak;if(Array.isArray(this.style)){for(var x="",H=0;H<this.style.length;H++)x+=Mc(this.at,this.style[H]),this.style[H+1]&&(x+=D);return x}return Mc(this.at,this.style,g)},I}(),eV=/@font-face/,nV={onCreateRule:function(C,y,g){return eV.test(C)?new tV(C,y,g):null}},iV=function(){function I(y,g,b){this.type="viewport",this.at="@viewport",this.isProcessed=!1,this.key=y,this.style=g,this.options=b}var C=I.prototype;return C.toString=function(g){return Mc(this.key,this.style,g)},I}(),rV={onCreateRule:function(C,y,g){return C==="@viewport"||C==="@-ms-viewport"?new iV(C,y,g):null}},sV=function(){function I(y,g,b){this.type="simple",this.isProcessed=!1,this.key=y,this.value=g,this.options=b}var C=I.prototype;return C.toString=function(g){if(Array.isArray(this.value)){for(var b="",D=0;D<this.value.length;D++)b+=this.key+" "+this.value[D]+";",this.value[D+1]&&(b+=`
`);return b}return this.key+" "+this.value+";"},I}(),oV={"@charset":!0,"@import":!0,"@namespace":!0},aV={onCreateRule:function(C,y,g){return C in oV?new sV(C,y,g):null}},VI=[Wx,qx,Qx,$x,nV,rV,aV],cV={process:!0},FI={force:!0,process:!0},Ju=function(){function I(y){this.map={},this.raw={},this.index=[],this.counter=0,this.options=y,this.classes=y.classes,this.keyframes=y.keyframes}var C=I.prototype;return C.add=function(g,b,D){var x=this.options,H=x.parent,it=x.sheet,ht=x.jss,_t=x.Renderer,ut=x.generateId,wt=x.scoped,It=zt({classes:this.classes,parent:H,sheet:it,jss:ht,Renderer:_t,generateId:ut,scoped:wt,name:g,keyframes:this.keyframes,selector:void 0},D),vt=g;g in this.raw&&(vt=g+"-d"+this.counter++),this.raw[vt]=b,vt in this.classes&&(It.selector="."+km(this.classes[vt]));var qt=Lm(vt,b,It);if(!qt)return null;this.register(qt);var Ie=It.index===void 0?this.index.length:It.index;return this.index.splice(Ie,0,qt),qt},C.replace=function(g,b,D){var x=this.get(g),H=this.index.indexOf(x);x&&this.remove(x);var it=D;return H!==-1&&(it=zt({},D,{index:H})),this.add(g,b,it)},C.get=function(g){return this.map[g]},C.remove=function(g){this.unregister(g),delete this.raw[g.key],this.index.splice(this.index.indexOf(g),1)},C.indexOf=function(g){return this.index.indexOf(g)},C.process=function(){var g=this.options.jss.plugins;this.index.slice(0).forEach(g.onProcessRule,g)},C.register=function(g){this.map[g.key]=g,g instanceof vm?(this.map[g.selector]=g,g.id&&(this.classes[g.key]=g.id)):g instanceof ym&&this.keyframes&&(this.keyframes[g.name]=g.id)},C.unregister=function(g){delete this.map[g.key],g instanceof vm?(delete this.map[g.selector],delete this.classes[g.key]):g instanceof ym&&delete this.keyframes[g.name]},C.update=function(){var g,b,D;if(typeof(arguments.length<=0?void 0:arguments[0])=="string"?(g=arguments.length<=0?void 0:arguments[0],b=arguments.length<=1?void 0:arguments[1],D=arguments.length<=2?void 0:arguments[2]):(b=arguments.length<=0?void 0:arguments[0],D=arguments.length<=1?void 0:arguments[1],g=null),g)this.updateOne(this.get(g),b,D);else for(var x=0;x<this.index.length;x++)this.updateOne(this.index[x],b,D)},C.updateOne=function(g,b,D){D===void 0&&(D=cV);var x=this.options,H=x.jss.plugins,it=x.sheet;if(g.rules instanceof I){g.rules.update(b,D);return}var ht=g.style;if(H.onUpdate(b,g,it,D),D.process&&ht&&ht!==g.style){H.onProcessStyle(g.style,g,it);for(var _t in g.style){var ut=g.style[_t],wt=ht[_t];ut!==wt&&g.prop(_t,ut,FI)}for(var It in ht){var vt=g.style[It],qt=ht[It];vt==null&&vt!==qt&&g.prop(It,null,FI)}}},C.toString=function(g){for(var b="",D=this.options.sheet,x=D?D.options.link:!1,H=Ra(g),it=H.linebreak,ht=0;ht<this.index.length;ht++){var _t=this.index[ht],ut=_t.toString(g);!ut&&!x||(b&&(b+=it),b+=ut)}return b},I}(),$I=function(){function I(y,g){this.attached=!1,this.deployed=!1,this.classes={},this.keyframes={},this.options=zt({},g,{sheet:this,parent:this,classes:this.classes,keyframes:this.keyframes}),g.Renderer&&(this.renderer=new g.Renderer(this)),this.rules=new Ju(this.options);for(var b in y)this.rules.add(b,y[b]);this.rules.process()}var C=I.prototype;return C.attach=function(){return this.attached?this:(this.renderer&&this.renderer.attach(),this.attached=!0,this.deployed||this.deploy(),this)},C.detach=function(){return this.attached?(this.renderer&&this.renderer.detach(),this.attached=!1,this):this},C.addRule=function(g,b,D){var x=this.queue;this.attached&&!x&&(this.queue=[]);var H=this.rules.add(g,b,D);return H?(this.options.jss.plugins.onProcessRule(H),this.attached?(this.deployed&&(x?x.push(H):(this.insertRule(H),this.queue&&(this.queue.forEach(this.insertRule,this),this.queue=void 0))),H):(this.deployed=!1,H)):null},C.replaceRule=function(g,b,D){var x=this.rules.get(g);if(!x)return this.addRule(g,b,D);var H=this.rules.replace(g,b,D);return H&&this.options.jss.plugins.onProcessRule(H),this.attached?(this.deployed&&this.renderer&&(H?x.renderable&&this.renderer.replaceRule(x.renderable,H):this.renderer.deleteRule(x)),H):(this.deployed=!1,H)},C.insertRule=function(g){this.renderer&&this.renderer.insertRule(g)},C.addRules=function(g,b){var D=[];for(var x in g){var H=this.addRule(x,g[x],b);H&&D.push(H)}return D},C.getRule=function(g){return this.rules.get(g)},C.deleteRule=function(g){var b=typeof g=="object"?g:this.rules.get(g);return!b||this.attached&&!b.renderable?!1:(this.rules.remove(b),this.attached&&b.renderable&&this.renderer?this.renderer.deleteRule(b.renderable):!0)},C.indexOf=function(g){return this.rules.indexOf(g)},C.deploy=function(){return this.renderer&&this.renderer.deploy(),this.deployed=!0,this},C.update=function(){var g;return(g=this.rules).update.apply(g,arguments),this},C.updateOne=function(g,b,D){return this.rules.updateOne(g,b,D),this},C.toString=function(g){return this.rules.toString(g)},I}(),dV=function(){function I(){this.plugins={internal:[],external:[]},this.registry={}}var C=I.prototype;return C.onCreateRule=function(g,b,D){for(var x=0;x<this.registry.onCreateRule.length;x++){var H=this.registry.onCreateRule[x](g,b,D);if(H)return H}return null},C.onProcessRule=function(g){if(!g.isProcessed){for(var b=g.options.sheet,D=0;D<this.registry.onProcessRule.length;D++)this.registry.onProcessRule[D](g,b);g.style&&this.onProcessStyle(g.style,g,b),g.isProcessed=!0}},C.onProcessStyle=function(g,b,D){for(var x=0;x<this.registry.onProcessStyle.length;x++)b.style=this.registry.onProcessStyle[x](b.style,b,D)},C.onProcessSheet=function(g){for(var b=0;b<this.registry.onProcessSheet.length;b++)this.registry.onProcessSheet[b](g)},C.onUpdate=function(g,b,D,x){for(var H=0;H<this.registry.onUpdate.length;H++)this.registry.onUpdate[H](g,b,D,x)},C.onChangeValue=function(g,b,D){for(var x=g,H=0;H<this.registry.onChangeValue.length;H++)x=this.registry.onChangeValue[H](x,b,D);return x},C.use=function(g,b){b===void 0&&(b={queue:"external"});var D=this.plugins[b.queue];D.indexOf(g)===-1&&(D.push(g),this.registry=[].concat(this.plugins.external,this.plugins.internal).reduce(function(x,H){for(var it in H)it in x&&x[it].push(H[it]);return x},{onCreateRule:[],onProcessRule:[],onProcessStyle:[],onProcessSheet:[],onChangeValue:[],onUpdate:[]}))},I}(),uV=function(){function I(){this.registry=[]}var C=I.prototype;return C.add=function(g){var b=this.registry,D=g.options.index;if(b.indexOf(g)===-1){if(b.length===0||D>=this.index){b.push(g);return}for(var x=0;x<b.length;x++)if(b[x].options.index>D){b.splice(x,0,g);return}}},C.reset=function(){this.registry=[]},C.remove=function(g){var b=this.registry.indexOf(g);this.registry.splice(b,1)},C.toString=function(g){for(var b=g===void 0?{}:g,D=b.attached,x=JI(b,["attached"]),H=Ra(x),it=H.linebreak,ht="",_t=0;_t<this.registry.length;_t++){var ut=this.registry[_t];D!=null&&ut.attached!==D||(ht&&(ht+=it),ht+=ut.toString(x))}return ht},zI(I,[{key:"index",get:function(){return this.registry.length===0?0:this.registry[this.registry.length-1].options.index}}]),I}(),Lc=new uV,Am=typeof globalThis<"u"?globalThis:typeof window<"u"&&window.Math===Math?window:typeof self<"u"&&self.Math===Math?self:Function("return this")(),bm="2f1acc6c3a606b082e5eef5e54414ffb";Am[bm]==null&&(Am[bm]=0);var BI=Am[bm]++,jI=function(C){C===void 0&&(C={});var y=0,g=function(D,x){y+=1;var H="",it="";return x&&(x.options.classNamePrefix&&(it=x.options.classNamePrefix),x.options.jss.id!=null&&(H=String(x.options.jss.id))),C.minify?""+(it||"c")+BI+H+y:it+D.key+"-"+BI+(H?"-"+H:"")+"-"+y};return g},tA=function(C){var y;return function(){return y||(y=C()),y}},lV=function(C,y){try{return C.attributeStyleMap?C.attributeStyleMap.get(y):C.style.getPropertyValue(y)}catch{return""}},hV=function(C,y,g){try{var b=g;if(Array.isArray(g)&&(b=ho(g)),C.attributeStyleMap)C.attributeStyleMap.set(y,b);else{var D=b?b.indexOf("!important"):-1,x=D>-1?b.substr(0,D-1):b;C.style.setProperty(y,x,D>-1?"important":"")}}catch{return!1}return!0},pV=function(C,y){try{C.attributeStyleMap?C.attributeStyleMap.delete(y):C.style.removeProperty(y)}catch{}},_V=function(C,y){return C.selectorText=y,C.selectorText===y},eA=tA(function(){return document.querySelector("head")});function mV(I,C){for(var y=0;y<I.length;y++){var g=I[y];if(g.attached&&g.options.index>C.index&&g.options.insertionPoint===C.insertionPoint)return g}return null}function EV(I,C){for(var y=I.length-1;y>=0;y--){var g=I[y];if(g.attached&&g.options.insertionPoint===C.insertionPoint)return g}return null}function fV(I){for(var C=eA(),y=0;y<C.childNodes.length;y++){var g=C.childNodes[y];if(g.nodeType===8&&g.nodeValue.trim()===I)return g}return null}function gV(I){var C=Lc.registry;if(C.length>0){var y=mV(C,I);if(y&&y.renderer)return{parent:y.renderer.element.parentNode,node:y.renderer.element};if(y=EV(C,I),y&&y.renderer)return{parent:y.renderer.element.parentNode,node:y.renderer.element.nextSibling}}var g=I.insertionPoint;if(g&&typeof g=="string"){var b=fV(g);if(b)return{parent:b.parentNode,node:b.nextSibling}}return!1}function TV(I,C){var y=C.insertionPoint,g=gV(C);if(g!==!1&&g.parent){g.parent.insertBefore(I,g.node);return}if(y&&typeof y.nodeType=="number"){var b=y,D=b.parentNode;D&&D.insertBefore(I,b.nextSibling);return}eA().appendChild(I)}var SV=tA(function(){var I=document.querySelector('meta[property="csp-nonce"]');return I?I.getAttribute("content"):null}),GI=function(C,y,g){try{"insertRule"in C?C.insertRule(y,g):"appendRule"in C&&C.appendRule(y)}catch{return!1}return C.cssRules[g]},WI=function(C,y){var g=C.cssRules.length;return y===void 0||y>g?g:y},RV=function(){var C=document.createElement("style");return C.textContent=`
`,C},CV=function(){function I(y){this.getPropertyValue=lV,this.setProperty=hV,this.removeProperty=pV,this.setSelector=_V,this.hasInsertedRules=!1,this.cssRules=[],y&&Lc.add(y),this.sheet=y;var g=this.sheet?this.sheet.options:{},b=g.media,D=g.meta,x=g.element;this.element=x||RV(),this.element.setAttribute("data-jss",""),b&&this.element.setAttribute("media",b),D&&this.element.setAttribute("data-meta",D);var H=SV();H&&this.element.setAttribute("nonce",H)}var C=I.prototype;return C.attach=function(){if(!(this.element.parentNode||!this.sheet)){TV(this.element,this.sheet.options);var g=!!(this.sheet&&this.sheet.deployed);this.hasInsertedRules&&g&&(this.hasInsertedRules=!1,this.deploy())}},C.detach=function(){if(this.sheet){var g=this.element.parentNode;g&&g.removeChild(this.element),this.sheet.options.link&&(this.cssRules=[],this.element.textContent=`
`)}},C.deploy=function(){var g=this.sheet;if(g){if(g.options.link){this.insertRules(g.rules);return}this.element.textContent=`
`+g.toString()+`
`}},C.insertRules=function(g,b){for(var D=0;D<g.index.length;D++)this.insertRule(g.index[D],D,b)},C.insertRule=function(g,b,D){if(D===void 0&&(D=this.element.sheet),g.rules){var x=g,H=D;if(g.type==="conditional"||g.type==="keyframes"){var it=WI(D,b);if(H=GI(D,x.toString({children:!1}),it),H===!1)return!1;this.refCssRule(g,it,H)}return this.insertRules(x.rules,H),H}var ht=g.toString();if(!ht)return!1;var _t=WI(D,b),ut=GI(D,ht,_t);return ut===!1?!1:(this.hasInsertedRules=!0,this.refCssRule(g,_t,ut),ut)},C.refCssRule=function(g,b,D){g.renderable=D,g.options.parent instanceof $I&&this.cssRules.splice(b,0,D)},C.deleteRule=function(g){var b=this.element.sheet,D=this.indexOf(g);return D===-1?!1:(b.deleteRule(D),this.cssRules.splice(D,1),!0)},C.indexOf=function(g){return this.cssRules.indexOf(g)},C.replaceRule=function(g,b){var D=this.indexOf(g);return D===-1?!1:(this.element.sheet.deleteRule(D),this.cssRules.splice(D,1),this.insertRule(b,D))},C.getRules=function(){return this.element.sheet.cssRules},I}(),vV=0,yV=function(){function I(y){this.id=vV++,this.version="10.10.0",this.plugins=new dV,this.options={id:{minify:!1},createGenerateId:jI,Renderer:Uc?CV:null,plugins:[]},this.generateId=jI({minify:!1});for(var g=0;g<VI.length;g++)this.plugins.use(VI[g],{queue:"internal"});this.setup(y)}var C=I.prototype;return C.setup=function(g){return g===void 0&&(g={}),g.createGenerateId&&(this.options.createGenerateId=g.createGenerateId),g.id&&(this.options.id=zt({},this.options.id,g.id)),(g.createGenerateId||g.id)&&(this.generateId=this.options.createGenerateId(this.options.id)),g.insertionPoint!=null&&(this.options.insertionPoint=g.insertionPoint),"Renderer"in g&&(this.options.Renderer=g.Renderer),g.plugins&&this.use.apply(this,g.plugins),this},C.createStyleSheet=function(g,b){b===void 0&&(b={});var D=b,x=D.index;typeof x!="number"&&(x=Lc.index===0?0:Lc.index+1);var H=new $I(g,zt({},b,{jss:this,generateId:b.generateId||this.generateId,insertionPoint:this.options.insertionPoint,Renderer:this.options.Renderer,index:x}));return this.plugins.onProcessSheet(H),H},C.removeStyleSheet=function(g){return g.detach(),Lc.remove(g),this},C.createRule=function(g,b,D){if(b===void 0&&(b={}),D===void 0&&(D={}),typeof g=="object")return this.createRule(void 0,g,b);var x=zt({},D,{name:g,jss:this,Renderer:this.options.Renderer});x.generateId||(x.generateId=this.generateId),x.classes||(x.classes={}),x.keyframes||(x.keyframes={});var H=Lm(g,b,x);return H&&this.plugins.onProcessRule(H),H},C.use=function(){for(var g=this,b=arguments.length,D=new Array(b),x=0;x<b;x++)D[x]=arguments[x];return D.forEach(function(H){g.plugins.use(H)}),this},I}(),nA=function(C){return new yV(C)},Mm=typeof CSS=="object"&&CSS!=null&&"number"in CSS;function iA(I){var C=null;for(var y in I){var g=I[y],b=typeof g;if(b==="function")C||(C={}),C[y]=g;else if(b==="object"&&g!==null&&!Array.isArray(g)){var D=iA(g);D&&(C||(C={}),C[y]=D)}}return C}/**
 * A better abstraction over CSS.
 *
 * @copyright Oleg Isonen (Slobodskoi) / Isonen 2014-present
 * @website https://github.com/cssinjs/jss
 * @license MIT
 */nA();var rA=Date.now(),lm="fnValues"+rA,hm="fnStyle"+ ++rA,IV=function(){return{onCreateRule:function(y,g,b){if(typeof g!="function")return null;var D=Lm(y,{},b);return D[hm]=g,D},onProcessStyle:function(y,g){if(lm in g||hm in g)return y;var b={};for(var D in y){var x=y[D];typeof x=="function"&&(delete y[D],b[D]=x)}return g[lm]=b,y},onUpdate:function(y,g,b,D){var x=g,H=x[hm];H&&(x.style=H(y)||{});var it=x[lm];if(it)for(var ht in it)x.prop(ht,it[ht](y),D)}}};const AV=IV;var As="@global",wm="@global ",bV=function(){function I(y,g,b){this.type="global",this.at=As,this.isProcessed=!1,this.key=y,this.options=b,this.rules=new Ju(zt({},b,{parent:this}));for(var D in g)this.rules.add(D,g[D]);this.rules.process()}var C=I.prototype;return C.getRule=function(g){return this.rules.get(g)},C.addRule=function(g,b,D){var x=this.rules.add(g,b,D);return x&&this.options.jss.plugins.onProcessRule(x),x},C.replaceRule=function(g,b,D){var x=this.rules.replace(g,b,D);return x&&this.options.jss.plugins.onProcessRule(x),x},C.indexOf=function(g){return this.rules.indexOf(g)},C.toString=function(g){return this.rules.toString(g)},I}(),wV=function(){function I(y,g,b){this.type="global",this.at=As,this.isProcessed=!1,this.key=y,this.options=b;var D=y.substr(wm.length);this.rule=b.jss.createRule(D,g,zt({},b,{parent:this}))}var C=I.prototype;return C.toString=function(g){return this.rule?this.rule.toString(g):""},I}(),OV=/\s*,\s*/g;function sA(I,C){for(var y=I.split(OV),g="",b=0;b<y.length;b++)g+=C+" "+y[b].trim(),y[b+1]&&(g+=", ");return g}function NV(I,C){var y=I.options,g=I.style,b=g?g[As]:null;if(b){for(var D in b)C.addRule(D,b[D],zt({},y,{selector:sA(D,I.selector)}));delete g[As]}}function DV(I,C){var y=I.options,g=I.style;for(var b in g)if(!(b[0]!=="@"||b.substr(0,As.length)!==As)){var D=sA(b.substr(As.length),I.selector);C.addRule(D,g[b],zt({},y,{selector:D})),delete g[b]}}function PV(){function I(y,g,b){if(!y)return null;if(y===As)return new bV(y,g,b);if(y[0]==="@"&&y.substr(0,wm.length)===wm)return new wV(y,g,b);var D=b.parent;return D&&(D.type==="global"||D.options.parent&&D.options.parent.type==="global")&&(b.scoped=!1),!b.selector&&b.scoped===!1&&(b.selector=y),null}function C(y,g){y.type!=="style"||!g||(NV(y,g),DV(y,g))}return{onCreateRule:I,onProcessRule:C}}var HI=/\s*,\s*/g,LV=/&/g,kV=/\$([\w-]+)/g;function MV(){function I(b,D){return function(x,H){var it=b.getRule(H)||D&&D.getRule(H);return it?it.selector:H}}function C(b,D){for(var x=D.split(HI),H=b.split(HI),it="",ht=0;ht<x.length;ht++)for(var _t=x[ht],ut=0;ut<H.length;ut++){var wt=H[ut];it&&(it+=", "),it+=wt.indexOf("&")!==-1?wt.replace(LV,_t):_t+" "+wt}return it}function y(b,D,x){if(x)return zt({},x,{index:x.index+1});var H=b.options.nestingLevel;H=H===void 0?1:H+1;var it=zt({},b.options,{nestingLevel:H,index:D.indexOf(b)+1});return delete it.name,it}function g(b,D,x){if(D.type!=="style")return b;var H=D,it=H.options.parent,ht,_t;for(var ut in b){var wt=ut.indexOf("&")!==-1,It=ut[0]==="@";if(!(!wt&&!It)){if(ht=y(H,it,ht),wt){var vt=C(ut,H.selector);_t||(_t=I(it,x)),vt=vt.replace(kV,_t);var qt=H.key+"-"+ut;"replaceRule"in it?it.replaceRule(qt,b[ut],zt({},ht,{selector:vt})):it.addRule(qt,b[ut],zt({},ht,{selector:vt}))}else It&&it.addRule(ut,{},ht).addRule(H.key,b[ut],{selector:H.selector});delete b[ut]}}return b}return{onProcessStyle:g}}var UV=/[A-Z]/g,xV=/^ms-/,pm={};function VV(I){return"-"+I.toLowerCase()}function oA(I){if(pm.hasOwnProperty(I))return pm[I];var C=I.replace(UV,VV);return pm[I]=xV.test(C)?"-"+C:C}function Yu(I){var C={};for(var y in I){var g=y.indexOf("--")===0?y:oA(y);C[g]=I[y]}return I.fallbacks&&(Array.isArray(I.fallbacks)?C.fallbacks=I.fallbacks.map(Yu):C.fallbacks=Yu(I.fallbacks)),C}function FV(){function I(y){if(Array.isArray(y)){for(var g=0;g<y.length;g++)y[g]=Yu(y[g]);return y}return Yu(y)}function C(y,g,b){if(g.indexOf("--")===0)return y;var D=oA(g);return g===D?y:(b.prop(D,y),null)}return{onProcessStyle:I,onChangeValue:C}}var Z=Mm&&CSS?CSS.px:"px",Hu=Mm&&CSS?CSS.ms:"ms",Ea=Mm&&CSS?CSS.percent:"%",BV={"animation-delay":Hu,"animation-duration":Hu,"background-position":Z,"background-position-x":Z,"background-position-y":Z,"background-size":Z,border:Z,"border-bottom":Z,"border-bottom-left-radius":Z,"border-bottom-right-radius":Z,"border-bottom-width":Z,"border-left":Z,"border-left-width":Z,"border-radius":Z,"border-right":Z,"border-right-width":Z,"border-top":Z,"border-top-left-radius":Z,"border-top-right-radius":Z,"border-top-width":Z,"border-width":Z,"border-block":Z,"border-block-end":Z,"border-block-end-width":Z,"border-block-start":Z,"border-block-start-width":Z,"border-block-width":Z,"border-inline":Z,"border-inline-end":Z,"border-inline-end-width":Z,"border-inline-start":Z,"border-inline-start-width":Z,"border-inline-width":Z,"border-start-start-radius":Z,"border-start-end-radius":Z,"border-end-start-radius":Z,"border-end-end-radius":Z,margin:Z,"margin-bottom":Z,"margin-left":Z,"margin-right":Z,"margin-top":Z,"margin-block":Z,"margin-block-end":Z,"margin-block-start":Z,"margin-inline":Z,"margin-inline-end":Z,"margin-inline-start":Z,padding:Z,"padding-bottom":Z,"padding-left":Z,"padding-right":Z,"padding-top":Z,"padding-block":Z,"padding-block-end":Z,"padding-block-start":Z,"padding-inline":Z,"padding-inline-end":Z,"padding-inline-start":Z,"mask-position-x":Z,"mask-position-y":Z,"mask-size":Z,height:Z,width:Z,"min-height":Z,"max-height":Z,"min-width":Z,"max-width":Z,bottom:Z,left:Z,top:Z,right:Z,inset:Z,"inset-block":Z,"inset-block-end":Z,"inset-block-start":Z,"inset-inline":Z,"inset-inline-end":Z,"inset-inline-start":Z,"box-shadow":Z,"text-shadow":Z,"column-gap":Z,"column-rule":Z,"column-rule-width":Z,"column-width":Z,"font-size":Z,"font-size-delta":Z,"letter-spacing":Z,"text-decoration-thickness":Z,"text-indent":Z,"text-stroke":Z,"text-stroke-width":Z,"word-spacing":Z,motion:Z,"motion-offset":Z,outline:Z,"outline-offset":Z,"outline-width":Z,perspective:Z,"perspective-origin-x":Ea,"perspective-origin-y":Ea,"transform-origin":Ea,"transform-origin-x":Ea,"transform-origin-y":Ea,"transform-origin-z":Ea,"transition-delay":Hu,"transition-duration":Hu,"vertical-align":Z,"flex-basis":Z,"shape-margin":Z,size:Z,gap:Z,grid:Z,"grid-gap":Z,"row-gap":Z,"grid-row-gap":Z,"grid-column-gap":Z,"grid-template-rows":Z,"grid-template-columns":Z,"grid-auto-rows":Z,"grid-auto-columns":Z,"box-shadow-x":Z,"box-shadow-y":Z,"box-shadow-blur":Z,"box-shadow-spread":Z,"font-line-height":Z,"text-shadow-x":Z,"text-shadow-y":Z,"text-shadow-blur":Z};function aA(I){var C=/(-[a-z])/g,y=function(x){return x[1].toUpperCase()},g={};for(var b in I)g[b]=I[b],g[b.replace(C,y)]=I[b];return g}var jV=aA(BV);function kc(I,C,y){if(C==null)return C;if(Array.isArray(C))for(var g=0;g<C.length;g++)C[g]=kc(I,C[g],y);else if(typeof C=="object")if(I==="fallbacks")for(var b in C)C[b]=kc(b,C[b],y);else for(var D in C)C[D]=kc(I+"-"+D,C[D],y);else if(typeof C=="number"&&isNaN(C)===!1){var x=y[I]||jV[I];return x&&!(C===0&&x===Z)?typeof x=="function"?x(C).toString():""+C+x:C.toString()}return C}function GV(I){I===void 0&&(I={});var C=aA(I);function y(b,D){if(D.type!=="style")return b;for(var x in b)b[x]=kc(x,b[x],C);return b}function g(b,D){return kc(D,b,C)}return{onProcessStyle:y,onChangeValue:g}}var Dc="",Om="",cA="",dA="",WV=Uc&&"ontouchstart"in document.documentElement;if(Uc){var _m={Moz:"-moz-",ms:"-ms-",O:"-o-",Webkit:"-webkit-"},HV=document.createElement("p"),mm=HV.style,KV="Transform";for(var Em in _m)if(Em+KV in mm){Dc=Em,Om=_m[Em];break}Dc==="Webkit"&&"msHyphens"in mm&&(Dc="ms",Om=_m.ms,dA="edge"),Dc==="Webkit"&&"-apple-trailing-word"in mm&&(cA="apple")}var Yt={js:Dc,css:Om,vendor:cA,browser:dA,isTouch:WV};function YV(I){return I[1]==="-"||Yt.js==="ms"?I:"@"+Yt.css+"keyframes"+I.substr(10)}var qV={noPrefill:["appearance"],supportedProperty:function(C){return C!=="appearance"?!1:Yt.js==="ms"?"-webkit-"+C:Yt.css+C}},JV={noPrefill:["color-adjust"],supportedProperty:function(C){return C!=="color-adjust"?!1:Yt.js==="Webkit"?Yt.css+"print-"+C:C}},zV=/[-\s]+(.)?/g;function XV(I,C){return C?C.toUpperCase():""}function Um(I){return I.replace(zV,XV)}function bs(I){return Um("-"+I)}var QV={noPrefill:["mask"],supportedProperty:function(C,y){if(!/^mask/.test(C))return!1;if(Yt.js==="Webkit"){var g="mask-image";if(Um(g)in y)return C;if(Yt.js+bs(g)in y)return Yt.css+C}return C}},ZV={noPrefill:["text-orientation"],supportedProperty:function(C){return C!=="text-orientation"?!1:Yt.vendor==="apple"&&!Yt.isTouch?Yt.css+C:C}},$V={noPrefill:["transform"],supportedProperty:function(C,y,g){return C!=="transform"?!1:g.transform?C:Yt.css+C}},tF={noPrefill:["transition"],supportedProperty:function(C,y,g){return C!=="transition"?!1:g.transition?C:Yt.css+C}},eF={noPrefill:["writing-mode"],supportedProperty:function(C){return C!=="writing-mode"?!1:Yt.js==="Webkit"||Yt.js==="ms"&&Yt.browser!=="edge"?Yt.css+C:C}},nF={noPrefill:["user-select"],supportedProperty:function(C){return C!=="user-select"?!1:Yt.js==="Moz"||Yt.js==="ms"||Yt.vendor==="apple"?Yt.css+C:C}},iF={supportedProperty:function(C,y){if(!/^break-/.test(C))return!1;if(Yt.js==="Webkit"){var g="WebkitColumn"+bs(C);return g in y?Yt.css+"column-"+C:!1}if(Yt.js==="Moz"){var b="page"+bs(C);return b in y?"page-"+C:!1}return!1}},rF={supportedProperty:function(C,y){if(!/^(border|margin|padding)-inline/.test(C))return!1;if(Yt.js==="Moz")return C;var g=C.replace("-inline","");return Yt.js+bs(g)in y?Yt.css+g:!1}},sF={supportedProperty:function(C,y){return Um(C)in y?C:!1}},oF={supportedProperty:function(C,y){var g=bs(C);return C[0]==="-"||C[0]==="-"&&C[1]==="-"?C:Yt.js+g in y?Yt.css+C:Yt.js!=="Webkit"&&"Webkit"+g in y?"-webkit-"+C:!1}},aF={supportedProperty:function(C){return C.substring(0,11)!=="scroll-snap"?!1:Yt.js==="ms"?""+Yt.css+C:C}},cF={supportedProperty:function(C){return C!=="overscroll-behavior"?!1:Yt.js==="ms"?Yt.css+"scroll-chaining":C}},dF={"flex-grow":"flex-positive","flex-shrink":"flex-negative","flex-basis":"flex-preferred-size","justify-content":"flex-pack",order:"flex-order","align-items":"flex-align","align-content":"flex-line-pack"},uF={supportedProperty:function(C,y){var g=dF[C];return g&&Yt.js+bs(g)in y?Yt.css+g:!1}},uA={flex:"box-flex","flex-grow":"box-flex","flex-direction":["box-orient","box-direction"],order:"box-ordinal-group","align-items":"box-align","flex-flow":["box-orient","box-direction"],"justify-content":"box-pack"},lF=Object.keys(uA),hF=function(C){return Yt.css+C},pF={supportedProperty:function(C,y,g){var b=g.multiple;if(lF.indexOf(C)>-1){var D=uA[C];if(!Array.isArray(D))return Yt.js+bs(D)in y?Yt.css+D:!1;if(!b)return!1;for(var x=0;x<D.length;x++)if(!(Yt.js+bs(D[0])in y))return!1;return D.map(hF)}return!1}},lA=[qV,JV,QV,ZV,$V,tF,eF,nF,iF,rF,sF,oF,aF,cF,uF,pF],KI=lA.filter(function(I){return I.supportedProperty}).map(function(I){return I.supportedProperty}),_F=lA.filter(function(I){return I.noPrefill}).reduce(function(I,C){return I.push.apply(I,Ox(C.noPrefill)),I},[]),Pc,lo={};if(Uc){Pc=document.createElement("p");var fm=window.getComputedStyle(document.documentElement,"");for(var gm in fm)isNaN(gm)||(lo[fm[gm]]=fm[gm]);_F.forEach(function(I){return delete lo[I]})}function Nm(I,C){if(C===void 0&&(C={}),!Pc)return I;if(lo[I]!=null)return lo[I];(I==="transition"||I==="transform")&&(C[I]=I in Pc.style);for(var y=0;y<KI.length&&(lo[I]=KI[y](I,Pc.style,C),!lo[I]);y++);try{Pc.style[I]=""}catch{return!1}return lo[I]}var fa={},mF={transition:1,"transition-property":1,"-webkit-transition":1,"-webkit-transition-property":1},EF=/(^\s*[\w-]+)|, (\s*[\w-]+)(?![^()]*\))/g,Is;function fF(I,C,y){if(C==="var")return"var";if(C==="all")return"all";if(y==="all")return", all";var g=C?Nm(C):", "+Nm(y);return g||C||y}Uc&&(Is=document.createElement("p"));function YI(I,C){var y=C;if(!Is||I==="content")return C;if(typeof y!="string"||!isNaN(parseInt(y,10)))return y;var g=I+y;if(fa[g]!=null)return fa[g];try{Is.style[I]=y}catch{return fa[g]=!1,!1}if(mF[I])y=y.replace(EF,fF);else if(Is.style[I]===""&&(y=Yt.css+y,y==="-ms-flex"&&(Is.style[I]="-ms-flexbox"),Is.style[I]=y,Is.style[I]===""))return fa[g]=!1,!1;return Is.style[I]="",fa[g]=y,fa[g]}function gF(){function I(b){if(b.type==="keyframes"){var D=b;D.at=YV(D.at)}}function C(b){for(var D in b){var x=b[D];if(D==="fallbacks"&&Array.isArray(x)){b[D]=x.map(C);continue}var H=!1,it=Nm(D);it&&it!==D&&(H=!0);var ht=!1,_t=YI(it,ho(x));_t&&_t!==x&&(ht=!0),(H||ht)&&(H&&delete b[D],b[it||D]=_t||x)}return b}function y(b,D){return D.type!=="style"?b:C(b)}function g(b,D){return YI(D,ho(b))||b}return{onProcessRule:I,onProcessStyle:y,onChangeValue:g}}function TF(){var I=function(y,g){return y.length===g.length?y>g?1:-1:y.length-g.length};return{onProcessStyle:function(y,g){if(g.type!=="style")return y;for(var b={},D=Object.keys(y).sort(I),x=0;x<D.length;x++)b[D[x]]=y[D[x]];return b}}}function SF(){return{plugins:[AV(),PV(),MV(),FV(),GV(),typeof window>"u"?null:gF(),TF()]}}function hA(){var I=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},C=I.baseClasses,y=I.newClasses;if(I.Component,!y)return C;var g=zt({},C);return Object.keys(y).forEach(function(b){y[b]&&(g[b]="".concat(C[b]," ").concat(y[b]))}),g}var RF={set:function(C,y,g,b){var D=C.get(y);D||(D=new Map,C.set(y,D)),D.set(g,b)},get:function(C,y,g){var b=C.get(y);return b?b.get(g):void 0},delete:function(C,y,g){var b=C.get(y);b.delete(g)}};const Ta=RF;var CF=ji.createContext(null);const vF=CF;function pA(){var I=ji.useContext(vF);return I}var yF=nA(SF()),IF=Fx(),AF=new Map,bF={disableGeneration:!1,generateClassName:IF,jss:yF,sheetsCache:null,sheetsManager:AF,sheetsRegistry:null},wF=ji.createContext(bF),qI=-1e9;function OF(){return qI+=1,qI}var NF={};const DF=NF;function PF(I){var C=typeof I=="function";return{create:function(g,b){var D;try{D=C?I(g):I}catch(it){throw it}if(!b||!g.overrides||!g.overrides[b])return D;var x=g.overrides[b],H=zt({},D);return Object.keys(x).forEach(function(it){H[it]=Sa(H[it],x[it])}),H},options:{}}}function LF(I,C,y){var g=I.state,b=I.stylesOptions;if(b.disableGeneration)return C||{};g.cacheClasses||(g.cacheClasses={value:null,lastProp:null,lastJSS:{}});var D=!1;return g.classes!==g.cacheClasses.lastJSS&&(g.cacheClasses.lastJSS=g.classes,D=!0),C!==g.cacheClasses.lastProp&&(g.cacheClasses.lastProp=C,D=!0),D&&(g.cacheClasses.value=hA({baseClasses:g.cacheClasses.lastJSS,newClasses:C,Component:y})),g.cacheClasses.value}function kF(I,C){var y=I.state,g=I.theme,b=I.stylesOptions,D=I.stylesCreator,x=I.name;if(!b.disableGeneration){var H=Ta.get(b.sheetsManager,D,g);H||(H={refs:0,staticSheet:null,dynamicStyles:null},Ta.set(b.sheetsManager,D,g,H));var it=zt({},D.options,b,{theme:g,flip:typeof b.flip=="boolean"?b.flip:g.direction==="rtl"});it.generateId=it.serverGenerateClassName||it.generateClassName;var ht=b.sheetsRegistry;if(H.refs===0){var _t;b.sheetsCache&&(_t=Ta.get(b.sheetsCache,D,g));var ut=D.create(g,x);_t||(_t=b.jss.createStyleSheet(ut,zt({link:!1},it)),_t.attach(),b.sheetsCache&&Ta.set(b.sheetsCache,D,g,_t)),ht&&ht.add(_t),H.staticSheet=_t,H.dynamicStyles=iA(ut)}if(H.dynamicStyles){var wt=b.jss.createStyleSheet(H.dynamicStyles,zt({link:!0},it));wt.update(C),wt.attach(),y.dynamicSheet=wt,y.classes=hA({baseClasses:H.staticSheet.classes,newClasses:wt.classes}),ht&&ht.add(wt)}else y.classes=H.staticSheet.classes;H.refs+=1}}function MF(I,C){var y=I.state;y.dynamicSheet&&y.dynamicSheet.update(C)}function UF(I){var C=I.state,y=I.theme,g=I.stylesOptions,b=I.stylesCreator;if(!g.disableGeneration){var D=Ta.get(g.sheetsManager,b,y);D.refs-=1;var x=g.sheetsRegistry;D.refs===0&&(Ta.delete(g.sheetsManager,b,y),g.jss.removeStyleSheet(D.staticSheet),x&&x.remove(D.staticSheet)),C.dynamicSheet&&(g.jss.removeStyleSheet(C.dynamicSheet),x&&x.remove(C.dynamicSheet))}}function xF(I,C){var y=ji.useRef([]),g,b=ji.useMemo(function(){return{}},C);y.current!==b&&(y.current=b,g=I()),ji.useEffect(function(){return function(){g&&g()}},[b])}function VF(I){var C=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},y=C.name,g=C.classNamePrefix,b=C.Component,D=C.defaultTheme,x=D===void 0?DF:D,H=Vr(C,["name","classNamePrefix","Component","defaultTheme"]),it=PF(I),ht=y||g||"makeStyles";it.options={index:OF(),name:y,meta:ht,classNamePrefix:ht};var _t=function(){var wt=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},It=pA()||x,vt=zt({},ji.useContext(wF),H),qt=ji.useRef(),Ie=ji.useRef();xF(function(){var Fe={name:y,state:{},stylesCreator:it,stylesOptions:vt,theme:It};return kF(Fe,wt),Ie.current=!1,qt.current=Fe,function(){UF(Fe)}},[It,it]),ji.useEffect(function(){Ie.current&&MF(qt.current,wt),Ie.current=!0});var Xe=LF(qt.current,wt.classes,b);return Xe};return _t}function _A(I){var C,y,g="";if(typeof I=="string"||typeof I=="number")g+=I;else if(typeof I=="object")if(Array.isArray(I))for(C=0;C<I.length;C++)I[C]&&(y=_A(I[C]))&&(g&&(g+=" "),g+=y);else for(C in I)I[C]&&(g&&(g+=" "),g+=C);return g}function FF(){for(var I,C,y=0,g="";y<arguments.length;)(I=arguments[y++])&&(C=_A(I))&&(g&&(g+=" "),g+=C);return g}var BF=function(C){var y=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function(g){var b=y.defaultTheme,D=y.withTheme,x=D===void 0?!1:D,H=y.name,it=Vr(y,["defaultTheme","withTheme","name"]),ht=H,_t=VF(C,zt({defaultTheme:b,Component:g,name:H||g.displayName,classNamePrefix:ht},it)),ut=ji.forwardRef(function(It,vt){It.classes;var qt=It.innerRef,Ie=Vr(It,["classes","innerRef"]),Xe=_t(zt({},g.defaultProps,It)),Fe,bn=Ie;return(typeof H=="string"||x)&&(Fe=pA()||b,H&&(bn=Bx({theme:Fe,name:H,props:Ie})),x&&!bn.theme&&(bn.theme=Fe)),ji.createElement(g,zt({ref:qt||vt,classes:Xe},bn))});return Q2(ut,g),ut}};const jF=BF;var GF=Mx();const WF=GF;function HF(I,C){return jF(I,zt({defaultTheme:WF},C))}var KF=[0,1,2,3,4,5,6,7,8,9,10],YF=["auto",!0,1,2,3,4,5,6,7,8,9,10,11,12];function qF(I,C,y){var g={};YF.forEach(function(b){var D="grid-".concat(y,"-").concat(b);if(b===!0){g[D]={flexBasis:0,flexGrow:1,maxWidth:"100%"};return}if(b==="auto"){g[D]={flexBasis:"auto",flexGrow:0,maxWidth:"none"};return}var x="".concat(Math.round(b/12*1e8)/1e6,"%");g[D]={flexBasis:x,flexGrow:0,maxWidth:x}}),y==="xs"?zt(I,g):I[C.breakpoints.up(y)]=g}function Tm(I){var C=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,y=parseFloat(I);return"".concat(y/C).concat(String(I).replace(String(y),"")||"px")}function JF(I,C){var y={};return KF.forEach(function(g){var b=I.spacing(g);b!==0&&(y["spacing-".concat(C,"-").concat(g)]={margin:"-".concat(Tm(b,2)),width:"calc(100% + ".concat(Tm(b),")"),"& > $item":{padding:Tm(b,2)}})}),y}var zF=function(C){return zt({root:{},container:{boxSizing:"border-box",display:"flex",flexWrap:"wrap",width:"100%"},item:{boxSizing:"border-box",margin:"0"},zeroMinWidth:{minWidth:0},"direction-xs-column":{flexDirection:"column"},"direction-xs-column-reverse":{flexDirection:"column-reverse"},"direction-xs-row-reverse":{flexDirection:"row-reverse"},"wrap-xs-nowrap":{flexWrap:"nowrap"},"wrap-xs-wrap-reverse":{flexWrap:"wrap-reverse"},"align-items-xs-center":{alignItems:"center"},"align-items-xs-flex-start":{alignItems:"flex-start"},"align-items-xs-flex-end":{alignItems:"flex-end"},"align-items-xs-baseline":{alignItems:"baseline"},"align-content-xs-center":{alignContent:"center"},"align-content-xs-flex-start":{alignContent:"flex-start"},"align-content-xs-flex-end":{alignContent:"flex-end"},"align-content-xs-space-between":{alignContent:"space-between"},"align-content-xs-space-around":{alignContent:"space-around"},"justify-content-xs-center":{justifyContent:"center"},"justify-content-xs-flex-end":{justifyContent:"flex-end"},"justify-content-xs-space-between":{justifyContent:"space-between"},"justify-content-xs-space-around":{justifyContent:"space-around"},"justify-content-xs-space-evenly":{justifyContent:"space-evenly"}},JF(C,"xs"),C.breakpoints.keys.reduce(function(y,g){return qF(y,C,g),y},{}))},XF=yI.forwardRef(function(C,y){var g=C.alignContent,b=g===void 0?"stretch":g,D=C.alignItems,x=D===void 0?"stretch":D,H=C.classes,it=C.className,ht=C.component,_t=ht===void 0?"div":ht,ut=C.container,wt=ut===void 0?!1:ut,It=C.direction,vt=It===void 0?"row":It,qt=C.item,Ie=qt===void 0?!1:qt,Xe=C.justify,Fe=C.justifyContent,bn=Fe===void 0?"flex-start":Fe,$i=C.lg,jn=$i===void 0?!1:$i,dn=C.md,Gn=dn===void 0?!1:dn,tr=C.sm,Be=tr===void 0?!1:tr,Xn=C.spacing,er=Xn===void 0?0:Xn,Gi=C.wrap,_o=Gi===void 0?"wrap":Gi,Qe=C.xl,Fr=Qe===void 0?!1:Qe,_i=C.xs,xc=_i===void 0?!1:_i,ws=C.zeroMinWidth,Sn=ws===void 0?!1:ws,Ca=Vr(C,["alignContent","alignItems","classes","className","component","container","direction","item","justify","justifyContent","lg","md","sm","spacing","wrap","xl","xs","zeroMinWidth"]),Vc=FF(H.root,it,wt&&[H.container,er!==0&&H["spacing-xs-".concat(String(er))]],Ie&&H.item,Sn&&H.zeroMinWidth,vt!=="row"&&H["direction-xs-".concat(String(vt))],_o!=="wrap"&&H["wrap-xs-".concat(String(_o))],x!=="stretch"&&H["align-items-xs-".concat(String(x))],b!=="stretch"&&H["align-content-xs-".concat(String(b))],(Xe||bn)!=="flex-start"&&H["justify-content-xs-".concat(String(Xe||bn))],xc!==!1&&H["grid-xs-".concat(String(xc))],Be!==!1&&H["grid-sm-".concat(String(Be))],Gn!==!1&&H["grid-md-".concat(String(Gn))],jn!==!1&&H["grid-lg-".concat(String(jn))],Fr!==!1&&H["grid-xl-".concat(String(Fr))]);return yI.createElement(_t,zt({className:Vc,ref:y},Ca))}),QF=HF(zF,{name:"MuiGrid"})(XF);const uB=QF;var mA={exports:{}};(function(I,C){(function(y,g){I.exports=g()})($_,function(){function y(n,t){return t.forEach(function(e){e&&typeof e!="string"&&!Array.isArray(e)&&Object.keys(e).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return e[i]}})}})}),Object.freeze(n)}var g=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof $_<"u"?$_:typeof self<"u"?self:{};function b(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var D=function(n){try{return!!n()}catch{return!0}},x=!D(function(){var n=(function(){}).bind();return typeof n!="function"||n.hasOwnProperty("prototype")}),H=x,it=Function.prototype,ht=it.call,_t=H&&it.bind.bind(ht,ht),ut=H?_t:function(n){return function(){return ht.apply(n,arguments)}},wt=ut({}.isPrototypeOf),It=function(n){return n&&n.Math==Math&&n},vt=It(typeof globalThis=="object"&&globalThis)||It(typeof window=="object"&&window)||It(typeof self=="object"&&self)||It(typeof g=="object"&&g)||function(){return this}()||g||Function("return this")(),qt=x,Ie=Function.prototype,Xe=Ie.apply,Fe=Ie.call,bn=typeof Reflect=="object"&&Reflect.apply||(qt?Fe.bind(Xe):function(){return Fe.apply(Xe,arguments)}),$i=ut,jn=$i({}.toString),dn=$i("".slice),Gn=function(n){return dn(jn(n),8,-1)},tr=Gn,Be=ut,Xn=function(n){if(tr(n)==="Function")return Be(n)},er=typeof document=="object"&&document.all,Gi={all:er,IS_HTMLDDA:er===void 0&&er!==void 0},_o=Gi.all,Qe=Gi.IS_HTMLDDA?function(n){return typeof n=="function"||n===_o}:function(n){return typeof n=="function"},Fr={},_i=!D(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),xc=x,ws=Function.prototype.call,Sn=xc?ws.bind(ws):function(){return ws.apply(ws,arguments)},Ca={},Vc={}.propertyIsEnumerable,xm=Object.getOwnPropertyDescriptor,EA=xm&&!Vc.call({1:2},1);Ca.f=EA?function(n){var t=xm(this,n);return!!t&&t.enumerable}:Vc;var Br,Fc,Os=function(n,t){return{enumerable:!(1&n),configurable:!(2&n),writable:!(4&n),value:t}},fA=D,gA=Gn,zu=Object,TA=ut("".split),Xu=fA(function(){return!zu("z").propertyIsEnumerable(0)})?function(n){return gA(n)=="String"?TA(n,""):zu(n)}:zu,Bc=function(n){return n==null},SA=Bc,RA=TypeError,va=function(n){if(SA(n))throw RA("Can't call method on "+n);return n},CA=Xu,vA=va,Ns=function(n){return CA(vA(n))},Vm=Qe,yA=Gi.all,bi=Gi.IS_HTMLDDA?function(n){return typeof n=="object"?n!==null:Vm(n)||n===yA}:function(n){return typeof n=="object"?n!==null:Vm(n)},Tr={},Qu=Tr,Zu=vt,IA=Qe,Fm=function(n){return IA(n)?n:void 0},Qn=function(n,t){return arguments.length<2?Fm(Qu[n])||Fm(Zu[n]):Qu[n]&&Qu[n][t]||Zu[n]&&Zu[n][t]},Ds=typeof navigator<"u"&&String(navigator.userAgent)||"",Bm=vt,$u=Ds,jm=Bm.process,Gm=Bm.Deno,Wm=jm&&jm.versions||Gm&&Gm.version,Hm=Wm&&Wm.v8;Hm&&(Fc=(Br=Hm.split("."))[0]>0&&Br[0]<4?1:+(Br[0]+Br[1])),!Fc&&$u&&(!(Br=$u.match(/Edge\/(\d+)/))||Br[1]>=74)&&(Br=$u.match(/Chrome\/(\d+)/))&&(Fc=+Br[1]);var Ps=Fc,Km=Ps,AA=D,bA=vt.String,mo=!!Object.getOwnPropertySymbols&&!AA(function(){var n=Symbol();return!bA(n)||!(Object(n)instanceof Symbol)||!Symbol.sham&&Km&&Km<41}),Ym=mo&&!Symbol.sham&&typeof Symbol.iterator=="symbol",wA=Qn,OA=Qe,NA=wt,DA=Object,ya=Ym?function(n){return typeof n=="symbol"}:function(n){var t=wA("Symbol");return OA(t)&&NA(t.prototype,DA(n))},PA=String,Eo=function(n){try{return PA(n)}catch{return"Object"}},LA=Qe,kA=Eo,MA=TypeError,wi=function(n){if(LA(n))return n;throw MA(kA(n)+" is not a function")},UA=wi,xA=Bc,tl=function(n,t){var e=n[t];return xA(e)?void 0:UA(e)},el=Sn,nl=Qe,il=bi,VA=TypeError,qm={exports:{}},Jm=vt,FA=Object.defineProperty,BA=function(n,t){try{FA(Jm,n,{value:t,configurable:!0,writable:!0})}catch{Jm[n]=t}return t},zm="__core-js_shared__",rl=vt[zm]||BA(zm,{}),Xm=rl;(qm.exports=function(n,t){return Xm[n]||(Xm[n]=t!==void 0?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var fo=qm.exports,jA=va,GA=Object,jr=function(n){return GA(jA(n))},WA=jr,HA=ut({}.hasOwnProperty),Dn=Object.hasOwn||function(n,t){return HA(WA(n),t)},KA=ut,YA=0,qA=Math.random(),JA=KA(1 .toString),sl=function(n){return"Symbol("+(n===void 0?"":n)+")_"+JA(++YA+qA,36)},zA=fo,Qm=Dn,XA=sl,QA=mo,ZA=Ym,go=vt.Symbol,ol=zA("wks"),$A=ZA?go.for||go:go&&go.withoutSetter||XA,je=function(n){return Qm(ol,n)||(ol[n]=QA&&Qm(go,n)?go[n]:$A("Symbol."+n)),ol[n]},tb=Sn,Zm=bi,$m=ya,eb=tl,nb=function(n,t){var e,i;if(t==="string"&&nl(e=n.toString)&&!il(i=el(e,n))||nl(e=n.valueOf)&&!il(i=el(e,n))||t!=="string"&&nl(e=n.toString)&&!il(i=el(e,n)))return i;throw VA("Can't convert object to primitive value")},ib=TypeError,rb=je("toPrimitive"),sb=function(n,t){if(!Zm(n)||$m(n))return n;var e,i=eb(n,rb);if(i){if(t===void 0&&(t="default"),e=tb(i,n,t),!Zm(e)||$m(e))return e;throw ib("Can't convert object to primitive value")}return t===void 0&&(t="number"),nb(n,t)},ob=ya,jc=function(n){var t=sb(n,"string");return ob(t)?t:t+""},tE=bi,al=vt.document,ab=tE(al)&&tE(al.createElement),cl=function(n){return ab?al.createElement(n):{}},cb=cl,eE=!_i&&!D(function(){return Object.defineProperty(cb("div"),"a",{get:function(){return 7}}).a!=7}),db=_i,ub=Sn,lb=Ca,hb=Os,pb=Ns,_b=jc,mb=Dn,Eb=eE,nE=Object.getOwnPropertyDescriptor;Fr.f=db?nE:function(n,t){if(n=pb(n),t=_b(t),Eb)try{return nE(n,t)}catch{}if(mb(n,t))return hb(!ub(lb.f,n,t),n[t])};var fb=D,gb=Qe,Tb=/#|\.prototype\./,Ia=function(n,t){var e=Rb[Sb(n)];return e==vb||e!=Cb&&(gb(t)?fb(t):!!t)},Sb=Ia.normalize=function(n){return String(n).replace(Tb,".").toLowerCase()},Rb=Ia.data={},Cb=Ia.NATIVE="N",vb=Ia.POLYFILL="P",iE=Ia,yb=wi,Ib=x,Ab=Xn(Xn.bind),Aa=function(n,t){return yb(n),t===void 0?n:Ib?Ab(n,t):function(){return n.apply(t,arguments)}},Oi={},rE=_i&&D(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),bb=bi,wb=String,Ob=TypeError,Wi=function(n){if(bb(n))return n;throw Ob(wb(n)+" is not an object")},Nb=_i,Db=eE,Pb=rE,Gc=Wi,sE=jc,Lb=TypeError,dl=Object.defineProperty,kb=Object.getOwnPropertyDescriptor,ul="enumerable",ll="configurable",hl="writable";Oi.f=Nb?Pb?function(n,t,e){if(Gc(n),t=sE(t),Gc(e),typeof n=="function"&&t==="prototype"&&"value"in e&&hl in e&&!e[hl]){var i=kb(n,t);i&&i[hl]&&(n[t]=e.value,e={configurable:ll in e?e[ll]:i[ll],enumerable:ul in e?e[ul]:i[ul],writable:!1})}return dl(n,t,e)}:dl:function(n,t,e){if(Gc(n),t=sE(t),Gc(e),Db)try{return dl(n,t,e)}catch{}if("get"in e||"set"in e)throw Lb("Accessors not supported");return"value"in e&&(n[t]=e.value),n};var Mb=Oi,Ub=Os,Gr=_i?function(n,t,e){return Mb.f(n,t,Ub(1,e))}:function(n,t,e){return n[t]=e,n},Wc=vt,xb=bn,Vb=Xn,Fb=Qe,Bb=Fr.f,jb=iE,To=Tr,Gb=Aa,So=Gr,oE=Dn,Wb=function(n){var t=function(e,i,r){if(this instanceof t){switch(arguments.length){case 0:return new n;case 1:return new n(e);case 2:return new n(e,i)}return new n(e,i,r)}return xb(n,this,arguments)};return t.prototype=n.prototype,t},le=function(n,t){var e,i,r,s,o,a,c,d,u,l=n.target,p=n.global,_=n.stat,R=n.proto,f=p?Wc:_?Wc[l]:(Wc[l]||{}).prototype,T=p?To:To[l]||So(To,l,{})[l],A=T.prototype;for(s in t)i=!(e=jb(p?s:l+(_?".":"#")+s,n.forced))&&f&&oE(f,s),a=T[s],i&&(c=n.dontCallGetSet?(u=Bb(f,s))&&u.value:f[s]),o=i&&c?c:t[s],i&&typeof a==typeof o||(d=n.bind&&i?Gb(o,Wc):n.wrap&&i?Wb(o):R&&Fb(o)?Vb(o):o,(n.sham||o&&o.sham||a&&a.sham)&&So(d,"sham",!0),So(T,s,d),R&&(oE(To,r=l+"Prototype")||So(To,r,{}),So(To[r],s,o),n.real&&A&&(e||!A[s])&&So(A,s,o)))},Hb=Math.ceil,Kb=Math.floor,Yb=Math.trunc||function(n){var t=+n;return(t>0?Kb:Hb)(t)},pl=function(n){var t=+n;return t!=t||t===0?0:Yb(t)},qb=pl,Jb=Math.max,zb=Math.min,aE=function(n,t){var e=qb(n);return e<0?Jb(e+t,0):zb(e,t)},Xb=pl,Qb=Math.min,Zb=function(n){return n>0?Qb(Xb(n),9007199254740991):0},Ls=function(n){return Zb(n.length)},$b=Ns,t0=aE,e0=Ls,cE=function(n){return function(t,e,i){var r,s=$b(t),o=e0(s),a=t0(i,o);if(n&&e!=e){for(;o>a;)if((r=s[a++])!=r)return!0}else for(;o>a;a++)if((n||a in s)&&s[a]===e)return n||a||0;return!n&&-1}},_l={includes:cE(!0),indexOf:cE(!1)},n0=_l.includes;le({target:"Array",proto:!0,forced:D(function(){return!Array(1).includes()})},{includes:function(n){return n0(this,n,arguments.length>1?arguments[1]:void 0)}});var i0=Tr,Wr=function(n){return i0[n+"Prototype"]},r0=Wr("Array").includes,s0=bi,o0=Gn,a0=je("match"),c0=function(n){var t;return s0(n)&&((t=n[a0])!==void 0?!!t:o0(n)=="RegExp")},d0=TypeError,dE={};dE[je("toStringTag")]="z";var ml=String(dE)==="[object z]",u0=ml,l0=Qe,Hc=Gn,h0=je("toStringTag"),p0=Object,_0=Hc(function(){return arguments}())=="Arguments",ks=u0?Hc:function(n){var t,e,i;return n===void 0?"Undefined":n===null?"Null":typeof(e=function(r,s){try{return r[s]}catch{}}(t=p0(n),h0))=="string"?e:_0?Hc(t):(i=Hc(t))=="Object"&&l0(t.callee)?"Arguments":i},m0=ks,E0=String,Sr=function(n){if(m0(n)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return E0(n)},f0=je("match"),g0=le,T0=function(n){if(c0(n))throw d0("The method doesn't accept regular expressions");return n},S0=va,uE=Sr,R0=function(n){var t=/./;try{"/./"[n](t)}catch{try{return t[f0]=!1,"/./"[n](t)}catch{}}return!1},C0=ut("".indexOf);g0({target:"String",proto:!0,forced:!R0("includes")},{includes:function(n){return!!~C0(uE(S0(this)),uE(T0(n)),arguments.length>1?arguments[1]:void 0)}});var v0=Wr("String").includes,lE=wt,y0=r0,I0=v0,El=Array.prototype,fl=String.prototype,nt=b(function(n){var t=n.includes;return n===El||lE(El,n)&&t===El.includes?y0:typeof n=="string"||n===fl||lE(fl,n)&&t===fl.includes?I0:t});let hE=!0,pE=!0;function Kc(n,t,e){const i=n.match(t);return i&&i.length>=e&&parseInt(i[e],10)}function Ms(n,t,e){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==t)return r.apply(this,arguments);const c=d=>{const u=e(d);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(a))return s.apply(this,arguments);const c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(o){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),o&&this.addEventListener(t,this["_on"+t]=o)},enumerable:!0,configurable:!0})}function A0(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(hE=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function b0(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(pE=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function _E(){if(typeof window=="object"){if(hE)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function gl(n,t){pE&&console.warn(n+" is deprecated, please use "+t+" instead.")}function mE(n){return Object.prototype.toString.call(n)==="[object Object]"}function EE(n){return mE(n)?Object.keys(n).reduce(function(t,e){const i=mE(n[e]),r=i?EE(n[e]):n[e],s=i&&!Object.keys(r).length;return r===void 0||s?t:Object.assign(t,{[e]:r})},{}):n}function Tl(n,t,e){t&&!e.has(t.id)&&(e.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?Tl(n,n.get(t[i]),e):i.endsWith("Ids")&&t[i].forEach(r=>{Tl(n,n.get(r),e)})}))}function fE(n,t,e){const i=e?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;const s=[];return n.forEach(o=>{o.type==="track"&&o.trackIdentifier===t.id&&s.push(o)}),s.forEach(o=>{n.forEach(a=>{a.type===i&&a.trackId===o.id&&Tl(n,a,r)})}),r}const gE=_E;function TE(n,t){const e=n&&n.navigator;if(!e.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof o[c]=="object"?o[c]:{ideal:o[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const u=function(l,p){return l?l+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){a.optional=a.optional||[];let l={};typeof d.ideal=="number"?(l[u("min",c)]=d.ideal,a.optional.push(l),l={},l[u("max",c)]=d.ideal,a.optional.push(l)):(l[u("",c)]=d.ideal,a.optional.push(l))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[u("",c)]=d.exact):["min","max"].forEach(l=>{d[l]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[u(l,c)]=d[l])})}),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},r=function(o,a){if(t.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=t.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!e.mediaDevices.getSupportedConstraints||!e.mediaDevices.getSupportedConstraints().facingMode||d)){let u;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?u=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(u=["front"]),u)return e.mediaDevices.enumerateDevices().then(l=>{let p=(l=l.filter(_=>_.kind==="videoinput")).find(_=>u.some(R=>_.label.toLowerCase().includes(R)));return!p&&l.length&&u.includes("back")&&(p=l[l.length-1]),p&&(o.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),o.video=i(o.video),gE("chrome: "+JSON.stringify(o)),a(o)})}o.video=i(o.video)}return gE("chrome: "+JSON.stringify(o)),a(o)},s=function(o){return t.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(e.getUserMedia=(function(o,a,c){r(o,d=>{e.webkitGetUserMedia(d,a,u=>{c&&c(s(u))})})}).bind(e),e.mediaDevices.getUserMedia){const o=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(a){return r(a,c=>o(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>Promise.reject(s(d))))}}}function SE(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function RE(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",i=>{let r;r=n.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===i.track.id):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=r,s.transceiver={receiver:r},s.streams=[e.stream],this.dispatchEvent(s)}),e.stream.getTracks().forEach(i=>{let r;r=n.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===i.id):{track:i};const s=new Event("track");s.track=i,s.receiver=r,s.transceiver={receiver:r},s.streams=[e.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Ms(n,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function CE(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const t=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,a){let c=r.apply(this,arguments);return c||(c=t(this,o),this._senders.push(c)),c};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],e.apply(this,[r]),r.getTracks().forEach(s=>{this._senders.push(t(this,s))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(s=>{const o=this._senders.find(a=>a.track===s);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(i=>i._pc=this),e},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function vE(n){if(!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[e,i,r]=arguments;if(arguments.length>0&&typeof e=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof e!="function"))return t.apply(this,[]);const s=function(a){const c={};return a.result().forEach(d=>{const u={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(l=>{u[l]=d.stat(l)}),c[u.id]=u}),c},o=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){const a=function(c){i(o(s(c)))};return t.apply(this,[a,e])}return new Promise((a,c)=>{t.apply(this,[function(d){a(o(s(d)))},c])}).then(i,r)}}function yE(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>fE(s,r.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Ms(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then(r=>fE(r,i.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype)||!("getStats"in n.RTCRtpReceiver.prototype))return;const t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const e=arguments[0];let i,r,s;return this.getSenders().forEach(o=>{o.track===e&&(i?s=!0:i=o)}),this.getReceivers().forEach(o=>(o.track===e&&(r?s=!0:r=o),o.track===e)),s||i&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function IE(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(s,o){if(!o)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=t.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(c=>{if(this.getSenders().find(d=>d.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();e.apply(this,arguments);const a=this.getSenders().filter(c=>o.indexOf(c)===-1);this._shimmedLocalStreams[s.id]=[s].concat(a)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const a=this._shimmedLocalStreams[o].indexOf(s);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),r.apply(this,arguments)}}function AE(n,t){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&t.version>=65)return IE(n);const e=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const c=e.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){const d=new n.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};const r=n.RTCPeerConnection.prototype.removeStream;function s(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l],_=c._streams[p.id];u=u.replace(new RegExp(_.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}n.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},n.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const u=[].slice.call(arguments,1);if(u.length!==1||!u[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const l=this._streams[d.id];if(l)l.addTrack(c),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const p=new n.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){const d=n.RTCPeerConnection.prototype[c],u={[c](){const l=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[p=>{const _=s(this,p);l[0].apply(null,[_])},p=>{l[1]&&l[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then(p=>s(this,p))}};n.RTCPeerConnection.prototype[c]=u[c]});const o=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l],_=c._streams[p.id];u=u.replace(new RegExp(p.id,"g"),_.id)}),new RTCSessionDescription({type:d.type,sdp:u})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:s(this,c)}}),n.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(u=>{this._streams[u].getTracks().find(l=>c.track===l)&&(d=this._streams[u])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Sl(n,t){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const i=n.RTCPeerConnection.prototype[e],r={[e](){return arguments[0]=new(e==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[e]=r[e]})}function bE(n,t){Ms(n,"negotiationneeded",e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return e})}var wE=Object.freeze({__proto__:null,fixNegotiationNeeded:bE,shimAddTrackRemoveTrack:AE,shimAddTrackRemoveTrackWithNative:IE,shimGetDisplayMedia:function(n,t){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(typeof t=="function"?n.navigator.mediaDevices.getDisplayMedia=function(e){return t(e).then(i=>{const r=e.video&&e.video.width,s=e.video&&e.video.height,o=e.video&&e.video.frameRate;return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:o||3}},r&&(e.video.mandatory.maxWidth=r),s&&(e.video.mandatory.maxHeight=s),n.navigator.mediaDevices.getUserMedia(e)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:CE,shimGetStats:vE,shimGetUserMedia:TE,shimMediaStream:SE,shimOnTrack:RE,shimPeerConnection:Sl,shimSenderReceiverGetStats:yE});function OE(n,t){const e=n&&n.navigator,i=n&&n.MediaStreamTrack;if(e.getUserMedia=function(r,s,o){gl("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(r).then(s,o)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function NE(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Rl(n,t){if(typeof n!="object"||!n.RTCPeerConnection&&!n.mozRTCPeerConnection)return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=o[r]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[r,s,o]=arguments;return i.apply(this,[r||null]).then(a=>{if(t.version<53&&!s)try{a.forEach(c=>{c.type=e[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,u)=>{a.set(u,Object.assign({},d,{type:e[d.type]||d.type}))})}return a}).then(s,o)}}function DE(n){if(typeof n!="object"||!n.RTCPeerConnection||!n.RTCRtpSender||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i});const e=n.RTCPeerConnection.prototype.addTrack;e&&(n.RTCPeerConnection.prototype.addTrack=function(){const i=e.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function PE(n){if(typeof n!="object"||!n.RTCPeerConnection||!n.RTCRtpSender||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(i=>i._pc=this),e}),Ms(n,"track",e=>(e.receiver._pc=e.srcElement,e)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function LE(n){n.RTCPeerConnection&&!("removeStream"in n.RTCPeerConnection.prototype)&&(n.RTCPeerConnection.prototype.removeStream=function(t){gl("removeStream","removeTrack"),this.getSenders().forEach(e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)})})}function kE(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function ME(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype.addTransceiver;t&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;e===void 0&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const r=t.apply(this,arguments);if(i){const{sender:s}=r,o=s.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=e,s.sendEncodings=e,this.setParametersPromises.push(s.setParameters(o).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return r})}function UE(n){if(typeof n!="object"||!n.RTCRtpSender)return;const t=n.RTCRtpSender.prototype.getParameters;t&&(n.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function xE(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function VE(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var FE=Object.freeze({__proto__:null,shimAddTransceiver:ME,shimCreateAnswer:VE,shimCreateOffer:xE,shimGetDisplayMedia:function(n,t){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(e){if(!e||!e.video){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Promise.reject(i)}return e.video===!0?e.video={mediaSource:t}:e.video.mediaSource=t,n.navigator.mediaDevices.getUserMedia(e)})},shimGetParameters:UE,shimGetUserMedia:OE,shimOnTrack:NE,shimPeerConnection:Rl,shimRTCDataChannel:kE,shimReceiverGetStats:PE,shimRemoveStream:LE,shimSenderGetStats:DE});function BE(n){if(typeof n=="object"&&n.RTCPeerConnection){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(i=>t.call(this,i,e)),e.getVideoTracks().forEach(i=>t.call(this,i,e))},n.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach(r=>{this._localStreams?this._localStreams.includes(r)||this._localStreams.push(r):this._localStreams=[r]}),t.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(t);if(e===-1)return;this._localStreams.splice(e,1);const i=t.getTracks();this.getSenders().forEach(r=>{i.includes(r.track)&&this.removeTrack(r)})})}}function jE(n){if(typeof n=="object"&&n.RTCPeerConnection&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(r=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(r)>=0)return;e._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,e.dispatchEvent(s)})}),t.apply(e,arguments)}}}function GE(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype,e=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=e.apply(this,[u]);return d?(l.then(c,d),Promise.resolve()):l},t.createAnswer=function(c,d){const u=arguments.length>=2?arguments[2]:arguments[0],l=i.apply(this,[u]);return d?(l.then(c,d),Promise.resolve()):l};let a=function(c,d,u){const l=r.apply(this,[c]);return u?(l.then(d,u),Promise.resolve()):l};t.setLocalDescription=a,a=function(c,d,u){const l=s.apply(this,[c]);return u?(l.then(d,u),Promise.resolve()):l},t.setRemoteDescription=a,a=function(c,d,u){const l=o.apply(this,[c]);return u?(l.then(d,u),Promise.resolve()):l},t.addIceCandidate=a}function WE(n){const t=n&&n.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=r=>i(HE(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(e,i,r){t.mediaDevices.getUserMedia(e).then(i,r)}).bind(t))}function HE(n){return n&&n.video!==void 0?Object.assign({},n,{video:EE(n.video)}):n}function KE(n){if(!n.RTCPeerConnection)return;const t=n.RTCPeerConnection;n.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const r=[];for(let s=0;s<e.iceServers.length;s++){let o=e.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(gl("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(e.iceServers[s])}e.iceServers=r}return new t(e,i)},n.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function YE(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function qE(n){const t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(e){if(e){e.offerToReceiveAudio!==void 0&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const i=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");e.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):e.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),e.offerToReceiveVideo!==void 0&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find(s=>s.receiver.track.kind==="video");e.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):e.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function JE(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var zE=Object.freeze({__proto__:null,shimAudioContext:JE,shimCallbacksAPI:GE,shimConstraints:HE,shimCreateOfferLegacy:qE,shimGetUserMedia:WE,shimLocalStreamsAPI:BE,shimRTCIceServerUrls:KE,shimRemoteStreamsAPI:jE,shimTrackEventTransceiver:YE}),XE={exports:{}};(function(n){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split(`
`).map(i=>i.trim())},t.splitSections=function(e){return e.split(`
m=`).map((i,r)=>(r>0?"m="+i:i).trim()+`\r
`)},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter(r=>r.indexOf(i)===0)},t.parseCandidate=function(e){let i;i=e.indexOf("a=candidate:")===0?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1])}return r},t.writeCandidate=function(e){const i=[];i.push(e.foundation);const r=e.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(e.protocol.toUpperCase()),i.push(e.priority),i.push(e.address||e.ip),i.push(e.port);const s=e.type;return i.push("typ"),i.push(s),s!=="host"&&e.relatedAddress&&e.relatedPort&&(i.push("raddr"),i.push(e.relatedAddress),i.push("rport"),i.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(i.push("ufrag"),i.push(e.usernameFragment||e.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let i=e.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let i=e.payloadType;e.preferredPayloadType!==void 0&&(i=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+i+" "+e.name+"/"+e.clockRate+(r!==1?"/"+r:"")+`\r
`},t.parseExtmap=function(e){const i=e.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+`\r
`},t.parseFmtp=function(e){const i={};let r;const s=e.substring(e.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},t.writeFmtp=function(e){let i="",r=e.payloadType;if(e.preferredPayloadType!==void 0&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const s=[];Object.keys(e.parameters).forEach(o=>{e.parameters[o]!==void 0?s.push(o+"="+e.parameters[o]):s.push(o)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},t.parseRtcpFb=function(e){const i=e.substring(e.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(e){let i="",r=e.payloadType;return e.preferredPayloadType!==void 0&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},t.parseSsrcMedia=function(e){const i=e.indexOf(" "),r={ssrc:parseInt(e.substring(7,i),10)},s=e.indexOf(":",i);return s>-1?(r.attribute=e.substring(i+1,s),r.value=e.substring(s+1)):r.attribute=e.substring(i+1),r},t.parseSsrcGroup=function(e){const i=e.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const i=e.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,i){let r="a=setup:"+i+`\r
`;return e.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},t.parseCryptoLine=function(e){const i=e.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;const i=e.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],s=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(e){let i="a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`;return e.iceLite&&(i+=`a=ice-lite\r
`),i},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" ");i.profile=r[2];for(let o=3;o<r.length;o++){const a=r[o],c=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(c){const d=t.parseRtpMap(c),u=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(d.parameters=u.length?t.parseFmtp(u[0]):{},d.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach(o=>{i.headerExtensions.push(t.parseExtmap(o))});const s=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach(o=>{s.forEach(a=>{o.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||o.rtcpFeedback.push(a)})}),i},t.writeRtpDescription=function(e,i){let r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(o=>{r+=t.writeRtpMap(o),r+=t.writeFmtp(o),r+=t.writeRtcpFb(o)});let s=0;return i.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(o=>{r+=t.writeExtmap(o)}),r},t.parseRtpEncodingParameters=function(e){const i=[],r=t.parseRtpParameters(e),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=t.matchPrefix(e,"a=ssrc:").map(p=>t.parseSsrcMedia(p)).filter(p=>p.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const u=t.matchPrefix(e,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(_=>parseInt(_,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(d=u[0][1]),r.codecs.forEach(p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let _={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(_.rtx={ssrc:d}),i.push(_),s&&(_=JSON.parse(JSON.stringify(_)),_.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(_))}}),i.length===0&&c&&i.push({ssrc:c});let l=t.matchPrefix(e,"b=");return l.length&&(l=l[0].indexOf("b=TIAS:")===0?parseInt(l[0].substring(7),10):l[0].indexOf("b=AS:")===0?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach(p=>{p.maxBitrate=l})),i},t.parseRtcpParameters=function(e){const i={},r=t.matchPrefix(e,"a=ssrc:").map(a=>t.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=t.matchPrefix(e,"a=rtcp-mux");return i.mux=o.length>0,i},t.writeRtcpParameters=function(e){let i="";return e.reducedSize&&(i+=`a=rtcp-rsize\r
`),e.mux&&(i+=`a=rtcp-mux\r
`),e.ssrc!==void 0&&e.cname&&(i+="a=ssrc:"+e.ssrc+" cname:"+e.cname+`\r
`),i},t.parseMsid=function(e){let i;const r=t.matchPrefix(e,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=t.matchPrefix(e,"a=ssrc:").map(o=>t.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},t.writeSctpDescription=function(e,i){let r=[];return r=e.protocol!=="DTLS/SCTP"?["m="+e.kind+" 9 "+e.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+e.kind+" 9 "+e.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,r){let s;const o=i!==void 0?i:2;return s=e||t.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(e,i){const r=t.splitLines(e);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return e.split(" ",2)[1]==="0"},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;const i=t.splitLines(e);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=t})(XE);var QE=XE.exports,Ro=b(QE),w0=y({__proto__:null,default:Ro},[QE]);function Yc(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const t=n.RTCIceCandidate;n.RTCIceCandidate=function(e){if(typeof e=="object"&&e.candidate&&e.candidate.indexOf("a=")===0&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),r=Ro.parseCandidate(e.candidate),s=Object.assign(i,r);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},n.RTCIceCandidate.prototype=t.prototype,Ms(n,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new n.RTCIceCandidate(e.candidate),writable:"false"}),e))}function Cl(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Ms(n,"icecandidate",t=>{if(t.candidate){const e=Ro.parseCandidate(t.candidate.candidate);e.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t})}function qc(n,t){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const e=function(a){if(!a||!a.sdp)return!1;const c=Ro.splitSections(a.sdp);return c.shift(),c.some(d=>{const u=Ro.parseMLine(d);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return t.browser==="firefox"&&(c=t.version<57?a===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),c},s=function(a,c){let d=65536;t.browser==="firefox"&&t.version===57&&(d=65535);const u=Ro.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?d=parseInt(u[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(d=2147483637),d},o=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const a=i(arguments[0]),c=r(a),d=s(arguments[0],a);let u;u=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const l={};Object.defineProperty(l,"maxMessageSize",{get:()=>u}),this._sctp=l}return o.apply(this,arguments)}}function Jc(n){if(!n.RTCPeerConnection||!("createDataChannel"in n.RTCPeerConnection.prototype))return;function t(i,r){const s=i.send;i.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const e=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const i=e.apply(this,arguments);return t(i,this),i},Ms(n,"datachannel",i=>(t(i.channel,i.target),i))}function vl(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const t=n.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function yl(n,t){if(!n.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=i.sdp.split(`
`).filter(s=>s.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&i instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return e.apply(this,arguments)}}function zc(n,t){if(!n.RTCPeerConnection||!n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype.addIceCandidate;e&&e.length!==0&&(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Xc(n,t){if(!n.RTCPeerConnection||!n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype.setLocalDescription;e&&e.length!==0&&(n.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return e.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?e.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>e.apply(this,[r]))})}var O0=Object.freeze({__proto__:null,removeExtmapAllowMixed:yl,shimAddIceCandidateNullOrEmpty:zc,shimConnectionState:vl,shimMaxMessageSize:qc,shimParameterlessSetLocalDescription:Xc,shimRTCIceCandidate:Yc,shimRTCIceCandidateRelayProtocol:Cl,shimSendThrowTypeError:Jc});(function({window:n}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const e=_E,i=function(s){const o={browser:null,version:null};if(s===void 0||!s.navigator)return o.browser="Not a browser.",o;const{navigator:a}=s;if(a.mozGetUserMedia)o.browser="firefox",o.version=Kc(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)o.browser="chrome",o.version=Kc(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=Kc(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return o}(n),r={browserDetails:i,commonShim:O0,extractVersion:Kc,disableLog:A0,disableWarnings:b0,sdp:w0};switch(i.browser){case"chrome":if(!wE||!Sl||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),r;if(i.version===null)return e("Chrome shim can not determine version, not shimming."),r;e("adapter.js shimming chrome."),r.browserShim=wE,zc(n,i),Xc(n),TE(n,i),SE(n),Sl(n,i),RE(n),AE(n,i),CE(n),vE(n),yE(n),bE(n,i),Yc(n),Cl(n),vl(n),qc(n,i),Jc(n),yl(n,i);break;case"firefox":if(!FE||!Rl||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),r;e("adapter.js shimming firefox."),r.browserShim=FE,zc(n,i),Xc(n),OE(n,i),Rl(n,i),NE(n),LE(n),DE(n),PE(n),kE(n),ME(n),UE(n),xE(n),VE(n),Yc(n),vl(n),qc(n,i),Jc(n);break;case"safari":if(!zE||!t.shimSafari)return e("Safari shim is not included in this adapter release."),r;e("adapter.js shimming safari."),r.browserShim=zE,zc(n,i),Xc(n),KE(n),qE(n),GE(n),BE(n),jE(n),YE(n),WE(n),JE(n),Yc(n),Cl(n),qc(n,i),Jc(n),yl(n,i);break;default:e("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var ZE={exports:{}},N0=le,D0=_i,$E=Oi.f;N0({target:"Object",stat:!0,forced:Object.defineProperty!==$E,sham:!D0},{defineProperty:$E});var tf=Tr.Object,P0=ZE.exports=function(n,t,e){return tf.defineProperty(n,t,e)};tf.defineProperty.sham&&(P0.sham=!0);var L0=b(ZE.exports),k0=Gn,Il=Array.isArray||function(n){return k0(n)=="Array"},M0=TypeError,U0=jc,x0=Oi,V0=Os,ef=function(n,t,e){var i=U0(t);i in n?x0.f(n,i,V0(0,e)):n[i]=e},F0=Qe,Al=rl,B0=ut(Function.toString);F0(Al.inspectSource)||(Al.inspectSource=function(n){return B0(n)});var nf=Al.inspectSource,j0=ut,G0=D,rf=Qe,W0=ks,H0=nf,sf=function(){},K0=[],of=Qn("Reflect","construct"),bl=/^\s*(?:class|function)\b/,Y0=j0(bl.exec),q0=!bl.exec(sf),ba=function(n){if(!rf(n))return!1;try{return of(sf,K0,n),!0}catch{return!1}},af=function(n){if(!rf(n))return!1;switch(W0(n)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return q0||!!Y0(bl,H0(n))}catch{return!0}};af.sham=!0;var cf=!of||G0(function(){var n;return ba(ba.call)||!ba(Object)||!ba(function(){n=!0})||n})?af:ba,df=Il,J0=cf,z0=bi,X0=je("species"),uf=Array,Q0=function(n){var t;return df(n)&&(t=n.constructor,(J0(t)&&(t===uf||df(t.prototype))||z0(t)&&(t=t[X0])===null)&&(t=void 0)),t===void 0?uf:t},lf=function(n,t){return new(Q0(n))(t===0?0:t)},Z0=D,$0=Ps,tw=je("species"),ew=le,nw=D,iw=Il,rw=bi,sw=jr,ow=Ls,hf=function(n){if(n>9007199254740991)throw M0("Maximum allowed index exceeded");return n},pf=ef,aw=lf,cw=function(n){return $0>=51||!Z0(function(){var t=[];return(t.constructor={})[tw]=function(){return{foo:1}},t[n](Boolean).foo!==1})},dw=Ps,_f=je("isConcatSpreadable"),uw=dw>=51||!nw(function(){var n=[];return n[_f]=!1,n.concat()[0]!==n}),lw=function(n){if(!rw(n))return!1;var t=n[_f];return t!==void 0?!!t:iw(n)};ew({target:"Array",proto:!0,arity:1,forced:!uw||!cw("concat")},{concat:function(n){var t,e,i,r,s,o=sw(this),a=aw(o,0),c=0;for(t=-1,i=arguments.length;t<i;t++)if(lw(s=t===-1?o:arguments[t]))for(r=ow(s),hf(c+r),e=0;e<r;e++,c++)e in s&&pf(a,c,s[e]);else hf(c+1),pf(a,c++,s);return a.length=c,a}});var wl={},Qc={},Ol=Dn,hw=Ns,pw=_l.indexOf,_w=Qc,mf=ut([].push),Ef=function(n,t){var e,i=hw(n),r=0,s=[];for(e in i)!Ol(_w,e)&&Ol(i,e)&&mf(s,e);for(;t.length>r;)Ol(i,e=t[r++])&&(~pw(s,e)||mf(s,e));return s},Nl=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],mw=Ef,Ew=Nl,Dl=Object.keys||function(n){return mw(n,Ew)},fw=_i,gw=rE,Tw=Oi,Sw=Wi,Rw=Ns,Cw=Dl;wl.f=fw&&!gw?Object.defineProperties:function(n,t){Sw(n);for(var e,i=Rw(t),r=Cw(t),s=r.length,o=0;s>o;)Tw.f(n,e=r[o++],i[e]);return n};var Zc,ff=Qn("document","documentElement"),vw=sl,gf=fo("keys"),$c=function(n){return gf[n]||(gf[n]=vw(n))},yw=Wi,Iw=wl,Tf=Nl,Aw=Qc,bw=ff,ww=cl,Pl="prototype",Ll="script",Sf=$c("IE_PROTO"),kl=function(){},Rf=function(n){return"<"+Ll+">"+n+"</"+Ll+">"},Cf=function(n){n.write(Rf("")),n.close();var t=n.parentWindow.Object;return n=null,t},td=function(){try{Zc=new ActiveXObject("htmlfile")}catch{}var n,t,e;td=typeof document<"u"?document.domain&&Zc?Cf(Zc):(t=ww("iframe"),e="java"+Ll+":",t.style.display="none",bw.appendChild(t),t.src=String(e),(n=t.contentWindow.document).open(),n.write(Rf("document.F=Object")),n.close(),n.F):Cf(Zc);for(var i=Tf.length;i--;)delete td[Pl][Tf[i]];return td()};Aw[Sf]=!0;var ed=Object.create||function(n,t){var e;return n!==null?(kl[Pl]=yw(n),e=new kl,kl[Pl]=null,e[Sf]=n):e=td(),t===void 0?e:Iw.f(e,t)},nd={},Ow=Ef,Nw=Nl.concat("length","prototype");nd.f=Object.getOwnPropertyNames||function(n){return Ow(n,Nw)};var vf={},yf=aE,Dw=Ls,Pw=ef,Lw=Array,kw=Math.max,If=function(n,t,e){for(var i=Dw(n),r=yf(t,i),s=yf(e===void 0?i:e,i),o=Lw(kw(s-r,0)),a=0;r<s;r++,a++)Pw(o,a,n[r]);return o.length=a,o},Mw=Gn,Uw=Ns,Af=nd.f,xw=If,bf=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];vf.f=function(n){return bf&&Mw(n)=="Window"?function(t){try{return Af(t)}catch{return xw(bf)}}(n):Af(Uw(n))};var id={};id.f=Object.getOwnPropertySymbols;var Vw=Gr,wa=function(n,t,e,i){return i&&i.enumerable?n[t]=e:Vw(n,t,e),n},Fw=Oi,wf=function(n,t,e){return Fw.f(n,t,e)},Co={},Bw=je;Co.f=Bw;var rd,Oa,sd,Of=Tr,jw=Dn,Gw=Co,Ww=Oi.f,tn=function(n){var t=Of.Symbol||(Of.Symbol={});jw(t,n)||Ww(t,n,{value:Gw.f(n)})},Hw=Sn,Kw=Qn,Yw=je,qw=wa,Nf=function(){var n=Kw("Symbol"),t=n&&n.prototype,e=t&&t.valueOf,i=Yw("toPrimitive");t&&!t[i]&&qw(t,i,function(r){return Hw(e,this)},{arity:1})},Jw=ks,zw=ml?{}.toString:function(){return"[object "+Jw(this)+"]"},Xw=ml,Qw=Oi.f,Zw=Gr,$w=Dn,tO=zw,Df=je("toStringTag"),vo=function(n,t,e,i){if(n){var r=e?n:n.prototype;$w(r,Df)||Qw(r,Df,{configurable:!0,value:t}),i&&!Xw&&Zw(r,"toString",tO)}},eO=Qe,Pf=vt.WeakMap,nO=eO(Pf)&&/native code/.test(String(Pf)),Lf=vt,iO=bi,rO=Gr,Ml=Dn,Ul=rl,sO=$c,oO=Qc,kf="Object already initialized",xl=Lf.TypeError,aO=Lf.WeakMap;if(nO||Ul.state){var nr=Ul.state||(Ul.state=new aO);nr.get=nr.get,nr.has=nr.has,nr.set=nr.set,rd=function(n,t){if(nr.has(n))throw xl(kf);return t.facade=n,nr.set(n,t),t},Oa=function(n){return nr.get(n)||{}},sd=function(n){return nr.has(n)}}else{var yo=sO("state");oO[yo]=!0,rd=function(n,t){if(Ml(n,yo))throw xl(kf);return t.facade=n,rO(n,yo,t),t},Oa=function(n){return Ml(n,yo)?n[yo]:{}},sd=function(n){return Ml(n,yo)}}var od={set:rd,get:Oa,has:sd,enforce:function(n){return sd(n)?Oa(n):rd(n,{})},getterFor:function(n){return function(t){var e;if(!iO(t)||(e=Oa(t)).type!==n)throw xl("Incompatible receiver, "+n+" required");return e}}},cO=Aa,dO=Xu,uO=jr,lO=Ls,hO=lf,Mf=ut([].push),Hr=function(n){var t=n==1,e=n==2,i=n==3,r=n==4,s=n==6,o=n==7,a=n==5||s;return function(c,d,u,l){for(var p,_,R=uO(c),f=dO(R),T=cO(d,u),A=lO(f),N=0,P=l||hO,j=t?P(c,A):e||o?P(c,0):void 0;A>N;N++)if((a||N in f)&&(_=T(p=f[N],N,R),n))if(t)j[N]=_;else if(_)switch(n){case 3:return!0;case 5:return p;case 6:return N;case 2:Mf(j,p)}else switch(n){case 4:return!1;case 7:Mf(j,p)}return s?-1:i||r?r:j}},pO={forEach:Hr(0),map:Hr(1),filter:Hr(2),some:Hr(3),every:Hr(4),find:Hr(5),findIndex:Hr(6),filterReject:Hr(7)},ad=le,Vl=vt,Fl=Sn,_O=ut,Io=_i,Ao=mo,mO=D,Rn=Dn,EO=wt,Bl=Wi,cd=Ns,jl=jc,fO=Sr,Gl=Os,Na=ed,Uf=Dl,gO=nd,xf=vf,TO=id,Vf=Fr,Ff=Oi,SO=wl,Bf=Ca,jf=wa,RO=wf,Wl=fo,Gf=Qc,Wf=sl,CO=je,vO=Co,yO=tn,IO=Nf,AO=vo,Hf=od,dd=pO.forEach,Zn=$c("hidden"),ud="Symbol",Da="prototype",bO=Hf.set,Kf=Hf.getterFor(ud),Hi=Object[Da],Us=Vl.Symbol,ld=Us&&Us[Da],wO=Vl.TypeError,Hl=Vl.QObject,Yf=Vf.f,xs=Ff.f,qf=xf.f,OO=Bf.f,Jf=_O([].push),Rr=Wl("symbols"),Pa=Wl("op-symbols"),NO=Wl("wks"),Kl=!Hl||!Hl[Da]||!Hl[Da].findChild,Yl=Io&&mO(function(){return Na(xs({},"a",{get:function(){return xs(this,"a",{value:7}).a}})).a!=7})?function(n,t,e){var i=Yf(Hi,t);i&&delete Hi[t],xs(n,t,e),i&&n!==Hi&&xs(Hi,t,i)}:xs,ql=function(n,t){var e=Rr[n]=Na(ld);return bO(e,{type:ud,tag:n,description:t}),Io||(e.description=t),e},hd=function(n,t,e){n===Hi&&hd(Pa,t,e),Bl(n);var i=jl(t);return Bl(e),Rn(Rr,i)?(e.enumerable?(Rn(n,Zn)&&n[Zn][i]&&(n[Zn][i]=!1),e=Na(e,{enumerable:Gl(0,!1)})):(Rn(n,Zn)||xs(n,Zn,Gl(1,{})),n[Zn][i]=!0),Yl(n,i,e)):xs(n,i,e)},Jl=function(n,t){Bl(n);var e=cd(t),i=Uf(e).concat(Zf(e));return dd(i,function(r){Io&&!Fl(zf,e,r)||hd(n,r,e[r])}),n},zf=function(n){var t=jl(n),e=Fl(OO,this,t);return!(this===Hi&&Rn(Rr,t)&&!Rn(Pa,t))&&(!(e||!Rn(this,t)||!Rn(Rr,t)||Rn(this,Zn)&&this[Zn][t])||e)},Xf=function(n,t){var e=cd(n),i=jl(t);if(e!==Hi||!Rn(Rr,i)||Rn(Pa,i)){var r=Yf(e,i);return!r||!Rn(Rr,i)||Rn(e,Zn)&&e[Zn][i]||(r.enumerable=!0),r}},Qf=function(n){var t=qf(cd(n)),e=[];return dd(t,function(i){Rn(Rr,i)||Rn(Gf,i)||Jf(e,i)}),e},Zf=function(n){var t=n===Hi,e=qf(t?Pa:cd(n)),i=[];return dd(e,function(r){!Rn(Rr,r)||t&&!Rn(Hi,r)||Jf(i,Rr[r])}),i};Ao||(Us=function(){if(EO(ld,this))throw wO("Symbol is not a constructor");var n=arguments.length&&arguments[0]!==void 0?fO(arguments[0]):void 0,t=Wf(n),e=function(i){this===Hi&&Fl(e,Pa,i),Rn(this,Zn)&&Rn(this[Zn],t)&&(this[Zn][t]=!1),Yl(this,t,Gl(1,i))};return Io&&Kl&&Yl(Hi,t,{configurable:!0,set:e}),ql(t,n)},jf(ld=Us[Da],"toString",function(){return Kf(this).tag}),jf(Us,"withoutSetter",function(n){return ql(Wf(n),n)}),Bf.f=zf,Ff.f=hd,SO.f=Jl,Vf.f=Xf,gO.f=xf.f=Qf,TO.f=Zf,vO.f=function(n){return ql(CO(n),n)},Io&&RO(ld,"description",{configurable:!0,get:function(){return Kf(this).description}})),ad({global:!0,constructor:!0,wrap:!0,forced:!Ao,sham:!Ao},{Symbol:Us}),dd(Uf(NO),function(n){yO(n)}),ad({target:ud,stat:!0,forced:!Ao},{useSetter:function(){Kl=!0},useSimple:function(){Kl=!1}}),ad({target:"Object",stat:!0,forced:!Ao,sham:!Io},{create:function(n,t){return t===void 0?Na(n):Jl(Na(n),t)},defineProperty:hd,defineProperties:Jl,getOwnPropertyDescriptor:Xf}),ad({target:"Object",stat:!0,forced:!Ao},{getOwnPropertyNames:Qf}),IO(),AO(Us,ud),Gf[Zn]=!0;var $f=mo&&!!Symbol.for&&!!Symbol.keyFor,DO=le,PO=Qn,LO=Dn,kO=Sr,tg=fo,MO=$f,zl=tg("string-to-symbol-registry"),UO=tg("symbol-to-string-registry");DO({target:"Symbol",stat:!0,forced:!MO},{for:function(n){var t=kO(n);if(LO(zl,t))return zl[t];var e=PO("Symbol")(t);return zl[t]=e,UO[e]=t,e}});var xO=le,VO=Dn,FO=ya,BO=Eo,jO=$f,eg=fo("symbol-to-string-registry");xO({target:"Symbol",stat:!0,forced:!jO},{keyFor:function(n){if(!FO(n))throw TypeError(BO(n)+" is not a symbol");if(VO(eg,n))return eg[n]}});var ng=ut([].slice),ig=Il,GO=Qe,rg=Gn,WO=Sr,sg=ut([].push),HO=le,og=Qn,ag=bn,KO=Sn,La=ut,cg=D,dg=Qe,ug=ya,lg=ng,YO=function(n){if(GO(n))return n;if(ig(n)){for(var t=n.length,e=[],i=0;i<t;i++){var r=n[i];typeof r=="string"?sg(e,r):typeof r!="number"&&rg(r)!="Number"&&rg(r)!="String"||sg(e,WO(r))}var s=e.length,o=!0;return function(a,c){if(o)return o=!1,c;if(ig(this))return c;for(var d=0;d<s;d++)if(e[d]===a)return c}}},qO=mo,JO=String,Kr=og("JSON","stringify"),pd=La(/./.exec),hg=La("".charAt),zO=La("".charCodeAt),XO=La("".replace),QO=La(1 .toString),ZO=/[\uD800-\uDFFF]/g,pg=/^[\uD800-\uDBFF]$/,_g=/^[\uDC00-\uDFFF]$/,mg=!qO||cg(function(){var n=og("Symbol")();return Kr([n])!="[null]"||Kr({a:n})!="{}"||Kr(Object(n))!="{}"}),Eg=cg(function(){return Kr("\uDF06\uD834")!=='"\\udf06\\ud834"'||Kr("\uDEAD")!=='"\\udead"'}),$O=function(n,t){var e=lg(arguments),i=YO(t);if(dg(i)||n!==void 0&&!ug(n))return e[1]=function(r,s){if(dg(i)&&(s=KO(i,this,JO(r),s)),!ug(s))return s},ag(Kr,null,e)},tN=function(n,t,e){var i=hg(e,t-1),r=hg(e,t+1);return pd(pg,n)&&!pd(_g,r)||pd(_g,n)&&!pd(pg,i)?"\\u"+QO(zO(n,0),16):n};Kr&&HO({target:"JSON",stat:!0,arity:3,forced:mg||Eg},{stringify:function(n,t,e){var i=lg(arguments),r=ag(mg?$O:Kr,null,i);return Eg&&typeof r=="string"?XO(r,ZO,tN):r}});var fg=id,eN=jr;le({target:"Object",stat:!0,forced:!mo||D(function(){fg.f(1)})},{getOwnPropertySymbols:function(n){var t=fg.f;return t?t(eN(n)):[]}}),tn("asyncIterator"),tn("hasInstance"),tn("isConcatSpreadable"),tn("iterator"),tn("match"),tn("matchAll"),tn("replace"),tn("search"),tn("species"),tn("split");var nN=Nf;tn("toPrimitive"),nN();var iN=Qn,rN=vo;tn("toStringTag"),rN(iN("Symbol"),"Symbol"),tn("unscopables"),vo(vt.JSON,"JSON",!0);var Vs,gg,Tg,sN=Tr.Symbol,bo={},Xl=_i,oN=Dn,Sg=Function.prototype,aN=Xl&&Object.getOwnPropertyDescriptor,Ql=oN(Sg,"name"),Rg={EXISTS:Ql,PROPER:Ql&&(function(){}).name==="something",CONFIGURABLE:Ql&&(!Xl||Xl&&aN(Sg,"name").configurable)},cN=!D(function(){function n(){}return n.prototype.constructor=null,Object.getPrototypeOf(new n)!==n.prototype}),dN=Dn,uN=Qe,lN=jr,hN=cN,Cg=$c("IE_PROTO"),Zl=Object,pN=Zl.prototype,$l=hN?Zl.getPrototypeOf:function(n){var t=lN(n);if(dN(t,Cg))return t[Cg];var e=t.constructor;return uN(e)&&t instanceof e?e.prototype:t instanceof Zl?pN:null},_N=D,mN=Qe,EN=bi,fN=ed,vg=$l,gN=wa,th=je("iterator"),yg=!1;[].keys&&("next"in(Tg=[].keys())?(gg=vg(vg(Tg)))!==Object.prototype&&(Vs=gg):yg=!0);var TN=!EN(Vs)||_N(function(){var n={};return Vs[th].call(n)!==n});mN((Vs=TN?{}:fN(Vs))[th])||gN(Vs,th,function(){return this});var Ig={IteratorPrototype:Vs,BUGGY_SAFARI_ITERATORS:yg},SN=Ig.IteratorPrototype,RN=ed,CN=Os,vN=vo,yN=bo,IN=function(){return this},AN=ut,bN=wi,wN=Qe,ON=String,NN=TypeError,DN=function(n,t,e){try{return AN(bN(Object.getOwnPropertyDescriptor(n,t)[e]))}catch{}},PN=Wi,LN=function(n){if(typeof n=="object"||wN(n))return n;throw NN("Can't set "+ON(n)+" as a prototype")},kN=Object.setPrototypeOf||("__proto__"in{}?function(){var n,t=!1,e={};try{(n=DN(Object.prototype,"__proto__","set"))(e,[]),t=e instanceof Array}catch{}return function(i,r){return PN(i),LN(r),t?n(i,r):i.__proto__=r,i}}():void 0),MN=le,UN=Sn,xN=Rg,VN=function(n,t,e,i){var r=t+" Iterator";return n.prototype=RN(SN,{next:CN(+!i,e)}),vN(n,r,!1,!0),yN[r]=IN,n},FN=$l,BN=vo,Ag=wa,bg=bo,jN=Ig,GN=xN.PROPER,_d=jN.BUGGY_SAFARI_ITERATORS,eh=je("iterator"),wg="keys",md="values",Og="entries",WN=function(){return this},Ng=function(n,t,e,i,r,s,o){VN(e,t,i);var a,c,d,u=function(A){if(A===r&&f)return f;if(!_d&&A in _)return _[A];switch(A){case wg:case md:case Og:return function(){return new e(this,A)}}return function(){return new e(this)}},l=t+" Iterator",p=!1,_=n.prototype,R=_[eh]||_["@@iterator"]||r&&_[r],f=!_d&&R||u(r),T=t=="Array"&&_.entries||R;if(T&&(a=FN(T.call(new n)))!==Object.prototype&&a.next&&(BN(a,l,!0,!0),bg[l]=WN),GN&&r==md&&R&&R.name!==md&&(p=!0,f=function(){return UN(R,this)}),r)if(c={values:u(md),keys:s?f:u(wg),entries:u(Og)},o)for(d in c)(_d||p||!(d in _))&&Ag(_,d,c[d]);else MN({target:t,proto:!0,forced:_d||p},c);return o&&_[eh]!==f&&Ag(_,eh,f,{name:r}),bg[t]=f,c},Dg=function(n,t){return{value:n,done:t}},HN=Ns,Pg=bo,Lg=od;Oi.f;var KN=Ng,kg=Dg,Mg="Array Iterator",YN=Lg.set,qN=Lg.getterFor(Mg);KN(Array,"Array",function(n,t){YN(this,{type:Mg,target:HN(n),index:0,kind:t})},function(){var n=qN(this),t=n.target,e=n.kind,i=n.index++;return!t||i>=t.length?(n.target=void 0,kg(void 0,!0)):kg(e=="keys"?i:e=="values"?t[i]:[i,t[i]],!1)},"values"),Pg.Arguments=Pg.Array;var JN={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},zN=vt,XN=ks,QN=Gr,Ug=bo,xg=je("toStringTag");for(var nh in JN){var Vg=zN[nh],ih=Vg&&Vg.prototype;ih&&XN(ih)!==xg&&QN(ih,xg,nh),Ug[nh]=Ug.Array}var ZN=sN,$N=je,tD=Oi.f,Fg=$N("metadata"),Bg=Function.prototype;Bg[Fg]===void 0&&tD(Bg,Fg,{value:null}),tn("dispose"),tn("metadata");var eD=ZN;tn("asyncDispose");var nD=ut,rh=Qn("Symbol"),iD=rh.keyFor,rD=nD(rh.prototype.valueOf),jg=rh.isRegisteredSymbol||function(n){try{return iD(rD(n))!==void 0}catch{return!1}};le({target:"Symbol",stat:!0},{isRegisteredSymbol:jg});for(var sD=fo,Gg=Qn,oD=ut,aD=ya,cD=je,Ed=Gg("Symbol"),Wg=Ed.isWellKnownSymbol,Hg=Gg("Object","getOwnPropertyNames"),dD=oD(Ed.prototype.valueOf),Kg=sD("wks"),sh=0,Yg=Hg(Ed),uD=Yg.length;sh<uD;sh++)try{var qg=Yg[sh];aD(Ed[qg])&&cD(qg)}catch{}var Jg=function(n){if(Wg&&Wg(n))return!0;try{for(var t=dD(n),e=0,i=Hg(Kg),r=i.length;e<r;e++)if(Kg[i[e]]==t)return!0}catch{}return!1};le({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Jg}),tn("matcher"),tn("observable"),le({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:jg}),le({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Jg}),tn("metadataKey"),tn("patternMatch"),tn("replaceAll");var wo=b(eD),oh=ut,lD=pl,hD=Sr,pD=va,_D=oh("".charAt),zg=oh("".charCodeAt),mD=oh("".slice),Xg=function(n){return function(t,e){var i,r,s=hD(pD(t)),o=lD(e),a=s.length;return o<0||o>=a?n?"":void 0:(i=zg(s,o))<55296||i>56319||o+1===a||(r=zg(s,o+1))<56320||r>57343?n?_D(s,o):i:n?mD(s,o,o+2):r-56320+(i-55296<<10)+65536}},ED={codeAt:Xg(!1),charAt:Xg(!0)}.charAt,fD=Sr,Qg=od,gD=Ng,Zg=Dg,$g="String Iterator",TD=Qg.set,SD=Qg.getterFor($g);gD(String,"String",function(n){TD(this,{type:$g,string:fD(n),index:0})},function(){var n,t=SD(this),e=t.string,i=t.index;return i>=e.length?Zg(void 0,!0):(n=ED(e,i),t.index+=n.length,Zg(n,!1))});var tT=b(Co.f("iterator"));function ka(n){return ka=typeof wo=="function"&&typeof tT=="symbol"?function(t){return typeof t}:function(t){return t&&typeof wo=="function"&&t.constructor===wo&&t!==wo.prototype?"symbol":typeof t},ka(n)}var RD=b(Co.f("toPrimitive"));function CD(n){var t=function(e,i){if(ka(e)!=="object"||e===null)return e;var r=e[RD];if(r!==void 0){var s=r.call(e,i||"default");if(ka(s)!=="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(e)}(n,"string");return ka(t)==="symbol"?t:String(t)}function h(n,t,e){return(t=CD(t))in n?L0(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}var vD=Wr("Array").keys,yD=ks,ID=Dn,AD=wt,bD=vD,ah=Array.prototype,wD={DOMTokenList:!0,NodeList:!0},$n=b(function(n){var t=n.keys;return n===ah||AD(ah,n)&&t===ah.keys||ID(wD,yD(n))?bD:t}),eT=Eo,OD=TypeError,nT=If,ND=Math.floor,ch=function(n,t){var e=n.length,i=ND(e/2);return e<8?DD(n,t):PD(n,ch(nT(n,0,i),t),ch(nT(n,i),t),t)},DD=function(n,t){for(var e,i,r=n.length,s=1;s<r;){for(i=s,e=n[s];i&&t(n[i-1],e)>0;)n[i]=n[--i];i!==s++&&(n[i]=e)}return n},PD=function(n,t,e,i){for(var r=t.length,s=e.length,o=0,a=0;o<r||a<s;)n[o+a]=o<r&&a<s?i(t[o],e[a])<=0?t[o++]:e[a++]:o<r?t[o++]:e[a++];return n},LD=ch,kD=D,dh=function(n,t){var e=[][n];return!!e&&kD(function(){e.call(null,t||function(){return 1},1)})},iT=Ds.match(/firefox\/(\d+)/i),MD=!!iT&&+iT[1],UD=/MSIE|Trident/.test(Ds),rT=Ds.match(/AppleWebKit\/(\d+)\./),xD=!!rT&&+rT[1],VD=le,sT=ut,FD=wi,BD=jr,oT=Ls,jD=function(n,t){if(!delete n[t])throw OD("Cannot delete property "+eT(t)+" of "+eT(n))},aT=Sr,uh=D,GD=LD,WD=dh,cT=MD,HD=UD,dT=Ps,uT=xD,Yr=[],lT=sT(Yr.sort),KD=sT(Yr.push),YD=uh(function(){Yr.sort(void 0)}),qD=uh(function(){Yr.sort(null)}),JD=WD("sort"),hT=!uh(function(){if(dT)return dT<70;if(!(cT&&cT>3)){if(HD)return!0;if(uT)return uT<603;var n,t,e,i,r="";for(n=65;n<76;n++){switch(t=String.fromCharCode(n),n){case 66:case 69:case 70:case 72:e=3;break;case 68:case 71:e=4;break;default:e=2}for(i=0;i<47;i++)Yr.push({k:t+i,v:e})}for(Yr.sort(function(s,o){return o.v-s.v}),i=0;i<Yr.length;i++)t=Yr[i].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return r!=="DGBEFHACIJK"}});VD({target:"Array",proto:!0,forced:YD||!qD||!JD||!hT},{sort:function(n){n!==void 0&&FD(n);var t=BD(this);if(hT)return n===void 0?lT(t):lT(t,n);var e,i,r=[],s=oT(t);for(i=0;i<s;i++)i in t&&KD(r,t[i]);for(GD(r,function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:aT(a)>aT(c)?1:-1}}(n)),e=oT(r),i=0;i<e;)t[i]=r[i++];for(;i<s;)jD(t,i++);return t}});var zD=Wr("Array").sort,XD=wt,QD=zD,lh=Array.prototype,Ma=b(function(n){var t=n.sort;return n===lh||XD(lh,n)&&t===lh.sort?QD:t}),ZD=Qn,$D=nd,tP=id,eP=Wi,nP=ut([].concat),iP=ZD("Reflect","ownKeys")||function(n){var t=$D.f(eP(n)),e=tP.f;return e?nP(t,e(n)):t},pT=Dn,rP=iP,sP=Fr,oP=Oi,aP=bi,cP=Gr,_T=Error,dP=ut("".replace),uP=String(_T("zxcasd").stack),mT=/\n\s*at [^:]*:[^\n]*/,lP=mT.test(uP),hP=Os,pP=!D(function(){var n=Error("a");return!("stack"in n)||(Object.defineProperty(n,"stack",hP(1,7)),n.stack!==7)}),_P=Gr,mP=function(n,t){if(lP&&typeof n=="string"&&!_T.prepareStackTrace)for(;t--;)n=dP(n,mT,"");return n},EP=pP,ET=Error.captureStackTrace,fP=bo,gP=je("iterator"),TP=Array.prototype,SP=ks,fT=tl,RP=Bc,CP=bo,vP=je("iterator"),gT=function(n){if(!RP(n))return fT(n,vP)||fT(n,"@@iterator")||CP[SP(n)]},yP=Sn,IP=wi,AP=Wi,bP=Eo,wP=gT,OP=TypeError,NP=Sn,TT=Wi,DP=tl,PP=Aa,LP=Sn,kP=Wi,MP=Eo,UP=function(n){return n!==void 0&&(fP.Array===n||TP[gP]===n)},xP=Ls,ST=wt,VP=function(n,t){var e=arguments.length<2?wP(n):t;if(IP(e))return AP(yP(e,n));throw OP(bP(n)+" is not iterable")},FP=gT,RT=function(n,t,e){var i,r;TT(n);try{if(!(i=DP(n,"return"))){if(t==="throw")throw e;return e}i=NP(i,n)}catch(s){r=!0,i=s}if(t==="throw")throw e;if(r)throw i;return TT(i),e},BP=TypeError,fd=function(n,t){this.stopped=n,this.result=t},CT=fd.prototype,Ua=function(n,t,e){var i,r,s,o,a,c,d,u=e&&e.that,l=!(!e||!e.AS_ENTRIES),p=!(!e||!e.IS_RECORD),_=!(!e||!e.IS_ITERATOR),R=!(!e||!e.INTERRUPTED),f=PP(t,u),T=function(N){return i&&RT(i,"normal",N),new fd(!0,N)},A=function(N){return l?(kP(N),R?f(N[0],N[1],T):f(N[0],N[1])):R?f(N,T):f(N)};if(p)i=n.iterator;else if(_)i=n;else{if(!(r=FP(n)))throw BP(MP(n)+" is not iterable");if(UP(r)){for(s=0,o=xP(n);o>s;s++)if((a=A(n[s]))&&ST(CT,a))return a;return new fd(!1)}i=VP(n,r)}for(c=p?n.next:i.next;!(d=LP(c,i)).done;){try{a=A(d.value)}catch(N){RT(i,"throw",N)}if(typeof a=="object"&&a&&ST(CT,a))return a}return new fd(!1)},jP=Sr,GP=le,WP=wt,HP=$l,gd=kN,KP=function(n,t,e){for(var i=rP(t),r=oP.f,s=sP.f,o=0;o<i.length;o++){var a=i[o];pT(n,a)||e&&pT(e,a)||r(n,a,s(t,a))}},vT=ed,hh=Gr,ph=Os,YP=function(n,t){aP(t)&&"cause"in t&&cP(n,"cause",t.cause)},qP=function(n,t,e,i){EP&&(ET?ET(n,t):_P(n,"stack",mP(e,i)))},JP=Ua,zP=function(n,t){return n===void 0?arguments.length<2?"":t:jP(n)},XP=je("toStringTag"),Td=Error,QP=[].push,Oo=function(n,t){var e,i=WP(_h,this);gd?e=gd(Td(),i?HP(this):_h):(e=i?this:vT(_h),hh(e,XP,"Error")),t!==void 0&&hh(e,"message",zP(t)),qP(e,Oo,e.stack,1),arguments.length>2&&YP(e,arguments[2]);var r=[];return JP(n,QP,{that:r}),hh(e,"errors",r),e};gd?gd(Oo,Td):KP(Oo,Td,{name:!0});var _h=Oo.prototype=vT(Td.prototype,{constructor:ph(1,Oo),message:ph(1,""),name:ph(1,"AggregateError")});GP({global:!0,constructor:!0,arity:2},{AggregateError:Oo});var xa,No,yT,mh,Va=typeof process<"u"&&Gn(process)=="process",ZP=Qn,$P=wf,tL=_i,IT=je("species"),eL=wt,nL=TypeError,iL=cf,rL=Eo,sL=TypeError,AT=Wi,oL=function(n){if(iL(n))return n;throw sL(rL(n)+" is not a constructor")},aL=Bc,cL=je("species"),bT=function(n,t){var e,i=AT(n).constructor;return i===void 0||aL(e=AT(i)[cL])?t:oL(e)},dL=TypeError,wT=/(?:ipad|iphone|ipod).*applewebkit/i.test(Ds),mi=vt,uL=bn,lL=Aa,OT=Qe,hL=Dn,NT=D,DT=ff,pL=ng,PT=cl,_L=function(n,t){if(n<t)throw dL("Not enough arguments");return n},mL=wT,EL=Va,Eh=mi.setImmediate,fh=mi.clearImmediate,fL=mi.process,gh=mi.Dispatch,gL=mi.Function,LT=mi.MessageChannel,TL=mi.String,Th=0,Fa={},kT="onreadystatechange";NT(function(){xa=mi.location});var Sh=function(n){if(hL(Fa,n)){var t=Fa[n];delete Fa[n],t()}},Rh=function(n){return function(){Sh(n)}},MT=function(n){Sh(n.data)},UT=function(n){mi.postMessage(TL(n),xa.protocol+"//"+xa.host)};Eh&&fh||(Eh=function(n){_L(arguments.length,1);var t=OT(n)?n:gL(n),e=pL(arguments,1);return Fa[++Th]=function(){uL(t,void 0,e)},No(Th),Th},fh=function(n){delete Fa[n]},EL?No=function(n){fL.nextTick(Rh(n))}:gh&&gh.now?No=function(n){gh.now(Rh(n))}:LT&&!mL?(mh=(yT=new LT).port2,yT.port1.onmessage=MT,No=lL(mh.postMessage,mh)):mi.addEventListener&&OT(mi.postMessage)&&!mi.importScripts&&xa&&xa.protocol!=="file:"&&!NT(UT)?(No=UT,mi.addEventListener("message",MT,!1)):No=kT in PT("script")?function(n){DT.appendChild(PT("script"))[kT]=function(){DT.removeChild(this),Sh(n)}}:function(n){setTimeout(Rh(n),0)});var xT={set:Eh,clear:fh},VT=function(){this.head=null,this.tail=null};VT.prototype={add:function(n){var t={item:n,next:null},e=this.tail;e?e.next=t:this.head=t,this.tail=t},get:function(){var n=this.head;if(n)return(this.head=n.next)===null&&(this.tail=null),n.item}};var Do,Ch,vh,yh,FT,BT=VT,SL=/ipad|iphone|ipod/i.test(Ds)&&typeof Pebble<"u",RL=/web0s(?!.*chrome)/i.test(Ds),Fs=vt,jT=Aa,CL=Fr.f,Ih=xT.set,vL=BT,yL=wT,IL=SL,AL=RL,Ah=Va,GT=Fs.MutationObserver||Fs.WebKitMutationObserver,WT=Fs.document,HT=Fs.process,Sd=Fs.Promise,KT=CL(Fs,"queueMicrotask"),bh=KT&&KT.value;if(!bh){var Rd=new vL,Cd=function(){var n,t;for(Ah&&(n=HT.domain)&&n.exit();t=Rd.get();)try{t()}catch(e){throw Rd.head&&Do(),e}n&&n.enter()};yL||Ah||AL||!GT||!WT?!IL&&Sd&&Sd.resolve?((yh=Sd.resolve(void 0)).constructor=Sd,FT=jT(yh.then,yh),Do=function(){FT(Cd)}):Ah?Do=function(){HT.nextTick(Cd)}:(Ih=jT(Ih,Fs),Do=function(){Ih(Cd)}):(Ch=!0,vh=WT.createTextNode(""),new GT(Cd).observe(vh,{characterData:!0}),Do=function(){vh.data=Ch=!Ch}),bh=function(n){Rd.head||Do(),Rd.add(n)}}var bL=bh,Po=function(n){try{return{error:!1,value:n()}}catch(t){return{error:!0,value:t}}},Bs=vt.Promise,YT=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",wL=!YT&&!Va&&typeof window=="object"&&typeof document=="object",OL=vt,Ba=Bs,NL=Qe,DL=iE,PL=nf,LL=je,kL=wL,ML=YT,wh=Ps,qT=Ba&&Ba.prototype,UL=LL("species"),JT=!1,zT=NL(OL.PromiseRejectionEvent),xL=DL("Promise",function(){var n=PL(Ba),t=n!==String(Ba);if(!t&&wh===66||!qT.catch||!qT.finally)return!0;if(!wh||wh<51||!/native code/.test(n)){var e=new Ba(function(r){r(1)}),i=function(r){r(function(){},function(){})};if((e.constructor={})[UL]=i,!(JT=e.then(function(){})instanceof i))return!0}return!t&&(kL||ML)&&!zT}),ja={CONSTRUCTOR:xL,REJECTION_EVENT:zT,SUBCLASSING:JT},ir={},XT=wi,VL=TypeError,FL=function(n){var t,e;this.promise=new n(function(i,r){if(t!==void 0||e!==void 0)throw VL("Bad Promise constructor");t=i,e=r}),this.resolve=XT(t),this.reject=XT(e)};ir.f=function(n){return new FL(n)};var Oh,QT,BL=le,vd=Va,qr=vt,Ga=Sn,jL=wa,GL=vo,WL=function(n){var t=ZP(n);tL&&t&&!t[IT]&&$P(t,IT,{configurable:!0,get:function(){return this}})},HL=wi,Nh=Qe,KL=bi,YL=function(n,t){if(eL(t,n))return n;throw nL("Incorrect invocation")},qL=bT,ZT=xT.set,Dh=bL,JL=function(n,t){try{arguments.length==1?console.error(n):console.error(n,t)}catch{}},zL=Po,XL=BT,$T=od,Ph=Bs,tS=ja,eS=ir,yd="Promise",nS=tS.CONSTRUCTOR,QL=tS.REJECTION_EVENT,Lh=$T.getterFor(yd),ZL=$T.set,$L=Ph&&Ph.prototype,Wa=Ph,kh=$L,iS=qr.TypeError,Mh=qr.document,Uh=qr.process,xh=eS.f,tk=xh,ek=!!(Mh&&Mh.createEvent&&qr.dispatchEvent),rS="unhandledrejection",sS=function(n){var t;return!(!KL(n)||!Nh(t=n.then))&&t},oS=function(n,t){var e,i,r,s=t.value,o=t.state==1,a=o?n.ok:n.fail,c=n.resolve,d=n.reject,u=n.domain;try{a?(o||(t.rejection===2&&ik(t),t.rejection=1),a===!0?e=s:(u&&u.enter(),e=a(s),u&&(u.exit(),r=!0)),e===n.promise?d(iS("Promise-chain cycle")):(i=sS(e))?Ga(i,e,c,d):c(e)):d(s)}catch(l){u&&!r&&u.exit(),d(l)}},aS=function(n,t){n.notified||(n.notified=!0,Dh(function(){for(var e,i=n.reactions;e=i.get();)oS(e,n);n.notified=!1,t&&!n.rejection&&nk(n)}))},cS=function(n,t,e){var i,r;ek?((i=Mh.createEvent("Event")).promise=t,i.reason=e,i.initEvent(n,!1,!0),qr.dispatchEvent(i)):i={promise:t,reason:e},!QL&&(r=qr["on"+n])?r(i):n===rS&&JL("Unhandled promise rejection",e)},nk=function(n){Ga(ZT,qr,function(){var t,e=n.facade,i=n.value;if(dS(n)&&(t=zL(function(){vd?Uh.emit("unhandledRejection",i,e):cS(rS,e,i)}),n.rejection=vd||dS(n)?2:1,t.error))throw t.value})},dS=function(n){return n.rejection!==1&&!n.parent},ik=function(n){Ga(ZT,qr,function(){var t=n.facade;vd?Uh.emit("rejectionHandled",t):cS("rejectionhandled",t,n.value)})},Lo=function(n,t,e){return function(i){n(t,i,e)}},ko=function(n,t,e){n.done||(n.done=!0,e&&(n=e),n.value=t,n.state=2,aS(n,!0))},Vh=function(n,t,e){if(!n.done){n.done=!0,e&&(n=e);try{if(n.facade===t)throw iS("Promise can't be resolved itself");var i=sS(t);i?Dh(function(){var r={done:!1};try{Ga(i,t,Lo(Vh,r,n),Lo(ko,r,n))}catch(s){ko(r,s,n)}}):(n.value=t,n.state=1,aS(n,!1))}catch(r){ko({done:!1},r,n)}}};nS&&(kh=(Wa=function(n){YL(this,kh),HL(n),Ga(Oh,this);var t=Lh(this);try{n(Lo(Vh,t),Lo(ko,t))}catch(e){ko(t,e)}}).prototype,(Oh=function(n){ZL(this,{type:yd,done:!1,notified:!1,parent:!1,reactions:new XL,rejection:!1,state:0,value:void 0})}).prototype=jL(kh,"then",function(n,t){var e=Lh(this),i=xh(qL(this,Wa));return e.parent=!0,i.ok=!Nh(n)||n,i.fail=Nh(t)&&t,i.domain=vd?Uh.domain:void 0,e.state==0?e.reactions.add(i):Dh(function(){oS(i,e)}),i.promise}),QT=function(){var n=new Oh,t=Lh(n);this.promise=n,this.resolve=Lo(Vh,t),this.reject=Lo(ko,t)},eS.f=xh=function(n){return n===Wa||n===void 0?new QT(n):tk(n)}),BL({global:!0,constructor:!0,wrap:!0,forced:nS},{Promise:Wa}),GL(Wa,yd,!1,!0),WL(yd);var uS=je("iterator"),lS=!1;try{var rk=0,hS={next:function(){return{done:!!rk++}},return:function(){lS=!0}};hS[uS]=function(){return this},Array.from(hS,function(){throw 2})}catch{}var sk=Bs,ok=function(n,t){if(!t&&!lS)return!1;var e=!1;try{var i={};i[uS]=function(){return{next:function(){return{done:e=!0}}}},n(i)}catch{}return e},Id=ja.CONSTRUCTOR||!ok(function(n){sk.all(n).then(void 0,function(){})}),ak=Sn,ck=wi,dk=ir,uk=Po,lk=Ua;le({target:"Promise",stat:!0,forced:Id},{all:function(n){var t=this,e=dk.f(t),i=e.resolve,r=e.reject,s=uk(function(){var o=ck(t.resolve),a=[],c=0,d=1;lk(n,function(u){var l=c++,p=!1;d++,ak(o,t,u).then(function(_){p||(p=!0,a[l]=_,--d||i(a))},r)}),--d||i(a)});return s.error&&r(s.value),e.promise}});var hk=le,pk=ja.CONSTRUCTOR;Bs&&Bs.prototype,hk({target:"Promise",proto:!0,forced:pk,real:!0},{catch:function(n){return this.then(void 0,n)}});var _k=Sn,mk=wi,Ek=ir,fk=Po,gk=Ua;le({target:"Promise",stat:!0,forced:Id},{race:function(n){var t=this,e=Ek.f(t),i=e.reject,r=fk(function(){var s=mk(t.resolve);gk(n,function(o){_k(s,t,o).then(e.resolve,i)})});return r.error&&i(r.value),e.promise}});var Tk=Sn,Sk=ir;le({target:"Promise",stat:!0,forced:ja.CONSTRUCTOR},{reject:function(n){var t=Sk.f(this);return Tk(t.reject,void 0,n),t.promise}});var Rk=Wi,Ck=bi,vk=ir,pS=function(n,t){if(Rk(n),Ck(t)&&t.constructor===n)return t;var e=vk.f(n);return(0,e.resolve)(t),e.promise},yk=le,Ik=Bs,Ak=ja.CONSTRUCTOR,bk=pS,wk=Qn("Promise"),Ok=!Ak;yk({target:"Promise",stat:!0,forced:!0},{resolve:function(n){return bk(Ok&&this===wk?Ik:this,n)}});var Nk=Sn,Dk=wi,Pk=ir,Lk=Po,kk=Ua;le({target:"Promise",stat:!0,forced:Id},{allSettled:function(n){var t=this,e=Pk.f(t),i=e.resolve,r=e.reject,s=Lk(function(){var o=Dk(t.resolve),a=[],c=0,d=1;kk(n,function(u){var l=c++,p=!1;d++,Nk(o,t,u).then(function(_){p||(p=!0,a[l]={status:"fulfilled",value:_},--d||i(a))},function(_){p||(p=!0,a[l]={status:"rejected",reason:_},--d||i(a))})}),--d||i(a)});return s.error&&r(s.value),e.promise}});var Mk=Sn,Uk=wi,xk=Qn,Vk=ir,Fk=Po,Bk=Ua,_S="No one promise resolved";le({target:"Promise",stat:!0,forced:Id},{any:function(n){var t=this,e=xk("AggregateError"),i=Vk.f(t),r=i.resolve,s=i.reject,o=Fk(function(){var a=Uk(t.resolve),c=[],d=0,u=1,l=!1;Bk(n,function(p){var _=d++,R=!1;u++,Mk(a,t,p).then(function(f){R||l||(l=!0,r(f))},function(f){R||l||(R=!0,c[_]=f,--u||s(new e(c,_S)))})}),--u||s(new e(c,_S))});return o.error&&s(o.value),i.promise}});var jk=le,Fh=Bs,Gk=D,Wk=Qn,Hk=Qe,Kk=bT,mS=pS,Yk=Fh&&Fh.prototype;jk({target:"Promise",proto:!0,real:!0,forced:!!Fh&&Gk(function(){Yk.finally.call({then:function(){}},function(){})})},{finally:function(n){var t=Kk(this,Wk("Promise")),e=Hk(n);return this.then(e?function(i){return mS(t,n()).then(function(){return i})}:n,e?function(i){return mS(t,n()).then(function(){throw i})}:n)}});var ES=Tr.Promise,F=b(ES);const qk=()=>{};function Ha(){const n={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:qk};return n.promise=new F((t,e)=>{n.resolve=i=>{n.isFinished||(n.isResolved=!0,n.isFinished=!0,t(i),n.value=i)},n.reject=i=>{n.isFinished||(n.isRejected=!0,n.isFinished=!0,e(i))}}),n}const Ad=new Map,bd=new Map,rr=new Map;var Ne,xt;(function(n){n.WIN_10="Windows 10",n.WIN_81="Windows 8.1",n.WIN_8="Windows 8",n.WIN_7="Windows 7",n.WIN_VISTA="Windows Vista",n.WIN_SERVER_2003="Windows Server 2003",n.WIN_XP="Windows XP",n.WIN_2000="Windows 2000",n.ANDROID="Android",n.HARMONY_OS="HarmonyOS",n.OPEN_BSD="Open BSD",n.SUN_OS="Sun OS",n.LINUX="Linux",n.IOS="iOS",n.MAC_OS="Mac OS",n.CHROMIUM_OS="Chromium OS",n.QNX="QNX",n.UNIX="UNIX",n.BEOS="BeOS",n.OS_2="OS/2",n.SEARCH_BOT="Search Bot"})(Ne||(Ne={})),function(n){n.CHROME="Chrome",n.SAFARI="Safari",n.EDGE="Edge",n.FIREFOX="Firefox",n.OPERA="OPR",n.QQ="QQBrowser",n.WECHAT="MicroMessenger"}(xt||(xt={}));var Bh={exports:{}};(function(n,t){(function(e,i){var r="function",s="undefined",o="object",a="string",c="major",d="model",u="name",l="type",p="vendor",_="version",R="architecture",f="console",T="mobile",A="tablet",N="smarttv",P="wearable",j="embedded",M="Amazon",U="Apple",B="ASUS",V="BlackBerry",q="Browser",z="Chrome",mt="Firefox",Rt="Google",te="Huawei",we="LG",ie="Microsoft",qn="Motorola",K="Opera",X="Samsung",et="Sharp",ft="Sony",kt="Xiaomi",Q="Zebra",E="Facebook",w="Chromium OS",L="Mac OS",J=function(Ee){for(var Oe={},re=0;re<Ee.length;re++)Oe[Ee[re].toUpperCase()]=Ee[re];return Oe},gt=function(Ee,Oe){return typeof Ee===a&&ee(Oe).indexOf(ee(Ee))!==-1},ee=function(Ee){return Ee.toLowerCase()},cn=function(Ee,Oe){if(typeof Ee===a)return Ee=Ee.replace(/^\s\s*/,""),typeof Oe===s?Ee:Ee.substring(0,350)},Jn=function(Ee,Oe){for(var re,zn,gr,fe,Mt,Bn,vs=0;vs<Oe.length&&!Mt;){var Zi=Oe[vs],vI=Oe[vs+1];for(re=zn=0;re<Zi.length&&!Mt&&Zi[re];)if(Mt=Zi[re++].exec(Ee))for(gr=0;gr<vI.length;gr++)Bn=Mt[++zn],typeof(fe=vI[gr])===o&&fe.length>0?fe.length===2?typeof fe[1]==r?this[fe[0]]=fe[1].call(this,Bn):this[fe[0]]=fe[1]:fe.length===3?typeof fe[1]!==r||fe[1].exec&&fe[1].test?this[fe[0]]=Bn?Bn.replace(fe[1],fe[2]):i:this[fe[0]]=Bn?fe[1].call(this,Bn,fe[2]):i:fe.length===4&&(this[fe[0]]=Bn?fe[3].call(this,Bn.replace(fe[1],fe[2])):i):this[fe]=Bn||i;vs+=2}},xr=function(Ee,Oe){for(var re in Oe)if(typeof Oe[re]===o&&Oe[re].length>0){for(var zn=0;zn<Oe[re].length;zn++)if(gt(Oe[re][zn],Ee))return re==="?"?i:re}else if(gt(Oe[re],Ee))return re==="?"?i:re;return Ee},Gu={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Wu={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[_,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[_,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,_],[/opios[\/ ]+([\w\.]+)/i],[_,[u,K+" Mini"]],[/\bopr\/([\w\.]+)/i],[_,[u,K]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[u,_],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[_,[u,"UC"+q]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[_,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[_,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[_,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[_,[u,"IE"]],[/yabrowser\/([\w\.]+)/i],[_,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure "+q],_],[/\bfocus\/([\w\.]+)/i],[_,[u,mt+" Focus"]],[/\bopt\/([\w\.]+)/i],[_,[u,K+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[_,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[_,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[_,[u,K+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[_,[u,"MIUI "+q]],[/fxios\/([-\w\.]+)/i],[_,[u,mt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 "+q]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 "+q],_],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],_],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,_],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,E],_],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,_],[/\bgsa\/([\w\.]+) .*safari\//i],[_,[u,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[_,[u,z+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,z+" WebView"],_],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[_,[u,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,_],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[_,[u,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[_,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[_,xr,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,_],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],_],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[_,[u,mt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[u,_],[/(cobalt)\/([\w\.]+)/i],[u,[_,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[R,"amd64"]],[/(ia32(?=;))/i],[[R,ee]],[/((?:i[346]|x)86)[;\)]/i],[[R,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[R,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[R,"armhf"]],[/windows (ce|mobile); ppc;/i],[[R,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[R,/ower/,"",ee]],[/(sun4\w)[;\)]/i],[[R,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[R,ee]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,X],[l,A]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,X],[l,T]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[p,U],[l,T]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,U],[l,A]],[/(macintosh);/i],[d,[p,U]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,et],[l,T]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[p,te],[l,A]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,te],[l,T]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[p,kt],[l,T]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[p,kt],[l,A]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,"OPPO"],[l,T]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[l,T]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[l,T]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,qn],[l,T]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,qn],[l,A]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,we],[l,A]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,we],[l,T]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[p,"Lenovo"],[l,A]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[p,"Nokia"],[l,T]],[/(pixel c)\b/i],[d,[p,Rt],[l,A]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,Rt],[l,T]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,ft],[l,T]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,ft],[l,A]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,"OnePlus"],[l,T]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,M],[l,A]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,M],[l,T]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[l,A]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,V],[l,T]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,B],[l,A]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,B],[l,T]],[/(nexus 9)/i],[d,[p,"HTC"],[l,A]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[l,T]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[l,A]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[l,T]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[l,T]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[l,A]],[/(surface duo)/i],[d,[p,ie],[l,A]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[l,T]],[/(u304aa)/i],[d,[p,"AT&T"],[l,T]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[l,T]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[l,A]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[l,A]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[l,A]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[l,A]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[l,A]],[/\b(k88) b/i],[d,[p,"ZTE"],[l,A]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[l,T]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[l,T]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[l,A]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[l,A]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[l,A]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[l,A]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[l,A]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[l,T]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[l,T]],[/\b(ph-1) /i],[d,[p,"Essential"],[l,T]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[l,A]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[l,A]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[l,A]],[/(shield[\w ]+) b/i],[d,[p,"Nvidia"],[l,A]],[/(sprint) (\w+)/i],[p,d,[l,T]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,ie],[l,T]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,Q],[l,A]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,Q],[l,T]],[/smart-tv.+(samsung)/i],[p,[l,N]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,X],[l,N]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,we],[l,N]],[/(apple) ?tv/i],[p,[d,U+" TV"],[l,N]],[/crkey/i],[[d,z+"cast"],[p,Rt],[l,N]],[/droid.+aft(\w)( bui|\))/i],[d,[p,M],[l,N]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,et],[l,N]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,ft],[l,N]],[/(mitv-\w{5}) bui/i],[d,[p,kt],[l,N]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[l,N]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,cn],[d,cn],[l,N]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,N]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[l,f]],[/droid.+; (shield) bui/i],[d,[p,"Nvidia"],[l,f]],[/(playstation [345portablevi]+)/i],[d,[p,ft],[l,f]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,ie],[l,f]],[/((pebble))app/i],[p,d,[l,P]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,U],[l,P]],[/droid.+; (glass) \d/i],[d,[p,Rt],[l,P]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,Q],[l,P]],[/(quest( 2| pro)?)/i],[d,[p,E],[l,P]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[l,j]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[l,T]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[l,A]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,A]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,T]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[_,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[_,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[u,_],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[_,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,_],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[_,xr,Gu]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[_,xr,Gu]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[_,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,L],[_,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[_,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,_],[/\(bb(10);/i],[_,[u,V]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[_,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[_,[u,mt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[_,[u,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[_,[u,"watchOS"]],[/crkey\/([\d\.]+)/i],[_,[u,z+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[u,w],_],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,_],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],_],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[u,_]]},Ai=function(Ee,Oe){if(typeof Ee===o&&(Oe=Ee,Ee=i),!(this instanceof Ai))return new Ai(Ee,Oe).getResult();var re=typeof e!==s&&e.navigator?e.navigator:i,zn=Ee||(re&&re.userAgent?re.userAgent:""),gr=re&&re.userAgentData?re.userAgentData:i,fe=Oe?function(Mt,Bn){var vs={};for(var Zi in Mt)Bn[Zi]&&Bn[Zi].length%2==0?vs[Zi]=Bn[Zi].concat(Mt[Zi]):vs[Zi]=Mt[Zi];return vs}(Wu,Oe):Wu;return this.getBrowser=function(){var Mt={};return Mt[u]=i,Mt[_]=i,Jn.call(Mt,zn,fe.browser),Mt[c]=function(Bn){return typeof Bn===a?Bn.replace(/[^\d\.]/g,"").split(".")[0]:i}(Mt[_]),re&&re.brave&&typeof re.brave.isBrave==r&&(Mt[u]="Brave"),Mt},this.getCPU=function(){var Mt={};return Mt[R]=i,Jn.call(Mt,zn,fe.cpu),Mt},this.getDevice=function(){var Mt={};return Mt[p]=i,Mt[d]=i,Mt[l]=i,Jn.call(Mt,zn,fe.device),!Mt[l]&&gr&&gr.mobile&&(Mt[l]=T),Mt[d]=="Macintosh"&&re&&typeof re.standalone!==s&&re.maxTouchPoints&&re.maxTouchPoints>2&&(Mt[d]="iPad",Mt[l]=A),Mt},this.getEngine=function(){var Mt={};return Mt[u]=i,Mt[_]=i,Jn.call(Mt,zn,fe.engine),Mt},this.getOS=function(){var Mt={};return Mt[u]=i,Mt[_]=i,Jn.call(Mt,zn,fe.os),!Mt[u]&&gr&&gr.platform!="Unknown"&&(Mt[u]=gr.platform.replace(/chrome os/i,w).replace(/macos/i,L)),Mt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return zn},this.setUA=function(Mt){return zn=typeof Mt===a&&Mt.length>350?cn(Mt,350):Mt,this},this.setUA(zn),this};Ai.VERSION="0.7.34",Ai.BROWSER=J([u,_,c]),Ai.CPU=J([R]),Ai.DEVICE=J([d,p,l,f,T,N,A,P,j]),Ai.ENGINE=Ai.OS=J([u,_]),n.exports&&(t=n.exports=Ai),t.UAParser=Ai;var Cs=typeof e!==s&&(e.jQuery||e.Zepto);if(Cs&&!Cs.ua){var ma=new Ai;Cs.ua=ma.getResult(),Cs.ua.get=function(){return ma.getUA()},Cs.ua.set=function(Ee){ma.setUA(Ee);var Oe=ma.getResult();for(var re in Oe)Cs.ua[re]=Oe[re]}}})(typeof window=="object"?window:g)})(Bh,Bh.exports);const jh=new(b(Bh.exports));let Cr=jh.getResult(),Gh=null;function Lt(n){if(!Gh){n&&jh.setUA(n),Cr=jh.getResult();const t=function(s){if(s.engine.name==="Blink"&&s.browser.name!=="WeChat")return xt.CHROME;switch(s.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return xt.CHROME;case"Safari":case"Mobile Safari":return xt.SAFARI;case"Edge":return xt.EDGE;case"Firefox":return xt.FIREFOX;case"QQBrowser":return xt.QQ;case"Opera":return xt.OPERA;case"WeChat":return xt.WECHAT;default:return s.browser.name||""}}(Cr),e=function(s){let o;return o=s.engine.name==="Blink"?s.engine.version||"":s.browser.version||"",o.split(".")[0]}(Cr),i=function(s){return s.os.name==="Windows"?s.os.version?s.os.name+" "+s.os.version:s.os.name:s.os.name||""}(Cr),r=Cr.os.version;if(!(t&&e&&i&&r))return{name:t,version:e,os:i,osVersion:r};Gh={name:t,version:e,os:i,osVersion:r}}return Gh}function wd(){return Lt().os}function fS(){const n=Lt();return"".concat(n.os," ").concat(n.osVersion)}function Od(){const n=Lt();return!!(Cr.engine.name==="WebKit"&&n.os===Ne.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&n.name!==xt.SAFARI||gn()&&n.name!==xt.SAFARI)}function Jk(){const n=Lt();if(Od()){if(n.os===Ne.MAC_OS)return!0;if(n.os===Ne.IOS){const t=Cr.os.version&&Cr.os.version.split(".");if(t&&Number(t[0])===14&&t[1]&&Number(t[1])>=3||t&&Number(t[0])>14)return!0}}return!1}function zk(){return Cr.engine.name==="WebKit"}function Ka(){return Lt().name===xt.CHROME}function fn(){return Lt().name===xt.SAFARI}function Jt(){return Lt().name===xt.FIREFOX}function gn(){return Lt().os===Ne.IOS}function Wh(n){const t=Lt();return!(t.name!==xt.CHROME||!t.osVersion)&&Number(t.version)>=n}function gS(n){const t=Lt();return!(t.name!==xt.EDGE||!t.osVersion)&&Number(t.version)>=n}function TS(n){const t=Lt();return!(t.name!==xt.OPERA||!t.osVersion)&&Number(t.version)>=n}function SS(){const n=Lt();return!(n.name!==xt.CHROME||!n.osVersion)&&Number(n.version)<=90}function RS(){const n=Lt();if(n.os!==Ne.IOS||!n.osVersion)return!1;const t=n.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function Mo(){const n=Lt();if(n.os!==Ne.IOS||!n.osVersion)return!1;const t=n.osVersion.split(".");return Number(t[0])===15}function Hh(){const n=Lt();if(n.os!==Ne.IOS||!n.osVersion)return!1;const t=n.osVersion.split(".");return Number(t[0])===16}function CS(){const n=Lt();if(n.os!==Ne.IOS||!n.osVersion)return!1;const t=n.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function sr(){return fn()&&navigator.maxTouchPoints>0}function vS(){return Lt().name===xt.WECHAT}function yS(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Jr(){const n=Lt();return n.name===xt.EDGE||n.name===xt.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Nd(){return wd()===Ne.ANDROID}function Ya(){const n=Lt();return Nd()&&(n.name===xt.CHROME||n.name===xt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var v;(function(n){n.UNEXPECTED_ERROR="UNEXPECTED_ERROR",n.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",n.TIMEOUT="TIMEOUT",n.INVALID_PARAMS="INVALID_PARAMS",n.NOT_READABLE="NOT_READABLE",n.NOT_SUPPORTED="NOT_SUPPORTED",n.INVALID_OPERATION="INVALID_OPERATION",n.OPERATION_ABORTED="OPERATION_ABORTED",n.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",n.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",n.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",n.DATACHANNEL_FAILED="DATACHANNEL_FAILED",n.NETWORK_ERROR="NETWORK_ERROR",n.NETWORK_TIMEOUT="NETWORK_TIMEOUT",n.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",n.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",n.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",n.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",n.ELECTRON_IS_NULL="ELECTRON_IS_NULL",n.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",n.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",n.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",n.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",n.TRACK_IS_DISABLED="TRACK_IS_DISABLED",n.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",n.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",n.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",n.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",n.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",n.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",n.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",n.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",n.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",n.UID_CONFLICT="UID_CONFLICT",n.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",n.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",n.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",n.INVALID_TRACK="INVALID_TRACK",n.SENDER_NOT_FOUND="SENDER_NOT_FOUND",n.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",n.SET_ANSWER_FAILED="SET_ANSWER_FAILED",n.ICE_FAILED="ICE_FAILED",n.PC_CLOSED="PC_CLOSED",n.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",n.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",n.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",n.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",n.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",n.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",n.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",n.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",n.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",n.INVALID_REMOTE_USER="INVALID_REMOTE_USER",n.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",n.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",n.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",n.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",n.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",n.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",n.WS_ABORT="WS_ABORT",n.WS_DISCONNECT="WS_DISCONNECT",n.WS_ERR="WS_ERR",n.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",n.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",n.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",n.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",n.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",n.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",n.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",n.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",n.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",n.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",n.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",n.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",n.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",n.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",n.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",n.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",n.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",n.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",n.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",n.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",n.INVALID_PLUGIN="INVALID_PLUGIN",n.DISCONNECT_P2P="DISCONNECT_P2P",n.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",n.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",n.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",n.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",n.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",n.PROHIBITED_OPERATION="PROHIBITED_OPERATION",n.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",n.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"})(v||(v={}));let G=class extends Error{constructor(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",e=arguments.length>2?arguments[2]:void 0;super(t),h(this,"code",void 0),h(this,"message",void 0),h(this,"data",void 0),h(this,"name","AgoraRTCException"),this.code=n,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=e}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return n==="error"&&(t||console).error(this.toString()),n==="warning"&&(t||console).warn(this.toString()),this}throw(n){throw this.print("error",n),this}};function zr(n,t){if(typeof n!="boolean")throw new G(v.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function De(n,t,e){if(!nt(e).call(e,n))throw new G(v.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(e)))}function Wt(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(n<e||n>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(n))throw new G(v.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(e,", ").concat(i,"]. integer only"))}function Kh(n,t){if(typeof n!="number"){if(!(n.min||n.max||n.ideal||n.exact))throw new G(v.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));n.min!==void 0&&Wt(n.min,"".concat(t,".min"),0,1/0),n.max!==void 0&&Wt(n.max,"".concat(t,".max"),1,1/0),n.exact!==void 0&&Wt(n.exact,"".concat(t,".exact"),1,1/0),n.ideal!==void 0&&Wt(n.ideal,"".concat(t,".ideal"),1,1/0)}else Wt(n,t,1,1/0)}function en(n,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(n==null)throw new G(v.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!IS(n,e,i,r))throw new G(v.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(e,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function vr(n,t){if(!Array.isArray(n))throw new G(v.INVALID_PARAMS,"".concat(t," should be an array"))}function ae(n){return n==null}function IS(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof n=="string"&&n.length<=e&&n.length>=t&&(!i||function(r){if(typeof r!="string")return!1;for(let s=0;s<r.length;s+=1){const o=r.charCodeAt(s);if(o<0||o>255)return!1}return!0}(n))}function AS(n,t,e){if("getBigUint64"in DataView.prototype)return n.getBigUint64(t,e);const i=n.getUint32(t,e),r=n.getUint32(t+4,e),s=+!!e,o=+!e;return BigInt(i*o+r*s)<<BigInt(32)|BigInt(i*s+r*o)}function bS(n,t,e,i){if("setBigUint64"in DataView.prototype)return n.setBigUint64(t,e,i);const r=Number(e>>BigInt(32)),s=Number(e&BigInt(4294967295));i?(n.setUint32(t+4,r,i),n.setUint32(t,s,i)):(n.setUint32(t,r,i),n.setUint32(t+4,s,i))}var Uo,Dd;(function(n){n.COVERED="COVERED",n.POSITION="POSITION",n.SIZE="SIZE",n.STYLE="STYLE"})(Uo||(Uo={})),function(n){n.UNMOUNTED="UNMOUNTED",n.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(Dd||(Dd={}));const wS=new class{constructor(){h(this,"_clientSize",null),h(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),h(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),h(this,"getStyle",n=>window.getComputedStyle(n,null)),h(this,"checkCssVisibleProperty",n=>{var t;let e=!0;const i=this.getStyle(n),{display:r,visibility:s,opacity:o,filter:a}=i;return(r==="none"||nt(t=["hidden","collapse"]).call(t,s)||Number(o)<.1)&&(e=!1),e?(a&&a.split(" ").filter(c=>{var d;const u=c.split("(")[0];return nt(d=["brightness","blur","opacity"]).call(d,u)}).map(c=>{const[d,u]=c.split(/\(|\)/);return[d,Number(u.match(/^[0-9\.]+/))]}).forEach(c=>{const[d,u]=c;switch(d){case"brightness":(u<.1||u>3)&&(e=!1);break;case"blur":u>3&&(e=!1);break;case"opacity":u<.1&&(e=!1)}}),e):!1}),h(this,"checkPropertyUpToAllParentNodes",(n,t)=>{let e=!0,i=!0;const r=o=>t(o);let s=n;for(;s&&i;)r(s)||(e=!1,i=!1),s=s.parentElement,s||(i=!1);return e}),h(this,"checkActualCssVisibleIncludeInherit",n=>this.checkPropertyUpToAllParentNodes(n,this.checkCssVisibleProperty)),h(this,"getSizeAboutClient",n=>{const{width:t,height:e,left:i,right:r,top:s,bottom:o}=n.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:e,left:i,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),h(this,"checkActualSize",()=>{const{width:n,height:t,clientMin:e}=this._clientSize;return this.checkSizeIsVisible(n,t,e)}),h(this,"elementFromPoint",(n,t)=>document.elementFromPoint?document.elementFromPoint(n,t):null),h(this,"checkCoverForAPoint",(n,t,e)=>{const i=this.elementFromPoint(n,t);return i!==null&&i!==e}),h(this,"getPointPositionList",()=>{const{width:n,height:t,left:e,top:i}=this._clientSize,r=n/6,s=t/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const u=(e*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,l=(i*a+(d===0?.1:d===4?(s*d*a-1e5)/a:s*d)*a)/a;o.push({x:u,y:l})}return[...o]}),h(this,"checkElementCover",n=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,n)).filter(t=>!!t).length>6),h(this,"checkSizeIsVisible",(n,t,e)=>(n>50||e/n<=10)&&(t>50||e/t<=10)),h(this,"checkSizeOfPartInClient",()=>{const{left:n,right:t,top:e,bottom:i,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,d,u;if(n<0)a=0;else{if(!(n<s))return!1;a=n}if(t<0)return!1;if(c=t<s?t:s,e<0)d=0;else{if(!(e<r))return!1;d=e}if(i<0)return!1;u=i<r?i:r;const l=c-a,p=u-d;return this.checkSizeIsVisible(l,p,o)}),h(this,"returnHiddenResult",n=>(this._clientSize=null,{visible:!1,reason:n})),h(this,"checkOneElementVisible",n=>{if(n instanceof HTMLElement){if(this.checkElementIsMountedOnDom(n)){if(this.checkActualCssVisibleIncludeInherit(n)){if(this._clientSize=this.getSizeAboutClient(n),this.checkElementCover(n))return this.returnHiddenResult(Uo.COVERED);{const t=this.checkActualSize(),e=this.checkSizeOfPartInClient();return t&&!e?this.returnHiddenResult(Uo.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Uo.SIZE)}}return this.returnHiddenResult(Uo.STYLE)}return this.returnHiddenResult(Dd.UNMOUNTED)}return this.returnHiddenResult(Dd.INVALID_HTML_ELEMENT)}),h(this,"checkElementIsMountedOnDom",n=>this.checkPropertyUpToAllParentNodes(n,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function Yh(n){return new TextEncoder().encode(n)}const OS=function(n,t){const e=new Uint8Array(n.byteLength+t.byteLength);return e.set(new Uint8Array(n),0),e.set(new Uint8Array(t),n.byteLength),e},Xk=async n=>{const t=function(s){const o=window.atob(s),a=new Uint8Array(new ArrayBuffer(o.length));for(let c=0;c<o.length;c+=1)a[c]=o.charCodeAt(c);return a}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),e=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),i=Yh(n),r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,i);return function(s){let o="";for(let a=0;a<s.length;a+=1)o+=String.fromCharCode(s[a]);return window.btoa(o)}(new Uint8Array(r))},qh=async n=>function(t,e){let i="";return new Uint8Array(t).forEach(r=>{i+=r.toString(e).padStart(2,"0")}),i}(await crypto.subtle.digest("SHA-256",Yh(n)),16);class se{constructor(){h(this,"_events",{}),h(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const i=this._events[t],r=this._indexOfListener(i,e);r!==-1&&i.splice(r,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map(o=>o);for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];for(let o=0;o<e.length;o+=1){const a=e[o];a.once&&this.off(t,a.listener),a.listener.apply(this,r||[])}}safeEmit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];[...this._events[t]||[]].forEach(s=>{s.once&&this.off(t,s.listener);try{s.listener.apply(this,i)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(t,e){let i=t.length;for(;i--;)if(t[i].listener===e)return i;return-1}}let qa=null;function NS(){if(qa)return qa;if(window.electron)return qa=window.electron;if(!window.require)return null;try{return qa=window.require("electron"),qa}catch{return null}}var Ae,ce,Jh,Ot,Nt,Ge,Tn,yr;function DS(n){return Wt(n.timeout,"config.timeout",0,1e5),Wt(n.timeoutFactor,"config.timeoutFactor",0,100,!1),Wt(n.maxRetryCount,"config.maxRetryConfig",0,1/0),Wt(n.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function xo(n){if(!Array.isArray(n)||n.length<1)return!1;try{n.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function PS(n){return en(n.turnServerURL,"turnServerURL"),en(n.username,"username"),en(n.password,"password"),n.udpport&&Wt(n.udpport,"udpport",1,99999,!0),n.forceturn&&zr(n.forceturn,"forceturn"),n.security&&zr(n.security,"security"),n.tcpport&&Wt(n.tcpport,"tcpport",1,99999,!0),!0}function LS(n){return n.level!==void 0&&De(n.level,"level",[1,2,3]),n.delay!==void 0&&Wt(n.delay,"delay",0,3e3,!0),!0}function Se(n,t){for(var e=arguments.length,i=new Array(e>2?e-2:0),r=2;r<e;r++)i[r-2]=arguments[r];return n.getListeners(t).length===0?F.reject(new G(v.UNEXPECTED_ERROR,"can not emit promise")):new F((s,o)=>{n.emit(t,...i,s,o)})}function Xt(n,t){if(n.getListeners(t).length===0)return F.resolve();for(var e=arguments.length,i=new Array(e>2?e-2:0),r=2;r<e;r++)i[r-2]=arguments[r];return Se(n,t,...i)}function Wn(n,t){if(n.getListeners(t).length===0)return null;for(var e=arguments.length,i=new Array(e>2?e-2:0),r=2;r<e;r++)i[r-2]=arguments[r];return js(n,t,...i)}function js(n,t){let e=null,i=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(n.emit(t,...s,a=>{e=a},a=>{i=a}),i!==null)throw i;if(e===null)throw new G(v.UNEXPECTED_ERROR,"handler is not sync");return e}(function(n){n.CREATE_CLIENT="createClient",n.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",n.SET_AREA="setArea",n.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",n.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",n.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",n.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",n.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",n.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",n.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",n.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",n.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",n.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",n.START_PROXY_SERVER="Client.startProxyServer",n.STOP_PROXY_SERVER="Client.stopProxyServer",n.SET_PROXY_SERVER="Client.setProxyServer",n.SET_TURN_SERVER="Client.setTurnServer",n.SET_CLIENT_ROLE="Client.setClientRole",n.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",n.ENABLE_DUAL_STREAM="Client.enableDualStream",n.DISABLE_DUAL_STREAM="Client.disableDualStream",n.JOIN="Client.join",n.LEAVE="Client.leave",n.PUBLISH="Client.publish",n.UNPUBLISH="Client.unpublish",n.SUBSCRIBE="Client.subscribe",n.MASS_SUBSCRIBE="Client.massSubscribe",n.MASS_UNSUBSCRIBE="Client.massUnsubscribe",n.UNSUBSCRIBE="Client.unsubscribe",n.RENEW_TOKEN="Client.renewToken",n.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",n.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",n.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",n.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",n.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",n.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",n.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",n.DATACHANNEL_FAILBACK="Client._datachannelFailback",n.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",n.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",n.START_LIVE_STREAMING="Client.startLiveStreaming",n.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",n.STOP_LIVE_STREAMING="Client.stopLiveStreaming",n.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",n.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",n.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",n.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",n.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",n.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",n.SET_CONFIG_DISTRIBUTE="_configDistribute",n.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",n.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",n.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",n.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",n.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",n.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",n.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",n.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",n.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",n.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",n.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",n.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",n.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",n.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",n.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",n.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",n.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",n.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",n.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",n.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",n.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",n.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",n.STREAM_TYPE_CHANGE="streamTypeChange",n.CONNECTION_STATE_CHANGE="connectionStateChange",n.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",n.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(Ae||(Ae={})),function(n){n.TRACER="tracer"}(ce||(ce={})),function(n){n[n.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",n[n.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",n[n.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(Jh||(Jh={})),function(n){n.LEAVE="LEAVE",n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.UID_BANNED="UID_BANNED",n.IP_BANNED="IP_BANNED",n.CHANNEL_BANNED="CHANNEL_BANNED",n.FALLBACK="FALLBACK",n.LICENSE_MISSING="LICENSE_MISSING",n.LICENSE_EXPIRED="LICENSE_EXPIRED",n.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",n.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",n.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",n.LICENSE_ILLEGAL="LICENSE_ILLEGAL",n.TOKEN_EXPIRE="TOKEN_EXPIRE"}(Ot||(Ot={})),function(n){n.CONNECTION_STATE_CHANGE="connection-state-change",n.MEDIA_RECONNECT_START="media-reconnect-start",n.MEDIA_RECONNECT_END="media-reconnect-end",n.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",n.USER_JOINED="user-joined",n.USER_LEAVED="user-left",n.USER_PUBLISHED="user-published",n.USER_UNPUBLISHED="user-unpublished",n.USER_INFO_UPDATED="user-info-updated",n.CLIENT_BANNED="client-banned",n.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",n.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",n.VOLUME_INDICATOR="volume-indicator",n.CRYPT_ERROR="crypt-error",n.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",n.NETWORK_QUALITY="network-quality",n.STREAM_TYPE_CHANGED="stream-type-changed",n.STREAM_FALLBACK="stream-fallback",n.RECEIVE_METADATA="receive-metadata",n.STREAM_MESSAGE="stream-message",n.LIVE_STREAMING_ERROR="live-streaming-error",n.LIVE_STREAMING_WARNING="live-streaming-warning",n.INJECT_STREAM_STATUS="stream-inject-status",n.EXCEPTION="exception",n.ERROR="error",n.P2P_LOST="p2p_lost",n.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",n.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",n.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",n.PUBLISHED_USER_LIST="published-user-list",n.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",n.CONTENT_INSPECT_ERROR="content-inspect-error",n.CONTENT_INSPECT_RESULT="content-inspect-result",n.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(Nt||(Nt={})),function(n){n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.MULTI_IP="MULTI_IP",n.TIMEOUT="TIMEOUT",n.OFFLINE="OFFLINE",n.LEAVE="LEAVE",n.P2P_FAILED="P2P_FAILED",n.FALLBACK="FALLBACK"}(Ge||(Ge={})),function(n){n.ONLINE="ONLINE",n.OFFLINE="OFFLINE"}(Tn||(Tn={})),function(n){n.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",n.ONLINE="ONLINE",n.OFFLINE="OFFLINE"}(yr||(yr={}));const Re=new class extends se{set networkState(n){this.emit(yr.NETWORK_STATE_CHANGE,n,this._networkState),n===Tn.ONLINE?this.emit(yr.ONLINE):n===Tn.OFFLINE&&(this.onlineWaiter=new F(t=>{this.once(yr.ONLINE,()=>{this.onlineWaiter=void 0,t(Tn.ONLINE)})}),this.emit(yr.OFFLINE)),this._networkState=n}get networkState(){return this._networkState}get isOnline(){return this._networkState===Tn.ONLINE}constructor(){super(),h(this,"_moduleName","network-indicator"),h(this,"_networkState",Tn.ONLINE),h(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Tn.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Tn.OFFLINE})}};function kS(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Gs(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?kS(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):kS(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function Pd(n,t){const e=n.indexOf(t);e!==-1&&n.splice(e,1)}function Vo(n){const t=[];return n.forEach(e=>{t.indexOf(e)===-1&&t.push(e)}),t}function Ld(n){F!==void 0?F.resolve().then(n):setTimeout(n,0)}function Zt(n){return JSON.parse(JSON.stringify(n))}function Ws(n){try{return Zt(n)}catch{return n}}const MS={};function Ja(n,t){MS[t]||(MS[t]=!0,n())}function kd(n){const t=window.atob(n),e=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)e[i]=t.charCodeAt(i);return e}function Fo(n){let t="";for(let e=0;e<n.length;e+=1)t+=String.fromCharCode(n[e]);return window.btoa(t)}function or(n){return window.TextEncoder?new TextEncoder().encode(n).length:n.length}function US(n){let t=0;return/DingTalk/i.test(navigator.userAgent)&&n.realFormData&&(n=n.realFormData),n.forEach(e=>{t+=typeof e=="string"?or(e):e.size}),t+138}function Qk(n){const t=new G(v.TIMEOUT,"timeout");return new F((e,i)=>{window.setTimeout(()=>i(t),n)})}function We(n){return new F(t=>{window.setTimeout(t,n)})}function Qt(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const e=Math.random().toString(16).substr(2,n).toLowerCase();return e.length===n?"".concat(t).concat(e):"".concat(t).concat(e)+Qt(n-e.length,"")}function zh(){return Qt(32,"").toUpperCase()}const Md=()=>{},xS=new class{constructor(){h(this,"fnMap",new Map)}throttleByKey(n,t,e,i){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(t)){const a=this.fnMap.get(t);if(a.threshold!==e){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},e);this.fnMap.set(t,{fn:n,threshold:e,timer:c,args:s,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(t,Gs(Gs({},a),{},{fn:n,args:s,skipFn:i}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(t);c&&c.fn(...c.args),this.fnMap.delete(t)},e);this.fnMap.set(t,{fn:n,threshold:e,timer:a,args:s,skipFn:i})}}},VS=xS.throttleByKey.bind(xS);function FS(n){return typeof n=="object"&&n!==null&&!(n instanceof RegExp)}function Xh(n,t){if(!FS(n)||!FS(t)||Array.isArray(n)&&!Array.isArray(t)||!Array.isArray(n)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(n)){const e=[...n];for(let i=0;i<t.length;i++)e[i]=Xh(n[i],t[i]);return e}{const e=Gs({},n);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(n,i)?e[i]=Xh(n[i],t[i]):e[i]=t[i]);return e}}let Zk=1,Ud=console;class He{static setLogger(t){Ud=t}constructor(t){h(this,"lockingPromise",F.resolve()),h(this,"locks",0),h(this,"name",""),h(this,"lockId",void 0),this.lockId=Zk++,t&&(this.name=t),Ud.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,Ud.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));const i=new F(s=>{e=()=>{this.locks-=1,Ud.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),s()}}),r=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>i),r}}function Bo(n,t){return function(e,i,r){const s=r.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[t];if(!o)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(n));const a=await o.lock("From ".concat(n,".").concat(i));try{for(var c=arguments.length,d=new Array(c),u=0;u<c;u++)d[u]=arguments[u];return await s.apply(this,d)}finally{a()}},r}}const Ce={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function xd(n,t){const e=Math.floor(t.timeout*Math.pow(t.timeoutFactor,n));return Math.min(t.maxRetryTimeout,e)}function Ki(n,t,e,i){const r=Object.assign({},Ce,i);let s=r.timeout;const o=async()=>{await function(d){return new F(u=>{window.setTimeout(u,d)})}(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new F(async(d,u)=>{t=t||(()=>!1),e=e||(()=>!0);for(let l=0;l<r.maxRetryCount;l+=1){if(a)return u(new G(v.OPERATION_ABORTED));try{const p=await n();if(!t(p,l)||l+1===r.maxRetryCount)return d(p);await o()}catch(p){if(!e(p,l)||l+1===r.maxRetryCount)return u(p);await o()}}});return c.cancel=()=>a=!0,c}var $k=wi,t1=jr,e1=Xu,n1=Ls,i1=TypeError,BS=function(n){return function(t,e,i,r){$k(e);var s=t1(t),o=e1(s),a=n1(s),c=n?a-1:0,d=n?-1:1;if(i<2)for(;;){if(c in o){r=o[c],c+=d;break}if(c+=d,n?c<0:a<=c)throw i1("Reduce of empty array with no initial value")}for(;n?c>=0:a>c;c+=d)c in o&&(r=e(r,o[c],c,s));return r}},r1={left:BS(!1),right:BS(!0)}.left;le({target:"Array",proto:!0,forced:!Va&&Ps>79&&Ps<83||!dh("reduce")},{reduce:function(n){var t=arguments.length;return r1(this,n,t,t>1?arguments[1]:void 0)}});var s1=Wr("Array").reduce,o1=wt,a1=s1,Qh=Array.prototype,Hs=b(function(n){var t=n.reduce;return n===Qh||o1(Qh,n)&&t===Qh.reduce?a1:t});let Zh=class{constructor(n){h(this,"input",[]),h(this,"size",void 0),this.size=n}add(n){this.input.push(n),this.input.length>this.size&&this.input.splice(0,1)}mean(){var n;return this.input.length===0?0:Hs(n=this.input).call(n,(t,e)=>t+e)/this.input.length}};var $h,tp={exports:{}},jS=function(n,t){return function(){for(var e=new Array(arguments.length),i=0;i<e.length;i++)e[i]=arguments[i];return n.apply(t,e)}},c1=jS,ep=Object.prototype.toString,np=($h=Object.create(null),function(n){var t=ep.call(n);return $h[t]||($h[t]=t.slice(8,-1).toLowerCase())});function Ks(n){return n=n.toLowerCase(),function(t){return np(t)===n}}function ip(n){return Array.isArray(n)}function Vd(n){return n===void 0}var GS=Ks("ArrayBuffer");function WS(n){return n!==null&&typeof n=="object"}function Fd(n){if(np(n)!=="object")return!1;var t=Object.getPrototypeOf(n);return t===null||t===Object.prototype}var d1=Ks("Date"),u1=Ks("File"),l1=Ks("Blob"),h1=Ks("FileList");function rp(n){return ep.call(n)==="[object Function]"}var p1=Ks("URLSearchParams");function sp(n,t){if(n!=null)if(typeof n!="object"&&(n=[n]),ip(n))for(var e=0,i=n.length;e<i;e++)t.call(null,n[e],e,n);else for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&t.call(null,n[r],r,n)}var op,_1=(op=typeof Uint8Array<"u"&&Object.getPrototypeOf(Uint8Array),function(n){return op&&n instanceof op}),wn={isArray:ip,isArrayBuffer:GS,isBuffer:function(n){return n!==null&&!Vd(n)&&n.constructor!==null&&!Vd(n.constructor)&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)},isFormData:function(n){var t="[object FormData]";return n&&(typeof FormData=="function"&&n instanceof FormData||ep.call(n)===t||rp(n.toString)&&n.toString()===t)},isArrayBufferView:function(n){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(n):n&&n.buffer&&GS(n.buffer)},isString:function(n){return typeof n=="string"},isNumber:function(n){return typeof n=="number"},isObject:WS,isPlainObject:Fd,isUndefined:Vd,isDate:d1,isFile:u1,isBlob:l1,isFunction:rp,isStream:function(n){return WS(n)&&rp(n.pipe)},isURLSearchParams:p1,isStandardBrowserEnv:function(){return(typeof navigator>"u"||navigator.product!=="ReactNative"&&navigator.product!=="NativeScript"&&navigator.product!=="NS")&&typeof window<"u"&&typeof document<"u"},forEach:sp,merge:function n(){var t={};function e(s,o){Fd(t[o])&&Fd(s)?t[o]=n(t[o],s):Fd(s)?t[o]=n({},s):ip(s)?t[o]=s.slice():t[o]=s}for(var i=0,r=arguments.length;i<r;i++)sp(arguments[i],e);return t},extend:function(n,t,e){return sp(t,function(i,r){n[r]=e&&typeof i=="function"?c1(i,e):i}),n},trim:function(n){return n.trim?n.trim():n.replace(/^\s+|\s+$/g,"")},stripBOM:function(n){return n.charCodeAt(0)===65279&&(n=n.slice(1)),n},inherits:function(n,t,e,i){n.prototype=Object.create(t.prototype,i),n.prototype.constructor=n,e&&Object.assign(n.prototype,e)},toFlatObject:function(n,t,e){var i,r,s,o={};t=t||{};do{for(r=(i=Object.getOwnPropertyNames(n)).length;r-- >0;)o[s=i[r]]||(t[s]=n[s],o[s]=!0);n=Object.getPrototypeOf(n)}while(n&&(!e||e(n,t))&&n!==Object.prototype);return t},kindOf:np,kindOfTest:Ks,endsWith:function(n,t,e){n=String(n),(e===void 0||e>n.length)&&(e=n.length),e-=t.length;var i=n.indexOf(t,e);return i!==-1&&i===e},toArray:function(n){if(!n)return null;var t=n.length;if(Vd(t))return null;for(var e=new Array(t);t-- >0;)e[t]=n[t];return e},isTypedArray:_1,isFileList:h1},jo=wn;function HS(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var KS=function(n,t,e){if(!t)return n;var i;if(e)i=e(t);else if(jo.isURLSearchParams(t))i=t.toString();else{var r=[];jo.forEach(t,function(o,a){o!=null&&(jo.isArray(o)?a+="[]":o=[o],jo.forEach(o,function(c){jo.isDate(c)?c=c.toISOString():jo.isObject(c)&&(c=JSON.stringify(c)),r.push(HS(a)+"="+HS(c))}))}),i=r.join("&")}if(i){var s=n.indexOf("#");s!==-1&&(n=n.slice(0,s)),n+=(n.indexOf("?")===-1?"?":"&")+i}return n},m1=wn;function Bd(){this.handlers=[]}Bd.prototype.use=function(n,t,e){return this.handlers.push({fulfilled:n,rejected:t,synchronous:!!e&&e.synchronous,runWhen:e?e.runWhen:null}),this.handlers.length-1},Bd.prototype.eject=function(n){this.handlers[n]&&(this.handlers[n]=null)},Bd.prototype.forEach=function(n){m1.forEach(this.handlers,function(t){t!==null&&n(t)})};var YS,qS,E1=Bd,f1=wn;function Go(){if(qS)return YS;qS=1;var n=wn;function t(r,s,o,a,c){Error.call(this),this.message=r,this.name="AxiosError",s&&(this.code=s),o&&(this.config=o),a&&(this.request=a),c&&(this.response=c)}n.inherits(t,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var e=t.prototype,i={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach(function(r){i[r]={value:r}}),Object.defineProperties(t,i),Object.defineProperty(e,"isAxiosError",{value:!0}),t.from=function(r,s,o,a,c,d){var u=Object.create(e);return n.toFlatObject(r,u,function(l){return l!==Error.prototype}),t.call(u,r.message,s,o,a,c),u.name=r.name,d&&Object.assign(u,d),u},YS=t}var ap,JS,zS,XS,cp,QS,ZS={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function $S(){if(JS)return ap;JS=1;var n=wn;return ap=function(t,e){e=e||new FormData;var i=[];function r(s){return s===null?"":n.isDate(s)?s.toISOString():n.isArrayBuffer(s)||n.isTypedArray(s)?typeof Blob=="function"?new Blob([s]):Buffer.from(s):s}return function s(o,a){if(n.isPlainObject(o)||n.isArray(o)){if(i.indexOf(o)!==-1)throw Error("Circular reference detected in "+a);i.push(o),n.forEach(o,function(c,d){if(!n.isUndefined(c)){var u,l=a?a+"."+d:d;if(c&&!a&&typeof c=="object"){if(n.endsWith(d,"{}"))c=JSON.stringify(c);else if(n.endsWith(d,"[]")&&(u=n.toArray(c)))return void u.forEach(function(p){!n.isUndefined(p)&&e.append(l,r(p))})}s(c,l)}}),i.pop()}else e.append(a,r(o))}(t),e},ap}function g1(){if(XS)return zS;XS=1;var n=Go();return zS=function(t,e,i){var r=i.config.validateStatus;i.status&&r&&!r(i.status)?e(new n("Request failed with status code "+i.status,[n.ERR_BAD_REQUEST,n.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)}}function T1(){if(QS)return cp;QS=1;var n=wn;return cp=n.isStandardBrowserEnv()?{write:function(t,e,i,r,s,o){var a=[];a.push(t+"="+encodeURIComponent(e)),n.isNumber(i)&&a.push("expires="+new Date(i).toGMTString()),n.isString(r)&&a.push("path="+r),n.isString(s)&&a.push("domain="+s),o===!0&&a.push("secure"),document.cookie=a.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},cp}var dp,tR,eR,nR,iR,rR,sR,oR,up,aR,cR,dR,S1=function(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)},R1=function(n,t){return t?n.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):n},uR=function(n,t){return n&&!S1(t)?R1(n,t):t};function C1(){if(tR)return dp;tR=1;var n=wn,t=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return dp=function(e){var i,r,s,o={};return e&&n.forEach(e.split(`
`),function(a){if(s=a.indexOf(":"),i=n.trim(a.substr(0,s)).toLowerCase(),r=n.trim(a.substr(s+1)),i){if(o[i]&&t.indexOf(i)>=0)return;o[i]=i==="set-cookie"?(o[i]?o[i]:[]).concat([r]):o[i]?o[i]+", "+r:r}}),o},dp}function v1(){if(nR)return eR;nR=1;var n=wn;return eR=n.isStandardBrowserEnv()?function(){var t,e=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function r(s){var o=s;return e&&(i.setAttribute("href",o),o=i.href),i.setAttribute("href",o),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:i.pathname.charAt(0)==="/"?i.pathname:"/"+i.pathname}}return t=r(window.location.href),function(s){var o=n.isString(s)?r(s):s;return o.protocol===t.protocol&&o.host===t.host}}():function(){return!0}}function jd(){if(rR)return iR;rR=1;var n=Go();function t(e){n.call(this,e??"canceled",n.ERR_CANCELED),this.name="CanceledError"}return wn.inherits(t,n,{__CANCEL__:!0}),iR=t}function y1(){return oR||(oR=1,sR=function(n){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(n);return t&&t[1]||""}),sR}function I1(){if(aR)return up;aR=1;var n=wn,t=g1(),e=T1(),i=KS,r=uR,s=C1(),o=v1(),a=ZS,c=Go(),d=jd(),u=y1();return up=function(l){return new Promise(function(p,_){var R,f=l.data,T=l.headers,A=l.responseType;function N(){l.cancelToken&&l.cancelToken.unsubscribe(R),l.signal&&l.signal.removeEventListener("abort",R)}n.isFormData(f)&&n.isStandardBrowserEnv()&&delete T["Content-Type"];var P=new XMLHttpRequest;if(l.auth){var j=l.auth.username||"",M=l.auth.password?unescape(encodeURIComponent(l.auth.password)):"";T.Authorization="Basic "+btoa(j+":"+M)}var U=r(l.baseURL,l.url);function B(){if(P){var z="getAllResponseHeaders"in P?s(P.getAllResponseHeaders()):null,mt={data:A&&A!=="text"&&A!=="json"?P.response:P.responseText,status:P.status,statusText:P.statusText,headers:z,config:l,request:P};t(function(Rt){p(Rt),N()},function(Rt){_(Rt),N()},mt),P=null}}if(P.open(l.method.toUpperCase(),i(U,l.params,l.paramsSerializer),!0),P.timeout=l.timeout,"onloadend"in P?P.onloadend=B:P.onreadystatechange=function(){P&&P.readyState===4&&(P.status!==0||P.responseURL&&P.responseURL.indexOf("file:")===0)&&setTimeout(B)},P.onabort=function(){P&&(_(new c("Request aborted",c.ECONNABORTED,l,P)),P=null)},P.onerror=function(){_(new c("Network Error",c.ERR_NETWORK,l,P,P)),P=null},P.ontimeout=function(){var z=l.timeout?"timeout of "+l.timeout+"ms exceeded":"timeout exceeded",mt=l.transitional||a;l.timeoutErrorMessage&&(z=l.timeoutErrorMessage),_(new c(z,mt.clarifyTimeoutError?c.ETIMEDOUT:c.ECONNABORTED,l,P)),P=null},n.isStandardBrowserEnv()){var V=(l.withCredentials||o(U))&&l.xsrfCookieName?e.read(l.xsrfCookieName):void 0;V&&(T[l.xsrfHeaderName]=V)}"setRequestHeader"in P&&n.forEach(T,function(z,mt){f===void 0&&mt.toLowerCase()==="content-type"?delete T[mt]:P.setRequestHeader(mt,z)}),n.isUndefined(l.withCredentials)||(P.withCredentials=!!l.withCredentials),A&&A!=="json"&&(P.responseType=l.responseType),typeof l.onDownloadProgress=="function"&&P.addEventListener("progress",l.onDownloadProgress),typeof l.onUploadProgress=="function"&&P.upload&&P.upload.addEventListener("progress",l.onUploadProgress),(l.cancelToken||l.signal)&&(R=function(z){P&&(_(!z||z&&z.type?new d:z),P.abort(),P=null)},l.cancelToken&&l.cancelToken.subscribe(R),l.signal&&(l.signal.aborted?R():l.signal.addEventListener("abort",R))),f||(f=null);var q=u(U);q&&["http","https","file"].indexOf(q)===-1?_(new c("Unsupported protocol "+q+":",c.ERR_BAD_REQUEST,l)):P.send(f)})},up}var Cn=wn,lR=function(n,t){f1.forEach(n,function(e,i){i!==t&&i.toUpperCase()===t.toUpperCase()&&(n[t]=e,delete n[i])})},hR=Go(),A1=ZS,b1=$S(),w1={"Content-Type":"application/x-www-form-urlencoded"};function pR(n,t){!Cn.isUndefined(n)&&Cn.isUndefined(n["Content-Type"])&&(n["Content-Type"]=t)}var _R,Gd={transitional:A1,adapter:((typeof XMLHttpRequest<"u"||typeof process<"u"&&Object.prototype.toString.call(process)==="[object process]")&&(_R=I1()),_R),transformRequest:[function(n,t){if(lR(t,"Accept"),lR(t,"Content-Type"),Cn.isFormData(n)||Cn.isArrayBuffer(n)||Cn.isBuffer(n)||Cn.isStream(n)||Cn.isFile(n)||Cn.isBlob(n))return n;if(Cn.isArrayBufferView(n))return n.buffer;if(Cn.isURLSearchParams(n))return pR(t,"application/x-www-form-urlencoded;charset=utf-8"),n.toString();var e,i=Cn.isObject(n),r=t&&t["Content-Type"];if((e=Cn.isFileList(n))||i&&r==="multipart/form-data"){var s=this.env&&this.env.FormData;return b1(e?{"files[]":n}:n,s&&new s)}return i||r==="application/json"?(pR(t,"application/json"),function(o,a,c){if(Cn.isString(o))try{return(a||JSON.parse)(o),Cn.trim(o)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(o)}(n)):n}],transformResponse:[function(n){var t=this.transitional||Gd.transitional,e=t&&t.silentJSONParsing,i=t&&t.forcedJSONParsing,r=!e&&this.responseType==="json";if(r||i&&Cn.isString(n)&&n.length)try{return JSON.parse(n)}catch(s){if(r)throw s.name==="SyntaxError"?hR.from(s,hR.ERR_BAD_RESPONSE,this,null,this.response):s}return n}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:dR?cR:(dR=1,cR=null)},validateStatus:function(n){return n>=200&&n<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};Cn.forEach(["delete","get","head"],function(n){Gd.headers[n]={}}),Cn.forEach(["post","put","patch"],function(n){Gd.headers[n]=Cn.merge(w1)});var mR,ER,lp=Gd,O1=wn,N1=lp;function fR(){return ER?mR:(ER=1,mR=function(n){return!(!n||!n.__CANCEL__)})}var gR=wn,hp=function(n,t,e){var i=this||N1;return O1.forEach(e,function(r){n=r.call(i,n,t)}),n},D1=fR(),P1=lp,L1=jd();function pp(n){if(n.cancelToken&&n.cancelToken.throwIfRequested(),n.signal&&n.signal.aborted)throw new L1}var TR,SR,Ei=wn,RR=function(n,t){t=t||{};var e={};function i(d,u){return Ei.isPlainObject(d)&&Ei.isPlainObject(u)?Ei.merge(d,u):Ei.isPlainObject(u)?Ei.merge({},u):Ei.isArray(u)?u.slice():u}function r(d){return Ei.isUndefined(t[d])?Ei.isUndefined(n[d])?void 0:i(void 0,n[d]):i(n[d],t[d])}function s(d){if(!Ei.isUndefined(t[d]))return i(void 0,t[d])}function o(d){return Ei.isUndefined(t[d])?Ei.isUndefined(n[d])?void 0:i(void 0,n[d]):i(void 0,t[d])}function a(d){return d in t?i(n[d],t[d]):d in n?i(void 0,n[d]):void 0}var c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a};return Ei.forEach(Object.keys(n).concat(Object.keys(t)),function(d){var u=c[d]||r,l=u(d);Ei.isUndefined(l)&&u!==a||(e[d]=l)}),e};function CR(){return SR?TR:(SR=1,TR={version:"0.27.2"})}var k1=CR().version,Xr=Go(),_p={};["object","boolean","number","function","string","symbol"].forEach(function(n,t){_p[n]=function(e){return typeof e===n||"a"+(t<1?"n ":" ")+n}});var vR={};_p.transitional=function(n,t,e){function i(r,s){return"[Axios v"+k1+"] Transitional option '"+r+"'"+s+(e?". "+e:"")}return function(r,s,o){if(n===!1)throw new Xr(i(s," has been removed"+(t?" in "+t:"")),Xr.ERR_DEPRECATED);return t&&!vR[s]&&(vR[s]=!0,console.warn(i(s," has been deprecated since v"+t+" and will be removed in the near future"))),!n||n(r,s,o)}};var yR,IR,AR,bR,wR,OR,M1={assertOptions:function(n,t,e){if(typeof n!="object")throw new Xr("options must be an object",Xr.ERR_BAD_OPTION_VALUE);for(var i=Object.keys(n),r=i.length;r-- >0;){var s=i[r],o=t[s];if(o){var a=n[s],c=a===void 0||o(a,s,n);if(c!==!0)throw new Xr("option "+s+" must be "+c,Xr.ERR_BAD_OPTION_VALUE)}else if(e!==!0)throw new Xr("Unknown option "+s,Xr.ERR_BAD_OPTION)}},validators:_p},NR=wn,U1=KS,DR=E1,PR=function(n){return pp(n),n.headers=n.headers||{},n.data=hp.call(n,n.data,n.headers,n.transformRequest),n.headers=gR.merge(n.headers.common||{},n.headers[n.method]||{},n.headers),gR.forEach(["delete","get","head","post","put","patch","common"],function(t){delete n.headers[t]}),(n.adapter||P1.adapter)(n).then(function(t){return pp(n),t.data=hp.call(n,t.data,t.headers,n.transformResponse),t},function(t){return D1(t)||(pp(n),t&&t.response&&(t.response.data=hp.call(n,t.response.data,t.response.headers,n.transformResponse))),Promise.reject(t)})},Wd=RR,x1=uR,LR=M1,Wo=LR.validators;function Ho(n){this.defaults=n,this.interceptors={request:new DR,response:new DR}}Ho.prototype.request=function(n,t){typeof n=="string"?(t=t||{}).url=n:t=n||{},(t=Wd(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var e=t.transitional;e!==void 0&&LR.assertOptions(e,{silentJSONParsing:Wo.transitional(Wo.boolean),forcedJSONParsing:Wo.transitional(Wo.boolean),clarifyTimeoutError:Wo.transitional(Wo.boolean)},!1);var i=[],r=!0;this.interceptors.request.forEach(function(l){typeof l.runWhen=="function"&&l.runWhen(t)===!1||(r=r&&l.synchronous,i.unshift(l.fulfilled,l.rejected))});var s,o=[];if(this.interceptors.response.forEach(function(l){o.push(l.fulfilled,l.rejected)}),!r){var a=[PR,void 0];for(Array.prototype.unshift.apply(a,i),a=a.concat(o),s=Promise.resolve(t);a.length;)s=s.then(a.shift(),a.shift());return s}for(var c=t;i.length;){var d=i.shift(),u=i.shift();try{c=d(c)}catch(l){u(l);break}}try{s=PR(c)}catch(l){return Promise.reject(l)}for(;o.length;)s=s.then(o.shift(),o.shift());return s},Ho.prototype.getUri=function(n){n=Wd(this.defaults,n);var t=x1(n.baseURL,n.url);return U1(t,n.params,n.paramsSerializer)},NR.forEach(["delete","get","head","options"],function(n){Ho.prototype[n]=function(t,e){return this.request(Wd(e||{},{method:n,url:t,data:(e||{}).data}))}}),NR.forEach(["post","put","patch"],function(n){function t(e){return function(i,r,s){return this.request(Wd(s||{},{method:n,headers:e?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}Ho.prototype[n]=t(),Ho.prototype[n+"Form"]=t(!0)});var kR=wn,V1=jS,Hd=Ho,F1=RR,ti=function n(t){var e=new Hd(t),i=V1(Hd.prototype.request,e);return kR.extend(i,Hd.prototype,e),kR.extend(i,e),i.create=function(r){return n(F1(t,r))},i}(lp);ti.Axios=Hd,ti.CanceledError=jd(),ti.CancelToken=function(){if(IR)return yR;IR=1;var n=jd();function t(e){if(typeof e!="function")throw new TypeError("executor must be a function.");var i;this.promise=new Promise(function(s){i=s});var r=this;this.promise.then(function(s){if(r._listeners){var o,a=r._listeners.length;for(o=0;o<a;o++)r._listeners[o](s);r._listeners=null}}),this.promise.then=function(s){var o,a=new Promise(function(c){r.subscribe(c),o=c}).then(s);return a.cancel=function(){r.unsubscribe(o)},a},e(function(s){r.reason||(r.reason=new n(s),i(r.reason))})}return t.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},t.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},t.prototype.unsubscribe=function(e){if(this._listeners){var i=this._listeners.indexOf(e);i!==-1&&this._listeners.splice(i,1)}},t.source=function(){var e;return{token:new t(function(i){e=i}),cancel:e}},yR=t}(),ti.isCancel=fR(),ti.VERSION=CR().version,ti.toFormData=$S(),ti.AxiosError=Go(),ti.Cancel=ti.CanceledError,ti.all=function(n){return Promise.all(n)},ti.spread=bR?AR:(bR=1,AR=function(n){return function(t){return n.apply(null,t)}}),ti.isAxiosError=function(){if(OR)return wR;OR=1;var n=wn;return wR=function(t){return n.isObject(t)&&t.isAxiosError===!0}}(),tp.exports=ti,tp.exports.default=ti;var Pn=b(tp.exports);function MR(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function UR(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?MR(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):MR(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}let Kd,Yd=0,mp=0;function Ep(n,t,e,i){return new F((r,s)=>{t.responseType=t.responseType||"json",t.data&&!e?(t.data=JSON.stringify(t.data),Yd+=or(t.data)):e&&(t.data.size?Yd+=t.data.size:t.data instanceof FormData?Yd+=US(t.data):Yd+=or(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=n,Pn.request(t).then(o=>{typeof o.data=="string"?mp+=or(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?mp+=o.data.byteLength:mp+=or(JSON.stringify(o.data)),i&&r({data:o.data,headers:o.headers}),r(o.data)}).catch(o=>{Pn.isCancel(o)?s(new G(v.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new G(v.NETWORK_TIMEOUT,o.message)):o.response?s(new G(v.NETWORK_RESPONSE_ERROR,o.response.status)):s(new G(v.NETWORK_ERROR,o.message))})})}async function B1(n,t){const e=new Blob([t.data],{type:"buffer"});return await Ep(n,UR(UR({},t),{},{data:e,headers:{"Content-Type":"application/octet-stream"}}),!0)}const j1=()=>(Kd||Kd||(Kd=(window.location.protocol.split(":")[0]||"").toUpperCase(),Kd))==="HTTPS",xR=()=>window.isSecureContext!==void 0,fi=function(n){if(n.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return n;const t=n.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const i=t[1],r=t[2];return"".concat(i,".").concat(r)}const e=n.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(e&&e[1]&&e[2]){const i=e[1],r=e[2];return"".concat(i,".").concat(100*(Number(r)+1))}return"4.0.0.999"}("4.20.0"),fp=function(){try{return JSON.parse("true")===!0}catch{return!0}}();var Ir;(function(n){n.Default="default",n.Auto="auto",n.Relay="relay",n.SdRtn="sd-rtn"})(Ir||(Ir={}));const gp="v4.20.0-0-g334e514b-dirty(12/8/2023, 3:48:29 PM)",vn={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function Ht(n,t,e){var i,r;nt(i=Object.keys(vn)).call(i,n)&&(!e&&nt(r=Object.keys(Qr)).call(r,n)||(vn[n]=t))}function O(n){return vn[n]}const Qr={};function VR(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function ot(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?VR(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):VR(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}var At;(function(n){n.SET_SESSION_ID="SET_SESSION_ID",n.SET_P2P_ID="SET_P2P_id",n.SET_DC_ID="SET_DC_id",n.SET_UID="SET_UID",n.SET_INT_UID="SET_INT_UID",n.SET_PUB_ID="SET_PUB_ID",n.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",n.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",n.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",n.AVOID_JOIN_START="AVOID_JOIN_START",n.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",n.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",n.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",n.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",n.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",n.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",n.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",n.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",n.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",n.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",n.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",n.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",n.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",n.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",n.RESET_KEY_METRICS="RESET_KEY_METRICS",n.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",n.SET_USE_P2P="SET_USE_P2P",n.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"})(At||(At={}));class G1{constructor(t,e,i,r){h(this,"state",void 0),this.state={codec:t,audioCodec:e,mode:i,clientId:r,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:Ir.Default}}dispatch(t){this.state=function(e,i){switch(i.type){case At.SET_SESSION_ID:return ot(ot({},e),{},{sessionId:i.sessionId});case At.SET_P2P_ID:return ot(ot({},e),{},{p2pId:i.p2pId});case At.SET_UID:return ot(ot({},e),{},{uid:i.uid});case At.SET_INT_UID:return ot(ot({},e),{},{intUid:i.intUid});case At.SET_PUB_ID:return ot(ot({},e),{},{pubId:i.pubId});case At.KEY_METRIC_CLIENT_CREATED:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{clientCreated:i.metric})});case At.KEY_METRIC_JOIN_START:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{joinStart:i.metric})});case At.AVOID_JOIN_START:return ot(ot({},e),{},{avoidJoinStart:i.avoidJoinStart});case At.KEY_METRIC_JOIN_END:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{joinEnd:i.metric})});case At.KEY_METRIC_REQUEST_AP_START:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{requestAPStart:i.metric})});case At.KEY_METRIC_REQUEST_AP_END:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{requestAPEnd:i.metric})});case At.KEY_METRIC_JOIN_GATEWAY_START:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{joinGatewayStart:i.metric})});case At.KEY_METRIC_JOIN_GATEWAY_END:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{joinGatewayEnd:i.metric})});case At.KEY_METRIC_PEER_CONNECTION_START:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{peerConnectionStart:i.metric})});case At.KEY_METRIC_PEER_CONNECTION_END:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{peerConnectionEnd:i.metric})});case At.KEY_METRIC_DESCRIPTION_START:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{descriptionStart:i.metric})});case At.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{signalChannelOpen:i.metric})});case At.KEY_METRIC_ICE_CONNECTION_END:return ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{iceConnectionEnd:i.metric})});case At.KEY_METRIC_PUBLISH:{const r=e.keyMetrics.publish,s=r.findIndex(o=>o.trackId===i.metric.trackId);return s!==-1?(r[s]=ot(ot({},r[s]),i.metric),ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{publish:[...r]})})):ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,i.metric]})})}case At.KEY_METRIC_SUBSCRIBE:{const r=e.keyMetrics.subscribe,s=r.findIndex(o=>o.userId===i.metric.userId&&o.type===i.metric.type);return s!==-1?(r[s]=ot(ot({},r[s]),i.metric),ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{subscribe:[...r]})})):ot(ot({},e),{},{keyMetrics:ot(ot({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,i.metric]})})}case At.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=i.mode,e;case At.RECORD_JOIN_CHANNEL_SERVICE:return typeof i.index!="number"?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,i.record]:(e.joinChannelServiceRecords[i.index]=ot(ot({},e.joinChannelServiceRecords[i.index]),i.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case At.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case At.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case At.SET_USE_DATACHANNEL:return ot(ot({},e),{},{useDataChannel:i.val});case At.SET_USE_P2P:return ot(ot({},e),{},{useP2P:i.val});case At.SET_TRANSPORT_TYPE:return ot(ot({},e),{},{p2pTransport:i.val});default:return e}}(this.state,t)}set sessionId(t){this.dispatch({type:At.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:At.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:At.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:At.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:At.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:At.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:At.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:At.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:At.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:At.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:At.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:At.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:At.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:At.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:At.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:At.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:At.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:At.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:At.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:At.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:At.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:At.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,e,i,r){this.dispatch({type:At.KEY_METRIC_PUBLISH,metric:ot(ot({trackId:t,type:e},i&&{publishStart:i}),r&&{publishEnd:r})})}subscribe(t,e,i,r,s,o,a){this.dispatch({type:At.KEY_METRIC_SUBSCRIBE,metric:ot(ot(ot(ot(ot({userId:t,type:e},i&&{subscribeStart:i}),r&&{subscribeEnd:r}),s&&{firstFrame:s}),o&&{streamAdded:o}),a&&{firstDecoded:a})})}massSubscribe(t,e,i,r){t.forEach(s=>{this.dispatch({type:At.KEY_METRIC_SUBSCRIBE,metric:ot(ot(ot({userId:s.userId,type:s.type},e&&{subscribeStart:e}),i&&{subscribeEnd:i}),r&&{firstFrame:r})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,e){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(i=>i.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof e!="number"?(this.dispatch({type:At.RECORD_JOIN_CHANNEL_SERVICE,record:ot(ot({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(e<0||e>=this.state.joinChannelServiceRecords.length||this.dispatch({type:At.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:e}),e)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:At.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:At.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:At.AVOID_JOIN_START,avoidJoinStart:t})}}var Zr,FR;(function(n){n.h264="h264",n.h265="h265",n.vp8="vp8",n.vp9="vp9",n.av1="av1"})(Zr||(Zr={})),function(n){n.opus="opus",n.pcma="pcma",n.pcmu="pcmu",n.g722="g722"}(FR||(FR={}));const qd=new class extends se{reportLogUploadError(n){this.emit("REPORT_LOG_UPLOAD",n)}};class W1{constructor(t){h(this,"logger",void 0),h(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function Tp(){const n=new Date;return n.toTimeString().split(" ")[0]+":"+n.getMilliseconds()}function BR(){const n=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+n.getUTCMilliseconds():n.toTimeString().split(" ")[0]+":"+n.getMilliseconds()}const gi={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Jd=Date.now(),za=n=>{for(const t in gi)if(Object.prototype.hasOwnProperty.call(gi,t)&&gi[t]===n)return t;return"DEFAULT"},m=new class{constructor(){h(this,"proxyServerURL",void 0),h(this,"logLevel",gi.DEBUG),h(this,"uploadState","collecting"),h(this,"uploadLogWaitingList",[]),h(this,"uploadLogUploadingList",[]),h(this,"uploadErrorCount",0),h(this,"currentLogID",0),h(this,"url",void 0),h(this,"extLog",(n,t)=>{this.appendLogToWaitingList(n,...t)})}debug(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const i=[gi.DEBUG].concat(t);this.log.apply(this,i)}info(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const i=[gi.INFO].concat(t);this.log.apply(this,i)}warning(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const i=[gi.WARNING].concat(t);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const i=[gi.ERROR].concat(t);this.log.apply(this,i)}upload(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];const i=[gi.DEBUG].concat(t);this.uploadLog.apply(this,i)}setLogLevel(n){n=Math.min(Math.max(0,n),4),this.logLevel=n}enableLogUpload(){Ht("UPLOAD_LOG",!0)}disableLogUpload(){Ht("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(n){this.proxyServerURL=n}prefix(n){return new W1(this).prefix(n)}log(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];if(Date.now()-Jd<100)return void setTimeout(()=>{this.log(...t)},Date.now()-Jd);const i=Math.max(0,Math.min(4,t[0]));if(t[0]=Tp()+" Agora-SDK [".concat(za(i),"]:"),this.appendLogToWaitingList(i,...t),i<this.logLevel)return;const r=Tp()+" %cAgora-SDK [".concat(za(i),"]:");let s=[];if(!O("USE_NEW_LOG"))switch(i){case gi.DEBUG:s=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,s);break;case gi.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,s);break;case gi.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,s);break;case gi.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];if(Date.now()-Jd<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-Jd);const i=Math.max(0,Math.min(4,t[0]));t[0]=Tp()+" Agora-SDK [".concat(za(i),"]:"),this.appendLogToWaitingList(i,...t)}appendLogToWaitingList(n){if(!O("UPLOAD_LOG"))return;for(var t=arguments.length,e=new Array(t>1?t-1:0),i=1;i<t;i++)e[i-1]=arguments[i];Array.isArray(e[0])?e[0][0]=BR()+" Agora-SDK [".concat(za(n),"]:"):e[0]=BR()+" Agora-SDK [".concat(za(n),"]:");let r="";e.forEach(s=>{typeof s=="object"&&(s=JSON.stringify(s)),r+="".concat(s," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:n,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const n=this.uploadLogUploadingList,t={sdk_version:fi,process_id:O("PROCESS_ID"),payload:JSON.stringify(n)};return Ki(async()=>{const e=await Pn.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(O("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(O("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(e.data!=="OK"){const i=new Error("unexpected upload log response");throw i.response=e,i}},()=>(this.uploadLogUploadingList=[],!1),e=>(e.response?qd.reportLogUploadError({status:e.response.status,data:e.response.data,headers:e.response.headers,message:e.message}):e.request?qd.reportLogUploadError({status:e.request.status,message:e.message}):qd.reportLogUploadError({status:-1,message:e.message}),!0),{timeout:O("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:O("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,O("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),O("UPLOAD_LOG_INTERVAL"))}).catch(n=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),O("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),O("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var jR,GR;function H1(n){return en(n.reportId,"params.reportId",0,100,!1),en(n.category,"params.category",0,100,!1),en(n.event,"params.event",0,100,!1),en(n.label,"params.label",0,100,!1),Wt(n.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(n){n.FREE="free",n.UPLOADING="uploading"})(jR||(jR={})),function(n){n[n.MISC=0]="MISC",n[n.INTERNAL_EVENT=1]="INTERNAL_EVENT",n[n.PUBLIC_EVENT=2]="PUBLIC_EVENT",n[n.WEB_EVENT=3]="WEB_EVENT",n[n.INTERNAL_API=4]="INTERNAL_API",n[n.WEB_API=5]="WEB_API",n[n.PUBLIC_API=6]="PUBLIC_API"}(GR||(GR={}));const K1={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var Pe,ne,WR,HR;function KR(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Tt(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?KR(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):KR(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}(function(n){n.PUBLISH="publish",n.SUBSCRIBE="subscribe",n.WS_COMPRESSOR_INIT="ws_compressor_init",n.SESSION_INIT="session_init",n.JOIN_CHOOSE_SERVER="join_choose_server",n.REQ_USER_ACCOUNT="req_user_account",n.JOIN_GATEWAY="join_gateway",n.REJOIN_GATEWAY="rejoin_gateway",n.STREAM_SWITCH="stream_switch",n.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",n.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",n.FIRST_VIDEO_RECEIVED="first_video_received",n.FIRST_AUDIO_RECEIVED="first_audio_received",n.FIRST_VIDEO_DECODE="first_video_decode",n.FIRST_AUDIO_DECODE="first_audio_decode",n.ON_ADD_AUDIO_STREAM="on_add_audio_stream",n.ON_ADD_VIDEO_STREAM="on_add_video_stream",n.ON_UPDATE_STREAM="on_update_stream",n.ON_REMOVE_STREAM="on_remove_stream",n.USER_ANALYTICS="req_user_analytics",n.PC_STATS="pc_stats",n.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"})(Pe||(Pe={})),function(n){n.SESSION="io.agora.pb.Wrtc.Session",n.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",n.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",n.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",n.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",n.PUBLISH="io.agora.pb.Wrtc.Publish",n.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",n.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",n.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",n.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",n.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",n.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",n.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",n.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",n.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",n.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",n.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",n.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",n.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",n.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",n.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",n.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",n.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",n.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",n.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",n.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",n.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",n.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",n.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",n.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",n.PC_STATS="io.agora.pb.Wrtc.PCStats",n.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(ne||(ne={})),function(n){n[n.WORKER_EVENT=156]="WORKER_EVENT",n[n.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(WR||(WR={})),function(n){n[n.SESSION=26]="SESSION",n[n.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",n[n.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",n[n.JOIN_GATEWAY=28]="JOIN_GATEWAY",n[n.PUBLISH=30]="PUBLISH",n[n.SUBSCRIBE=29]="SUBSCRIBE",n[n.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",n[n.STREAM_SWITCH=32]="STREAM_SWITCH",n[n.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",n[n.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",n[n.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",n[n.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",n[n.API_INVOKE=41]="API_INVOKE",n[n.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",n[n.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",n[n.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",n[n.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",n[n.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",n[n.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",n[n.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",n[n.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",n[n.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",n[n.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",n[n.WORKER_EVENT=156]="WORKER_EVENT",n[n.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",n[n.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",n[n.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",n[n.USER_ANALYTICS=1e4]="USER_ANALYTICS",n[n.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(HR||(HR={}));class Xa{constructor(){h(this,"baseInfoMap",new Map),h(this,"proxyServer",void 0),h(this,"eventUploadTimer",void 0),h(this,"setSessionIdTimer",void 0),h(this,"url",void 0),h(this,"backupUrl",void 0),h(this,"_appId",void 0),h(this,"keyEventUploadPendingItems",[]),h(this,"normalEventUploadPendingItems",[]),h(this,"apiInvokeUploadPendingItems",[]),h(this,"apiInvokeCount",0),h(this,"ltsList",[]),h(this,"lastSendNormalEventTime",Date.now()),h(this,"customReportCounterTimer",void 0),h(this,"customReportCount",0),h(this,"extApiInvoke",async t=>{for(const e of t){const i=Tt(Tt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:ce.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),O("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),O("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void m.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),i=Date.now(),r=e.startTime;e.startTime=i,m.debug("rewrite session ".concat(t," startTime: ").concat(i," , ").concat(i-r,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const r=Date.now();this.apiInvokeCount+=1;const s=this.apiInvokeCount,o=()=>({tag:e.tag,invokeId:s,sid:t,name:e.name,apiInvokeTime:r,options:e.options,states:e.states||null}),a=!!O("SHOW_REPORT_INVOKER_LOG");a&&m.info("".concat(e.name," start"),e.options);let c=!1;We(e.timeout).then(()=>{c||(this.sendApiInvoke(Tt(Tt({},o()),{},{error:v.API_INVOKE_TIMEOUT,success:!1})),m.debug("".concat(e.name," timeout")))});const d=new G(v.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:u=>{const l=()=>{if(c)throw d;return c=!0,this.sendApiInvoke(Tt(Tt({},o()),{},{success:!0},e.reportResult&&{result:u})),a&&m.info("".concat(e.name," onSuccess")),u};return i?VS(l,e.name+"Success",i,()=>c=!0):l()},onError:u=>{const l=()=>{if(c)throw u;c=!0,this.sendApiInvoke(Tt(Tt({},o()),{},{success:!1,error:u})),a&&m.info("".concat(e.name," onFailure"),u.toString())};return i?VS(l,e.name+"Error",i,()=>c=!0):l()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const i=Date.now(),r=this.createBaseInfo(t,i);r.cname=e.cname;const s=Object.assign({},{willUploadConsoleLog:O("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:fp?"global":"oversea",areas:O("AREAS")&&O("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:u,clientRole:l}=e,p=Date.now(),_=Tt(Tt({},r),{},{eventType:Pe.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,build:gp,lts:p,elapse:p-i,extend:JSON.stringify(s),mode:e.mode,process:O("PROCESS_ID"),appType:O("APP_TYPE"),success:!0,version:fi,stringUid:o,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:u,clientType:20,clientRole:l,serviceId:O("PROCESS_ID"),extensionID:O("PLUGIN_INFO").join(",")||""});this.send({type:ne.SESSION,data:_},!0)}joinChooseServer(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.JOIN_CHOOSE_SERVER,lts:s,eventElapse:s-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:s-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:ne.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.REQ_USER_ACCOUNT,lts:s,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:s-i.startTime,eventElapse:s-e.lts,extend:JSON.stringify(e.extend)});this.send({type:ne.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info;e.vid&&(r.vid=e.vid),r.uid=e.uid,r.cid=e.cid;const s=Date.now(),{firstSuccess:o,avoidJoinStartTime:a,isProxy:c,addr:d}=e,u=s-(o&&a?a:i.startTime),l=Tt(Tt({},r),{},{eventType:Pe.JOIN_GATEWAY,lts:s,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:u,eventElapse:s-e.lts,firstSuccess:o,signalChannel:e.signalChannel}),p=l.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=s),o)this.send({type:ne.JOIN_GATEWAY,data:l},!0);else{let _;if(d)if(c){const f=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),T=d.match(/p=[0-9]{1,6}/g);_={isSuccess:p,gatewayIp:f&&f.length?f[0].split("=")[1].replace(/-/g,"."):"",port:T&&T.length?T[0].split("=")[1]:"",isProxy:c?1:0}}else{const f=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),T=d.match(/(:|p=)[0-9]{1,6}/g);_={isSuccess:p,gatewayIp:f&&f.length?f[0].split("//")[1].replace(/-/g,"."):"",port:T&&T.length?T[0].split(/:|p=/g)[1]:"",isProxy:c?1:0}}else _={isSuccess:p,gatewayIp:"",port:"",isProxy:c?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const R=Object.assign({},l,_,{eventType:Pe.REJOIN_GATEWAY});this.send({type:ne.RE_JOIN_GATEWAY,data:R},!0)}}joinChannelTimeout(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=Date.now(),s=Tt(Tt({},i.info),{},{lts:r,timeout:e,elapse:r-i.startTime});this.send({type:ne.JOIN_CHANNEL_TIMEOUT,data:s},!0)}publish(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.PUBLISH,lts:s,eventElapse:e.eventElapse,elapse:s-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:ne.PUBLISH,data:o},!0)}subscribe(t,e,i){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=Tt(Tt({},s),{},{eventType:Pe.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?a.peerSuid=e.peerid:a.peer=e.peerid,this.send({type:ne.SUBSCRIBE,data:a},!0)}wsCompressorInit(t){var e;const i=[...$n(e=this.baseInfoMap).call(e)],r=i.length?i[0]:"UnableToGetSid",s=this.baseInfoMap.get(r);if(!s)return;const o=s.info,a=Date.now(),c=Tt(Tt({},o),{},{eventType:Pe.WS_COMPRESSOR_INIT,lts:a,eventElapse:t.eventElapse,elapse:a-s.startTime,status:t.status?1:2});this.send({type:ne.WS_COMPRESSOR_INIT,data:c},!0)}firstRemoteVideoDecode(t,e,i,r){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,a=Date.now(),c=Tt(Tt(Tt({},o),r),{},{elapse:a-s.startTime,eventType:e,lts:a,firstDecodeFrame:Math.max(a-s.startTime,0),apEnd:Math.max(r.apEnd-s.startTime,0),apStart:Math.max(r.apStart-s.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-s.startTime,0),joinGwStart:Math.max(r.joinGwStart-s.startTime,0),pcEnd:Math.max(r.pcEnd-s.startTime,0),pcStart:Math.max(r.pcStart-s.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-s.startTime,0),subscriberStart:Math.max(r.subscriberStart-s.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-s.startTime,0)});this.send({type:i,data:c},!0)}firstRemoteFrame(t,e,i,r){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,a=Date.now(),c=Tt(Tt(Tt({},o),r),{},{elapse:a-s.startTime,eventType:e,lts:a});this.send({type:i,data:c},!0)}pcStats(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt(Tt({},r),e),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:s-i.startTime,eventType:Pe.PC_STATS,lts:s});this.send({type:ne.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt(Tt({},r),e),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:Pe.UPDATE_REMOTE_RTPCAPABILITIES,lts:s});this.send({type:ne.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,i,r){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,a=Date.now(),c=Tt(Tt(Tt({},o),r),{},{eventType:e,lts:a});this.send({type:i,data:c},!0)}streamSwitch(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.STREAM_SWITCH,lts:s,isDual:e.isdual,elapse:s-i.startTime,success:e.succ});this.send({type:ne.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.REQUEST_PROXY_APPCENTER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:ne.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{eventType:Pe.REQUEST_PROXY_WORKER_MANAGER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:ne.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?m.debug("reportProxyServerurl: ".concat(t)):m.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt({},r),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:s,elapse:s-i.startTime,joinChannelSuccessElapse:s-(i.lastJoinSuccessTime||s),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:ne.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now();(function(a,c,d){const u=a[c];if(!u||typeof u!="string")return[a];a[c]="";const l=or(JSON.stringify(a));let p=0;const _=[];let R=0;for(let f=0;f<u.length;f++)R+=u.charCodeAt(f)<=127?1:3,R<=d-l||(_[_.length]=Gs(Gs({},a),{},{[c]:u.substring(p,f)}),p=f,R=u.charCodeAt(f)<=127?1:3);return p!==u.length-1&&(_[_.length]=Gs(Gs({},a),{},{[c]:u.substring(p)})),_})(Tt(Tt(Tt({},r),e),{},{elapse:s-i.startTime,lts:s,productType:"WebRTC"}),"payload",1300).forEach(a=>this.send({type:ne.WORKER_EVENT,data:a},!0))}apworkerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt(Tt({},r),e),{},{elapse:s-i.startTime,lts:s});this.send({type:ne.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt(Tt({},r),e),{},{elapse:s-i.startTime,lts:s,extend:e.extend||void 0});this.send({type:ne.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Tt(Tt(Tt({},r),e),{},{elapse:s-i.startTime,lts:s});this.send({type:ne.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>O("CUSTOM_REPORT_LIMIT"))throw new G(v.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),r=e.map(s=>({type:ne.USER_ANALYTICS,data:Tt(Tt({sid:t},s),{},{lts:i})}));try{O("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(s){throw m.error("send custom report message failed",s.toString()),new G(v.CUSTOM_REPORT_SEND_FAILED,s.message)}}sendApiInvoke(t){const e=O("NOT_REPORT_EVENT");if(t.tag&&nt(e)&&nt(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:r,uid:s,cid:o}=i.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof G){const{code:d,message:u}=t.error;a=d||u||t.error.toString()}else a=t.error.toString();const c={invokeId:t.invokeId,sid:t.sid,cname:r,cid:o,uid:s,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:ne.API_INVOKE,data:c},!1),!0}appendSessionId(){Xa.__CLIENT_LIST__.forEach(t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let i=0;i<e;i++){const r=this.apiInvokeUploadPendingItems.shift();r&&(r.sid=t._sessionId,this.sendApiInvoke(Object.assign({},r)))}}})}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>O("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const i=[],r=[];for(;t.length;){const o=t.shift();i.length<20?i.push(o):r.push(o)}t.push(...r);for(const o of[...i]){var s;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Ma(s=this.ltsList).call(s,(a,c)=>a-c))}return e||(this.lastSendNormalEventTime=Date.now()),O("ENABLE_EVENT_REPORT")&&i.length&&(O("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((o=>a=>{O("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>O("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-O("NORMAL_EVENT_QUEUE_CAPACITY")),m.warning("report: drop normal events"))))})(i)),t}async postDataToStatsCollector2(t){Re.networkState===Tn.OFFLINE&&await F.race([Re.onlineWaiter,We(2*Ce.maxRetryTimeout)]);const e=s=>{let o=new Uint8Array;return s.forEach(a=>{const c=Yh(JSON.stringify(a.data)),d=new ArrayBuffer(5),u=(p=>{let _=0;return Object.entries(ne).forEach(R=>{let[f,T]=R;T===p.type&&(_=EventNameToID[f])}),_})(a),l=new DataView(d);l.setUint16(0,c.byteLength,!0),l.setUint8(2,255&u),l.setUint8(3,u>>>8&255),l.setUint8(4,u>>>16&255),o=OS(o,new Uint8Array(d)),o=OS(o,c)}),o},i="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(O("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(O("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let s=0;s<2;s+=1){s===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(O("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(O("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await Ep(r,{timeout:1e4,data:e(t),headers:Tt(Tt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(s===1)throw o;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(o=>JSON.stringify(o)),vid:(o=>{const a=o&&o.data.sid&&this.baseInfoMap.get(o.data.sid);return a&&a.info.vid&&+a.info.vid||0})(t[0])};Re.networkState===Tn.OFFLINE&&await F.race([Re.onlineWaiter,We(2*Ce.maxRetryTimeout)]);const r=e?"/events/proto-raws":"/events/messages";let s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(O("EVENT_REPORT_DOMAIN"),"&p=").concat(O("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(O("EVENT_REPORT_DOMAIN"),":").concat(O("STATS_COLLECTOR_PORT")).concat(r));for(let o=0;o<2;o+=1){o===1&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(O("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(O("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(O("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(O("STATS_COLLECTOR_PORT")).concat(r)));try{e?await B1(s,{timeout:1e4,data:i}):await Ep(s,{timeout:1e4,data:i})}catch(a){if(o===1)throw a;continue}return}}createBaseInfo(t,e){const i=Object.assign({},K1);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){const i=performance.getEntriesByName(t),r=i[i.length-1];r&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:r,tag:ce.TRACER}).onSuccess()}}function dt(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,e,i){const r=i.value;if(typeof r=="function"){const s=n.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);i.value=function(){for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];let d=a;if(n.argsMap)try{d=n.argsMap(this,...a)}catch(l){m.warning(l),d=[]}try{JSON.stringify(d)}catch{m.warning("arguments for method ".concat(s,".").concat(String(e)," not serializable for apiInvoke.")),d=[]}const u=(n.report||st).reportApiInvoke(this._sessionId||null,{name:"".concat(s,".").concat(String(e)),options:d,tag:ce.TRACER,reportResult:n.reportResult},n.throttleTime);try{const l=r.apply(this,a);return l instanceof F?l.then(p=>(u.onSuccess(n.reportResult&&p),p)).catch(p=>{throw u.onError(p),p}):(u.onSuccess(n.reportResult&&l),l)}catch(l){throw u.onError(l),l}}}return i}}h(Xa,"__CLIENT_LIST__",[]);const st=new Xa;qd.on("REPORT_LOG_UPLOAD",n=>{n.networkState=Re.networkState,st.reportApiInvoke(null,{name:"logUploadError",options:n,tag:ce.TRACER})});const Y1=["CHINA","GLOBAL"],yn=function(){const n="us".concat("erna","me"),t="pa".concat("sswo","rd"),e=["t","s","t"];e.splice(1,0,"e");const i=e.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[n]=i,o[t]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=yn,fp||(vn.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],vn.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],vn.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],vn.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],vn.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],vn.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],vn.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",vn.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",vn.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",vn.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",vn.AREAS=["NORTH_AMERICA","OVERSEA"]);const YR=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],$r=[];function Ys(n,t){return!!t&&$r.some(e=>e.uid===n&&e.channelName===t)}Xa.__CLIENT_LIST__=$r;var Sp,Ln,Ko,Qa,ei,un,ct,yt,$,at,Ar,Et,qR,ln,pt,Le,ts,q1=Wr("Array").values,J1=ks,z1=Dn,X1=wt,Q1=q1,Rp=Array.prototype,Z1={DOMTokenList:!0,NodeList:!0},Yi=b(function(n){var t=n.values;return n===Rp||X1(Rp,n)&&t===Rp.values||z1(Z1,J1(n))?Q1:t});function W(n,t,e,i){var r,s=arguments.length,o=s<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(n,t,e,i);else for(var a=n.length-1;a>=0;a--)(r=n[a])&&(o=(s<3?r(o):s>3?r(t,e,o):r(t,e))||o);return s>3&&o&&Object.defineProperty(t,e,o),o}function S(n,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(n,t)}(function(n){n.L1T1="L1T1",n.L1T2="L1T2",n.L1T3="L1T3",n.L2T1_KEY="L2T1_KEY",n.L2T2_KEY="L2T2_KEY",n.L2T3_KEY="L2T3_KEY",n.L3T1_KEY="L3T1_KEY",n.L3T2_KEY="L3T2_KEY",n.L3T3_KEY="L3T3_KEY"})(Sp||(Sp={})),function(n){n.CERTIFICATE="certificate",n.CODEC="codec",n.CANDIDATE_PAIR="candidate-pair",n.LOCAL_CANDIDATE="local-candidate",n.REMOTE_CANDIDATE="remote-candidate",n.INBOUND="inbound-rtp",n.TRACK="track",n.OUTBOUND="outbound-rtp",n.PC="peer-connection",n.REMOTE_INBOUND="remote-inbound-rtp",n.REMOTE_OUTBOUND="remote-outbound-rtp",n.TRANSPORT="transport",n.CSRC="csrc",n.DATA_CHANNEL="data-channel",n.STREAM="stream",n.SENDER="sender",n.RECEIVER="receiver"}(Ln||(Ln={})),function(n){n[n.ACCESS_POINT=101]="ACCESS_POINT",n[n.UNILBS=201]="UNILBS",n[n.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(Ko||(Ko={})),function(n){n[n.IIIEGAL_APPID=1]="IIIEGAL_APPID",n[n.IIIEGAL_UID=2]="IIIEGAL_UID",n[n.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(Qa||(Qa={})),function(n){n[n.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",n[n.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",n[n.INTERNAL_ERROR=8]="INTERNAL_ERROR",n[n.NO_AUTHORIZED=9]="NO_AUTHORIZED",n[n.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",n[n.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",n[n.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",n[n.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",n[n.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",n[n.USER_OVERLOAD=16]="USER_OVERLOAD",n[n.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",n[n.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(ei||(ei={})),function(n){n[n.NO_FLAG_SET=100]="NO_FLAG_SET",n[n.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",n[n.INVALID_FALG_SET=102]="INVALID_FALG_SET",n[n.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",n[n.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",n[n.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",n[n.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",n[n.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",n[n.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",n[n.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",n[n.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",n[n.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",n[n.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",n[n.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",n[n.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",n[n.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",n[n.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",n[n.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",n[n.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(un||(un={})),function(n){n[n.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",n[n.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",n[n.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",n[n.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",n[n.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",n[n.K_TICKET_INVALID=7]="K_TICKET_INVALID",n[n.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",n[n.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",n[n.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",n[n.K_UID_BANNED=14]="K_UID_BANNED",n[n.K_IP_BANNED=15]="K_IP_BANNED",n[n.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",n[n.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",n[n.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",n[n.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",n[n.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",n[n.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",n[n.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",n[n.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",n[n.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",n[n.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",n[n.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",n[n.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",n[n.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",n[n.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",n[n.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",n[n.ERR_INVALID_UID=117]="ERR_INVALID_UID",n[n.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",n[n.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",n[n.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",n[n.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",n[n.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",n[n.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",n[n.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",n[n.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",n[n.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",n[n.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",n[n.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",n[n.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",n[n.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",n[n.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",n[n.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",n[n.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",n[n.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",n[n.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",n[n.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",n[n.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",n[n.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",n[n.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",n[n.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",n[n.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",n[n.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",n[n.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",n[n.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",n[n.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",n[n.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",n[n.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",n[n.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",n[n.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",n[n.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",n[n.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",n[n.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",n[n.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",n[n.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(ct||(ct={})),function(n){n.CONNECTING="connecting",n.CONNECTED="connected",n.RECONNECTING="reconnecting",n.CLOSED="closed"}(yt||(yt={})),function(n){n.WS_CONNECTED="ws_connected",n.WS_RECONNECTING="ws_reconnecting",n.WS_CLOSED="ws_closed",n.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",n.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",n.ON_BINARY_DATA="on_binary_data",n.REQUEST_RECOVER="request_recover",n.REQUEST_JOIN_INFO="request_join_info",n.REQUEST_REJOIN_INFO="req_rejoin_info",n.IS_P2P_DISCONNECTED="is_p2p_dis",n.DISCONNECT_P2P="dis_p2p",n.ABORT_P2P_EXECUTION="abort_p2p_execution",n.NEED_RENEW_SESSION="need-sid",n.REPORT_JOIN_GATEWAY="report_join_gateway",n.REQUEST_TIMEOUT="request_timeout",n.REQUEST_SUCCESS="request_success",n.JOIN_RESPONSE="join_response",n.DATACHANNEL_PRECONNECT="datachannel_preconnect",n.DATACHANNEL_CONNECTING="datachannel_connecting",n.DATACHANNEL_FAILBACK="datachannel_failback",n.P2P_CONNECTION="p2p_connection",n.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",n.P2P_SUBSCRIBE="p2p_subscribe",n.P2P_UNSUBSCRIBE="p2p_unsubscribe",n.P2P_EXCHANGE_SDP="p2p_exchange_sdp",n.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",n.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}($||($={})),function(n){n.PING="ping",n.PING_BACK="ping_back",n.JOIN="join_v3",n.REJOIN="rejoin_v3",n.LEAVE="leave",n.SET_CLIENT_ROLE="set_client_role",n.PUBLISH="publish",n.PUBLISH_DATASTREAM="publish_datastream",n.UNPUBLISH="unpublish",n.UNPUBLISH_DATASTREAM="unpublish_datastream",n.SUBSCRIBE="subscribe",n.PRE_SUBSCRIBE="pre_subscribe",n.SUBSCRIBE_DATASTREAM="subscribe_datastream",n.SUBSCRIBE_STREAMS="subscribe_streams",n.UNSUBSCRIBE="unsubscribe",n.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",n.UNSUBSCRIBE_STREAMS="unsubscribe_streams",n.SUBSCRIBE_CHANGE="subscribe_change",n.TRAFFIC_STATS="traffic_stats",n.RENEW_TOKEN="renew_token",n.SWITCH_VIDEO_STREAM="switch_video_stream",n.DEFAULT_VIDEO_STREAM="default_video_stream",n.SET_FALLBACK_OPTION="set_fallback_option",n.GATEWAY_INFO="gateway_info",n.CONTROL="control",n.SEND_METADATA="send_metadata",n.DATA_STREAM="data_stream",n.PICK_SVC_LAYER="pick_svc_layer",n.RESTART_ICE="restart_ice",n.CONNECT_PC="connect_pc",n.SET_VIDEO_PROFILE="set_video_profile",n.SET_PARAMETER="set_parameter",n.SET_RTM2_FLAG="set_rtm2_flag"}(at||(at={})),function(n){n.WRTC_STATS="wrtc_stats",n.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",n.DENOISER_STATS="denoiser_stats",n.EXTENSION_USAGE_STATS="extension_usage_stats"}(Ar||(Ar={})),function(n){n.ON_USER_ONLINE="on_user_online",n.ON_USER_OFFLINE="on_user_offline",n.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",n.ON_PUBLISH_STREAM="on_publish_stream",n.ON_UPLINK_STATS="on_uplink_stats",n.ON_P2P_LOST="on_p2p_lost",n.ON_REMOVE_STREAM="on_remove_stream",n.ON_ADD_AUDIO_STREAM="on_add_audio_stream",n.ON_ADD_VIDEO_STREAM="on_add_video_stream",n.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",n.ON_USER_BANNED="on_user_banned",n.ON_USER_LICENSE_BANNED="on_user_license_banned",n.ON_NOTIFICATION="on_notification",n.ON_CRYPT_ERROR="on_crypt_error",n.MUTE_AUDIO="mute_audio",n.MUTE_VIDEO="mute_video",n.UNMUTE_AUDIO="unmute_audio",n.UNMUTE_VIDEO="unmute_video",n.ON_P2P_OK="on_p2p_ok",n.RECEIVE_METADATA="receive_metadata",n.ON_DATA_STREAM="on_data_stream",n.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",n.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",n.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",n.ENABLE_LOCAL_VIDEO="enable_local_video",n.DISABLE_LOCAL_VIDEO="disable_local_video",n.ENABLE_LOCAL_AUDIO="enable_local_audio",n.DISABLE_LOCAL_AUDIO="disable_local_audio",n.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Et||(Et={})),function(n){n.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",n.NEED_ANSWER="NEED_ANSWER",n.NEED_RENEGOTIATE="NEED_RENEGOTIATE",n.P2P_LOST="P2P_LOST",n.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",n.NEED_UNPUB="NEED_UNPUB",n.NEED_UNSUB="NEED_UNSUB",n.NEED_UPLOAD="NEED_UPLOAD",n.NEED_CONTROL="NEED_CONTROL",n.START_RECONNECT="START_RECONNECT",n.END_RECONNECT="END_RECONNECT",n.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(qR||(qR={})),function(n){n.SEND_ONLY="SEND_ONLY",n.RECEIVE_ONLY="RECEIVE_ONLY"}(ln||(ln={})),function(n){n.CONNECTED="websocket:connected",n.RECONNECTING="websocket:reconnecting",n.WILL_RECONNECT="websocket:will_reconnect",n.CLOSED="websocket:closed",n.FAILED="websocket:failed",n.ON_MESSAGE="websocket:on_message",n.REQUEST_NEW_URLS="websocket:request_new_urls",n.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",n.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(pt||(pt={}));class k extends G{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),h(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,m)}throw(){super.throw(m)}}function Cp(n){if(typeof n!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(n))throw m.error("Invalid Channel Name ".concat(n)),new k(v.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function vp(n){if(t=n,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||IS(n,1,255)))throw new k(v.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof n=="string"&&m.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(n){n.TRANSCODE="mix_streaming",n.RAW="raw_streaming",n.INJECT="inject_streaming"})(Le||(Le={})),function(n){n[n.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",n[n.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",n[n.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",n[n.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",n[n.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",n[n.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",n[n.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",n[n.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",n[n.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",n[n.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",n[n.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(ts||(ts={}));const $1={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},yp={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Ip(n,t){en(n.url,"".concat(t,".url"),1,1e3,!1),ae(n.x)||Wt(n.x,"".concat(t,".x"),0,1e4),ae(n.y)||Wt(n.y,"".concat(t,".y"),0,1e4),ae(n.width)||Wt(n.width,"".concat(t,".width"),0,1e4),ae(n.height)||Wt(n.height,"".concat(t,".height"),0,1e4),ae(n.zOrder)||Wt(n.zOrder,"".concat(t,".zOrder"),0,255),ae(n.alpha)||Wt(n.alpha,"".concat(t,".alpha"),0,1,!1)}const tM={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},eM={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var Ni,Yo,ge,JR,hn,qi,In,es,Ut,de,qs,be,zd,Pt;function zR(n){if(!n.channelName)throw new k(v.INVALID_PARAMS,"invalid channelName in info");if(typeof n.uid!="number")throw new k(v.INVALID_PARAMS,"invalid uid in info, uid must be a number");return n.token&&en(n.token,"info.token",1,2047),vp(n.uid),Cp(n.channelName),!0}(function(n){n.WARNING="@live_uap-warning",n.ERROR="@line_uap-error",n.PUBLISH_STREAM_STATUS="@live_uap-publish-status",n.INJECT_STREAM_STATUS="@live_uap-inject-status",n.WORKER_STATUS="@live_uap-worker-status",n.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(Ni||(Ni={})),function(n){n.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(Yo||(Yo={})),function(n){n[n.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",n[n.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",n[n.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",n[n.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",n[n.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",n[n.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",n[n.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",n[n.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",n[n.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",n[n.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",n[n.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",n[n.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",n[n.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",n[n.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",n[n.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",n[n.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",n[n.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",n[n.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",n[n.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(ge||(ge={})),function(n){n.CONNECT_FAILED="connect failed",n.CONNECT_TIMEOUT="connect timeout",n.WS_DISCONNECTED="websocket disconnected",n.REQUEST_TIMEOUT="request timeout",n.REQUEST_FAILED="request failed",n.WAIT_STATUS_TIMEOUT="wait status timeout",n.WAIT_STATUS_ERROR="wait status error",n.BAD_STATE="bad state",n.WS_ABORT="ws abort",n.AP_REQUEST_TIMEOUT="AP request timeout",n.AP_JSON_PARSE_ERROR="AP json parse error",n.AP_REQUEST_ERROR="AP request error",n.AP_REQUEST_ABORT="AP request abort"}(JR||(JR={})),function(n){n[n.SetSdkProfile=0]="SetSdkProfile",n[n.SetSourceChannel=1]="SetSourceChannel",n[n.SetSourceUserId=2]="SetSourceUserId",n[n.SetDestChannel=3]="SetDestChannel",n[n.StartPacketTransfer=4]="StartPacketTransfer",n[n.StopPacketTransfer=5]="StopPacketTransfer",n[n.UpdateDestChannel=6]="UpdateDestChannel",n[n.Reconnect=7]="Reconnect",n[n.SetVideoProfile=8]="SetVideoProfile"}(hn||(hn={})),function(n){n.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",n.NETWORK_CONNECTED="NETWORK_CONNECTED",n.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",n.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",n.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",n.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",n.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",n.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",n.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",n.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(qi||(qi={})),function(n){n.RELAY_STATE_IDLE="RELAY_STATE_IDLE",n.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",n.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",n.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(In||(In={})),function(n){n.RELAY_OK="RELAY_OK",n.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",n.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",n.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(es||(es={})),function(n){n.High="high",n.Low="low",n.Audio="audio",n.Screen="screen",n.ScreenLow="screen_low"}(Ut||(Ut={})),function(n){n.DISCONNECT="disconnect",n.CONNECTION_STATE_CHANGE="connection-state-change",n.NETWORK_QUALITY="network-quality",n.STREAM_TYPE_CHANGE="stream-type-change",n.IS_P2P_DISCONNECTED="is-p2p-dis",n.DISCONNECT_P2P="dis-p2p",n.REQUEST_NEW_GATEWAY_LIST="req-gate-url",n.NEED_RENEW_SESSION="need-sid",n.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",n.JOIN_RESPONSE="join-response",n.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",n.RESET_CONNECTION_EVENTS="reset-connection-events",n.DATACHANNEL_PRECONNECT="datachannel_preconnect",n.DATACHANNEL_FAILBACK="datachannel_failback",n.RESET_SIGNAL="reset-signal"}(de||(de={})),function(n){n.P2P_DISCONNECTED="P2P_DISCONNECTED",n.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",n.TIMEOUT="TIMEOUT",n.UNKNOWN_REASON="UNKNOWN_REASON"}(qs||(qs={})),function(n){n[n.Nothing=0]="Nothing",n[n.Audio=1]="Audio",n[n.LwoVideo=2]="LwoVideo",n[n.Video=4]="Video",n[n.Data=8]="Data",n[n.DataStream0=256]="DataStream0",n[n.DataStream1=512]="DataStream1",n[n.DataStream2=1024]="DataStream2",n[n.DataStream3=2048]="DataStream3",n[n.DataStream4=4096]="DataStream4",n[n.DataStream5=8192]="DataStream5",n[n.DataStream6=16384]="DataStream6",n[n.DataStream7=32768]="DataStream7"}(be||(be={})),function(n){n[n.websocket=0]="websocket",n[n.datachannel=1]="datachannel"}(zd||(zd={})),function(n){n.CHINA="CHINA",n.ASIA="ASIA",n.NORTH_AMERICA="NORTH_AMERICA",n.EUROPE="EUROPE",n.JAPAN="JAPAN",n.INDIA="INDIA",n.KOREA="KOREA",n.HKMC="HKMC",n.US="US",n.OCEANIA="OCEANIA",n.SOUTH_AMERICA="SOUTH_AMERICA",n.AFRICA="AFRICA",n.OVERSEA="OVERSEA",n.GLOBAL="GLOBAL",n.EXTENSIONS="EXTENSIONS"}(Pt||(Pt={}));const XR=[Pt.AFRICA,Pt.ASIA,Pt.CHINA,Pt.EUROPE,Pt.GLOBAL,Pt.INDIA,Pt.JAPAN,Pt.NORTH_AMERICA,Pt.OCEANIA,Pt.OVERSEA,Pt.SOUTH_AMERICA];var Ze;(function(n){n.CHINA="CN",n.ASIA="AS",n.NORTH_AMERICA="NA",n.EUROPE="EU",n.JAPAN="JP",n.INDIA="IN",n.KOREA="KR",n.HKMC="HK",n.US="US",n.OCEANIA="OC",n.SOUTH_AMERICA="SA",n.AFRICA="AF",n.OVERSEA="OVERSEA",n.GLOBAL="GLOBAL",n.EXTENSIONS="GLOBAL"})(Ze||(Ze={}));const Xd={CHINA:{},ASIA:{CODE:Ze.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Ze.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Ze.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Ze.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Ze.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Ze.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Ze.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Ze.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Ze.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Ze.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Ze.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Ze.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Ze.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Za,QR,rt,nn,Ji,Y,Bt,lt,ZR,ni,ii,ke,ar,_e,Di,$R,Hn,Ti,ns,ue,is,cr,tC,Ap;fp&&(Xd.CHINA={CODE:Ze.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(n){n.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Za||(Za={}));class eC extends se{constructor(t,e){super(),h(this,"onICEConnectionStateChange",void 0),h(this,"onConnectionStateChange",void 0),h(this,"onDTLSTransportStateChange",void 0),h(this,"onDTLSTransportError",void 0),h(this,"onICETransportStateChange",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoReceived",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0)}}class Qd extends eC{constructor(t,e){super(t,e)}}(function(n){n.SEND="sendonly",n.RECV="recvonly",n.SENDRECV="sendrecv",n.INACTIVE="inactive"})(QR||(QR={})),function(n){n.VIDEO="video",n.AUDIO="audio"}(rt||(rt={})),function(n){n[n.UDP=0]="UDP",n[n.TCP=1]="TCP",n[n.RELAY=2]="RELAY"}(nn||(nn={})),function(n){n[n.FIRST_CONNECTION=0]="FIRST_CONNECTION",n[n.TCP_RESTART=1]="TCP_RESTART",n[n.RELAY_RESTART=2]="RELAY_RESTART",n[n.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",n[n.OLD_RESTART=11]="OLD_RESTART",n[n.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(Ji||(Ji={})),function(n){n.LocalVideoTrack="videoTrack",n.LocalAudioTrack="audioTrack",n.LocalVideoLowTrack="videoLowTrack"}(Y||(Y={})),function(n){n.New="new",n.Connected="connected",n.Reconnecting="reconnecting",n.Disconnected="disconnected"}(Bt||(Bt={})),function(n){n.StateChange="stateChange",n.IceConnectionStateChange="iceConnectionStateChange",n.RequestMuteLocal="requestMuteLocal",n.RequestUnmuteLocal="requestUnmuteLocal",n.RequestRePublish="requestRePublish",n.RequestRePublishDataChannel="requestRePublishDataChannel",n.RequestReSubscribe="requestReSubscribe",n.RequestUploadStats="requestUploadStats",n.RequestUpload="requestUpload",n.MediaReconnectStart="MediaReconnectStart",n.MediaReconnectEnd="MediaReconnectEnd",n.NeedSignalRTT="NeedSignalRTT",n.RequestRestartICE="RequestRestartIce",n.PeerConnectionStateChange="PeerConnectionStateChange",n.RequestReconnect="RequestReconnect",n.RequestReconnectPC="RequestReconnectPC",n.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",n.P2PLost="P2PLost",n.UpdateVideoEncoder="UpdateVideoEncoder",n.ConnectionTypeChange="ConnectionTypeChange",n.RequestLowStreamParameter="RequestLowStreamParameter",n.QueryClientConnectionState="QueryClientConnectionState",n.LocalCandidate="LocalCandidate",n.RequestP2PMuteLocal="requestP2PMuteLocal",n.RequestP2PUnPublish="RequestP2PUnPublish",n.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",n.RequestP2PMuteRemote="RequestP2PMuteRemote",n.RequestP2PRestartICE="RequestP2PRestartICE"}(lt||(lt={})),function(n){n.MUTE_LOCAL_VIDEO="mute_local_video",n.MUTE_LOCAL_AUDIO="mute_local_audio",n.UNMUTE_LOCAL_VIDEO="unmute_local_video",n.UNMUTE_LOCAL_AUDIO="unmute_local_audio",n.MUTE_REMOTE_VIDEO="mute_remote_video",n.MUTE_REMOTE_AUDIO="mute_remote_audio",n.UNMUTE_REMOTE_VIDEO="unmute_remote_video",n.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(ZR||(ZR={})),function(n){n.CONNECTING="CONNECTING",n.RECONNECTING="RECONNECTING",n.CONNECTED="CONNECTED",n.CLOSED="CLOSED"}(ni||(ni={})),function(n){n[n.CONNECT_AP=0]="CONNECT_AP",n[n.AP_CONNECTED=1]="AP_CONNECTED",n[n.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",n[n.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",n[n.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",n[n.CONNECT_WORKER=5]="CONNECT_WORKER",n[n.WORKER_CONNECTED=6]="WORKER_CONNECTED",n[n.CLOSED=7]="CLOSED"}(ii||(ii={})),function(n){n.CONNECTION_STATE_CHANGE="connection-state-change",n.STATE_CHANGE="state-change",n.INSPECT_RESULT="inspect-result",n.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",n.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ke||(ke={})),function(n){n.NETWORK_ERROR="NETWORK_ERROR",n.SERVER_ERROR="SERVER_ERROR",n.MULTI_IP="MULTI_IP",n.TIMEOUT="TIMEOUT",n.OFFLINE="OFFLINE",n.LEAVE="LEAVE",n.P2P_FAILED="P2P_FAILED",n.FALLBACK="FALLBACK"}(ar||(ar={})),function(n){n.CONNECTED="transmitter:connected",n.RECONNECTING="transmitter:reconnecting",n.WILL_RECONNECT="transmitter:will_reconnect",n.CLOSED="transmitter:closed",n.FAILED="transmitter:failed",n.ON_MESSAGE="transmitter:on_message",n.REQUEST_NEW_URLS="transmitter:request_new_urls",n.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",n.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",n.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",n.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",n.FAILBACK="transmitter:failback"}(_e||(_e={})),function(n){n.CAMERA_CHANGED="camera-changed",n.MICROPHONE_CHANGED="microphone-changed",n.PLAYBACK_DEVICE_CHANGED="playback-device-changed",n.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",n.AUTOPLAY_FAILED="autoplay-failed",n.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",n.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Di||(Di={})),function(n){n[n.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",n[n.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",n[n.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",n[n.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",n[n.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",n[n.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",n[n.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",n[n.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",n[n.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",n[n.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",n[n.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",n[n.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",n[n.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",n[n.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",n[n.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",n[n.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",n[n.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",n[n.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",n[n.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",n[n.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}($R||($R={})),function(n){n.CONNECTING="CONNECTING",n.RECONNECTING="RECONNECTING",n.CONNECTED="CONNECTED",n.CLOSED="CLOSED"}(Hn||(Hn={})),function(n){n.CONNECTION_STATE_CHANGE="connection-state-change",n.STATE_CHANGE="state-change",n.INSPECT_RESULT="inspect-result",n.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",n.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Ti||(Ti={})),function(n){n[n.CONNECT_AP=0]="CONNECT_AP",n[n.AP_CONNECTED=1]="AP_CONNECTED",n[n.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",n[n.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",n[n.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",n[n.CONNECT_WORKER=5]="CONNECT_WORKER",n[n.WORKER_CONNECTED=6]="WORKER_CONNECTED",n[n.CLOSED=7]="CLOSED"}(ns||(ns={})),function(n){n.CALL="call",n.CANDIDATE="candidate",n.PUBLISH="publish",n.UNPUBLISH="unpublish",n.CONTROL="control",n.RESTART_ICE="restart_ice",n.ACK="ack",n.RESPONSE="response",n.JOIN="join",n.CHECK="check"}(ue||(ue={})),function(n){n.ABORT="abort"}(is||(is={})),function(n){n.MUTE_LOCAL_AUDIO="mute_local_audio",n.MUTE_LOCAL_VIDEO="mute_local_video",n.UNMUTE_LOCAL_AUDIO="unmute_local_audio",n.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(cr||(cr={})),function(n){n[n.SUCCESS=1]="SUCCESS",n[n.FAILED=0]="FAILED"}(tC||(tC={})),function(n){n.P2P_TOKEN_TIMEOUT="p2p_token_timeout",n.P2P_TOKEN_CHANGED="p2p_token_changed"}(Ap||(Ap={}));const nM={[Ko.ACCESS_POINT]:{[un.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[un.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[un.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[un.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[un.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[un.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[un.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[un.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[un.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[un.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[un.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[un.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[un.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[un.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[un.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[un.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[un.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[un.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Ko.UNILBS]:{[ei.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ei.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ei.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ei.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ei.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ei.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ei.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ei.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ei.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ei.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ei.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ei.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Ko.STRING_UID_ALLOCATOR]:{[Qa.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Qa.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Qa.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Zd(n){const t=nM[Math.floor(n/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const e=t[n%1e4];if(!e){if(Math.floor(n/1e4)===Ko.ACCESS_POINT){const i=n%1e4;if(i.toString()[0]==="1")return{desc:n.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:n.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return e}const iM={[ct.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ct.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ct.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ct.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ct.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ct.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ct.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ct.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ct.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ct.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ct.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ct.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ct.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ct.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ct.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ct.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ct.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ct.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ct.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ct.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ct.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ct.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ct.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ct.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ct.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ct.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ct.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ct.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ct.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ct.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ct.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ct.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ct.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ct.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ct.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ct.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ct.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ct.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ct.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ct.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ct.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ct.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ct.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ct.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ct.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ct.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ct.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ct.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ct.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ct.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ct.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ct.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ct.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ct.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ct.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ct.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ct.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ct.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ct.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ct.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ct.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ct.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Js(n){return iM[n]||{desc:"UNKNOW_ERROR_".concat(n),action:"failed"}}function nC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function bp(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?nC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):nC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function iC(n){return n.every(t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)}function rC(n,t){if(typeof n=="string")return n;const{proxy:e,host:i,port:r}=n;if(t){const s=O("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(s,"/ws/?p=").concat(Number(r)+150)}return e?"wss://".concat(e,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const rM=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,sM=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,oM=/wss:\/\/(.+):([0-9]+)\/?/,aM=/wss:\/\/(.[^\/]+)\/?/;let cM=0;class dM{constructor(t,e){h(this,"id",0),h(this,"store",void 0),h(this,"recordIndex",void 0),h(this,"websockets",[]),h(this,"try443PortDuration",2e3),h(this,"forceCloseWSDuration",5e3),h(this,"try443PortTimeout",null),h(this,"forceCloseTimeout",null),h(this,"isTry443PortFailed",!1),h(this,"isNormalPortFailed",!1),h(this,"useDoubleDomain",!1),h(this,"useProxy",!1),h(this,"startTime",Date.now()),this.id=++cM,this.try443PortDuration=O("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=e}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;const e=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];m.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(e,"ms:"),...r)}createWebSocket(t,e,i){this.logger("createWebSocket:",t,{isTry443Port:e,hasTimeoutDetection:i});const r=O("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=r.find(u=>{var l;return nt(l=t.host).call(l,u)});a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach(u=>{c.push(rC(bp(bp({},t),{},{host:t.host.replace(a,u)}),e))});else{const u=bp({},t);if(e&&a){const l=r.find(p=>p!==a);l&&(u.host=u.host.replace(a,l))}c.push(rC(u,e))}try{c.forEach(u=>{const l=new WebSocket(u);l.binaryType="arraybuffer",o.push(l),this.logger("ws is connecting:",l.url)})}catch(u){if(this.logger("ws create failed"),o.forEach(l=>l.close()),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,e,i);if(!e&&Number(t.port)!==443)return this.createWebSocket(t,!0,i);throw new k(v.WS_ERR,"init websocket failed! Error: ".concat(u.toString()))}const d=Ha();return this.store&&this.store.recordJoinChannelService({urls:o.map(u=>u.url),service:"gateway"},this.recordIndex),o.forEach(u=>{u.onopen=()=>{this.logger("onopen: ws ".concat(u.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach(l=>{l!==u&&(l.onopen=null,l.onclose=null,l.onmessage=null,l.close(),this.logger("close backup websocket: ".concat(l.url)))}),this.websockets.length=0,d.resolve(u)},u.onclose=l=>{this.logger("onclose: ws ".concat(u.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(u.readyState)),e?this.isTry443PortFailed=iC(o):this.isNormalPortFailed=iC(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(e&&this.isTry443PortFailed||!e&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(l.reason)),d.reject({code:l.code,reason:qs.A_ROUND_WS_FAILED}))},u.onmessage=l=>this.logger("".concat(u.url," onmessage: ").concat(l.data))}),this.websockets.push(...o),i||(()=>{const u=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(l=>l.readyState!==WebSocket.OPEN&&l.close())};if(e||this.useProxy)return this.logger("add 5s timeout at ".concat(e?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return u();Lt().os===Ne.MAC_OS&&Jt()&&u(),this.createWebSocket(t,!0,!0).then(l=>d.resolve(l)).catch(l=>{this.isNormalPortFailed&&d.reject(l),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration)},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(t,e,i,r){return this.useDoubleDomain=!!e,typeof t=="string"&&(t=function(s){let o,a,c;return[,o,a,c]=s.match(rM)||[],o||([,a,c]=s.match(sM)||[]),a&&c||([,a,c]=s.match(oM)||[]),a&&c||([,a]=s.match(aM)||[]),a||m.warning("un-destructible url: ",s),{proxy:o,host:a,port:c||"443"}}(t)),this.recordIndex=r,this.useProxy=!!t.proxy,i&&this.useProxy&&(m.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(t,!!i,!1).finally(()=>this.clearTimeout())}}function sC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}class oC extends se{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;nt(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(pt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(pt.CONNECTED):this._state==="closed"?this.emit(pt.CLOSED):this._state==="failed"&&this.emit(pt.FAILED))}resetReconnectCount(t){m.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"urls",[]),h(this,"_reconnectMode","tryNext"),h(this,"reconnectReason",void 0),h(this,"_initMutex",new He("websocket")),h(this,"name",void 0),h(this,"_state","closed"),h(this,"reconnectInterrupter",void 0),h(this,"websocket",void 0),h(this,"retryConfig",void 0),h(this,"reconnectCount",0),h(this,"forceCloseTimeout",5e3),h(this,"onlineReconnectListener",void 0),h(this,"useCompress",void 0),h(this,"tryDoubleDomain",!1),h(this,"use443PortOnly",!1),h(this,"wsInflateLength",0),h(this,"wsDeflateLength",0),h(this,"closeEstablishingWs",()=>{}),h(this,"store",void 0),h(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=function(l){for(var p=1;p<arguments.length;p++){var _=arguments[p]!=null?arguments[p]:{};p%2?sC(Object(_),!0).forEach(function(R){h(l,R,_[R])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(_)):sC(Object(_)).forEach(function(R){Object.defineProperty(l,R,Object.getOwnPropertyDescriptor(_,R))})}return l}({},e),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=s;const{timeout:a,timeoutFactor:c}=e,d=Math.max(300,Math.floor(3*a/5)),u=Math.max(1.2,Math.floor(8*c)/10);Tn.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u),Re.on(yr.NETWORK_STATE_CHANGE,(l,p)=>{l!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(l)),l===Tn.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=e,this.urls=t,this.state="connecting";try{const r=Ha(),s=this.urls[this.currentURLIndex];this.createWebSocketConnection(s).then(r.resolve).catch(r.reject),this.once(pt.CLOSED,()=>{r.reject(new G(v.WS_DISCONNECT))}),this.once(pt.CONNECTED,r.resolve),await r.promise}catch{}finally{i()}}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;e?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,e){if(!this.websocket)return void m.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),m.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(e)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:e})}sendMessage(t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new G(v.WS_ABORT,"websocket is not ready");try{e||(t=JSON.stringify(t)),this.websocket.send(t)}catch(i){throw new G(v.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,e=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:e}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var e;const i=Ha();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=u=>{var l;(l=this.store)===null||l===void 0||l.signalChannelOpen(),m.debug("[".concat(this.name,"] websocket opened:"),u),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async u=>{var l;if(m.debug("[".concat(this.name,"] websocket close ").concat((l=this.websocket)===null||l===void 0?void 0:l.url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new G(v.WS_DISCONNECT,"websocket close: ".concat(u.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const p=Wn(this,pt.WILL_RECONNECT,this.reconnectMode,u.reason)||this.reconnectMode,_=await this.reconnectWithAction(p);if(this.state==="closed")return void m.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!_)return i.reject(new G(v.WS_DISCONNECT,"websocket reconnect failed: ".concat(u.code))),this.close(!0);i.resolve()}},o=u=>{this.emit(pt.ON_MESSAGE,u)},a=u=>{m.warn("[".concat(this.connectionID,"] ws open error ").concat(u))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),O("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=O("GATEWAY_WSS_ADDRESS")),m.debug("[".concat(this.name,"] start connect, url:"),t);const c=(e=this.store)===null||e===void 0?void 0:e.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const u=await this.chooseBestWebsocketConnection(t);this.websocket=u,r&&r(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(u){const l=this.state==="closed",p=u instanceof G,_=p&&u.code===v.WS_ABORT,R=p&&u.code===v.WS_ERR,f=p?u.message:u&&(u.reason||u.toString());m.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(f)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:_?"aborted":"error",errors:[u]},c),l||R?(i.reject(l?new G(v.WS_DISCONNECT,"websocket is closed: ".concat(f)):new G(v.WS_ERR,"init websocket failed: ".concat(f))),R&&m.error("[".concat(this.name,"] init websocket failed: ").concat(f))):s&&s(u)}return i.promise}async reconnectWithAction(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;m.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||Re.isOnline||!Re.onlineWaiter||(this.onlineReconnectListener=Re.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,e){const o=xd(this.reconnectCount,this.retryConfig);m.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(t)),await F.race([We(o),this.onlineReconnectListener||new F(()=>{})])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(o,a)=>{this.emit(pt.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(t==="retry")this.emit(pt.RECONNECT_WAITTING_FINISH,t),await r(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);m.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(pt.RECONNECT_WAITTING_FINISH,t),await r(this.urls[this.currentURLIndex],t)}else t==="recover"&&(m.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(pt.RECONNECT_WAITTING_FINISH,t),this.urls=await Se(this,pt.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],t))}catch(o){var s;m.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(s=o.data)===null||s===void 0?void 0:s.desc;return Array.isArray(a)&&nt(a).call(a,"dynamic key expired")?(this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,e)}return!0}}class $a extends oC{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){const i=Ha(),r=function(o,a){return new dM(o,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{m.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new G(v.WS_ABORT,"choose best websocket aborted"))};const s=O("GATEWAY_DOMAINS");return m.debug("[choose-best-ws] currentDomain: ",t,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,e).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class tc extends oC{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){return new F((i,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{m.debug("[choose-best-ws] close establishing websockets"),o.forEach(R=>{R.onclose=null,R.onopen=null,R.onmessage=null,R.close()}),r(new G(v.WS_ABORT,"choose best websocket aborted"))};const a=O("GATEWAY_DOMAINS");let c;const d=t.indexOf("?h="),u=a.find(R=>d!==-1?nt(t).call(t,R,d):nt(t).call(t,R));m.debug("[choose-best-ws] currentDomain: ",u,", domains: ",a);let l=!this.tryDoubleDomain||!u;if(!l&&u){var p;const R=Date.now();try{a.forEach(f=>{const T=d===-1?t.replace(u,f):t.substr(0,d)+t.substr(d).replace(u,f),A=new WebSocket(T);A.binaryType="arraybuffer",o.push(A),m.debug("[choose-best-ws] ws is connecting:",A.url)})}catch{for(m.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach(T=>T.close());o.length;)o.pop();l=!0}(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:o.map(f=>f.url),service:"gateway"},e),o.forEach(f=>{f.onopen=()=>{if(s)return;const T=Date.now()-R;m.debug("[choose-best-ws] ws open cost ".concat(T,"ms")),o.filter(A=>A!==f).forEach(A=>{m.debug("[choose-best-ws]close backup websocket: ".concat(A.url)),A.close()}),s=!0,i(f)},f.onclose=T=>{c=T,!s&&(o.find(A=>!(A.readyState===WebSocket.CLOSED||A.readyState===WebSocket.CLOSING))||(m.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c)))},f.onmessage=T=>{m.debug("[choose-best-ws]".concat(f.url," onmessage: ").concat(T.data))}}),We(this.forceCloseTimeout).then(()=>{o.forEach(f=>{f.readyState!==WebSocket.OPEN&&f.close()})})}if(l){var _;let R;m.debug("[choose-best-ws] use single url: ",t),(_=this.store)===null||_===void 0||_.recordJoinChannelService({urls:[t],service:"gateway"},e);try{R=new WebSocket(t),o.push(R),R.binaryType="arraybuffer"}catch(f){const T=new G(v.WS_ERR,"init websocket failed! Error: ".concat(f.toString()));return m.error("[".concat(this.name,"]").concat(T)),void r(T)}R.onopen=()=>{i(R)},R.onclose=f=>{r(f)},R.onmessage=f=>{m.debug("[choose-best-ws]".concat(R.url," onmessage: ").concat(f.data))},We(this.forceCloseTimeout).then(()=>{R&&R.readyState!==WebSocket.OPEN&&R.close()})}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class aC extends se{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===yt.CONNECTED?this.emit($.WS_CONNECTED):t===yt.RECONNECTING?this.emit($.WS_RECONNECTING,this._websocketReconnectReason):t===yt.CLOSED&&this.emit($.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",yt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new Zh(5)),h(this,"pingpongTimer",void 0),h(this,"wsInflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit($.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===Et.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Et.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ot.UID_BANNED);break;case 15:this.close(Ot.IP_BANNED);break;case 16:this.close(Ot.CHANNEL_BANNED)}if(r._type===Et.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ct.ERR_LICENSE_MISSING:this.close(Ot.LICENSE_MISSING);break;case ct.ERR_LICENSE_EXPIRED:this.close(Ot.LICENSE_EXPIRED);break;case ct.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ot.LICENSE_MINUTES_EXCEEDED);break;case ct.ERR_LICENSE_PERIOD_INVALID:this.close(Ot.LICENSE_PERIOD_INVALID);break;case ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ot.LICENSE_MULTIPLE_SDK_SERVICE);break;case ct.ERR_LICENSE_ILLEGAL:this.close(Ot.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new $a("gateway-".concat(this.clientId),this.spec.retryConfig,!0,O("JOIN_GATEWAY_USE_DUAL_DOMAIN"),O("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===yt.CONNECTED&&this.reconnect("retry",Ge.OFFLINE)})}async request(t,e,i,r){const s=Qt(6,""),o={_id:s,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new F((R,f)=>{if(this.connectionState===yt.CONNECTED)return R();const T=()=>{this.off($.WS_CLOSED,A),R()},A=()=>{this.off($.WS_CONNECTED,T),f(new k(v.WS_ABORT))};this.once($.WS_CONNECTED,T),this.once($.WS_CLOSED,A),t!==at.PUBLISH&&t!==at.SUBSCRIBE&&t!==at.UNSUBSCRIBE&&t!==at.UNPUBLISH&&t!==at.CONTROL&&t!==at.RESTART_ICE||this.once($.DISCONNECT_P2P,()=>{f(new k(v.DISCONNECT_P2P))}),t!==at.PUBLISH&&t!==at.RESTART_ICE||this.once($.ABORT_P2P_EXECUTION,()=>{f(new k(v.DISCONNECT_P2P))})});if(this.connectionState!==yt.CONNECTING&&this.connectionState!==yt.RECONNECTING||t===at.JOIN||t===at.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new F((R,f)=>{let T=!1;const A=(P,j)=>{T=!0,R({isSuccess:P==="success",message:j||{}}),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.emit($.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),A);const N=()=>{f(new k(v.WS_ABORT,"type: ".concat(t))),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.off("res-@".concat(s),A)};this.once($.WS_CLOSED,N),this.once($.WS_RECONNECTING,N),We(O("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||T||(m.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit($.REQUEST_TIMEOUT,t,e))})});let u=null;try{u=await d}catch(R){if(this.connectionState===yt.CLOSED||t===at.LEAVE)throw new k(v.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===at.JOIN||t===at.REJOIN?null:(await c(),await this.request(t,e))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Js(l),_=new k(v.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(m.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===ct.ERR_TOO_MANY_BROADCASTERS?((t===at.JOIN||t===at.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(l===ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ge.MULTI_IP)):this.reconnect(p.action,Ge.SERVER_ERROR),t===at.JOIN||t===at.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new F(i=>{const r=s=>{(!e||e(s))&&(this.off(t,r),i(s))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ar.WRTC_STATS,e)}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch{const s=O("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==yt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},O("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((i,r)=>{this.once($.WS_CONNECTED,()=>i(this.joinResponse)),this.once($.WS_CLOSED,()=>r(this.initError||new k(v.WS_ABORT))),this.connectionState=yt.CONNECTING,this.websocket.init(t).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ot.LEAVE,this.connectionState=yt.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===Ot.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new $a("gateway-".concat(this.clientId),this.spec.retryConfig,!0,O("JOIN_GATEWAY_USE_DUAL_DOMAIN"),O("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit($.ABORT_P2P_EXECUTION);const t=await Se(this,$.REQUEST_JOIN_INFO),e=await this.request(at.JOIN,t);if(!e)return this.emit($.REPORT_JOIN_GATEWAY,qs.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit($.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=yt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new k(v.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=js(this,$.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(at.REJOIN,t);return!!e&&(this.connectionState=yt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach(i=>{this.emit(Et.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Et.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Et.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Et.MUTE_AUDIO,{uid:i.uid}):this.emit(Et.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Et.MUTE_VIDEO,{uid:i.uid}):this.emit(Et.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Et.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Et.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Et.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Et.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Et.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){m.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Js(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ot.UID_BANNED),void this.close()):void this.reconnect(e.action,Ge.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=O("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(m.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>O("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Ge.TIMEOUT):this.request(at.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-e;this.rttRolling.add(i),O("REPORT_STATS")&&this.send(at.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:e}=this.websocket.getWsInflateData();t!==0&&e!==0&&this.upload(Ar.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(pt.RECONNECT_WAITTING_FINISH,t=>{this.emit($.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(pt.RECONNECT_CREATE_CONNECTION,t=>{this.emit($.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(pt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(pt.CLOSED,()=>{this.connectionState=yt.CLOSED}),this.websocket.on(pt.FAILED,()=>{this._disconnectedReason=Ot.NETWORK_ERROR,this.connectionState=yt.CLOSED}),this.websocket.on(pt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===yt.CONNECTED?this.connectionState=yt.RECONNECTING:this.connectionState=yt.CONNECTING}),this.websocket.on(pt.WILL_RECONNECT,(t,e,i)=>{const r=js(this,$.IS_P2P_DISCONNECTED),s=r||t!=="retry";r&&t==="retry"&&(m.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",e=qs.P2P_DISCONNECTED),s&&(m.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit($.REPORT_JOIN_GATEWAY,e||qs.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit($.NEED_RENEW_SESSION),this.emit($.DISCONNECT_P2P)),i(t)}),this.websocket.on(pt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{m.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Ge.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit($.REPORT_JOIN_GATEWAY,t.message||t.code||qs.UNKNOWN_REASON,this.url||""),t instanceof k&&t.code===v.UNEXPECTED_RESPONSE&&t.data.code===ct.ERR_NO_AUTHORIZED)return m.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Ge.SERVER_ERROR);m.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ge.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(pt.REQUEST_NEW_URLS,(t,e)=>{Se(this,$.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Et.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var cC=`	
\v\f\r                　\u2028\u2029\uFEFF`,uM=va,lM=Sr,wp=cC,dC=ut("".replace),hM=RegExp("^["+wp+"]+"),pM=RegExp("(^|[^"+wp+"])["+wp+"]+$"),Op=function(n){return function(t){var e=lM(uM(t));return 1&n&&(e=dC(e,hM,"")),2&n&&(e=dC(e,pM,"$1")),e}},_M={start:Op(1),end:Op(2),trim:Op(3)},mM=Rg.PROPER,EM=D,uC=cC,fM=_M.trim;le({target:"String",proto:!0,forced:function(n){return EM(function(){return!!uC[n]()||"​᠎"[n]()!=="​᠎"||mM&&uC[n].name!==n})}("trim")},{trim:function(){return fM(this)}});var Ke,Si,gM=Wr("String").trim,TM=wt,SM=gM,Np=String.prototype,Dp=b(function(n){var t=n.trim;return typeof n=="string"||n===Np||TM(Np,n)&&t===Np.trim?SM:t});function lC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function $d(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?lC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):lC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function rs(n){return n.match(/^[\.\:\d]+$/)?"".concat(n.replace(/[^\d]/g,"-"),".").concat(O("TURN_DOMAIN")):(m.info("Unidentified as ip: ".concat(n,", use as host")),n)}function hC(n,t){n.addresses||(n.addresses=[]);const e=function(s,o){if(O("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return s.map(d=>{let{ip:u,port:l}=d;return{address:"".concat(u,":").concat(l)}});const a=O("GATEWAY_DOMAINS");let c=a[1]&&nt(o).call(o,a[1])?1:0;return s.map(d=>{let{domain_prefix:u,port:l,ip:p}=d;if(u)return{address:"".concat(u,".").concat(a[c++%a.length],":").concat(l)};const _=/^[\.\:\d]+$/.test(p),R=_?"".concat(p.replace(/[^\d]/g,"-"),".").concat(a[c++%a.length],":").concat(l):"".concat(p,":").concat(l);return _||m.info("Unidentified as ip: ".concat(p,", use as host")),{ip:p,port:l,address:R}})}(n.addresses,t),i=Array.isArray(n.detail)&&n.detail[18];if(i&&typeof i=="string"){const s=i.split(";");for(let o=0;o<s.length;o++){var r;const a=Dp(r=s[o]).call(r);e[o]&&a&&(e[o].ip6=a)}}return{gatewayAddrs:e,uid:n.uid,cid:n.cid,cert:n.cert,vid:n.detail&&n.detail[8],uni_lbs_ip:n.detail&&n.detail[1],res:n,csIp:n.detail&&n.detail[502]}}function ri(n){return typeof n=="number"?n:n.exact||n.ideal||n.max||n.min||0}function pC(n){const t=n._encoderConfig;if(!t)return{};const e={resolution:t.width&&t.height?"".concat(ri(t.width),"x").concat(ri(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(e.maxFrameRate=t.frameRate,e.minFrameRate=t.frameRate):t.frameRate&&(e.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,e.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),e}function _C(n){return n>=0&&n<.17?1:n>=.17&&n<.36?2:n>=.36&&n<.59?3:n>=.59&&n<=1?4:n>1?5:0}function Pp(n,t){let e,i,r;switch(t){case Ke.CHOOSE_SERVER:i=4096,r="choose server";break;case Ke.CLOUD_PROXY:i=1048576,r="proxy";break;case Ke.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case Ke.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new k(v.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:n.detail&&n.detail[502],retry:!1})}if(n.response_body.forEach(s=>{s.buffer&&s.buffer.flag===i&&(e={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map(o=>$d($d({},o),{},{ticket:s.buffer.cert})),server_ts:n.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:$d($d({},s.buffer.detail),n.detail),flag:s.buffer.flag,opid:n.opid,cert:s.buffer.cert})}),!e)throw new k(v.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:n.detail&&n.detail[502]});return e}async function RM(n,t){return await F.all(n.addresses.map(async e=>({address:rs(e.ip),tcpport:e.port,udpport:e.port,username:t&&O("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():yn.username,password:t&&O("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await qh(t.toString()):yn.password})))}function Lp(n,t){const e=t._videoHeight||t.getMediaStreamTrack(!0).getSettings().height;return e?Math.max(e/ri(n.height),1):(m.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ss(n){let{candidateType:t,relayProtocol:e,type:i,address:r,port:s,protocol:o}=n;return i==="local-candidate"?{candidateType:t,relayProtocol:e,protocol:o}:{candidateType:t,relayProtocol:e,address:r,port:s,protocol:o}}function mC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}(function(n){n[n.CHOOSE_SERVER=11]="CHOOSE_SERVER",n[n.CLOUD_PROXY=18]="CLOUD_PROXY",n[n.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",n[n.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(Ke||(Ke={}));class CM extends se{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;nt(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(_e.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(_e.CONNECTED):this._state==="closed"?this.emit(_e.CLOSED):this._state==="failed"&&this.emit(_e.FAILED))}constructor(t,e,i,r){super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"reconnectReason",void 0),h(this,"_reconnectMode","tryNext"),h(this,"_name",void 0),h(this,"_state","closed"),h(this,"_retryConfig",void 0),h(this,"_reconnectCount",0),h(this,"_forceCloseTimeout",5e3),h(this,"_onlineReconnectListener",void 0),h(this,"_closeEstablishingTransmitter",()=>{}),h(this,"_store",void 0),h(this,"_joinChannelServiceRecordIndex",void 0),h(this,"_useCompress",void 0),h(this,"_inflateLength",0),h(this,"_deflateLength",0),this._store=r,this._name=t,this._retryConfig=function(s){for(var o=1;o<arguments.length;o++){var a=arguments[o]!=null?arguments[o]:{};o%2?mC(Object(a),!0).forEach(function(c){h(s,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):mC(Object(a)).forEach(function(c){Object.defineProperty(s,c,Object.getOwnPropertyDescriptor(a,c))})}return s}({},e),this._useCompress=i}resetReconnectCount(t){m.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;e?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,e){if(!this._transmitter)return void m.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;t!==void 0&&(this.reconnectMode=t),m.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(e)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:e})}getInflateData(){const t=this._inflateLength,e=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:e}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}(function(n){n[n.Default=0]="Default",n[n.Ack=1]="Ack"})(Si||(Si={}));class vM{constructor(t,e,i){h(this,"version",1),h(this,"initialRTO",void 0),h(this,"maxBatchAckCount",void 0),h(this,"maxRTO",void 0),h(this,"initialRTT",void 0),h(this,"ID",void 0),h(this,"rtt",void 0),h(this,"packetNumber",1),h(this,"rtoRatioMap",new Map),h(this,"timeoutMap",new Map),h(this,"unorderedPacketQueue",[]),h(this,"batchAckPacketQueue",[]),h(this,"lastOrderedPacketNumber",0),h(this,"batchAckTimer",void 0),h(this,"sendImpl",void 0),h(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=e,this.ID=Qt(7,"transmitter-"),this.initialRTO=(i==null?void 0:i.initialRTO)!==void 0?i.initialRTO:O("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:O("TRANSMITTER_INITIAL_RTT"),this.rtt=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:O("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(i==null?void 0:i.maxBatchAckCount)!==void 0?i.maxBatchAckCount:O("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(i==null?void 0:i.maxRTO)!==void 0?i.maxRTO:O("TRANSMITTER_MAX_RTO")}packetize(t,e){return{type:Si.Default,version:this.version,packetNumber:e,payload:t}}serialize(t){switch(t.type){case Si.Default:{let e;typeof t.payload=="string"?e=new TextEncoder().encode(t.payload):e=t.payload;const i=new ArrayBuffer(e.length+15),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.packetNumber),bS(r,7,BigInt(t.sendTs)),new Uint8Array(r.buffer).set(e,15),i}case Si.Ack:{const e=new ArrayBuffer(16),i=new DataView(e);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),bS(i,8,BigInt(t.ackSendTs)),e}}}deserialize(t){const e=new DataView(t),i=e.getUint16(0),r=e.getUint8(2);switch(r){case Si.Default:{const s=e.getUint32(3),o=AS(e,7),a=t.slice(15),c=new TextDecoder().decode(a);return{version:i,type:r,packetNumber:s,sendTs:Number(o),payload:c}}case Si.Ack:{const s=e.getUint32(3),o=e.getUint8(7),a=AS(e,8);return{version:i,type:r,maxAckPacketNumber:s,shift:o,ackSendTs:Number(a)}}default:throw m.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(t){const e=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(e),r=window.setTimeout(()=>{this.resendMessage(e)},i);this.timeoutMap.set(e.packetNumber,r),this.sendPacket(e)}onData(t){const e=this.deserialize(t);e.type===Si.Default?this.ack(e):e.type===Si.Ack&&(this.updateRTT(e,Math.round(performance.now())),this.clearRTO(e))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[e,i]=t;window.clearTimeout(i)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const e=this.calculateRTO(t),i=window.setTimeout(()=>{this.resendMessage(t)},e);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const e=this.rtoRatioMap.get(t.packetNumber);if(e===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*e;return this.rtoRatioMap.set(t.packetNumber,e+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,e){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(e-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Si.Ack,version:this.version};this.sendPacket(e)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Si.Ack,version:this.version};this.sendPacket(e)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Si.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Si.Default&&(t.sendTs=Math.round(performance.now()));const e=this.serialize(t);this.sendImpl(e)}clearRTO(t){for(let e=t.maxAckPacketNumber-t.shift;e<=t.maxAckPacketNumber;e++){const i=this.timeoutMap.get(e);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(e),this.rtoRatioMap.delete(e)}}}class EC extends CM{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),h(this,"_initMutex",void 0),h(this,"_reconnectInterrupter",void 0),h(this,"_url",void 0),h(this,"_transmitter",void 0),h(this,"_addresses",void 0),h(this,"_reliableTransmission",void 0),this._initMutex=new He("datachannel");const{timeout:i,timeoutFactor:r}=e,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*r)/10);Tn.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),Re.on(yr.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===Tn.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=e;const i=(r,s)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||O("FINGERPRINT"));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(r).catch(s),this.once(_e.CLOSED,()=>s(new k(v.WS_DISCONNECT))),this.once(_e.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new F((s,o)=>{i(s,o)}).then(()=>{r()}).catch(()=>{r()}))}sendMessage(t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new k(v.WS_ABORT,"datachannel is not ready");try{e||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(i){throw new k(v.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const e=JSON.stringify(t);return{compressed:e,compressedLength:e.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new F((e,i)=>{var r;const s=()=>{m.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),e()},o=async u=>{var l;if((l=this._closeEstablishingTransmitter)===null||l===void 0||l.call(this),m.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(u.code,", reason: ").concat(u.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=u.reason,this.state="reconnecting");const p=Wn(this,_e.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,_=await this.reconnectWithAction(p);if(this.state==="closed")return void m.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!_)return i(new k(v.WS_DISCONNECT,"datachannel reconnect failed: ".concat(u.code))),void this.close(!0);e()}else i(new k(v.WS_DISCONNECT,"datachannel close: ".concat(u.code))),this.close()},a=u=>{var l;(l=this._reliableTransmission)===null||l===void 0||l.onData(u.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),m.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Se(this,_e.TO_CONNECT_DATACHANNEL,t).then(u=>{var l,p;if(!u)throw new Error("transmissonInfo not exist yet");const{transmitter:_,close:R}=u;this._transmitter=_,(l=this._store)===null||l===void 0||l.signalChannelOpen();const f=Date.now()-d;m.debug("[choose dc] dc open cost ".concat(f,"ms")),this._reliableTransmission=new vM(T=>{var A;this._transmitter&&this._transmitter.readyState==="open"&&((A=this._transmitter)===null||A===void 0||A.send(T))},T=>{typeof T=="string"&&this.emit(_e.ON_MESSAGE,T)}),this._closeEstablishingTransmitter=()=>{var T;(T=this._reliableTransmission)===null||T===void 0||T.close(),this._reliableTransmission=void 0,R()},s&&s(),_.onclose=o,_.onmessage=a,(p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(u=>{var l;if((l=this._store)===null||l===void 0||l.recordJoinChannelService({endTs:Date.now(),status:u instanceof k&&u.code===v.WS_ABORT?"aborted":"error",errors:[u]},c),this.state!=="closed"){if(u instanceof k&&u.code===v.WS_ERR){const p=new k(v.WS_ERR,"init datachannel failed! Error: ".concat(u.toString()));return m.error("[".concat(this._name,"]").concat(p)),void i(p)}o&&o(u)}else i(new k(v.WS_DISCONNECT,"datachannel is closed: ".concat(u.toString())))})})}async reconnectWithAction(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Re.networkState!==Tn.OFFLINE||(this._onlineReconnectListener=Re.onlineWaiter&&Re.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},e){const a=xd(this._reconnectCount,this._retryConfig);m.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(t)),await F.race([We(a),this._onlineReconnectListener||new F(()=>{})])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(a,c)=>{this.emit(_e.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(t==="retry"){const a=this._addresses[this.currentURLIndex];this.emit(_e.RECONNECT_WAITTING_FINISH,t),await r(a,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||O("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return m.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);m.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];this.emit(_e.RECONNECT_WAITTING_FINISH,t),await r(a,t)}else t==="recover"&&(m.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(_e.RECONNECT_WAITTING_FINISH,t),this.emit(_e.FAILBACK));return!0}catch(a){var s,o;return m.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(s=a.data)!==null&&s!==void 0&&s.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&nt(o=a.data.desc).call(o,"dynamic key expired")?(this.emit(_e.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,e)}}}class br extends se{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===yt.CONNECTED?this.emit($.WS_CONNECTED):t===yt.RECONNECTING?this.emit($.WS_RECONNECTING,this._websocketReconnectReason):t===yt.CLOSED&&this.emit($.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",yt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new Zh(5)),h(this,"pingpongTimer",void 0),h(this,"inflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",i=>{if(i instanceof ArrayBuffer)return void this.emit($.ON_BINARY_DATA,i);const r=JSON.parse(i);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")&&(this.emit(r._type,r._message),r._type===Et.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Et.ON_USER_BANNED))switch(r._message.error_code){case 14:this.close(Ot.UID_BANNED);break;case 15:this.close(Ot.IP_BANNED);break;case 16:this.close(Ot.CHANNEL_BANNED)}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new EC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===yt.CONNECTED&&this.reconnect("retry",ar.OFFLINE)})}async request(t,e,i,r){const s=Qt(6,""),o={_id:s,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new F((R,f)=>{if(this.connectionState===yt.CONNECTED)return R();const T=()=>{this.off($.WS_CLOSED,A),R()},A=()=>{this.off($.WS_CONNECTED,T),f(new k(v.WS_ABORT))};this.once($.WS_CONNECTED,T),this.once($.WS_CLOSED,A),t!==at.PUBLISH&&t!==at.SUBSCRIBE&&t!==at.UNSUBSCRIBE&&t!==at.UNPUBLISH&&t!==at.CONTROL&&t!==at.RESTART_ICE||this.once($.DISCONNECT_P2P,()=>{f(new k(v.DISCONNECT_P2P))}),t!==at.PUBLISH&&t!==at.RESTART_ICE||this.once($.ABORT_P2P_EXECUTION,()=>{f(new k(v.DISCONNECT_P2P))})});if(this.connectionState!==yt.CONNECTING&&this.connectionState!==yt.RECONNECTING||t===at.JOIN||t===at.REJOIN||await c(),t===at.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),this.websocket.sendMessage(o,!0,!1),r)return;const d=new F((R,f)=>{let T=!1;const A=(P,j)=>{T=!0,R({isSuccess:P==="success",message:j||{}}),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.emit($.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),A);const N=()=>{f(new k(v.WS_ABORT,"type: ".concat(t))),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.off("res-@".concat(s),A)};this.once($.WS_CLOSED,N),this.once($.WS_RECONNECTING,N),We(O("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||T||(m.warning("dc request timeout, type: ".concat(t)),this.emit($.REQUEST_TIMEOUT,t,e))})});let u=null;try{u=await d}catch(R){if(this.connectionState===yt.CLOSED||t===at.LEAVE)throw new k(v.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===at.JOIN||t===at.REJOIN?null:(await c(),await this.request(t,e))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Js(l),_=new k(v.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(m.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===ct.ERR_TOO_MANY_BROADCASTERS?((t===at.JOIN||t===at.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(l===ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ar.MULTI_IP)):this.reconnect(p.action,ar.SERVER_ERROR),t===at.JOIN||t===at.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new F(i=>{const r=s=>{(!e||e(s))&&(this.off(t,r),i(s))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ar.WRTC_STATS,e)}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch{const s=O("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==yt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},O("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((i,r)=>{this.once($.WS_CONNECTED,()=>i(this.joinResponse)),this.once($.WS_CLOSED,()=>r(this.initError||new k(v.WS_ABORT))),this.connectionState=yt.CONNECTING,this.websocket.init(t).catch(r),this.websocket.once(_e.FAILBACK,()=>{this.openConnectionTime===void 0&&r(new k(v.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{e&&this.openConnectionTime===void 0&&(m.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new k(v.INIT_DATACHANNEL_TIMEOUT)))},O("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ot.LEAVE,this.connectionState=yt.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Ot.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new EC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit($.ABORT_P2P_EXECUTION);const t=await Se(this,$.DATACHANNEL_CONNECTING),e=await this.request(at.JOIN,t);if(!e)return this.emit($.REPORT_JOIN_GATEWAY,v.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit($.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=yt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new k(v.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=js(this,$.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(at.REJOIN,t);return!!e&&(this.connectionState=yt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach(i=>{this.emit(Et.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Et.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Et.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Et.MUTE_AUDIO,{uid:i.uid}):this.emit(Et.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Et.MUTE_VIDEO,{uid:i.uid}):this.emit(Et.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Et.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Et.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Et.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Et.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Et.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){m.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Js(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ot.UID_BANNED),void this.close()):void this.reconnect(e.action,ar.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=O("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(m.warning("PINGPONG Timeout. Last Socket Message: ".concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>O("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",ar.TIMEOUT):this.request(at.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-e;this.rttRolling.add(i),O("REPORT_STATS")&&this.send(at.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleInflateData(){const{inflateLength:t,deflateLength:e}=this.websocket.getInflateData();t!==0&&e!==0&&this.upload(Ar.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(_e.RECONNECT_WAITTING_FINISH,t=>{this.emit($.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(_e.RECONNECT_CREATE_CONNECTION,t=>{this.emit($.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(_e.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(_e.CLOSED,()=>{this.connectionState=yt.CLOSED}),this.websocket.on(_e.FAILED,()=>{this._disconnectedReason=Ot.NETWORK_ERROR,this.connectionState=yt.CLOSED}),this.websocket.on(_e.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===yt.CONNECTED?this.connectionState=yt.RECONNECTING:this.connectionState=yt.CONNECTING}),this.websocket.on(_e.WILL_RECONNECT,(t,e)=>{if(js(this,$.IS_P2P_DISCONNECTED)&&t==="retry")return m.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit($.NEED_RENEW_SESSION),this.emit($.DISCONNECT_P2P),e("tryNext");t!=="retry"&&(m.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit($.NEED_RENEW_SESSION),this.emit($.DISCONNECT_P2P)),e(t)}),this.websocket.on(_e.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{m.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",ar.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit($.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof k&&t.code===v.UNEXPECTED_RESPONSE&&t.data.code===ct.ERR_NO_AUTHORIZED)return m.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ar.SERVER_ERROR);m.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ar.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(_e.REQUEST_NEW_URLS,(t,e)=>{Se(this,$.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on(_e.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Et.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(_e.TO_CONNECT_DATACHANNEL,async(t,e,i)=>Se(this,$.DATACHANNEL_PRECONNECT,t).then(e).catch(i)),this.websocket.on(_e.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit($.DATACHANNEL_FAILBACK)})}}class zs extends se{constructor(t,e){super(),h(this,"signal",void 0),h(this,"token",void 0),h(this,"tokenTimeout",void 0),h(this,"tokenInterval",void 0),h(this,"_sequence",0),h(this,"userMap",new Map),h(this,"encoder",new TextEncoder),this.signal=t,this.token=e;const i=()=>{this.signal.connectionState===yt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*O("P2P_TOKEN_INTERVAL"))};i()}async send(t,e,i,r,s){var o,a,c;if(this.userMap.size===0)return;const d=Array.from(Yi(o=this.userMap).call(o))[0].token;typeof e!="string"&&(e=JSON.stringify(e)),r=(a=r)!==null&&a!==void 0?a:Qt(6,""),s=(c=s)!==null&&c!==void 0?c:this._sequence++;const u={_id:r,_type:t,_seq:s,_message:e,token:"".concat(this.token,"_").concat(d)};O("SHOW_P2P_LOG")&&m.debug("send message",u,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(u)).forEach(p=>{this.signal.request(at.DATA_STREAM,{payload:Fo(this.encoder.encode(p))})});const l=new F((p,_)=>{const R=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),A),this.off(is.ABORT,T),m.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(r)),this.userMap.size===0?_(new G(v.INVALID_REMOTE_USER)):_(new G(v.TIMEOUT))},O("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),f=()=>{R&&window.clearTimeout(R),this.off(is.ABORT,T),i&&p()},T=()=>{R&&window.clearTimeout(R),this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),A),_(new G(v.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(r)))};this.once(is.ABORT,T),this.once("res-@".concat(r,"_ack"),f);const A=(P,j)=>{N=!0,R&&window.clearTimeout(R),this.off("res-@".concat(r,"_ack"),f),this.off(is.ABORT,T),P==="success"?p(j):_(new G(v.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(r)))};let N=!1;i||(this.once("res-@".concat(r),A),We(O("SIGNAL_REQUEST_TIMEOUT")).then(()=>{N||m.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(r,", ").concat(u))}))});try{return await l}catch(p){if(p.code===v.TIMEOUT)return await this.send(t,e,i,r,s);throw p}}onMessage(t){var e;const{_uid:i}=t;let r,s=this.userMap.get(i);if(s)r=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==ue.CHECK)return;const{token:d}=t;r=new Map,s={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(Et.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:d,total:u}=t,l=(o=r.get(d))!==null&&o!==void 0?o:[];if(l.push(t),r.has(d)||r.set(d,l),l.length!==u)return;{const p=Ma(l).call(l,(_,R)=>_.index-R.index).map(_=>_.payload).join("");r.delete(d),(t=JSON.parse(p))._uid=i}}const{_type:a,token:c}=t;if(nt(e=[ue.ACK,ue.CHECK]).call(e,a))return a===ue.CHECK&&this.handleCheckToken(s,c),void this.receiveMessage(t);c==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(t):m.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(s.token,"_").concat(this.token),t)}check(){const t={_id:Qt(6,""),token:this.token,_type:ue.CHECK};O("SHOW_P2P_LOG")&&m.debug("send message",t),this.signal.request(at.DATA_STREAM,{payload:Fo(this.encoder.encode(JSON.stringify(t)))})}ack(t){const e={_id:t,_type:ue.ACK,token:this.token};O("SHOW_P2P_LOG")&&m.debug("send message",e),this.signal.request(at.DATA_STREAM,{payload:Fo(this.encoder.encode(JSON.stringify(e)))})}response(t,e,i){this.send(ue.RESPONSE,JSON.stringify({success:!i,message:e}),!0,t)}handleReceivedMessage(t){const e=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:u,nextExpectedSequenceNumber:l}=d;for(;u.has(l);){const p=u.get(l);u.delete(l),this.receiveMessage(p),d.nextExpectedSequenceNumber++}})};if(!t)return void e();const{_uid:i,_seq:r}=t,s=this.userMap.get(i),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=s;if(r<c)return this.ack(t._id),void m.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(t._message));o.set(r,t),a&&r===c&&(this.receiveMessage(t),o.delete(c),s.nextExpectedSequenceNumber++,e())}receiveMessage(t){const{_id:e,_type:i,_message:r,_uid:s}=t;if(O("SHOW_P2P_LOG")&&m.debug("receive message",t),e){let o;switch(t._type!==ue.ACK&&(r&&(o=JSON.parse(r)),this.ack(t._id)),t._type){case ue.CANDIDATE:case ue.CONTROL:this.signal.emit(i,o,s);break;case ue.PUBLISH:case ue.UNPUBLISH:case ue.RESTART_ICE:case ue.CALL:o.uid=s,Se(this.signal,i,o).then(a=>{this.response(t._id,a)}).catch(()=>{this.response(t._id,void 0,!0)});break;case ue.ACK:this.getListeners("res-@".concat(e,"_ack")).length>0&&this.emit("res-@".concat(e,"_ack"));break;case ue.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(e),a?"success":"failed",c);break}}}}splitMessage(t){if(t.length<zs.MAX_MESSAGE_SIZE)return[t];const e=[],{remoteToken:i}=JSON.parse(t),r=Qt(6,"");let s=0,o=800;const a=Math.ceil(t.length/o);for(;t.length>0;){s++;const c={id:r,index:s,total:a,payload:t.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>zs.MAX_MESSAGE_SIZE?o-=50:(e.push(c),t=t.slice(o))}return e.map(c=>JSON.stringify(c))}handleCheckToken(t,e){return t.token!==e?(m.debug("token changed, from ".concat(t.token," to ").concat(e)),this.reset(t.uid,e),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{m.debug("token timeout, ".concat(e)),this.reset(t.uid)},O("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await Se(this.signal,ue.CALL,void 0),e=await this.send(ue.CALL,t);this.signal.emit($.P2P_CONNECTION,e,!0)}async reset(t,e){const i=this.userMap.get(t);i&&(this.emit(is.ABORT),this.signal.emit(Et.ON_USER_OFFLINE,{uid:i.uid,reason:Ap.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),e||(m.debug("change local token from ".concat(e," to ").concat(e)),this.token=Qt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(is.ABORT)}}h(zs,"MAX_SIZE",1),h(zs,"MAX_MESSAGE_SIZE",1024);class fC extends se{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===yt.CONNECTED?this.emit($.WS_CONNECTED):t===yt.RECONNECTING?this.emit($.WS_RECONNECTING,this._websocketReconnectReason):t===yt.CLOSED&&this.emit($.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",yt.CLOSED),h(this,"reconnectToken",void 0),h(this,"p2pToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new Zh(5)),h(this,"pingpongTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"_external_signal",void 0),h(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit($.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case Et.ON_DATA_STREAM:return void this.handleDataStream(r._message);case Et.MUTE_AUDIO:case Et.MUTE_VIDEO:case Et.ON_P2P_LOST:case Et.ON_USER_ONLINE:return;case Et.ON_USER_OFFLINE:const{uid:s}=r._message;return m.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(r._type,r._message),r._type===Et.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Et.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ot.UID_BANNED);break;case 15:this.close(Ot.IP_BANNED);break;case 16:this.close(Ot.CHANNEL_BANNED)}if(r._type===Et.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ct.ERR_LICENSE_MISSING:this.close(Ot.LICENSE_MISSING);break;case ct.ERR_LICENSE_EXPIRED:this.close(Ot.LICENSE_EXPIRED);break;case ct.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ot.LICENSE_MINUTES_EXCEEDED);break;case ct.ERR_LICENSE_PERIOD_INVALID:this.close(Ot.LICENSE_PERIOD_INVALID);break;case ct.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ot.LICENSE_MULTIPLE_SDK_SERVICE);break;case ct.ERR_LICENSE_ILLEGAL:this.close(Ot.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new $a("gateway-".concat(this.clientId),this.spec.retryConfig,!0,O("JOIN_GATEWAY_USE_DUAL_DOMAIN"),O("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===yt.CONNECTED&&this.reconnect("retry",Ge.OFFLINE)}),this.p2pToken=Qt(6,""),this._external_signal=new zs(this,this.p2pToken)}async request(t,e,i,r){const s=Qt(6,""),o={_id:s,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new F((R,f)=>{if(this.connectionState===yt.CONNECTED)return R();const T=()=>{this.off($.WS_CLOSED,A),R()},A=()=>{this.off($.WS_CONNECTED,T),f(new G(v.WS_ABORT))};this.once($.WS_CONNECTED,T),this.once($.WS_CLOSED,A)});if(this.connectionState!==yt.CONNECTING&&this.connectionState!==yt.RECONNECTING||t===at.JOIN||t===at.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new F((R,f)=>{let T=!1;const A=(P,j)=>{T=!0,R({isSuccess:P==="success",message:j||{}}),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.emit($.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),A);const N=()=>{f(new G(v.WS_ABORT,"type: ".concat(t))),this.off($.WS_CLOSED,N),this.off($.WS_RECONNECTING,N),this.off("res-@".concat(s),A)};this.once($.WS_CLOSED,N),this.once($.WS_RECONNECTING,N),We(O("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||T||(m.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit($.REQUEST_TIMEOUT,t,e))})});let u=null;try{u=await d}catch(R){if(this.connectionState===yt.CLOSED||t===at.LEAVE)throw new G(v.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===at.JOIN||t===at.REJOIN?null:(await c(),await this.request(t,e))}if(u.isSuccess)return u.message;const l=Number(u.message.error_code||u.message.code),p=Js(l),_=new G(v.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(u.message.error_str),{code:l,data:u.message});return p.action==="success"?u.message:(m.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(p.desc,", action: ").concat(p.action)),l===ct.ERR_TOO_MANY_BROADCASTERS?((t===at.JOIN||t===at.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(l===ct.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ge.MULTI_IP)):this.reconnect(p.action,Ge.SERVER_ERROR),t===at.JOIN||t===at.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new F(i=>{const r=s=>{(!e||e(s))&&(this.off(t,r),i(s))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ar.WRTC_STATS,e)}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch{const s=O("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==yt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},O("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}async sendExtensionMessage(t,e,i){return await this._external_signal.send(t,e,i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((e,i)=>{this.once($.WS_CONNECTED,()=>e(this.joinResponse)),this.once($.WS_CLOSED,()=>i(this.initError||new G(v.WS_ABORT))),this.connectionState=yt.CONNECTING,this.websocket.init(t).catch(i)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||Ot.LEAVE,this.connectionState=yt.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===Ot.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new $a("gateway-".concat(this.clientId),this.spec.retryConfig,!0,O("JOIN_GATEWAY_USE_DUAL_DOMAIN"),O("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=Qt(6,""),this._external_signal.clear(),this._external_signal=new zs(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit($.ABORT_P2P_EXECUTION);const t=await Se(this,$.REQUEST_JOIN_INFO),e=await this.request(at.JOIN,t);if(!e)return this.emit($.REPORT_JOIN_GATEWAY,v.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit($.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=yt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleDataStream(t){try{var e;const i=kd(t.payload),r=new TextDecoder().decode(i),s=JSON.parse(r);"total"in s&&"id"in s||nt(e=Object.values(ue)).call(e,s._type)?(s._uid=t.uid,this._external_signal.onMessage(s)):this.emit(Et.ON_DATA_STREAM,t)}catch{this.emit(Et.ON_DATA_STREAM,t)}}handleNotification(t){m.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Js(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ot.UID_BANNED),void this.close()):void this.reconnect(e.action,Ge.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=O("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(m.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>O("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Ge.TIMEOUT):this.request(at.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-e;this.rttRolling.add(i),O("REPORT_STATS")&&this.send(at.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWebsocketEvents(){this.websocket.on(pt.RECONNECT_WAITTING_FINISH,t=>{this.emit($.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(pt.RECONNECT_CREATE_CONNECTION,t=>{this.emit($.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(pt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(pt.CLOSED,()=>{this.connectionState=yt.CLOSED}),this.websocket.on(pt.FAILED,()=>{this._disconnectedReason=Ot.NETWORK_ERROR,this.connectionState=yt.CLOSED}),this.websocket.on(pt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===yt.CONNECTED?this.connectionState=yt.RECONNECTING:this.connectionState=yt.CONNECTING}),this.websocket.on(pt.WILL_RECONNECT,(t,e,i)=>{t!=="retry"?(m.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit($.NEED_RENEW_SESSION)):m.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(t)}),this.websocket.on(pt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit($.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof G&&t.code===v.UNEXPECTED_RESPONSE&&t.data.code===ct.ERR_NO_AUTHORIZED)return m.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Ge.SERVER_ERROR);m.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ge.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(pt.REQUEST_NEW_URLS,(t,e)=>{Se(this,$.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Et.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function gC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Pi(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?gC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):gC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}const kp=new Map;class yM extends se{get state(){return this._state}set state(t){if(t===this._state)return;const e=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(de.CONNECTION_STATE_CHANGE,t,e,this._disconnectedReason):this.emit(de.CONNECTION_STATE_CHANGE,t,e)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){m.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,e){super(),h(this,"store",void 0),h(this,"joinInfo",void 0),h(this,"key",void 0),h(this,"ntpOffset",0),h(this,"signal",void 0),h(this,"role",void 0),h(this,"inChannelInfo",{joinAt:null,duration:0}),h(this,"spec",void 0),h(this,"_state","DISCONNECTED"),h(this,"_statsCollector",void 0),h(this,"_disconnectedReason",void 0),h(this,"isSignalRecover",!1),h(this,"hasChangeBGPAddress",!1),h(this,"trafficStatsInterval",void 0),h(this,"networkQualityInterval",void 0),h(this,"_joinGatewayStartTime",0),h(this,"_signalTimeout",!1),h(this,"_clientRoleOptions",void 0),h(this,"_isProactiveJoin",!1),this.store=t,this.spec=e,this.signal=this.store.useP2P?new fC(Pi(Pi({},e),{},{retryConfig:e.websocketRetryConfig}),t):this.store.useDataChannel?new br(Pi(Pi({},e),{},{retryConfig:e.websocketRetryConfig}),t):new aC(Pi(Pi({},e),{},{retryConfig:e.websocketRetryConfig}),t),this._statsCollector=e.statsCollector,this.role=e.role||"audience",this._clientRoleOptions=e.clientRoleOptions,this.handleSignalEvents()}async join(t,e,i){if(this.signal instanceof br){let c=!1;t.cloudProxyServer!=="disabled"?(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),c=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):t.apResponse.addresses.some(d=>d.fingerprint)||O("FINGERPRINT")||(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let s=kp.get(t.cname);if(s||(s=new Map,kp.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const c=new k(v.UID_CONFLICT);throw st.joinGateway(t.sid,{lts:r,succ:!1,ec:c.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof br?"1":"0"}),this._isProactiveJoin=!1,c}s.set(t.uid,!0),this.joinInfo=t,this.key=e;let o=0;this.joinGatewayStartTime=r;const a=t.proxyServer;try{let c;if(m.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof br?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof br)c=await this.signal.init(t.apResponse.addresses,i);else{const d=t.gatewayAddrs.map(u=>{let{address:l}=u;const[p,_]=l.split(":"),R={host:p,port:_};return t.proxyServer&&(R.proxy=t.proxyServer),R});c=await this.signal.init(d,i)}o=c.uid,m.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof br?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(c){throw c&&c.code===v.INIT_WEBSOCKET_TIMEOUT?(m.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===v.INIT_DATACHANNEL_TIMEOUT?(m.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(m.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),st.joinGateway(t.sid,{lts:r,succ:!1,ec:c.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof br?"1":"0"}),this._isProactiveJoin=!1,s.delete(t.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),m.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{m.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(de.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(de.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(de.NETWORK_QUALITY,{uplinkNetworkQuality:_C(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:_C(this._statsCollector.trafficStats.B_dnq)}):this.emit(de.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){e!==Ot.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==yt.CONNECTED||await function(i,r){return r===1/0?i:F.race([i,Qk(r)])}(this.signal.request(at.LEAVE,void 0,!0),3e3)}catch(i){m.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(e),e!==Ot.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:e,mode:this.spec.mode,extend:O("PUB_EXTEND"),twcc:!!O("PUBLISH_TWCC"),rtx:!!O("USE_PUB_RTX")};try{return(await this.signal.request(at.PUBLISH,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===ct.ERR_PUBLISH_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(t,e),this.publish(t,e,!1);throw s}}async publishDataChannel(t,e,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:e.streamId,ordered:e.ordered?1:0,max_retrans_times:(r=e.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:e.channelId,metadata:e.metadata};try{await this.signal.request(at.PUBLISH_DATASTREAM,s,!0)}catch(o){if(i&&o.data&&o.data.code===ct.ERR_PUBLISH_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(t,e),this.publishDataChannel(t,e,!1);throw o}}async unpublish(t,e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(at.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(i){m.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await F.all(t.map(e=>this.signal.request(at.UNPUBLISH_DATASTREAM,{channel_id:e},!0)))}catch(e){m.warning("unpublish datachannels warning: ",e)}}async presubscribe(t,e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:e,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!O("SUBSCRIBE_TWCC"),rtx:!!O("USE_SUB_RTX")||void 0,extend:O("SUB_EXTEND"),svc:Array.isArray(O("SVC"))&&O("SVC").length!==0?O("SVC"):void 0};try{return await this.signal.request(at.PRE_SUBSCRIBE,r,!0)}catch(s){if(i&&s.data&&s.data.code===ct.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(t,e,!1);throw s}}async subscribe(t,e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:e.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!O("SUBSCRIBE_TWCC"),rtx:!!O("USE_SUB_RTX"),extend:O("SUB_EXTEND"),ssrcId:e.ssrcId,svc:Array.isArray(O("SVC"))&&O("SVC").length!==0?O("SVC"):void 0};try{return(await this.signal.request(at.SUBSCRIBE,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===ct.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(t,e),await this.subscribe(t,e,!1);throw s}}async subscribeDataChannel(t,e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:t,stream_id:e.id,channel_id:e.datachannelId};try{return void await this.signal.request(at.SUBSCRIBE_DATASTREAM,r,!0)}catch(s){if(i&&s.data&&s.data.code===ct.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(t,e),await this.subscribeDataChannel(t,e,!1);throw s}}async subscribeAll(t,e){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!O("USE_SUB_RTX")};try{return await this.signal.request(at.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(e&&r.data&&r.data.code===ct.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw r}}async setVideoProfile(t){const e=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,s=i.width,o=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(a=!1)),a?{stream_type:0,width:s,height:o,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(t);if(e)return this.signal.request(at.SET_VIDEO_PROFILE,e);m.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,e){try{await this.signal.request(at.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:e},!0)}catch(i){m.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(t,e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await F.all(t.map(i=>this.signal.request(at.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:e},!0)))}catch(i){m.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(t){try{await this.signal.request(at.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){m.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(t){const{iceParameters:e,dtlsParameters:i,rtpCapabilities:r}=t;return{gatewayEstablishParams:await this.signal.request(at.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(at.GATEWAY_INFO)}async renewToken(t){await this.signal.request(at.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,e){if(e&&(this._clientRoleOptions=Object.assign({},e)),this.state!=="CONNECTED")return void(this.role=t);let i,r=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,await this.signal.request(at.SET_CLIENT_ROLE,{role:t,level:r,delay:i,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,e){await this.signal.request(at.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:e})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(at.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,e){await this.signal.request(at.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:e})}async pickSVCLayer(t,e){await this.signal.request(at.PICK_SVC_LAYER,{stream_id:t,spatial_layer:e.spatialLayer,temporal_layer:e.temporalLayer})}async setRTM2Flag(t){await this.signal.request(at.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,e,i){if(this.signal instanceof fC)return this.signal.sendExtensionMessage(t,e,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Pi({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(at.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=kp.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(e){let i;return i=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:yn.username,password:yn.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Pi(Pi({},yn),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(at.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(e=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===e.peer_uid);i&&i.B_st!==e.B_st&&Ld(()=>{this.emit(de.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new k(v.UNEXPECTED_ERROR,"can not generate join message, no join info");const e=Object.assign({},this.joinInfo.apResponse);let i=O("REPORT_APP_SCENARIO");if(typeof i!="string")try{i=JSON.stringify(i)}catch{i=void 0}i&&i.length>128&&(i=void 0);const r=Pi({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:fi,browser:navigator.userAgent,process_id:O("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:e,extend:O("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:O("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:O("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof O("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?O("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof O("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?O("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof O("ENABLE_USER_LICENSE_CHECK")=="boolean"?O("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:O("USE_PUB_RTX")===!0||O("USE_SUB_RTX")===!0||void 0,disableFEC:O("DISABLE_FEC"),enableNTPReport:!!O("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!O("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof O("ENABLE_DATASTREAM_2")=="boolean"?O("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!O("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof O("USE_XR")=="boolean"?O("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(r.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(r.aes_mode=this.joinInfo.aesmode,O("ENCRYPT_AES")?(r.aes_secret=this.joinInfo.aespassword,r.aes_encrypt=!0):r.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(r.aes_salt=this.joinInfo.aessalt)),e.addresses[this.signal.websocket.currentURLIndex]&&(r.ap_response.ticket=e.addresses[this.signal.websocket.currentURLIndex].ticket,delete e.addresses),this.joinInfo.defaultVideoStream!==void 0&&(r.default_video_stream=this.joinInfo.defaultVideoStream),r}getRejoinMessage(){if(!this.joinInfo)throw new k(v.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on($.WS_RECONNECT_WAITTING_FINISH,t=>{var e;nt(e=["tryNext","recover"]).call(e,t)&&this.joinInfo&&st.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on($.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on($.WS_RECONNECTING,t=>{this.joinInfo&&st.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||Ge.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",st.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on($.WS_CLOSED,t=>{let e;switch(t){case Ot.LEAVE:e=Ge.LEAVE;break;case Ot.UID_BANNED:case Ot.IP_BANNED:case Ot.CHANNEL_BANNED:case Ot.SERVER_ERROR:e=Ge.SERVER_ERROR;break;case Ot.FALLBACK:e=Ge.FALLBACK;break;case Ot.LICENSE_MISSING:case Ot.LICENSE_EXPIRED:case Ot.LICENSE_MINUTES_EXCEEDED:case Ot.LICENSE_PERIOD_INVALID:case Ot.LICENSE_MULTIPLE_SDK_SERVICE:case Ot.LICENSE_ILLEGAL:case Ot.TOKEN_EXPIRE:e=t;break;default:e=Ge.NETWORK_ERROR}m.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(e||"undefined -> "+Ge.NETWORK_ERROR)),this.joinInfo&&st.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Ot.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e}),this._disconnectedReason=t,t!==Ot.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on($.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(m.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),st.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof br?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void m.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));Ht("EVENT_REPORT_DOMAIN",t[1]),Ht("EVENT_REPORT_BACKUP_DOMAIN",t[1]),Ht("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}),this.signal.on(Et.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on($.REQUEST_RECOVER,(t,e,i)=>{if(!this.joinInfo)return i(new k(v.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Se(this,de.REQUEST_NEW_GATEWAY_LIST).then(e).catch(i)}),this.signal.on($.REQUEST_JOIN_INFO,async t=>{var e;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:r,rtpCapabilities:s}=await Se(this,de.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(e=this.joinInfo)===null||e===void 0?void 0:e.turnServer});t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:s,version:"2"}}))}),this.signal.on($.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on($.REPORT_JOIN_GATEWAY,(t,e)=>{this.joinInfo&&(st.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:e,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof br?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on($.IS_P2P_DISCONNECTED,t=>{t(js(this,de.IS_P2P_DISCONNECTED))}),this.signal.on($.DISCONNECT_P2P,()=>{this.emit(de.DISCONNECT_P2P)}),this.signal.on($.NEED_RENEW_SESSION,()=>{this.emit(de.NEED_RENEW_SESSION)}),this.signal.on($.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on($.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on($.JOIN_RESPONSE,t=>{const e=this.getCurrentGatewayAddress();this.emit(de.JOIN_RESPONSE,t,e)}),this.signal.on($.DATACHANNEL_PRECONNECT,async(t,e,i)=>{this.updateTurnConfigFromSignal();const r=this.getCurrentGatewayAddress();return Se(this,de.DATACHANNEL_PRECONNECT,t,r).then(e).catch(i)}),this.signal.on($.DATACHANNEL_CONNECTING,async t=>{const{iceParameters:e,dtlsParameters:i,rtpCapabilities:r}=await Se(this,de.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:r,version:"2"}}))}),this.signal.on($.DATACHANNEL_FAILBACK,()=>{m.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(de.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,e){try{await this.signal.request(at.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[e]},!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(t,e){try{await this.signal.request(at.UNSUBSCRIBE,{stream_id:e.id},!0)}catch(i){throw m.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(t,e){try{await this.signal.request(at.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(t,e){try{await this.signal.request(at.UNPUBLISH_DATASTREAM,{channnel_id:e.channelId},!0)}catch(i){throw m.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(t){const e={users:t.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request(at.UNSUBSCRIBE_STREAMS,e,!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(t,e){const i={action:t.find(r=>r.stream_type===Ut.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(at.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(t,e){const i={action:t.find(r=>r.stream_type===Ut.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(at.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(t,e){const i={action:t===rt.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(at.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(t,e){const i={action:t===rt.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(at.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,e){this.signal.upload(t,e)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const e={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(at.RESTART_ICE,e,!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Ge.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!O("GATEWAY_WSS_ADDRESS"))return(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(at.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ot.FALLBACK)),this.store.useDataChannel=!1,this.signal=new aC(Pi(Pi({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(de.RESET_SIGNAL,zd.websocket)}}let tu=0,Mp=0;function wr(n,t,e,i){return new F((r,s)=>{t.timeout=t.timeout||O("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!e?(t.data=JSON.stringify(t.data),tu+=or(t.data)):e&&(t.data.size?tu+=t.data.size:t.data instanceof FormData?tu+=US(t.data):tu+=or(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=n,Pn.request(t).then(o=>{typeof o.data=="string"?Mp+=or(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?Mp+=o.data.byteLength:Mp+=or(JSON.stringify(o.data)),i&&r({data:o.data,headers:o.headers}),r(o.data)}).catch(o=>{Pn.isCancel(o)?s(new k(v.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new k(v.NETWORK_TIMEOUT,o.message)):o.response?s(new k(v.NETWORK_RESPONSE_ERROR,o.response.status)):s(new k(v.NETWORK_ERROR,o.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var n;function t(K){var X=0;return function(){return X<K.length?{done:!1,value:K[X++]}:{done:!0}}}var e=typeof Object.defineProperties=="function"?Object.defineProperty:function(K,X,et){return K==Array.prototype||K==Object.prototype||(K[X]=et.value),K},i,r=function(K){K=[typeof globalThis=="object"&&globalThis,K,typeof window=="object"&&window,typeof self=="object"&&self,typeof g=="object"&&g];for(var X=0;X<K.length;++X){var et=K[X];if(et&&et.Math==Math)return et}throw Error("Cannot find global object")}(this);function s(K,X){if(X)t:{var et=r;K=K.split(".");for(var ft=0;ft<K.length-1;ft++){var kt=K[ft];if(!(kt in et))break t;et=et[kt]}(X=X(ft=et[K=K[K.length-1]]))!=ft&&X!=null&&e(et,K,{configurable:!0,writable:!0,value:X})}}function o(K){return(K={next:K})[Symbol.iterator]=function(){return this},K}function a(K){var X=typeof Symbol<"u"&&Symbol.iterator&&K[Symbol.iterator];return X?X.call(K):{next:t(K)}}if(s("Symbol",function(K){function X(kt,Q){this.A=kt,e(this,"description",{configurable:!0,writable:!0,value:Q})}if(K)return K;X.prototype.toString=function(){return this.A};var et="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",ft=0;return function kt(Q){if(this instanceof kt)throw new TypeError("Symbol is not a constructor");return new X(et+(Q||"")+"_"+ft++,Q)}}),s("Symbol.iterator",function(K){if(K)return K;K=Symbol("Symbol.iterator");for(var X="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),et=0;et<X.length;et++){var ft=r[X[et]];typeof ft=="function"&&typeof ft.prototype[K]!="function"&&e(ft.prototype,K,{configurable:!0,writable:!0,value:function(){return o(t(this))}})}return K}),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}i=c?function(K,X){if(K.__proto__=X,K.__proto__!==X)throw new TypeError(K+" is not extensible");return K}:null}var u=i;function l(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(K){if(K.m)throw new TypeError("Generator is already running");K.m=!0}function _(K,X){return K.h=3,{value:X}}function R(K){this.g=new l,this.G=K}function f(K,X,et,ft){try{var kt=X.call(K.g.j,et);if(!(kt instanceof Object))throw new TypeError("Iterator result "+kt+" is not an object");if(!kt.done)return K.g.m=!1,kt;var Q=kt.value}catch(E){return K.g.j=null,K.g.s(E),T(K)}return K.g.j=null,ft.call(K.g,Q),T(K)}function T(K){for(;K.g.h;)try{var X=K.G(K.g);if(X)return K.g.m=!1,{value:X.value,done:!1}}catch(et){K.g.v=void 0,K.g.s(et)}if(K.g.m=!1,K.g.l){if(X=K.g.l,K.g.l=null,X.F)throw X.D;return{value:X.return,done:!0}}return{value:void 0,done:!0}}function A(K){this.next=function(X){return K.o(X)},this.throw=function(X){return K.s(X)},this.return=function(X){return function(et,ft){p(et.g);var kt=et.g.j;return kt?f(et,"return"in kt?kt.return:function(Q){return{value:Q,done:!0}},ft,et.g.return):(et.g.return(ft),T(et))}(K,X)},this[Symbol.iterator]=function(){return this}}function N(K,X){return X=new A(new R(X)),u&&K.prototype&&u(X,K.prototype),X}if(l.prototype.o=function(K){this.v=K},l.prototype.s=function(K){this.l={D:K,F:!0},this.h=this.C||this.u},l.prototype.return=function(K){this.l={return:K},this.h=this.u},R.prototype.o=function(K){return p(this.g),this.g.j?f(this,this.g.j.next,K,this.g.o):(this.g.o(K),T(this))},R.prototype.s=function(K){return p(this.g),this.g.j?f(this,this.g.j.throw,K,this.g.o):(this.g.s(K),T(this))},s("Array.prototype.entries",function(K){return K||function(){return function(X,et){X instanceof String&&(X+="");var ft=0,kt=!1,Q={next:function(){if(!kt&&ft<X.length){var E=ft++;return{value:et(E,X[E]),done:!1}}return kt=!0,{done:!0,value:void 0}}};return Q[Symbol.iterator]=function(){return Q},Q}(this,function(X,et){return[X,et]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var P=function(K,X){for(var et=0;et<K.length;et++)X(K[et])},j=function(K){return K.replace(/\r?\n|\r/g,`\r
`)},M=function(K,X,et){return X instanceof Blob?(et=et!==void 0?et+"":typeof X.name=="string"?X.name:"blob",X.name===et&&Object.prototype.toString.call(X)!=="[object Blob]"||(X=new File([X],et)),[String(K),X]):[String(K),String(X)]},U=function(K,X){if(K.length<X)throw new TypeError(X+" argument required, but only "+K.length+" present.")},B=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,V=B.FormData,q=B.XMLHttpRequest&&B.XMLHttpRequest.prototype.send,z=B.Request&&B.fetch,mt=B.navigator&&B.navigator.sendBeacon,Rt=B.Element&&B.Element.prototype,te=B.Symbol&&Symbol.toStringTag;te&&(Blob.prototype[te]||(Blob.prototype[te]="Blob"),"File"in B&&!File.prototype[te]&&(File.prototype[te]="File"));try{new File([],"")}catch{B.File=function(X,et,ft){return X=new Blob(X,ft||{}),Object.defineProperties(X,{name:{value:et},lastModified:{value:+(ft&&ft.lastModified!==void 0?new Date(ft.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),te&&Object.defineProperty(X,te,{value:"File"}),X}}var we=function(K){return K.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},ie=function(K){this.i=[];var X=this;K&&P(K.elements,function(et){if(et.name&&!et.disabled&&et.type!=="submit"&&et.type!=="button"&&!et.matches("form fieldset[disabled] *"))if(et.type==="file"){var ft=et.files&&et.files.length?et.files:[new File([],"",{type:"application/octet-stream"})];P(ft,function(kt){X.append(et.name,kt)})}else et.type==="select-multiple"||et.type==="select-one"?P(et.options,function(kt){!kt.disabled&&kt.selected&&X.append(et.name,kt.value)}):et.type==="checkbox"||et.type==="radio"?et.checked&&X.append(et.name,et.value):(ft=et.type==="textarea"?j(et.value):et.value,X.append(et.name,ft))})};if((n=ie.prototype).append=function(K,X,et){U(arguments,2),this.i.push(M(K,X,et))},n.delete=function(K){U(arguments,1);var X=[];K=String(K),P(this.i,function(et){et[0]!==K&&X.push(et)}),this.i=X},n.entries=function K(){var X,et=this;return N(K,function(ft){if(ft.h==1&&(X=0),ft.h!=3)return X<et.i.length?ft=_(ft,et.i[X]):(ft.h=0,ft=void 0),ft;X++,ft.h=2})},n.forEach=function(K,X){U(arguments,1);for(var et=a(this),ft=et.next();!ft.done;ft=et.next()){var kt=a(ft.value);ft=kt.next().value,kt=kt.next().value,K.call(X,kt,ft,this)}},n.get=function(K){U(arguments,1);var X=this.i;K=String(K);for(var et=0;et<X.length;et++)if(X[et][0]===K)return X[et][1];return null},n.getAll=function(K){U(arguments,1);var X=[];return K=String(K),P(this.i,function(et){et[0]===K&&X.push(et[1])}),X},n.has=function(K){U(arguments,1),K=String(K);for(var X=0;X<this.i.length;X++)if(this.i[X][0]===K)return!0;return!1},n.keys=function K(){var X,et,ft,kt,Q=this;return N(K,function(E){if(E.h==1&&(X=a(Q),et=X.next()),E.h!=3)return et.done?void(E.h=0):(ft=et.value,kt=a(ft),_(E,kt.next().value));et=X.next(),E.h=2})},n.set=function(K,X,et){U(arguments,2),K=String(K);var ft=[],kt=M(K,X,et),Q=!0;P(this.i,function(E){E[0]===K?Q&&(Q=!ft.push(kt)):ft.push(E)}),Q&&ft.push(kt),this.i=ft},n.values=function K(){var X,et,ft,kt,Q=this;return N(K,function(E){if(E.h==1&&(X=a(Q),et=X.next()),E.h!=3)return et.done?void(E.h=0):(ft=et.value,(kt=a(ft)).next(),_(E,kt.next().value));et=X.next(),E.h=2})},ie.prototype._asNative=function(){for(var K=new V,X=a(this),et=X.next();!et.done;et=X.next()){var ft=a(et.value);et=ft.next().value,ft=ft.next().value,K.append(et,ft)}return K},ie.prototype._blob=function(){var K="----formdata-polyfill-"+Math.random(),X=[],et="--"+K+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(ft,kt){return typeof ft=="string"?X.push(et+we(j(kt))+`"\r
\r
`+j(ft)+`\r
`):X.push(et+we(j(kt))+'"; filename="'+we(ft.name)+`"\r
Content-Type: `+(ft.type||"application/octet-stream")+`\r
\r
`,ft,`\r
`)}),X.push("--"+K+"--"),new Blob(X,{type:"multipart/form-data; boundary="+K})},ie.prototype[Symbol.iterator]=function(){return this.entries()},ie.prototype.toString=function(){return"[object FormData]"},Rt&&!Rt.matches&&(Rt.matches=Rt.matchesSelector||Rt.mozMatchesSelector||Rt.msMatchesSelector||Rt.oMatchesSelector||Rt.webkitMatchesSelector||function(K){for(var X=(K=(this.document||this.ownerDocument).querySelectorAll(K)).length;0<=--X&&K.item(X)!==this;);return-1<X}),te&&(ie.prototype[te]="FormData"),q){var qn=B.XMLHttpRequest.prototype.setRequestHeader;B.XMLHttpRequest.prototype.setRequestHeader=function(K,X){qn.call(this,K,X),K.toLowerCase()==="content-type"&&(this.B=!0)},B.XMLHttpRequest.prototype.send=function(K){K instanceof ie?(K=K._blob(),this.B||this.setRequestHeader("Content-Type",K.type),q.call(this,K)):q.call(this,K)}}z&&(B.fetch=function(K,X){return X&&X.body&&X.body instanceof ie&&(X.body=X.body._blob()),z.call(this,K,X)}),mt&&(B.navigator.sendBeacon=function(K,X){return X instanceof ie&&(X=X._asNative()),mt.call(this,K,X)}),B.FormData=ie}})();const eu=()=>{const n=O("AREAS");return n.length===0&&n.push(Pt.GLOBAL),Hs(n).call(n,(t,e,i)=>{const r=TC(e);return r?i===0?r:"".concat(t,",").concat(r):t},"")},TC=n=>n===Pt.OVERSEA?"".concat(Ze.ASIA,",").concat(Ze.EUROPE,",").concat(Ze.AFRICA,",").concat(Ze.NORTH_AMERICA,",").concat(Ze.SOUTH_AMERICA,",").concat(Ze.OCEANIA):Ze[n],IM=n=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return n.map(e=>{const i=Xd[e],r=Object.keys(i);r&&r.map(s=>{s!=="CODE"&&(t[s]=t[s].concat(i[s]))})}),t},nu={GLOBAL:{ASIA:[Pt.CHINA,Pt.JAPAN,Pt.INDIA,Pt.KOREA,Pt.HKMC],EUROPE:[],NORTH_AMERICA:[Pt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},iu=Object.keys(nu[Pt.GLOBAL]),Up=[Pt.CHINA,Pt.NORTH_AMERICA,Pt.EUROPE,Pt.ASIA,Pt.JAPAN,Pt.INDIA,Pt.OCEANIA,Pt.SOUTH_AMERICA,Pt.AFRICA,Pt.KOREA,Pt.HKMC,Pt.US],AM=function(n,t){let e=[];if(nt(n).call(n,Pt.GLOBAL)){const s=[Pt.GLOBAL,Pt.OVERSEA],o=Object.keys(Xd);if(t===Pt.GLOBAL)throw new k(v.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Pt.CHINA)e=[Pt.OVERSEA];else if(r=t,nt(iu).call(iu,r)){const a=(i=t,nu[Pt.GLOBAL][i]||[]),c=[...s,t,...a];e=o.filter(d=>!nt(c).call(c,d))}else if(function(a){let c=!1;return iu.forEach(d=>{var u;nt(u=nu[Pt.GLOBAL][d]).call(u,a)&&(c=!0)}),c}(t)){const a=function(d){let u;return iu.forEach(l=>{var p;nt(p=nu[Pt.GLOBAL][l]).call(p,d)&&(u=l)}),u}(t),c=[...s,a,t];e=o.filter(d=>!nt(c).call(c,d))}else e=n;e=function(a){const c=[];return Up.forEach(d=>{nt(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!nt(Up).call(Up,d)))}(e)}else e=n;var i,r;return e};function SC(n){var t,e;if(!n&&nt(t=O("AREAS")).call(t,Pt.EXTENSIONS))return m.debug("update area from ap : reset"),void xp(Y1,!0);if(!nt(e=O("AREAS")).call(e,Pt.GLOBAL)||!n)return;let i=Xd.EXTENSIONS;i&&(i={CODE:TC(Pt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(n,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(n,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(n,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(n,".agora.io"),"cds-ap-web-2-".concat(n,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(n,".agora.io"),"sua-ap-web-2-".concat(n,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(n,".agora.io"),"uap-ap-web-2-".concat(n,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(n,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(n,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(n,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(n,".agora.io")]},m.debug("update area from ap success: ".concat(n,",config is "),i),Ht("AREAS",[Pt.EXTENSIONS],!0),Object.keys(i).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?Ht(r,i[r][0]):Ht(r,i[r])}))}function xp(n){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const e=st.reportApiInvoke(null,{name:Ae.SET_AREA,options:n,tag:ce.TRACER});try{let i=[];if(typeof n=="string"&&(i=[n]),Array.isArray(n)&&(n.forEach(s=>{if(!nt(XR).call(XR,s))throw new k(v.INVALID_PARAMS,"invalid area code")}),i=n),Object.prototype.toString.call(n)==="[object Object]"){const{areaCode:s,excludedArea:o}=n;if(!s)throw new k(v.INVALID_PARAMS,"area code is needed");let a=s;typeof s=="string"&&(a=[s]),i=o?AM(a,o):a}if(!t){if(Qr.AREAS){const s=new k(v.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return e.onError(s),void m.warning("setArea is prohibited because of config-distribute")}if(nt(i).call(i,Pt.GLOBAL)&&O("AREAS")===Pt.EXTENSIONS){const s=new k(v.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return e.onError(s),void m.warning("setArea is prohibited because of ap extensions")}}Ht("AREAS",i,t);const r=IM(i);Object.keys(r).map(s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?Ht(s,r[s][0]):Ht(s,r[s])}),m.debug("set area success:",i.join(","))}catch(i){throw e.onError(i),i}e.onSuccess()}function RC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Vp(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?RC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):RC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}let Fp=1;function bM(n,t,e,i,r){Fp+=1;const s={sid:e.sid,command:"convergeAllocateEdge",uid:"666",appId:e.appId,ts:Math.floor(Date.now()/1e3),seq:Fp,requestId:Fp,version:fi,cname:e.cname},o={service_name:t,json_body:JSON.stringify(s)};let a,c,d=n[0];return Ki(async()=>{a=Date.now();const u=await wr(d,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,u.code!==0){const _=new k(v.UNEXPECTED_RESPONSE,"live streaming ap error, code"+u.code,{retry:!0,responseTime:c});throw m.error(_.toString()),_}const l=JSON.parse(u.json_body);if(l.code!==200){const _=new k(v.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(l.code,", reason: ").concat(l.reason),{code:l.code,responseTime:c});throw m.error(_.toString()),_}if(!l.servers||l.servers.length===0){const _=new k(v.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:l.code,responseTime:c});throw m.error(_.toString()),_}const p=function(_,R){return{addressList:_.servers.map(f=>"wss://".concat(f.address.replace(/\./g,"-"),".").concat(O("WORKER_DOMAIN"),":").concat(f.wss,"?serviceName=").concat(encodeURIComponent(R))),workerToken:_.workerToken,vid:_.vid}}(l,t);return O("LIVE_STREAMING_ADDRESS")&&(p.addressList=O("LIVE_STREAMING_ADDRESS")instanceof Array?O("LIVE_STREAMING_ADDRESS"):[O("LIVE_STREAMING_ADDRESS")]),Vp(Vp({},p),{},{responseTime:c})},(u,l)=>(st.apworkerEvent(e.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(u.addressList),firstSuccess:l===0,responseTime:c,serverIp:n[l%n.length]}),!1),(u,l)=>(st.apworkerEvent(e.sid,{success:!1,sc:u.data&&u.data.code||200,serviceName:t,responseTime:c,serverIp:n[l%n.length]}),!!(u.code!==v.OPERATION_ABORTED&&u.code!==v.UNEXPECTED_RESPONSE||u.data&&u.data.retry)&&(d=n[(l+1)%n.length],!0)),r)}let Bp=1;function CC(n,t,e,i){let{url:r,areaCode:s}=n;const o=Date.now();let a;const[c,d]=AC(t,s,[Ke.CHOOSE_SERVER]);let u=Re.networkState;return Ki(async()=>{u&&Re.networkState===Tn.OFFLINE&&Re.onlineWaiter&&await F.race([Re.onlineWaiter,We(i&&i.maxRetryTimeout||Ce.maxRetryTimeout)]),u=Re.networkState;const{data:l,headers:p}=await wr(r,{data:c,cancelToken:e,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a=p.http3==="1"?1:-1,st.reportResourceTiming(r,t.sid),yC(l,r,t,o,[Ke.CHOOSE_SERVER],a);const _=Pp(l,Ke.CHOOSE_SERVER);return IC(_),hC(_,r)},l=>(l&&st.joinChooseServer(t.sid,{lts:o,succ:!0,csAddr:r,opid:d,serverList:l.gatewayAddrs.map(p=>p.address),ec:null,cid:l.cid.toString(),uid:l.uid.toString(),csIp:l.csIp,unilbsServerIds:[Ke.CHOOSE_SERVER].toString(),isHttp3:a}),!1),l=>l.code!==v.OPERATION_ABORTED&&(l.code===v.CAN_NOT_GET_GATEWAY_SERVER?l.data.retry:(st.joinChooseServer(t.sid,{lts:o,succ:!1,csAddr:r,serverList:null,opid:d,ec:l.code,csIp:l.data&&l.data.csIp,unilbsServerIds:[Ke.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:u}),isHttp3:a}),m.warning("[".concat(t.clientId,"] Choose server network error, retry"),l),!0)),i)}function vC(n,t,e,i){let r,{url:s,areaCode:o,serviceIds:a}=n;const c=Date.now(),[d,u]=AC(t,o,a);let l;return Ki(async()=>{l&&Re.networkState===Tn.OFFLINE&&Re.onlineWaiter&&await F.race([Re.onlineWaiter,We(i&&i.maxRetryTimeout||Ce.maxRetryTimeout)]),l=Re.networkState;const{data:p,headers:_}=await wr(s,{data:d,cancelToken:e,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=_.http3==="1"?1:-1,st.reportResourceTiming(s,t.sid),yC(p,s,t,c,a,r);const R=Pp(p,Ke.CHOOSE_SERVER),f=Pp(p,t.cloudProxyServer==="proxy5"?Ke.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Ke.CLOUD_PROXY:Ke.CLOUD_PROXY_FALLBACK);return IC(R),{gatewayInfo:hC(R,s),proxyInfo:f,url:s}},p=>(p.gatewayInfo&&st.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:s,serverList:p.gatewayInfo.gatewayAddrs.map(_=>_.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),p.proxyInfo&&st.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:p.proxyInfo.addresses.map(_=>_.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==v.OPERATION_ABORTED&&(p.code===v.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(st.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:p.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:l})}),m.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),p),!0)),i)}const yC=(n,t,e,i,r,s)=>{const o=[],a=c=>{c.flag===4096?st.joinChooseServer(e.sid,{lts:i,succ:!1,csAddr:t,opid:n.opid,serverList:null,ec:c.error.message,csIp:c.error.data&&c.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s}):c.flag!==1048576&&c.flag!==4194304&&c.flag!==4194310||st.joinWebProxyAP(e.sid,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:c.error.code,eventType:e.cloudProxyServer,unilbsServerIds:r.toString()})};if(n.response_body.forEach(c=>{const d=c.buffer.code;if(c.uri===23&&d===0&&!c.buffer.edges_services)if(c.buffer.flag===4194310)m.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),c.buffer.edges_services=[];else{const u={error:new k(v.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:n.detail[502]}),flag:c.buffer.flag};o.push(u),a(u)}if(d!==0){const u=Zd(d),l={error:new k(v.CAN_NOT_GET_GATEWAY_SERVER,u.desc,{desc:u.desc,retry:u.retry,csIp:n.detail[502]}),flag:c.buffer.flag};c.buffer.flag===4194310?m.warning(l.error.toString()):o.push(l),a(l)}}),o.length)throw m.warning("[".concat(e.clientId,"] multi unilbs ").concat(t," failed, ").concat(o.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message,", retry: ").concat(c.error.data.retry)).join(" | "))),new k(v.CAN_NOT_GET_GATEWAY_SERVER,o.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message)).join(" | "),{retry:!!o.find(c=>c.error.data.retry),csIp:n.detail[502],desc:[...new Set(o.map(c=>{var d;return c==null||(d=c.error)===null||d===void 0||(d=d.data)===null||d===void 0?void 0:d.desc}).filter(c=>!!c))]})},IC=n=>{var t,e,i,r;if(n.addresses&&n.addresses.length===0&&n.code===0)throw new k(v.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:n.detail&&n.detail[502]});if(O("AP_AREA")&&((i=n.detail)!==null&&i!==void 0&&i[23]&&typeof((r=n.detail)===null||r===void 0?void 0:r[23])=="string"?SC(n.detail[23].toLowerCase()):SC()),(t=n.detail)!==null&&t!==void 0&&t[19]&&typeof((e=n.detail)===null||e===void 0?void 0:e[19])=="string"){const o=n.detail[19],a=o==null?void 0:o.split(";");for(let c=0;c<a.length;c++){var s;const d=Dp(s=a[c]).call(s);n.addresses[c]&&a&&(n.addresses[c].fingerprint=d)}}if(O("GATEWAY_ADDRESS")&&O("GATEWAY_ADDRESS").length>0){m.debug("assign gateway address to",O("GATEWAY_ADDRESS"));const o=O("GATEWAY_ADDRESS").map(a=>{var c,d;const u=(c=(d=n.addresses.find(l=>l.ip===a.ip&&l.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:n.addresses[0]&&n.addresses[0].ticket,fingerprint:u}});n.addresses=o}},wM=(n,t)=>{if(n.response_body&&n.response_body.length){const e=n.response_body[0];if(e.buffer.code!==0){const i=Zd(e.buffer.code);throw new k(v.UPDATE_TICKET_FAILED,"[".concat(e.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return e.buffer.ticket}throw m.debug("update ticket request received ap response without response body:",t),new k(v.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},AC=(n,t,e)=>{const i=Math.floor(Math.random()*1e12),r={appid:n.appId,client_ts:Date.now(),opid:i,sid:n.sid,request_bodies:[{uri:22,buffer:{cname:n.cname,detail:Vp({6:n.stringUid,11:t,12:O("USE_NEW_TOKEN")?"1":void 0,22:t},n.apRTM?{26:"RTM2"}:{}),key:n.token,service_ids:e,uid:n.uid||0}}]};r.request_bodies.forEach(o=>{n.multiIP&&n.multiIP.gateway_ip&&(o.buffer.detail[5]=JSON.stringify({vocs_ip:[n.multiIP.uni_lbs_ip],vos_ip:[n.multiIP.gateway_ip]}))});const s=new FormData;return s.append("request",JSON.stringify(r)),[s,i]},OM=(n,t)=>{const e=Math.floor(Math.random()*1e12),i={appid:n.appId,client_ts:Date.now(),opid:e,sid:n.sid,request_bodies:[{uri:28,buffer:{cname:n.cname,detail:{1:"",6:n.stringUid,12:"1"},token:n.token,service_ids:t,uid:n.uid||0,edges_services:n.apResponse.addresses.map(s=>({ip:s.ip,port:s.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,e]};let qo=0;function Jo(n){return F.all(n.map(t=>t.then(e=>{throw e},e=>e))).then(t=>{throw t},t=>t)}const ec=async n=>{let{fragementLength:t,referenceList:e,asyncMapHandler:i,allFailedhandler:r,promisesCollector:s}=n,o=0;const a=t;let c,d=0;const u=async()=>{const l=(()=>{const p=o*a,_=p+a;return e.slice(p,_).map(i)})();s&&s.push(...l);try{c=await Jo(l)}catch(p){if(d+=a,o++,!(d>=e.length))return void await u();r(p)}l.forEach(p=>p.cancel())};return await u(),c};async function jp(n,t,e,i){return{gatewayInfo:await async function(s,o,a,c){let d=null;const u=[],l=async()=>{const _=O("WEBCS_DOMAIN").slice(0,O("AJAX_REQUEST_CONCURRENT")).map(T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:eu()})),R=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(T=>T.url)}),f=await ec({fragementLength:O("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:T=>(m.debug("[".concat(s.clientId,"] Connect to choose_server:"),T.url),CC(T,s,o,a)),allFailedhandler:T=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},R),T[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},R),f},p=async()=>{if(await We(1e3),d!==null)return d;const _=O("WEBCS_DOMAIN_BACKUP_LIST").map(T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:eu()})),R=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(T=>T.url)}),f=await ec({fragementLength:O("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:T=>(m.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),T.url),CC(T,s,o,a)),allFailedhandler:T=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},R),T[0]},promisesCollector:u});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},R),f};try{return d=await Jo([l(),p()]),u.length&&u.forEach(_=>_.cancel&&typeof _.cancel=="function"&&_.cancel()),d}catch(_){throw _[0]}}(n,t,e,i)}}async function bC(n,t,e,i,r){const s=n.cloudProxyServer;if(s==="disabled"){if(!i)return;if(n.useLocalAccessPoint)return await jp(n,t,e,r);if(O("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:p,proxyInfo:_}=await OC(n,t,e,r);if(n.turnServer&&n.turnServer.mode!=="auto")return{gatewayInfo:p};const R=_.map(f=>({turnServerURL:f.address,tcpport:f.tcpport||yn.tcpport,udpport:f.udpport||yn.udpport,username:f.username||yn.username,password:f.password||yn.password,forceturn:!1,security:!0}));if(r.useP2P){var o;const f=(o=n.uid)!==null&&o!==void 0?o:p.uid,T="glb:".concat(f.toString()),A=await qh(T),N=_.map(P=>({turnServerURL:P.address,tcpport:P.tcpport||yn.tcpport,udpport:P.udpport||yn.udpport,username:T,password:A,forceturn:!1,security:!0}));R.push(...N)}return n.turnServer={mode:"manual",servers:R},{gatewayInfo:p}}return await jp(n,t,e,r)}const{proxyInfo:a,gatewayInfo:c}=await OC(n,t,e,r),d={gatewayInfo:c},u=a.map(p=>({turnServerURL:p.address,tcpport:s==="proxy3"?void 0:p.tcpport?p.tcpport:yn.tcpport,udpport:s==="proxy4"?void 0:p.udpport?p.udpport:yn.udpport,username:p.username||yn.username,password:p.password||yn.password,forceturn:s!=="proxy4",security:s==="proxy5"}));if(r.useP2P){var l;const p=(l=n.uid)!==null&&l!==void 0?l:c.uid,_="glb:".concat(p.toString()),R=await qh(_),f=a.map(T=>({turnServerURL:T.address,tcpport:s==="proxy3"?void 0:T.tcpport||yn.tcpport,udpport:s==="proxy4"?void 0:T.udpport||yn.udpport,username:_,password:R,forceturn:s!=="proxy4",security:s==="proxy5"}));u.push(...f)}return n.turnServer={mode:"manual",servers:u},m.debug("[".concat(n.clientId,"] set proxy server: ").concat(n.proxyServer,", mode: ").concat(s)),d}async function wC(n,t,e,i,r){const s=O("ACCOUNT_REGISTER").slice(0,O("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?s.map(c=>"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1")):s.map(c=>"https://".concat(c,"/api/v1"));const a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await async function(d,u,l,p,_){const R=Date.now(),f={sid:l.sid,opid:10,appid:l.appId,string_uid:u};let T=d[0];const A=await Ki(()=>wr(T+"".concat(T.indexOf("?")===-1?"?":"&","action=stringuid"),{data:f,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(N,P)=>{if(N.code===0){if(N.uid<=0||N.uid>=Math.pow(2,32))throw m.error("Invalid Uint Uid ".concat(u," => ").concat(N.uid),N),st.reqUserAccount(f.sid,{lts:R,success:!1,serverAddr:T,stringUid:f.string_uid,uid:N.uid,errorCode:v.INVALID_UINT_UID_FROM_STRING_UID,extend:f}),new k(v.INVALID_UINT_UID_FROM_STRING_UID);return st.reqUserAccount(f.sid,{lts:R,success:!0,serverAddr:T,stringUid:f.string_uid,uid:N.uid,errorCode:null,extend:f}),!1}const j=Zd(N.code);return j.retry&&(T=d[(P+1)%d.length]),st.reqUserAccount(f.sid,{lts:R,success:!1,serverAddr:T,stringUid:f.string_uid,uid:N.uid,errorCode:j.desc,extend:f}),j.retry},(N,P)=>N.code!==v.OPERATION_ABORTED&&(st.reqUserAccount(f.sid,{lts:R,success:!1,serverAddr:T,stringUid:f.string_uid,uid:null,errorCode:N.code,extend:f}),T=d[(P+1)%d.length],!0),_);if(A.code!==0){const N=Zd(A.code);throw new k(v.UNEXPECTED_RESPONSE,N.desc)}return A}(o,n,t,e,i);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function NM(n,t,e){const i=O("CDS_AP").slice(0,O("AJAX_REQUEST_CONCURRENT")).map(a=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(a+"/api/v1"):"https://".concat(a,"/api/v1?action=config")).map(a=>function(c,d,u,l){const p=Lt(),_={flag:64,cipher_method:0,features:{device:p.name,system:p.os,system_general:navigator.userAgent,vendor:d.appId,version:fi,cname:d.cname,sid:d.sid,session_id:d.sid,detail:"",proxyServer:d.proxyServer}};return Ki(()=>wr(c,{data:_,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,R=>R.code!==v.OPERATION_ABORTED,l)}(a,n,t,e));let r=null,s=null,o={};try{r=await Jo(i)}catch(a){if(a.code===v.OPERATION_ABORTED)throw a;s=a}if(i.forEach(a=>a.cancel()),st.reportApiInvoke(n.sid,{name:Ae.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:r}}).onSuccess(),r&&r.test_tags)try{o=function(a){if(!a.test_tags)return{};const c=a.test_tags,d=Object.keys(c),u={};return d.forEach(l=>{var p;const _=Dp(p=l.slice(4)).call(p),R=JSON.parse(c[l])[1];u[_]=R}),u}(r)}catch{}return o}async function OC(n,t,e,i){const r=O("PROXY_SERVER_TYPE3"),s=(_,R,f)=>{let T=f||r;return Array.isArray(T)&&(T=R%2==0?r[1]:r[0]),"https://".concat(T,"/ap/?url=").concat(_)};let o=null;const a=[],c=async()=>{const _=O("WEBCS_DOMAIN").slice(0,O("AJAX_REQUEST_CONCURRENT")).map((T,A)=>{let N;return N=n.cloudProxyServer==="disabled"&&n.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),A,n.proxyServer):n.cloudProxyServer==="disabled"||n.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),A),{url:N,areaCode:eu(),serviceIds:[Ke.CHOOSE_SERVER,n.cloudProxyServer==="proxy5"?Ke.CLOUD_PROXY_5:n.cloudProxyServer==="proxy3"||n.cloudProxyServer==="proxy4"?Ke.CLOUD_PROXY:Ke.CLOUD_PROXY_FALLBACK]}}),R=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(T=>T.url)}),f=await ec({fragementLength:O("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:T=>(m.debug("[".concat(n.clientId,"] Connect to choose_server:"),T.url),vC(T,n,t,e)),allFailedhandler:T=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},R),T[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},R),f},d=async()=>{if(await We(1e3),o!==null)return o;const _=O("WEBCS_DOMAIN_BACKUP_LIST").map((T,A)=>{let N;return N=n.cloudProxyServer==="disabled"&&n.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),A,n.proxyServer):n.cloudProxyServer==="disabled"||n.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),A),{url:N,areaCode:eu(),serviceIds:[Ke.CHOOSE_SERVER,n.cloudProxyServer==="proxy5"?Ke.CLOUD_PROXY_5:n.cloudProxyServer==="proxy3"||n.cloudProxyServer==="proxy4"?Ke.CLOUD_PROXY:Ke.CLOUD_PROXY_FALLBACK]}}),R=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(T=>T.url)}),f=await ec({fragementLength:O("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:T=>(m.debug("[".concat(n.clientId,"] Connect to backup choose_server:"),T.url),vC(T,n,t,e)),allFailedhandler:T=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},R),T[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},R),f};let u,l,p;try{({gatewayInfo:u,proxyInfo:l,url:p}=await Jo([c(),d()]))}catch(_){throw _[0]}if(a.length&&a.forEach(_=>_.cancel&&typeof _.cancel=="function"&&_.cancel()),!u||!l)throw new k(v.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(n.apUrl=p,n.cloudProxyServer!=="disabled"&&Array.isArray(r)&&p){const _=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];nt(r).call(r,_)&&(n.proxyServer=_,m.setProxyServer(_),st.setProxyServer(_))}return o={gatewayInfo:u,proxyInfo:await RM(l,u.uid)},o}async function NC(n,t,e,i){const r=O("UAP_AP").slice(0,O("AJAX_REQUEST_CONCURRENT")).map(s=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap"));return await bM(r,n,t,e,i)}async function DM(n,t,e){const i=O("UAP_AP").slice(0,O("AJAX_REQUEST_CONCURRENT")).map(r=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(r+"/api/v1?action=uap"):"https://".concat(r,"/api/v1?action=uap")).map(r=>function(s,o,a,c){const d={command:"convergeAllocateEdge",sid:o.sid,appId:o.appId,token:o.token,ts:Date.now(),version:fi,cname:o.cname,uid:o.uid.toString(),requestId:Bp,seq:Bp};Bp+=1;const u={service_name:"tele_channel",json_body:JSON.stringify(d)};return Ki(async()=>{const l=await wr(s,{data:u,cancelToken:a,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(l.code!==0){const _=new k(v.UNEXPECTED_RESPONSE,"cross channel ap error, code"+l.code,{retry:!0});throw m.error(_.toString()),_}const p=JSON.parse(l.json_body);if(p.code!==200){const _=new k(v.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw m.error(_.toString()),_}if(!p.servers||p.servers.length===0){const _=new k(v.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw m.error(_.toString()),_}return{vid:p.vid,workerToken:p.workerToken,addressList:(O("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(_=>"wss://".concat(_.address.replace(/\./g,"-"),".").concat(O("WORKER_DOMAIN"),":").concat(_.wss))}},void 0,l=>!!(l.code!==v.OPERATION_ABORTED&&l.code!==v.UNEXPECTED_RESPONSE||l.data&&l.data.retry),c)}(r,n,t,e));try{const r=await Jo(i);return i.forEach(s=>s.cancel()),r}catch(r){throw r[0]}}async function PM(n,t,e){let i=null;const r=[],s=async o=>{const a=O(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return o&&(await We(1e3),i!==null)?i:await ec({fragementLength:O("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(m.debug("[".concat(n.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),function(d,u,l,p){const[_]=OM(u,[Ke.CHOOSE_SERVER]);let R=Re.networkState;return Ki(async()=>{R&&Re.networkState===Tn.OFFLINE&&Re.onlineWaiter&&await F.race([Re.onlineWaiter,We(p&&p.maxRetryTimeout||Ce.maxRetryTimeout)]),R=Re.networkState;const f=await wr(d,{data:_,cancelToken:l,headers:{"Content-Type":"multipart/form-data;"}},!0);return wM(f,d)},()=>!1,f=>f.code!==v.OPERATION_ABORTED&&(f.code===v.UPDATE_TICKET_FAILED?f.data.retry:(m.warning("[".concat(u.clientId,"] update ticket network error, retry"),f),!0)),p)}(c,n,t,e)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await Jo([s(!1),s(!0)]),r.length&&r.forEach(o=>o.cancel&&typeof o.cancel=="function"&&o.cancel()),i}catch(o){throw o[0]}}function DC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function PC(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?DC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):DC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class LM extends se{get isSuccess(){return!!this.configs}constructor(){super(),h(this,"configs",void 0),h(this,"joinInfo",void 0),h(this,"cancelToken",void 0),h(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),h(this,"interval",void 0),h(this,"mutex",new He("config-distribute")),h(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,e){this.joinInfo=t,this.cancelToken=e,this.interval&&this.stopGetConfigDistribute(),O("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},O("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,st.reportApiInvoke(null,{options:void 0,name:Ae.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:ce.TRACER}).onSuccess(JSON.stringify(Qr))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void m.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const e=await this.mutex.lock();try{t=await NM(this.joinInfo,this.cancelToken,this.retryConfig),m.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(i){const r=new k(v.NETWORK_RESPONSE_ERROR,i);m.warning("[config-distribute] ".concat(r.toString()))}finally{e()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var e;(e=t)&&e.uplink&&e.id&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(Za.UPDATE_BITRATE_LIMIT,t):this.emit(Za.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&PC({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var e;const i=Ma(e=Object.keys(t).filter(s=>/^webrtc_ng_global_parameter/.test(s))).call(e);for(let s=0;s<i.length;s++)for(let o=i.length-1;o>s;o--){const a=i[o];if(typeof t[a].__priority=="number"){const c=t[a].__priority,d=i[o-1];if(typeof t[d].__priority=="number"){if(!(c>t[d].__priority))continue;{const u=a;i[o]=i[o-1],i[o-1]=u}}else{const u=a;i[o]=i[o-1],i[o-1]=u}}}const r={};i.forEach(s=>{const o=t[s],a=o.__expires;Object.keys(o).forEach(c=>{c==="__priority"||c==="__expires"||Object.prototype.hasOwnProperty.call(r,c)||(r[c]=PC({value:o[c]},a&&{expires:a}))})});try{(function(a){try{const c=Date.now();Object.keys(a).forEach(d=>{switch(d){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(vn,d)){const{value:u,expires:l}=a[d];if(l&&l<=c)return;Qr[d]=u,vn[d]=u,m.debug("Update global parameters from config distribute",d,u)}}})}catch(c){m.error("Error update config immediately: ".concat(a),c.message)}})(r);const s=JSON.stringify(r),o=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",o),m.debug("Caching global parameters ".concat(s))}catch(s){m.error("Error caching global parameters:",s.message)}}}const pn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function Kt(){return pn}var xe;function zo(n,t,e){return{sampleRate:n,stereo:t,bitrate:e}}function Dt(n,t,e,i,r){return{width:n,height:t,frameRate:e,bitrateMin:i,bitrateMax:r}}function Li(n,t,e,i,r){return{width:{max:n},height:{max:t},frameRate:e,bitrateMin:i,bitrateMax:r}}function Gp(n,t){return{numSpatialLayers:n,numTemporalLayers:t}}(function(n){n.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",n.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",n.IOS_INTERRUPTION_START="ios-interruption-start",n.IOS_INTERRUPTION_END="ios-interruption-end",n.STATE_CHANGE="state-change"})(xe||(xe={}));const kM={"90p":Dt(160,90),"90p_1":Dt(160,90),"120p":Dt(160,120,15,30,65),"120p_1":Dt(160,120,15,30,65),"120p_3":Dt(120,120,15,30,50),"120p_4":Dt(212,120),"180p":Dt(320,180,15,30,140),"180p_1":Dt(320,180,15,30,140),"180p_3":Dt(180,180,15,30,100),"180p_4":Dt(240,180,15,30,120),"240p":Dt(320,240,15,40,200),"240p_1":Dt(320,240,15,40,200),"240p_3":Dt(240,240,15,40,140),"240p_4":Dt(424,240,15,40,220),"360p":Dt(640,360,15,80,400),"360p_1":Dt(640,360,15,80,400),"360p_3":Dt(360,360,15,80,260),"360p_4":Dt(640,360,30,80,600),"360p_6":Dt(360,360,30,80,400),"360p_7":Dt(480,360,15,80,320),"360p_8":Dt(480,360,30,80,490),"360p_9":Dt(640,360,15,80,800),"360p_10":Dt(640,360,24,80,800),"360p_11":Dt(640,360,24,80,1e3),"480p":Dt(640,480,15,100,500),"480p_1":Dt(640,480,15,100,500),"480p_2":Dt(640,480,30,100,1e3),"480p_3":Dt(480,480,15,100,400),"480p_4":Dt(640,480,30,100,750),"480p_6":Dt(480,480,30,100,600),"480p_8":Dt(848,480,15,100,610),"480p_9":Dt(848,480,30,100,930),"480p_10":Dt(640,480,10,100,400),"720p":Dt(1280,720,15,120,1130),"720p_auto":Dt(1280,720,30,900,3e3),"720p_1":Dt(1280,720,15,120,1130),"720p_2":Dt(1280,720,30,120,2e3),"720p_3":Dt(1280,720,30,120,1710),"720p_5":Dt(960,720,15,120,910),"720p_6":Dt(960,720,30,120,1380),"1080p":Dt(1920,1080,15,120,2080),"1080p_1":Dt(1920,1080,15,120,2080),"1080p_2":Dt(1920,1080,30,120,3e3),"1080p_3":Dt(1920,1080,30,120,3150),"1080p_5":Dt(1920,1080,60,120,4780),"1440p":Dt(2560,1440,30,120,4850),"1440p_1":Dt(2560,1440,30,120,4850),"1440p_2":Dt(2560,1440,60,120,7350),"4k":Dt(3840,2160,30,120,8910),"4k_1":Dt(3840,2160,30,120,8910),"4k_3":Dt(3840,2160,60,120,13500)},ru=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],MM={"480p":Li(640,480,5),"480p_1":Li(640,480,5),"480p_2":Li(640,480,30),"480p_3":Li(640,480,15),"720p":Li(1280,720,5),"720p_auto":Dt(1280,720,30,900,3e3),"720p_1":Li(1280,720,5),"720p_2":Li(1280,720,30),"720p_3":Li(1280,720,15),"1080p":Li(1920,1080,5),"1080p_1":Li(1920,1080,5),"1080p_2":Li(1920,1080,30),"1080p_3":Li(1920,1080,15)},UM={"1SL1TL":Gp(1,1),"3SL3TL":Gp(3,3),"2SL3TL":Gp(2,3)};function dr(n){return n||(n="480p_1"),typeof n=="string"?Object.assign({},kM[n]):n}function Wp(n){return typeof n=="string"?Object.assign({},MM[n]):n}function su(n){return typeof n=="string"?Object.assign({},UM[n]):n}const xM={speech_low_quality:zo(16e3,!1),speech_standard:zo(32e3,!1,18),music_standard:zo(48e3,!1),standard_stereo:zo(48e3,!0,56),high_quality:zo(48e3,!1,128),high_quality_stereo:zo(48e3,!0,192)};function ou(n){return typeof n=="string"?Object.assign({},xM[n]):n}const Xo=[];function LC(n){return De(n,"mediaSource",["screen","window","application"]),!0}var tt,$t,os,Hp,Kp,Qo,as,Xs,kn,au;(function(n){n.NEED_RENEGOTIATE="@need_renegotiate",n.NEED_REPLACE_TRACK="@need_replace_track",n.NEED_CLOSE="@need_close",n.NEED_ENABLE_TRACK="@need_enable_track",n.NEED_DISABLE_TRACK="@need_disable_track",n.NEED_SESSION_ID="@need_sid",n.SET_OPTIMIZATION_MODE="@set_optimization_mode",n.GET_STATS="@get_stats",n.GET_RTC_STATS="@get_rtc_stats",n.GET_LOW_VIDEO_TRACK="@get_low_video_track",n.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",n.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",n.NEED_MUTE_TRACK="@need_mute_track",n.NEED_UNMUTE_TRACK="@need_unmute_track"})(tt||(tt={})),function(n){n.SCREEN_TRACK="screen_track",n.CUSTOM_TRACK="custome_track",n.LOW_STREAM="low_stream"}($t||($t={})),function(n){n[n.HIGH_STREAM=0]="HIGH_STREAM",n[n.LOW_STREAM=1]="LOW_STREAM"}(os||(os={})),function(n){n[n.HIGH_STREAM=0]="HIGH_STREAM",n[n.LOW_STREAM=1]="LOW_STREAM"}(Hp||(Hp={})),function(n){n[n.DISABLE=0]="DISABLE",n[n.LOW_STREAM=1]="LOW_STREAM",n[n.AUDIO_ONLY=2]="AUDIO_ONLY"}(Kp||(Kp={})),function(n){n.TRANSCEIVER_UPDATED="transceiver-updated"}(Qo||(Qo={})),function(n){n.SOURCE_STATE_CHANGE="source-state-change",n.TRACK_ENDED="track-ended",n.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",n.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",n.CLOSED="closed"}(as||(as={})),function(n){n.FIRST_FRAME_DECODED="first-frame-decoded",n.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(Xs||(Xs={})),function(n){n.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",n.RECEIVE_TRACK_BUFFER="receive_track_buffer",n.ON_AUDIO_BUFFER="on_audio_buffer",n.UPDATE_SOURCE="update_source"}(kn||(kn={})),function(n){n.UPDATE_TRACK_SOURCE="update-track-source"}(au||(au={}));const Yp={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},qp={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},kC={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},VM={uplinkNetworkQuality:0,downlinkNetworkQuality:0},MC={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var _n,Mn,Qs,Or,mn;(function(n){n.ON_TRACK="on_track",n.ON_NODE="on_node"})(_n||(_n={})),function(n){n.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",n.REQUEST_CONSTRAINTS="request_constraints"}(Mn||(Mn={})),function(n){n.IDLE="IDLE",n.INITING="INITING",n.INITEND="INITEND"}(Qs||(Qs={})),function(n){n.STATE_CHANGE="state_change",n.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",n.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",n.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(Or||(Or={})),function(n){n.NONE="none",n.INIT="init",n.CANPLAY="canplay",n.PLAYING="playing",n.PAUSED="paused",n.SUSPEND="suspend",n.STALLED="stalled",n.WAITING="waiting",n.ERROR="error",n.DESTROYED="destroyed",n.ABORT="abort",n.ENDED="ended",n.EMPTIED="emptied",n.LOADEDDATA="loadeddata"}(mn||(mn={}));const Jp={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var Zo;(function(n){n.OPEN="open",n.MESSAGE="message",n.CLOSE="close",n.CLOSING="closing",n.ERROR="error"})(Zo||(Zo={}));class UC extends se{constructor(t,e){super(),h(this,"_ID",void 0),h(this,"_rtpTransceiver",void 0),h(this,"_lowRtpTransceiver",void 0),h(this,"_hints",[]),h(this,"_isClosed",!1),h(this,"_originMediaStreamTrack",void 0),h(this,"_mediaStreamTrack",void 0),h(this,"_external",{}),this._ID=e||Qt(8,"track-"),this._originMediaStreamTrack=t,this._mediaStreamTrack=t,function(i){nt(Xo).call(Xo,i)||Xo.push(i)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){if(!t){const e=st.reportApiInvoke(null,{name:Ae.GET_MEDIA_STREAM_TRACK,options:[],tag:ce.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?e.onSuccess(this._mediaStreamTrack.label):e.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===os.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const e=Xo.indexOf(t);e!==-1&&Xo.splice(e,1)}(this),this.emit(as.CLOSED)}_updateRtpTransceiver(t,e){if(e===os.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Qo.TRANSCEIVER_UPDATED,t,e)}}class rn extends UC{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}constructor(t,e){super(t,e),h(this,"_enabled",!0),h(this,"_muted",!1),h(this,"_isExternalTrack",!1),h(this,"_isClosed",!1),h(this,"_enabledMutex",void 0),h(this,"processor",void 0),h(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new He("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,e;return(t=(e=this._originMediaStreamTrack)===null||e===void 0?void 0:e.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,m.debug("[".concat(this.getTrackId(),"] close")),this.emit(tt.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,tt.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(as.TRACK_ENDED)}stateCheck(t,e){if(m.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(e,"]")),zr(e,t),this._enabled&&this._muted&&t==="enabled"&&e===!1)throw new G(v.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",m);if(!this._enabled&&!this._muted&&t==="muted"&&e===!0)throw new G(v.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",m)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function xC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}const VC=window.AudioContext||window.webkitAudioContext;let si=null;const jt=new class extends se{constructor(){super(...arguments),h(this,"prevState",void 0),h(this,"curState",void 0),h(this,"currentTime",void 0),h(this,"currentTimeStuckAt",void 0),h(this,"interruptDetectorTrack",void 0),h(this,"onLocalAudioTrackMute",()=>{m.info("ios15-interruption-start"),this.emit(xe.IOS_15_16_INTERRUPTION_START)}),h(this,"onLocalAudioTrackUnmute",async()=>{m.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?m.info("ios15-interruption-end-canceled"):(si&&await si.suspend(),this.emit(xe.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(n){m.debug("webaudio bindInterruptDetectorTrack ".concat(n.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=n,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(n){m.debug("webaudio unbindInterruptDetectorTrack ".concat(n.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===n&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function FM(){if(!VC)return void m.error("your browser is not support web audio");m.info("create audio context");const n=function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?xC(Object(i),!0).forEach(function(r){h(t,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xC(Object(i)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(i,r))})}return t}({},O("WEBAUDIO_INIT_OPTIONS"));m.debug("audio context init option:",JSON.stringify(n)),si=new VC(n),jt.curState=si.state,si.onstatechange=()=>{jt.prevState=jt.curState,jt.curState=si?si.state:void 0;const{prevState:t,curState:e}=jt,i=e==="running",r=e==="interrupted",s=t==="running",o=t==="suspended",a=t==="interrupted",c=Lt().osVersion;(gn()||sr())&&s&&r&&(m.info("ios".concat(c,"-interruption-start")),jt.emit(xe.IOS_INTERRUPTION_START)),(gn()||sr())&&(o||a)&&i&&(m.info("ios".concat(c,"-interruption-end")),jt.emit(xe.IOS_INTERRUPTION_END)),t!==e&&jt.emit(xe.STATE_CHANGE,e,t)},setInterval(()=>{var t;const e=(t=si)===null||t===void 0?void 0:t.currentTime;jt.currentTime!==e?(jt.currentTimeStuckAt&&(m.debug("AudioContext current time resume at ".concat(e)),jt.currentTimeStuckAt=void 0),jt.currentTime=e):(e!==jt.currentTimeStuckAt&&(st.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:e},tag:ce.TRACER}).onSuccess(),m.warning("AudioContext current time stuck at ".concat(e))),jt.currentTimeStuckAt=e)},5e3),async function(t){const e=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r=!1,s=!1,o=!1;function a(T){t.state==="running"?c(!1):gn()||sr()?t.state==="suspended"&&(c(!0),T&&t.resume().then(u,u)):t.state!=="closed"&&(c(!0),T&&t.resume().then(u,u))}function c(T){if(r!==T){r=T;for(let A=0,N=e;A<N.length;A+=1){const P=N[A];T?window.addEventListener(P,l,{capture:!0,passive:!0}):window.removeEventListener(P,l,{capture:!0,passive:!0})}}}function d(){a(!0)}function u(){a(!1)}function l(){a(!0)}function p(T){if(!o)if(i.paused)if(T){let A;_(!1),o=!0;try{A=i.play(),A?A.then(R,R):(i.addEventListener("playing",R),i.addEventListener("abort",R),i.addEventListener("error",R))}catch{R()}}else _(!0);else _(!1)}function _(T){if(s!==T){s=T;for(let A=0,N=e;A<N.length;A++){const P=N[A];T?window.addEventListener(P,f,{capture:!0,passive:!0}):window.removeEventListener(P,f,{capture:!0,passive:!0})}}}function R(){i.removeEventListener("playing",R),i.removeEventListener("abort",R),i.removeEventListener("error",R),o=!1,p(!1)}function f(){p(!0)}if(gn()){const T=t.createMediaStreamDestination(),A=document.createElement("div");A.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=A.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=T.stream,p(!0)}jt.on(xe.STATE_CHANGE,d),a(!1)}(si)}function $o(){if(!si){if(FM(),!si)throw new G(v.NOT_SUPPORTED,"can not create audio context");return si}return si}function FC(){return!!si}function Zs(n){if(function(){if(zp!==null)return zp;const i=$o(),r=i.createBufferSource(),s=i.createGain(),o=i.createGain();r.connect(s),r.connect(o),r.disconnect(s);let a=!1;try{r.disconnect(s)}catch{a=!0}return r.disconnect(),zp=a,a}())return;const t=n.connect,e=n.disconnect;n.connect=(i,r,s)=>{var o;return n._inputNodes||(n._inputNodes=[]),nt(o=n._inputNodes).call(o,i)||(i instanceof AudioNode?(n._inputNodes.push(i),t.call(n,i,r,s)):t.call(n,i,r)),n},n.disconnect=(i,r,s)=>{e.call(n),i?Pd(n._inputNodes,i):n._inputNodes=[];for(const o of n._inputNodes)t.call(n,o)}}let zp=null;function Xp(n,t){let e=!1;const i=1/t;if(O("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{e?window.clearInterval(r):n(performance.now()/1e3)},1e3*i)}else{const r=$o();let s=r.createGain();s.gain.value=0,s.connect(r.destination);const o=()=>{if(e)return void(s=null);const a=r.createOscillator();a.onended=o,a.connect(s),a.start(0),a.stop(r.currentTime+i),n(r.currentTime)};o()}return()=>{e=!0}}class BC{constructor(){h(this,"context",void 0),h(this,"analyserNode",void 0),h(this,"sourceNode",void 0),this.context=$o(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||gn()||sr()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<t.length;++r)t[r]=i[r]/128-1}const e=Hs(t).call(t,(i,r)=>i+r*r,0)/t.length;return Math.max(10*Math.log10(e)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,e;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(e=this.sourceNode)===null||e===void 0||e.connect(this.analyserNode)}catch{m.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class jC extends se{get processSourceNode(){return this.sourceNode}set processedNode(t){var e;if(!this.isDestroyed&&this._processedNode!==t){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(e=this._processedNode)===null||e===void 0||e.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),h(this,"outputNode",void 0),h(this,"outputTrack",void 0),h(this,"isPlayed",!1),h(this,"context",void 0),h(this,"audioBufferNode",void 0),h(this,"destNode",void 0),h(this,"audioOutputLevel",0),h(this,"volumeLevelAnalyser",void 0),h(this,"_processedNode",void 0),h(this,"playNode",void 0),h(this,"isDestroyed",!1),h(this,"onNoAudioInput",void 0),h(this,"isNoAudioInput",!1),h(this,"_noAudioInputCount",0),this.context=$o(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Zs(this.outputNode),this.volumeLevelAnalyser=new BC}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit(kn.ON_AUDIO_BUFFER,function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){const s=i.outputBuffer.getChannelData(r);for(let o=0;o<s.length;o+=1)s[o]=0}return i.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Kt().webAudioMediaStreamDest)throw new G(v.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&Ld(()=>{jt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;gn()||sr()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const e=this.volumeLevelAnalyser.getAnalyserNode();let i;e.getFloatTimeDomainData?(i=new Float32Array(e.fftSize),e.getFloatTimeDomainData(i)):(i=new Uint8Array(e.fftSize),e.getByteTimeDomainData(i));let r=!1;for(let s=0;s<i.length;s++)i[s]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await We(200),await this.checkHasAudioInput(t?t+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,e;(t=this.processedNode)===null||t===void 0||t.disconnect(),(e=this.sourceNode)===null||e===void 0||e.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Qp extends jC{get isFreeze(){return!1}constructor(t,e,i){var r;if(super(),h(this,"sourceNode",void 0),h(this,"track",void 0),h(this,"clonedTrack",void 0),h(this,"audioElement",void 0),h(this,"isCurrentTrackCloned",!1),h(this,"isRemoteTrack",!1),h(this,"originVolumeLevelAnalyser",void 0),h(this,"rebuildWebAudio",async()=>{if(m.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void m.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>m.info("resume success")),m.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Zs(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Zs(this.outputNode),this.emit(kn.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new G(v.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!e,this.sourceNode=this.context.createMediaStreamSource(s),Zs(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,m.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));Zs(c),this.originVolumeLevelAnalyser=new BC,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=Lt();e&&o.os===Ne.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(jt.on(xe.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const e=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(e),Zs(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(kn.UPDATE_SOURCE),this.audioElement.srcObject=e}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),jt.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const e=t.clone();e.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=e),m.debug("create an unmuted track ".concat(e.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([e]));Zs(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function GC(n,t,e){const i=(s,o)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||o:s:o,r={audio:!!e&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function BM(n,t){const e=await WC(n.mediaSource),{sourceId:i,audio:r}=await function(s){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new F((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const u=document.createElement("div");u.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const l=document.createElement("div");l.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",l.setAttribute("style","height: 12%;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const _=document.createElement("div");_.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const R=document.createElement("button");R.innerHTML="cancel",R.setAttribute("style","width: 85px;"),R.onclick=()=>{document.body.removeChild(A);const N=new Error("NotAllowedError");N.name="NotAllowedError",c(N)};let f=o;const T=document.createElement("div");if(o){const N=document.createElement("input");N.setAttribute("type","checkbox");const P=document.createElement("span");N.setAttribute("style","margin-right: 6px;"),P.innerText="Share audio",N.checked=f,N.onchange=()=>{f=N.checked},T.appendChild(N),T.appendChild(P)}_.appendChild(T),_.appendChild(R),u.appendChild(l),u.appendChild(p),u.appendChild(_);const A=document.createElement("div");A.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),A.appendChild(d),A.appendChild(u),document.body.appendChild(A),s.map(N=>{if(N.id){const P=document.createElement("div");P.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let j=N.thumbnail;try{const{width:M}=j.getSize();M>1920&&(j=j.resize({width:1920}))}catch(M){throw M&&M.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),M}P.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+j.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+N.name.replace(/[\u00A0-\u9999<>\&]/g,function(M){return"&#"+M.charCodeAt(0)+";"})+"</span>",P.onclick=()=>{document.body.removeChild(A),a({sourceId:N.id,audio:f})},p.appendChild(P)}})})}(e,t);return await GC(i,n,r)}async function WC(n){let t=["window","screen"];n!=="application"&&n!=="window"||(t=["window"]),n==="screen"&&(t=["screen"]);const e=NS();if(!e)throw console.error("failed to fetch electron, please mount it to window"),new G(v.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=e.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:t}))||e.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{i=null}i&&i.then||(i=new F((s,o)=>{e.desktopCapturer.getSources({types:t},(a,c)=>{a?o(a):s(c)})}));try{return await i}catch(s){throw new G(v.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}function HC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}const Zp=new He("safari");let KC=!1,YC=!1;async function oi(n,t){let e=0,i=null;for(;e<2;)try{i=await jM(n,t,e>0);break}catch(r){if(r instanceof G)throw m.error("[".concat(t,"] ").concat(r.toString())),r;const s=cu(r.name||r.code||r,r.message);if(s.code===v.MEDIA_OPTION_INVALID){m.debug("[".concat(t,"] detect media option invalid, retry")),e+=1,await We(500);continue}throw m.error("[".concat(t,"] ").concat(s.toString())),s}if(!i)throw new G(v.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function jM(n,t,e){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new G(v.NOT_SUPPORTED,"can not find getUserMedia");e&&(n.video&&(delete n.video.width,delete n.video.height),n.screen&&(delete n.screen.width,delete n.screen.height));const i=Kt(),r=new MediaStream;if(n.audioSource&&r.addTrack(n.audioSource),n.videoSource&&r.addTrack(n.videoSource),!n.audio&&!n.video&&!n.screen)return m.debug("Using Video Source/ Audio Source"),r;if(n.screen)if(NS())n.screen.sourceId?ta(r,await GC(n.screen.sourceId,n.screen,n.screenAudio)):ta(r,await BM(n.screen,n.screenAudio));else if(Ka()&&n.screen.extensionId&&n.screen.mandatory){if(!i.getStreamFromExtension)throw new G(v.NOT_SUPPORTED,"This browser does not support screen sharing");m.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const p=await(o=n.screen.extensionId,a=t,new F((_,R)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},f=>{if(!f||!f.streamId)return m.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),f),void R(new G(v.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));_(f.streamId)})}catch(f){m.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),f.toString()),R(new G(v.CHROME_PLUGIN_NOT_INSTALL))}}));n.screen.mandatory.chromeMediaSourceId=p,ta(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:n.screen.mandatory}}))}else if(i.getDisplayMedia){var s;n.screen.mediaSource&&LC(n.screen.mediaSource);const p={width:n.screen.width,height:n.screen.height,frameRate:n.screen.frameRate,displaySurface:(s=n.screen.displaySurface)!==null&&s!==void 0?s:n.screen.mediaSource==="screen"?"monitor":n.screen.mediaSource},{selfBrowserSurface:_,surfaceSwitching:R,systemAudio:f}=n.screen,T={selfBrowserSurface:_,surfaceSwitching:R,systemAudio:f};!_&&delete T.selfBrowserSurface,!R&&delete T.surfaceSwitching,!f&&delete T.systemAudio,m.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:p,audio:!!n.screenAudio,controls:T}));const A=await navigator.mediaDevices.getDisplayMedia(function(N){for(var P=1;P<arguments.length;P++){var j=arguments[P]!=null?arguments[P]:{};P%2?HC(Object(j),!0).forEach(function(M){h(N,M,j[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(N,Object.getOwnPropertyDescriptors(j)):HC(Object(j)).forEach(function(M){Object.defineProperty(N,M,Object.getOwnPropertyDescriptor(j,M))})}return N}({video:p,audio:!!n.screenAudio},T));ta(r,A)}else{if(!Jt())throw m.error("[".concat(t,"] This browser does not support screenSharing")),new G(v.NOT_SUPPORTED,"This browser does not support screen sharing");{n.screen.mediaSource&&LC(n.screen.mediaSource);const p={video:{mediaSource:n.screen.mediaSource,width:n.screen.width,height:n.screen.height,frameRate:n.screen.frameRate}};m.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(p))),ta(r,await navigator.mediaDevices.getUserMedia(p))}}var o,a;if(!n.video&&!n.audio)return r;let c={video:n.video,audio:n.audio},d=O("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=Xh(c,d)}catch{}m.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),Lt();let u,l=null;(fn()||gn()||Od())&&(l=await Zp.lock());try{u=await navigator.mediaDevices.getUserMedia(c)}catch(p){throw l&&l(),p}return c.audio&&(KC=!0),c.video&&(YC=!0),ta(r,u),l&&l(),r}function cu(n,t){switch(n){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new G(v.MEDIA_OPTION_INVALID,"".concat(n,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new G(v.DEVICE_NOT_FOUND,"".concat(n,": ").concat(t));case"NotSupportedError":return new G(v.NOT_SUPPORTED,"".concat(n,": ").concat(t));case"NotReadableError":return new G(v.NOT_READABLE,"".concat(n,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new G(v.PERMISSION_DENIED,"".concat(n,": ").concat(t));case"ConstraintNotSatisfiedError":return new G(v.CONSTRAINT_NOT_SATISFIED,"".concat(n,": ").concat(t));default:return m.error("getUserMedia unexpected error",n),new G(v.UNEXPECTED_ERROR,"".concat(n,": ").concat(t))}}function ta(n,t){const e=n.getVideoTracks()[0],i=n.getAudioTracks()[0],r=t.getVideoTracks()[0],s=t.getAudioTracks()[0];s&&(i&&n.removeTrack(i),n.addTrack(s)),r&&(e&&n.removeTrack(e),n.addTrack(r))}const ai=new class extends se{get state(){return this._state}set state(n){n!==this._state&&(this.emit(Or.STATE_CHANGE,n),this._state=n)}constructor(){super(),h(this,"_state",Qs.IDLE),h(this,"isAccessMicrophonePermission",!1),h(this,"isAccessCameraPermission",!1),h(this,"lastAccessMicrophonePermission",!1),h(this,"lastAccessCameraPermission",!1),h(this,"checkdeviceMatched",!1),h(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(O("ENUMERATE_DEVICES_INTERVAL")||(Nd()||wd()===Ne.HARMONY_OS)&&Jr())&&this.updateDevicesInfo()},O("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(n=>m.error(n.toString()))}async enumerateDevices(n,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new G(v.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let s=!this.isAccessMicrophonePermission&&n,o=!this.isAccessCameraPermission&&t;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,d=null;if(!e&&(s||o)){if(Zp.isLocked&&(m.debug("[device manager] wait GUM lock"),(await Zp.lock())(),m.debug("[device manager] GUM unlock")),KC&&(s=!1,this.isAccessMicrophonePermission=!0),YC&&(o=!1,this.isAccessCameraPermission=!0),m.debug("[device manager] check media device permissions",n,t,s,o),s&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(u){const l=cu(u.name||u.code||u,u.message);if(l.code===v.PERMISSION_DENIED)throw l;m.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:n})}catch(u){const l=cu(u.name||u.code||u,u.message);if(l.code===v.PERMISSION_DENIED)throw l;m.warning("getUserMedia failed in getDevices",l)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(u){const l=cu(u.name||u.code||u,u.message);if(l.code===v.PERMISSION_DENIED)throw l;m.warning("getUserMedia failed in getDevices",l)}this.isAccessCameraPermission=!0}m.debug("[device manager] mic permission",n,"cam permission",t)}try{const u=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,u}catch(u){return a&&a.getTracks().forEach(l=>l.stop()),c&&c.getTracks().forEach(l=>l.stop()),d&&d.getTracks().forEach(l=>l.stop()),a=null,c=null,d=null,new G(v.ENUMERATE_DEVICES_FAILED,u.toString()).throw()}}async getRecordingDevices(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,n)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,n)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let n=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,n)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(n){let t=null;return this.deviceInfoMap.forEach(e=>{e.device.label===n&&(t=e.device.deviceId)}),t}async getDeviceById(n){const t=(await this.enumerateDevices(!0,!0,!0)).find(e=>e.deviceId===n);if(!t)throw new G(v.DEVICE_NOT_FOUND,"deviceId: ".concat(n));return t}async init(){this.state=Qs.INITING;try{await this.updateDevicesInfo(),this.state=Qs.INITEND}catch(n){throw m.warning("Device Detection functionality cannot start properly.",n.toString()),this.state=Qs.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new G(v.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),n}}async updateDevicesInfo(){const n=await this.enumerateDevices(!0,!0,!0),t=Date.now(),e=[];if(n[0]&&n[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=n.find(o=>o.kind==="audioinput"&&o.deviceId==="default"),s=n.find(o=>o.kind==="audiooutput"&&o.deviceId==="default");r&&s?s.groupId===r.groupId?m.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is the same group")):m.warning("[device-check] default input ".concat(r.label," and output ").concat(s.label," is not the same group")):m.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(n);if(n.forEach(r=>{if(!r.deviceId)return;const s=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const o={initAt:t,updateAt:t,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),e.push(o)}s&&(s.updateAt=t)}),this.deviceInfoMap.forEach((r,s)=>{r.state==="ACTIVE"&&r.updateAt!==t&&(r.state="INACTIVE",e.push(r))}),this.state!==Qs.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));e.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Or.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Or.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Or.PLAYOUT_DEVICE_CHANGED,r)}}),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(n){const t=n.filter(r=>r.kind==="audioinput"),e=n.filter(r=>r.kind==="videoinput"),i={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of e)if(r.label&&r.deviceId){i.video=!0;break}return i}};let $p=!1;const ci=new class extends se{constructor(){super(...arguments),h(this,"onAutoplayFailed",void 0),h(this,"onAudioAutoplayFailed",void 0)}};function qC(){if(Lt(),!$p){const n=t=>{t.preventDefault(),$p=!1,Ya()?document.body.removeEventListener("click",n,!0):(document.body.removeEventListener("touchstart",n,!0),document.body.removeEventListener("mousedown",n,!0))};$p=!0,Ya()?document.body.addEventListener("click",n,!0):(document.body.addEventListener("touchstart",n,!0),document.body.addEventListener("mousedown",n,!0)),m.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),ci.onAutoplayFailed?ci.onAutoplayFailed():ci.onAudioAutoplayFailed?m.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):m.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),ci.emit("autoplay-failed")}}function JC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function zC(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?JC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):JC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function XC(n,t,e,i){if(!n)return;const r=st.getBaseInfoBySessionId(n);if(!r)return;const s=r.info,o=Date.now(),a=zC(zC({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:ci.onAutoplayFailed||ci.onAudioAutoplayFailed?1:-1,errorMsg:e,mediaType:t,trackId:i,extend:void 0});st.send({type:ne.AUTOPLAY_FAILED,data:a},!0)}const GM=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Un=new class{constructor(){h(this,"onAutoplayFailed",void 0),h(this,"elementMap",new Map),h(this,"elementStateMap",new Map),h(this,"elementsNeedToResume",[]),h(this,"sinkIdMap",new Map),h(this,"autoResumeAfterInterruption",n=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,i]=t;const r=this.elementStateMap.get(e),s=i.srcObject.getAudioTracks()[0],o=s&&s.readyState;if(m.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(n)),o==="live"){if(n)return i.pause(),void i.play();if(jt.curState==="running")return Mo()?(i.pause(),void i.play()):void(r&&r==="paused"&&i.play())}})}),h(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(n=>{let[t,e]=n;const i=e.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(m.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),e.pause(),e.play())})}),this.autoResumeAudioElement(),jt.on(xe.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),jt.on(xe.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),jt.on(xe.STATE_CHANGE,()=>{gn()&&jt.prevState==="suspended"&&jt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(n,t){const e=this.elementMap.get(n);if(this.sinkIdMap.set(n,t),e)try{await e.setSinkId(t)}catch(i){throw new G(v.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(n,t,e,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([n]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,mn.INIT),this.setVolume(t,e);const s=this.sinkIdMap.get(t);if(s)try{r.setSinkId(s).catch(a=>{m.warning("[".concat(t,"] set sink id failed"),a.toString())})}catch(a){m.warning("[".concat(t,"] set sink id failed"),a.toString())}const o=r.play();o&&o.then&&o.catch(a=>{i&&XC(i,"audio",a.message,t),m.warning("audio element play warning",a.toString()),this.elementMap.has(t)&&a.name==="NotAllowedError"&&(m.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Ld(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),qC()}))})}updateTrack(n,t){const e=this.elementMap.get(n);e&&(e.srcObject=new MediaStream([t]))}isPlaying(n){return this.elementMap.has(n)&&this.elementStateMap.get(n)==="playing"}setVolume(n,t){const e=this.elementMap.get(n);e&&(t=Math.max(0,Math.min(100,t)),e.volume=t/100)}stop(n){const t=this.elementMap.get(n);if(this.sinkIdMap.delete(n),!t)return;const e=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(e,1),t.srcObject=null,t.remove(),this.elementMap.delete(n),this.elementStateMap.delete(n)}bindAudioElementEvents(n,t){GM.forEach(e=>{t.addEventListener(e,i=>{const r=this.elementStateMap.get(n),s=i.type==="pause"?"paused":i.type;if(m.debug("[".concat(n,"] audio-element-status change ").concat(r," => ").concat(s)),i.type==="error"){const o=t==null?void 0:t.error;o&&m.error("[".concat(n,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(n,s)})})}getPlayerState(n){return this.elementStateMap.get(n)||"uninit"}autoResumeAudioElement(){const n=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(e=>{m.debug("Auto resume audio element success")}).catch(e=>{m.warning("Auto resume audio element failed!",e)})}),this.elementsNeedToResume=[]};new F(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{Ya()?document.body.addEventListener("click",n,!0):(document.body.addEventListener("touchstart",n,!0),document.body.addEventListener("mousedown",n,!0))})}};function me(){return function(n,t,e){const i=e.value;return typeof i=="function"&&(e.value=function(){this._isClosed&&new G(v.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",m);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];const a=i.apply(this,s);return a instanceof F?new F((c,d)=>{a.then(c).catch(d)}):a}),e}}function QC(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function du(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?QC(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):QC(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class ZC extends se{constructor(t){super(),h(this,"name","VideoProcessorDestination"),h(this,"ID","0"),h(this,"_source",void 0),h(this,"videoContext",void 0),h(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new G(v.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new G(v.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(_n.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(_n.ON_TRACK,void 0)}}class $C extends se{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"usageRegistry",[]),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"_chained",!1),this.trackId=t,this.direction=e}async getConstraints(){return await Se(this,Mn.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,e){var i;return m.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),Xt(this,Mn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Yi(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return m.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),Xt(this,Mn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Yi(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===e)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===e);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:r,stats:o})}catch(o){m.error(new G(v.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,e){this.usageRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name);e!==-1&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof F&&(i=await i),t.push(du(du({},i),{},{direction:this.direction}))}catch(i){m.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class uu extends se{constructor(t){super(),h(this,"name","AudioProcessorDestination"),h(this,"ID","0"),h(this,"inputTrack",void 0),h(this,"inputNode",void 0),h(this,"audioProcessorContext",void 0),h(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new G(v.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new G(v.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(_n.ON_TRACK,void 0),this.emit(_n.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(_n.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(_n.ON_NODE,this.inputNode))}}class lu extends se{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e,i){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"audioContext",void 0),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"usageRegistry",[]),h(this,"_chained",!1),this.audioContext=t,this.trackId=e,this.direction=i}async getConstraints(){return Se(this,Mn.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,e){var i;return m.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),Xt(this,Mn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Yi(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),Xt(this,Mn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Yi(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===e)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===e);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:r,stats:o})}catch(o){m.error(new G(v.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,e){this.usageRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name);e!==-1&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof F&&(i=await i),t.push(du(du({},i),{},{direction:this.direction}))}catch(i){m.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class t_ extends se{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),h(this,"context",void 0),h(this,"processSourceNode",void 0),h(this,"outputTrack",void 0),h(this,"processedNode",void 0),h(this,"clonedTrack",void 0),h(this,"outputNode",void 0),this.outputNode=new WM}setVolume(){}createOutputTrack(){throw new G(v.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class WM{disconnect(){}connect(){}}let ea=null;class HM{constructor(){h(this,"state","open"),h(this,"trigger",void 0),h(this,"tasks",[]),m.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout(()=>{this.state="closed",m.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map(t=>t.key),"]")),this.trigger=void 0,this.tasks.forEach(t=>{let{func:e}=t;return e()}),this.tasks.length=0,m.debug("[macro-task-queue] is closed.")})}enqueue(t,e){this.state!=="closed"&&(this.tasks.push({key:t,func:e}),m.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")))}runTask(t){if(this.state==="closed")return;const e=this.tasks.findIndex(i=>i.key===t);if(e!==-1){const i=this.tasks.splice(e,1);m.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")),i[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,m.debug("[macro-task-queue] is closed."))}}function e_(n){return function(t,e,i){var r;const s=(r=i.value)!==null&&r!==void 0?r:i.get,o=function(){ea&&ea.state==="open"&&ea.runTask(n);for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return s==null?void 0:s.apply(this,...c)};return i.value?i.value=o:i.get=o,i}}function tv(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function n_(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?tv(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):tv(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class Vt extends rn{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?Un.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,r,s){super(t,i),h(this,"trackMediaType","audio"),h(this,"_encoderConfig",void 0),h(this,"_trackSource",void 0),h(this,"_enabled",!0),h(this,"_volume",100),h(this,"_useAudioElement",!1),h(this,"_bypassWebAudio",!1),h(this,"processor",void 0),h(this,"_processorContext",void 0),h(this,"_processorDestination",void 0),h(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!r;const o=()=>{this.processorContext=new lu(this._source.context,this.getTrackId(),"local"),this.processorDestination=new uu(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(kn.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})},a=s&&fn()&&!FC();O("DISABLE_WEBAUDIO")?(this._source=new t_,this._useAudioElement=!0,this._bypassWebAudio=!0):a?this._source=new t_:(this._source=new Qp(t,!1,this._getOriginVolumeLevel?t:void 0),O("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!O("DISABLE_WEBAUDIO")&&a&&(ea||(ea=new HM),ea).enqueue("INIT_WEBAUDIO",()=>{this._source=new Qp(t,!1,this._getOriginVolumeLevel?t:void 0),O("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(au.UPDATE_TRACK_SOURCE)})}setVolume(t){Wt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&Un.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void m.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Xt(this,tt.NEED_REPLACE_TRACK,this).then(()=>{m.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{m.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!Ka()&&O("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new G(v.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Un.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,i){return this._setEnabled(t,e,i)}async _setEnabled(t,e,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await Xt(this,tt.NEED_ENABLE_TRACK,this),m.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(r){throw i||(this._enabled=!1),m.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await Xt(this,tt.NEED_DISABLE_TRACK,this)}catch(r){throw i||(this._enabled=!0),m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,m.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Xt(this,tt.NEED_MUTE_TRACK,this):await Xt(this,tt.NEED_UNMUTE_TRACK,this))}getStats(){return Ja(()=>{m.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Wn(this,tt.GET_STATS)||n_({},Yp)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(kn.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(kn.ON_AUDIO_BUFFER),this._source.on(kn.ON_AUDIO_BUFFER,i=>t(i))}play(){m.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(m.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Un.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){m.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Un.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];m.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Un.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,tt.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return F.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new G(v.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new G(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(_n.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Xt(this,tt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,tt.NEED_REPLACE_TRACK,this))}),this.processorDestination.on(_n.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(_n.ON_TRACK),this.processorDestination.removeAllListeners(_n.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Mn.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Mn.REQUEST_CONSTRAINTS)}}W([e_("INIT_WEBAUDIO"),S("design:type",Object),S("design:paramtypes",[Object])],Vt.prototype,"_source",null),W([e_("INIT_WEBAUDIO"),S("design:type",lu),S("design:paramtypes",[lu])],Vt.prototype,"processorContext",null),W([e_("INIT_WEBAUDIO"),S("design:type",uu),S("design:paramtypes",[uu])],Vt.prototype,"processorDestination",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t],throttleTime:300}),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",void 0)],Vt.prototype,"setVolume",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Vt.prototype,"setPlaybackDevice",null),W([Bo("LocalAudioTrack","_enabledMutex"),dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean,Object,Boolean]),S("design:returntype",F)],Vt.prototype,"setEnabled",null),W([Bo("LocalAudioTrack","_enabledMutex"),dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean]),S("design:returntype",F)],Vt.prototype,"setMuted",null),W([me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",Object)],Vt.prototype,"getStats",null),W([me(),S("design:type",Function),S("design:paramtypes",[Object,Number]),S("design:returntype",void 0)],Vt.prototype,"setAudioFrameCallback",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Vt.prototype,"play",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Vt.prototype,"stop",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Vt.prototype,"close",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t.name]}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",Object)],Vt.prototype,"pipe",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Vt.prototype,"unpipe",null);class $s extends Vt{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,i,r){super(t,e.encoderConfig?ou(e.encoderConfig):{},r,O("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),h(this,"_config",void 0),h(this,"_deviceName","default"),h(this,"_constraints",void 0),h(this,"_originalConstraints",void 0),h(this,"_enabled",!0),this._config=e,this._constraints=i,this._originalConstraints=i,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(Mo()||Hh())&&jt.bindInterruptDetectorTrack(this),this.on(au.UPDATE_TRACK_SOURCE,()=>{this.bindProcessorContextEvents()}),FC()&&this.bindProcessorContextEvents()}async setDevice(t){if(m.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await ai.getDeviceById(t),i={};i.audio=n_({},this._constraints),i.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let r=null;try{r=await oi(i,this.getTrackId())}catch(s){throw m.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await oi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await ai.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}m.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,i){if(e)return m.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),i||(this._enabled=!1);try{await Xt(this,tt.NEED_DISABLE_TRACK,this)}catch(a){throw m.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}const s=n_({},this._constraints),o=ai.searchDeviceIdByName(this._deviceName);o&&!s.deviceId&&(s.deviceId=o);try{i||(this._enabled=!0);const a=await oi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),await Xt(this,tt.NEED_ENABLE_TRACK,this)}catch(a){throw i||(this._enabled=!1),m.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}m.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Mo()||Hh())&&jt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((gn()||sr())&&this._enabled&&!this._isClosed&&jt.duringInterruption){const t=async()=>{jt.off(xe.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};jt.on(xe.IOS_INTERRUPTION_END,t)}else m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(as.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=ai.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId=i),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const r=await oi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(Mn.REQUEST_UPDATE_CONSTRAINTS,async(t,e,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),e()}catch(r){i(r)}}),this.processorContext.on(Mn.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],$s.prototype,"setDevice",null),W([Bo("MicrophoneAudioTrack","_enabledMutex"),dt({argsMap:(n,t,e)=>[n.getTrackId(),t,e]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean,Boolean,Boolean]),S("design:returntype",F)],$s.prototype,"setEnabled",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],$s.prototype,"close",null);class cs extends Vt{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,r){super(e.createOutputTrack(),i,r),h(this,"source",void 0),h(this,"_bufferSource",void 0),this.source=t,this._bufferSource=e,this._bufferSource.on(kn.AUDIO_SOURCE_STATE_CHANGE,s=>{this.safeEmit(as.SOURCE_STATE_CHANGE,s)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Wt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}W([dt({argsMap:(n,t)=>[n.getTrackId(),t,n.duration]}),me(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",void 0)],cs.prototype,"startProcessAudioBuffer",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],cs.prototype,"pauseProcessAudioBuffer",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",void 0)],cs.prototype,"seekAudioBuffer",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],cs.prototype,"resumeProcessAudioBuffer",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],cs.prototype,"stopProcessAudioBuffer",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],cs.prototype,"close",null),W([dt({argsMap:n=>[n.getTrackId()]}),me(),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",void 0)],cs.prototype,"setAudioBufferPlaybackSpeed",null);class ve extends Vt{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=$o().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,Qt(8,"track-mix-")),h(this,"trackList",void 0),h(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(m.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):m.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){m.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Pd(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(e=>{e._encoderConfig&&((e._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=e._encoderConfig.bitrate),(e._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=e._encoderConfig.sampleRate),(e._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=e._encoderConfig.sampleSize),e._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(e=>{e instanceof ve?e.emit(Qo.TRANSCEIVER_UPDATED,t):e._updateRtpTransceiver(t)}))}}function hu(n){const t={};n.facingMode&&(t.facingMode=n.facingMode),n.cameraId&&(t.deviceId={exact:n.cameraId});const e=dr(n.encoderConfig);return e.width!=null&&(t.width=e.width),e.height!=null&&(t.height=e.height),!yS()&&e.frameRate&&(t.frameRate=e.frameRate),Lt().name===xt.EDGE&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Jt()&&(t.frameRate={ideal:30,max:30}),t}function ev(n){const t={};if(yS()||(n.AGC!==void 0&&(t.autoGainControl=n.AGC),n.AEC!==void 0&&(t.echoCancellation=n.AEC),n.ANS!==void 0&&(t.noiseSuppression=n.ANS,Ka()&&n.ANS&&(t.googHighpassFilter=n.ANS))),n.encoderConfig){const e=ou(n.encoderConfig);t.channelCount=e.stereo?2:1,t.sampleRate=e.sampleRate,t.sampleSize=e.sampleSize}return n.microphoneId&&(t.deviceId={exact:n.microphoneId}),Nd()&&(t.sampleRate=void 0),t}class KM extends jC{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(kn.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),h(this,"audioBuffer",void 0),h(this,"sourceNode",void 0),h(this,"startPlayTime",0),h(this,"startPlayOffset",0),h(this,"pausePlayTime",0),h(this,"options",void 0),h(this,"currentLoopCount",0),h(this,"currentPlaybackSpeed",100),h(this,"_currentState","stopped"),this.audioBuffer=t,this.options=e,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):m.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const nv=new Map;async function YM(n,t){let e=null;if(typeof n=="string"){const r=nv.get(n);if(r)return m.debug("use cached audio resource: ",n),r;try{e=(await Ki(()=>Pn.get(n,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(s){throw new G(v.FETCH_AUDIO_FILE_FAILED,s.toString())}}else e=await new F((s,o)=>{const a=new FileReader;a.onload=c=>{c.target?s(c.target.result):o(new G(v.READ_LOCAL_AUDIO_FILE_ERROR))},a.onerror=()=>{o(new G(v.READ_LOCAL_AUDIO_FILE_ERROR))},a.readAsArrayBuffer(n)});const i=await function(r){const s=$o();return new F((o,a)=>{s.decodeAudioData(r,c=>{o(c)},c=>{a(new G(v.DECODE_AUDIO_FILE_FAILED,c.toString()))})})}(e);return typeof n=="string"&&t&&nv.set(n,i),i}const i_=n=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new F((e,i)=>{t.toBlob(async r=>{if(t.remove(),r){const s=await iv(r);e({buffer:s,width:t.width,height:t.height})}else i(new G(v.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},n,1)})},iv=async n=>{const t=await n.arrayBuffer();return new Uint8Array(t)},Nr=new class extends se{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),h(this,"_lastHiddenTime",0),h(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),m.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};function rv(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function sv(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?rv(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):rv(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class r_{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(m.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}constructor(t){h(this,"trackId",void 0),h(this,"config",void 0),h(this,"onFirstVideoFrameDecoded",void 0),h(this,"freezeTimeCounterList",[]),h(this,"renderFreezeAccTime",0),h(this,"isKeepLastFrame",!1),h(this,"timeUpdatedCount",0),h(this,"freezeTime",0),h(this,"playbackTime",0),h(this,"lastTimeUpdatedTime",0),h(this,"autoplayFailed",!1),h(this,"videoTrack",void 0),h(this,"videoElement",void 0),h(this,"cacheVideoElement",void 0),h(this,"videoElementCheckInterval",void 0),h(this,"_videoElementStatus",mn.NONE),h(this,"isGettingVideoDimensions",!1),h(this,"startGetVideoDimensions",()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return m.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()}),h(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&jt.curState==="running"&&(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(fS())),CS()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),h(this,"handleVideoEvents",e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=mn.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=mn.CANPLAY;break;case"stalled":this.videoElementStatus=mn.STALLED;break;case"suspend":this.videoElementStatus=mn.SUSPEND;break;case"pause":this.videoElementStatus=mn.PAUSED,gn()||sr()||fn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=mn.WAITING;break;case"abort":this.videoElementStatus=mn.ABORT;break;case"ended":this.videoElementStatus=mn.ENDED;break;case"emptied":this.videoElementStatus=mn.EMPTIED;break;case"error":{this.videoElementStatus=mn.ERROR;const i=this.videoElement.error;i&&m.error("[".concat(this.trackId,"] media error, code: ").concat(i.code,", message: ").concat(i.message));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Nr.lastVisibleTime<Nr.lastHiddenTime||s<Nr.lastHiddenTime||s<Nr.lastVisibleTime)return;for(r>O("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),h(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(fS())),CS()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),jt.on(xe.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),jt.on(xe.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const e=this.videoElement.play();e&&e.catch&&e.catch(r=>{t&&XC(t,"video",r.message,this.trackId),r.name==="NotAllowedError"?(m.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):m.warning("[".concat(this.trackId,"] play warning: "),r)});const i=Lt();if((i.name==="Safari"&&Number(i.version)===15||Mo())&&e&&e.then){const r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};e.then(r).catch(r)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const e=t.getContext("2d");if(!e)return m.error("create canvas context failed!"),new ImageData(2,2);e.drawImage(this.videoElement,0,0,t.width,t.height);const i=e.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new F((s,o)=>{i.toBlob(async a=>{if(i.remove(),a){const c=await iv(a);s({buffer:c,width:i.width,height:i.height})}else o(new G(v.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,e<0?.1:e>1?1:e)})):await i_(t)}destroy(){jt.off(xe.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),jt.off(xe.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=mn.INIT,!this.videoElementCheckInterval&&(ov.forEach(s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(s){return s!==document.body&&document.body.contains(s)})(this.videoElement)||(this.videoElementStatus=mn.DESTROYED)},1e3),O("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,e;let s;const o=(a,c)=>{if(this.videoElementStatus===mn.PLAYING){if(s){const l=c.presentationTime-s.presentationTime;l>O("VIDEO_FREEZE_DURATION")&&Nr.lastVisibleTime>=Nr.lastHiddenTime&&s.timestamp>Nr.lastVisibleTime&&s.timestamp>Nr.lastHiddenTime&&(this.renderFreezeAccTime+=l)}s=sv(sv({},c),{},{timestamp:a})}var d,u;O("ENABLE_VIDEO_FRAME_CALLBACK")&&((d=(u=this.videoElement).requestVideoFrameCallback)===null||d===void 0||d.call(u,o))};(t=(e=this.videoElement).requestVideoFrameCallback)===null||t===void 0||t.call(e,o)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Nd()&&(this.videoElement.poster="noposter");const i=Lt();i.name==="Safari"&&Number(i.version)===15||Mo()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Jt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Jt()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(s=>{m.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())})}resetVideoElement(){ov.forEach(t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=mn.NONE}handleAutoPlayFailed(){const t=e=>{e.preventDefault(),this.videoElement.play().then(()=>{m.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(i=>{m.error(i)}),this.autoplayFailed=!1,Ya()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Ya()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),qC()}}const ov=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class av extends r_{constructor(t){super(t),h(this,"container",void 0),h(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const e=t.element;e!==this.slot&&(this.destroy(),this.slot=e),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var e;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await i_(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",O("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function cv(n){return new F((t,e)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=gn()?"canplay":"playing";r.addEventListener(s,()=>{const o=r.videoWidth,a=r.videoHeight;!o&&Jt()||(i=!0,r.srcObject=null,r.remove(),t([o,a]))}),r.srcObject=new MediaStream([n]),r.play().catch(Md),setTimeout(()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))},4e3)})}const qM=async(n,t,e)=>{const i=function(o){const a=[];for(let c=0;c<o.length;c+=2)a.push(parseInt(o.slice(c,c+2),16));return Uint8Array.from(a)}(function(o){const a="0123456789abcdef";function c(q){let z,mt="";for(z=0;z<=3;z++)mt+=a.charAt(q>>8*z+4&15)+a.charAt(q>>8*z&15);return mt}function d(q,z){const mt=(65535&q)+(65535&z);return(q>>16)+(z>>16)+(mt>>16)<<16|65535&mt}function u(q,z,mt,Rt,te,we){return d(function(ie,qn){return ie<<qn|ie>>>32-qn}(d(d(z,q),d(Rt,we)),te),mt)}function l(q,z,mt,Rt,te,we,ie){return u(z&mt|~z&Rt,q,z,te,we,ie)}function p(q,z,mt,Rt,te,we,ie){return u(z&Rt|mt&~Rt,q,z,te,we,ie)}function _(q,z,mt,Rt,te,we,ie){return u(z^mt^Rt,q,z,te,we,ie)}function R(q,z,mt,Rt,te,we,ie){return u(mt^(z|~Rt),q,z,te,we,ie)}const f=function(q){let z;const mt=1+(q.length+8>>6),Rt=new Array(16*mt);for(z=0;z<16*mt;z++)Rt[z]=0;for(z=0;z<q.length;z++)Rt[z>>2]|=q.charCodeAt(z)<<z%4*8;return Rt[z>>2]|=128<<z%4*8,Rt[16*mt-2]=8*q.length,Rt}(o);let T,A,N,P,j,M=1732584193,U=-271733879,B=-1732584194,V=271733878;for(T=0;T<f.length;T+=16)A=M,N=U,P=B,j=V,M=l(M,U,B,V,f[T+0],7,-680876936),V=l(V,M,U,B,f[T+1],12,-389564586),B=l(B,V,M,U,f[T+2],17,606105819),U=l(U,B,V,M,f[T+3],22,-1044525330),M=l(M,U,B,V,f[T+4],7,-176418897),V=l(V,M,U,B,f[T+5],12,1200080426),B=l(B,V,M,U,f[T+6],17,-1473231341),U=l(U,B,V,M,f[T+7],22,-45705983),M=l(M,U,B,V,f[T+8],7,1770035416),V=l(V,M,U,B,f[T+9],12,-1958414417),B=l(B,V,M,U,f[T+10],17,-42063),U=l(U,B,V,M,f[T+11],22,-1990404162),M=l(M,U,B,V,f[T+12],7,1804603682),V=l(V,M,U,B,f[T+13],12,-40341101),B=l(B,V,M,U,f[T+14],17,-1502002290),U=l(U,B,V,M,f[T+15],22,1236535329),M=p(M,U,B,V,f[T+1],5,-165796510),V=p(V,M,U,B,f[T+6],9,-1069501632),B=p(B,V,M,U,f[T+11],14,643717713),U=p(U,B,V,M,f[T+0],20,-373897302),M=p(M,U,B,V,f[T+5],5,-701558691),V=p(V,M,U,B,f[T+10],9,38016083),B=p(B,V,M,U,f[T+15],14,-660478335),U=p(U,B,V,M,f[T+4],20,-405537848),M=p(M,U,B,V,f[T+9],5,568446438),V=p(V,M,U,B,f[T+14],9,-1019803690),B=p(B,V,M,U,f[T+3],14,-187363961),U=p(U,B,V,M,f[T+8],20,1163531501),M=p(M,U,B,V,f[T+13],5,-1444681467),V=p(V,M,U,B,f[T+2],9,-51403784),B=p(B,V,M,U,f[T+7],14,1735328473),U=p(U,B,V,M,f[T+12],20,-1926607734),M=_(M,U,B,V,f[T+5],4,-378558),V=_(V,M,U,B,f[T+8],11,-2022574463),B=_(B,V,M,U,f[T+11],16,1839030562),U=_(U,B,V,M,f[T+14],23,-35309556),M=_(M,U,B,V,f[T+1],4,-1530992060),V=_(V,M,U,B,f[T+4],11,1272893353),B=_(B,V,M,U,f[T+7],16,-155497632),U=_(U,B,V,M,f[T+10],23,-1094730640),M=_(M,U,B,V,f[T+13],4,681279174),V=_(V,M,U,B,f[T+0],11,-358537222),B=_(B,V,M,U,f[T+3],16,-722521979),U=_(U,B,V,M,f[T+6],23,76029189),M=_(M,U,B,V,f[T+9],4,-640364487),V=_(V,M,U,B,f[T+12],11,-421815835),B=_(B,V,M,U,f[T+15],16,530742520),U=_(U,B,V,M,f[T+2],23,-995338651),M=R(M,U,B,V,f[T+0],6,-198630844),V=R(V,M,U,B,f[T+7],10,1126891415),B=R(B,V,M,U,f[T+14],15,-1416354905),U=R(U,B,V,M,f[T+5],21,-57434055),M=R(M,U,B,V,f[T+12],6,1700485571),V=R(V,M,U,B,f[T+3],10,-1894986606),B=R(B,V,M,U,f[T+10],15,-1051523),U=R(U,B,V,M,f[T+1],21,-2054922799),M=R(M,U,B,V,f[T+8],6,1873313359),V=R(V,M,U,B,f[T+15],10,-30611744),B=R(B,V,M,U,f[T+6],15,-1560198380),U=R(U,B,V,M,f[T+13],21,1309151649),M=R(M,U,B,V,f[T+4],6,-145523070),V=R(V,M,U,B,f[T+11],10,-1120210379),B=R(B,V,M,U,f[T+2],15,718787259),U=R(U,B,V,M,f[T+9],21,-343485551),M=d(M,A),U=d(U,N),B=d(B,P),V=d(V,j);return c(M)+c(U)+c(B)+c(V)}(""+t+e)).slice(0,16),r=i.slice(0,12),s=await window.crypto.subtle.importKey("raw",i,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},s,n))},dv=async(n,t,e)=>await qM(n.buffer,t,e);function uv(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function di(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?uv(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):uv(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class Ct extends rn{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==mn.PLAYING)}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,e,i,r,s,o){if(super(t,s),h(this,"trackMediaType","video"),h(this,"_player",void 0),h(this,"isUseScaleResolutionDownBy",!1),h(this,"_videoVisibleTimer",null),h(this,"_statsTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"_encoderConfig",void 0),h(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),h(this,"_optimizationMode",void 0),h(this,"_videoHeight",void 0),h(this,"_videoWidth",void 0),h(this,"_forceBitrateLimit",void 0),h(this,"_enabled",!0),h(this,"processorDestination",void 0),h(this,"_processorContext",void 0),fn()){const{width:a,height:c}=t.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=e,this._scalabilityMode=i,this._optimizationMode=r,this._hints=o||[],this._hints.indexOf($t.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(a,c,d){const u=Lt();return!(u.name!==a||!u.osVersion)&&(d?Number(u.version)>=c&&Number(u.version)<=d:Number(u.version)===c)}(xt.CHROME,115)&&wd().indexOf("Windows")!==-1){const a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&Kt().supportWebRTCInsertableStream){const u=new MediaStreamTrackProcessor(c),l=new MediaStreamTrackGenerator({kind:"video"});let p,_,R=Date.now();const f=()=>{T&&(clearInterval(T),T=void 0),p&&(p.close(),p=void 0),c.stop(),_=void 0,l.removeEventListener("ended",f)};let T=window.setInterval(()=>{if(_&&p&&Date.now()-R>(d??1e3))try{l.readyState==="live"?_.enqueue(p.clone()):f()}catch{f()}},d??1e3);const A=new TransformStream({transform:(N,P)=>{l.readyState==="live"?(_=P,R=Date.now(),p===void 0?(p=N,P.enqueue(N.clone())):(P.enqueue(p),p=N)):N.close()}});return l.addEventListener("ended",f),u.readable.pipeThrough(A).pipeTo(l.writable),l}}(t);a&&(m.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}e&&this._hints.indexOf($t.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(e),this.processorContext=new $C(this.getTrackId(),"local"),this.processorDestination=new ZC(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(m.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}m.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=di(di(di({},this._getDefaultPlayerConfig()),e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new r_(i):this._player=new av(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(as.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},O("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,m.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await Xt(this,tt.NEED_DISABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return e||(this._enabled=!1),void m.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Xt(this,tt.NEED_ENABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,m.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Xt(this,tt.NEED_MUTE_TRACK,this):await Xt(this,tt.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,e){if(!this._enabled)throw new G(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=dr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const i=hu({encoderConfig:t});(fn()||gn()||sr())&&(i.deviceId=void 0),m.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const s=new G(v.UNEXPECTED_ERROR,r.toString());throw m.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=t,this._hints.indexOf($t.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,tt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(m)}}getStats(){return Ja(()=>{m.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Wn(this,tt.GET_STATS)||di({},qp)}async setBeautyEffect(t){m.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,e):await i_(t)}async setBitrateLimit(t){if(m.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await Xt(this,tt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(m)}}}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void m.error(v.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const e=this._optimizationMode;try{this._optimizationMode=t,await Xt(this,tt.SET_OPTIMIZATION_MODE,this)}catch(i){throw this._optimizationMode=e,m.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return m.error(v.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,m.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){cv(this._originMediaStreamTrack).then(t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e}).catch(Md)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new G(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");m.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=dr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf($t.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,tt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(m)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:e,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!e||!i)return;const[r,s]=function(o,a,c,d){let u;const l=200*Math.pow(c/15,.6)*Math.pow(o*a/640/360,.75),p=l;if(d==="STANDARD_BITRATE")u=4*l;else{if(d!=="COMPATIABLE_BITRATE")return;u=2*l}return[Math.floor(u),Math.floor(p)]}(t,e,i,O("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=s,this._encoderConfig.bitrateMax=r,m.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(e,", fps: ").concat(i,"] => [brMax: ").concat(r,", brMin: ").concat(s,"]")))}getVideoElementVisibleStatus(){try{var t,e;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=wS.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new G(v.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new G(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=di(di({},i),dr(t))),i=Ws(i);const r=Qt(8,"track-video-cloned-"),s=new Ct(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,Ws(this._scalabilityMode),this._optimizationMode,r,Ws(this._hints));return t&&i&&s.setEncoderConfiguration(i),m.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(e)),s}async replaceTrack(t,e){if(!(t instanceof MediaStreamTrack))throw new G(v.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new G(v.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,e,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!fn()&&!gn())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,e=ru[t],i=-1,r=Date.now();const s=o=>{o>2||o<0||(r=Date.now(),e=ru[o],this.setSenderConfiguration(e))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const o=this.getStats(),a=Wn(this,tt.GET_RTC_STATS);if(o.sendPackets>0&&a){i===-1&&(i=Date.now());const c=Date.now();if(c-i<1e3||c-r<O("PROFILE_SWITCH_INTERVAL"))return;const d=o.sendFrameRate,u=.6*e.frameRate,l=.9*e.frameRate;typeof d=="number"&&d>0&&d<u?t>0&&(t--,s(t),m.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(d,", switchProfile to ").concat(t))):a.OutgoingAvailableBandwidth<e.bitrateMin?t>0&&(t--,s(t),m.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", bitrateMin ").concat(e.bitrateMin,", switchProfile to ").concat(t))):typeof d=="number"&&d>l&&t<ru.length-1&&a.OutgoingAvailableBandwidth>1.2*ru[t+1].bitrateMin&&(t++,s(t),m.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(d,", OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}},O("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on(_n.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await Xt(this,tt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Xt(this,tt.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(_n.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Mn.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Mn.REQUEST_CONSTRAINTS)}}W([dt({argsMap:(n,t,e)=>[n.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",e]}),me(),S("design:type",Function),S("design:paramtypes",[Object,Object]),S("design:returntype",void 0)],Ct.prototype,"play",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ct.prototype,"stop",null),W([Bo("LocalVideoTrack","_enabledMutex"),dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean,Boolean]),S("design:returntype",F)],Ct.prototype,"setEnabled",null),W([Bo("LocalVideoTrack","_enabledMutex"),dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean]),S("design:returntype",F)],Ct.prototype,"setMuted",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Object,Boolean]),S("design:returntype",F)],Ct.prototype,"setEncoderConfiguration",null),W([me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",Object)],Ct.prototype,"getStats",null),W([dt({argsMap:(n,t,e)=>[n.getTrackId(),t,e]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean,Object]),S("design:returntype",F)],Ct.prototype,"setBeautyEffect",null),W([me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",ImageData)],Ct.prototype,"getCurrentFrameData",null),W([me(),S("design:type",Function),S("design:paramtypes",[String,Number]),S("design:returntype",F)],Ct.prototype,"getCurrentFrameImage",null),W([me(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Ct.prototype,"setBitrateLimit",null),W([me(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Ct.prototype,"setOptimizationMode",null),W([me(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",void 0)],Ct.prototype,"setScalabiltyMode",null),W([me(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ct.prototype,"updateMediaStreamTrackResolution",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t.name]}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",Object)],Ct.prototype,"pipe",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ct.prototype,"unpipe",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ct.prototype,"close",null),W([dt({argsMap:(n,t,e)=>[n.getTrackId(),t.label,e]}),S("design:type",Function),S("design:paramtypes",[MediaStreamTrack,Boolean]),S("design:returntype",F)],Ct.prototype,"replaceTrack",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ct.prototype,"startMonitorStats",null);class ds extends Ct{get __className__(){return"CameraVideoTrack"}constructor(t,e,i,r,s,o){super(t,dr(e.encoderConfig),r,s,o),h(this,"_config",void 0),h(this,"_originalConstraints",void 0),h(this,"_constraints",void 0),h(this,"_enabled",!0),h(this,"_deviceName","default"),h(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Mo()||Hh())&&!function(){const a=Lt();if(a.os!==Ne.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&vS()&&this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=e,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=dr(this._config.encoderConfig),jt.on(xe.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),jt.on(xe.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(m.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const e=await ai.getDeviceById(t),i={};i.video=di({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await oi(i,this.getTrackId())}catch(s){throw m.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await oi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await ai.getDeviceById(t);this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}m.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){m.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const e={video:di(di({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await oi(e,this.getTrackId())}catch(r){throw m.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await oi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=di({},e.video),m.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await oi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await Xt(this,tt.NEED_ENABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),m.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),e||(this._enabled=!1);try{await Xt(this,tt.NEED_DISABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,e){if(!this._enabled)throw new G(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=dr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);const i=Zt(this._config);i.encoderConfig=t;const r=hu(i);(fn()||gn()||sr())&&(r.deviceId=void 0),m.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(s){const o=new G(v.UNEXPECTED_ERROR,s.toString());throw m.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=t,this._hints.indexOf($t.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Xt(this,tt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(m)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((gn()||sr())&&this._enabled&&!this._isClosed&&jt.duringInterruption){const t=async()=>{jt.off(xe.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};jt.on(xe.IOS_INTERRUPTION_END,t)}else m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(as.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=ai.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId={exact:i}),this._enabled){const r=await oi({video:e},this.getTrackId());this._constraints=e,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),jt.off(xe.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),jt.off(xe.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=di(di({},i),dr(t))),i=Ws(i);const r=Qt(8,"track-cam-cloned-"),s=new ds(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,Ws(di(di({},this._config),{},{encoderConfig:i})),Ws(this._constraints),Ws(this._scalabilityMode),this._optimizationMode,r);return t&&i&&s.setEncoderConfiguration(i),m.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(e)),s}bindProcessorContextEvents(){this.processorContext.on(Mn.REQUEST_UPDATE_CONSTRAINTS,async(t,e,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),e()}catch(r){i(r)}}),this.processorContext.on(Mn.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}function lv(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function pu(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?lv(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):lv(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function s_(n,t,e,i){e.optimizationMode&&(i&&i.width&&i.height?(e.encoderConfig=pu(pu({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),e.optimizationMode!=="motion"&&e.optimizationMode!=="detail"||(t.contentHint=e.optimizationMode,t.contentHint===e.optimizationMode?m.debug("[".concat(n,"] set content hint to"),e.optimizationMode):m.debug("[".concat(n,"] set content hint failed")))):m.warning("[".concat(n,"] can not apply optimization mode bitrate config, no encoderConfig")))}function hv(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function _u(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?hv(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):hv(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],ds.prototype,"setDevice",null),W([Bo("CameraVideoTrack","_enabledMutex"),dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Boolean,Boolean]),S("design:returntype",F)],ds.prototype,"setEnabled",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),me(),S("design:type",Function),S("design:paramtypes",[Object,Boolean]),S("design:returntype",F)],ds.prototype,"setEncoderConfiguration",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ds.prototype,"close",null);class pv extends UC{getUserId(){return this._userId}constructor(t,e,i,r){super(t,"track-".concat(t.kind,"-").concat(e,"-").concat(r.clientId,"_").concat(Qt(5,""))),h(this,"_userId",void 0),h(this,"_uintId",void 0),h(this,"_isDestroyed",!1),h(this,"store",void 0),h(this,"processor",void 0),this._userId=e,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,m.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class ur extends pv{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==mn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,r){super(t,e,i,r),h(this,"_videoVisibleTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"trackMediaType","video"),h(this,"_videoWidth",void 0),h(this,"_videoHeight",void 0),h(this,"_player",void 0),h(this,"processorDestination",void 0),h(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new $C(this.getTrackId(),"remote"),this.processorDestination=new ZC(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Ja(()=>{m.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Wn(this,tt.GET_STATS)||_u({},MC)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(m.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}m.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=_u(_u({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new r_(i):this._player=new av(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Xs.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(Xs.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},O("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,m.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){cv(this._originMediaStreamTrack).then(t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e}).catch(Md)}_updatePlayerSource(){m.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=wS.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new G(v.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new G(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(_n.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(_n.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}W([dt({argsMap:(n,t,e)=>[n.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",e]}),S("design:type",Function),S("design:paramtypes",[Object,Object]),S("design:returntype",void 0)],ur.prototype,"play",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ur.prototype,"stop",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t.name]}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",Object)],ur.prototype,"pipe",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ur.prototype,"unpipe",null);class ki extends pv{get isPlaying(){return this._useAudioElement?Un.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,r){super(t,e,i,r),h(this,"trackMediaType","audio"),h(this,"_source",void 0),h(this,"_useAudioElement",!0),h(this,"_volume",100),h(this,"processorContext",void 0),h(this,"processorDestination",void 0),h(this,"_played",!1),h(this,"_bypassWebAudio",!1),O("DISABLE_WEBAUDIO")?(this._source=new t_,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Qp(t,!0),O("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(kn.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Xs.FIRST_FRAME_DECODED)}),this.processorContext=new lu(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new uu(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(kn.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(kn.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(kn.ON_AUDIO_BUFFER),this._source.on(kn.ON_AUDIO_BUFFER,i=>t(i))}setVolume(t){this._volume=t,this._useAudioElement?Un.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!Ka()&&O("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new G(v.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Un.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Ja(()=>{m.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Wn(this,tt.GET_STATS)||_u({},kC)}play(){m.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(m.debug("[".concat(this.getTrackId(),"] use audio element to play")),Un.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){m.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Un.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];m.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Un.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new G(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(_n.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(_n.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(_n.ON_TRACK),this.processorDestination.removeAllListeners(_n.ON_NODE)}}W([dt({argsMap:(n,t)=>[n.getTrackId(),t],throttleTime:300}),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",void 0)],ki.prototype,"setVolume",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t]}),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],ki.prototype,"setPlaybackDevice",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ki.prototype,"play",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ki.prototype,"stop",null),W([dt({argsMap:(n,t)=>[n.getTrackId(),t.name]}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",Object)],ki.prototype,"pipe",null),W([dt({argsMap:n=>[n.getTrackId()]}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],ki.prototype,"unpipe",null);function na(n){let t=n.length;for(;--t>=0;)n[t]=0}const o_=256,_v=286,nc=30,ic=15,a_=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),mu=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),JM=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),mv=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Dr=new Array(576);na(Dr);const rc=new Array(60);na(rc);const sc=new Array(512);na(sc);const oc=new Array(256);na(oc);const c_=new Array(29);na(c_);const Eu=new Array(nc);function d_(n,t,e,i,r){this.static_tree=n,this.extra_bits=t,this.extra_base=e,this.elems=i,this.max_length=r,this.has_stree=n&&n.length}let Ev,fv,gv;function u_(n,t){this.dyn_tree=n,this.max_code=0,this.stat_desc=t}na(Eu);const Tv=n=>n<256?sc[n]:sc[256+(n>>>7)],ac=(n,t)=>{n.pending_buf[n.pending++]=255&t,n.pending_buf[n.pending++]=t>>>8&255},ui=(n,t,e)=>{n.bi_valid>16-e?(n.bi_buf|=t<<n.bi_valid&65535,ac(n,n.bi_buf),n.bi_buf=t>>16-n.bi_valid,n.bi_valid+=e-16):(n.bi_buf|=t<<n.bi_valid&65535,n.bi_valid+=e)},lr=(n,t,e)=>{ui(n,e[2*t],e[2*t+1])},Sv=(n,t)=>{let e=0;do e|=1&n,n>>>=1,e<<=1;while(--t>0);return e>>>1},Rv=(n,t,e)=>{const i=new Array(16);let r,s,o=0;for(r=1;r<=ic;r++)o=o+e[r-1]<<1,i[r]=o;for(s=0;s<=t;s++){let a=n[2*s+1];a!==0&&(n[2*s]=Sv(i[a]++,a))}},Cv=n=>{let t;for(t=0;t<_v;t++)n.dyn_ltree[2*t]=0;for(t=0;t<nc;t++)n.dyn_dtree[2*t]=0;for(t=0;t<19;t++)n.bl_tree[2*t]=0;n.dyn_ltree[512]=1,n.opt_len=n.static_len=0,n.sym_next=n.matches=0},vv=n=>{n.bi_valid>8?ac(n,n.bi_buf):n.bi_valid>0&&(n.pending_buf[n.pending++]=n.bi_buf),n.bi_buf=0,n.bi_valid=0},yv=(n,t,e,i)=>{const r=2*t,s=2*e;return n[r]<n[s]||n[r]===n[s]&&i[t]<=i[e]},l_=(n,t,e)=>{const i=n.heap[e];let r=e<<1;for(;r<=n.heap_len&&(r<n.heap_len&&yv(t,n.heap[r+1],n.heap[r],n.depth)&&r++,!yv(t,i,n.heap[r],n.depth));)n.heap[e]=n.heap[r],e=r,r<<=1;n.heap[e]=i},Iv=(n,t,e)=>{let i,r,s,o,a=0;if(n.sym_next!==0)do i=255&n.pending_buf[n.sym_buf+a++],i+=(255&n.pending_buf[n.sym_buf+a++])<<8,r=n.pending_buf[n.sym_buf+a++],i===0?lr(n,r,t):(s=oc[r],lr(n,s+o_+1,t),o=a_[s],o!==0&&(r-=c_[s],ui(n,r,o)),i--,s=Tv(i),lr(n,s,e),o=mu[s],o!==0&&(i-=Eu[s],ui(n,i,o)));while(a<n.sym_next);lr(n,256,t)},h_=(n,t)=>{const e=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,s=t.stat_desc.elems;let o,a,c,d=-1;for(n.heap_len=0,n.heap_max=573,o=0;o<s;o++)e[2*o]!==0?(n.heap[++n.heap_len]=d=o,n.depth[o]=0):e[2*o+1]=0;for(;n.heap_len<2;)c=n.heap[++n.heap_len]=d<2?++d:0,e[2*c]=1,n.depth[c]=0,n.opt_len--,r&&(n.static_len-=i[2*c+1]);for(t.max_code=d,o=n.heap_len>>1;o>=1;o--)l_(n,e,o);c=s;do o=n.heap[1],n.heap[1]=n.heap[n.heap_len--],l_(n,e,1),a=n.heap[1],n.heap[--n.heap_max]=o,n.heap[--n.heap_max]=a,e[2*c]=e[2*o]+e[2*a],n.depth[c]=(n.depth[o]>=n.depth[a]?n.depth[o]:n.depth[a])+1,e[2*o+1]=e[2*a+1]=c,n.heap[1]=c++,l_(n,e,1);while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],((u,l)=>{const p=l.dyn_tree,_=l.max_code,R=l.stat_desc.static_tree,f=l.stat_desc.has_stree,T=l.stat_desc.extra_bits,A=l.stat_desc.extra_base,N=l.stat_desc.max_length;let P,j,M,U,B,V,q=0;for(U=0;U<=ic;U++)u.bl_count[U]=0;for(p[2*u.heap[u.heap_max]+1]=0,P=u.heap_max+1;P<573;P++)j=u.heap[P],U=p[2*p[2*j+1]+1]+1,U>N&&(U=N,q++),p[2*j+1]=U,j>_||(u.bl_count[U]++,B=0,j>=A&&(B=T[j-A]),V=p[2*j],u.opt_len+=V*(U+B),f&&(u.static_len+=V*(R[2*j+1]+B)));if(q!==0){do{for(U=N-1;u.bl_count[U]===0;)U--;u.bl_count[U]--,u.bl_count[U+1]+=2,u.bl_count[N]--,q-=2}while(q>0);for(U=N;U!==0;U--)for(j=u.bl_count[U];j!==0;)M=u.heap[--P],M>_||(p[2*M+1]!==U&&(u.opt_len+=(U-p[2*M+1])*p[2*M],p[2*M+1]=U),j--)}})(n,t),Rv(e,d,n.bl_count)},Av=(n,t,e)=>{let i,r,s=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),t[2*(e+1)+1]=65535,i=0;i<=e;i++)r=o,o=t[2*(i+1)+1],++a<c&&r===o||(a<d?n.bl_tree[2*r]+=a:r!==0?(r!==s&&n.bl_tree[2*r]++,n.bl_tree[32]++):a<=10?n.bl_tree[34]++:n.bl_tree[36]++,a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4))},bv=(n,t,e)=>{let i,r,s=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),i=0;i<=e;i++)if(r=o,o=t[2*(i+1)+1],!(++a<c&&r===o)){if(a<d)do lr(n,r,n.bl_tree);while(--a!=0);else r!==0?(r!==s&&(lr(n,r,n.bl_tree),a--),lr(n,16,n.bl_tree),ui(n,a-3,2)):a<=10?(lr(n,17,n.bl_tree),ui(n,a-3,3)):(lr(n,18,n.bl_tree),ui(n,a-11,7));a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4)}};let wv=!1;const Ov=(n,t,e,i)=>{ui(n,0+(i?1:0),3),vv(n),ac(n,e),ac(n,~e),e&&n.pending_buf.set(n.window.subarray(t,t+e),n.pending),n.pending+=e};var zM=n=>{wv||((()=>{let t,e,i,r,s;const o=new Array(16);for(i=0,r=0;r<28;r++)for(c_[r]=i,t=0;t<1<<a_[r];t++)oc[i++]=r;for(oc[i-1]=r,s=0,r=0;r<16;r++)for(Eu[r]=s,t=0;t<1<<mu[r];t++)sc[s++]=r;for(s>>=7;r<nc;r++)for(Eu[r]=s<<7,t=0;t<1<<mu[r]-7;t++)sc[256+s++]=r;for(e=0;e<=ic;e++)o[e]=0;for(t=0;t<=143;)Dr[2*t+1]=8,t++,o[8]++;for(;t<=255;)Dr[2*t+1]=9,t++,o[9]++;for(;t<=279;)Dr[2*t+1]=7,t++,o[7]++;for(;t<=287;)Dr[2*t+1]=8,t++,o[8]++;for(Rv(Dr,287,o),t=0;t<nc;t++)rc[2*t+1]=5,rc[2*t]=Sv(t,5);Ev=new d_(Dr,a_,257,_v,ic),fv=new d_(rc,mu,0,nc,ic),gv=new d_(new Array(0),JM,0,19,7)})(),wv=!0),n.l_desc=new u_(n.dyn_ltree,Ev),n.d_desc=new u_(n.dyn_dtree,fv),n.bl_desc=new u_(n.bl_tree,gv),n.bi_buf=0,n.bi_valid=0,Cv(n)},XM=(n,t,e,i)=>{let r,s,o=0;n.level>0?(n.strm.data_type===2&&(n.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<o_;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(n)),h_(n,n.l_desc),h_(n,n.d_desc),o=(a=>{let c;for(Av(a,a.dyn_ltree,a.l_desc.max_code),Av(a,a.dyn_dtree,a.d_desc.max_code),h_(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*mv[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(n),r=n.opt_len+3+7>>>3,s=n.static_len+3+7>>>3,s<=r&&(r=s)):r=s=e+5,e+4<=r&&t!==-1?Ov(n,t,e,i):n.strategy===4||s===r?(ui(n,2+(i?1:0),3),Iv(n,Dr,rc)):(ui(n,4+(i?1:0),3),((a,c,d,u)=>{let l;for(ui(a,c-257,5),ui(a,d-1,5),ui(a,u-4,4),l=0;l<u;l++)ui(a,a.bl_tree[2*mv[l]+1],3);bv(a,a.dyn_ltree,c-1),bv(a,a.dyn_dtree,d-1)})(n,n.l_desc.max_code+1,n.d_desc.max_code+1,o+1),Iv(n,n.dyn_ltree,n.dyn_dtree)),Cv(n),i&&vv(n)},QM=(n,t,e)=>(n.pending_buf[n.sym_buf+n.sym_next++]=t,n.pending_buf[n.sym_buf+n.sym_next++]=t>>8,n.pending_buf[n.sym_buf+n.sym_next++]=e,t===0?n.dyn_ltree[2*e]++:(n.matches++,t--,n.dyn_ltree[2*(oc[e]+o_+1)]++,n.dyn_dtree[2*Tv(t)]++),n.sym_next===n.sym_end),ZM={_tr_init:zM,_tr_stored_block:Ov,_tr_flush_block:XM,_tr_tally:QM,_tr_align:n=>{ui(n,2,3),lr(n,256,Dr),(t=>{t.bi_valid===16?(ac(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(n)}},cc=(n,t,e,i)=>{let r=65535&n|0,s=n>>>16&65535|0,o=0;for(;e!==0;){o=e>2e3?2e3:e,e-=o;do r=r+t[i++]|0,s=s+r|0;while(--o);r%=65521,s%=65521}return r|s<<16|0};const $M=new Uint32Array((()=>{let n,t=[];for(var e=0;e<256;e++){n=e;for(var i=0;i<8;i++)n=1&n?3988292384^n>>>1:n>>>1;t[e]=n}return t})());var An=(n,t,e,i)=>{const r=$M,s=i+e;n^=-1;for(let o=i;o<s;o++)n=n>>>8^r[255&(n^t[o])];return-1^n},to={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ia={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:tU,_tr_stored_block:p_,_tr_flush_block:eU,_tr_tally:us,_tr_align:nU}=ZM,{Z_NO_FLUSH:ls,Z_PARTIAL_FLUSH:iU,Z_FULL_FLUSH:rU,Z_FINISH:Mi,Z_BLOCK:Nv,Z_OK:On,Z_STREAM_END:Dv,Z_STREAM_ERROR:hr,Z_DATA_ERROR:sU,Z_BUF_ERROR:__,Z_DEFAULT_COMPRESSION:oU,Z_FILTERED:aU,Z_HUFFMAN_ONLY:fu,Z_RLE:cU,Z_FIXED:dU,Z_DEFAULT_STRATEGY:uU,Z_UNKNOWN:lU,Z_DEFLATED:gu}=ia,m_=286,hU=30,pU=19,_U=2*m_+1,mU=15,eo=258,pr=262,ra=42,no=113,dc=666,io=(n,t)=>(n.msg=to[t],t),Pv=n=>2*n-(n>4?9:0),hs=n=>{let t=n.length;for(;--t>=0;)n[t]=0},EU=n=>{let t,e,i,r=n.w_size;t=n.hash_size,i=t;do e=n.head[--i],n.head[i]=e>=r?e-r:0;while(--t);t=r,i=t;do e=n.prev[--i],n.prev[i]=e>=r?e-r:0;while(--t)};let ps=(n,t,e)=>(t<<n.hash_shift^e)&n.hash_mask;const Ri=n=>{const t=n.state;let e=t.pending;e>n.avail_out&&(e=n.avail_out),e!==0&&(n.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+e),n.next_out),n.next_out+=e,t.pending_out+=e,n.total_out+=e,n.avail_out-=e,t.pending-=e,t.pending===0&&(t.pending_out=0))},Ci=(n,t)=>{eU(n,n.block_start>=0?n.block_start:-1,n.strstart-n.block_start,t),n.block_start=n.strstart,Ri(n.strm)},he=(n,t)=>{n.pending_buf[n.pending++]=t},uc=(n,t)=>{n.pending_buf[n.pending++]=t>>>8&255,n.pending_buf[n.pending++]=255&t},E_=(n,t,e,i)=>{let r=n.avail_in;return r>i&&(r=i),r===0?0:(n.avail_in-=r,t.set(n.input.subarray(n.next_in,n.next_in+r),e),n.state.wrap===1?n.adler=cc(n.adler,t,r,e):n.state.wrap===2&&(n.adler=An(n.adler,t,r,e)),n.next_in+=r,n.total_in+=r,r)},Lv=(n,t)=>{let e,i,r=n.max_chain_length,s=n.strstart,o=n.prev_length,a=n.nice_match;const c=n.strstart>n.w_size-pr?n.strstart-(n.w_size-pr):0,d=n.window,u=n.w_mask,l=n.prev,p=n.strstart+eo;let _=d[s+o-1],R=d[s+o];n.prev_length>=n.good_match&&(r>>=2),a>n.lookahead&&(a=n.lookahead);do if(e=t,d[e+o]===R&&d[e+o-1]===_&&d[e]===d[s]&&d[++e]===d[s+1]){s+=2,e++;do;while(d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&d[++s]===d[++e]&&s<p);if(i=eo-(p-s),s=p-eo,i>o){if(n.match_start=t,o=i,i>=a)break;_=d[s+o-1],R=d[s+o]}}while((t=l[t&u])>c&&--r!=0);return o<=n.lookahead?o:n.lookahead},sa=n=>{const t=n.w_size;let e,i,r;do{if(i=n.window_size-n.lookahead-n.strstart,n.strstart>=t+(t-pr)&&(n.window.set(n.window.subarray(t,t+t-i),0),n.match_start-=t,n.strstart-=t,n.block_start-=t,n.insert>n.strstart&&(n.insert=n.strstart),EU(n),i+=t),n.strm.avail_in===0)break;if(e=E_(n.strm,n.window,n.strstart+n.lookahead,i),n.lookahead+=e,n.lookahead+n.insert>=3)for(r=n.strstart-n.insert,n.ins_h=n.window[r],n.ins_h=ps(n,n.ins_h,n.window[r+1]);n.insert&&(n.ins_h=ps(n,n.ins_h,n.window[r+3-1]),n.prev[r&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=r,r++,n.insert--,!(n.lookahead+n.insert<3)););}while(n.lookahead<pr&&n.strm.avail_in!==0)},kv=(n,t)=>{let e,i,r,s=n.pending_buf_size-5>n.w_size?n.w_size:n.pending_buf_size-5,o=0,a=n.strm.avail_in;do{if(e=65535,r=n.bi_valid+42>>3,n.strm.avail_out<r||(r=n.strm.avail_out-r,i=n.strstart-n.block_start,e>i+n.strm.avail_in&&(e=i+n.strm.avail_in),e>r&&(e=r),e<s&&(e===0&&t!==Mi||t===ls||e!==i+n.strm.avail_in)))break;o=t===Mi&&e===i+n.strm.avail_in?1:0,p_(n,0,0,o),n.pending_buf[n.pending-4]=e,n.pending_buf[n.pending-3]=e>>8,n.pending_buf[n.pending-2]=~e,n.pending_buf[n.pending-1]=~e>>8,Ri(n.strm),i&&(i>e&&(i=e),n.strm.output.set(n.window.subarray(n.block_start,n.block_start+i),n.strm.next_out),n.strm.next_out+=i,n.strm.avail_out-=i,n.strm.total_out+=i,n.block_start+=i,e-=i),e&&(E_(n.strm,n.strm.output,n.strm.next_out,e),n.strm.next_out+=e,n.strm.avail_out-=e,n.strm.total_out+=e)}while(o===0);return a-=n.strm.avail_in,a&&(a>=n.w_size?(n.matches=2,n.window.set(n.strm.input.subarray(n.strm.next_in-n.w_size,n.strm.next_in),0),n.strstart=n.w_size,n.insert=n.strstart):(n.window_size-n.strstart<=a&&(n.strstart-=n.w_size,n.window.set(n.window.subarray(n.w_size,n.w_size+n.strstart),0),n.matches<2&&n.matches++,n.insert>n.strstart&&(n.insert=n.strstart)),n.window.set(n.strm.input.subarray(n.strm.next_in-a,n.strm.next_in),n.strstart),n.strstart+=a,n.insert+=a>n.w_size-n.insert?n.w_size-n.insert:a),n.block_start=n.strstart),n.high_water<n.strstart&&(n.high_water=n.strstart),o?4:t!==ls&&t!==Mi&&n.strm.avail_in===0&&n.strstart===n.block_start?2:(r=n.window_size-n.strstart,n.strm.avail_in>r&&n.block_start>=n.w_size&&(n.block_start-=n.w_size,n.strstart-=n.w_size,n.window.set(n.window.subarray(n.w_size,n.w_size+n.strstart),0),n.matches<2&&n.matches++,r+=n.w_size,n.insert>n.strstart&&(n.insert=n.strstart)),r>n.strm.avail_in&&(r=n.strm.avail_in),r&&(E_(n.strm,n.window,n.strstart,r),n.strstart+=r,n.insert+=r>n.w_size-n.insert?n.w_size-n.insert:r),n.high_water<n.strstart&&(n.high_water=n.strstart),r=n.bi_valid+42>>3,r=n.pending_buf_size-r>65535?65535:n.pending_buf_size-r,s=r>n.w_size?n.w_size:r,i=n.strstart-n.block_start,(i>=s||(i||t===Mi)&&t!==ls&&n.strm.avail_in===0&&i<=r)&&(e=i>r?r:i,o=t===Mi&&n.strm.avail_in===0&&e===i?1:0,p_(n,n.block_start,e,o),n.block_start+=e,Ri(n.strm)),o?3:1)},f_=(n,t)=>{let e,i;for(;;){if(n.lookahead<pr){if(sa(n),n.lookahead<pr&&t===ls)return 1;if(n.lookahead===0)break}if(e=0,n.lookahead>=3&&(n.ins_h=ps(n,n.ins_h,n.window[n.strstart+3-1]),e=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),e!==0&&n.strstart-e<=n.w_size-pr&&(n.match_length=Lv(n,e)),n.match_length>=3)if(i=us(n,n.strstart-n.match_start,n.match_length-3),n.lookahead-=n.match_length,n.match_length<=n.max_lazy_match&&n.lookahead>=3){n.match_length--;do n.strstart++,n.ins_h=ps(n,n.ins_h,n.window[n.strstart+3-1]),e=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart;while(--n.match_length!=0);n.strstart++}else n.strstart+=n.match_length,n.match_length=0,n.ins_h=n.window[n.strstart],n.ins_h=ps(n,n.ins_h,n.window[n.strstart+1]);else i=us(n,0,n.window[n.strstart]),n.lookahead--,n.strstart++;if(i&&(Ci(n,!1),n.strm.avail_out===0))return 1}return n.insert=n.strstart<2?n.strstart:2,t===Mi?(Ci(n,!0),n.strm.avail_out===0?3:4):n.sym_next&&(Ci(n,!1),n.strm.avail_out===0)?1:2},oa=(n,t)=>{let e,i,r;for(;;){if(n.lookahead<pr){if(sa(n),n.lookahead<pr&&t===ls)return 1;if(n.lookahead===0)break}if(e=0,n.lookahead>=3&&(n.ins_h=ps(n,n.ins_h,n.window[n.strstart+3-1]),e=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart),n.prev_length=n.match_length,n.prev_match=n.match_start,n.match_length=2,e!==0&&n.prev_length<n.max_lazy_match&&n.strstart-e<=n.w_size-pr&&(n.match_length=Lv(n,e),n.match_length<=5&&(n.strategy===aU||n.match_length===3&&n.strstart-n.match_start>4096)&&(n.match_length=2)),n.prev_length>=3&&n.match_length<=n.prev_length){r=n.strstart+n.lookahead-3,i=us(n,n.strstart-1-n.prev_match,n.prev_length-3),n.lookahead-=n.prev_length-1,n.prev_length-=2;do++n.strstart<=r&&(n.ins_h=ps(n,n.ins_h,n.window[n.strstart+3-1]),e=n.prev[n.strstart&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=n.strstart);while(--n.prev_length!=0);if(n.match_available=0,n.match_length=2,n.strstart++,i&&(Ci(n,!1),n.strm.avail_out===0))return 1}else if(n.match_available){if(i=us(n,0,n.window[n.strstart-1]),i&&Ci(n,!1),n.strstart++,n.lookahead--,n.strm.avail_out===0)return 1}else n.match_available=1,n.strstart++,n.lookahead--}return n.match_available&&(i=us(n,0,n.window[n.strstart-1]),n.match_available=0),n.insert=n.strstart<2?n.strstart:2,t===Mi?(Ci(n,!0),n.strm.avail_out===0?3:4):n.sym_next&&(Ci(n,!1),n.strm.avail_out===0)?1:2};function _r(n,t,e,i,r){this.good_length=n,this.max_lazy=t,this.nice_length=e,this.max_chain=i,this.func=r}const lc=[new _r(0,0,0,0,kv),new _r(4,4,8,4,f_),new _r(4,5,16,8,f_),new _r(4,6,32,32,f_),new _r(4,4,16,16,oa),new _r(8,16,32,32,oa),new _r(8,16,128,128,oa),new _r(8,32,128,256,oa),new _r(32,128,258,1024,oa),new _r(32,258,258,4096,oa)];function fU(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=gu,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*_U),this.dyn_dtree=new Uint16Array(2*(2*hU+1)),this.bl_tree=new Uint16Array(2*(2*pU+1)),hs(this.dyn_ltree),hs(this.dyn_dtree),hs(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(mU+1),this.heap=new Uint16Array(2*m_+1),hs(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*m_+1),hs(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const hc=n=>{if(!n)return 1;const t=n.state;return!t||t.strm!==n||t.status!==ra&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==no&&t.status!==dc?1:0},Mv=n=>{if(hc(n))return io(n,hr);n.total_in=n.total_out=0,n.data_type=lU;const t=n.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?ra:no,n.adler=t.wrap===2?0:1,t.last_flush=-2,tU(t),On},Uv=n=>{const t=Mv(n);var e;return t===On&&((e=n.state).window_size=2*e.w_size,hs(e.head),e.max_lazy_match=lc[e.level].max_lazy,e.good_match=lc[e.level].good_length,e.nice_match=lc[e.level].nice_length,e.max_chain_length=lc[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),t},xv=(n,t,e,i,r,s)=>{if(!n)return hr;let o=1;if(t===oU&&(t=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),r<1||r>9||e!==gu||i<8||i>15||t<0||t>9||s<0||s>dU||i===8&&o!==1)return io(n,hr);i===8&&(i=9);const a=new fU;return n.state=a,a.strm=n,a.status=ra,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=s,a.method=e,Uv(n)};var gU=(n,t)=>{if(hc(n)||t>Nv||t<0)return n?io(n,hr):hr;const e=n.state;if(!n.output||n.avail_in!==0&&!n.input||e.status===dc&&t!==Mi)return io(n,n.avail_out===0?__:hr);const i=e.last_flush;if(e.last_flush=t,e.pending!==0){if(Ri(n),n.avail_out===0)return e.last_flush=-1,On}else if(n.avail_in===0&&Pv(t)<=Pv(i)&&t!==Mi)return io(n,__);if(e.status===dc&&n.avail_in!==0)return io(n,__);if(e.status===ra&&e.wrap===0&&(e.status=no),e.status===ra){let r=gu+(e.w_bits-8<<4)<<8,s=-1;if(s=e.strategy>=fu||e.level<2?0:e.level<6?1:e.level===6?2:3,r|=s<<6,e.strstart!==0&&(r|=32),r+=31-r%31,uc(e,r),e.strstart!==0&&(uc(e,n.adler>>>16),uc(e,65535&n.adler)),n.adler=1,e.status=no,Ri(n),e.pending!==0)return e.last_flush=-1,On}if(e.status===57){if(n.adler=0,he(e,31),he(e,139),he(e,8),e.gzhead)he(e,(e.gzhead.text?1:0)+(e.gzhead.hcrc?2:0)+(e.gzhead.extra?4:0)+(e.gzhead.name?8:0)+(e.gzhead.comment?16:0)),he(e,255&e.gzhead.time),he(e,e.gzhead.time>>8&255),he(e,e.gzhead.time>>16&255),he(e,e.gzhead.time>>24&255),he(e,e.level===9?2:e.strategy>=fu||e.level<2?4:0),he(e,255&e.gzhead.os),e.gzhead.extra&&e.gzhead.extra.length&&(he(e,255&e.gzhead.extra.length),he(e,e.gzhead.extra.length>>8&255)),e.gzhead.hcrc&&(n.adler=An(n.adler,e.pending_buf,e.pending,0)),e.gzindex=0,e.status=69;else if(he(e,0),he(e,0),he(e,0),he(e,0),he(e,0),he(e,e.level===9?2:e.strategy>=fu||e.level<2?4:0),he(e,3),e.status=no,Ri(n),e.pending!==0)return e.last_flush=-1,On}if(e.status===69){if(e.gzhead.extra){let r=e.pending,s=(65535&e.gzhead.extra.length)-e.gzindex;for(;e.pending+s>e.pending_buf_size;){let a=e.pending_buf_size-e.pending;if(e.pending_buf.set(e.gzhead.extra.subarray(e.gzindex,e.gzindex+a),e.pending),e.pending=e.pending_buf_size,e.gzhead.hcrc&&e.pending>r&&(n.adler=An(n.adler,e.pending_buf,e.pending-r,r)),e.gzindex+=a,Ri(n),e.pending!==0)return e.last_flush=-1,On;r=0,s-=a}let o=new Uint8Array(e.gzhead.extra);e.pending_buf.set(o.subarray(e.gzindex,e.gzindex+s),e.pending),e.pending+=s,e.gzhead.hcrc&&e.pending>r&&(n.adler=An(n.adler,e.pending_buf,e.pending-r,r)),e.gzindex=0}e.status=73}if(e.status===73){if(e.gzhead.name){let r,s=e.pending;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>s&&(n.adler=An(n.adler,e.pending_buf,e.pending-s,s)),Ri(n),e.pending!==0)return e.last_flush=-1,On;s=0}r=e.gzindex<e.gzhead.name.length?255&e.gzhead.name.charCodeAt(e.gzindex++):0,he(e,r)}while(r!==0);e.gzhead.hcrc&&e.pending>s&&(n.adler=An(n.adler,e.pending_buf,e.pending-s,s)),e.gzindex=0}e.status=91}if(e.status===91){if(e.gzhead.comment){let r,s=e.pending;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>s&&(n.adler=An(n.adler,e.pending_buf,e.pending-s,s)),Ri(n),e.pending!==0)return e.last_flush=-1,On;s=0}r=e.gzindex<e.gzhead.comment.length?255&e.gzhead.comment.charCodeAt(e.gzindex++):0,he(e,r)}while(r!==0);e.gzhead.hcrc&&e.pending>s&&(n.adler=An(n.adler,e.pending_buf,e.pending-s,s))}e.status=103}if(e.status===103){if(e.gzhead.hcrc){if(e.pending+2>e.pending_buf_size&&(Ri(n),e.pending!==0))return e.last_flush=-1,On;he(e,255&n.adler),he(e,n.adler>>8&255),n.adler=0}if(e.status=no,Ri(n),e.pending!==0)return e.last_flush=-1,On}if(n.avail_in!==0||e.lookahead!==0||t!==ls&&e.status!==dc){let r=e.level===0?kv(e,t):e.strategy===fu?((s,o)=>{let a;for(;;){if(s.lookahead===0&&(sa(s),s.lookahead===0)){if(o===ls)return 1;break}if(s.match_length=0,a=us(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,a&&(Ci(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Mi?(Ci(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Ci(s,!1),s.strm.avail_out===0)?1:2})(e,t):e.strategy===cU?((s,o)=>{let a,c,d,u;const l=s.window;for(;;){if(s.lookahead<=eo){if(sa(s),s.lookahead<=eo&&o===ls)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(d=s.strstart-1,c=l[d],c===l[++d]&&c===l[++d]&&c===l[++d])){u=s.strstart+eo;do;while(c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&d<u);s.match_length=eo-(u-d),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(a=us(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(a=us(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),a&&(Ci(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Mi?(Ci(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Ci(s,!1),s.strm.avail_out===0)?1:2})(e,t):lc[e.level].func(e,t);if(r!==3&&r!==4||(e.status=dc),r===1||r===3)return n.avail_out===0&&(e.last_flush=-1),On;if(r===2&&(t===iU?nU(e):t!==Nv&&(p_(e,0,0,!1),t===rU&&(hs(e.head),e.lookahead===0&&(e.strstart=0,e.block_start=0,e.insert=0))),Ri(n),n.avail_out===0))return e.last_flush=-1,On}return t!==Mi?On:e.wrap<=0?Dv:(e.wrap===2?(he(e,255&n.adler),he(e,n.adler>>8&255),he(e,n.adler>>16&255),he(e,n.adler>>24&255),he(e,255&n.total_in),he(e,n.total_in>>8&255),he(e,n.total_in>>16&255),he(e,n.total_in>>24&255)):(uc(e,n.adler>>>16),uc(e,65535&n.adler)),Ri(n),e.wrap>0&&(e.wrap=-e.wrap),e.pending!==0?On:Dv)},TU=(n,t)=>{let e=t.length;if(hc(n))return hr;const i=n.state,r=i.wrap;if(r===2||r===1&&i.status!==ra||i.lookahead)return hr;if(r===1&&(n.adler=cc(n.adler,t,e,0)),i.wrap=0,e>=i.w_size){r===0&&(hs(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(t.subarray(e-i.w_size,e),0),t=c,e=i.w_size}const s=n.avail_in,o=n.next_in,a=n.input;for(n.avail_in=e,n.next_in=0,n.input=t,sa(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=ps(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,sa(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,n.next_in=o,n.input=a,n.avail_in=s,i.wrap=r,On},pc={deflateInit:(n,t)=>xv(n,t,gu,15,8,uU),deflateInit2:xv,deflateReset:Uv,deflateResetKeep:Mv,deflateSetHeader:(n,t)=>hc(n)||n.state.wrap!==2?hr:(n.state.gzhead=t,On),deflate:gU,deflateEnd:n=>{if(hc(n))return hr;const t=n.state.status;return n.state=null,t===no?io(n,sU):On},deflateSetDictionary:TU,deflateInfo:"pako deflate (from Nodeca project)"};const SU=(n,t)=>Object.prototype.hasOwnProperty.call(n,t);var Tu={assign:function(n){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const e=t.shift();if(e){if(typeof e!="object")throw new TypeError(e+"must be non-object");for(const i in e)SU(e,i)&&(n[i]=e[i])}}return n},flattenChunks:n=>{let t=0;for(let i=0,r=n.length;i<r;i++)t+=n[i].length;const e=new Uint8Array(t);for(let i=0,r=0,s=n.length;i<s;i++){let o=n[i];e.set(o,r),r+=o.length}return e}};let Vv=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Vv=!1}const _c=new Uint8Array(256);for(let n=0;n<256;n++)_c[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;_c[254]=_c[254]=1;var mc={string2buf:n=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(n);let t,e,i,r,s,o=n.length,a=0;for(r=0;r<o;r++)e=n.charCodeAt(r),(64512&e)==55296&&r+1<o&&(i=n.charCodeAt(r+1),(64512&i)==56320&&(e=65536+(e-55296<<10)+(i-56320),r++)),a+=e<128?1:e<2048?2:e<65536?3:4;for(t=new Uint8Array(a),s=0,r=0;s<a;r++)e=n.charCodeAt(r),(64512&e)==55296&&r+1<o&&(i=n.charCodeAt(r+1),(64512&i)==56320&&(e=65536+(e-55296<<10)+(i-56320),r++)),e<128?t[s++]=e:e<2048?(t[s++]=192|e>>>6,t[s++]=128|63&e):e<65536?(t[s++]=224|e>>>12,t[s++]=128|e>>>6&63,t[s++]=128|63&e):(t[s++]=240|e>>>18,t[s++]=128|e>>>12&63,t[s++]=128|e>>>6&63,t[s++]=128|63&e);return t},buf2string:(n,t)=>{const e=t||n.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(n.subarray(0,t));let i,r;const s=new Array(2*e);for(r=0,i=0;i<e;){let o=n[i++];if(o<128){s[r++]=o;continue}let a=_c[o];if(a>4)s[r++]=65533,i+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&i<e;)o=o<<6|63&n[i++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&Vv)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(o[d]);return c})(s,r)},utf8border:(n,t)=>{(t=t||n.length)>n.length&&(t=n.length);let e=t-1;for(;e>=0&&(192&n[e])==128;)e--;return e<0||e===0?t:e+_c[n[e]]>t?e:t}},Fv=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Bv=Object.prototype.toString,{Z_NO_FLUSH:RU,Z_SYNC_FLUSH:CU,Z_FULL_FLUSH:vU,Z_FINISH:yU,Z_OK:Su,Z_STREAM_END:IU,Z_DEFAULT_COMPRESSION:AU,Z_DEFAULT_STRATEGY:bU,Z_DEFLATED:wU}=ia;function Ec(n){this.options=Tu.assign({level:AU,method:wU,chunkSize:16384,windowBits:15,memLevel:8,strategy:bU},n||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Fv,this.strm.avail_out=0;let e=pc.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(e!==Su)throw new Error(to[e]);if(t.header&&pc.deflateSetHeader(this.strm,t.header),t.dictionary){let i;if(i=typeof t.dictionary=="string"?mc.string2buf(t.dictionary):Bv.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,e=pc.deflateSetDictionary(this.strm,i),e!==Su)throw new Error(to[e]);this._dict_set=!0}}function g_(n,t){const e=new Ec(t);if(e.push(n,!0),e.err)throw e.msg||to[e.err];return e.result}Ec.prototype.push=function(n,t){const e=this.strm,i=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=t===~~t?t:t===!0?yU:RU,typeof n=="string"?e.input=mc.string2buf(n):Bv.call(n)==="[object ArrayBuffer]"?e.input=new Uint8Array(n):e.input=n,e.next_in=0,e.avail_in=e.input.length;;)if(e.avail_out===0&&(e.output=new Uint8Array(i),e.next_out=0,e.avail_out=i),(s===CU||s===vU)&&e.avail_out<=6)this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;else{if(r=pc.deflate(e,s),r===IU)return e.next_out>0&&this.onData(e.output.subarray(0,e.next_out)),r=pc.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Su;if(e.avail_out!==0){if(s>0&&e.next_out>0)this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;else if(e.avail_in===0)break}else this.onData(e.output)}return!0},Ec.prototype.onData=function(n){this.chunks.push(n)},Ec.prototype.onEnd=function(n){n===Su&&(this.result=Tu.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};var OU={Deflate:Ec,deflate:g_,deflateRaw:function(n,t){return(t=t||{}).raw=!0,g_(n,t)},gzip:function(n,t){return(t=t||{}).gzip=!0,g_(n,t)},constants:ia};const Ru=16209;var NU=function(n,t){let e,i,r,s,o,a,c,d,u,l,p,_,R,f,T,A,N,P,j,M,U,B,V,q;const z=n.state;e=n.next_in,V=n.input,i=e+(n.avail_in-5),r=n.next_out,q=n.output,s=r-(t-n.avail_out),o=r+(n.avail_out-257),a=z.dmax,c=z.wsize,d=z.whave,u=z.wnext,l=z.window,p=z.hold,_=z.bits,R=z.lencode,f=z.distcode,T=(1<<z.lenbits)-1,A=(1<<z.distbits)-1;t:do{_<15&&(p+=V[e++]<<_,_+=8,p+=V[e++]<<_,_+=8),N=R[p&T];e:for(;;){if(P=N>>>24,p>>>=P,_-=P,P=N>>>16&255,P===0)q[r++]=65535&N;else{if(!(16&P)){if(!(64&P)){N=R[(65535&N)+(p&(1<<P)-1)];continue e}if(32&P){z.mode=16191;break t}n.msg="invalid literal/length code",z.mode=Ru;break t}j=65535&N,P&=15,P&&(_<P&&(p+=V[e++]<<_,_+=8),j+=p&(1<<P)-1,p>>>=P,_-=P),_<15&&(p+=V[e++]<<_,_+=8,p+=V[e++]<<_,_+=8),N=f[p&A];n:for(;;){if(P=N>>>24,p>>>=P,_-=P,P=N>>>16&255,!(16&P)){if(!(64&P)){N=f[(65535&N)+(p&(1<<P)-1)];continue n}n.msg="invalid distance code",z.mode=Ru;break t}if(M=65535&N,P&=15,_<P&&(p+=V[e++]<<_,_+=8,_<P&&(p+=V[e++]<<_,_+=8)),M+=p&(1<<P)-1,M>a){n.msg="invalid distance too far back",z.mode=Ru;break t}if(p>>>=P,_-=P,P=r-s,M>P){if(P=M-P,P>d&&z.sane){n.msg="invalid distance too far back",z.mode=Ru;break t}if(U=0,B=l,u===0){if(U+=c-P,P<j){j-=P;do q[r++]=l[U++];while(--P);U=r-M,B=q}}else if(u<P){if(U+=c+u-P,P-=u,P<j){j-=P;do q[r++]=l[U++];while(--P);if(U=0,u<j){P=u,j-=P;do q[r++]=l[U++];while(--P);U=r-M,B=q}}}else if(U+=u-P,P<j){j-=P;do q[r++]=l[U++];while(--P);U=r-M,B=q}for(;j>2;)q[r++]=B[U++],q[r++]=B[U++],q[r++]=B[U++],j-=3;j&&(q[r++]=B[U++],j>1&&(q[r++]=B[U++]))}else{U=r-M;do q[r++]=q[U++],q[r++]=q[U++],q[r++]=q[U++],j-=3;while(j>2);j&&(q[r++]=q[U++],j>1&&(q[r++]=q[U++]))}break}}break}}while(e<i&&r<o);j=_>>3,e-=j,_-=j<<3,p&=(1<<_)-1,n.next_in=e,n.next_out=r,n.avail_in=e<i?i-e+5:5-(e-i),n.avail_out=r<o?o-r+257:257-(r-o),z.hold=p,z.bits=_};const Cu=15,DU=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),PU=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),LU=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),kU=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var fc=(n,t,e,i,r,s,o,a)=>{const c=a.bits;let d,u,l,p,_,R,f=0,T=0,A=0,N=0,P=0,j=0,M=0,U=0,B=0,V=0,q=null;const z=new Uint16Array(16),mt=new Uint16Array(16);let Rt,te,we,ie=null;for(f=0;f<=Cu;f++)z[f]=0;for(T=0;T<i;T++)z[t[e+T]]++;for(P=c,N=Cu;N>=1&&z[N]===0;N--);if(P>N&&(P=N),N===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(A=1;A<N&&z[A]===0;A++);for(P<A&&(P=A),U=1,f=1;f<=Cu;f++)if(U<<=1,U-=z[f],U<0)return-1;if(U>0&&(n===0||N!==1))return-1;for(mt[1]=0,f=1;f<Cu;f++)mt[f+1]=mt[f]+z[f];for(T=0;T<i;T++)t[e+T]!==0&&(o[mt[t[e+T]]++]=T);if(n===0?(q=ie=o,R=20):n===1?(q=DU,ie=PU,R=257):(q=LU,ie=kU,R=0),V=0,T=0,f=A,_=s,j=P,M=0,l=-1,B=1<<P,p=B-1,n===1&&B>852||n===2&&B>592)return 1;for(;;){Rt=f-M,o[T]+1<R?(te=0,we=o[T]):o[T]>=R?(te=ie[o[T]-R],we=q[o[T]-R]):(te=96,we=0),d=1<<f-M,u=1<<j,A=u;do u-=d,r[_+(V>>M)+u]=Rt<<24|te<<16|we|0;while(u!==0);for(d=1<<f-1;V&d;)d>>=1;if(d!==0?(V&=d-1,V+=d):V=0,T++,--z[f]==0){if(f===N)break;f=t[e+o[T]]}if(f>P&&(V&p)!==l){for(M===0&&(M=P),_+=A,j=f-M,U=1<<j;j+M<N&&(U-=z[j+M],!(U<=0));)j++,U<<=1;if(B+=1<<j,n===1&&B>852||n===2&&B>592)return 1;l=V&p,r[l]=P<<24|j<<16|_-s|0}}return V!==0&&(r[_+V]=f-M<<24|64<<16|0),a.bits=P,0};const{Z_FINISH:jv,Z_BLOCK:MU,Z_TREES:vu,Z_OK:ro,Z_STREAM_END:UU,Z_NEED_DICT:xU,Z_STREAM_ERROR:Ui,Z_DATA_ERROR:Gv,Z_MEM_ERROR:Wv,Z_BUF_ERROR:VU,Z_DEFLATED:Hv}=ia,yu=16180,Iu=16190,Pr=16191,T_=16192,S_=16194,Au=16199,bu=16200,R_=16206,Ye=16209,Kv=n=>(n>>>24&255)+(n>>>8&65280)+((65280&n)<<8)+((255&n)<<24);function FU(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const so=n=>{if(!n)return 1;const t=n.state;return!t||t.strm!==n||t.mode<yu||t.mode>16211?1:0},Yv=n=>{if(so(n))return Ui;const t=n.state;return n.total_in=n.total_out=t.total=0,n.msg="",t.wrap&&(n.adler=1&t.wrap),t.mode=yu,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,ro},qv=n=>{if(so(n))return Ui;const t=n.state;return t.wsize=0,t.whave=0,t.wnext=0,Yv(n)},Jv=(n,t)=>{let e;if(so(n))return Ui;const i=n.state;return t<0?(e=0,t=-t):(e=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Ui:(i.window!==null&&i.wbits!==t&&(i.window=null),i.wrap=e,i.wbits=t,qv(n))},zv=(n,t)=>{if(!n)return Ui;const e=new FU;n.state=e,e.strm=n,e.window=null,e.mode=yu;const i=Jv(n,t);return i!==ro&&(n.state=null),i};let C_,v_,Xv=!0;const BU=n=>{if(Xv){C_=new Int32Array(512),v_=new Int32Array(32);let t=0;for(;t<144;)n.lens[t++]=8;for(;t<256;)n.lens[t++]=9;for(;t<280;)n.lens[t++]=7;for(;t<288;)n.lens[t++]=8;for(fc(1,n.lens,0,288,C_,0,n.work,{bits:9}),t=0;t<32;)n.lens[t++]=5;fc(2,n.lens,0,32,v_,0,n.work,{bits:5}),Xv=!1}n.lencode=C_,n.lenbits=9,n.distcode=v_,n.distbits=5},Qv=(n,t,e,i)=>{let r;const s=n.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(s.window.set(t.subarray(e-s.wsize,e),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>i&&(r=i),s.window.set(t.subarray(e-i,e-i+r),s.wnext),(i-=r)?(s.window.set(t.subarray(e-i,e),0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var jU=(n,t)=>{let e,i,r,s,o,a,c,d,u,l,p,_,R,f,T,A,N,P,j,M,U,B,V=0;const q=new Uint8Array(4);let z,mt;const Rt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(so(n)||!n.output||!n.input&&n.avail_in!==0)return Ui;e=n.state,e.mode===Pr&&(e.mode=T_),o=n.next_out,r=n.output,c=n.avail_out,s=n.next_in,i=n.input,a=n.avail_in,d=e.hold,u=e.bits,l=a,p=c,B=ro;t:for(;;)switch(e.mode){case yu:if(e.wrap===0){e.mode=T_;break}for(;u<16;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(2&e.wrap&&d===35615){e.wbits===0&&(e.wbits=15),e.check=0,q[0]=255&d,q[1]=d>>>8&255,e.check=An(e.check,q,2,0),d=0,u=0,e.mode=16181;break}if(e.head&&(e.head.done=!1),!(1&e.wrap)||(((255&d)<<8)+(d>>8))%31){n.msg="incorrect header check",e.mode=Ye;break}if((15&d)!==Hv){n.msg="unknown compression method",e.mode=Ye;break}if(d>>>=4,u-=4,U=8+(15&d),e.wbits===0&&(e.wbits=U),U>15||U>e.wbits){n.msg="invalid window size",e.mode=Ye;break}e.dmax=1<<e.wbits,e.flags=0,n.adler=e.check=1,e.mode=512&d?16189:Pr,d=0,u=0;break;case 16181:for(;u<16;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(e.flags=d,(255&e.flags)!==Hv){n.msg="unknown compression method",e.mode=Ye;break}if(57344&e.flags){n.msg="unknown header flags set",e.mode=Ye;break}e.head&&(e.head.text=d>>8&1),512&e.flags&&4&e.wrap&&(q[0]=255&d,q[1]=d>>>8&255,e.check=An(e.check,q,2,0)),d=0,u=0,e.mode=16182;case 16182:for(;u<32;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.head&&(e.head.time=d),512&e.flags&&4&e.wrap&&(q[0]=255&d,q[1]=d>>>8&255,q[2]=d>>>16&255,q[3]=d>>>24&255,e.check=An(e.check,q,4,0)),d=0,u=0,e.mode=16183;case 16183:for(;u<16;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.head&&(e.head.xflags=255&d,e.head.os=d>>8),512&e.flags&&4&e.wrap&&(q[0]=255&d,q[1]=d>>>8&255,e.check=An(e.check,q,2,0)),d=0,u=0,e.mode=16184;case 16184:if(1024&e.flags){for(;u<16;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.length=d,e.head&&(e.head.extra_len=d),512&e.flags&&4&e.wrap&&(q[0]=255&d,q[1]=d>>>8&255,e.check=An(e.check,q,2,0)),d=0,u=0}else e.head&&(e.head.extra=null);e.mode=16185;case 16185:if(1024&e.flags&&(_=e.length,_>a&&(_=a),_&&(e.head&&(U=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Uint8Array(e.head.extra_len)),e.head.extra.set(i.subarray(s,s+_),U)),512&e.flags&&4&e.wrap&&(e.check=An(e.check,i,_,s)),a-=_,s+=_,e.length-=_),e.length))break t;e.length=0,e.mode=16186;case 16186:if(2048&e.flags){if(a===0)break t;_=0;do U=i[s+_++],e.head&&U&&e.length<65536&&(e.head.name+=String.fromCharCode(U));while(U&&_<a);if(512&e.flags&&4&e.wrap&&(e.check=An(e.check,i,_,s)),a-=_,s+=_,U)break t}else e.head&&(e.head.name=null);e.length=0,e.mode=16187;case 16187:if(4096&e.flags){if(a===0)break t;_=0;do U=i[s+_++],e.head&&U&&e.length<65536&&(e.head.comment+=String.fromCharCode(U));while(U&&_<a);if(512&e.flags&&4&e.wrap&&(e.check=An(e.check,i,_,s)),a-=_,s+=_,U)break t}else e.head&&(e.head.comment=null);e.mode=16188;case 16188:if(512&e.flags){for(;u<16;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(4&e.wrap&&d!==(65535&e.check)){n.msg="header crc mismatch",e.mode=Ye;break}d=0,u=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),n.adler=e.check=0,e.mode=Pr;break;case 16189:for(;u<32;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}n.adler=e.check=Kv(d),d=0,u=0,e.mode=Iu;case Iu:if(e.havedict===0)return n.next_out=o,n.avail_out=c,n.next_in=s,n.avail_in=a,e.hold=d,e.bits=u,xU;n.adler=e.check=1,e.mode=Pr;case Pr:if(t===MU||t===vu)break t;case T_:if(e.last){d>>>=7&u,u-=7&u,e.mode=R_;break}for(;u<3;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}switch(e.last=1&d,d>>>=1,u-=1,3&d){case 0:e.mode=16193;break;case 1:if(BU(e),e.mode=Au,t===vu){d>>>=2,u-=2;break t}break;case 2:e.mode=16196;break;case 3:n.msg="invalid block type",e.mode=Ye}d>>>=2,u-=2;break;case 16193:for(d>>>=7&u,u-=7&u;u<32;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if((65535&d)!=(d>>>16^65535)){n.msg="invalid stored block lengths",e.mode=Ye;break}if(e.length=65535&d,d=0,u=0,e.mode=S_,t===vu)break t;case S_:e.mode=16195;case 16195:if(_=e.length,_){if(_>a&&(_=a),_>c&&(_=c),_===0)break t;r.set(i.subarray(s,s+_),o),a-=_,s+=_,c-=_,o+=_,e.length-=_;break}e.mode=Pr;break;case 16196:for(;u<14;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(e.nlen=257+(31&d),d>>>=5,u-=5,e.ndist=1+(31&d),d>>>=5,u-=5,e.ncode=4+(15&d),d>>>=4,u-=4,e.nlen>286||e.ndist>30){n.msg="too many length or distance symbols",e.mode=Ye;break}e.have=0,e.mode=16197;case 16197:for(;e.have<e.ncode;){for(;u<3;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.lens[Rt[e.have++]]=7&d,d>>>=3,u-=3}for(;e.have<19;)e.lens[Rt[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,z={bits:e.lenbits},B=fc(0,e.lens,0,19,e.lencode,0,e.work,z),e.lenbits=z.bits,B){n.msg="invalid code lengths set",e.mode=Ye;break}e.have=0,e.mode=16198;case 16198:for(;e.have<e.nlen+e.ndist;){for(;V=e.lencode[d&(1<<e.lenbits)-1],T=V>>>24,A=V>>>16&255,N=65535&V,!(T<=u);){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(N<16)d>>>=T,u-=T,e.lens[e.have++]=N;else{if(N===16){for(mt=T+2;u<mt;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(d>>>=T,u-=T,e.have===0){n.msg="invalid bit length repeat",e.mode=Ye;break}U=e.lens[e.have-1],_=3+(3&d),d>>>=2,u-=2}else if(N===17){for(mt=T+3;u<mt;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}d>>>=T,u-=T,U=0,_=3+(7&d),d>>>=3,u-=3}else{for(mt=T+7;u<mt;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}d>>>=T,u-=T,U=0,_=11+(127&d),d>>>=7,u-=7}if(e.have+_>e.nlen+e.ndist){n.msg="invalid bit length repeat",e.mode=Ye;break}for(;_--;)e.lens[e.have++]=U}}if(e.mode===Ye)break;if(e.lens[256]===0){n.msg="invalid code -- missing end-of-block",e.mode=Ye;break}if(e.lenbits=9,z={bits:e.lenbits},B=fc(1,e.lens,0,e.nlen,e.lencode,0,e.work,z),e.lenbits=z.bits,B){n.msg="invalid literal/lengths set",e.mode=Ye;break}if(e.distbits=6,e.distcode=e.distdyn,z={bits:e.distbits},B=fc(2,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,z),e.distbits=z.bits,B){n.msg="invalid distances set",e.mode=Ye;break}if(e.mode=Au,t===vu)break t;case Au:e.mode=bu;case bu:if(a>=6&&c>=258){n.next_out=o,n.avail_out=c,n.next_in=s,n.avail_in=a,e.hold=d,e.bits=u,NU(n,p),o=n.next_out,r=n.output,c=n.avail_out,s=n.next_in,i=n.input,a=n.avail_in,d=e.hold,u=e.bits,e.mode===Pr&&(e.back=-1);break}for(e.back=0;V=e.lencode[d&(1<<e.lenbits)-1],T=V>>>24,A=V>>>16&255,N=65535&V,!(T<=u);){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(A&&!(240&A)){for(P=T,j=A,M=N;V=e.lencode[M+((d&(1<<P+j)-1)>>P)],T=V>>>24,A=V>>>16&255,N=65535&V,!(P+T<=u);){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}d>>>=P,u-=P,e.back+=P}if(d>>>=T,u-=T,e.back+=T,e.length=N,A===0){e.mode=16205;break}if(32&A){e.back=-1,e.mode=Pr;break}if(64&A){n.msg="invalid literal/length code",e.mode=Ye;break}e.extra=15&A,e.mode=16201;case 16201:if(e.extra){for(mt=e.extra;u<mt;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.length+=d&(1<<e.extra)-1,d>>>=e.extra,u-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=16202;case 16202:for(;V=e.distcode[d&(1<<e.distbits)-1],T=V>>>24,A=V>>>16&255,N=65535&V,!(T<=u);){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(!(240&A)){for(P=T,j=A,M=N;V=e.distcode[M+((d&(1<<P+j)-1)>>P)],T=V>>>24,A=V>>>16&255,N=65535&V,!(P+T<=u);){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}d>>>=P,u-=P,e.back+=P}if(d>>>=T,u-=T,e.back+=T,64&A){n.msg="invalid distance code",e.mode=Ye;break}e.offset=N,e.extra=15&A,e.mode=16203;case 16203:if(e.extra){for(mt=e.extra;u<mt;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}e.offset+=d&(1<<e.extra)-1,d>>>=e.extra,u-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){n.msg="invalid distance too far back",e.mode=Ye;break}e.mode=16204;case 16204:if(c===0)break t;if(_=p-c,e.offset>_){if(_=e.offset-_,_>e.whave&&e.sane){n.msg="invalid distance too far back",e.mode=Ye;break}_>e.wnext?(_-=e.wnext,R=e.wsize-_):R=e.wnext-_,_>e.length&&(_=e.length),f=e.window}else f=r,R=o-e.offset,_=e.length;_>c&&(_=c),c-=_,e.length-=_;do r[o++]=f[R++];while(--_);e.length===0&&(e.mode=bu);break;case 16205:if(c===0)break t;r[o++]=e.length,c--,e.mode=bu;break;case R_:if(e.wrap){for(;u<32;){if(a===0)break t;a--,d|=i[s++]<<u,u+=8}if(p-=c,n.total_out+=p,e.total+=p,4&e.wrap&&p&&(n.adler=e.check=e.flags?An(e.check,r,p,o-p):cc(e.check,r,p,o-p)),p=c,4&e.wrap&&(e.flags?d:Kv(d))!==e.check){n.msg="incorrect data check",e.mode=Ye;break}d=0,u=0}e.mode=16207;case 16207:if(e.wrap&&e.flags){for(;u<32;){if(a===0)break t;a--,d+=i[s++]<<u,u+=8}if(4&e.wrap&&d!==(4294967295&e.total)){n.msg="incorrect length check",e.mode=Ye;break}d=0,u=0}e.mode=16208;case 16208:B=UU;break t;case Ye:B=Gv;break t;case 16210:return Wv;default:return Ui}return n.next_out=o,n.avail_out=c,n.next_in=s,n.avail_in=a,e.hold=d,e.bits=u,(e.wsize||p!==n.avail_out&&e.mode<Ye&&(e.mode<R_||t!==jv))&&Qv(n,n.output,n.next_out,p-n.avail_out),l-=n.avail_in,p-=n.avail_out,n.total_in+=l,n.total_out+=p,e.total+=p,4&e.wrap&&p&&(n.adler=e.check=e.flags?An(e.check,r,p,n.next_out-p):cc(e.check,r,p,n.next_out-p)),n.data_type=e.bits+(e.last?64:0)+(e.mode===Pr?128:0)+(e.mode===Au||e.mode===S_?256:0),(l===0&&p===0||t===jv)&&B===ro&&(B=VU),B},Lr={inflateReset:qv,inflateReset2:Jv,inflateResetKeep:Yv,inflateInit:n=>zv(n,15),inflateInit2:zv,inflate:jU,inflateEnd:n=>{if(so(n))return Ui;let t=n.state;return t.window&&(t.window=null),n.state=null,ro},inflateGetHeader:(n,t)=>{if(so(n))return Ui;const e=n.state;return 2&e.wrap?(e.head=t,t.done=!1,ro):Ui},inflateSetDictionary:(n,t)=>{const e=t.length;let i,r,s;return so(n)?Ui:(i=n.state,i.wrap!==0&&i.mode!==Iu?Ui:i.mode===Iu&&(r=1,r=cc(r,t,e,0),r!==i.check)?Gv:(s=Qv(n,t,e,e),s?(i.mode=16210,Wv):(i.havedict=1,ro)))},inflateInfo:"pako inflate (from Nodeca project)"},GU=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Zv=Object.prototype.toString,{Z_NO_FLUSH:WU,Z_FINISH:HU,Z_OK:gc,Z_STREAM_END:y_,Z_NEED_DICT:I_,Z_STREAM_ERROR:KU,Z_DATA_ERROR:$v,Z_MEM_ERROR:YU}=ia;function Tc(n){this.options=Tu.assign({chunkSize:65536,windowBits:15,to:""},n||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||n&&n.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Fv,this.strm.avail_out=0;let e=Lr.inflateInit2(this.strm,t.windowBits);if(e!==gc)throw new Error(to[e]);if(this.header=new GU,Lr.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=mc.string2buf(t.dictionary):Zv.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=Lr.inflateSetDictionary(this.strm,t.dictionary),e!==gc)))throw new Error(to[e])}function A_(n,t){const e=new Tc(t);if(e.push(n),e.err)throw e.msg||to[e.err];return e.result}Tc.prototype.push=function(n,t){const e=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=t===~~t?t:t===!0?HU:WU,Zv.call(n)==="[object ArrayBuffer]"?e.input=new Uint8Array(n):e.input=n,e.next_in=0,e.avail_in=e.input.length;;){for(e.avail_out===0&&(e.output=new Uint8Array(i),e.next_out=0,e.avail_out=i),s=Lr.inflate(e,o),s===I_&&r&&(s=Lr.inflateSetDictionary(e,r),s===gc?s=Lr.inflate(e,o):s===$v&&(s=I_));e.avail_in>0&&s===y_&&e.state.wrap>0&&n[e.next_in]!==0;)Lr.inflateReset(e),s=Lr.inflate(e,o);switch(s){case KU:case $v:case I_:case YU:return this.onEnd(s),this.ended=!0,!1}if(a=e.avail_out,e.next_out&&(e.avail_out===0||s===y_))if(this.options.to==="string"){let c=mc.utf8border(e.output,e.next_out),d=e.next_out-c,u=mc.buf2string(e.output,c);e.next_out=d,e.avail_out=i-d,d&&e.output.set(e.output.subarray(c,c+d),0),this.onData(u)}else this.onData(e.output.length===e.next_out?e.output:e.output.subarray(0,e.next_out));if(s!==gc||a!==0){if(s===y_)return s=Lr.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(e.avail_in===0)break}}return!0},Tc.prototype.onData=function(n){this.chunks.push(n)},Tc.prototype.onEnd=function(n){n===gc&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Tu.flattenChunks(this.chunks)),this.chunks=[],this.err=n,this.msg=this.strm.msg};var qU={Inflate:Tc,inflate:A_,inflateRaw:function(n,t){return(t=t||{}).raw=!0,A_(n,t)},ungzip:A_,constants:ia};const{Deflate:$F,deflate:JU,deflateRaw:tB,gzip:eB}=OU,{Inflate:nB,inflate:zU,inflateRaw:iB,ungzip:rB}=qU;var b_,XU=JU,QU=zU;(function(n){n[n.ONE_BYTE=0]="ONE_BYTE",n[n.TWO_BYTE=1]="TWO_BYTE"})(b_||(b_={}));class ZU{constructor(){h(this,"_sequence",0),h(this,"_startTime",Date.now()),h(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const e={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};e.commonPacketHeader.extension=1,e.extension=d,e.payload=this.compress(t),e.commonPacketHeader.length=8+(e.extension.length+2)+e.payload.byteLength}else e.commonPacketHeader.length=8+e.payload.byteLength;O("SHOW_DATASTREAM2_LOG")&&m.debug("send data header: ".concat(JSON.stringify(e.commonPacketHeader)));const i=new ArrayBuffer(e.commonPacketHeader.length),r=new Uint8Array(i),s=new DataView(i);let o=0;if(s.setUint16(o,e.commonPacketHeader.extension<<15|e.commonPacketHeader.reserved<<14|e.commonPacketHeader.length,!0),o+=2,s.setUint32(o,e.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,e.commonStreamHeader,!0),o+=2,e.extension){const a=this.serializeExtension(e.extension);r.set(new Uint8Array(a),o),o+=a.byteLength}if(r.set(new Uint8Array(e.payload),o),o+=e.payload.byteLength,o!==e.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const e=new DataView(t);let i=0;const r=e.getUint16(i,!0);i+=2;const s={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:e.getUint16(i+2,!0)<<16|e.getUint16(i,!0)};let o,a;if(i+=4,O("SHOW_DATASTREAM2_LOG")&&m.debug("receive data header: ".concat(JSON.stringify(s))),e.getUint16(i,!0),i+=2,s.extension){a=this.deserializeExtension(t.slice(i)),i+=2+a.length,o=t.slice(i);let c=!1;if(a.datas.length>0){const d=a.datas.find(u=>u.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}o=c?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:e,length:i,datas:r}=t,s=new ArrayBuffer(i+2),o=new Uint8Array(s),a=new DataView(s);let c=0;if(a.setUint8(c++,e),a.setUint8(c++,i),r.forEach(d=>{e?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return s}deserializeExtension(t){const e=new DataView(t);let i=0;const r=e.getUint8(i);i++;const s=e.getUint8(i);i++;const o=r===b_.TWO_BYTE,a=[],c=new DataView(t,2);let d=0;for(;d<s;){let u=0,l=0,p=new ArrayBuffer(0);o?(u=c.getUint8(d),d++,l=c.getUint8(d),d++):(u=15&c.getUint8(d),l=c.getUint8(d)>>4,d++),l>0&&(p=c.buffer.slice(d+2,d+2+l),d+=p.byteLength),a.push({id:u,length:l,data:p})}if(d!==s)throw Error("parse error");return{profile:r,length:s,datas:a}}decompress(t){return QU(new Uint8Array(t))}compress(t){return XU(new Uint8Array(t))}}class ty extends se{constructor(t,e){super(),h(this,"_version",1),h(this,"_type",3),h(this,"_config",void 0),h(this,"_originDataChannel",void 0),h(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),h(this,"_dataStreamPacketHandler",void 0),h(this,"_datachannelEventMap",new Map),this._config=t,e&&(this._originDataChannel=e,this._bandDataChannelEvents(e)),this._initPacketHeader(),this._dataStreamPacketHandler=new ZU}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return O("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,e;return(t=(e=this._originDataChannel)===null||e===void 0?void 0:e.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,e;return(t=(e=this._originDataChannel)===null||e===void 0?void 0:e.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new F((t,e)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const i=setTimeout(()=>{var r;e(new G(v.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new G(v.DATACHANNEL_CONNECTION_TIMEOUT)}}else e(new G(v.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Zo.OPEN,Zo.CLOSE,Zo.ERROR].forEach(e=>{const i=()=>{this.emit(e)};this._datachannelEventMap.set(e,i),t.addEventListener(e,i)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(e=>{let[i,r]=e;t.removeEventListener(i,r)}),this._datachannelEventMap.clear()}}class $U extends ty{constructor(t){super(t),h(this,"_messageListener",void 0),this._messageListener=e=>{if(e.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=e.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(O("SHOW_DATASTREAM2_LOG")&&m.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let s=e.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(Zo.MESSAGE,s)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class ey extends ty{send(t){if(this._originDataChannel){let e=t;e=this._dataStreamPacketHandler.serialize(t);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+e.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(e),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}(function(){const n=Lt();pn.getDisplayMedia=function(t){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),pn.getStreamFromExtension=n.name===xt.CHROME&&Number(n.version)>34,pn.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let e=!1;try{t.addTransceiver("audio"),e=!0}catch{}return t.close(),e}(),pn.supportMinBitrate=n.name===xt.CHROME||n.name===xt.EDGE,pn.supportSetRtpSenderParameters=function(){const t=Lt();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!Jr()||!(!fn()&&!Od())||t.name===xt.FIREFOX&&Number(t.version)>=64}(),n.name===xt.SAFARI&&(Number(n.version)>=14?pn.supportDualStream=!0:pn.supportDualStream=!1),pn.webAudioMediaStreamDest=function(){const t=Lt();return!(t.name===xt.SAFARI&&Number(t.version)<12)}(),pn.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),pn.supportWebGL=typeof WebGLRenderingContext<"u",pn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Jr()||(pn.webAudioWithAEC=!0),pn.supportShareAudio=function(){const t=Lt();return(t.os===Ne.WIN_10||t.os===Ne.WIN_81||t.os===Ne.WIN_7||t.os===Ne.LINUX||t.os===Ne.MAC_OS||t.os===Ne.CHROMIUM_OS)&&t.name===xt.CHROME&&Number(t.version)>=74}(),pn.supportDataChannel=function(){return!!(Wh(76)||function(t){const e=Lt();return!(e.name!==xt.FIREFOX||!e.osVersion)&&Number(e.version)>=t}(68)||function(t){const e=Lt();return!(e.name!==xt.SAFARI||!e.osVersion)&&Number(e.version)>=t}(14))}(),pn.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!Jt()&&!!t&&t.prototype.setConfiguration instanceof Function}(),pn.supportWebRTCEncodedTransform=function(){const t=Lt();return t.name==="Chrome"&&Number(t.version)>=86}(),pn.supportWebRTCInsertableStream=function(){const t=Lt();return(t.name===xt.CHROME||t.name===xt.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Ld(()=>{pn.supportDualStreamEncoding=function(){const t=Lt();return O("DISABLE_WEBAUDIO")?!0:t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&O("CHROME_DUAL_STREAM_USE_ENCODING"))}(),m.info("browser compatibility",JSON.stringify(pn),JSON.stringify(n))})})();class t2 extends se{constructor(){super(...arguments),h(this,"resultStorage",new Map)}setLocalAudioStats(t,e,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,e)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,e))}setLocalVideoStats(t,e,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,e)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,e)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i))}setRemoteAudioStats(t,e){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(e))}setRemoteVideoStats(t,e){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(e))}record(t,e,i){if(O("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(t);if(r&&(r.result.push(i),r.result.length>=5)){var s;const o=nt(s=r.result).call(s,!0);r.isPrevNormal&&!o&&this.emit("exception",ny[t],t,e),!r.isPrevNormal&&o&&this.emit("exception",ny[t]+2e3,t+"_RECOVER",e),r.isPrevNormal=o,r.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,e){return e instanceof ve&&!e.isActive||!!e.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,e){let i=null;e._encoderConfig&&e._encoderConfig.frameRate&&(i=ri(e._encoderConfig.frameRate));const r=t.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,e){return!!e.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,e){return e instanceof ve&&!e.isActive||!!e.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const ny={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},sn=new class{markSubscribeStart(n,t){performance.mark("agora-web-sdk/".concat(n,"/subscribe-").concat(t))}markPublishStart(n,t){performance.mark("agora-web-sdk/".concat(n,"/publish-").concat(t))}measureFromSubscribeStart(n,t){const e=performance.getEntriesByName("agora-web-sdk/".concat(n,"/subscribe-").concat(t));if(e.length>0){const i=e[e.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(n,t){const e=performance.getEntriesByName("agora-web-sdk/".concat(n,"/publish-").concat(t));if(e.length>0){const i=e[e.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function w_(n,t){this.v=n,this.k=t}function St(n){return new w_(n,0)}var e2=ES,n2=ir;le({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var n=n2.f(this);return{promise:n.promise,resolve:n.resolve,reject:n.reject}}});var i2=ir,r2=Po;le({target:"Promise",stat:!0,forced:!0},{try:function(n){var t=i2.f(this),e=r2(n);return(e.error?t.reject:t.resolve)(e.value),t.promise}});var O_=b(e2),iy=Co.f("asyncIterator"),s2=b(iy);function Sc(n){var t,e;function i(s,o){try{var a=n[s](o),c=a.value,d=c instanceof w_;O_.resolve(d?c.v:c).then(function(u){if(d){var l=s==="return"?"return":"next";if(!c.k||u.done)return i(l,u);u=n[l](u).value}r(a.done?"return":"normal",u)},function(u){i("throw",u)})}catch(u){r("throw",u)}}function r(s,o){switch(s){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?i(t.key,t.arg):e=null}this._invoke=function(s,o){return new O_(function(a,c){var d={key:s,arg:o,resolve:a,reject:c,next:null};e?e=e.next=d:(t=e=d,i(s,o))})},typeof n.return!="function"&&(this.return=void 0)}function Kn(n){return function(){return new Sc(n.apply(this,arguments))}}Sc.prototype[typeof wo=="function"&&s2||"@@asyncIterator"]=function(){return this},Sc.prototype.next=function(n){return this._invoke("next",n)},Sc.prototype.throw=function(n){return this._invoke("throw",n)},Sc.prototype.return=function(n){return this._invoke("return",n)};var ry=b(Tr.Object.getOwnPropertySymbols),o2=le,a2=_l.indexOf,c2=dh,N_=Xn([].indexOf),sy=!!N_&&1/N_([1],1,-0)<0;o2({target:"Array",proto:!0,forced:sy||!c2("indexOf")},{indexOf:function(n){var t=arguments.length>1?arguments[1]:void 0;return sy?N_(this,n,t)||0:a2(this,n,t)}});var d2=Wr("Array").indexOf,u2=wt,l2=d2,D_=Array.prototype,oy=b(function(n){var t=n.indexOf;return n===D_||u2(D_,n)&&t===D_.indexOf?l2:t}),h2=jr,ay=Dl;le({target:"Object",stat:!0,forced:D(function(){ay(1)})},{keys:function(n){return ay(h2(n))}});var p2=b(Tr.Object.keys);function _2(n,t){if(n==null)return{};var e,i,r=function(o,a){if(o==null)return{};var c,d,u={},l=p2(o);for(d=0;d<l.length;d++)c=l[d],oy(a).call(a,c)>=0||(u[c]=o[c]);return u}(n,t);if(ry){var s=ry(n);for(i=0;i<s.length;i++)e=s[i],oy(t).call(t,e)>=0||Object.prototype.propertyIsEnumerable.call(n,e)&&(r[e]=n[e])}return r}var cy={exports:{}};(function(n,t){n.exports=(()=>{var e={8:(s,o,a)=>{a.r(o),a.d(o,{Parser:()=>mt,Printer:()=>qn,parse:()=>ft,print:()=>kt});const c=`
`,d="".concat("\r").concat(c),u=" ";let l;function p(Q){return Q>="0"&&Q<="9"}function _(Q){return Q>="!"&&Q<="~"}function R(Q){return _(Q)||Q>=""&&Q<="ÿ"}function f(Q){return Q==="!"||Q>="#"&&Q<="'"||Q>="*"&&Q<="+"||Q>="-"&&Q<="."||Q>="0"&&Q<="9"||Q>="A"&&Q<="Z"||Q>="^"&&Q<="~"}function T(Q){return Q>="1"&&Q<="9"}function A(Q){return Q>="A"&&Q<="Z"||Q>="a"&&Q<="z"}function N(Q){return Q==="d"||Q==="h"||Q==="m"||Q==="s"}function P(Q){return Q>""&&Q<"	"||Q>"\v"&&Q<"\f"||Q>""&&Q<"ÿ"}function j(Q){return A(Q)||p(Q)||Q==="+"||Q==="/"}function M(Q){return p(Q)||A(Q)||Q==="+"||Q==="/"||Q==="-"||Q==="_"}function U(Q){return A(Q)||p(Q)||Q==="+"||Q==="/"}function B(Q,E){var w=Object.keys(Q);if(Object.getOwnPropertySymbols){var L=Object.getOwnPropertySymbols(Q);E&&(L=L.filter(function(J){return Object.getOwnPropertyDescriptor(Q,J).enumerable})),w.push.apply(w,L)}return w}function V(Q){for(var E=1;E<arguments.length;E++){var w=arguments[E]!=null?arguments[E]:{};E%2?B(Object(w),!0).forEach(function(L){q(Q,L,w[L])}):Object.getOwnPropertyDescriptors?Object.defineProperties(Q,Object.getOwnPropertyDescriptors(w)):B(Object(w)).forEach(function(L){Object.defineProperty(Q,L,Object.getOwnPropertyDescriptor(w,L))})}return Q}function q(Q,E,w){return E in Q?Object.defineProperty(Q,E,{value:w,enumerable:!0,configurable:!0,writable:!0}):Q[E]=w,Q}(function(Q){Q.VERSION="v",Q.ORIGIN="o",Q.SESSION_NAME="s",Q.INFORMATION="i",Q.URI="u",Q.EMAIL="e",Q.PHONE="p",Q.CONNECTION="c",Q.BANDWIDTH="b",Q.TIME="t",Q.REPEAT="r",Q.ZONE_ADJUSTMENTS="z",Q.KEY="k",Q.ATTRIBUTE="a",Q.MEDIA="m"})(l||(l={}));class z{consumeText(E,w){let L=w;for(;L<E.length;){const J=E[L];if(J==="\0"||J==="\r"||J===c)break;L+=1}if(L-w==0)throw new Error("Invalid text, at ".concat(E));return L}consumeUnicastAddress(E,w,L){return this.consumeTill(E,w,u)}consumeOneOrMore(E,w,L){let J=w;for(;L(E[J]);)J++;if(J-w==0)throw new Error("Invalid rule at ".concat(w,"."));return J}consumeSpace(E,w){if(E[w]===u)return w+1;throw new Error("Invalid space at ".concat(w,"."))}consumeIP4Address(E,w){let L=w;for(let J=0;J<4;J++)if(L=this.consumeDecimalUChar(E,L),J!==3){if(E[L]!==".")throw new Error("Invalid IP4 address.");L++}return L}consumeDecimalUChar(E,w){let L=w;for(let gt=0;gt<3&&p(E[L]);gt++,L++);if(L-w==0)throw new Error("Invalid decimal uchar.");const J=parseInt(E.slice(w,L));if(J>=0&&J<=255)return L;throw new Error("Invalid decimal uchar")}consumeIP6Address(E,w){let L=this.consumeHexpart(E,w);return E[L]===":"&&(L+=1,L=this.consumeIP4Address(E,L)),L}consumeHexpart(E,w){let L=w;if(E[L]===":"&&E[L+1]===":"){L+=2;try{L=this.consumeHexseq(E,L)}catch{}return L}if(L=this.consumeHexseq(E,L),E[L]===":"&&E[L+1]===":"){L+=2;try{L=this.consumeHexseq(E,L)}catch{}return L}return L}consumeHexseq(E,w){let L=w;for(;L=this.consumeHex4(E,L),E[L]===":"&&E[L+1]!==":";)L+=1;return L}consumeHex4(E,w){let L=0;for(;L<4;L++)if(!((J=E[w+L])>="0"&&J<="9"||J>="a"&&J<="f"||J>="A"&&J<="F")){if(L===0)throw new Error("Invalid hex 4");break}var J;return w+L}consumeFQDN(E,w){let L=w;for(;p(E[L])||A(E[L])||E[L]==="-"||E[L]===".";)L+=1;if(L-w<4)throw new Error("Invalid FQDN");return L}consumeExtnAddr(E,w){return this.consumeOneOrMore(E,w,R)}consumeMulticastAddress(E,w,L){switch(L){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(E,w);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(E,w);default:try{return this.consumeFQDN(E,w)}catch{return this.consumeExtnAddr(E,w)}}}consumeIP6MulticastAddress(E,w){const L=this.consumeHexpart(E,w);return E[L]==="/"?this.consumeInteger(E,L+1):L}consumeIP4MulticastAddress(E,w){let L=w+3;const J=E.slice(w,L),gt=parseInt(J);if(gt<224||gt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let ee=0;ee<3;ee++){if(E[L]!==".")throw new Error("Invalid IP4 multicast address.");L+=1,L=this.consumeDecimalUChar(E,L)}return E[L]==="/"&&(L+=1),L=this.consumeTTL(E,L),E[L]==="/"&&(L=this.consumeInteger(E,L)),L}consumeInteger(E,w){if(!T(E[w]))throw new Error("Invalid integer.");for(w+=1;p(E[w]);)w+=1;return w}consumeTTL(E,w){if(E[w]==="0")return w+1;if(!T(E[w]))throw new Error("Invalid TTL.");w+=1;for(let L=0;L<2&&p(E[w]);L++)w+=1;return w}consumeToken(E,w){return this.consumeOneOrMore(E,w,f)}consumeTime(E,w){let L=w;if(E[L]==="0")return L+1;for(T(E[L])&&(L+=1);p(E[L]);)L++;if(L-w<10)throw new Error("Invalid time");return L}consumeAddress(E,w){return this.consumeTill(E,w,u)}consumeTypedTime(E,w){let L=w;return L=this.consumeOneOrMore(E,L,p),N(E[L])?L+1:L}consumeRepeatInterval(E,w){if(!T(E[w]))throw new Error("Invalid repeat interval");for(w+=1;p(E[w]);)w+=1;return N(E[w])&&(w+=1),w}consumePort(E,w){return this.consumeOneOrMore(E,w,p)}consume(E,w,L){for(let J=0;J<L.length;J++){if(w+J>=E.length)throw new Error("consume exceeding value length");if(E[w+J]!==L[J])throw new Error("consume ".concat(L," failed at ").concat(J))}return w+L.length}consumeTill(E,w,L){let J=w;for(;J<E.length&&(typeof L!="string"||E[J]!==L)&&(typeof L!="function"||!L(E[J]));)J++;return J}}class mt extends z{constructor(){super(),q(this,"records",[]),q(this,"currentLine",0)}parse(E){const w=this.probeEOL(E);this.records=E.split(w).filter(Oe=>!!Oe.trim()).map(this.parseLine),this.currentLine=0;const L=this.parseVersion(),J=this.parseOrigin(),gt=this.parseSessionName(),ee=this.parseInformation(),cn=this.parseUri(),Jn=this.parseEmail(),xr=this.parsePhone(),Gu=this.parseConnection(),Wu=this.parseBandWidth(),Ai=this.parseTimeFields(),Cs=this.parseKey(),ma=this.parseSessionAttribute(),Ee=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:L,origin:J,sessionName:gt,information:ee,uri:cn,emails:Jn,phones:xr,connection:Gu,bandwidths:Wu,timeFields:Ai,key:Cs,attributes:ma,mediaDescriptions:Ee}}getCurrentRecord(){const E=this.records[this.currentLine];if(!E)throw new Error("Record doesn't exit.");return E}probeEOL(E){for(let w=0;w<E.length;w++)if(E[w]===c)return E[w-1]==="\r"?d:c;throw new Error("Invalid newline character.")}parseLine(E,w){if(E.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const L=E[0];if(E[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:L,value:E.slice(2),line:w,cur:0}}parseSessionAttribute(){const E=new te;for(;this.currentLine<this.records.length;){const w=this.getCurrentRecord();if(w.type!==l.ATTRIBUTE)break;const L={attField:this.extractOneOrMore(w,J=>f(J)&&J!==":"),_cur:0};w.value[w.cur]===":"&&(w.cur+=1,L.attValue=this.extractOneOrMore(w,P)),E.parse(L),this.currentLine++}return E.digest()}parseMediaAttributes(E){const w=new we(E);for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==l.ATTRIBUTE)break;const J={attField:this.extractOneOrMore(L,gt=>f(gt)&&gt!==":"),_cur:0};L.value[L.cur]===":"&&(L.cur+=1,J.attValue=this.extractOneOrMore(L,P)),w.parse(J),this.currentLine++}return w.digest()}parseKey(){const E=this.getCurrentRecord();if(E.type===l.KEY){if(E.value==="prompt"||E.value==="clear:"||E.value==="base64:"||E.value==="uri:")return E.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const E=this.getCurrentRecord();if(E.type===l.ZONE_ADJUSTMENTS){const w=[];for(;;)try{const L=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);let J=!1;E.value[E.cur]==="-"&&(J=!0,E.cur+=1);const gt=this.extract(E,this.consumeTypedTime);w.push({time:L,typedTime:gt,back:J})}catch{break}if(w.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,w}return[]}parseRepeat(){const E=[];for(;;){const w=this.getCurrentRecord();if(w.type!==l.REPEAT)break;{const L=this.extract(w,this.consumeRepeatInterval),J=this.parseTypedTime(w);E.push({repeatInterval:L,typedTimes:J}),this.currentLine++}}return E}parseTypedTime(E){const w=[];for(;;)try{this.consumeSpaceForRecord(E),w.push(this.extract(E,this.consumeTypedTime))}catch{break}if(w.length===0)throw new Error("Invalid typed time.");return w}parseTime(){const E=this.getCurrentRecord(),w=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);const L=this.extract(E,this.consumeTime);return this.currentLine++,{startTime:w,stopTime:L}}parseBandWidth(){const E=[];for(;this.currentLine<this.records.length;){const w=this.getCurrentRecord();if(w.type!==l.BANDWIDTH)break;{const L=this.extractOneOrMore(w,f);if(w.value[w.cur]!==":")throw new Error("Invalid bandwidth field.");w.cur++;const J=this.extractOneOrMore(w,p);E.push({bwtype:L,bandwidth:J}),this.currentLine++}}return E}parseVersion(){const E=this.getCurrentRecord();if(E.type!==l.VERSION)throw new Error("first sdp record must be version");const w=E.value.slice(0,this.consumeOneOrMore(E.value,0,p));if(w.length!==E.value.length)throw new Error('invalid proto version, "v='.concat(E.value,'"'));return this.currentLine++,w}parseOrigin(){const E=this.getCurrentRecord();if(E.type!==l.ORIGIN)throw new Error("second line of sdp must be origin");const w=this.extractOneOrMore(E,R);this.consumeSpaceForRecord(E);const L=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const J=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const gt=this.extractOneOrMore(E,f);this.consumeSpaceForRecord(E);const ee=this.extractOneOrMore(E,f);this.consumeSpaceForRecord(E);const cn=this.extract(E,this.consumeUnicastAddress);return this.currentLine++,{username:w,sessId:L,sessVersion:J,nettype:gt,addrtype:ee,unicastAddress:cn}}parseSessionName(){const E=this.getCurrentRecord();if(E.type===l.SESSION_NAME){const w=this.extract(E,this.consumeText);return this.currentLine++,w}}parseInformation(){const E=this.getCurrentRecord();if(E.type!==l.INFORMATION)return;const w=this.extract(E,this.consumeText);return this.currentLine++,w}parseUri(){const E=this.getCurrentRecord();if(E.type===l.URI)return this.currentLine++,E.value}parseEmail(){const E=[];for(;;){const w=this.getCurrentRecord();if(w.type!==l.EMAIL)break;E.push(w.value),this.currentLine++}return E}parsePhone(){const E=[];for(;;){const w=this.getCurrentRecord();if(w.type!==l.PHONE)break;E.push(w.value),this.currentLine++}return E}parseConnection(){const E=this.getCurrentRecord();if(E.type===l.CONNECTION){const w=this.extractOneOrMore(E,f);this.consumeSpaceForRecord(E);const L=this.extractOneOrMore(E,f);this.consumeSpaceForRecord(E);const J=this.extract(E,this.consumeAddress);return this.currentLine++,{nettype:w,addrtype:L,address:J}}}parseMedia(){const E=this.getCurrentRecord(),w=this.extract(E,this.consumeToken);this.consumeSpaceForRecord(E);let L=this.extract(E,this.consumePort);E.value[E.cur]==="/"&&(E.cur+=1,L+=this.extract(E,this.consumeInteger)),this.consumeSpaceForRecord(E);const J=[];for(J.push(this.extract(E,this.consumeToken));E.value[E.cur]==="/";)E.cur+=1,J.push(this.extract(E,this.consumeToken));if(J.length===0)throw new Error("Invalid proto");const gt=this.parseFmt(E);return this.currentLine++,{mediaType:w,port:L,protos:J,fmts:gt}}parseTimeFields(){const E=[];for(;this.getCurrentRecord().type===l.TIME;){const w=this.parseTime(),L=this.parseRepeat(),J=this.parseZone();E.push({time:w,repeats:L,zones:J})}return E}parseMediaDescription(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.MEDIA;){const w=this.parseMedia(),L=this.parseInformation(),J=this.parseConnections(),gt=this.parseBandWidth(),ee=this.parseKey(),cn=this.parseMediaAttributes(w);E.push({media:w,information:L,connections:J,bandwidths:gt,key:ee,attributes:cn})}return E}parseConnections(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.CONNECTION;)E.push(this.parseConnection());return E}parseFmt(E){const w=[];for(;;)try{this.consumeSpaceForRecord(E),w.push(this.extract(E,this.consumeToken))}catch{break}if(w.length===0)throw new Error("Invalid fmts");return w}extract(E,w,...L){const J=w.call(this,E.value,E.cur,...L),gt=E.value.slice(E.cur,J);return E.cur=J,gt}extractOneOrMore(E,w){const L=this.consumeOneOrMore(E.value,E.cur,w),J=E.value.slice(E.cur,L);return E.cur=L,J}consumeSpaceForRecord(E){if(E.value[E.cur]!==u)throw new Error("Invalid space at ".concat(E.cur,"."));E.cur+=1}}class Rt extends z{constructor(...E){super(...E),q(this,"attributes",void 0),q(this,"digested",!1)}extractOneOrMore(E,w,L){const J=this.consumeOneOrMore(E.attValue,E._cur,w),gt=E.attValue.slice(E._cur,J),[ee,cn]=L||[];if(typeof ee=="number"&&gt.length<ee)throw new Error("error in length, should be more or equal than ".concat(ee," characters."));if(typeof cn=="number"&&gt.length>cn)throw new Error("error in length, should be less or equal than ".concat(cn," characters."));return E._cur=J,gt}consumeAttributeSpace(E){if(E.attValue[E._cur]!==u)throw new Error("Invalid space at ".concat(E._cur,"."));E._cur+=1}extract(E,w,...L){if(!E.attValue)throw new Error("Nothing to extract from attValue.");const J=w.call(this,E.attValue,E._cur,...L),gt=E.attValue.slice(E._cur,J);return E._cur=J,gt}atEnd(E){if(!E.attValue)throw new Error;return E._cur>=E.attValue.length}peekChar(E){if(!E.attValue)throw new Error;return E.attValue[E._cur]}peek(E,w){if(!E.attValue)throw new Error;for(let L=0;L<w.length;L++)if(w[L]!==E.attValue[E._cur+L])return!1;return!0}parseIceUfrag(E){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(E,j,[4,256])}parseIcePwd(E){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(E,j,[22,256])}parseIceOptions(E){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const w=[];for(;!this.atEnd(E);){w.push(this.extractOneOrMore(E,j));try{this.consumeAttributeSpace(E)}catch(L){if(this.atEnd(E))break;throw L}}this.attributes.iceOptions=w}parseFingerprint(E){const w=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const L=this.extract(E,this.consumeTill);this.attributes.fingerprints.push({hashFunction:w,fingerprint:L})}parseExtmap(E){const w=this.extractOneOrMore(E,p);let L;this.peekChar(E)==="/"&&(this.extract(E,this.consume,"/"),L=this.extract(E,this.consumeToken)),this.consumeAttributeSpace(E);const J=this.extract(E,this.consumeTill,u),gt=V(V({entry:parseInt(w,10)},L&&{direction:L}),{},{extensionName:J});this.peekChar(E)===u&&(this.consumeAttributeSpace(E),gt.extensionAttributes=this.extract(E,this.consumeTill)),this.attributes.extmaps.push(gt)}parseSetup(E){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const w=this.extract(E,this.consumeTill);if(w!=="active"&&w!=="passive"&&w!=="actpass"&&w!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=w}}class te extends Rt{constructor(...E){super(...E),q(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"group":this.parseGroup(E);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"fingerprint":this.parseFingerprint(E);break;case"setup":this.parseSetup(E);break;case"tls-id":this.parseTlsId(E);break;case"identity":this.parseIdentity(E);break;case"extmap":this.parseExtmap(E);break;case"msid-semantic":this.parseMsidSemantic(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(w){throw console.error("parsing session attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),w}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(E){const w=this.extract(E,this.consumeToken),L=[];for(;!this.atEnd(E)&&this.peekChar(E)===u;)this.consumeAttributeSpace(E),L.push(this.extract(E,this.consumeToken));this.attributes.groups.push({semantic:w,identificationTag:L})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(E){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(E,M)}parseIdentity(E){const w=this.extractOneOrMore(E,U),L=[];for(;!this.atEnd(E)&&this.peekChar(E)===u;){this.consumeAttributeSpace(E);const J=this.extract(E,this.consumeToken);this.extract(E,this.consume,"=");const gt=this.extractOneOrMore(E,ee=>ee!==u&&P(ee));L.push({name:J,value:gt})}this.attributes.identities.push({assertionValue:w,extensions:L})}parseMsidSemantic(E){this.peekChar(E)===u&&this.consumeAttributeSpace(E);const w={semantic:this.extract(E,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(E)}catch{break}if(this.peekChar(E)==="*"){this.extract(E,this.consume,"*"),w.applyForAll=!0;break}{const L=this.extract(E,this.consumeTill,u);w.identifierList.push(L)}}this.attributes.msidSemantic=w}}class we extends Rt{constructor(E){super(),q(this,"attributes",void 0),E.protos.indexOf("RTP")!==-1||E.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"extmap":this.parseExtmap(E);break;case"setup":this.parseSetup(E);break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"candidate":this.parseCandidate(E);break;case"remote-candidate":this.parseRemoteCandidate(E);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(E);break;case"rtpmap":this.parseRtpmap(E);break;case"ptime":this.parsePtime(E);break;case"maxptime":this.parseMaxPtime(E);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(E);break;case"ssrc":this.parseSSRC(E);break;case"fmtp":this.parseFmtp(E);break;case"rtcp-fb":this.parseRtcpFb(E);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(E);break;case"mid":this.parseMid(E);break;case"msid":this.parseMsid(E);break;case"imageattr":this.parseImageAttr(E);break;case"rid":this.parseRid(E);break;case"simulcast":this.parseSimulcast(E);break;case"sctp-port":this.parseSctpPort(E);break;case"max-message-size":this.parseMaxMessageSize(E);break;case"ssrc-group":this.parseSSRCGroup(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(w){throw console.error("parsing media attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),w}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}parseCandidate(E){const w=this.extractOneOrMore(E,j,[1,32]);this.consumeAttributeSpace(E);const L=this.extractOneOrMore(E,p,[1,5]);this.consumeAttributeSpace(E);const J=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const gt=this.extractOneOrMore(E,p,[1,10]);this.consumeAttributeSpace(E);const ee=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const cn=this.extract(E,this.consumePort);this.consumeAttributeSpace(E),this.extract(E,this.consume,"typ"),this.consumeAttributeSpace(E);const Jn={foundation:w,componentId:L,transport:J,priority:gt,connectionAddress:ee,port:cn,type:this.extract(E,this.consumeToken),extension:{}};for(this.peek(E," raddr")&&(this.extract(E,this.consume," raddr"),this.consumeAttributeSpace(E),Jn.relAddr=this.extract(E,this.consumeAddress)),this.peek(E," rport")&&(this.extract(E,this.consume," rport"),this.consumeAttributeSpace(E),Jn.relPort=this.extract(E,this.consumePort));this.peekChar(E)===u;){this.consumeAttributeSpace(E);const xr=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E),Jn.extension[xr]=this.extractOneOrMore(E,_)}this.attributes.candidates.push(Jn)}parseRemoteCandidate(E){const w=[];for(;;){const L=this.extractOneOrMore(E,p,[1,5]);this.consumeAttributeSpace(E);const J=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const gt=this.extract(E,this.consumePort);w.push({componentId:L,connectionAddress:J,port:gt});try{this.consumeAttributeSpace(E)}catch{break}}this.attributes.remoteCandidatesList.push(w)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(E){const w=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const L=this.extract(E,this.consumeTill,"/");this.extract(E,this.consume,"/");const J={encodingName:L,clockRate:this.extractOneOrMore(E,p)};this.atEnd(E)||this.peekChar(E)!=="/"||(this.extract(E,this.consume,"/"),J.encodingParameters=parseInt(this.extract(E,this.consumeTill),10));const gt=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));gt?gt.rtpMap=J:this.attributes.payloads.push({payloadType:parseInt(w,10),rtpMap:J,rtcpFeedbacks:[]})}parsePtime(E){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(E,this.consumeTill)}parseMaxPtime(E){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(E,this.consumeTill)}parseDirection(E){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=E.attField}parseSSRC(E){const w=this.extractOneOrMore(E,p);this.consumeAttributeSpace(E);const L=this.extract(E,this.consumeTill,":");let J;this.peekChar(E)===":"&&(this.extract(E,this.consume,":"),J=this.extract(E,this.consumeTill));const gt=this.attributes.ssrcs.find(ee=>ee.ssrcId===parseInt(w,10));gt?gt.attributes[L]=J:this.attributes.ssrcs.push({ssrcId:parseInt(w,10),attributes:{[L]:J}})}parseFmtp(E){const w=this.extract(E,this.consumeTill,u);this.consumeAttributeSpace(E);const L=this.extract(E,this.consumeTill),J={};L.split(";").forEach(ee=>{let[cn,Jn]=ee.split("=");cn=cn.trim();const xr=typeof Jn=="string"?Jn.trim():null;typeof cn=="string"&&cn.length>0&&(J[cn]=xr)});const gt=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));gt?gt.fmtp={parameters:J}:this.attributes.payloads.push({payloadType:parseInt(w,10),rtcpFeedbacks:[],fmtp:{parameters:J}})}parseFmtParameters(E){const w={},L=this.extract(E,this.consumeTill,"=");E._cur++;const J=this.extract(E,this.consumeTill,";");for(w[L]=J;E.attValue[E._cur]===";";){const gt=this.extract(E,this.consumeTill,"=");E._cur++;const ee=this.extract(E,this.consumeTill,";");w[gt]=ee}return w}parseRtcpFb(E){let w="";w=this.peekChar(E)==="*"?this.extract(E,this.consume,"*"):this.extract(E,this.consumeTill,u),this.consumeAttributeSpace(E);const L=this.extract(E,this.consumeTill,u);let J;if(L==="trr-int")J={type:L,interval:this.extract(E,this.consumeTill)};else{const gt={type:L};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),gt.parameter=this.extract(E,this.consumeToken),this.peekChar(E)===u&&(gt.additional=this.extract(E,this.consumeTill))),J=gt}if(w==="*")this.attributes.rtcpFeedbackWildcards.push(J);else{const gt=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));gt?gt.rtcpFeedbacks.push(J):this.attributes.payloads.push({payloadType:parseInt(w,10),rtcpFeedbacks:[J]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(E){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const w={port:this.extract(E,this.consumePort)};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),w.netType=this.extractOneOrMore(E,f),this.consumeAttributeSpace(E),w.addressType=this.extractOneOrMore(E,f),this.consumeAttributeSpace(E),w.address=this.extract(E,this.consumeAddress)),this.attributes.rtcp=w}parseMsid(E){const w={id:this.extractOneOrMore(E,f,[1,64])};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),w.appdata=this.extractOneOrMore(E,f,[1,64])),this.attributes.msids.push(w)}parseImageAttr(E){this.attributes.imageattr.push(E.attValue)}parseRid(E){const w=this.extractOneOrMore(E,J=>A(J)||p(J)||J==="_"||J==="-");this.consumeAttributeSpace(E);const L={id:w,direction:this.extract(E,this.consumeToken),params:[]};if(this.peekChar(E)===u){if(this.consumeAttributeSpace(E),this.peek(E,"pt=")){this.extract(E,this.consume,"pt=");const J=[];for(;;){const gt=this.extract(E,this.consumeToken);J.push(gt);try{this.extract(E,this.consume,",")}catch{break}}L.payloads=J,this.peekChar(E)===u&&this.extract(E,this.consume,u)}for(;;){const J=this.extract(E,this.consumeToken);switch(J){case"depend":{const gt={type:J,rids:this.extract(E,this.consume,"=").split(",")};L.params.push(gt);break}default:{const gt={type:J};this.peekChar(E)==="="&&(this.extract(E,this.consume,"="),gt.val=this.extract(E,this.consumeTill,";")),L.params.push(gt)}}try{this.extract(E,this.consume,";")}catch{break}}}this.attributes.rids.push(L)}parseSimulcast(E){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=E.attValue,this.extract(E,this.consumeTill)}parseSctpPort(E){this.attributes.sctpPort=this.extractOneOrMore(E,p,[1,5])}parseMaxMessageSize(E){this.attributes.maxMessageSize=this.extractOneOrMore(E,p,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(E){this.attributes.mid=this.extract(E,this.consumeToken)}parseSSRCGroup(E){const w=this.extract(E,this.consumeToken),L=[];for(;;)try{this.consumeAttributeSpace(E);const J=this.extract(E,this.consumeInteger);L.push(parseInt(J,10))}catch{break}this.attributes.ssrcGroups.push({semantic:w,ssrcIds:L})}}function ie(Q,E,w){return E in Q?Object.defineProperty(Q,E,{value:w,enumerable:!0,configurable:!0,writable:!0}):Q[E]=w,Q}class qn{constructor(){ie(this,"eol",d)}print(E,w){let L="";return w&&(this.eol=w),L+=this.printVersion(E.version),L+=this.printOrigin(E.origin),L+=this.printSessionName(E.sessionName),L+=this.printInformation(E.information),L+=this.printUri(E.uri),L+=this.printEmail(E.emails),L+=this.printPhone(E.phones),L+=this.printConnection(E.connection),L+=this.printBandwidth(E.bandwidths),L+=this.printTimeFields(E.timeFields),L+=this.printKey(E.key),L+=this.printSessionAttributes(E.attributes),L+=this.printMediaDescription(E.mediaDescriptions),L}printVersion(E){return"v=".concat(E).concat(this.eol)}printOrigin(E){return"o=".concat(E.username," ").concat(E.sessId," ").concat(E.sessVersion," ").concat(E.nettype," ").concat(E.addrtype," ").concat(E.unicastAddress).concat(this.eol)}printSessionName(E){return E?"s=".concat(E).concat(this.eol):""}printInformation(E){return E?"i=".concat(E).concat(this.eol):""}printUri(E){return E?"u=".concat(E).concat(this.eol):""}printEmail(E){let w="";for(const L of E)w+="e=".concat(L).concat(this.eol);return w}printPhone(E){let w="";for(const L of E)w+="e=".concat(L).concat(this.eol);return w}printConnection(E){return E?"c=".concat(E.nettype," ").concat(E.addrtype," ").concat(E.address).concat(this.eol):""}printBandwidth(E){let w="";for(const L of E)w+="b=".concat(L.bwtype,":").concat(L.bandwidth).concat(this.eol);return w}printTimeFields(E){let w="";for(const L of E){w+="t=".concat(L.time.startTime," ").concat(L.time.startTime).concat(this.eol);for(const J of L.repeats)w+="r=".concat(J.repeatInterval," ").concat(J.typedTimes.join(" ")).concat(this.eol);L.zoneAdjustments&&(w+="z=",w+="z=".concat(L.zoneAdjustments.map(J=>"".concat(J.time," ").concat(J.back?"-":""," ").concat(J.typedTime)).join(" ")).concat(this.eol),w+=this.eol)}return w}printKey(E){return E?"k=".concat(E).concat(this.eol):""}printAttributes(E){let w="";for(const L of E)w+="a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol);return w}printMediaDescription(E){let w="";for(const L of E)w+=this.printMedia(L.media),w+=this.printInformation(L.information),w+=this.printConnections(L.connections),w+=this.printBandwidth(L.bandwidths),w+=this.printKey(L.key),w+=this.printMediaAttributes(L);return w}printConnections(E){let w="";for(const L of E)w+=this.printConnection(L);return w}printMedia(E){return"m=".concat(E.mediaType," ").concat(E.port," ").concat(E.protos.join("/")," ").concat(E.fmts.join(" ")).concat(this.eol)}printSessionAttributes(E){return new X(this.eol).print(E)}printMediaAttributes(E){return new et(this.eol).print(E)}}class K{constructor(E){ie(this,"eol",void 0),this.eol=E}printIceUfrag(E){return E===void 0?"":"a=ice-ufrag:".concat(E).concat(this.eol)}printIcePwd(E){return E===void 0?"":"a=ice-pwd:".concat(E).concat(this.eol)}printIceOptions(E){return E===void 0?"":"a=ice-options:".concat(E.join(u)).concat(this.eol)}printFingerprints(E){return E.length>0?E.map(w=>"a=fingerprint:".concat(w.hashFunction).concat(u).concat(w.fingerprint)).join(this.eol)+this.eol:""}printExtmap(E){return E.map(w=>"a=extmap:".concat(w.entry).concat(w.direction?"/".concat(w.direction):"").concat(u).concat(w.extensionName).concat(w.extensionAttributes?"".concat(u).concat(w.extensionAttributes):"").concat(this.eol)).join("")}printSetup(E){return E===void 0?"":"a=setup:".concat(E).concat(this.eol)}printUnrecognized(E){return E.map(w=>"a=".concat(w.attField).concat(w.attValue?":".concat(w.attValue):"").concat(this.eol)).join("")}}class X extends K{print(E){let w="";return w+=this.printGroups(E.groups),w+=this.printMsidSemantic(E.msidSemantic),w+=this.printIceLite(E.iceLite),w+=this.printIceUfrag(E.iceUfrag),w+=this.printIcePwd(E.icePwd),w+=this.printIceOptions(E.iceOptions),w+=this.printFingerprints(E.fingerprints),w+=this.printSetup(E.setup),w+=this.printTlsId(E.tlsId),w+=this.printIdentity(E.identities),w+=this.printExtmap(E.extmaps),w+=this.printUnrecognized(E.unrecognized),w}printGroups(E){let w="";return E.length>0&&(w+=E.map(L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map(J=>"".concat(u).concat(J)).join("")).concat(this.eol)).join("")),w}printIceLite(E){return E===void 0?"":"a=ice-lite"+this.eol}printTlsId(E){return E?"a=tls-id:".concat(E).concat(this.eol):""}printIdentity(E){return E.length===0?"":E.map(w=>"a=identity:".concat(w.assertionValue).concat(w.extensions.map(L=>"".concat(u).concat(L.name).concat(L.value?"=".concat(L.value):"")))).join(this.eol)+this.eol}printMsidSemantic(E){if(!E)return"";let w="a=msid-semantic:".concat(E.semantic);return E.applyForAll?w+="".concat(u,"*"):E.identifierList.length>0&&(w+=E.identifierList.map(L=>"".concat(u).concat(L))),w+this.eol}}class et extends K{print(E){const w=E.attributes;let L="";return L+=this.printRTCP(w.rtcp),L+=this.printIceUfrag(w.iceUfrag),L+=this.printIcePwd(w.icePwd),L+=this.printIceOptions(w.iceOptions),L+=this.printCandidates(w.candidates),L+=this.printRemoteCandidatesList(w.remoteCandidatesList),L+=this.printEndOfCandidates(w.endOfCandidates),L+=this.printFingerprints(w.fingerprints),L+=this.printSetup(w.setup),L+=this.printMid(w.mid),L+=this.printExtmap(w.extmaps),L+=this.printRTPRelated(w),L+=this.printPtime(w.ptime),L+=this.printMaxPtime(w.maxPtime),L+=this.printDirection(w.direction),L+=this.printSSRCGroups(w.ssrcGroups),L+=this.printSSRC(w.ssrcs),L+=this.printRTCPMux(w.rtcpMux),L+=this.printRTCPMuxOnly(w.rtcpMuxOnly),L+=this.printRTCPRsize(w.rtcpRsize),L+=this.printMSId(w.msids),L+=this.printImageattr(w.imageattr),L+=this.printRid(w.rids),L+=this.printSimulcast(w.simulcast),L+=this.printSCTPPort(w.sctpPort),L+=this.printMaxMessageSize(w.maxMessageSize),L+=this.printUnrecognized(w.unrecognized),L}printCandidates(E){return E.map(w=>"a=candidate:".concat(w.foundation).concat(u).concat(w.componentId).concat(u).concat(w.transport).concat(u).concat(w.priority).concat(u).concat(w.connectionAddress).concat(u).concat(w.port).concat(u,"typ").concat(u).concat(w.type).concat(w.relAddr?"".concat(u,"raddr").concat(u).concat(w.relAddr):"").concat(w.relPort?"".concat(u,"rport").concat(u).concat(w.relPort):"").concat(Object.keys(w.extension).map(L=>"".concat(u).concat(L).concat(u).concat(w.extension[L])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(E){return E.map(w=>"a=remote-candidates:".concat(w.join(u)).concat(this.eol)).join("")}printEndOfCandidates(E){return E===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(E){if(!E.payloads)return"";const w=E.payloads;let L="";L+=E.rtcpFeedbackWildcards.map(J=>this.printRTCPFeedback("*",J)).join("");for(const J of w)L+=this.printRtpMap(J.payloadType,J.rtpMap),L+=this.printFmtp(J.payloadType,J.fmtp),L+=J.rtcpFeedbacks.map(gt=>this.printRTCPFeedback(J.payloadType,gt)).join("");return L}printFmtp(E,w){if(!w)return"";const L=Object.keys(w.parameters);return L.length===1&&w.parameters[L[0]]===null?"a=fmtp:".concat(E).concat(u).concat(L[0]).concat(this.eol):"a=fmtp:".concat(E).concat(u).concat(Object.keys(w.parameters).map(J=>"".concat(J,"=").concat(w.parameters[J])).join(";")).concat(this.eol)}printRtpMap(E,w){return w?"a=rtpmap:".concat(E).concat(u).concat(w.encodingName,"/").concat(w.clockRate).concat(w.encodingParameters?"/".concat(w.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(E,w){let L="a=rtcp-fb:".concat(E).concat(u),J=w;return J.type==="trr-int"?L+="ttr-int".concat(u).concat(J.interval):(L+="".concat(J.type),J.parameter&&(L+="".concat(u).concat(J.parameter),J.additional&&(L+="".concat(u).concat(J.additional)))),L+this.eol}printPtime(E){return E===void 0?"":"a=ptime:".concat(E).concat(this.eol)}printMaxPtime(E){return E===void 0?"":"a=maxptime:".concat(E).concat(this.eol)}printDirection(E){return E===void 0?"":"a=".concat(E).concat(this.eol)}printSSRC(E){return E.map(w=>Object.keys(w.attributes).map(L=>"a=ssrc:".concat(w.ssrcId.toString(10)).concat(u).concat(L).concat(w.attributes[L]?":".concat(w.attributes[L]):"").concat(this.eol)).join("")).join("")}printRTCPMux(E){return E===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(E){return E===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(E){return E===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(E){if(E===void 0)return"";let w="a=rtcp:".concat(E.port);return E.netType&&(w+="".concat(u).concat(E.netType)),E.addressType&&(w+="".concat(u).concat(E.addressType)),E.address&&(w+="".concat(u).concat(E.address)),w+this.eol}printMSId(E){return E.map(w=>"a=msid:".concat(w.id).concat(w.appdata?"".concat(u).concat(w.appdata):"").concat(this.eol)).join("")}printImageattr(E){return E.map(w=>"a=imageattr:".concat(w).concat(this.eol)).join("")}printRid(E){return E.map(w=>{let L="a=rid:".concat(w.id).concat(u).concat(w.direction);return w.payloads&&(L+="".concat(u,"pt=").concat(w.payloads.join(","))),w.params.length>0&&(L+="".concat(u).concat(w.params.map(J=>J.type==="depend"?"depend=".concat(J.rids.join(",")):"".concat(J.type,"=").concat(J.val)).join(";"))),L+this.eol}).join("")}printSimulcast(E){return E===void 0?"":"a=simulcast:".concat(E).concat(this.eol)}printSCTPPort(E){return E===void 0?"":"a=sctp-port:".concat(E).concat(this.eol)}printMaxMessageSize(E){return E===void 0?"":"a=max-message-size:".concat(E).concat(this.eol)}printMid(E){return E===void 0?"":"a=mid:".concat(E).concat(this.eol)}printSSRCGroups(E){return E.map(w=>"a=ssrc-group:".concat(w.semantic).concat(w.ssrcIds.map(L=>"".concat(u).concat(L.toString(10))).join("")).concat(this.eol)).join("")}}function ft(Q){return new mt().parse(Q)}function kt(Q,E){return new qn().print(Q,E)}}},i={};function r(s){if(i[s])return i[s].exports;var o=i[s]={exports:{}};return e[s](o,o.exports,r),o.exports}return r.d=(s,o)=>{for(var a in o)r.o(o,a)&&!r.o(s,a)&&Object.defineProperty(s,a,{enumerable:!0,get:o[a]})},r.o=(s,o)=>Object.prototype.hasOwnProperty.call(s,o),r.r=s=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(s,"__esModule",{value:!0})},r(8)})()})(cy);var oe=cy.exports;function xi(n){if(Array.isArray(n))return n.map(e=>e);if(!dy(n))return n;const t={};for(const e in n){const i=n[e];dy(i)||Array.isArray(i)?t[e]=xi(i):t[e]=i}return t}function dy(n){return!(typeof n!="object"||Array.isArray(n)||!n)}class P_{constructor(t){h(this,"input",[]),h(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const mr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Rc={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:mr,remoteCandidate:mr}},uy={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},ly={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},hy={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},py={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function _y(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function my(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?_y(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):_y(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class L_{constructor(t,e){h(this,"onFirstVideoReceived",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0),h(this,"videoIsReady",!1),h(this,"videoIsReady2",{}),h(this,"pc",void 0),h(this,"options",void 0),h(this,"intervalTimer",void 0),h(this,"stats",xi(Rc)),h(this,"isFirstVideoReceived",{}),h(this,"isFirstVideoDecoded",{}),h(this,"isFirstAudioReceived",{}),h(this,"isFirstAudioDecoded",{}),h(this,"isFirstVideoDecodedTimeout",{}),h(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new F(t=>{t({local:my({},mr),remote:my({},mr)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,s=0,o=0,a=0;for(const c of i)t[c].forEach((d,u)=>{if(!this.lossRateWindowStats[e-1][c][u]||!this.lossRateWindowStats[0][c][u])return;const l=this.lossRateWindowStats[e-1][c][u].packets-this.lossRateWindowStats[0][c][u].packets,p=this.lossRateWindowStats[e-1][c][u].packetsLost-this.lossRateWindowStats[0][c][u].packetsLost;c==="videoSend"||c==="audioSend"?(r+=l,o+=p):(s+=l,a+=p),Number.isNaN(l)||Number.isNaN(l)?d.packetLostRate=0:d.packetLostRate=l<=0||p<=0?0:p/(l+p)});t.sendPacketLossRate=r<=0||o<=0?0:o/(r+o),t.recvPacketLossRate=s<=0||a<=0?0:a/(s+a)}}function Ey(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function m2(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Ey(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Ey(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class E2 extends L_{constructor(){super(...arguments),h(this,"_stats",Rc),h(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=xi(Rc);const i=e.filter(s=>s.type==="ssrc");this.processSSRCStats(i);const r=e.find(s=>s.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var i;const r=nt(i=e.id).call(i,"send");switch("".concat(e.mediaType,"_").concat(r?"send":"recv")){case"video_send":{const s=xi(ly);s.codec=e.googCodecName,s.adaptionChangeReason="none",e.googCpuLimitedResolution&&(s.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(s.adaptionChangeReason="bandwidth"),s.avgEncodeMs=Number(e.googAvgEncodeMs),s.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},s.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},s.firsCount=Number(e.googFirReceived),s.nacksCount=Number(e.googNacksReceived),s.plisCount=Number(e.googPlisReceived),s.frameCount=Number(e.framesEncoded),s.bytes=Number(e.bytesSent),s.packets=Number(e.packetsSent),s.packetsLost=Number(e.packetsLost),s.ssrc=Number(e.ssrc),s.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(s),this._stats.rtt=s.rttMs;break}case"video_recv":{const s=xi(uy),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(s.codec=e.googCodecName,s.targetDelayMs=Number(e.googTargetDelayMs),s.renderDelayMs=Number(e.googRenderDelayMs),s.currentDelayMs=Number(e.googCurrentDelayMs),s.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),s.decodeMs=Number(e.googDecodeMs),s.maxDecodeMs=Number(e.googMaxDecodeMs),s.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},s.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},s.decodeFrameRate=Number(e.googFrameRateDecoded),s.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},s.jitterBufferMs=Number(e.googJitterBufferMs),s.firsCount=Number(e.googFirsSent),s.nacksCount=Number(e.googNacksSent),s.plisCount=Number(e.googPlisSent),s.framesDecodeCount=Number(e.framesDecoded),s.bytes=Number(e.bytesReceived),s.packets=Number(e.packetsReceived),s.packetsLost=Number(e.packetsLost),s.ssrc=Number(e.ssrc),s.packets>0&&!this.isFirstVideoReceived[s.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(s.ssrc),this.isFirstVideoReceived[s.ssrc]=!0),s.framesDecodeCount>0&&!this.isFirstVideoDecoded[s.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(s.ssrc,s.decodedFrame.width,s.decodedFrame.height),this.isFirstVideoDecoded[s.ssrc]=!0),o){const a=o.stats,c=Date.now()-o.lts;s.framesDecodeFreezeTime=a.framesDecodeFreezeTime,s.framesDecodeInterval=a.framesDecodeInterval,s.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[s.ssrc]?(o.lts=Date.now(),s.framesDecodeInterval=c,s.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?s.framesDecodeFreezeTime+=s.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):s.framesDecodeCount<o.stats.framesDecodeCount&&(s.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(s.ssrc,{stats:m2({},s),lts:Date.now()}),this._stats.videoRecv.push(s);break}case"audio_recv":{const s=xi(py);s.codec=e.googCodecName,s.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,s.decodingCNG=Number(e.googDecodingCNG),s.decodingCTN=Number(e.googDecodingCTN),s.decodingCTSG=Number(e.googDecodingCTSG),s.decodingNormal=Number(e.googDecodingNormal),s.decodingPLC=Number(e.googDecodingPLC),s.decodingPLCCNG=Number(e.googDecodingPLCCNG),s.expandRate=Number(e.googExpandRate),s.accelerateRate=Number(e.googAccelerateRate),s.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),s.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),s.speechExpandRate=Number(e.googSpeechExpandRate),s.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),s.jitterBufferMs=Number(e.googJitterBufferMs),s.jitterMs=Number(e.googJitterReceived),s.bytes=Number(e.bytesReceived),s.packets=Number(e.packetsReceived),s.packetsLost=Number(e.packetsLost),s.ssrc=Number(e.ssrc),s.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),s.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),s.receivedFrames>0&&!this.isFirstAudioReceived[s.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(s.ssrc),this.isFirstAudioReceived[s.ssrc]=!0),s.decodingNormal>0&&!this.isFirstAudioDecoded[s.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(s.ssrc),this.isFirstAudioDecoded[s.ssrc]=!0),this._stats.audioRecv.push(s);break}case"audio_send":{const s=xi(hy);s.codec=e.googCodecName,s.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,s.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),s.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),s.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),s.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),s.bytes=Number(e.bytesSent),s.packets=Number(e.packetsSent),s.packetsLost=Number(e.packetsLost),s.ssrc=Number(e.ssrc),s.rttMs=Number(e.googRtt||0),this._stats.rtt=s.rttMs,this._stats.audioSend.push(s);break}}})}_getStats(){return new F((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){const e=[];return t.result().forEach(i=>{const r={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(s=>{r[s]=i.stat(s)}),e.push(r)}),e}}function fy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function oo(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?fy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):fy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class gy extends L_{constructor(){super(...arguments),h(this,"_stats",Rc),h(this,"report",void 0),h(this,"lastDecodeVideoReceiverStats",new Map),h(this,"lastVideoFramesRecv",new Map),h(this,"lastVideoFramesSent",new Map),h(this,"lastVideoFramesDecode",new Map),h(this,"lastVideoJBDelay",new Map),h(this,"lastAudioJBDelay",new Map),h(this,"mediaBytesSent",new Map),h(this,"mediaBytesRetransmit",new Map),h(this,"mediaBytesTargetEncode",new Map),h(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=xi(Rc),this.report.forEach(t=>{switch(t.type){case Ln.OUTBOUND:case Ln.INBOUND:{const e=t.mediaType||t.kind,i=!e&&"frameWidth"in t,r=!e&&!("frameWidth"in t);t.type===Ln.OUTBOUND?e==="audio"||r?this.processAudioOutboundStats(t):(e==="video"||i)&&this.processVideoOutboundStats(t):t.type===Ln.INBOUND&&(e==="audio"||r?this.processAudioInboundStats(t):(e==="video"||i)&&this.processVideoInboundStats(t));break}case Ln.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case Ln.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:oo({},mr),remote:oo({},mr)};return t.forEach(i=>{let r;if(i.type===Ln.TRANSPORT&&(r=t.get(i.selectedCandidatePairId)),i.type===Ln.CANDIDATE_PAIR&&i.selected&&(r=i),r){const s=(o,a)=>{o.type=a.type,o.id=a.id,a.address&&(o.address=a.address),a.candidateType&&(o.candidateType=a.candidateType),a.port&&(o.port=a.port),a.priority&&(o.priority=a.priority),a.protocol&&(o.protocol=a.protocol),a.relayProtocol&&(o.relayProtocol=a.relayProtocol)};if(r.localCandidateId){const o=t.get(r.localCandidateId);o&&s(e.local,o)}if(r.remoteCandidateId){const o=t.get(r.remoteCandidateId);o&&s(e.remote,o)}}}),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===Ln.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===Ln.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===Ln.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(oo({},e),oo({},this.stats.selectedCandidatePair.localCandidate)),t.type===Ln.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(oo({},e),oo({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(i=>i.ssrc===t.ssrc);e||(e=xi(py),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let e=this._stats.videoRecv.find(o=>o.ssrc===t.ssrc);e||(e=xi(uy),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(e.ssrc),r=this.lastVideoFramesDecode.get(e.ssrc),s=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const o=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,o,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(i){const o=i.stats,a=s-i.lts;e.framesDecodeFreezeTime=o.framesDecodeFreezeTime,e.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<o.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}r&&s-r.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:e.decodeFrameRate})):r?e.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:0}),t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:oo({},e),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(r=>r.ssrc===t.ssrc);e||(e=xi(ly),this._stats.videoSend.push(e));const i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{const r=new P_(10);r.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,r)}if(t.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(t.ssrc);if(r)r.add(t.retransmittedBytesSent);else{const s=new P_(10);s.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,s)}}if(t.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(t.ssrc);if(r)r.add(t.totalEncodedBytesTarget);else{const s=new P_(10);s.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,s)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){const r=this.lastEncoderMs.get(t.ssrc);if(!r||r.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const s=t.framesEncoded-r.lastFrameCount,o=t.totalEncodeTime-r.lastEncoderTime;e.avgEncodeMs=1e3*o/s}}if(t.framesEncoded&&t.qpSum){const r=this.lastEncoderMs.get(t.ssrc);!r||r.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-r.lastQpSum)/(t.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const r=this.findRemoteStatsId(t.ssrc,Ln.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(i=>i.ssrc===t.ssrc);if(e||(e=xi(hy),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,Ln.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}findRemoteStatsId(t,e){var i;const r=Array.from(Yi(i=this.report).call(i)).find(s=>s.type===e&&s.ssrc===t);return r?r.id:null}processVideoMediaSource(t,e){const i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(e.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,e){const i=this.report.get(t);i&&(e.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,e,i){var r,s,o,a;const c=e?this.report.get(e):void 0,d=(r=c==null?void 0:c.framesSent)!==null&&r!==void 0?r:t.framesSent;if(typeof d!="number")return;let u=(s=c==null?void 0:c.frameWidth)!==null&&s!==void 0?s:t.frameWidth,l=(o=c==null?void 0:c.frameHeight)!==null&&o!==void 0?o:t.frameHeight,p=(a=c==null?void 0:c.framesPerSecond)!==null&&a!==void 0?a:t.framesPerSecond;if(typeof u=="number"&&typeof l=="number"||(u=0,l=0),p==null){const _=Date.now(),R=this.lastVideoFramesSent.get(i.ssrc);R&&_-R.lts>=800?(p=Math.round((d-R.count)/((_-R.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:_,rate:p})):R?p=R.rate:this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:_,rate:0})}i.sentFrame={width:u,height:l,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(t,e,i){var r,s,o,a,c;const d=e?this.report.get(e):void 0,u=(r=d==null?void 0:d.framesReceived)!==null&&r!==void 0?r:t.framesReceived,l=(s=d==null?void 0:d.frameWidth)!==null&&s!==void 0?s:t.frameWidth,p=(o=d==null?void 0:d.frameHeight)!==null&&o!==void 0?o:t.frameHeight,_=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:t.jitterBufferDelay,R=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:t.jitterBufferEmittedCount;if(typeof u=="number"){const f=this.lastVideoFramesRecv.get(i.ssrc),T=Date.now();i.framesReceivedCount=u;let A=0;f&&T-f.lts>=800?(A=Math.round((u-f.count)/((T-f.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:u,lts:T,rate:A})):f?A=f.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:u,lts:T,rate:0}),i.receivedFrame={width:l||0,height:p||0,frameRate:A||0},i.decodedFrame={width:l||0,height:p||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:p||0,frameRate:i.decodeFrameRate||0}}if(_&&R){const f=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let T=f.jitterBufferMs;const A=R-f.jitterBufferEmittedCount;A>0&&(T=1e3*(_-f.jitterBufferDelay)/A),i.jitterBufferMs=T,i.currentDelayMs=Math.round(T),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:_,jitterBufferEmittedCount:R,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(t,e,i){var r,s,o,a;const c=e?this.report.get(e):void 0,d=(r=(s=c==null?void 0:c.echoReturnLoss)!==null&&s!==void 0?s:t.echoReturnLoss)!==null&&r!==void 0?r:0,u=(o=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:t.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;i.aecReturnLoss=d,i.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(t,e,i){var r,s,o,a,c,d,u;const l=e?this.report.get(e):void 0,p=(r=l==null?void 0:l.removedSamplesForAcceleration)!==null&&r!==void 0?r:t.removedSamplesForAcceleration,_=(s=l==null?void 0:l.totalSamplesReceived)!==null&&s!==void 0?s:t.totalSamplesReceived,R=(o=l==null?void 0:l.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,f=(a=l==null?void 0:l.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount,T=(c=l==null?void 0:l.audioLevel)!==null&&c!==void 0?c:t==null?void 0:t.audioLevel,A=(d=l==null?void 0:l.totalSamplesDuration)!==null&&d!==void 0?d:t==null?void 0:t.totalSamplesDuration,N=(u=l==null?void 0:l.concealedSamples)!==null&&u!==void 0?u:t.concealedSamples;if(p&&_&&(i.accelerateRate=p/_),R&&f){const j=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let M=j.jitterBufferMs;const U=f-j.jitterBufferEmittedCount;U>0&&(M=1e3*(R-j.jitterBufferDelay)/U),i.jitterBufferMs=Math.round(M),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:R,jitterBufferEmittedCount:f,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=T;let P=1920;A&&_&&(P=_/A/50,i.receivedFrames=Math.round(_/P)),N&&(i.droppedFrames=Math.round(N/P))}processRemoteInboundStats(t,e){const i=this.report.get(t);i&&(e.packetsLost=i.packetsLost,i.roundTripTime&&(e.rttMs=1e3*i.roundTripTime),i.jitter&&(e.jitterMs=1e3*i.jitter),i.timestamp&&(e.timestamp=i.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const i=e.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,e=null,i=null;this.mediaBytesSent.forEach(s=>{t+=s.diffMean()}),this.mediaBytesRetransmit.forEach(s=>{e=e===null?s.diffMean():e+s.diffMean()}),this.mediaBytesTargetEncode.forEach(s=>{i=i===null?s.diffMean():i+s.diffMean()});const r=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class f2 extends L_{updateStats(){return F.resolve()}}function wu(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null}();return s?s<76?new E2(n,{updateInterval:t,lossRateInterval:e,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new gy(n,{updateInterval:t,lossRateInterval:e,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(o){return!!window.RTCStatsReport&&o.getStats()instanceof F}(n)?new gy(n,{updateInterval:t,lossRateInterval:e,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new f2(n,{updateInterval:t,lossRateInterval:e,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function Ty(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Sy(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Ty(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Ty(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function Cc(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=e;let u=[],l=[],p=[],_=[],R=!1,f=!1;if(oe.parse(n).mediaDescriptions.forEach(A=>{i&&i!==A.attributes.direction||(A.media.mediaType!=="video"||R||(l=A.attributes.payloads,_=A.attributes.extmaps,R=!0),A.media.mediaType!=="audio"||f||(u=A.attributes.payloads,p=A.attributes.extmaps,f=!0))}),!_||l.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!p||u.length===0)throw new Error("Cannot get audio capabilities from SDP.");l.forEach(A=>{var N;(N=A.rtpMap)!==null&&N!==void 0&&N.clockRate&&(A.rtpMap.clockRate=parseInt(A.rtpMap.clockRate)),d&&A.rtcpFeedbacks.push({type:"rrtr"})}),u.forEach(A=>{var N;(N=A.rtpMap)!==null&&N!==void 0&&N.clockRate&&(A.rtpMap.clockRate=parseInt(A.rtpMap.clockRate)),d&&A.rtcpFeedbacks.push({type:"rrtr"})}),r&&(u=u.filter(A=>{var N;return((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLowerCase())!=="rtx"}),l=l.filter(A=>{var N;return((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLowerCase())!=="rtx"})),s&&(l=l.filter(A=>{var N;return!/(red)|(ulpfec)|(flexfec)/i.test(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName)||"")})),o&&(u=u.filter(A=>{var N;return!/(red)|(ulpfec)|(flexfec)/i.test(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(u=u.filter(A=>{var N;return nt(a).call(a,((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0&&(l=l.filter(A=>{var N;return nt(c).call(c,((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLowerCase())||"")}));const T=O("UNSUPPORTED_VIDEO_CODEC");return T&&T.length>0&&(l=l.filter(A=>!(A.rtpMap&&nt(T).call(T,A.rtpMap.encodingName.toLowerCase())))),{audioCodecs:u,videoCodecs:l,audioExtensions:p,videoExtensions:_}}function zi(n){const t=oe.parse(n);let e,i;for(const r of t.mediaDescriptions){if(!e){const s=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!s||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");e={iceUfrag:s,icePwd:o}}if(!i){const s=r.attributes.fingerprints;s.length>0&&(i={fingerprints:s})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!e)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:e,dtlsParameters:i}}function k_(n,t){const e=[],i=n.attributes.ssrcGroups.filter(o=>o.semantic==="FID"),r=n.attributes.ssrcGroups.find(o=>o.semantic==="SIM"),s=n.attributes.ssrcs;if(r)r.ssrcIds.forEach(o=>{var a;const c=(a=i.find(d=>d.ssrcIds[0]===o))===null||a===void 0?void 0:a.ssrcIds[1];e.push({ssrcId:o,rtx:t?c:void 0})});else if(i.length>0){const o=i[0].ssrcIds[0],a=i[0].ssrcIds[1];e.push({ssrcId:o,rtx:t?a:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");e.push({ssrcId:s[0].ssrcId})}return e}function Ry(n,t){const{cname:e}=n;let i;t&&t.ip&&typeof t.port=="number"?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],m.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),m.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=n.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));const r={fingerprints:n.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},s={iceUfrag:n.iceParameters.iceUfrag,icePwd:n.iceParameters.icePwd};let o;switch(n.dtlsParameters.role){case"server":o="passive";break;case"client":o="active";break;case"auto":o="actpass"}return{dtlsParameters:r,iceParameters:s,candidates:i,rtpCapabilities:ca(n.rtpCapabilities),setup:o,cname:e}}function xn(n,t,e){const i=[],r=[];return n.forEach(s=>{let{ssrcId:o,rtx:a}=s;const c=Qt(8,"track-"),d={ssrcId:o,attributes:Sy({label:c,mslabel:e=e||Qt(10,""),msid:"".concat(e," ").concat(c)},t&&{cname:t})};if(i.push(d),a!==void 0){const u={ssrcId:a,attributes:Sy({label:c,mslabel:e,msid:"".concat(e," ").concat(c)},t&&{cname:t})};i.push(u),r.push({semantic:"FID",ssrcIds:[o,a]})}}),n.length>1&&r.push({semantic:"SIM",ssrcIds:n.map(s=>{let{ssrcId:o}=s;return o})}),{ssrcs:i,ssrcGroups:r}}function _s(n,t){t instanceof Vt&&n.attributes.payloads.forEach(e=>{var i;const r=(i=e.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(s.bitrate&&!Jt()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))})}function Ou(n){const t=n.attributes.unrecognized.findIndex(e=>e.attField==="x-google-flag"&&e.attValue==="conference");t!==-1&&n.attributes.unrecognized.splice(t,1)}function Nu(n,t){var e;if(!(t instanceof Ct&&t._encoderConfig&&t._hints.indexOf($t.SCREEN_TRACK)===-1))return;const i=t._encoderConfig;Kt().supportMinBitrate&&i.bitrateMin&&n.attributes.payloads.forEach(r=>{var s,o;nt(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))}),Kt().supportMinBitrate&&!nt(e=t._hints).call(e,$t.LOW_STREAM)&&i.bitrateMax&&n.attributes.payloads.forEach(r=>{var s,o;nt(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(O("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))})}function M_(n){if(n.media.mediaType!=="video")return;const t=Lt();if(t.name!==xt.SAFARI&&t.os!==Ne.IOS)return;const e=n.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));e!==-1&&n.attributes.extmaps.splice(e,1)}function aa(n,t,e){if(!t)return;let i,r;if(n.media.mediaType==="video"?(i=e.videoExtensions,r=e.videoCodecs):(i=e.audioExtensions,r=e.audioCodecs),t.twcc===!0){const s=i.find(o=>o.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");s&&(n.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||n.attributes.extmaps.push({entry:s.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,c){return c.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(l=>l.type==="transport-cc")))}(r,n.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(t.twcc===!1){const s=n.attributes.extmaps.findIndex(o=>o.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");s!==-1&&n.attributes.extmaps.splice(s,1),n.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}if(t.remb===!0){const s=i.find(o=>o.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");s&&(n.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||n.attributes.extmaps.push({entry:s.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,c){return c.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(l=>l.type==="goog-remb")))}(r,n.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(t.remb===!1){const s=n.attributes.extmaps.findIndex(o=>o.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");s!==-1&&n.attributes.extmaps.splice(s,1),n.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}}function U_(n,t,e){if(Jt()||n.media.mediaType!=="video"||!(t instanceof Ct)||e!=="vp9"&&e!=="vp8"||e==="vp8"&&!O("SIMULCAST")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const i=e==="vp8"?2:t._scalabilityMode.numSpatialLayers,r=n.attributes.ssrcs[0],s=n.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)n.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Zt(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(n.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:Zt(r.attributes)}),n.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));n.attributes.ssrcGroups.unshift(o)}async function x_(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly"}),e.addTransceiver("audio",{direction:"sendonly"}),e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const i=(await e.createOffer()).sdp,{send:r,recv:s,sendrecv:o}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const u=Cc(d,a,c,"sendonly"),l=Cc(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},R={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vi(u,l,"videoExtensions",p,_,R),Vi(u,l,"videoCodecs",p,_,R),Vi(u,l,"audioExtensions",p,_,R),Vi(u,l,"audioCodecs",p,_,R),O("RAISE_H264_BASELINE_PRIORITY")){const f=R.videoCodecs.findIndex(T=>{var A,N;return((A=T.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"&&((N=T.fmtp)===null||N===void 0?void 0:N.parameters["profile-level-id"])==="42001f"});if(f!==-1){const T=R.videoCodecs.findIndex(A=>{var N;return((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"});if(T<f){m.debug("raising H264 baseline profile priority");const A=R.videoCodecs[f];R.videoCodecs.splice(f,1),R.videoCodecs.splice(T,0,A)}T!==-1&&(_.videoCodecs=_.videoCodecs.filter(A=>{var N,P;return!(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"&&((P=A.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])!=="42001f")})),T!==-1&&O("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(A=>{var N,P;return!(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"&&((P=A.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])!=="42001f")}))}}return{send:p,recv:_,sendrecv:R}}(n,t,i);try{e.close()}catch{}return{send:r,recv:s,sendrecv:o}}function Cy(){const n={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Cc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),e={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vi(n,t,"videoExtensions",e,i,r),Vi(n,t,"videoCodecs",e,i,r),Vi(n,t,"audioExtensions",e,i,r),Vi(n,t,"audioCodecs",e,i,r),O("RAISE_H264_BASELINE_PRIORITY")){const s=r.videoCodecs.findIndex(o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f");if(s!==-1){const o=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(o<s){m.debug("raising H264 baseline profile priority");const a=r.videoCodecs[s];r.videoCodecs.splice(s,1),r.videoCodecs.splice(o,0,a)}o!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:e,recv:i,sendrecv:r}}function Vi(n,t,e,i,r,s){if(e==="videoExtensions"||e==="audioExtensions"){const o=[];return n[e].forEach(a=>{t[e].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(d),!0})?s[e].push(a):i[e].push(a)}),void t[e].forEach((a,c)=>{o.indexOf(c)===-1&&r[e].push(a)})}if(e==="videoCodecs"||e==="audioCodecs"){const o=[];return n[e].forEach(a=>{t[e].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(d),!0})?s[e].push(a):i[e].push(a)}),void t[e].forEach((a,c)=>{o.indexOf(c)===-1&&r[e].push(a)})}}function ca(n){const{send:t,recv:e,sendrecv:i}=n;if(!i){if(!t||!e)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:e}}let r,s;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=i,e?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...e.audioCodecs,...i.audioCodecs],s.videoCodecs=[...e.videoCodecs,...i.videoCodecs],s.audioExtensions=[...e.audioExtensions,...i.audioExtensions],s.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):s=i,{send:r,recv:s}}function Xi(n){n.media.mediaType==="audio"&&n.attributes.payloads.filter(t=>{var e;return((e=t.rtpMap)===null||e===void 0?void 0:e.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function vc(n){n.mediaDescriptions.forEach(t=>{t.media.mediaType!=="video"&&t.media.mediaType!=="audio"||t.attributes.payloads.forEach(e=>{e.rtcpFeedbacks.findIndex(i=>i.type==="rrtr")===-1&&e.rtcpFeedbacks.push({type:"rrtr"})})})}function ao(n,t,e,i){let r=[];if(n===rt.VIDEO){if(O("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=t.videoCodecs.filter(s=>{var o;return nt(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,i)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===O("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let s=[];const o=[],a=[];e.videoCodecs.forEach(c=>{var d,u,l;nt(d=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(d,i)&&s.push(c),nt(u=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(u,"vp8")&&o.push(c),nt(l=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(l,"h264")&&a.push(c)}),s.length===0&&(o.length!==0?(s=o,m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: vp8"))):a.length!==0&&(s=a,m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: h264")))),s.length!==0&&(r=t.videoCodecs.filter(c=>s.some(d=>d.payloadType===c.payloadType)))}if(O("USE_PUB_RTX")){const s=r.map(a=>a.payloadType.toString()),o=t.videoCodecs.filter(a=>a.rtpMap&&a.rtpMap.encodingName==="rtx"&&nt(s).call(s,a.fmtp&&a.fmtp.parameters.apt||""));r=[...r,...o]}r.length===0&&(m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs)}else r=t.audioCodecs.filter(s=>{var o;return nt(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,i)}),r.length===0&&(m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter(s=>{var o;return nt(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,"opus")}));return r}let vy=class{get localCapabilities(){return Zt(this._localCapabilities)}get rtpCapabilities(){return Zt(this._rtpCapabilities)}get candidates(){return Zt(this._candidates)}get iceParameters(){return Zt(this._iceParameters)}get dtlsParameters(){return Zt(this._dtlsParameters)}constructor(n){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname","o/i14u9pJrxRKAsu"),h(this,"firefoxSsrcMidMap",new Map),n=Zt(n);const{remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:r,localCapabilities:s,direction:o,setup:a,videoCodec:c,audioCodec:d}=n;let u;this.setup=a,u=o===ln.RECEIVE_ONLY?oe.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):oe.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=e,this._localCapabilities=s;const l=o===ln.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=o===ln.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,_=o===ln.RECEIVE_ONLY?r.send.videoCodecs:ao(rt.VIDEO,l,p,c),R=o===ln.RECEIVE_ONLY?r.send.audioCodecs:ao(rt.AUDIO,l,p,d);for(const f of u.mediaDescriptions){if(f.attributes.iceUfrag=t.iceUfrag,f.attributes.icePwd=t.icePwd,f.attributes.fingerprints=e.fingerprints,f.attributes.candidates=i,f.attributes.setup=this.setup,f.media.mediaType==="application"&&(f.attributes.sctpPort="5000"),f.media.mediaType==="video"&&(f.media.fmts=_.map(T=>T.payloadType.toString(10)),f.attributes.payloads=_,f.attributes.extmaps=l.videoExtensions,O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:T,ssrcGroups:A}=xn([{ssrcId:4e4,rtx:O("USE_SUB_RTX")?40001:void 0}],this.cname);f.attributes.ssrcs=T,f.attributes.ssrcGroups=A}if(f.media.mediaType==="audio"&&(f.media.fmts=R.map(T=>T.payloadType.toString(10)),f.attributes.payloads=R,f.attributes.extmaps=l.audioExtensions,Xi(f),O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:T,ssrcGroups:A}=xn([{ssrcId:2e4}],this.cname);f.attributes.ssrcs=T,f.attributes.ssrcGroups=A}}this.sessionDesc=u,this.currentMidIndex=u.mediaDescriptions.length-1}toString(){return oe.print(this.sessionDesc)}hasMid(n){return Array.isArray(n)?n.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===n)}send(n,t,e,i,r){e=e.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:o}=xn(t,this.cname,O("SYNC_GROUP")?e:void 0),a=this.findPreloadMediaDesc(s);if(a){if(Jt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(n,s,i);let d;return c===-1?(d=this.createOrRecycleSendMedia(n,s,o,"sendonly",i,r),this.updateBundleMids()):(d=Zt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=s,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Jt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(n){const t=this.sessionDesc.mediaDescriptions.filter(e=>e.attributes.mid&&n.indexOf(e.attributes.mid)!==-1);if(t.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(e=>{e.attributes.ssrcs=[]}),this.updateBundleMids()}receive(n,t,e){const i=[];return n.forEach(r=>{const s=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",t,e),this.updateBundleMids()):(a=Zt(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})}),i}stopReceiving(n){const t=this.sessionDesc.mediaDescriptions.filter(e=>n.indexOf(e.attributes.mid)!==-1);if(t.length!==n.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(e=>{e.media.port="0",e.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(n){const{foundation:t,protocol:e,address:i,port:r,type:s,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(n),d={foundation:t??"",componentId:"1",transport:e??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:s?s+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some(u=>u.priority===d.priority&&u.connectionAddress===d.connectionAddress&&u.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(u=>{u.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(n,t,e,i,r){const s=n._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=ao(s,o,this.localCapabilities.send,s===rt.AUDIO?r:i),c=s===rt.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let u={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:e,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungRecvMediaDsec(u,n);const l=this.findFirstClosedMedia(s);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}muteRemote(n){const t=this.sessionDesc.mediaDescriptions.filter(e=>nt(n).call(n,e.attributes.mid||""));if(t.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(e=>{e.attributes.direction="inactive"})}unmuteRemote(n){const t=this.sessionDesc.mediaDescriptions.filter(e=>nt(n).call(n,e.attributes.mid||""));if(t.length!==n.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(e=>{e.attributes.direction="recvonly"})}findAvailableMediaIndex(n,t,e){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===n&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Jt()){if(r){const s=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(s||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!s||s!==i.attributes.mid)}return!1}return r&&i.attributes.mid===e})}findAvailableRecvMediaIndex(n){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const e=t.media.mediaType===n&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&e})}predictReceivingMids(n){const t=[];for(let e=0;e<n;e++)t.push((this.currentMidIndex+e+1).toString(10));return t}restartICE(n){n=Zt(n),this._iceParameters=n,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=n.iceUfrag,t.attributes.icePwd=n.icePwd})}createOrRecycleSendMedia(n,t,e,i,r,s){const o=this.rtpCapabilities.send,a=n===rt.VIDEO?o.videoCodecs:o.audioCodecs,c=n===rt.VIDEO?o.videoExtensions:o.audioExtensions;Jt()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:n,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(l=>l.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:e,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,s);const u=this.findFirstClosedMedia(n);if(u){const l=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[l]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(n,t,e){const i=Zt(n);return Ou(i),_s(i,t),Nu(i,t),M_(i),aa(i,e,this.localCapabilities.send),i}mungSendMediaDesc(n,t){const e=Zt(n);return aa(e,t,this.localCapabilities.recv),Xi(e),e}updateRecvMedia(n,t){const e=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===n);if(e!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[e],t);this.sessionDesc.mediaDescriptions[e]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(n=>n.media.port!=="0").map(n=>n.attributes.mid)}findPreloadMediaDesc(n){return this.sessionDesc.mediaDescriptions.find(t=>{var e;return((e=t.attributes)===null||e===void 0||(e=e.ssrcs[0])===null||e===void 0?void 0:e.ssrcId)===n[0].ssrcId})}findFirstClosedMedia(n){return this.sessionDesc.mediaDescriptions.find(t=>Jt()?t.media.port==="0"&&t.media.mediaType===n:t.media.port==="0")}};const g2=["sdp"];function yy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function ms(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?yy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):yy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}let li=class ga extends eC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return(t=(e=this.peerConnection.getReceivers()[0])===null||e===void 0||(e=e.transport)===null||e===void 0?void 0:e.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,e,i){super(t,e),h(this,"direction",void 0),h(this,"name",void 0),h(this,"store",void 0),h(this,"spec",void 0),h(this,"peerConnection",void 0),h(this,"initialOffer",void 0),h(this,"transport",void 0),h(this,"statsFilter",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"localCandidateAddress",null),h(this,"useXR",O("USE_XR")),h(this,"filter",{filterRTX:!O("USE_PUB_RTX")&&!O("USE_SUB_RTX"),filterVideoFec:O("FILTER_VIDEO_FEC"),filterAudioFec:O("FILTER_AUDIO_FEC")}),h(this,"extension",{useXR:this.useXR}),h(this,"_isInRestartIce",!1),h(this,"mutex",new He("P2PConnection-mutex")),h(this,"onLocalCandidate",void 0),h(this,"remoteSDP",void 0),h(this,"pendingCandidates",[]),h(this,"localCapabilities",void 0),h(this,"isReady",!1),h(this,"restartCnt",0),h(this,"curTurnServerIndex",0),this.store=e,this.spec=t,this.peerConnection=new RTCPeerConnection(ga.resolvePCConfiguration(t,e.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??ln.SEND_ONLY,this.name=this.direction===ln.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=wu(this.peerConnection,O("STATS_UPDATE_INTERVAL"),void 0,Jt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const e=await x_(this.filter,this.extension);if(this.localCapabilities=ca(e),t){const{sdp:i}=t,r=_2(t,g2),s=function(){const u={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},l=Cc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},R={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vi(l,u,"videoExtensions",p,_,R),Vi(l,u,"videoCodecs",p,_,R),Vi(l,u,"audioExtensions",p,_,R),Vi(l,u,"audioCodecs",p,_,R),O("RAISE_H264_BASELINE_PRIORITY")){const f=R.videoCodecs.findIndex(T=>T.rtpMap&&T.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&T.fmtp&&T.fmtp.parameters["profile-level-id"]==="42001f");if(f!==-1){const T=R.videoCodecs.findIndex(A=>A.rtpMap&&A.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(T<f){m.debug("raising H264 baseline profile priority");const A=R.videoCodecs[f];R.videoCodecs.splice(f,1),R.videoCodecs.splice(T,0,A)}T!==-1&&O("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(A=>!(A.rtpMap&&A.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&A.fmtp&&A.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:p,recv:_,sendrecv:R}}(this.filter,this.extension,i);this.remoteSDP=new vy({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=zi(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await Cy(this.filter,this.extension,o.sdp);this.localCapabilities=ca(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),ms(ms({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=zi(i.sdp);return this.initialOffer=i,ms(ms({},r),{},{sdp:i.sdp})}}catch(e){throw new G(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:e,iceParameters:i,dtlsParameters:r}=t,s=await Cy(this.filter,this.extension,e);this.remoteSDP=new vy({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(e=>{this.peerConnection.addIceCandidate(e)}),this.pendingCandidates=[])}catch(e){throw new G(v.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=r.remoteSDP.receive(t,e,i);t.forEach((T,A)=>{if(a[A].needCreateTransceiver){const N=r.peerConnection.addTransceiver(T._mediaStreamTrack,{direction:"sendonly"});o.push(N),T._updateRtpTransceiver(N)}else{const N=r.peerConnection.getTransceivers().find(P=>P.mid===a[A].mid);if(!N)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[A].mid));o.push(N),T._updateRtpTransceiver(N)}}),Jt()&&O("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(o,t)));const c=a.map(T=>T.mid),d=yield St(r.peerConnection.createOffer()),u=r.mungSendOfferSDP(d.sdp,t,c),l=oe.parse(u),p=c.map(T=>{const A=l.mediaDescriptions.find(N=>N.attributes.mid===T);if(!A)throw new Error("Cannot extract ssrc from mediaDescription.");return k_(A,O("USE_PUB_RTX"))}),_=o.map((T,A)=>{const N=c[A];return{localSSRC:p[A],id:N}});yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:u}));try{yield _}catch(T){const A=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:A})),yield St(r.stopSending(c,!0)),T}yield St(r.applySimulcastEncodings(o,t)),yield St(r.applySendEncodings(o,t));const R=r.remoteSDP.toString(),f=r.logSDPExchange(u,"offer","local","send");return f==null||f(R),yield St(r.setRemoteDescription({type:"answer",sdp:R})),o.map((T,A)=>{const N=c[A];return{localSSRC:p[A],id:N}})}catch(o){throw o instanceof G?o:new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}})()}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,e,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,s,t);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===s);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(s){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(t,e,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,r);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(d.sdp,s,t);c==null||c(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(s){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Ir.Auto&&(this.store.p2pTransport=Ir.SdRtn,Kt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ga.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Kt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ga.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=zi(e.sdp);return this.store.descriptionStart(),this.direction===ln.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===ln.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=zi(e.sdp);return await this.peerConnection.setLocalDescription(e),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new G(v.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(e)?Jt()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find(r=>r.mid===e);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:i,remote:r}=e.getSelectedCandidatePair();return{local:ms(ms({},mr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:ms(ms({},mr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,e;nt(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var e;t.candidate.candidate&&(this.localCandidateAddress=t.candidate.address,(e=this.onLocalCandidate)===null||e===void 0||e.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var s;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(xo(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...ga.turnServerConfigToIceServers(t.turnServer.servers,e,i)),O("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...ga.turnServerConfigToIceServers(t.turnServer.serversFromGateway,e,i)),nt(s=[Ir.Relay,Ir.SdRtn]).call(s,e)&&(r.iceTransportPolicy="relay"),O("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(r.iceTransportPolicy="relay")}))),O("ENABLE_ENCODED_TRANSFORM")&&Kt().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),m.debug("P2PConnection p2pTransport is ".concat(e)),r}static turnServerConfigToIceServers(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],s=t.filter(a=>a.tcpport);m.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(i));const o=s.length>i?s[i]:s[0];switch(e){case Ir.SdRtn:const a=t.filter(d=>{var u;return nt(u=d.username).call(u,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(rs(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(rs(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Ir.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(rs(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(rs(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var i;t!=null&&t.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,t.state))},t.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const e=t.iceTransport;e&&(e.onstatechange=()=>{const i=t==null?void 0:t.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},e.getSelectedCandidatePair&&(e.onselectedcandidatepairchange=()=>{if(e.getSelectedCandidatePair()){const{local:i,remote:r}=e.getSelectedCandidatePair();m.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find(u=>u.track===t._mediaStreamTrack)),!e)return m.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return m.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Kt().supportSetRtpSenderParameters)return m.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:u,frameRate:l,scaleResolutionDownBy:p}=t._encoderConfig;u&&(s.maxBitrate=1e3*u),nt(o=t._hints).call(o,$t.LOW_STREAM)&&(l&&(s.maxFramerate=ri(l)),p&&p>=1&&(s.scaleResolutionDownBy=p))}if(O("DSCP_TYPE")&&Jr()){var a;const u=O("DSCP_TYPE");nt(a=["very-low","low","medium","high"]).call(a,u)&&(s.networkPriority=u)}const c=e.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];Jt()&&!d&&(r.encodings=[s]),d&&Object.assign(d,s),Object.assign(c,r),m.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await e.setParameters(c)}async applySendEncodings(t,e){try{if(!Kt().supportSetRtpSenderParameters||t.length!==e.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=e[i];s instanceof Ct&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,i){const r=oe.parse(t);return e.forEach((s,o)=>{const a=i[o],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(_s(c,s),U_(c,s,this.store.codec))}),oe.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],u=e[c];if(u instanceof Ct&&!nt(i=u._hints).call(i,$t.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=u._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=u._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,l))}}}async applySimulcastEncodings(t,e){if(!Jt()&&t.length===e.length)for(let i=0;i<t.length;i++){const r=e[i];if(r instanceof Ct&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,i,r,s,o;return!!(t instanceof Ct&&O("SIMULCAST")&&this.store.codec==="vp8"&&!nt(e=t._hints).call(e,$t.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,r){if(O("SDP_LOGGING"))return m.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(e," SDP during P2PConnection.").concat(r,`
`),t),e==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async o=>{o.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(t,e){var i,r;if(e=(i=e)!==null&&i!==void 0?i:(r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp){var s;const o=(s=oe.parse(e).mediaDescriptions.find(a=>a.attributes.mid===t))===null||s===void 0?void 0:s.attributes.ssrcs;return o==null?void 0:o[0].ssrcId}}async setRemoteDescription(t){var e;await this.peerConnection.setRemoteDescription(t),nt(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,e,i){const r=oe.parse(t),s=r.mediaDescriptions.find(o=>o.attributes.mid===e);return s&&(i===rt.AUDIO&&s.media.mediaType==="audio"&&Xi(s),this.useXR&&vc(r)),oe.print(r)}};function Fi(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function V_(n,t){let e=document.createElement("video"),i=document.createElement("canvas");e.setAttribute("style","display:none"),i.setAttribute("style","display:none"),e.setAttribute("muted",""),e.muted=!0,e.setAttribute("autoplay",""),e.autoplay=!0,e.setAttribute("playsinline",""),i.width=ri(t.width),i.height=ri(t.height);const r=ri(t.framerate||15);document.body.append(e),document.body.append(i);let s=n._mediaStreamTrack;e.srcObject=new MediaStream([s]),e.play();const o=i.getContext("2d");if(!o)throw new k(v.UNEXPECTED_ERROR,"can not get canvas context");const a=Kt(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!e)return i.stopCapture&&i.stopCapture();if(e.paused&&e.play(),e.videoHeight>2&&e.videoWidth>2){const u=e.videoWidth,l=e.videoHeight/u,p=i.width*l;Math.abs(p-i.height)>=2&&(m.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(p)),i.height=p)}o.drawImage(e,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),s!==n._mediaStreamTrack&&(s=n._mediaStreamTrack,e.srcObject=new MediaStream([s]))},i.stopCapture=Xp(()=>i.startCapture&&i.startCapture(),r);const d=c.stop;return c.stop=()=>{d.call(c),e&&(e.remove(),e.srcObject=null,e=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),m.debug("clean low stream renderer")},c}var yc,Iy,Ve,Es,on,da,F_,kr,vi,B_,hi;W([Fi,S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],li.prototype,"establish",null),W([Fi,S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],li.prototype,"connect",null),W([Fi,S("design:type",Function),S("design:paramtypes",[String,Array,String,String]),S("design:returntype",F)],li.prototype,"receive",null),W([Fi,S("design:type",Function),S("design:paramtypes",[String,Array,String,String]),S("design:returntype",F)],li.prototype,"mockReceive",null),W([Fi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],li.prototype,"stopReceiving",null),W([Fi,S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],li.prototype,"restartICE",null),W([Fi,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],li.prototype,"close",null),W([Fi,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],li.prototype,"updateEncoderConfig",null),W([Fi,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],li.prototype,"updateSendParameters",null),W([Fi,S("design:type",Function),S("design:paramtypes",[rn,String]),S("design:returntype",F)],li.prototype,"replaceTrack",null),W([Fi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],li.prototype,"muteLocal",null),W([Fi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],li.prototype,"unmuteLocal",null),function(n){n[n.HEIGHT=2033]="HEIGHT",n[n.FRAME_RATE=2034]="FRAME_RATE",n[n.WIDTH=2035]="WIDTH"}(yc||(yc={})),function(n){n[n.HEIGHT=2072]="HEIGHT",n[n.FRAME_RATE=2074]="FRAME_RATE",n[n.WIDTH=2076]="WIDTH"}(Iy||(Iy={})),function(n){n[n.FRAME_RATE=2002]="FRAME_RATE",n[n.WIDTH=2003]="WIDTH",n[n.HEIGHT=2004]="HEIGHT",n[n.PACKAGE_LOST=2005]="PACKAGE_LOST",n[n.AVG_ENCODE=2007]="AVG_ENCODE",n[n.NACKS=2009]="NACKS",n[n.PLIS=2010]="PLIS",n[n.FIRS=2011]="FIRS",n[n.BITRATE=2012]="BITRATE",n[n.PACKAGE_RATE=2031]="PACKAGE_RATE",n[n.ADAPTATION=2032]="ADAPTATION",n[n.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",n[n.BANDWIDTH=2061]="BANDWIDTH",n[n.RETRANSMIT=2062]="RETRANSMIT",n[n.TARGET_ENCODED=2064]="TARGET_ENCODED",n[n.TRANSMIT=2066]="TRANSMIT",n[n.FREEZE=2082]="FREEZE",n[n.DISABLED=2095]="DISABLED",n[n.PLAYER_STATUS=2128]="PLAYER_STATUS",n[n.QP_SUM=2143]="QP_SUM"}(Ve||(Ve={})),function(n){n[n.BITRATE=2069]="BITRATE",n[n.PACKAGE_LOST=2070]="PACKAGE_LOST",n[n.PACKAGE_RATE=2071]="PACKAGE_RATE",n[n.HEIGHT=2073]="HEIGHT",n[n.FRAME_RATE=2075]="FRAME_RATE",n[n.WIDTH=2077]="WIDTH"}(Es||(Es={})),function(n){n[n.JITTER=-1]="JITTER",n[n.PACKAGE_LOST=2014]="PACKAGE_LOST",n[n.WIDTH=2018]="WIDTH",n[n.HEIGHT=2019]="HEIGHT",n[n.FRAME_RATE=2020]="FRAME_RATE",n[n.JITTER_BUFFER=2023]="JITTER_BUFFER",n[n.CURRENT_DELAY=2024]="CURRENT_DELAY",n[n.NACKS=2026]="NACKS",n[n.PLIS=2027]="PLIS",n[n.FIRS=2028]="FIRS",n[n.BITRATE=2029]="BITRATE",n[n.PACKAGE_RATE=2078]="PACKAGE_RATE",n[n.FREEZE=2084]="FREEZE",n[n.DISABLED=2101]="DISABLED",n[n.PLAYER_STATUS=2129]="PLAYER_STATUS",n[n.QP_SUM=2144]="QP_SUM",n[n.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(on||(on={})),function(n){n[n.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",n[n.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",n[n.FREEZE_TIME=2109]="FREEZE_TIME",n[n.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(da||(da={})),function(n){n[n.PCM_LEVEL=2104]="PCM_LEVEL"}(F_||(F_={})),function(n){n[n.PACKAGE_LOST=-1]="PACKAGE_LOST",n[n.LEVEL=2038]="LEVEL",n[n.BITRATE=2039]="BITRATE",n[n.PACKAGE_RATE=2040]="PACKAGE_RATE",n[n.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",n[n.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",n[n.FREEZE=2081]="FREEZE",n[n.DISABLED=2096]="DISABLED"}(kr||(kr={})),function(n){n[n.BITRATE=2044]="BITRATE",n[n.PACKAGE_LOST=2045]="PACKAGE_LOST",n[n.PACKAGE_RATE=2046]="PACKAGE_RATE",n[n.CURRENT_DELAY=2047]="CURRENT_DELAY",n[n.JITTER_BUFFER=2054]="JITTER_BUFFER",n[n.JITTER=2055]="JITTER",n[n.FREEZE=2083]="FREEZE",n[n.DISABLED=2102]="DISABLED",n[n.PCM_LEVEL=2105]="PCM_LEVEL",n[n.PLAYER_STATUS=2130]="PLAYER_STATUS",n[n.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(vi||(vi={})),function(n){n[n.FREEZE_TIME=-1]="FREEZE_TIME",n[n.LEVEL=2043]="LEVEL"}(B_||(B_={})),function(n){n[n.RTT=2006]="RTT",n[n.CONN_TYPE=801]="CONN_TYPE"}(hi||(hi={}));const Mr=1e3,co=3;function bt(n,t,e){e!=null&&Number.isFinite(e)&&(n[t]=Math.round(Math.max(0,e)))}function Ay(n){const t={[hi.CONN_TYPE]:0,[hi.RTT]:n.rtt};switch(n.selectedCandidatePair.localCandidate.candidateType){case"relay":{const e=n.selectedCandidatePair.localCandidate.relayProtocol;e==="udp"&&(t[hi.CONN_TYPE]=1),e==="tcp"&&(t[hi.CONN_TYPE]=3),e==="tls"&&(t[hi.CONN_TYPE]=4);break}case"srflx":t[hi.CONN_TYPE]=2}return t}class by extends se{constructor(t){super(),h(this,"store",void 0),h(this,"uploadWRTCStatsTimer",void 0),h(this,"uploadOutboundDenoiserStatsTimer",void 0),h(this,"uploadExtStatsTimer",void 0),h(this,"uploadExtUsageStatsTimer",void 0),h(this,"uploadInboundExtStatsTimer",void 0),h(this,"requestStats",void 0),h(this,"requestTransportStats",void 0),h(this,"requestLocalMedia",void 0),h(this,"requestRemoteMedia",void 0),h(this,"requestAllTracks",void 0),h(this,"requestVideoIsReady",void 0),h(this,"requestUploadStats",void 0),h(this,"requestUpload",void 0),h(this,"uploadOutboundStarted",!1),h(this,"uploadInboundStarted",!1),h(this,"uploadTransportStarted",!1),h(this,"uploadExtensionUsageStarted",!1),h(this,"lastRecvStats",void 0),h(this,"lastSendStats",void 0),h(this,"lastFullRecvStats",void 0),h(this,"lastFullSendStats",void 0),h(this,"needUploadRenderFreezeTime",!0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;let e,i;if(this.uploadTransportStarted&&(e=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!e&&this.uploadOutboundStarted&&(e=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),e||i){const r={};if(this.uploadTransportStarted&&e){const s=this.getTransportStats(e,i,t);s&&(r.misc=[s])}if(this.uploadOutboundStarted&&e){const s=this.getOutboundStats(e,t?this.lastSendStats:this.lastFullSendStats,t);s&&(r.outbound=[s])}if(this.uploadInboundStarted&&i){const s=this.getInboundStats(i,t?this.lastRecvStats:this.lastFullRecvStats,t);s&&(r.inbound=s)}this.requestUploadStats(r)}this.lastRecvStats=i,this.lastSendStats=e,t||(this.lastFullRecvStats=i,this.lastFullSendStats=e)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(t!==co),++t===co+1&&(t=1)},Mr)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(t,e,i){if(!this.requestStats)return;if(i)return t.rtt==null?void 0:{addition:{[hi.RTT]:t.rtt,[hi.CONN_TYPE]:void 0}};const r=Ay(t);if(this.store.useP2P){if(e){const s=Ay(e);r[hi.CONN_TYPE]+=s[hi.CONN_TYPE]<<3}r[hi.CONN_TYPE]+=110}else r[hi.CONN_TYPE]+=100;return{addition:r}}getOutboundStats(t,e,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const r=this.requestLocalMedia();if(!r||r.length===0)return;let s,o,a;return r.forEach(c=>{let[d,{track:u,ssrcs:l}]=c;switch(d){case Y.LocalVideoLowTrack:case Y.LocalVideoTrack:if(d===Y.LocalVideoTrack){const p=function(f,T,A,N,P){const j=T.videoSend.find(q=>q.ssrc===f);if(!j)return;const M={},{sentFrame:U,inputFrame:B}=j;if(B&&U){const q=B.frameRate,z=U.frameRate;M[Ve.FREEZE]=function(mt,Rt){let te=!0;return te=!(mt<=5)&&(mt<=10?Rt<3:mt<=20?Rt<4:Rt<5),te}(q,z)?1:0}if(bt(M,Ve.QP_SUM,j.qpSumPerFrame),P)return M;switch(U&&(bt(M,Ve.HEIGHT,U.height),bt(M,Ve.WIDTH,U.width),bt(M,Ve.FRAME_RATE,U.frameRate)),M[Ve.DISABLED]=N._originMediaStreamTrack&&!N._originMediaStreamTrack.enabled||N._mediaStreamTrack&&!N._mediaStreamTrack.enabled?1:0,j.adaptionChangeReason){case"none":M[Ve.ADAPTATION]=0;break;case"cpu":M[Ve.ADAPTATION]=1;break;case"bandwidth":M[Ve.ADAPTATION]=2;break;case"other":M[Ve.ADAPTATION]=3}M[Ve.PLAYER_STATUS]=Jp[N._player?N._player.videoElementStatus:"uninit"],bt(M,Ve.NACKS,j.nacksCount),bt(M,Ve.PLIS,j.plisCount),bt(M,Ve.FIRS,j.firsCount),bt(M,Ve.AVG_ENCODE,j.avgEncodeMs);const V=A&&A.videoSend.find(q=>q.ssrc===f);if(V){let q=P?Mr:Mr*co;V.timestamp&&j.timestamp&&(q=j.timestamp-V.timestamp),V.packets!=null&&j.packets!=null&&bt(M,Ve.PACKAGE_RATE,1e3*(j.packets-V.packets)/q),j.packetsLost!=null&&V.packetsLost!=null&&bt(M,Ve.PACKAGE_LOST,j.packetsLost-V.packetsLost),V.bytes!=null&&j.bytes!=null&&bt(M,Ve.BITRATE,8*(j.bytes-V.bytes)/q)}return M}(l[0].ssrcId,t,e,u,i),_=i?null:function(f,T,A){const N=T.videoSend.find(V=>V.ssrc===f);if(!N)return null;const P={},j=N.inputFrame,M=j&&j.height||A&&A._videoHeight||0,U=j&&j.width||A&&A._videoWidth||0,B=j&&j.frameRate||0;return bt(P,yc.HEIGHT,M),bt(P,yc.WIDTH,U),bt(P,yc.FRAME_RATE,B),P}(l[0].ssrcId,t,u),R=i?null:function(f){const T={};return bt(T,Ve.RETRANSMIT,f.bitrate.retransmit),bt(T,Ve.TARGET_ENCODED,f.bitrate.targetEncoded),bt(T,Ve.ACTUAL_ENCODED,f.bitrate.actualEncoded),bt(T,Ve.TRANSMIT,f.bitrate.transmit),bt(T,Ve.BANDWIDTH,f.sendBandwidth),T}(t);o=Object.assign({},p,_,R)}else a=i?void 0:function(p,_,R){const f=_.videoSend.find(N=>N.ssrc===p);if(!f)return;const T={},A=f.sentFrame;if(A&&(bt(T,Es.HEIGHT,A.height),bt(T,Es.WIDTH,A.width),bt(T,Es.FRAME_RATE,A.frameRate)),R){const N=R.videoSend.find(P=>P.ssrc===p);if(N){let P=Mr*co;N.timestamp&&f.timestamp&&(P=f.timestamp-N.timestamp),N.packets!=null&&f.packets!=null&&bt(T,Es.PACKAGE_RATE,1e3*(f.packets-N.packets)/P),f.packetsLost!=null&&N.packetsLost!=null&&bt(T,Es.PACKAGE_LOST,f.packetsLost-N.packetsLost),N.bytes!=null&&f.bytes!=null&&bt(T,Es.BITRATE,8*(f.bytes-N.bytes)/P)}}return T}(l[0].ssrcId,t,e);break;case Y.LocalAudioTrack:s=i?void 0:function(p,_,R,f){const T=_.audioSend.find(M=>M.ssrc===p);if(!T)return;const A={};A[kr.DISABLED]=f._originMediaStreamTrack&&!f._originMediaStreamTrack.enabled||f._mediaStreamTrack&&!f._mediaStreamTrack.enabled?1:0;const N=f._source.getAccurateVolumeLevel(),P=T.inputLevel;bt(A,kr.LEVEL,100*(P??N)),bt(A,F_.PCM_LEVEL,100*N),bt(A,kr.AEC_RETURN_LOSS,T.aecReturnLoss),bt(A,kr.AEC_RETURN_LOSS_ENH,T.aecReturnLossEnhancement),A[kr.FREEZE]=0;const j=R&&R.audioSend.find(M=>M.ssrc===p);if(j){let M=Mr*co;j.timestamp&&T.timestamp&&(M=T.timestamp-j.timestamp),j.bytes!=null&&T.bytes!=null&&bt(A,kr.BITRATE,8*(T.bytes-j.bytes)/M),j.packets!=null&&T.packets!=null&&bt(A,kr.PACKAGE_RATE,1e3*(T.packets-j.packets)/M)}return A}(l[0].ssrcId,t,e,u)}}),{high:o,low:a,audio:s}}getInboundStats(t,e,i){if(!this.requestRemoteMedia)return;const r=this.requestRemoteMedia()||[],s=[];return r.forEach(o=>{let[a,c]=o;const d={peer:a.uid};if(c.has(rt.VIDEO)&&a.videoTrack){const u=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,l=a.videoTrack?function(p,_,R,f,T,A,N){const P=_.videoRecv.find(q=>q.ssrc===p);if(!P)return;const j={},{receivedFrame:M,outputFrame:U,decodeFrameRate:B}=P,V=R&&R.videoRecv.find(q=>q.ssrc===p);if(j[on.FREEZE]=T&&Ic.isRemoteVideoFreeze(f,P,V)?1:0,bt(j,da.FRAME_RATE_DECODE,B),bt(j,on.QP_SUM,P.qpSumPerFrame),P.framesRateFirefox&&bt(j,on.FRAME_RATE,P.framesRateFirefox),M&&bt(j,on.FRAME_RATE,M.frameRate),V){const q=_.timestamp-R.timestamp||(N?Mr:co*Mr);P.packetsLost!=null&&V.packetsLost!=null&&bt(j,on.PACKAGE_LOST,P.packetsLost-V.packetsLost),V.bytes!=null&&P.bytes!=null&&bt(j,on.BITRATE,8*(P.bytes-V.bytes)/q),V.packets!=null&&P.packets!=null&&bt(j,on.PACKAGE_RATE,1e3*(P.packets-V.packets)/q)}if(N)return j;if(M?(bt(j,on.HEIGHT,M.height),bt(j,on.WIDTH,M.width)):f&&(bt(j,on.HEIGHT,f._videoHeight||0),bt(j,on.WIDTH,f._videoWidth||0)),U&&bt(j,da.FRAME_RATE_RENDER,U.frameRate),bt(j,on.JITTER_BUFFER,P.jitterBufferMs),bt(j,on.CURRENT_DELAY,P.currentDelayMs),bt(j,on.FIRS,P.firsCount),bt(j,on.NACKS,P.nacksCount),bt(j,on.PLIS,P.plisCount),f){j[on.DISABLED]=f._originMediaStreamTrack.enabled&&f._mediaStreamTrack.enabled?0:1;const q=f._player;if(q){const{freezeTimeCounterList:z,renderFreezeAccTime:mt}=q;if(z&&z.length>0&&bt(j,da.FREEZE_TIME,z.splice(0,1)[0]),A&&Nr.visibility==="visible"){const Rt=Math.min(6e3,mt);q.renderFreezeAccTime=Math.max(0,mt-Rt),bt(j,da.FREEZE_TIME_RENDER,Rt)}}}if(j[on.PLAYER_STATUS]=Jp[f._player?f._player.videoElementStatus:"uninit"],V&&P.totalInterFrameDelay!==void 0&&P.totalSquaredInterFrameDelay!==void 0&&V.totalInterFrameDelay!==void 0&&V.totalSquaredInterFrameDelay!==void 0){const q=P.totalInterFrameDelay-V.totalInterFrameDelay,z=P.totalSquaredInterFrameDelay-V.totalSquaredInterFrameDelay,mt=P.framesDecodeCount-V.framesDecodeCount,Rt=q/mt*1e3,te=Math.round(1e3*Math.sqrt((z-Math.pow(q,2)/mt)/mt));!isNaN(te)&&Rt+te>Math.max(3*Rt,Rt+150)&&(j[on.I_FRAME_DELAY]=te)}return j}(a._videoSSRC,t,e,a.videoTrack,u===!0,this.needUploadRenderFreezeTime,i):void 0;l&&(d.video=l)}if(c.has(rt.AUDIO)&&a.audioTrack){const u=a.audioTrack?function(l,p,_,R,f){const T=p.audioRecv.find(q=>q.ssrc===l);if(!T)return;const A={},N=_&&_.audioRecv.find(q=>q.ssrc===l),{receivedFrames:P,droppedFrames:j}=T;var M,U;if(bt(A,vi.JITTER,T.jitterMs),P!=null&&j!=null&&(A[vi.FREEZE]=(U=j,(M=P)===0||100*U/M>20?1:0)),N){const q=p.timestamp-_.timestamp||(f?Mr:Mr*co);T.packets!=null&&N.packets!=null&&bt(A,vi.PACKAGE_RATE,1e3*(T.packets-N.packets)/q),N.bytes!=null&&T.bytes!=null&&bt(A,vi.BITRATE,8*(T.bytes-N.bytes)/q),T.packetsLost!=null&&N.packetsLost!=null&&bt(A,vi.PACKAGE_LOST,T.packetsLost-N.packetsLost)}if(f)return A;const B=R._source.getAccurateVolumeLevel(),V=T.outputLevel;if(bt(A,B_.LEVEL,100*(V??B)),bt(A,vi.PCM_LEVEL,100*B),R&&(A[vi.DISABLED]=R._originMediaStreamTrack.enabled&&R._mediaStreamTrack.enabled?0:1),bt(A,vi.JITTER_BUFFER,T.jitterBufferMs),bt(A,vi.CURRENT_DELAY,T.jitterBufferMs),A[vi.PLAYER_STATUS]=Jp[Un.getPlayerState(R.getTrackId())],N){const q=T.concealedSamples-N.concealedSamples;q>0&&bt(A,vi.CONCEALED_SAMPLES,q)}return A}(a._audioSSRC,t,e,a.audioTrack,i):void 0;u&&(d.audio=u)}(d.video||d.audio)&&s.push(d)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(e=>e instanceof $s);if(t&&t._external.getDenoiserStats){const e=t._external.getDenoiserStats();e&&this.requestUpload(Ar.DENOISER_STATS,e)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[e,i]=t;i.has(rt.VIDEO)&&e.videoTrack&&e.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),i.has(rt.AUDIO)&&e.audioTrack&&e.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const e=Date.now(),i={connectionInterval:O("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:e};let r=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of s)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,u]of o)u.has(rt.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),u.has(rt.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,u){const l={};for(const{id:f,value:T,level:A,direction:N}of d){var p;const P=(p=u.get(f))!==null&&p!==void 0?p:0,j=T===2?P+O("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:P;var _,R;u.set(f,j),l[f]?(T===2&&(l[f].value=T),A>l[f].level&&(l[f].level=A),N==="remote"&&(l[f].remoteUidCount+=1),l[f].totalTs=(_=u.get(f))!==null&&_!==void 0?_:0):l[f]={value:T,level:A,remoteUidCount:N==="local"?0:1,totalTs:(R=u.get(f))!==null&&R!==void 0?R:0}}return Object.keys(l).map(f=>{const{level:T,value:A,totalTs:N}=l[f];return{id:f,level:T,value:A,totalTs:N}})}(r,t);const a=Date.now(),c=a>e?a:e+1;this.requestUpload&&this.requestUpload(Ar.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})},O("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class $e{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,e){h(this,"uid",void 0),h(this,"_uintid",void 0),h(this,"_trust_in_room_",!0),h(this,"_trust_audio_enabled_state_",!0),h(this,"_trust_video_enabled_state_",!0),h(this,"_trust_audio_mute_state_",!0),h(this,"_trust_video_mute_state_",!0),h(this,"_audio_muted_",!1),h(this,"_video_muted_",!1),h(this,"_audio_enabled_",!0),h(this,"_video_enabled_",!0),h(this,"_audio_added_",!1),h(this,"_video_added_",!1),h(this,"_is_pre_created",!1),h(this,"_video_pre_subscribed",!1),h(this,"_audio_pre_subscribed",!1),h(this,"_trust_video_stream_added_state_",!0),h(this,"_trust_audio_stream_added_state_",!0),h(this,"_audioTrack",void 0),h(this,"_videoTrack",void 0),h(this,"_dataChannels",[]),h(this,"_audioSSRC",void 0),h(this,"_videoSSRC",void 0),h(this,"_audioOrtc",void 0),h(this,"_videoOrtc",void 0),h(this,"_cname",void 0),h(this,"_rtxSsrcId",void 0),h(this,"_videoMid",void 0),h(this,"_audioMid",void 0),this.uid=t,this._uintid=e}}var yi;function T2(n,t){var e;let i;switch(t){case Y.LocalAudioTrack:i=Ut.Audio;break;case Y.LocalVideoTrack:i=nt(e=n._hints).call(e,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:i=Ut.Low}return i}function wy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Du(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?wy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):wy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}(function(n){n.SEND_ONLY="SEND_ONLY",n.RECEIVE_ONLY="RECEIVE_ONLY"})(yi||(yi={}));class Me extends se{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(lt.StateChange,e,this._state)}constructor(t,e){super(),h(this,"store",void 0),h(this,"statsUploader",void 0),h(this,"sendConnection",void 0),h(this,"recvConnection",void 0),h(this,"localTrackMap",new Map),h(this,"remoteUserMap",new Map),h(this,"localDataChannels",[]),h(this,"pendingLocalTracks",[]),h(this,"pendingRemoteTracks",[]),h(this,"statsCollector",void 0),h(this,"dtlsFailedCount",0),h(this,"sendMutex",new He("P2PChannel2-send-mutex")),h(this,"recvMutex",new He("P2PChannel2-recv-mutex")),h(this,"_state",Bt.Disconnected),h(this,"_restartStates",["disconnected","failed"]),h(this,"reconnectInterval",void 0),h(this,"uploadUnplinkStarted",!1),h(this,"uploadDownlinkStarted",!1),h(this,"uplinkStateUploadInterval",void 0),h(this,"downlinkStatsUploadInterval",void 0),h(this,"handleMuteLocalTrack",async(i,r,s)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Bt.Connected)return void s(new G(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const d=this.filterTobeMutedTracks(i);if(d.length===0)return void r();const u=d.find(R=>R[0]==="videoLowTrack");u&&u[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(d.map(R=>{let[,{id:f}]=R;return f}));let l=!1;var a,c;i.trackMediaType==="video"?l=!((a=this.localTrackMap.get(Y.LocalAudioTrack))===null||a===void 0||!a.track._muted):l=((c=this.localTrackMap.get(Y.LocalVideoTrack))===null||c===void 0?void 0:c.id)===void 0;const p=this.createMuteMessage(d);await Xt(this,lt.RequestMuteLocal,p);const _=i.trackMediaType==="video"?cr.MUTE_LOCAL_VIDEO:cr.MUTE_LOCAL_AUDIO;await Xt(this,lt.RequestP2PMuteLocal,{action:_,message:p,isMuteAll:l}),r()}catch(d){s(d)}finally{o()}}),h(this,"handleUnmuteLocalTrack",async(i,r,s)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Bt.Connected)return void s(new G(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();await this.sendConnection.unmuteLocal(a.map(u=>{let[,{id:l}]=u;return l}));const c=this.createUnmuteMessage(a),d=i.trackMediaType==="video"?cr.UNMUTE_LOCAL_VIDEO:cr.UNMUTE_LOCAL_AUDIO;await Xt(this,lt.RequestP2PMuteLocal,{action:d,message:c}),r()}catch(a){s(a)}finally{o()}}),h(this,"handleUpdateVideoEncoder",async(i,r,s)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const a=this.localTrackMap.get(Y.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==i||this.state!==Bt.Connected)return void r();const{id:c,track:d}=a;c&&(await this.sendConnection.updateSendParameters(c,d),await this.sendConnection.updateEncoderConfig(c,d),this.emit(lt.UpdateVideoEncoder,d)),r()}catch(a){s(a)}finally{o()}}),h(this,"handleSetOptimizationMode",async(i,r,s)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const a=this.localTrackMap.get(Y.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==i||this.state!==Bt.Connected)return;const{id:c,track:d}=a;c&&await this.sendConnection.updateSendParameters(c,d),r()}catch(a){s(a)}finally{o()}}),h(this,"handleReplaceTrack",async(i,r,s,o)=>{let a;m.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var c;const u=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:p}]=l;return i===p});if(!this.sendConnection||!u||u[1].id===void 0||this.state!==Bt.Connected)return void r();if(await((c=this.sendConnection)===null||c===void 0?void 0:c.replaceTrack(i,u[1].id)),u[0]===Y.LocalVideoTrack&&Kt().supportDualStreamEncoding){const l=this.localTrackMap.get(Y.LocalVideoLowTrack);if(l){const p=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=p,l.track._originMediaStreamTrack=p,await new F((_,R)=>{this.handleReplaceTrack(l.track,_,R,!0)})}}r()}catch(u){s(u)}finally{var d;(d=a)===null||d===void 0||d()}}),h(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),h(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),h(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),h(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new by(t),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(i=>{i&&(i.iceConnectionState!=="disconnected"&&i.iceConnectionState!=="failed"||this.handleDisconnect(i.direction))})},O("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new G(v.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,e,i,r,s,o){throw new G(v.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let i;try{if(e){this.recvConnection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new li(t,this.store,ln.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const r=await this.recvConnection.establish(e);return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}{this.state=Bt.New,this.sendConnection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new li(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const r=await this.sendConnection.establish();return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}}finally{i&&i()}}async p2pConnect(t){if(!this.sendConnection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Bt.Connected}async addRemoteCandidate(t,e){if(e===ln.RECEIVE_ONLY){if(!this.sendConnection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==Bt.Connected){r.throwIfTrackTypeNotMatch(t);const u=t.filter(l=>r.pendingLocalTracks.indexOf(l)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(u))}r.store.pubId=r.store.pubId+1,sn.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(t,e,i);if(o.length===0)return void(yield St(r.tryToUnmuteAudio(t)));o.forEach(u=>{let{track:l,type:p}=u;const _=Date.now();r.store.publish(l.getTrackId(),p===Y.LocalAudioTrack?"audio":"video",_)}),r.bindLocalTrackEvents(o);const a=yield St(r.sendConnection.send(o.map(u=>{let{track:l}=u;return l}),r.store.codec,r.store.audioCodec)),c=(yield St(a.next())).value,d=r.createGatewayPublishMessage(o,c);try{yield d}catch(u){throw a.throw(u),(u==null?void 0:u.code)===v.WS_ABORT&&o.forEach(l=>{let{track:p}=l;r.pendingLocalTracks.indexOf(p)===-1&&r.pendingLocalTracks.push(p)}),r.unbindLocalTrackEvents(o),u}yield St(a.next()),o.forEach(u=>{let{type:l}=u;r.statsCollector.addLocalStats(l)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(o,c),o.forEach(u=>{let{track:l,type:p}=u;const _=Date.now();r.store.publish(l.getTrackId(),p===Y.LocalAudioTrack?"audio":"video",void 0,_)}),r.startUploadUplinkState()}finally{s()}})()}async unpublish(t){if(!this.sendConnection||this.state!==Bt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(s=>!nt(t).call(t,s)));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const i=e.find(s=>s[0]==="videoLowTrack");i&&i[1].track.close();const r=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(s=>{let[,{id:o}]=s;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(s=>{let[o,{track:a}]=s;return{type:o,track:a}})),e.forEach(s=>{let[o]=s;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Bt.Connected)return i&&i[1].track.close(),r;t.forEach(s=>{const o=this.pendingLocalTracks.indexOf(s);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],i=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[s,{track:o,ssrcs:a}]=r;const c={stream_type:T2(o,s),ssrcs:a};o._muted||!o._enabled?e.push(c):i.push(c)}),e.length>0&&e.forEach(r=>{Xt(this,lt.RequestMuteLocal,[r])}),i.length>0&&i.forEach(r=>{Xt(this,lt.RequestUnmuteLocal,[r])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Kn(function*(){throw new G(v.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(m.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Se(this,lt.RequestRePublish,this.pendingLocalTracks),this.emit(lt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new G(v.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,i,r){var s;if(!this.recvConnection)throw new G(v.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((s=this.remoteUserMap.get(t))!==null&&s!==void 0&&s.has(e))return;const{track:o,mid:a,transceiver:c}=await this.recvConnection.receive(e,[{ssrcId:i}],String(t.uid),r);e===rt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new ki(o,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=i,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new ur(o,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack));const d=this.remoteUserMap.get(t);d?d.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex(l=>{let{user:p,kind:_}=l;return p.uid===t.uid&&e===_});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(lt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,i,r){if(!this.recvConnection)throw new G(v.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:i}],String(t.uid),r)}async unsubscribe(t,e,i){const r=this.pendingRemoteTracks.filter(o=>{let{user:a,kind:c}=o;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(r.forEach(o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)}),this.recvConnection||i||r.forEach(o=>{let{kind:a}=o;var c;if(a===rt.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===rt.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const s=this.filterTobeUnSubscribedTracks(t,e);s.length!==0&&(await this.recvConnection.stopReceiving(s.map(o=>{let[,{id:a}]=o;return a})),this.withdrawRemoteTracks(s),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),s.forEach(o=>{let[a,{kind:c}]=o;var d,u;if(c===rt.VIDEO&&a._videoSSRC&&((d=this.recvConnection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===rt.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((u=a._videoTrack)===null||u===void 0||u._destroy(),a._videoTrack=void 0);else if(c===rt.AUDIO){var l;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((l=a._audioTrack)===null||l===void 0||l._destroy(),a._audioTrack=void 0)}}),s.forEach(o=>{let[,{kind:a}]=o;Xt(this,lt.RequestP2PMuteRemote,a)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,i]=e;[rt.VIDEO,rt.AUDIO].forEach(r=>{i.has(r)?Xt(this,lt.RequestP2PUnmuteRemote,r):Xt(this,lt.RequestP2PMuteRemote,r)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new G(v.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new G(v.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new G(v.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new G(v.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);if(!i)return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const r=e===rt.VIDEO?t._videoSSRC:t._audioSSRC;r!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);if(!i)return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||m.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(Y.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ve){const i=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[s]=r;return s!==Y.LocalAudioTrack}).filter(r=>{let[s]=r;return!(t&&s===Y.LocalVideoLowTrack)}).map(r=>{let[,{track:s}]=r;return s}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(t&&r===Y.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}reportPublishEvent(t,e,i,r,s){if(t){const a=this.localTrackMap.get(Y.LocalAudioTrack),c=r?this.localTrackMap.get(Y.LocalVideoLowTrack):this.localTrackMap.get(Y.LocalVideoTrack);st.publish(this.store.sessionId,{eventElapse:sn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf($t.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const a=i.find(d=>d instanceof Vt),c=r?(o=this.localTrackMap.get(Y.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(d=>d instanceof Ct);st.publish(this.store.sessionId,{eventElapse:sn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf($t.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(t,e,i,r){const s=r===rt.VIDEO?i._videoSSRC:i._audioSSRC;s&&st.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===rt.VIDEO,audio:r===rt.AUDIO,peerid:i.uid,subscribeRequestid:r===rt.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:sn.measureFromSubscribeStart(this.store.clientId,s)})}reset(){m.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new He("P2PChannel2-send-mutex"),this.sendMutex=new He("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(Y.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ve){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Bt.Disconnected}getStats(t){var e,i;return t?(i=this.recvConnection)===null||i===void 0?void 0:i.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(Y.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(Y.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Ct||e&&e.track instanceof Vt?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from($n(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(Y.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Ma(t).call(t,(i,r)=>i.level-r.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(m.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Bt.Reconnecting,O("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:r}]=t;switch(i){case Y.LocalVideoTrack:nt(e=r._hints).call(e,$t.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case Y.LocalAudioTrack:r instanceof ve?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case Y.LocalVideoLowTrack:}}),this.emit(lt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from($n(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(e,r)}),this.emit(lt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),m.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:r,kind:s}=i;if((t instanceof $e?t.uid:t)===r.uid&&e===s)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let i,r;if(t===ln.SEND_ONLY){if(!this.sendConnection)throw new G(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),r=this.sendConnection}else{if(!this.recvConnection)throw new G(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),r=this.recvConnection}try{if(e){const s=await r.restartICE(e);return r.isInRestartIce=!1,s}{const s=await r.restartICE();if(s){const o=await Se(this,lt.RequestP2PRestartICE,{direction:ln.RECEIVE_ONLY,iceParameter:s});await r.restartICE(o),r.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(Y.LocalVideoTrack),i=this.localTrackMap.get(Y.LocalAudioTrack),r=t.videoSend.find(R=>{var f;return R.ssrc===(e==null||(f=e.ssrcs)===null||f===void 0?void 0:f[0].ssrcId)}),s=t.audioSend.find(R=>{var f;return R.ssrc===(i==null||(f=i.ssrcs)===null||f===void 0?void 0:f[0].ssrcId)});if(!r||!s)return 1;const o=Wn(this,lt.NeedSignalRTT),a=r?r.rttMs:void 0,c=s?s.rttMs:void 0,d=a&&c?(a+c)/2:a||c,u=(d&&o?(d+o)/2:d||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*u/1500,p=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,_=e==null?void 0:e.track;if(_&&_._encoderConfig&&_._hints.indexOf($t.SCREEN_TRACK)===-1){const R=_._encoderConfig.bitrateMax,f=t.bitrate.actualEncoded;if(R&&f){const T=(1e3*R-f)/(1e3*R);return YR[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i;const s=r._audioSSRC,o=r._videoSSRC,a=t.audioRecv.find(f=>f.ssrc===s),c=t.videoRecv.find(f=>f.ssrc===o);if(!a&&!c)return void(e+=1);const d=Wn(this,lt.NeedSignalRTT),u=t.rtt,l=(u&&d?(u+d)/2:u||d)||0,p=a?a.jitterMs:void 0,_=t.recvPacketLossRate;let R=.7*_*100/50+.3*l/1500;p&&(R=.6*_*100/50+.2*l/1500+.2*p/400),e+=R<.1?1:R<.17?2:R<.36?3:R<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new F((e,i)=>{this.handleMuteLocalTrack(t,e,i)})}filterTobePublishedTracks(t,e,i){const r=[],s=Kt(),o=this.getAllTracks();t=Vo(t=t.filter(d=>o.indexOf(d)===-1));let a=!1,c=!1;for(const d of t){if(d instanceof Ct&&(this.localTrackMap.has(Y.LocalVideoTrack)||a?new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:Y.LocalVideoTrack}),a=!0),e)){const u=this.getLowVideoTrack(d,i);r.push({track:u,type:Y.LocalVideoLowTrack})}if(d instanceof Vt){const u=this.localTrackMap.get(Y.LocalAudioTrack);if(u){if(!(u.track instanceof ve))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(c){const l=r.find(p=>{let{type:_}=p;return _===Y.LocalAudioTrack});if(!(l.track instanceof ve))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(d)}else{if(!s.webAudioMediaStreamDest||d instanceof ve||d._bypassWebAudio)r.push({track:d,type:Y.LocalAudioTrack});else{const l=new ve;l.addAudioTrack(d),r.push({track:l,type:Y.LocalAudioTrack})}c=!0}}}return r}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=Vo(t=t.filter(r=>i.indexOf(r)!==-1));for(const r of t){if(r instanceof Vt){const s=this.localTrackMap.get(Y.LocalAudioTrack);if(!s)continue;s.track instanceof ve?(s.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),s.track.trackList.length===0&&(e.push([Y.LocalAudioTrack,s]),s.track.close())):e.push([Y.LocalAudioTrack,s])}if(r instanceof Ct){const s=this.localTrackMap.get(Y.LocalVideoTrack);if(!s)continue;e.push([Y.LocalVideoTrack,s]);const o=this.localTrackMap.get(Y.LocalVideoLowTrack);o&&e.push([Y.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:r}=e;switch(r){case Y.LocalVideoTrack:i.addListener(tt.GET_STATS,this.handleGetLocalVideoStats),i.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(tt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(tt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.addListener(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Y.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case Y.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof ve?t.trackList.forEach(i=>{i.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(tt.GET_STATS,this.handleGetLocalAudioStats),i.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(tt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:r}]=e;return{track:r,type:i}})),t.forEach(e=>{let{track:i,type:r}=e;switch(r){case Y.LocalVideoTrack:i.off(tt.GET_STATS,this.handleGetLocalVideoStats),i.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(tt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(tt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.off(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Y.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case Y.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof ve?t.trackList.forEach(e=>{e.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(tt.GET_STATS,this.handleGetLocalAudioStats),e.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(tt.GET_STATS,this.handleGetLocalAudioStats),t.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof ur&&e.addListener(tt.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof ki&&e.addListener(tt.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(tt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has(rt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(rt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,r)=>{var s;let o,{track:a,type:c}=i;switch(c){case Y.LocalAudioTrack:o=Ut.Audio;break;case Y.LocalVideoTrack:o=nt(s=a._hints).call(s,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:o=Ut.Low}return{kind:c===Y.LocalAudioTrack?rt.AUDIO:rt.VIDEO,stream_type:o,mid:e[r].id,ssrcs:e[r].localSSRC,isMuted:a.muted||!a.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}assignLocalTracks(t,e){t.forEach((i,r)=>{let{track:s,type:o}=i;this.localTrackMap.set(o,{track:s,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var i;m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(lt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),nt(i=this._restartStates).call(i,e)&&!t.isInRestartIce&&(e==="disconnected"&&await We(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),st.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ce.TRACER}).onSuccess(),this.emit(lt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===e);var s;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(s=r.audioTrack)===null||s===void 0||s.emit(Xs.FIRST_FRAME_DECODED),st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_AUDIO_DECODE,ne.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===e);r&&st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_AUDIO_RECEIVED,ne.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,r)=>{this.reportVideoFirstFrameDecoded(e,i,r)},t.onFirstVideoReceived=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===e);r&&st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_VIDEO_RECEIVED,ne.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{const r=e.candidateType==="relay",s=i.candidateType==="relay";i.candidateType!=="unknown"&&r===s||this.emit(lt.ConnectionTypeChange,r),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ss(i))," -> ").concat(JSON.stringify(ss(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ss(i))," -> ").concat(JSON.stringify(ss(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(lt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===ln.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,m.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===ln.SEND_ONLY?this.restartICE(t):Se(this,lt.RequestP2PRestartICE,{direction:ln.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const i=this.localTrackMap.get(Y.LocalAudioTrack);if(t instanceof Vt&&(i==null?void 0:i.track)instanceof ve)return i.track.isActive||e.push([Y.LocalAudioTrack,i]),e;const r=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:o}]=s;return t===o});if(r&&(e.push(r),r[0]===Y.LocalVideoTrack)){const s=this.localTrackMap.get(Y.LocalVideoLowTrack);s&&e.push([Y.LocalVideoLowTrack,s])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(Y.LocalAudioTrack);if(t instanceof Vt&&(i==null?void 0:i.track)instanceof ve)return i.track.isActive&&e.push([Y.LocalAudioTrack,i]),e;const r=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:o}]=s;return t===o});if(r)if(r[0]===Y.LocalVideoTrack){e.push(r);const s=this.localTrackMap.get(Y.LocalVideoLowTrack);s&&e.push([Y.LocalVideoLowTrack,s])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}createUnmuteMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(t,e){const i=[],r=this.remoteUserMap.get(t);if(!r)return i;if(e){const s=r.get(e);if(!s)return i;i.push([t,{kind:e,id:s}])}else Array.from(r.entries()).forEach(s=>{let[o,a]=s;i.push([t,{kind:o,id:a}])});return i}createUnsubscribeMessage(t){const e=[];return t.forEach(i=>{let[r,{kind:s,id:o}]=i;switch(s){case rt.VIDEO:return void(r._videoSSRC&&e.push({stream_type:rt.VIDEO,ssrcId:r._videoSSRC}));case rt.AUDIO:return void(r._audioSSRC&&e.push({stream_type:rt.AUDIO,ssrcId:r._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:r}]=e;const s=this.remoteUserMap.get(i);s&&(s.delete(r),Array.from(s.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(Y.LocalVideoTrack),i=this.localTrackMap.get(Y.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof Vt){const i=this.filterTobeUnmutedTracks(t[e]);if(i.length===0)continue;const r=this.createUnmuteMessage(i);return void await Xt(this,lt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(lt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(lt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await We(xd(this.dtlsFailedCount,Ce)),this.emit(lt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Y.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Ct)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Ct).length>1)throw new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Vt).length>1&&(t.some(e=>e instanceof Vt&&e._bypassWebAudio)||!Kt().webAudioMediaStreamDest))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Ct&&this.pendingLocalTracks.some(i=>i instanceof Ct))throw new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Vt&&this.pendingLocalTracks.some(i=>i instanceof Vt)&&(!Kt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof Vt&&i._bypassWebAudio)))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=!O("DISABLE_DUAL_STREAM_USE_ENCODING")&&Kt().supportDualStreamEncoding,r=Du(Du({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():V_(t,r);const o=Qt(8,"track-low-"),a=new Ct(s,Du(Du({},i&&{scaleResolutionDownBy:Lp(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(Qo.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,os.LOW_STREAM)}),a._hints.push($t.LOW_STREAM),t.addListener(tt.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,i,r){var s;const o=Array.from($n(s=this.remoteUserMap).call(s)).find(a=>a._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");st.firstRemoteVideoDecode(this.store.sessionId,Pe.FIRST_VIDEO_DECODE,ne.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.recvConnection)return!1;const r=this.remoteUserMap.get(t);if(!r)return!1;const s=r.get(e);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return o!==void 0&&o!==i}resetConnection(t){m.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===Bt.Connected?(m.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(t){throw new G(v.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new G(v.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new G(v.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new G(v.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new G(v.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new G(v.NOT_SUPPORTED)}async preConnect(t,e,i,r,s,o){throw new G(v.NOT_SUPPORTED)}getEstablishParams(){throw new G(v.NOT_SUPPORTED)}async reSubscribe(t){throw new G(v.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new G(v.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===Y.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,os.LOW_STREAM):i._updateRtpTransceiver(void 0)})}}function Qi(n){return function(t,e,i){const r=t[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];switch(n){case yi.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(e));try{return await r.apply(this,o)}finally{c()}}case yi.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(e));try{return await r.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(e)),d=await this.recvMutex.lock("From P2PChannel2.".concat(e));try{return await r.apply(this,o)}finally{c(),d()}}}},i}}function Oy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function uo(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Oy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Oy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}W([Qi(yi.SEND_ONLY),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Me.prototype,"p2pConnect",null),W([Qi(yi.SEND_ONLY),S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Me.prototype,"unpublish",null),W([Qi(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Me.prototype,"unpublishLowStream",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String,Number,String]),S("design:returntype",F)],Me.prototype,"subscribe",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String,Number,String]),S("design:returntype",F)],Me.prototype,"mockSubscribe",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String,Boolean]),S("design:returntype",F)],Me.prototype,"unsubscribe",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Me.prototype,"muteRemote",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Me.prototype,"unmuteRemote",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Me.prototype,"hasRemoteMediaWithLock",null),W([Qi(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Me.prototype,"disconnectForReconnect",null),W([Qi(yi.RECEIVE_ONLY),S("design:type",Function),S("design:paramtypes",[$e,String,Number]),S("design:returntype",F)],Me.prototype,"remoteMediaSsrcChanged",null);class Ic{constructor(t){h(this,"store",void 0),h(this,"onStatsException",void 0),h(this,"onUploadPublishDuration",void 0),h(this,"onStatsChanged",void 0),h(this,"localStats",new Map),h(this,"remoteStats",new Map),h(this,"updateStatsInterval",void 0),h(this,"trafficStats",void 0),h(this,"trafficStatsPeerList",[]),h(this,"uplinkStats",void 0),h(this,"exceptionMonitor",void 0),h(this,"p2pChannel",void 0),h(this,"scalabilityMode",Sp.L1T1),h(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new t2,this.exceptionMonitor.on("exception",(e,i,r)=>{this.onStatsException&&this.onStatsException(e,i,r)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Y.LocalAudioTrack)||uo({},Yp)}getLocalVideoTrackStats(){return this.localStats.get(Y.LocalVideoTrack)||uo({},qp)}getRemoteAudioTrackStats(t){const e=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===s);return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.audioStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[o,{audioStats:a}]=s;a&&(i[o]=e(o,a))});return i}getRemoteNetworkQualityStats(t){const e={};if(t){var i;const r=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.networkStats;r&&(e[t]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[s,{networkStats:o}]=r;o&&(e[s]=o)});return e}getRemoteVideoTrackStats(t){const e=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===s);return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.videoStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[o,{videoStats:a}]=s;a&&(i[o]=e(o,a))});return i}getRTCStats(){let t=0,e=0,i=0,r=0;const s=this.localStats.get(Y.LocalAudioTrack);s&&(t+=s.sendBytes,e+=s.sendBitrate);const o=this.localStats.get(Y.LocalVideoTrack);o&&(t+=o.sendBytes,e+=o.sendBitrate);const a=this.localStats.get(Y.LocalVideoLowTrack);a&&(t+=a.sendBytes,e+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:u,videoStats:l}=d;u&&(i+=u.receiveBytes,r+=u.receiveBitrate),l&&(i+=l.receiveBytes,r+=l.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:e,SendBytes:t,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(e=>e.B_ppad!==void 0||e.B_ppvd!==void 0),t.peer_delay.filter(e=>this.trafficStatsPeerList.indexOf(e.peer_uid)===-1).forEach(e=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(e.peer_uid),s=r!=null&&r.videoSSRC?sn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?sn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;e.B_ppad!==void 0&&e.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,s>o?s:o),this.trafficStatsPeerList.push(e.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&m.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,e,i){if(!t)return!1;const r=!!i&&e.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||e.framesDecodeCount>i.framesDecodeCount;return r||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(e=>{let[i,r]=e;switch(i){case Y.LocalVideoTrack:case Y.LocalVideoLowTrack:{const o=r,a=uo({},qp),c=t.getStats(),d=t.getLocalMedia(i);if(c){const u=c.videoSend.find(l=>l.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(u){const l=t.getLocalVideoSize(),p=t.getEncoderConfig(Y.LocalVideoTrack);u.codec!=="H264"&&u.codec!=="H265"&&u.codec!=="VP8"&&u.codec!=="VP9"&&u.codec!=="AV1X"&&u.codec!=="AV1"||(a.codecType=u.codec),a.sendBytes=u.bytes,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0,u.inputFrame?(a.captureFrameRate=u.inputFrame.frameRate,a.captureResolutionHeight=u.inputFrame.height,a.captureResolutionWidth=u.inputFrame.width):l&&(a.captureResolutionWidth=l.width,a.captureResolutionHeight=l.height),u.sentFrame?(a.sendFrameRate=u.sentFrame.frameRate,a.sendResolutionHeight=u.sentFrame.height,a.sendResolutionWidth=u.sentFrame.width):l&&(a.sendResolutionWidth=l.width,a.sendResolutionHeight=l.height),u.avgEncodeMs&&(a.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax&&(a.targetSendBitrate=1e3*p.bitrateMax),a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.totalDuration=o?o.totalDuration+1:1,a.totalFreezeTime=o?o.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(a.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(m.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(i,a),((o==null?void 0:o.sendResolutionWidth)!==a.sendResolutionWidth||(o==null?void 0:o.sendResolutionHeight)!==a.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case Y.LocalAudioTrack:{const o=r,a=uo({},Yp),c=t.getStats(),d=t.getLocalMedia(i);if(c){const u=c.audioSend.find(l=>l.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(u){if(u.codec!=="opus"&&u.codec!=="aac"&&u.codec!=="PCMU"&&u.codec!=="PCMA"&&u.codec!=="G722"||(a.codecType=u.codec),u.inputLevel)a.sendVolumeLevel=Math.round(32767*u.inputLevel);else{const l=t.getLocalAudioVolume();l&&(a.sendVolumeLevel=Math.round(32767*l))}a.sendBytes=u.bytes,a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Y.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(e=>{var i,r;let[s,{videoStats:o,audioStats:a,videoPcStats:c}]=e;const d=a,u=o,l=c,p=uo({},kC),_=uo({},MC),R=uo({},VM),{audioTrack:f,videoTrack:T,audioSSRC:A,videoSSRC:N}=t.getRemoteMedia(s);let P;P=t instanceof Me?t.getStats(!0):t.getStats();const j=(i=P)===null||i===void 0?void 0:i.audioRecv.find(B=>B.ssrc===A),M=(r=P)===null||r===void 0?void 0:r.videoRecv.find(B=>B.ssrc===N),U=this.trafficStats&&this.trafficStats.peer_delay.find(B=>B.peer_uid===s);if(j&&(j.codec!=="opus"&&j.codec!=="aac"&&j.codec!=="PCMU"&&j.codec!=="PCMA"&&j.codec!=="G722"||(p.codecType=j.codec),j.outputLevel?p.receiveLevel=Math.round(32767*j.outputLevel):f&&(p.receiveLevel=Math.round(32767*f.getVolumeLevel())),p.receiveBytes=j.bytes,p.receivePackets=j.packets,p.receivePacketsLost=j.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=j.jitterBufferMs,p.totalDuration>10&&Ic.isRemoteAudioFreeze(f)&&(p.totalFreezeTime+=1)),M){M.codec!=="H264"&&M.codec!=="H265"&&M.codec!=="VP8"&&M.codec!=="VP9"&&M.codec!=="AV1X"&&M.codec!=="AV1"||(_.codecType=M.codec),_.receiveBytes=M.bytes,_.receiveBitrate=u?8*Math.max(0,_.receiveBytes-u.receiveBytes):0,_.decodeFrameRate=M.decodeFrameRate<0?0:M.decodeFrameRate,_.renderFrameRate=M.decodeFrameRate<0?0:M.decodeFrameRate,M.outputFrame&&(_.renderFrameRate=M.outputFrame.frameRate),M.receivedFrame?(_.receiveFrameRate=M.receivedFrame.frameRate,_.receiveResolutionHeight=M.receivedFrame.height,_.receiveResolutionWidth=M.receivedFrame.width):T&&(_.receiveResolutionHeight=T._videoHeight||0,_.receiveResolutionWidth=T._videoWidth||0),M.framesRateFirefox!==void 0&&(_.receiveFrameRate=Math.round(M.framesRateFirefox)),_.receivePackets=M.packets,_.receivePacketsLost=M.packetsLost,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost),_.totalDuration=u?u.totalDuration+1:1,_.totalFreezeTime=u?u.totalFreezeTime:0,_.receiveDelay=M.jitterBufferMs||0;const B=!!N&&t.getRemoteVideoIsReady(N);T&&B&&Ic.isRemoteVideoFreeze(T,M,l)&&(_.totalFreezeTime+=1),_.freezeRate=_.totalFreezeTime/_.totalDuration}U&&(p.end2EndDelay=U.B_ad,_.end2EndDelay=U.B_vd,p.transportDelay=U.B_ed,_.transportDelay=U.B_ed,p.currentPacketLossRate=U.B_ealr4/100,_.currentPacketLossRate=U.B_evlr4/100,R.uplinkNetworkQuality=U.B_punq?U.B_punq:0,R.downlinkNetworkQuality=U.B_pdnq?U.B_pdnq:0),this.remoteStats.set(s,{audioStats:p,videoStats:_,videoPcStats:M,networkStats:R}),f&&this.exceptionMonitor.setRemoteAudioStats(f,p),T&&this.exceptionMonitor.setRemoteVideoStats(T,_)})}}function Ny(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Ac(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Ny(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Ny(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class S2 extends se{constructor(t,e,i,r){super(),h(this,"spec",void 0),h(this,"token",void 0),h(this,"websocket",void 0),h(this,"pingpongTimer",void 0),h(this,"reconnectMode","retry"),h(this,"serviceMode",void 0),h(this,"reqId",0),h(this,"commandReqId",0),h(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),h(this,"handleWebSocketMessage",s=>{if(!s.data)return;const o=JSON.parse(s.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):this.serviceMode===Le.INJECT?this.emit(Ni.INJECT_STREAM_STATUS,o):(st.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===Le.TRANSCODE?1:2}),this.emit(Ni.PUBLISH_STREAM_STATUS,o))}),this.spec=e,this.token=t,this.serviceMode=r,this.websocket=new tc("live-streaming",i),this.websocket.on(pt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(pt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(pt.REQUEST_NEW_URLS,(s,o)=>{Se(this,Ni.REQUEST_NEW_ADDRESS).then(s).catch(o)}),this.websocket.on(pt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,e,i,r){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new k(v.UNEXPECTED_ERROR);const a=Ac({command:t,sdkVersion:fi==="4.20.0"?"0.0.1":fi,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},e);if(this.websocket.state==="closed")throw new k(v.WS_DISCONNECT);const c=()=>new F((p,_)=>{this.websocket.once(pt.CLOSED,()=>_(new k(v.WS_ABORT))),this.websocket.once(pt.CONNECTED,p)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new F((p,_)=>{const R=()=>{_(new k(v.WS_ABORT))};this.websocket.once(pt.RECONNECTING,R),this.websocket.once(pt.CLOSED,R),this.once("@".concat(o,"-").concat(this.spec.sid),f=>{p(f)})});r&&st.workerEvent(this.spec.sid,Ac(Ac({},r),{},{requestId:s,actionType:"request",payload:JSON.stringify(e.clientRequest),serverCode:0,code:0}));const u=Date.now();this.websocket.sendMessage(a);let l=null;try{l=await d}catch(p){if(this.websocket.state==="closed")throw p;return await c(),await this.request(t,e,i)}return r&&st.workerEvent(this.spec.sid,Ac(Ac({},r),{},{requestId:s,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:l.code===200,responseTime:Date.now()-u})),l.code!==200&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=fi==="4.20.0"?"0.0.1":fi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case ge.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void m.warning("live stream response already exists stream");case ge.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ge.LIVE_STREAM_RESPONSE_BAD_STREAM:case ge.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new k(v.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case ge.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ge.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new k(v.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case ge.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new k(v.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Ni.WARNING,e,t.serverResponse.url)}case ge.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const e=new k(v.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Ni.WARNING,e,t.serverResponse.url)}case ge.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ge.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new k(v.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case ge.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const e=new k(v.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Ni.WARNING,e,t.serverResponse.url)}case ge.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case ge.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ge.LIVE_STREAM_RESPONSE_WORKER_LOST:case ge.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ge.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ge.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new k(v.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Md)},6e3)}}function Dy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Nn(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Dy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Dy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class R2 extends se{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ce,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ce;super(),h(this,"onLiveStreamWarning",void 0),h(this,"onLiveStreamError",void 0),h(this,"onInjectStatusChange",void 0),h(this,"spec",void 0),h(this,"retryTimeout",1e4),h(this,"connection",void 0),h(this,"httpRetryConfig",void 0),h(this,"wsRetryConfig",void 0),h(this,"streamingTasks",new Map),h(this,"isStartingStreamingTask",!1),h(this,"taskMutex",new He("live-streaming")),h(this,"cancelToken",Pn.CancelToken.source()),h(this,"transcodingConfig",void 0),h(this,"injectConfig",Nn({},eM)),h(this,"injectLoopTimes",0),h(this,"uapResponse",void 0),h(this,"lastTaskId",1),h(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=e}async setTranscodingConfig(t){const e=Nn(Nn({},tM),t);e.videoCodecProfile!==66&&e.videoCodecProfile!==77&&e.videoCodecProfile!==100&&(m.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(e.videoCodecProfile," -> 100")),e.videoCodecProfile=100),e.transcodingUsers||(e.transcodingUsers=e.userConfigs),e.transcodingUsers&&(e.transcodingUsers=e.transcodingUsers.map(o=>Nn(Nn(Nn({},$1),o),{},{zOrder:o.zOrder?o.zOrder+1:1}))),function(o){ae(o.width)||Wt(o.width,"config.width",0,1e4),ae(o.height)||Wt(o.height,"config.height",0,1e4),ae(o.videoBitrate)||Wt(o.videoBitrate,"config.videoBitrate",1,1e6),ae(o.videoFrameRate)||Wt(o.videoFrameRate,"config.videoFrameRate"),ae(o.lowLatency)||zr(o.lowLatency,"config.lowLatency"),ae(o.audioSampleRate)||De(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),ae(o.audioBitrate)||Wt(o.audioBitrate,"config.audioBitrate",1,128),ae(o.audioChannels)||De(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),ae(o.videoGop)||Wt(o.videoGop,"config.videoGop"),ae(o.videoCodecProfile)||De(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),ae(o.userCount)||Wt(o.userCount,"config.userCount",0,17),ae(o.backgroundColor)||Wt(o.backgroundColor,"config.backgroundColor",0,16777215),ae(o.userConfigExtraInfo)||en(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!ae(o.transcodingUsers)&&(vr(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach((a,c)=>{vp(a.uid),ae(a.x)||Wt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),ae(a.y)||Wt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),ae(a.width)||Wt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),ae(a.height)||Wt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),ae(a.zOrder)||Wt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),ae(a.alpha)||Wt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),ae(o.watermark)||Ip(o.watermark,"watermark"),ae(o.backgroundImage)||Ip(o.backgroundImage,"backgroundImage"),o.images&&!ae(o.images)&&(vr(o.images,"config.images"),o.images.forEach((a,c)=>{Ip(a,"images[".concat(c,"]"))}))}(e);const i=[];e.images&&i.push(...e.images.map(o=>Nn(Nn(Nn({},yp),o),{},{zOrder:255}))),e.backgroundImage&&(i.push(Nn(Nn(Nn({},yp),e.backgroundImage),{},{zOrder:0})),delete e.backgroundImage),e.watermark&&(i.push(Nn(Nn(Nn({},yp),e.watermark),{},{zOrder:255})),delete e.watermark),e.images=i,e.transcodingUsers&&(e.userConfigs=e.transcodingUsers.map(o=>Nn({},o)),e.userCount=e.transcodingUsers.length,delete e.transcodingUsers);const r=(e.userConfigs||[]).map(o=>typeof o.uid=="number"?F.resolve(o.uid):wC(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await F.all(r)).forEach((o,a)=>{e.userConfigs&&e.userConfigs[a]&&(e.userConfigs[a].uid=o)}),this.transcodingConfig=e,this.connection)try{var s;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Yi(s=this.streamingTasks).call(s)).map(a=>a.taskId).join("#")});m.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{m.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then(()=>{m.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{m.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}setInjectStreamConfig(t,e){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=e}async startLiveStreamingTask(t,e,i){var r;if(Array.from(Yi(r=this.streamingTasks).call(r)).find(c=>c.mode===Le.INJECT)&&e===Le.INJECT)return new k(v.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&e===Le.TRANSCODE)throw new k(v.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};m.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(e));const o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(t)&&!i)return o(),new k(v.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(e))}catch(c){throw o(),c}switch(e){case Le.TRANSCODE:s.transcodingConfig=Nn({},this.transcodingConfig);break;case Le.RAW:break;case Le.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const c=new F((u,l)=>{We(this.retryTimeout).then(()=>{if(i)return l(i);const p=this.statusError.get(t);return p?(this.statusError.delete(t),l(p)):void 0})}),d=await F.race([this.connection.request("request",{clientRequest:s},!0,{url:t,command:"PublishStream",workerType:e===Le.TRANSCODE?1:2,requestByUser:!i,tid:a.toString()}),c]);this.isStartingStreamingTask=!1,m.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(d.code)),this.streamingTasks.set(t,{clientRequest:s,mode:e,url:t,taskId:a}),o()}catch(c){if(o(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||i)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,e,c)):await this.startLiveStreamingTask(t,e,c)}}stopLiveStreamingTask(t){return new F((e,i)=>{const r=this.streamingTasks.get(t);if(!r||!this.connection)return new k(v.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=r.mode;r.abortTask=()=>{m.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),e()},this.connection.request("request",{clientRequest:{command:s===Le.INJECT?"UninjectStream":"UnpublishStream",url:r.url}},!1,{url:t,command:"UnPublishStream",workerType:s===Le.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(o=>{m.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&s!==Le.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),e(),s===Le.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)}).catch(i)})}async controlInjectStream(t,e,i,r){const s=this.streamingTasks.get(t);if(!s||!this.connection||s.mode!==Le.INJECT)throw new k(v.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:e,audioVolume:i,position:r}})).serverResponse}resetAllTask(){var t;const e=Array.from(Yi(t=this.streamingTasks).call(t));this.terminate();for(const i of e)this.startLiveStreamingTask(i.url,i.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Pn.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new k(v.UNEXPECTED_ERROR,"live streaming connection has already connected");const e=await Se(this,Yo.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=e,this.connection=new S2(e.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Ni.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(Ni.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(Ni.INJECT_STREAM_STATUS,i=>this.handleInjectStreamServerStatus(i)),this.connection.on(Ni.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new k(v.UNEXPECTED_ERROR,"can not get new live streaming address list"));Se(this,Yo.REQUEST_WORKER_MANAGER_LIST,t).then(s=>{this.uapResponse=s,i(s.addressList)}).catch(r)}),await this.connection.init(e.addressList),this.connection}handlePublishStreamServer(t){const e=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(e),r=t.reason;switch(t.code){case ge.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ge.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new k(v.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return m.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(e,o);if(!this.isStartingStreamingTask)return;this.statusError.set(e,o)}case ge.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new k(v.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(e,o)}case ge.LIVE_STREAM_RESPONSE_WORKER_LOST:case ge.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(Yi(s=this.streamingTasks).call(s));for(const a of o)a.abortTask?a.abortTask():(m.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new k(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{m.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{m.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}handleInjectStreamServerStatus(t){const e=Number(t.uid),i=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_START_SUCCESS,e,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,e,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_START_UNAUTHORIZED,e,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_BROKEN,e,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(ts.INJECT_STREAM_STATUS_START_TIMEOUT,e,i),void this.streamingTasks.delete(i);default:return void m.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class Pu{constructor(){h(this,"destChannelMediaInfos",new Map),h(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){zR(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){zR(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Cp(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Py(n){if(!(n instanceof Pu))return new k(v.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=n.getSrcChannelMediaInfo(),e=n.getDestChannelMediaInfo();if(!t)return new k(v.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(e.size===0)return new k(v.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class C2 extends se{constructor(t,e,i){super(),h(this,"ws",void 0),h(this,"requestId",1),h(this,"heartBeatTimer",void 0),h(this,"joinInfo",void 0),h(this,"clientId",void 0),h(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),h(this,"onClose",r=>{this.emit("close"),this.dispose()}),h(this,"onMessage",r=>{const s=JSON.parse(r.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)}),this.joinInfo=t,this.clientId=e,this.ws=new tc("cross-channel-".concat(this.clientId),i),this.ws.on(pt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(pt.CONNECTED,this.onOpen),this.ws.on(pt.ON_MESSAGE,this.onMessage),this.ws.on(pt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const e=this.requestId++;return t.requestId=e,t.seq=e,this.ws.sendMessage(t),e}waitStatus(t){return new F((e,i)=>{const r=window.setTimeout(()=>{i(new k(v.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,s=>{window.clearTimeout(r),s.state&&s.state!==0?i(new k(v.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):e(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),i(new k(v.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new k(v.WS_DISCONNECT);const e=()=>new F((o,a)=>{this.ws.once(pt.CLOSED,()=>a(new k(v.WS_ABORT))),this.ws.once(pt.CONNECTED,o)});this.ws.state!=="connected"&&await e();const i=this.sendMessage(t),r=new F((o,a)=>{const c=()=>{a(new k(v.WS_ABORT))};this.ws.once(pt.RECONNECTING,c),this.ws.once(pt.CLOSED,c),this.once("req_".concat(i),o),We(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(pt.RECONNECTING,c),this.ws.off(pt.CLOSED,c),a(new k(v.TIMEOUT,"cross channel ws request timeout"))})}),s=await r;if(!s||s.code!==200)throw new k(v.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(pt.REQUEST_NEW_URLS),this.ws.on(pt.REQUEST_NEW_URLS,e=>{e(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const e=this.requestId++;return t.requestId=e,this.ws.sendMessage(t),e}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class v2 extends se{set state(t){t!==this._state&&(t!==In.RELAY_STATE_FAILURE&&(this.errorCode=es.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,e,i,r,s){super(),h(this,"joinInfo",void 0),h(this,"sid",void 0),h(this,"clientId",void 0),h(this,"cancelToken",Pn.CancelToken.source()),h(this,"workerToken",void 0),h(this,"requestId",0),h(this,"signal",void 0),h(this,"prevChannelMediaConfig",void 0),h(this,"httpRetryConfig",void 0),h(this,"_resolution",void 0),h(this,"_state",In.RELAY_STATE_IDLE),h(this,"errorCode",es.RELAY_OK),h(this,"onStatus",o=>{m.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",qi.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",qi.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=es.SRC_TOKEN_EXPIRED,this.state=In.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=es.DEST_TOKEN_EXPIRED,this.state=In.RELAY_STATE_FAILURE))}),h(this,"onReconnect",async()=>{m.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",qi.NETWORK_DISCONNECTED),this.state=In.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(o=>{this.state!==In.RELAY_STATE_IDLE&&(m.error("auto restart channel media relay failed",o.toString()),this.errorCode=es.SERVER_CONNECTION_LOST,this.state=In.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=e,this.sid=zh(),this.signal=new C2(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==In.RELAY_STATE_IDLE)throw new k(v.INVALID_OPERATION);this.state=In.RELAY_STATE_CONNECTING,await this.connect(),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(e){throw e.data&&e.data.serverResponse&&e.data.serverResponse.command==="SetSourceChannel"?new k(v.CROSS_CHANNEL_FAILED_JOIN_SRC):e.data&&e.data.serverResponse&&e.serverResponse.command==="SetDestChannelStatus"?new k(v.CROSS_CHANNEL_FAILED_JOIN_DEST):e.data&&e.data.serverResponse&&e.serverResponse.command==="StartPacketTransfer"?new k(v.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):e}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==In.RELAY_STATE_RUNNING)throw new k(v.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==In.RELAY_STATE_RUNNING)throw new k(v.INVALID_OPERATION);const e=this.genMessage(hn.SetVideoProfile);await this.signal.request(e),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),m.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=In.RELAY_STATE_IDLE,this.dispose()}dispose(){m.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Pn.CancelToken.source(),this.state=In.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await DM(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",qi.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const e=this.genMessage(hn.StopPacketTransfer);await this.signal.request(e),await this.signal.waitStatus("Normal Quit"),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(hn.SetSdkProfile,t);await this.signal.request(i),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(hn.SetSourceChannel,t);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",qi.PACKET_JOINED_SRC_CHANNEL),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=this.genMessage(hn.SetSourceUserId,t);await this.signal.request(s),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(hn.SetDestChannel,t);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",qi.PACKET_JOINED_DEST_CHANNEL),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(hn.StartPacketTransfer,t);await this.signal.request(a),this.emit("event",qi.PACKET_SENT_TO_DEST_CHANNEL),this.state=In.RELAY_STATE_RUNNING,m.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const e=this.genMessage(hn.UpdateDestChannel,t);await this.signal.request(e),this.emit("event",qi.PACKET_UPDATE_DEST_CHANNEL),m.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(hn.StopPacketTransfer);await this.signal.request(t),m.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,e){const i=[],r=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:fi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.20.0"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(t){case hn.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case hn.SetSourceChannel:if(c=e&&e.getSrcChannelMediaInfo(),!c)throw new k(v.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case hn.SetSourceUserId:if(c=e&&e.getSrcChannelMediaInfo(),!c)throw new k(v.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case hn.SetDestChannel:if(a=e&&e.getDestChannelMediaInfo(),!a)throw new k(v.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:s},o;case hn.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case hn.Reconnect:return o.clientRequest={command:"Reconnect"},o;case hn.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case hn.UpdateDestChannel:if(a=e&&e.getDestChannelMediaInfo(),!a)throw new k(v.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:s},o;case hn.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}function Lu(n){var t={},e=!1;function i(r,s){return e=!0,{done:!1,value:new w_(s=new O_(function(o){o(n[r](s))}),1)}}return t[wo!==void 0&&tT||"@@iterator"]=function(){return this},t.next=function(r){return e?(e=!1,r):i("next",r)},typeof n.throw=="function"&&(t.throw=function(r){if(e)throw e=!1,r;return i("throw",r)}),typeof n.return=="function"&&(t.return=function(r){return e?(e=!1,r):i("return",r)}),t}var Ly=b(iy);function ky(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function My(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?ky(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):ky(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function Uy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function xy(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Uy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Uy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class qe extends Qd{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var e;return nt(e=Object.keys(Zr)).call(e,t)}))]}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"statsFilter",void 0),h(this,"useRTX",!1),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"establishPromise",void 0),h(this,"mutex",new He("P2PConnection-mutex")),this.store=e,this.peerConnection=new RTCPeerConnection(qe.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=wu(this.peerConnection,O("STATS_UPDATE_INTERVAL"),void 0,Jt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=zi(t.sdp),i=Cc(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:O("FILTER_VIDEO_FEC"),filterAudioFec:O("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=t,xy(xy({},e),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new G(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,r,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(c){h(this,"sessionDesc",void 0),h(this,"localCapabilities",void 0),h(this,"rtpCapabilities",void 0),h(this,"candidates",void 0),h(this,"iceParameters",void 0),h(this,"dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),c=Zt(c);const{remoteIceParameters:d,remoteDtlsParameters:u,candidates:l,remoteRTPCapabilities:p,remoteSetup:_,localCapabilities:R,sdkCodec:f,cname:T}=c,A=oe.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=p,this.candidates=l,this.iceParameters=d,this.dtlsParameters=u,this.setup=_,this.localCapabilities=R,this.cname=T;for(let N=0;N<A.mediaDescriptions.length;N++){const P=A.mediaDescriptions[N];if(P.attributes.iceUfrag=d.iceUfrag,P.attributes.icePwd=d.icePwd,P.attributes.fingerprints=u.fingerprints,P.attributes.candidates=l,P.attributes.setup=_,P.media.mediaType==="video"){P.media.fmts=p.videoCodecs.map(M=>M.payloadType.toString(10));let j=p.videoCodecs.filter(M=>{var U,B;return(U=M.rtpMap)===null||U===void 0?void 0:nt(B=U.encodingName.toLowerCase()).call(B,f)});j.length===0&&(j=p.videoCodecs),P.attributes.payloads=j,P.attributes.extmaps=p.videoExtensions}P.media.mediaType==="audio"&&(P.media.fmts=p.audioCodecs.map(j=>j.payloadType.toString(10)),P.attributes.payloads=p.audioCodecs,P.attributes.extmaps=p.audioExtensions),A.mediaDescriptions[N]=this.mungMediaDesc(P)}this.sessionDesc=A,this.currentMidIndex=A.mediaDescriptions.length-1}toString(){return oe.print(this.sessionDesc)}send(c,d,u){const{ssrcs:l,ssrcGroups:p}=xn(d,this.cname),_=this.sessionDesc.mediaDescriptions.find(T=>c===rt.VIDEO?T.media.mediaType==="video":T.media.mediaType==="audio"),R=l[0].attributes.label,f=l[0].attributes.mslabel;return _.attributes.ssrcs=_.attributes.ssrcs.concat(l),_.attributes.ssrcGroups=_.attributes.ssrcGroups.concat(p),{id:R,mslabel:f}}batchSend(c){return c.map(d=>{let{kind:u,ssrcMsg:l}=d;return this.send(u,l,void 0)})}stopSending(c){this.sessionDesc.mediaDescriptions.forEach(d=>{const u=[],l=[],p=[];d.attributes.ssrcs.forEach(_=>{nt(c).call(c,_.attributes.label||"")?p.push(_):u.push(_)}),d.attributes.ssrcGroups.forEach(_=>{var R;nt(R=p.map(f=>f.ssrcId)).call(R,_.ssrcIds[0])||l.push(_)}),d.attributes.ssrcs=u,d.attributes.ssrcGroups=l})}mute(c){const d=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive"}unmute(c){const d=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly"}receive(c,d,u){c.forEach((l,p)=>{const _=l._mediaStreamTrack,R=this.sessionDesc.mediaDescriptions.findIndex(T=>T.attributes.mid===_.kind),f=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[R],l);this.sessionDesc.mediaDescriptions[R]=f})}stopReceiving(c){}updateCandidates(c){c===nn.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(u=>u.transport==="tcp"&&u.connectionAddress===d.connectionAddress&&u.port===d.port)===-1&&this.candidates.push(My(My({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(const d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates}restartICE(c){c=Zt(c),this.iceParameters=c,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=c.iceUfrag,d.attributes.icePwd=c.icePwd})}predictReceivingMids(c){const d=[];for(let u=0;u<c;u++)d.push((this.currentMidIndex+u+1).toString(10));return d}mungRecvMediaDsec(c,d){const u=Zt(c);return _s(u,d),Nu(u,d),u}updateRecvMedia(c,d){const u=this.sessionDesc.mediaDescriptions.findIndex(l=>l.attributes.mid===c);if(u!==-1){const l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[u],d);this.sessionDesc.mediaDescriptions[u]=l}}bumpMid(c){this.currentMidIndex+=c}updateTrackLabel(c,d,u){const l=this.sessionDesc.mediaDescriptions.find(_=>c===rt.VIDEO?_.attributes.mid==="video":_.attributes.mid==="audio");if(l){const _=l.attributes.ssrcs.find(R=>R.attributes.label===d);var p;_&&(_.attributes.label=u,(p=_.attributes.msid)===null||p===void 0||p.replace(d,u))}}mungMediaDesc(c){const d=Zt(c);return Ou(d),function(u){const l=u.attributes.extmaps.find(p=>p.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");l&&u.attributes.extmaps.splice(u.attributes.extmaps.indexOf(l),1),u.attributes.payloads.forEach(p=>{const _=p.rtcpFeedbacks.findIndex(R=>R.type==="transport-cc");_!==-1&&p.rtcpFeedbacks.splice(_,1)})}(d),d}getSSRC(c){for(const d of this.sessionDesc.mediaDescriptions)for(const u of d.attributes.ssrcs)if(u.attributes.label===c)return[u]}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:r.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,e){throw new G(v.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,e){var i=this;return Kn(function*(){const r=yield St(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map(p=>i.peerConnection.addTrack(p._mediaStreamTrack)),o=yield St(i.peerConnection.createOffer()),a=oe.parse(o.sdp),c=t.map(p=>{const _=p._mediaStreamTrack,R=a.mediaDescriptions.find(f=>f.attributes.mid===_.kind);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return function(f,T,A){const N=f.attributes.ssrcs.filter(j=>j.attributes.label===T),P=f.attributes.ssrcGroups;if(N.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(P&&N.length>1){const j=P.find(M=>M.ssrcIds.indexOf(N[0].ssrcId)!==-1);return j?[{ssrcId:j.ssrcIds[0],rtx:A?j.ssrcIds[1]:void 0}]:[{ssrcId:N[0].ssrcId}]}return[{ssrcId:N[0].ssrcId}]}(R,_.id,i.useRTX)});let d;try{d=yield c}catch(p){throw s.forEach(_=>{fn()&&_.replaceTrack(null),i.peerConnection.removeTrack(_)}),p}const u=i.mungSendOfferSDP(o.sdp,t);i.remoteSDP.receive(t,e,d);const l=i.remoteSDP.toString();return yield St(i.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield St(i.applySendEncodings(s,t)),yield St(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),t.map((p,_)=>{const R=p._mediaStreamTrack.id;return{localSSRC:c[_],id:R}})}catch(s){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{r()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getSenders().filter(s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map(s=>{fn()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(t,e,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:s,mslabel:o}=this.remoteSDP.send(t,e,r),a=new F((u,l)=>{const p=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(s)))},1e4),_=R=>{const f=Lt();if((f.name==="Safari"&&Number(f.version)===11||gn())&&R.track.id!==s&&R.streams[0].id===o){var T;const A=R.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(t,s,R.track.id),this.peerConnection.removeEventListener("track",_),clearTimeout(p),void u(A)}if(R.track.id===s)return this.peerConnection.removeEventListener("track",_),clearTimeout(p),void u(R.track)};this.peerConnection.addEventListener("track",_)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:s}}catch(s){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter(i=>{var r;return t.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(e.length!==t.length)throw new Error("sender' length doesn't match mids' length.");e.map(i=>{if(fn()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach(s=>s.active=!1),i.setParameters(r)}})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter(s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(e.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");e.map(async s=>{if(fn()&&s.track)s.track.enabled=!0;else{const o=s.getParameters();o.encodings.forEach(a=>a.active=!0),await s.setParameters(o)}});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return Kn(function*(){const i=yield St(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Kt().supportPCSetConfiguration){const c=e.peerConnection.getConfiguration(),d=t===nn.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(m.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,e.peerConnection.setConfiguration(c))}else if(t===nn.RELAY)return;t!==nn.RELAY&&e.remoteSDP.updateCandidates(t);const r=yield St(e.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=zi(r.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString();yield St(e.peerConnection.setLocalDescription(r)),yield St(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){m.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[e]);this.remoteSDP.updateRecvMedia(e._mediaStreamTrack.kind,e);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new G(v.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getSenders().filter(r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===t});i.length===1&&await this.applySendEncodings(i,[e])}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getSenders().find(r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===e});i&&await i.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,e){throw new G(v.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new G(v.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},O("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(xo(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...qe.turnServerConfigToIceServers(t.turnServer.servers)),O("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...qe.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(i=>{i.security?i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),e}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find(d=>{var u;return((u=d.track)===null||u===void 0?void 0:u.id)===t._mediaStreamTrack.id})),!e)return m.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Kt().supportSetRtpSenderParameters)return m.warn("Browser not support set rtp-sender parameters");const r={},s={};if(t instanceof Ct)switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(O("DSCP_TYPE")&&Jr()){var o;const d=O("DSCP_TYPE");nt(o=["very-low","low","medium","high"]).call(o,d)&&(s.networkPriority=d)}const a=e.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,s),Object.assign(a,r),m.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await e.setParameters(a)}async applySendEncodings(t,e){try{if(!Kt().supportSetRtpSenderParameters||t.length!==e.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=e[i];r&&s&&await this.updateRtpSenderEncodings(s,r)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e){const i=oe.parse(t);return e.forEach((r,s)=>{const o=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===o.kind);a&&_s(a,r)}),oe.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const e=this.remoteSDP.batchSend(t).map((s,o)=>{let{id:a,mslabel:c}=s;const{kind:d}=t[o];return new F((u,l)=>{const p=setTimeout(()=>{l(new Error("Cannot receive track, id: ".concat(a)))},1e4),_=R=>{const f=Lt();if(f.name==="Safari"&&Number(f.version)===11&&R.track.id!==a&&R.streams[0].id===c){var T;const A=R.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(d,a,R.track.id),this.peerConnection.removeEventListener("track",_),clearTimeout(p),void u({track:A,id:a})}if(R.track.id===a)return this.peerConnection.removeEventListener("track",_),clearTimeout(p),void u({track:R.track,id:a})};this.peerConnection.addEventListener("track",_)})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await F.all(e)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Kt().supportPCSetConfiguration){const e=qe.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function Ii(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("Locking from P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function Vy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function fs(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Vy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Vy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}W([Ii,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],qe.prototype,"connect",null),W([Ii,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],qe.prototype,"stopSending",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String,Array,String,Object]),S("design:returntype",F)],qe.prototype,"receive",null),W([Ii,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],qe.prototype,"stopReceiving",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],qe.prototype,"muteRemote",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],qe.prototype,"unmuteRemote",null),W([Ii,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],qe.prototype,"muteLocal",null),W([Ii,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],qe.prototype,"unmuteLocal",null),W([Ii,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],qe.prototype,"close",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],qe.prototype,"updateEncoderConfig",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],qe.prototype,"updateSendParameters",null),W([Ii,S("design:type",Function),S("design:paramtypes",[rn,String]),S("design:returntype",F)],qe.prototype,"replaceTrack",null),W([Ii,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],qe.prototype,"getRemoteSSRC",null);const bc="9",Fy=4e4;function By(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function ua(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?By(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):By(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class pe extends Qd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return(t=(e=this.peerConnection.getReceivers()[0])===null||e===void 0||(e=e.transport)===null||e===void 0?void 0:e.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var e;return nt(e=Object.keys(Zr)).call(e,t)}))]}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useXR",O("USE_XR")),h(this,"localCapabilities",void 0),h(this,"remoteCodecs",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"dataStreamChannelMap",new Map),h(this,"establishPromise",void 0),h(this,"mutex",new He("P2PConnection-mutex")),this.store=e,this.peerConnection=new RTCPeerConnection(pe.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=wu(this.peerConnection,O("STATS_UPDATE_INTERVAL"),void 0,Jt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,e){if(this.remoteCodecs=e,!this.remoteSDP)return void m.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(e));if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else m.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=zi(t.sdp),i=await x_({filterRTX:!O("USE_PUB_RTX")&&!O("USE_SUB_RTX"),filterVideoFec:O("FILTER_VIDEO_FEC"),filterAudioFec:O("FILTER_AUDIO_FEC"),filterVideoCodec:O("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=ca(i),this.initialOffer=t,ua(ua({},e),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new G(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,r,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Zt(this._localCapabilities)}get rtpCapabilities(){return Zt(this._rtpCapabilities)}get candidates(){return Zt(this._candidates)}get iceParameters(){return Zt(this._iceParameters)}get dtlsParameters(){return Zt(this._dtlsParameters)}constructor(_){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),_=Zt(_);const{remoteIceParameters:R,remoteDtlsParameters:f,candidates:T,remoteRTPCapabilities:A,remoteSetup:N,localCapabilities:P,cname:j}=_,M=oe.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=A,this._candidates=T,this._iceParameters=R,this._dtlsParameters=f,this._localCapabilities=P,this.setup=N,this.cname=j;const U=this.rtpCapabilities.send;for(const B of M.mediaDescriptions){if(B.attributes.iceUfrag=R.iceUfrag,B.attributes.icePwd=R.icePwd,B.attributes.fingerprints=f.fingerprints,B.attributes.candidates=T,B.attributes.setup=N,B.media.mediaType==="video"&&(B.media.fmts=U.videoCodecs.map(V=>V.payloadType.toString(10)),B.attributes.payloads=U.videoCodecs,B.attributes.extmaps=U.videoExtensions,O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:V,ssrcGroups:q}=xn([{ssrcId:Fy,rtx:O("USE_SUB_RTX")?40001:void 0}],this.cname);B.attributes.ssrcs=V,B.attributes.ssrcGroups=q}if(B.media.mediaType==="audio"&&(B.media.fmts=U.audioCodecs.map(V=>V.payloadType.toString(10)),B.attributes.payloads=U.audioCodecs,B.attributes.extmaps=U.audioExtensions,Xi(B),O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:V,ssrcGroups:q}=xn([{ssrcId:2e4}],this.cname);B.attributes.ssrcs=V,B.attributes.ssrcGroups=q}}this.sessionDesc=M,this.currentMidIndex=M.mediaDescriptions.length-1}preloadRemoteMedia(){const _=O("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const R=this.candidates,f=this.dtlsParameters,T=this.iceParameters,A=this.rtpCapabilities.send;for(let N=1;N<_;N++){const P=2*N+2e4,j=2*N+Fy,{ssrcs:M,ssrcGroups:U}=xn([{ssrcId:P}],this.cname),{ssrcs:B,ssrcGroups:V}=xn([{ssrcId:j,rtx:O("USE_SUB_RTX")?j+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:bc,protos:["UDP","TLS","RTP","SAVPF"],fmts:A.videoCodecs.map(q=>q.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:T.iceUfrag,icePwd:T.icePwd,unrecognized:[],candidates:R,extmaps:A.videoExtensions,fingerprints:f.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:B,ssrcGroups:V,rtcpFeedbackWildcards:[],payloads:A.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*N)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:bc,protos:["UDP","TLS","RTP","SAVPF"],fmts:A.audioCodecs.map(q=>q.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:T.iceUfrag,icePwd:T.icePwd,unrecognized:[],candidates:R,extmaps:A.audioExtensions,fingerprints:f.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:M,ssrcGroups:U,rtcpFeedbackWildcards:[],payloads:A.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*N+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return oe.print(this.sessionDesc)}send(_,R,f,T){const{ssrcs:A,ssrcGroups:N}=xn(R,this.cname,O("SYNC_GROUP")?f:void 0),P=this.findPreloadMediaDesc(A);if(P){if(Jt()&&this.firefoxSsrcMidMap.set(A[0].ssrcId,P.attributes.mid),T&&(T.twcc||T.remb)){const j=this.sessionDesc.mediaDescriptions.indexOf(P);return this.sessionDesc.mediaDescriptions[j]=this.mungSendMediaDesc(P,T),{mid:P.attributes.mid,needExchangeSDP:!0}}return{mid:P.attributes.mid,needExchangeSDP:!1}}{const j=this.findAvailableMediaIndex(_,A);let M;return j===-1||j===1&&(fn()||SS())||j===0&&O("USE_SUB_RTX")||RS()?(M=this.createOrRecycleSendMedia(_,A,N,"sendonly",T),this.updateBundleMids()):(M=Zt(this.sessionDesc.mediaDescriptions[j]),M.attributes.direction="sendonly",M.attributes.ssrcs=A,M.attributes.ssrcGroups=N,this.sessionDesc.mediaDescriptions[j]=this.mungSendMediaDesc(M,T)),Jt()&&this.firefoxSsrcMidMap.set(A[0].ssrcId,M.attributes.mid),{mid:M.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:_,needExchangeSDP:R}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:_.attributes.mid,needExchangeSDP:R}}batchSend(_){const R=_.map(A=>{let{kind:N,ssrcMsg:P,mslabel:j}=A;return this.send(N,P,j)}),f=[];let T=!1;return R.forEach(A=>{let{mid:N,needExchangeSDP:P}=A;P&&(T=!0),f.push(N)}),{mids:f,needExchangeSDP:T}}stopSending(_){const R=this.sessionDesc.mediaDescriptions.filter(f=>f.attributes.mid&&_.indexOf(f.attributes.mid)!==-1);if(R.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");R.forEach(f=>{f.attributes.mid==="0"||Jt()||RS()?f.attributes.ssrcs=[]:(f.attributes.ssrcs=[],f.attributes.direction="inactive",f.media.port="0")}),this.updateBundleMids()}mute(_){const R=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_);if(!R)throw new Error("mediaDescription not found with ".concat(_," in remote SDP when calling RemoteSDP.mute."));R.attributes.direction="inactive"}unmute(_){const R=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_);if(!R)throw new Error("mediaDescription not found with ".concat(_," in remote SDP when calling RemoteSDP.unmute."));R.attributes.direction="sendonly"}muteRemote(_){const R=this.sessionDesc.mediaDescriptions.filter(f=>nt(_).call(_,f.attributes.mid||""));if(R.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");R.forEach(f=>{f.attributes.direction="inactive"})}unmuteRemote(_){const R=this.sessionDesc.mediaDescriptions.filter(f=>nt(_).call(_,f.attributes.mid||""));if(R.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");R.forEach(f=>{f.attributes.direction="recvonly"})}receive(_,R,f,T){_.forEach((A,N)=>{this.createOrRecycleRecvMedia(A,[],"recvonly",R,f,T[N])}),this.updateBundleMids()}stopReceiving(_){const R=this.sessionDesc.mediaDescriptions.filter(f=>_.indexOf(f.attributes.mid)!==-1);if(R.length!==_.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");R.forEach(f=>{f.media.port="0",f.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(_){const R=this._candidates.filter(f=>f.transport==="udp");if(_===nn.TCP){if(R.length===0)return;if(O("TCP_CANDIDATE_ONLY")){const f=this._candidates.filter(T=>T.transport==="tcp");R.forEach(T=>{f.findIndex(A=>A.connectionAddress===T.connectionAddress)===-1&&f.push(fs(fs({},T),{},{foundation:"tcpcandidate",priority:Number(T.priority)-1+"",transport:"tcp",port:Number(T.port)+90+""}))}),this._candidates=f}else{const f=[];R.forEach(T=>{f.push(fs(fs({},T),{},{foundation:"tcpcandidate",priority:Number(T.priority)-1+"",transport:"tcp",port:Number(T.port)+90+""}))}),this._candidates=[...R,...f]}}else if(_===nn.RELAY){if(R.length!==0)return;{const f=this._candidates.filter(T=>T.transport==="tcp");f.forEach(T=>{R.push(fs(fs({},T),{},{foundation:"udpcandidate",priority:Number(T.priority)+1+"",transport:"udp",port:Number(T.port)-90+""}))}),this._candidates=[...R,...f]}}else R.length===0?(this._candidates.filter(f=>f.transport==="tcp").forEach(f=>{R.push(fs(fs({},f),{},{foundation:"udpcandidate",priority:Number(f.priority)+1+"",transport:"udp",port:Number(f.port)-90+""}))}),this._candidates=R):this._candidates=this._candidates.filter(f=>f.transport!=="tcp");for(const f of this.sessionDesc.mediaDescriptions)f.attributes.candidates=this.candidates}restartICE(_){_=Zt(_),this._iceParameters=_,this.sessionDesc.mediaDescriptions.forEach(R=>{R.attributes.iceUfrag=_.iceUfrag,R.attributes.icePwd=_.icePwd})}predictReceivingMids(_){const R=[];for(let f=0;f<_;f++)R.push((this.currentMidIndex+f+1).toString(10));return R}findAvailableMediaIndex(_,R){return this.sessionDesc.mediaDescriptions.findIndex(f=>{const T=f.media.mediaType===_&&f.media.port!=="0"&&(f.attributes.direction==="sendonly"||f.attributes.direction==="sendrecv")&&f.attributes.ssrcs.length===0;if(Jt()){if(T){const A=this.firefoxSsrcMidMap.get(R[0].ssrcId);return!(A||f.attributes.mid!=="0"&&f.attributes.mid!=="1")||!(!A||A!==f.attributes.mid)}return!1}return T})}createOrRecycleDataChannel(){for(const f of this.sessionDesc.mediaDescriptions)if(f.media.mediaType==="application")return{mediaDesc:f,needExchangeSDP:!1};this.currentMidIndex+=1;const _="".concat(this.currentMidIndex),R={media:{mediaType:"application",port:bc,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(_),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(R),{mediaDesc:R,needExchangeSDP:!0}}createOrRecycleRecvMedia(_,R,f,T,A,N){const P=_._mediaStreamTrack.kind,j=this.rtpCapabilities.recv,M=ao(P,j,this.localCapabilities.send,P===rt.VIDEO?T:A),U=P===rt.VIDEO?j.videoExtensions:j.audioExtensions;this.currentMidIndex+=1;const B="".concat(this.currentMidIndex);let V={media:{mediaType:P,port:bc,protos:["UDP","TLS","RTP","SAVPF"],fmts:M.map(z=>z.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:U,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:R,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:M,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:f,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(B)}};V=this.mungRecvMediaDsec(V,_,N);const q=this.findFirstClosedMedia(P);if(q){const z=this.sessionDesc.mediaDescriptions.indexOf(q);this.sessionDesc.mediaDescriptions[z]=V}else this.sessionDesc.mediaDescriptions.push(V);return V}updateRemoteCodec(_,R,f){const T=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(V=>V.rtpMap&&V.rtpMap.encodingName.toLowerCase()||"").filter(V=>{var q;return nt(q=Object.keys(Zr)).call(q,V)}))],A=new Set(R);if(T.every(V=>A.has(V)))return m.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(R)),!1;const N=this._rtpCapabilities.recv.videoCodecs.filter(V=>R.some(q=>{var z;return nt(z=V.rtpMap&&V.rtpMap.encodingName.toLowerCase()||"").call(z,q)}));if(N.length===0)return m.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(T," codecs: ").concat(R)),!1;const P=[...new Set(N.map(V=>V.rtpMap&&V.rtpMap.encodingName.toLowerCase()||""))];let j;if(m.debug("updateRemoteCodec, from ".concat(T," to ").concat(P)),_.length===0)j=this.sessionDesc.mediaDescriptions.filter(V=>V.media.mediaType==="video"&&V.attributes.direction==="recvonly");else if(j=this.sessionDesc.mediaDescriptions.filter(V=>V.attributes.mid&&nt(_).call(_,V.attributes.mid)&&V.attributes.direction==="recvonly"),j.length!==_.length)return m.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(_,", codecs: ").concat(R)),!1;this._rtpCapabilities.recv.videoCodecs=N;const M=this.localCapabilities.send,U=this.rtpCapabilities.recv,B=ao(rt.VIDEO,U,M,f);return j.forEach(V=>{const q=B.map(z=>z.payloadType.toString(10));m.debug("updateRemoteCodec mid: ".concat(V.attributes.mid,", from ").concat(V.attributes.payloads," to ").concat(B)),V.attributes.payloads=B,V.media.fmts=q}),!0}createOrRecycleSendMedia(_,R,f,T,A){const N=this.rtpCapabilities.send,P=_===rt.VIDEO?N.videoCodecs:N.audioCodecs,j=_===rt.VIDEO?N.videoExtensions:N.audioExtensions;this.currentMidIndex+=1;const M="".concat(this.currentMidIndex);let U={media:{mediaType:_,port:bc,protos:["UDP","TLS","RTP","SAVPF"],fmts:P.map(V=>V.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:j,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:R,ssrcGroups:f,rtcpFeedbackWildcards:[],payloads:P,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:T,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(M)}};U=this.mungSendMediaDesc(U,A);const B=this.findFirstClosedMedia(_);if(B){const V=this.sessionDesc.mediaDescriptions.indexOf(B);this.sessionDesc.mediaDescriptions[V]=U}else this.sessionDesc.mediaDescriptions.push(U);return U}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(_=>_.media.port!=="0").map(_=>_.attributes.mid)}mungRecvMediaDsec(_,R,f){const T=Zt(_);return Ou(T),_s(T,R),Nu(T,R),M_(T),aa(T,f,this.localCapabilities.send),T}mungSendMediaDesc(_,R){const f=Zt(_);return aa(f,R,this.localCapabilities.recv),Xi(f),f}updateRecvMedia(_,R){const f=this.sessionDesc.mediaDescriptions.findIndex(T=>T.attributes.mid===_);if(f!==-1){const T=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[f],R);this.sessionDesc.mediaDescriptions[f]=T}}bumpMid(_){this.currentMidIndex+=_}findFirstClosedMedia(_){return this.sessionDesc.mediaDescriptions.find(R=>Jt()?R.media.port==="0"&&R.media.mediaType===_:R.media.port==="0")}findPreloadMediaDesc(_){return this.sessionDesc.mediaDescriptions.find(R=>{var f;return((f=R.attributes)===null||f===void 0||(f=f.ssrcs[0])===null||f===void 0?void 0:f.ssrcId)===_[0].ssrcId})}getSSRC(_){var R;return(R=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_))===null||R===void 0?void 0:R.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:r,remoteSetup:s,localCapabilities:this.localCapabilities,cname:o}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const a=this.remoteSDP.toString(),c=oe.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(_=>_.media.mediaType==="audio");d&&Xi(d),this.useXR&&vc(c);const u=oe.print(c),l=this.logSDPExchange(u||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const p=this.peerConnection.getTransceivers()[0];if(p!=null&&p.receiver&&this.tryBindTransportEvents(p.receiver),O("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const _=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:_});const R=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(R)}}catch(a){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];t.forEach(f=>{const T=r.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});o.push(T),f._updateRtpTransceiver(T)}),Jt()&&O("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(o,t)));const a=yield St(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(t.length),d=r.mungSendOfferSDP(a.sdp,t,c),u=oe.parse(d),l=c.map(f=>{const T=u.mediaDescriptions.find(A=>A.attributes.mid===f);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return k_(T,O("USE_PUB_RTX"))});let p;try{p=yield l}catch(f){p=[],r.remoteSDP.receive(t,e,i,p);const T=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),yield St(r.stopSending(c,!0)),f}r.remoteSDP.receive(t,e,i,p);const _=r.remoteSDP.toString(),R=r.logSDPExchange(d,"offer","local","send");return yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield St(r.applySimulcastEncodings(o,t)),yield St(r.applySendEncodings(o,t)),R==null||R(_),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:_})),o.map((f,T)=>{const A=c[T];return{localSSRC:l[T],id:A,transceiver:f}})}catch(o){throw o instanceof G?o:new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}})()}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);i&&i.readyState==="open"?m.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:O("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)),e.forEach(s=>{s._updateOriginDataChannel(i)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),m.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else m.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof G?i:new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return e==null||e.close(),void this.dataStreamChannelMap.delete(t)}catch(e){throw e instanceof G?e:new G(v.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,e,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,s,t);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===s);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const r=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=await this.peerConnection.createAnswer();s==null||s(o.sdp||""),await this.peerConnection.setLocalDescription(o),m.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return e.map(r=>{const s=this.peerConnection.getTransceivers().find(o=>o.mid===r);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async(o,a)=>{o.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new G(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return Kn(function*(){const i=yield St(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Kt().supportPCSetConfiguration){const d=e.peerConnection.getConfiguration(),u=t===nn.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(m.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,e.peerConnection.setConfiguration(d))}else if(t===nn.RELAY)return;e.remoteSDP.updateCandidates(t);const r=yield St(e.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=zi(r.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString(),c=e.logSDPExchange(r.sdp||"","offer","local","restartICE");e.store.descriptionStart(),yield St(e.peerConnection.setLocalDescription(r)),c==null||c(a),yield St(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){m.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new G(v.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(e)?Jt()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find(r=>r.mid===e);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:i,remote:r}=e.getSelectedCandidatePair();return{local:ua(ua({},mr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:ua(ua({},mr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},O("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(xo(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...pe.turnServerConfigToIceServers(t.turnServer.servers)),O("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...pe.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),O("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(e.iceTransportPolicy="relay")}))),O("ENABLE_ENCODED_TRANSFORM")&&Kt().supportWebRTCEncodedTransform&&(e.encodedInsertableStreams=!0),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(i=>{i.security?i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(rs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!O("FORCE_TURN_TCP")&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),e}tryBindTransportEvents(t){const e=t.transport;if(e){this.transportEventReceiver=t,e.onstatechange=()=>{var r;e!=null&&e.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,e.state))},e.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const r=e==null?void 0:e.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair();m.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find(u=>u.track===t._mediaStreamTrack)),!e)return m.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return m.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Kt().supportSetRtpSenderParameters)return m.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:u,frameRate:l,scaleResolutionDownBy:p}=t._encoderConfig;u&&(s.maxBitrate=1e3*u),(nt(o=t._hints).call(o,$t.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(l&&(s.maxFramerate=ri(l)),p&&p>=1&&(s.scaleResolutionDownBy=p))}if(O("DSCP_TYPE")&&Jr()){var a;const u=O("DSCP_TYPE");nt(a=["very-low","low","medium","high"]).call(a,u)&&(s.networkPriority=u)}const c=e.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];Jt()&&!d&&(r.encodings=[s]),d&&Object.assign(d,s),Object.assign(c,r),m.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await e.setParameters(c)}async applySendEncodings(t,e){try{if(!Kt().supportSetRtpSenderParameters||t.length!==e.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=e[i];s instanceof Ct&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,i){const r=oe.parse(t);return e.forEach((s,o)=>{const a=i[o],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(_s(c,s),U_(c,s,this.store.codec))}),oe.print(r)}mungReceiveAnswerSDP(t,e,i){const r=oe.parse(t),s=r.mediaDescriptions.find(o=>o.attributes.mid===e);return s&&(i===rt.AUDIO&&s.media.mediaType==="audio"&&Xi(s),this.useXR&&vc(r)),oe.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],u=e[c];if(u instanceof Ct&&!nt(i=u._hints).call(i,$t.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=u._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=u._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,l))}}}async applySimulcastEncodings(t,e){if(!Jt()&&t.length===e.length)for(let i=0;i<t.length;i++){const r=e[i];if(r instanceof Ct&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,i,r,s,o;return!!(t instanceof Ct&&O("SIMULCAST")&&this.store.codec==="vp8"&&!nt(e=t._hints).call(e,$t.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,r){if(O("SDP_LOGGING"))return m.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(e," SDP during P2PConnection.").concat(r,`
`),t),e==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Kt().supportPCSetConfiguration){const e=pe.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function Yn(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function jy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Gy(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?jy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):jy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}W([Yn,S("design:type",Function),S("design:paramtypes",[Array,Array]),S("design:returntype",F)],pe.prototype,"updateRemoteRTPCapabilities",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],pe.prototype,"connect",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Object,Array]),S("design:returntype",F)],pe.prototype,"createDataChannels",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String,Array,String,Object]),S("design:returntype",F)],pe.prototype,"receive",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],pe.prototype,"batchReceive",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],pe.prototype,"stopReceiving",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],pe.prototype,"muteRemote",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],pe.prototype,"unmuteRemote",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],pe.prototype,"muteLocal",null),W([Yn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],pe.prototype,"unmuteLocal",null),W([Yn,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],pe.prototype,"close",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],pe.prototype,"updateEncoderConfig",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],pe.prototype,"updateSendParameters",null),W([Yn,S("design:type",Function),S("design:paramtypes",[rn,String]),S("design:returntype",F)],pe.prototype,"replaceTrack",null),W([Yn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],pe.prototype,"getRemoteSSRC",null);const Wy=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,ku="9",j_=2e4,G_=4e4;class y2{get localCapabilities(){return Zt(this._localCapabilities)}get rtpCapabilities(){return Zt(this._rtpCapabilities)}get candidates(){return Zt(this._candidates)}get iceParameters(){return Zt(this._iceParameters)}get dtlsParameters(){return Zt(this._dtlsParameters)}constructor(t){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),t=Zt(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:a,cname:c}=t,d=oe.parse(Wy);this._rtpCapabilities=s,this._candidates=r,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=a,this.setup=o,this.cname=c;const u=this.rtpCapabilities.send;for(const l of d.mediaDescriptions){if(l.attributes.iceUfrag=e.iceUfrag,l.attributes.icePwd=e.icePwd,l.attributes.fingerprints=i.fingerprints,l.attributes.candidates=r,l.attributes.setup=o,l.media.mediaType==="application"&&(l.attributes.sctpPort="5000"),l.media.mediaType==="video"&&(l.media.fmts=u.videoCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=u.videoCodecs,l.attributes.extmaps=u.videoExtensions,O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:_}=xn([{ssrcId:G_,rtx:O("USE_SUB_RTX")?40001:void 0}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=_}if(l.media.mediaType==="audio"&&(l.media.fmts=u.audioCodecs.map(p=>p.payloadType.toString(10)),l.attributes.payloads=u.audioCodecs,l.attributes.extmaps=u.audioExtensions,Xi(l),O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:_}=xn([{ssrcId:j_}],this.cname);l.attributes.ssrcs=p,l.attributes.ssrcGroups=_}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){const e=oe.parse(Wy);this._rtpCapabilities=t;const i=this.rtpCapabilities.send;for(const r of e.mediaDescriptions){if(r.attributes.iceUfrag=this._iceParameters.iceUfrag,r.attributes.icePwd=this._iceParameters.icePwd,r.attributes.fingerprints=this._dtlsParameters.fingerprints,r.attributes.candidates=this._candidates,r.attributes.setup=this.setup,r.media.mediaType==="application"&&(r.attributes.sctpPort="5000"),r.media.mediaType==="video"&&(r.media.fmts=i.videoCodecs.map(s=>s.payloadType.toString(10)),r.attributes.payloads=i.videoCodecs,r.attributes.extmaps=i.videoExtensions,O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:s,ssrcGroups:o}=xn([{ssrcId:G_,rtx:O("USE_SUB_RTX")?40001:void 0}],this.cname);r.attributes.ssrcs=s,r.attributes.ssrcGroups=o}if(r.media.mediaType==="audio"&&(r.media.fmts=i.audioCodecs.map(s=>s.payloadType.toString(10)),r.attributes.payloads=i.audioCodecs,r.attributes.extmaps=i.audioExtensions,O("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:s,ssrcGroups:o}=xn([{ssrcId:j_}],this.cname);r.attributes.ssrcs=s,r.attributes.ssrcGroups=o}}this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;const e=this.candidates,i=this.dtlsParameters,r=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<t;o++){const a=2*o+j_,c=2*o+G_,{ssrcs:d,ssrcGroups:u}=xn([{ssrcId:a}],this.cname),{ssrcs:l,ssrcGroups:p}=xn([{ssrcId:c,rtx:O("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:ku,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:e,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:p,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:ku,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:e,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:u,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return oe.print(this.sessionDesc)}send(t,e,i,r){const{ssrcs:s,ssrcGroups:o}=xn(e,this.cname,O("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(s);if(a){if(Jt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,s);let d;return c===-1||fn()||gn()||SS()||c===0&&O("USE_SUB_RTX")?(d=this.createOrRecycleSendMedia(t,s,o,"sendonly",r),this.updateBundleMids()):(d=Zt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=s,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Jt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const e=t.map(s=>{let{kind:o,ssrcMsg:a,mslabel:c}=s;return this.send(o,a,c)}),i=[];let r=!1;return e.forEach(s=>{let{mid:o,needExchangeSDP:a}=s;a&&(r=!0),i.push(o)}),{mids:i,needExchangeSDP:r}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(i=>{i.attributes.mid==="0"||Jt()||fn()||gn()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0")}),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>nt(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>nt(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="recvonly"})}receive(t,e,i,r){t.forEach((s,o)=>{this.createOrRecycleRecvMedia(s,[],"recvonly",e,i,r[o])}),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(t){t===nn.TCP?this._candidates.forEach(e=>{this._candidates.findIndex(i=>i.transport==="tcp"&&i.connectionAddress===e.connectionAddress&&i.port===e.port)===-1&&this._candidates.push(Gy(Gy({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))}):this._candidates=this._candidates.filter(e=>e.transport!=="tcp");for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(t){t=Zt(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Jt()){if(r){const s=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(s||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!s||s!==i.attributes.mid)}return!1}return r})}createOrRecycleRecvMedia(t,e,i,r,s,o){const a=t._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=ao(a,c,this.localCapabilities.send,a===rt.VIDEO?r:s),u=a===rt.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let p={media:{mediaType:a,port:ku,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(R=>R.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};p=this.mungRecvMediaDsec(p,t,o);const _=this.findFirstClosedMedia(a);if(_){const R=this.sessionDesc.mediaDescriptions.indexOf(_);this.sessionDesc.mediaDescriptions[R]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteCodec(t,e,i){const r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var _;return nt(_=Object.keys(Zr)).call(_,p)}))],s=new Set(e);if(r.every(p=>s.has(p)))return m.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter(p=>e.some(_=>{var R;return nt(R=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(R,_)}));if(o.length===0)return m.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(e)),!1;const a=[...new Set(o.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(m.debug("updateRemoteCodec, from ".concat(r," to ").concat(a)),t.length===0)c=this.sessionDesc.mediaDescriptions.filter(p=>p.media.mediaType==="video"&&p.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&nt(t).call(t,p.attributes.mid)&&p.attributes.direction==="recvonly"),c.length!==t.length)return m.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;this._rtpCapabilities.recv.videoCodecs=o;const d=this.localCapabilities.send,u=this.rtpCapabilities.recv,l=ao(rt.VIDEO,u,d,i);return c.forEach(p=>{const _=l.map(R=>R.payloadType.toString(10));m.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from ").concat(p.attributes.payloads," to ").concat(l)),p.attributes.payloads=l,p.media.fmts=_}),!0}createOrRecycleSendMedia(t,e,i,r,s){const o=this.rtpCapabilities.send,a=t===rt.VIDEO?o.videoCodecs:o.audioCodecs,c=t===rt.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:t,port:ku,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungSendMediaDesc(u,s);const l=this.findFirstClosedMedia(t);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,e,i){const r=Zt(t);return Ou(r),_s(r,e),Nu(r,e),M_(r),aa(r,i,this.localCapabilities.send),r}mungSendMediaDesc(t,e){const i=Zt(t);return aa(i,e,this.localCapabilities.recv),Xi(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===t);if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>Jt()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var i;return((i=e.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===t[0].ssrcId})}getSSRC(t){var e;return(e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t))===null||e===void 0?void 0:e.attributes.ssrcs}}function Hy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Mu(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Hy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Hy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}class an extends Qd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let t;return this.localCapabilities&&(t=ca(this.localCapabilities)),[...new Set(t&&t.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return nt(i=Object.keys(Zr)).call(i,e)}))]}constructor(t,e,i){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useXR",O("USE_XR")),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"remoteCodecs",void 0),h(this,"dataStreamChannelMap",new Map),h(this,"establishPromise",void 0),h(this,"mutex",new He("NVExtentionsConnection-mutex")),h(this,"rtcMedia",void 0),this.store=e,this.peerConnection=i,this.statsFilter=wu(this.peerConnection,O("STATS_UPDATE_INTERVAL"),void 0,Jt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=zi(e.sdp),r=await x_({filterRTX:!O("USE_PUB_RTX")&&!O("USE_SUB_RTX"),filterVideoFec:O("FILTER_VIDEO_FEC"),filterAudioFec:O("FILTER_AUDIO_FEC"),filterVideoCodec:O("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=r,this.initialOffer=e,Mu(Mu({},i),{},{rtpCapabilities:r,offerSDP:e.sdp})}catch(e){throw new k(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t,e,i,r,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new y2({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:r,remoteSetup:s,localCapabilities:ca(this.localCapabilities),cname:o});const a=this.remoteSDP.toString(),c=oe.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(p=>p.media.mediaType==="audio");d&&Xi(d),this.useXR&&vc(c);const u=oe.print(c),l=this.logSDPExchange(u||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:u}),l==null||l(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new k(v.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,e){if(this.remoteCodecs=e,!this.remoteSDP)return void m.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(e));if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else m.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(t){var e,i,r,s;(e=this.remoteSDP)===null||e===void 0||e.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((s=this.remoteSDP)===null||s===void 0||s.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(i=this.remoteSDP)===null||i===void 0||i.preloadRemoteMedia(2);const o=(r=this.remoteSDP)===null||r===void 0?void 0:r.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),m.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.mutex.lock("From NVExtentionsConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];t.forEach(f=>{const T=r.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});o.push(T)}),Jt()&&O("SIMULCAST")===!0&&(yield St(r.applySimulcastForFirefox(o,t)));const a=yield St(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(t.length),d=r.mungSendOfferSDP(a.sdp,t,c),u=oe.parse(d),l=c.map(f=>{const T=u.mediaDescriptions.find(A=>A.attributes.mid===f);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return k_(T,O("USE_PUB_RTX"))});let p;try{p=yield l}catch(f){p=[],r.remoteSDP.receive(t,e,i,p);const T=r.remoteSDP.toString();throw yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),yield St(r.stopSending(c,!0)),f}r.remoteSDP.receive(t,e,i,p);const _=r.remoteSDP.toString(),R=r.logSDPExchange(d,"offer","local","send");return yield St(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield St(r.applySimulcastEncodings(o,t)),yield St(r.applySendEncodings(o,t)),R==null||R(_),yield St(r.peerConnection.setRemoteDescription({type:"answer",sdp:_})),o.map((f,T)=>{const A=c[T];return{localSSRC:l[T],id:A,transceiver:f}})}catch(o){throw o instanceof k?o:new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(o.toString()))}finally{s()}})()}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);return i&&i.readyState==="open"?m.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:O("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)),void e.forEach(r=>{r._updateOriginDataChannel(i)})}catch(i){throw i instanceof k?i:new k(v.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return e==null||e.close(),void this.dataStreamChannelMap.delete(t)}catch(e){throw e instanceof k?e:new k(v.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(t,e,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(u.sdp,s,t);d==null||d(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),m.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else m.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===s);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s}}catch(s){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const r=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=await this.peerConnection.createAnswer();s==null||s(o.sdp||""),await this.peerConnection.setLocalDescription(o),m.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else m.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return e.map(r=>{const s=this.peerConnection.getTransceivers().find(o=>o.mid===r);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r}})}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async(o,a)=>{o.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new k(v.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return Kn(function*(){const i=yield St(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Kt().supportPCSetConfiguration){const d=e.peerConnection.getConfiguration(),u=t===nn.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(m.debug("restartICE change iceTransportPolicy from [".concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,e.peerConnection.setConfiguration(d))}else if(t===nn.RELAY)return;t!==nn.RELAY&&e.remoteSDP.updateCandidates(t);const r=yield St(e.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=zi(r.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString(),c=e.logSDPExchange(r.sdp||"","offer","local","restartICE");yield St(e.peerConnection.setLocalDescription(r)),c==null||c(a),yield St(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){m.warning("restart ICE failed, abort operation",r)}finally{i()}})()}close(){var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new k(v.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(e)?Jt()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find(r=>r.mid===e);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if((t=this.peerConnection.currentLocalDescription)===null||t===void 0||!t.sdp||!this.localCapabilities)throw new Error;return Mu(Mu({},zi(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},O("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(xo(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...an.turnServerConfigToIceServers(t.turnServer.servers)),O("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...an.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),O("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(i=>{i.security?i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(rs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!O("FORCE_TURN_TCP")&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),e}async applySendEncodings(t,e){try{if(!Kt().supportSetRtpSenderParameters||t.length!==e.length)return;for(let l=0;l<t.length;l++){const p=t[l],_=e[l];if(_&&_ instanceof Ct){var i,r,s;if(this.isVP8Simulcast(_))continue;const R={},f={};switch(_._optimizationMode){case"motion":R.degradationPreference="maintain-framerate";break;case"detail":R.degradationPreference="maintain-resolution";break;default:R.degradationPreference="balanced"}var o,a,c,d;if((i=_._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&(f.maxBitrate=1e3*((o=_._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)),nt(r=_._hints).call(r,$t.LOW_STREAM)&&((a=_._encoderConfig)!==null&&a!==void 0&&a.frameRate&&(f.maxFramerate=ri(_._encoderConfig.frameRate)),(c=_._encoderConfig)!==null&&c!==void 0&&c.scaleResolutionDownBy&&((d=_._encoderConfig)===null||d===void 0?void 0:d.scaleResolutionDownBy)>1&&(f.scaleResolutionDownBy=_._encoderConfig.scaleResolutionDownBy)),O("DSCP_TYPE")&&Jr()){var u;const N=O("DSCP_TYPE");nt(u=["very-low","low","medium","high"]).call(u,N)&&(f.networkPriority=N)}const T=p.sender.getParameters(),A=(s=T.encodings)===null||s===void 0?void 0:s[0];Jt()&&!A&&(R.encodings=[f]),A&&Object.assign(A,f),Object.assign(T,R),await p.sender.setParameters(T)}}}catch{m.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,e,i){const r=oe.parse(t);return e.forEach((s,o)=>{const a=i[o],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(_s(c,s),U_(c,s,this.store.codec))}),oe.print(r)}mungReceiveAnswerSDP(t,e,i){const r=oe.parse(t),s=r.mediaDescriptions.find(o=>o.attributes.mid===e);return s&&i===rt.AUDIO&&s.media.mediaType==="audio"&&Xi(s),this.useXR&&vc(r),oe.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],u=e[c];if(u instanceof Ct&&!nt(i=u._hints).call(i,$t.LOW_STREAM)&&(r=u._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=u._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=u._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=u._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},p={high:1e3*(u._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,l))}}}async applySimulcastEncodings(t,e){if(!Jt()&&t.length===e.length)for(let i=0;i<t.length;i++){const r=e[i];if(r instanceof Ct&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,i,r,s,o;return!!(t instanceof Ct&&O("SIMULCAST")&&this.store.codec==="vp8"&&!nt(e=t._hints).call(e,$t.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,r){if(O("SDP_LOGGING"))return m.upload("exchanging ".concat(i," ").concat(e," SDP during NVExtentionsConnection.").concat(r,`
`),t),e==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Kt().supportPCSetConfiguration){const e=an.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function Vn(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("From NVExtentionsConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function Ky(n){var t,e,i,r=2;for(typeof Symbol<"u"&&(e=Ly,i=Symbol.iterator);r--;){if(e&&(t=n[e])!=null)return t.call(n);if(i&&(t=n[i])!=null)return new Uu(t.call(n));e="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Uu(n){function t(e){if(Object(e)!==e)return F.reject(new TypeError(e+" is not an object."));var i=e.done;return F.resolve(e.value).then(function(r){return{value:r,done:i}})}return Uu=function(e){this.s=e,this.n=e.next},Uu.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return i===void 0?F.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return i===void 0?F.reject(e):t(i.apply(this.s,arguments))}},new Uu(n)}W([Vn,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],an.prototype,"connect",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Array,Array]),S("design:returntype",F)],an.prototype,"updateRemoteRTPCapabilities",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],an.prototype,"updateRemoteConnect",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Object,Array]),S("design:returntype",F)],an.prototype,"createDataChannels",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String,Array,String,Object]),S("design:returntype",F)],an.prototype,"receive",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],an.prototype,"batchReceive",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],an.prototype,"stopReceiving",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],an.prototype,"muteRemote",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],an.prototype,"unmuteRemote",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],an.prototype,"muteLocal",null),W([Vn,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],an.prototype,"unmuteLocal",null),W([Vn,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],an.prototype,"close",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],an.prototype,"updateEncoderConfig",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],an.prototype,"updateSendParameters",null),W([Vn,S("design:type",Function),S("design:paramtypes",[rn,String]),S("design:returntype",F)],an.prototype,"replaceTrack",null),W([Vn,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],an.prototype,"getRemoteSSRC",null);class Ue extends Qd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"cname",void 0),h(this,"mutex",new He("DataChannelConnection-mutex")),h(this,"dataChannel",void 0),h(this,"_p2pConnection",void 0),h(this,"establishPromise",void 0),h(this,"_nvMedia",void 0),this.store=e,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Ue.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new an(t,e,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;const e=(t=this._nvMedia)===null||t===void 0?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(e)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,e,i,r,s,o){return this.cname=o,await this._p2pConnection.connect(t,e,i,r,s,o),await new F((a,c)=>{const d=setTimeout(()=>{this.closeSignal(),c(new k(v.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=u=>{this.closeSignal(),c(u)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,e){return this._p2pConnection.updateRemoteRTPCapabilities(t,e)}send(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Lu(Ky(r._p2pConnection.send(t,e,i)))}finally{s()}})()}async stopSending(t,e){return this._p2pConnection.stopSending(t,e)}async createDataChannels(t,e){return this._p2pConnection.createDataChannels(t,e)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,e,i,r){return this._nvMedia?(m.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,e,this.cname)):(m.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,e,i,r))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var e=this;return Kn(function*(){return yield*Lu(Ky(e._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var e;(e=this._nvMedia)===null||e===void 0||e.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,e){return await this._p2pConnection.updateEncoderConfig(t,e)}async updateSendParameters(t,e){return await this._p2pConnection.updateSendParameters(t,e)}setStatsRemoteVideoIsReady(t,e){this._p2pConnection.setStatsRemoteVideoIsReady(t,e)}async replaceTrack(t,e){return await this._p2pConnection.replaceTrack(t,e)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,e,i,r){if(O("SDP_LOGGING"))return m.upload("exchanging ".concat(i," ").concat(e," SDP during DataChannelConnection.").concat(r,`
`),t),e==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(xo(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...Ue.turnServerConfigToIceServers(t.turnServer.servers)),O("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...Ue.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),O("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(i=>{i.security?i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(rs(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!O("FORCE_TURN_TCP")&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&e.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),e}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var e;return(e=this.onICEConnectionStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var e;return(e=this.onConnectionStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var e;return(e=this.onDTLSTransportStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var e;return(e=this.onDTLSTransportError)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var e;return(e=this.onICETransportStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var e;return(e=this.onFirstAudioReceived)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var e;return(e=this.onFirstVideoReceived)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var e;return(e=this.onFirstAudioDecoded)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,e,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,t,e,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var e;return(e=this.onFirstVideoDecodedTimeout)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,e)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,t,e)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,e)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,t,e)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}}function pi(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function Yy(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function gs(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?Yy(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):Yy(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}function qy(n){var t,e,i,r=2;for(typeof Symbol<"u"&&(e=Ly,i=Symbol.iterator);r--;){if(e&&(t=n[e])!=null)return t.call(n);if(i&&(t=n[i])!=null)return new xu(t.call(n));e="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function xu(n){function t(e){if(Object(e)!==e)return F.reject(new TypeError(e+" is not an object."));var i=e.done;return F.resolve(e.value).then(function(r){return{value:r,done:i}})}return xu=function(e){this.s=e,this.n=e.next},xu.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return i===void 0?F.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return i===void 0?F.reject(e):t(i.apply(this.s,arguments))}},new xu(n)}W([pi,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],Ue.prototype,"connect",null),W([pi,S("design:type",Function),S("design:paramtypes",[Array,Array]),S("design:returntype",F)],Ue.prototype,"updateRemoteRTPCapabilities",null),W([pi,S("design:type",Function),S("design:paramtypes",[Object,Array]),S("design:returntype",F)],Ue.prototype,"createDataChannels",null),W([pi,S("design:type",Function),S("design:paramtypes",[String,Array,String,Object]),S("design:returntype",F)],Ue.prototype,"receive",null),W([pi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Ue.prototype,"stopReceiving",null),W([pi,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Ue.prototype,"muteRemote",null),W([pi,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Ue.prototype,"unmuteRemote",null),W([pi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Ue.prototype,"muteLocal",null),W([pi,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Ue.prototype,"unmuteLocal",null),W([pi,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Ue.prototype,"close",null),W([pi,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],Ue.prototype,"updateEncoderConfig",null),W([pi,S("design:type",Function),S("design:paramtypes",[String,rn]),S("design:returntype",F)],Ue.prototype,"updateSendParameters",null),W([pi,S("design:type",Function),S("design:paramtypes",[rn,String]),S("design:returntype",F)],Ue.prototype,"replaceTrack",null),W([pi,S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Ue.prototype,"getRemoteSSRC",null);class Je extends se{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(lt.StateChange,e,this._state)}constructor(t,e){super(),h(this,"store",void 0),h(this,"statsUploader",void 0),h(this,"connection",void 0),h(this,"localTrackMap",new Map),h(this,"remoteUserMap",new Map),h(this,"localDataChannels",[]),h(this,"remoteDataChannelMap",new Map),h(this,"pendingLocalTracks",[]),h(this,"pendingRemoteTracks",[]),h(this,"pendingLocalDataChannels",[]),h(this,"pendingRemoteDataChannels",[]),h(this,"statsCollector",void 0),h(this,"isPlanB",!1),h(this,"shouldForwardP2PCreation",void 0),h(this,"iceFailedCount",0),h(this,"dtlsFailedCount",0),h(this,"mutex",new He("P2PChannel-mutex")),h(this,"_state",Bt.Disconnected),h(this,"_pcStatsUploadType",O("NEW_ICE_RESTART")?Ji.FIRST_CONNECTION:Ji.OLD_FIRST_CONNECTION),h(this,"_isInRestartIce",!1),h(this,"_isStartRestartIce",!1),h(this,"_restartStates",["disconnected","failed"]),h(this,"_restartTimer",void 0),h(this,"_isFirstConnected",!0),h(this,"handleMuteLocalTrack",async(i,r,s)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Bt.Connected)return void s(new G(v.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const a=this.filterTobeMutedTracks(i);if(a.length===0)return void r();const c=a.find(u=>u[0]==="videoLowTrack");c&&c[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(a.map(u=>{let[,{id:l}]=u;return l}));const d=this.createMuteMessage(a);await Xt(this,lt.RequestMuteLocal,d),r()}catch(a){s(a)}finally{o()}}),h(this,"handleUnmuteLocalTrack",async(i,r,s)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Bt.Connected)return void s(new G(v.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();const c=a.find(u=>u[0]==="videoLowTrack");if(c){const u=c[1];if(u.track._originMediaStreamTrack.stop(),!O("DISABLE_DUAL_STREAM_USE_ENCODING")&&Kt().supportDualStreamEncoding){const l=i._mediaStreamTrack.clone();u.track._mediaStreamTrack=l,u.track._originMediaStreamTrack=l}else{const l=V_(i,js(this,lt.RequestLowStreamParameter));u.track._mediaStreamTrack=l,u.track._originMediaStreamTrack=l}await new F((l,p)=>{this.handleReplaceTrack(u.track,l,p,!0)})}await this.connection.unmuteLocal(a.map(u=>{let[,{id:l}]=u;return l}));const d=this.createUnmuteMessage(a);await Xt(this,lt.RequestUnmuteLocal,d),r()}catch(a){s(a)}finally{o()}}),h(this,"handleUpdateVideoEncoder",async(i,r,s)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const a=this.localTrackMap.get(Y.LocalVideoTrack);if(!this.connection||!a||a.track!==i||this.state!==Bt.Connected)return void r();const{id:c,track:d}=a;await this.connection.updateSendParameters(c,d),await this.connection.updateEncoderConfig(c,d),this.emit(lt.UpdateVideoEncoder,d),r()}catch(a){s(a)}finally{o()}}),h(this,"handleSetOptimizationMode",async(i,r,s)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const a=this.localTrackMap.get(Y.LocalVideoTrack);if(!this.connection||!a||a.track!==i||this.state!==Bt.Connected)return;const{id:c,track:d}=a;await this.connection.updateSendParameters(c,d),r()}catch(a){s(a)}finally{o()}}),h(this,"handleReplaceTrack",async(i,r,s,o)=>{let a;m.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var c;const u=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:p}]=l;return i===p});if(!this.connection||!u||this.state!==Bt.Connected)return void r();if(await((c=this.connection)===null||c===void 0?void 0:c.replaceTrack(i,u[1].id)),this.isPlanB){const l=u[1];l.id=i._mediaStreamTrack.id,this.localTrackMap.set(u[0],l)}if(u[0]===Y.LocalVideoTrack&&!O("DISABLE_DUAL_STREAM_USE_ENCODING")&&Kt().supportDualStreamEncoding){const l=this.localTrackMap.get(Y.LocalVideoLowTrack);if(l){const p=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=p,l.track._originMediaStreamTrack=p,await new F((_,R)=>{this.handleReplaceTrack(l.track,_,R,!0)})}}r()}catch(u){s(u)}finally{var d;(d=a)===null||d===void 0||d()}}),h(this,"handleGetRTCStats",i=>{i(this.statsCollector.getRTCStats())}),h(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),h(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),h(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),h(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new by(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Kt().supportUnifiedPlan||O("CHROME_FORCE_PLAN_B")&&Jr(),this.shouldForwardP2PCreation=O("FORWARD_P2P_CREATION")&&Kt().supportPCSetConfiguration&&function(){const i=wd();return i===Ne.ANDROID||i===Ne.IOS||i===Ne.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ue({},this.store):this.isPlanB?new qe({},this.store):new pe({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var i;this.state=Bt.New;const r=this.shouldForwardP2PCreation&&((i=this.connection)===null||i===void 0?void 0:i.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!r||(r&&this.connection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Ue(t,this.store):this.isPlanB?new qe(t,this.store):new pe(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=O("NEW_ICE_RESTART")?Ji.FIRST_CONNECTION:Ji.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,i,r,s,o){if(!this.connection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Ue?this.connection.updateRemoteConnect(r):(this.store.peerConnectionStart(),await this.connection.connect(t,e,i,r,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Bt.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(s=>{var o;let[a]=s;return nt(o=[Y.LocalVideoLowTrack,Y.LocalVideoTrack]).call(o,a)}),i=e.map(s=>{let[,{id:o}]=s;return o}),r=e.map(s=>{let[o]=s;return o});if(this.connection instanceof pe){if(st.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!nt(t).call(t,this.store.codec)){const s=["vp8","h264"].find(o=>nt(t).call(t,o));s&&(this.store.codec=s,m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(s,".")))}this.connection.updateRemoteRTPCapabilities(i,t)}}async preConnect(t,e,i,r,s,o){if(!this.connection)throw new G(v.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const a=await this.connection.connect(t,e,i,r,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Bt.Connected,a}getEstablishParams(){if(this.connection instanceof Ue)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection){if(this.state===Bt.Disconnected)throw new G(v.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const i=t.filter(r=>this.pendingLocalDataChannels.findIndex(s=>s.id===r.id)!==-1);return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(i))}const e=this.filterTobePublishedDataChannels(t);e.length!==0&&(e.forEach(i=>{const r=Date.now();this.store.publish(i.id.toString(),"datachannel",r)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(i=>{this.localDataChannels.push(i);const r=Date.now();this.store.publish(i.id+"","datachannel",void 0,r)}))}publish(t,e,i){var r=this;return Kn(function*(){const s=yield St(r.mutex.lock("From P2PChannel.publish"));try{if(!r.connection||r.state!==Bt.Connected){if(r.state===Bt.Disconnected)throw new G(v.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(t);const a=t.filter(c=>r.pendingLocalTracks.indexOf(c)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(a))}r.store.pubId=r.store.pubId+1,sn.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(t,e,i);if(o.length===0)return void(yield St(r.tryToUnmuteAudio(t)));yield*Lu(qy(r.doPublish(r.connection,o)))}finally{s()}})()}doPublish(t,e){var i=this;return Kn(function*(){e.forEach(u=>{let{track:l,type:p}=u;const _=Date.now();i.store.publish(l.getTrackId(),p===Y.LocalAudioTrack?"audio":"video",_)}),i.bindLocalTrackEvents(e);const r=yield St(t.send(e.map(u=>{let{track:l}=u;return l}),i.store.codec,i.store.audioCodec)),s=(yield St(r.next())).value,o=i.createGatewayPublishMessage(e,s);let a;try{a=yield o}catch(u){throw r.throw(u),(u==null?void 0:u.code)===v.WS_ABORT&&e.forEach(l=>{let{track:p}=l;i.pendingLocalTracks.indexOf(p)===-1&&i.pendingLocalTracks.push(p)}),i.unbindLocalTrackEvents(e),u}const c=i.mapPubResToRemoteConfig(o,a),d=(yield St(r.next(c))).value;e.forEach(u=>{let{type:l}=u;i.statsCollector.addLocalStats(l)}),i.assignLocalTracks(e,d),i.statsUploader.startUploadOutboundStats(),e.forEach(u=>{let{track:l,type:p}=u;const _=Date.now();i.store.publish(l.getTrackId(),p===Y.LocalAudioTrack?"audio":"video",void 0,_)})})()}async updateVideoStreamParameter(t,e){const i=this.localTrackMap.get(e);if(!i)return;if(!(i.track instanceof Ct))return m.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof pe||this.connection instanceof qe))return m.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:r}=i,s=function(o,a){const c={};return o.height&&o.width&&(c.scaleResolutionDownBy=Lp(o,a)),c.maxFramerate=o.framerate?ri(o.framerate):void 0,c.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,c}(t,r);if(r._encoderConfig||(r._encoderConfig={}),e!==Y.LocalVideoLowTrack||!O("DISABLE_DUAL_STREAM_USE_ENCODING")&&Kt().supportDualStreamEncoding)s.scaleResolutionDownBy!=null&&(r._encoderConfig.scaleResolutionDownBy=s.scaleResolutionDownBy);else{const o=r._originMediaStreamTrack;if(!o.canvas)return m.warn("[".concat(r.getTrackId(),"] no canvas on track"));(function(a,c){const d=a.canvas;c.width&&(d.width=ri(c.width)),c.height&&(d.height=ri(c.height)),c.framerate&&(d.stopCapture&&d.stopCapture(),d.stopCapture=Xp(()=>{!d.startCapture&&d.stopCapture&&d.stopCapture(),d.startCapture&&d.startCapture()},ri(c.framerate)))})(o,t)}s.maxBitrate!=null&&(r._encoderConfig.bitrateMax=s.maxBitrate/1e3),s.maxFramerate!=null&&(r._encoderConfig.frameRate&&typeof r._encoderConfig.frameRate=="object"?r._encoderConfig.frameRate.max=s.maxFramerate:r._encoderConfig.frameRate={max:s.maxFramerate}),m.debug("[".concat(r.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(r._encoderConfig))),await this.connection.updateRtpSenderEncodings(r)}publishLowStream(t){var e=this;return Kn(function*(){if(!e.connection||e.state!==Bt.Connected)return;const i=yield St(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=e.localTrackMap.get(Y.LocalVideoTrack);if(!s)throw new G(v.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(Y.LocalVideoLowTrack))throw new G(v.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(s.track,t),type:Y.LocalVideoLowTrack}];if(yield*Lu(qy(e.doPublish(e.connection,o))),s.track.muted||!s.track.enabled){var r;const a=(r=e.localTrackMap.get(Y.LocalVideoLowTrack))===null||r===void 0?void 0:r.id;a!==void 0&&(yield St(e.connection.muteLocal([a])))}}finally{i()}})()}async republish(){this.pendingLocalTracks.length>0&&(m.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Se(this,lt.RequestRePublish,this.pendingLocalTracks),this.emit(lt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(m.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Se(this,lt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:i,kind:r}=this.pendingRemoteTracks[e];(r!==rt.AUDIO||i._audio_added_&&i._audioSSRC)&&(r!==rt.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await Se(this,lt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:i}of this.pendingRemoteTracks)await this.subscribe(e,i,i===rt.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:i}=e;this.emit(lt.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==Bt.Connected)return void t.forEach(r=>{const s=this.pendingLocalTracks.indexOf(r);s!==-1&&this.pendingLocalTracks.splice(s,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const i=e.find(r=>r[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==Bt.Connected)return void t.forEach(i=>{const r=this.pendingLocalDataChannels.indexOf(i);r!==-1&&this.pendingLocalDataChannels.splice(r,1)});const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(i=>{const r=this.localDataChannels.indexOf(i);r!==-1&&this.localDataChannels.splice(r,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(i=>i.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Bt.Connected)return;const t=this.localTrackMap.get(Y.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[Y.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const i=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(r=>{let[,{id:s}]=r;return s})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[s,{track:o}]=r;return{type:s,track:o}})),e.forEach(r=>{let[s]=r;this.statsCollector.removeLocalStats(s)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(t,e){if(!this.connection||this.state!==Bt.Connected)throw new G(v.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=e.filter(r=>{var s;return!((s=this.remoteDataChannelMap.get(t))!==null&&s!==void 0&&s.get(r.id))});if(i.length!==0)return await this.connection.createDataChannels(t.uid,i),i.forEach(r=>{var s;this.remoteDataChannelMap.has(t)?(s=this.remoteDataChannelMap.get(t))===null||s===void 0||s.set(r.id,r):this.remoteDataChannelMap.set(t,new Map([[r.id,r]]));const o=this.pendingRemoteDataChannels.findIndex(a=>{let{user:c,id:d}=a;return c.uid===t.uid&&d===r.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),i.map(r=>r.id)}async subscribe(t,e,i,r,s){var o;if(!this.connection||this.state!==Bt.Connected)throw new G(v.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let a,c,d;if(s){const p=s.find(R=>{let{stream_type:f}=R;return f===e});if(!p)throw new G(v.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const _=await this.connection.receive(e,p.ssrcs,String(t._uintid),p.attributes);this.connection instanceof pe&&(d=_.transceiver),a=_.track,c=_.id}else{const p=await this.connection.receive(e,[{ssrcId:i,rtx:r}],String(t._uintid),void 0);this.connection instanceof pe&&(d=p.transceiver),a=p.track,c=p.id}e===rt.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(a):(t._audioTrack=new ki(a,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),d&&t._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(a):(t._videoTrack=new ur(a,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),d&&t._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._videoTrack));const u=this.remoteUserMap.get(t);u?u.set(e,c):this.remoteUserMap.set(t,new Map([[e,c]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex(p=>{let{user:_,kind:R}=p;return _.uid===t.uid&&e===R});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(lt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==Bt.Connected)throw new G(v.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(i=>{var r;let{user:s,mediaType:o}=i;return!((r=this.remoteUserMap.get(s))!==null&&r!==void 0&&r.has(o))});const e=await this.connection.batchReceive(t.map(i=>{let{user:r,mediaType:s,ssrcId:o,rtxSsrcId:a}=i;return{kind:s,ssrcMsg:[{ssrcId:o,rtx:a}],mslabel:String(r._uintid)}}));t.forEach((i,r)=>{let{user:s,mediaType:o}=i;const{track:a,id:c,transceiver:d}=e[r];o===rt.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(a):(s._audioTrack=new ki(a,s.uid,s._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),d&&s._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(a):(s._videoTrack=new ur(a,s.uid,s._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),d&&s._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(s,s._videoTrack));const u=this.remoteUserMap.get(s);u?u.set(o,c):this.remoteUserMap.set(s,new Map([[o,c]])),this.statsCollector.addRemoteStats(s.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex(p=>{let{user:_,kind:R}=p;return _.uid===s.uid&&o===R});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(lt.MediaReconnectEnd,s.uid))})}async unsubscribe(t,e,i){const r=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return e!==void 0?c.uid===t.uid&&e===d:c.uid===t.uid});if(r.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),this.connection&&this.state===Bt.Connected||i||r.forEach(a=>{let{kind:c}=a;var d;if(c===rt.AUDIO)(d=t._audioTrack)===null||d===void 0||d._destroy(),t._audioTrack=void 0;else if(c===rt.VIDEO){var u;(u=t._videoTrack)===null||u===void 0||u._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==Bt.Connected)return;const s=this.filterTobeUnSubscribedTracks(t,e);if(s.length===0)return;await this.connection.stopReceiving(s.map(a=>{let[,{id:c}]=a;return c}));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),s.forEach(a=>{let[c,{kind:d}]=a;var u,l;if(d===rt.VIDEO&&c._videoSSRC&&((u=this.connection)===null||u===void 0||u.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),d===rt.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),i||((l=c._videoTrack)===null||l===void 0||l._destroy(),c._videoTrack=void 0);else if(d===rt.AUDIO){var p;this.unbindRemoteTrackEvents(c._audioTrack),!i&&((p=c._audioTrack)===null||p===void 0||p._destroy(),c._audioTrack=void 0)}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(s=>{const o=this.pendingRemoteDataChannels.findIndex(a=>a.id===s.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(t,e);if(i.length===0)return;e.forEach(s=>{s._close()});const r=this.remoteDataChannelMap.get(t);return i.forEach(s=>{r&&r.delete(s.id)}),r&&r.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),i.map(s=>s.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:s,mediaType:o}of t){const a=this.pendingRemoteTracks.filter(c=>{let{user:d,kind:u}=c;return o!==void 0?d.uid===s.uid&&o===u:d.uid===s.uid});a.forEach(c=>{const d=this.pendingRemoteTracks.indexOf(c);this.pendingRemoteTracks.splice(d,1)}),e=e.concat(a)}if(!this.connection||this.state!==Bt.Connected)return void e.forEach(s=>{let{user:o,kind:a}=s;var c;if(a===rt.AUDIO)(c=o._audioTrack)===null||c===void 0||c._destroy(),o._audioTrack=void 0;else if(a===rt.VIDEO){var d;(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0}});const i=Hs(t).call(t,(s,o)=>{let{user:a,mediaType:c}=o;const d=this.filterTobeUnSubscribedTracks(a,c);return s.concat(d)},[]);if(i.length===0)return;await this.connection.stopReceiving(i.map(s=>{let[,{id:o}]=s;return o}));const r=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(s=>{let[o,{kind:a}]=s;var c,d;if(a===rt.VIDEO&&o._videoSSRC&&((c=this.connection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===rt.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0;else if(a===rt.AUDIO){var u;this.unbindRemoteTrackEvents(o._audioTrack),(u=o._audioTrack)===null||u===void 0||u._destroy(),o._audioTrack=void 0}}),r}async muteRemote(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void m.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void m.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const r=e===rt.VIDEO?t._videoSSRC:t._audioSSRC;r!==void 0&&this.connection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void m.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||m.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(Y.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ve){const i=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[s]=r;return s!==Y.LocalAudioTrack}).filter(r=>{let[s]=r;return!(t&&s===Y.LocalVideoLowTrack)}).map(r=>{let[,{track:s}]=r;return s}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(t&&r===Y.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,i,r,s){if(t){const a=this.localTrackMap.get(Y.LocalAudioTrack),c=r?this.localTrackMap.get(Y.LocalVideoLowTrack):this.localTrackMap.get(Y.LocalVideoTrack);st.publish(this.store.sessionId,{eventElapse:sn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf($t.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const a=i.find(d=>d instanceof Vt),c=r?(o=this.localTrackMap.get(Y.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(d=>d instanceof Ct);st.publish(this.store.sessionId,{eventElapse:sn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf($t.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(t,e,i,r){const s=r===rt.VIDEO?i._videoSSRC:i._audioSSRC;s&&st.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===rt.VIDEO,audio:r===rt.AUDIO,peerid:i.uid,subscribeRequestid:r===rt.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:sn.measureFromSubscribeStart(this.store.clientId,s)})}reset(){m.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new He("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ue({},this.store):this.isPlanB?new qe({},this.store):new pe({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(Y.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ve){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Bt.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(Y.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(Y.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Ct||e&&e.track instanceof Vt?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from($n(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(Y.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Ma(t).call(t,(i,r)=>i.level-r.level),t}async disconnectForReconnect(){this.connection&&(m.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Bt.Reconnecting,O("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ue({},this.store):this.isPlanB?new qe({},this.store):new pe({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:r}]=t;switch(i){case Y.LocalVideoTrack:nt(e=r._hints).call(e,$t.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case Y.LocalAudioTrack:r instanceof ve?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case Y.LocalVideoLowTrack:}}),this.emit(lt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from($n(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(e,r)}),this.emit(lt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,i]=t;Array.from($n(i).call(i)).forEach(r=>{this.setPendingRemoteDataChannel(e,r)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),m.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const i of this.pendingRemoteDataChannels){const{user:r,id:s}=i;if((t instanceof $e?t.uid:t)===r.uid&&s===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:r,kind:s}=i;if((t instanceof $e?t.uid:t)===r.uid&&e===s)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return Kn(function*(){if(!e.connection||e.state!==Bt.Connected||e.connection instanceof Ue)return;const i=yield St(e.mutex.lock("From P2PChannel.restartICE"));let r;try{r=yield St(e.connection.restartICE(t));const o=yield St(r.next());if(o.done)return;const a=o.value,c=yield a;switch(e.reportPCDisconnectedOrFailed(t),t){case nn.TCP:e._pcStatsUploadType=Ji.TCP_RESTART;break;case nn.RELAY:e._pcStatsUploadType=Ji.RELAY_RESTART;break;default:e._pcStatsUploadType=Ji.OLD_RESTART}e._isInRestartIce=!0,r.next(c)}catch(o){var s;(s=r)===null||s===void 0||s.throw(o)}finally{i()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(Y.LocalVideoTrack),i=this.localTrackMap.get(Y.LocalAudioTrack),r=t.videoSend.find(R=>R.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),s=t.audioSend.find(R=>R.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId));if(!r||!s)return 1;const o=Wn(this,lt.NeedSignalRTT),a=r?r.rttMs:void 0,c=s?s.rttMs:void 0,d=a&&c?(a+c)/2:a||c,u=(d&&o?(d+o)/2:d||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*u/1500,p=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,_=e==null?void 0:e.track;if(_&&_._encoderConfig&&_._hints.indexOf($t.SCREEN_TRACK)===-1){const R=_._encoderConfig.bitrateMax,f=t.bitrate.actualEncoded;if(R&&f){const T=(1e3*R-f)/(1e3*R);return YR[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i;const s=r._audioSSRC,o=r._videoSSRC,a=t.audioRecv.find(f=>f.ssrc===s),c=t.videoRecv.find(f=>f.ssrc===o);if(!a&&!c)return void(e+=1);const d=Wn(this,lt.NeedSignalRTT),u=t.rtt,l=(u&&d?(u+d)/2:u||d)||0,p=a?a.jitterMs:void 0,_=t.recvPacketLossRate;let R=.7*_*100/50+.3*l/1500;p&&(R=.6*_*100/50+.2*l/1500+.2*p/400),e+=R<.1?1:R<.17?2:R<.36?3:R<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new F((e,i)=>{this.handleMuteLocalTrack(t,e,i)})}filterTobePublishedTracks(t,e,i){const r=[],s=Kt(),o=this.getAllTracks();t=Vo(t=t.filter(d=>o.indexOf(d)===-1));let a=!1,c=!1;for(const d of t){if(d instanceof Ct&&(this.localTrackMap.has(Y.LocalVideoTrack)||a?new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:Y.LocalVideoTrack}),a=!0),e)){const u=this.getLowVideoTrack(d,i);r.push({track:u,type:Y.LocalVideoLowTrack})}if(d instanceof Vt){const u=this.localTrackMap.get(Y.LocalAudioTrack);if(u){if(!(u.track instanceof ve))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(c){const l=r.find(p=>{let{type:_}=p;return _===Y.LocalAudioTrack});if(!(l.track instanceof ve))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(d)}else{if(!s.webAudioMediaStreamDest||d instanceof ve||d._bypassWebAudio)r.push({track:d,type:Y.LocalAudioTrack});else{const l=new ve;l.addAudioTrack(d),r.push({track:l,type:Y.LocalAudioTrack})}c=!0}}}return r}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=Vo(t=t.filter(r=>i.indexOf(r)!==-1));for(const r of t){if(r instanceof Vt){const s=this.localTrackMap.get(Y.LocalAudioTrack);if(!s)continue;s.track instanceof ve?(s.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),s.track.trackList.length===0&&(e.push([Y.LocalAudioTrack,s]),s.track.close())):e.push([Y.LocalAudioTrack,s])}if(r instanceof Ct){const s=this.localTrackMap.get(Y.LocalVideoTrack);if(!s)continue;e.push([Y.LocalVideoTrack,s]);const o=this.localTrackMap.get(Y.LocalVideoLowTrack);o&&e.push([Y.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=Vo(t)).filter(e=>this.localDataChannels.findIndex(i=>i.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=Vo(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:r}=e;switch(r){case Y.LocalVideoTrack:i.addListener(tt.GET_STATS,this.handleGetLocalVideoStats),i.addListener(tt.GET_RTC_STATS,this.handleGetRTCStats),i.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(tt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(tt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.addListener(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Y.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case Y.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof ve?t.trackList.forEach(i=>{i.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(tt.GET_STATS,this.handleGetLocalAudioStats),i.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(tt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:r}]=e;return{track:r,type:i}})),t.forEach(e=>{let{track:i,type:r}=e;switch(r){case Y.LocalVideoTrack:i.off(tt.GET_STATS,this.handleGetLocalVideoStats),i.off(tt.GET_RTC_STATS,this.handleGetRTCStats),i.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(tt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(tt.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),i.off(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Y.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case Y.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof ve?t.trackList.forEach(e=>{e.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(tt.GET_STATS,this.handleGetLocalAudioStats),e.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(tt.GET_STATS,this.handleGetLocalAudioStats),t.off(tt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(tt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(tt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(tt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(tt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof ur&&e.addListener(tt.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof ki&&e.addListener(tt.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(tt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has(rt.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(rt.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,r)=>{var s;let o,a,{track:c,type:d}=i;switch(d){case Y.LocalAudioTrack:o=Ut.Audio,a={dtx:c instanceof $s&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Y.LocalVideoTrack:o=nt(s=c._hints).call(s,$t.SCREEN_TRACK)?Ut.Screen:Ut.High,a=gs(gs({},pC(c)),{},{codec:this.store.codec});break;case Y.LocalVideoLowTrack:o=Ut.Low,a=gs(gs({},pC(c)),{},{codec:this.store.codec})}return{stream_type:o,attributes:a,ssrcs:e[r]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}assignLocalTracks(t,e){t.forEach((i,r)=>{let{track:s,type:o}=i;this.localTrackMap.set(o,{track:s,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(lt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),O("NEW_ICE_RESTART")){var i;if(nt(i=this._restartStates).call(i,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const r=a=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(m.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(a)),Wn(this,lt.QueryClientConnectionState)==="CONNECTED"&&this.emit(lt.RequestRestartICE,a))},s=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),m.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(lt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},o=O("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(O("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Kt().supportPCSetConfiguration)r(nn.RELAY),this._restartTimer=window.setTimeout(s,o);else if(Jt())r(nn.UDP),this._restartTimer=window.setTimeout(s,4e3);else{if(r(nn.TCP),Kt().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{r(nn.RELAY),this._restartTimer=window.setTimeout(s,o)},o));this._restartTimer=window.setTimeout(s,o)}},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&O("ICE_RESTART")&&Wn(this,lt.QueryClientConnectionState)==="CONNECTED"&&this.emit(lt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(lt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(lt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),st.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:ce.TRACER}).onSuccess(),this.emit(lt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===e);var s;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(s=r.audioTrack)===null||s===void 0||s.emit(Xs.FIRST_FRAME_DECODED),st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_AUDIO_DECODE,ne.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===e);r&&st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_AUDIO_RECEIVED,ne.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,r)=>{this.reportVideoFirstFrameDecoded(e,i,r)},t.onFirstVideoReceived=e=>{var i;const r=Array.from($n(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===e);r&&st.firstRemoteFrame(this.store.sessionId,Pe.FIRST_VIDEO_RECEIVED,ne.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{const r=e.candidateType==="relay",s=i.candidateType==="relay";i.candidateType!=="unknown"&&r===s||this.emit(lt.ConnectionTypeChange,r),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ss(i))," -> ").concat(JSON.stringify(ss(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ss(i))," -> ").concat(JSON.stringify(ss(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const i=this.localTrackMap.get(Y.LocalAudioTrack);if(t instanceof Vt&&(i==null?void 0:i.track)instanceof ve)return i.track.isActive||e.push([Y.LocalAudioTrack,i]),e;const r=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:o}]=s;return t===o});if(r&&(e.push(r),r[0]===Y.LocalVideoTrack)){const s=this.localTrackMap.get(Y.LocalVideoLowTrack);s&&e.push([Y.LocalVideoLowTrack,s])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(Y.LocalAudioTrack);if(t instanceof Vt&&(i==null?void 0:i.track)instanceof ve)return i.track.isActive&&e.push([Y.LocalAudioTrack,i]),e;const r=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:o}]=s;return t===o});if(r)if(r[0]===Y.LocalVideoTrack){e.push(r);const s=this.localTrackMap.get(Y.LocalVideoLowTrack);s&&e.push([Y.LocalVideoLowTrack,s])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}createUnmuteMessage(t){return t.map(e=>{var i;let r,[s,{track:o,ssrcs:a,id:c}]=e;switch(s){case Y.LocalAudioTrack:r=Ut.Audio;break;case Y.LocalVideoTrack:r=nt(i=o._hints).call(i,$t.SCREEN_TRACK)?Ut.Screen:Ut.High;break;case Y.LocalVideoLowTrack:r=Ut.Low}return{stream_type:r,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(t,e){const i=[],r=this.remoteUserMap.get(t);if(!r)return i;if(e){const s=r.get(e);if(!s)return i;i.push([t,{kind:e,id:s}])}else Array.from(r.entries()).forEach(s=>{let[o,a]=s;i.push([t,{kind:o,id:a}])});return i}filterTobeUnSubscribedDataChannels(t,e){const i=[];return e.forEach(r=>{var s;(s=this.remoteDataChannelMap.get(t))!==null&&s!==void 0&&s.has(r.id)&&i.push(r)}),i}createUnsubscribeMessage(t){const e=[];return t.forEach(i=>{let[r,{kind:s,id:o}]=i;switch(s){case rt.VIDEO:return void(r._videoSSRC&&e.push({stream_type:rt.VIDEO,ssrcId:r._videoSSRC}));case rt.AUDIO:return void(r._audioSSRC&&e.push({stream_type:rt.AUDIO,ssrcId:r._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(i=>{let[r,{kind:s}]=i;if(e.has(r)){let o=e.get(r);s===rt.VIDEO?o|=be.Video:o|=be.Audio,e.set(r,o)}else s===rt.VIDEO?e.set(r,be.Video):e.set(r,be.Audio)}),{users:Array.from(e.entries()).map(i=>{let[r,s]=i;return{stream_id:r.uid,stream_type:s}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:r}]=e;const s=this.remoteUserMap.get(i);s&&(s.delete(r),Array.from(s.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(Y.LocalVideoTrack),i=this.localTrackMap.get(Y.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e){return t.map((i,r)=>{var s;let{stream_type:o}=i;return(s=e.find(a=>{let{stream_type:c}=a;return o===c}))===null||s===void 0?void 0:s.attributes})}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof Vt){var e;const r=this.filterTobeUnmutedTracks(t[i]);if(r.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(r.map(o=>{let[,{id:a}]=o;return a})));const s=this.createUnmuteMessage(r);return void await Xt(this,lt.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(lt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(lt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await We(xd(this.dtlsFailedCount,Ce)),this.emit(lt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await Se(this,lt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(lt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Y.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Ct)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Ct).length>1)throw new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Vt).length>1&&(t.some(e=>e instanceof Vt&&e._bypassWebAudio)||!Kt().webAudioMediaStreamDest))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Ct&&this.pendingLocalTracks.some(i=>i instanceof Ct))throw new G(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Vt&&this.pendingLocalTracks.some(i=>i instanceof Vt)&&(!Kt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof Vt&&i._bypassWebAudio)))throw new G(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=!O("DISABLE_DUAL_STREAM_USE_ENCODING")&&Kt().supportDualStreamEncoding,r=gs(gs({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():V_(t,r);const o=Qt(8,"track-low-"),a=new Ct(s,gs(gs({},i&&{scaleResolutionDownBy:Lp(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(Qo.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,os.LOW_STREAM)}),a._hints.push($t.LOW_STREAM),t.addListener(tt.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof pe){var s,o,a,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:u,dtlsTransportState:l,peerConnectionState:p}=this.connection,{local:_,remote:R}=await this.connection.getSelectedCandidatePair();st.pcStats(this.store.sessionId,{startTime:d,eventElapse:t-d||0,iceconnectionsate:u,dtlsstate:l,connectionstate:p,intSucc:e?1:2,error:r,selectedLocalCandidateProtocol:(s=_==null?void 0:_.protocol)!==null&&s!==void 0?s:"",selectedLocalCandidateType:(o=_.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(_.address,":").concat(_.port),selectedRemoteCandidateProtocol:(a=R.protocol)!==null&&a!==void 0?a:"",selectedRemoteCandidateType:(c=R.candidateType)!==null&&c!==void 0?c:"",selectedRemoteCandidateAddress:"".concat(R.address,":").concat(R.port),restartCnt:i})}}reportVideoFirstFrameDecoded(t,e,i,r){var s;const o=Array.from($n(s=this.remoteUserMap).call(s)).find(a=>a._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");st.firstRemoteVideoDecode(this.store.sessionId,Pe.FIRST_VIDEO_DECODE,ne.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:sn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.connection)return!1;const r=this.remoteUserMap.get(t);if(!r)return!1;const s=r.get(e);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return o!==void 0&&o!==i}resetConnection(t){m.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===Bt.Connected?(m.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===zd.datachannel?new Ue({},this.store):this.isPlanB?new qe({},this.store):new pe({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===Y.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,os.LOW_STREAM):i._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof pe&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Ji.TCP_RESTART&&t===nn.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Ji.DISCONNECTED_OR_FAILED)))}}function En(n,t,e){const i=n[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const r=this.mutex,s=await r.lock("From P2PChannel.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},e}function I2(n){let t=Xy();return function(e,i){let r=e.appId;r!==void 0&&(Ft(i,10),Er(i,r));let s=e.cid;s!==void 0&&(Ft(i,16),Ft(i,s));let o=e.cname;o!==void 0&&(Ft(i,26),Er(i,o));let a=e.deviceId;a!==void 0&&(Ft(i,34),Er(i,a));let c=e.elapse;c!==void 0&&(Ft(i,40),Ts(i,c));let d=e.fileSize;d!==void 0&&(Ft(i,48),Ts(i,la(d)));let u=e.height;u!==void 0&&(Ft(i,56),Ts(i,la(u)));let l=e.jpg;l!==void 0&&(Ft(i,66),Ft(i,l.length),function(qn,K){let X=ha(qn,K.length);qn.bytes.set(K,X)}(i,l));let p=e.networkType;p!==void 0&&(Ft(i,72),Ts(i,la(p)));let _=e.osType;_!==void 0&&(Ft(i,80),Ts(i,la(_)));let R=e.requestId;R!==void 0&&(Ft(i,90),Er(i,R));let f=e.sdkVersion;f!==void 0&&(Ft(i,98),Er(i,f));let T=e.sequence;T!==void 0&&(Ft(i,104),Ts(i,la(T)));let A=e.sid;A!==void 0&&(Ft(i,114),Er(i,A));let N=e.timestamp;N!==void 0&&(Ft(i,120),Ts(i,N));let P=e.uid;P!==void 0&&(Ft(i,128),Ft(i,P));let j=e.vid;j!==void 0&&(Ft(i,136),Ft(i,j));let M=e.width;M!==void 0&&(Ft(i,144),Ts(i,la(M)));let U=e.service;U!==void 0&&(Ft(i,152),Ft(i,U));let B=e.callbackData;B!==void 0&&(Ft(i,162),Er(i,B));let V=e.jpgEncryption;V!==void 0&&(Ft(i,168),Ft(i,V));let q=e.requestType;q!==void 0&&(Ft(i,176),Ft(i,q));let z=e.scorePorn;z!==void 0&&(Ft(i,185),q_(i,z));let mt=e.scoreSexy;mt!==void 0&&(Ft(i,193),q_(i,mt));let Rt=e.scoreNeutral;Rt!==void 0&&(Ft(i,201),q_(i,Rt));let te=e.scene;te!==void 0&&(Ft(i,208),Ft(i,te));let we=e.ossFilePrefix;we!==void 0&&(Ft(i,218),Er(i,we));let ie=e.serviceVendor;if(ie!==void 0)for(let qn of ie){Ft(i,226);let K=Xy();w2(qn,K),Ft(i,K.limit),P2(i,K),D2(K)}}(n,t),function(e){let i=e.bytes,r=e.limit;return i.length===r?i:i.subarray(0,r)}(t)}function A2(n){return function(e){let i={};t:for(;!Qy(e);){let r=fr(e);switch(r>>>3){case 0:break t;case 1:i.code=fr(e);break;case 2:i.msg=Zy(e,fr(e));break;case 3:{let s=O2(e);i.data=b2(e),e.limit=s;break}default:Jy(e,7&r)}}return i}({bytes:t=n,offset:0,limit:t.length});var t}function b2(n){let t={};t:for(;!Qy(n);){let e=fr(n);switch(e>>>3){case 0:break t;case 1:t.requestId=Zy(n,fr(n));break;case 2:t.requestType=fr(n)>>>0;break;case 3:t.scorePorn=Y_(n);break;case 4:t.scoreSexy=Y_(n);break;case 5:t.scoreNeutral=Y_(n);break;case 6:t.requestScene=fr(n)>>>0;break;case 7:t.scene=fr(n)>>>0;break;default:Jy(n,7&e)}}return t}function w2(n,t){let e=n.service;e!==void 0&&(Ft(t,8),Ft(t,e));let i=n.vendor;i!==void 0&&(Ft(t,16),Ft(t,i));let r=n.token;r!==void 0&&(Ft(t,26),Er(t,r));let s=n.callbackUrl;s!==void 0&&(Ft(t,34),Er(t,s))}function O2(n){let t=fr(n),e=n.limit;return n.limit=n.offset+t,e}function Jy(n,t){switch(t){case 0:for(;128&$y(n););break;case 2:H_(n,fr(n));break;case 5:H_(n,4);break;case 1:H_(n,8);break;default:throw new Error("Unimplemented type: "+t)}}W([En,S("design:type",Function),S("design:paramtypes",[Object,Boolean]),S("design:returntype",F)],Je.prototype,"startP2PConnection",null),W([En,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],Je.prototype,"connect",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",void 0)],Je.prototype,"updateRemoteRTPCapabilities",null),W([En,S("design:type",Function),S("design:paramtypes",[Object,Object,Array,Object,String,String]),S("design:returntype",F)],Je.prototype,"preConnect",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Je.prototype,"publishDataChannel",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Je.prototype,"unpublish",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Je.prototype,"unpublishDataChannel",null),W([En,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Je.prototype,"unpublishLowStream",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,Array]),S("design:returntype",F)],Je.prototype,"subscribeDataChannel",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String,Number,Number,Array]),S("design:returntype",F)],Je.prototype,"subscribe",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Je.prototype,"massSubscribe",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String,Boolean]),S("design:returntype",F)],Je.prototype,"unsubscribe",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,Array]),S("design:returntype",F)],Je.prototype,"unsubscribeDataChannel",null),W([En,S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Je.prototype,"massUnsubscribe",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Je.prototype,"muteRemote",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Je.prototype,"unmuteRemote",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String]),S("design:returntype",F)],Je.prototype,"hasRemoteMediaWithLock",null),W([En,S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Je.prototype,"disconnectForReconnect",null),W([En,S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Je.prototype,"updateBitrateLimit",null),W([En,S("design:type",Function),S("design:paramtypes",[$e,String,Number]),S("design:returntype",F)],Je.prototype,"remoteMediaSsrcChanged",null);let N2=new Float32Array(1);new Uint8Array(N2.buffer);let W_=new Float64Array(1),Fn=new Uint8Array(W_.buffer);function la(n){return{low:n|=0,high:n>>31,unsigned:n>=0}}let zy=[];function Xy(){const n=zy.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}function D2(n){zy.push(n)}function H_(n,t){if(n.offset+t>n.limit)throw new Error("Skip past limit");n.offset+=t}function Qy(n){return n.offset>=n.limit}function ha(n,t){let e=n.bytes,i=n.offset,r=n.limit,s=i+t;if(s>e.length){let o=new Uint8Array(2*s);o.set(e),n.bytes=o}return n.offset=s,s>r&&(n.limit=s),i}function K_(n,t){let e=n.offset;if(e+t>n.limit)throw new Error("Read past limit");return n.offset+=t,e}function Zy(n,t){let e=K_(n,t),i=String.fromCharCode,r=n.bytes,s="�",o="";for(let a=0;a<t;a++){let c,d,u,l,p=r[a+e];128&p?(224&p)==192?a+1>=t?o+=s:(c=r[a+e+1],(192&c)!=128?o+=s:(l=(31&p)<<6|63&c,l<128?o+=s:(o+=i(l),a++))):(240&p)==224?a+2>=t?o+=s:(c=r[a+e+1],d=r[a+e+2],(49344&(c|d<<8))!=32896?o+=s:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?o+=s:(o+=i(l),a+=2))):(248&p)==240?a+3>=t?o+=s:(c=r[a+e+1],d=r[a+e+2],u=r[a+e+3],(12632256&(c|d<<8|u<<16))!=8421504?o+=s:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?o+=s:(l-=65536,o+=i(55296+(l>>10),56320+(1023&l)),a+=3))):o+=s:o+=i(p)}return o}function Er(n,t){let e=t.length,i=0;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}Ft(n,i);let r=ha(n,i),s=n.bytes;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function P2(n,t){let e=ha(n,t.limit),i=n.bytes,r=t.bytes;for(let s=0,o=t.limit;s<o;s++)i[s+e]=r[s]}function $y(n){return n.bytes[K_(n,1)]}function tI(n,t){let e=ha(n,1);n.bytes[e]=t}function Y_(n){let t=K_(n,8),e=n.bytes;return Fn[0]=e[t++],Fn[1]=e[t++],Fn[2]=e[t++],Fn[3]=e[t++],Fn[4]=e[t++],Fn[5]=e[t++],Fn[6]=e[t++],Fn[7]=e[t++],W_[0]}function q_(n,t){let e=ha(n,8),i=n.bytes;W_[0]=t,i[e++]=Fn[0],i[e++]=Fn[1],i[e++]=Fn[2],i[e++]=Fn[3],i[e++]=Fn[4],i[e++]=Fn[5],i[e++]=Fn[6],i[e++]=Fn[7]}function fr(n){let t,e=0,i=0;do t=$y(n),e<32&&(i|=(127&t)<<e),e+=7;while(128&t);return i}function Ft(n,t){for(t>>>=0;t>=128;)tI(n,127&t|128),t>>>=7;tI(n,t)}function Ts(n,t){let e=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?e<16384?e<128?1:2:e<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=ha(n,s),a=n.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?e>>>21|128:e>>>21&127;case 3:a[o+2]=s!==3?e>>>14|128:e>>>14&127;case 2:a[o+1]=s!==2?e>>>7|128:e>>>7&127;case 1:a[o]=s!==1?128|e:127&e}}function eI(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}const L2=new Map([["moderation",1],["supervise",2]]);class Vu extends se{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(ke.CONNECTION_STATE_CHANGE,e,t)}get inspectType(){return this._inspectType}set inspectType(t){var e;this._inspectMode=Hs(e=t.map(i=>L2.get(i)||0)).call(e,(i,r)=>i+r),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),h(this,"name","AgoraRTCVideoContentInspect"),h(this,"_connectionState",ni.CONNECTING),h(this,"_innerConnectionState",void 0),h(this,"sequence",0),h(this,"inspectStartTime",void 0),h(this,"workerManagerConnection",void 0),h(this,"workerConnection",void 0),h(this,"workerMessageLengthLimit",void 0),h(this,"inspectIntervalMinimum",void 0),h(this,"qualityRatio",void 0),h(this,"_connectInfo",void 0),h(this,"_cancelTokenSource",Pn.CancelToken.source()),h(this,"_retryConfig",void 0),h(this,"wmSequence",0),h(this,"inspectInterval",void 0),h(this,"inspectTimer",null),h(this,"ossFilePrefix",void 0),h(this,"extraInfo",void 0),h(this,"_inspectType",void 0),h(this,"_inspectMode",void 0),h(this,"_quality",1),h(this,"qualityTimer",null),h(this,"_inspectId",void 0),h(this,"_needWorkUrlOnly",!1),h(this,"inspectImage",()=>{if(this.connectionState!==ni.CONNECTED)throw new k(v.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===ni.CONNECTED?this.requestToInspectImage():m.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Qt(5,"inspect-"),this.workerMessageLengthLimit=O("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=O("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=O("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new tc("worker-manager-"+this._inspectId,Ce),this.on(ke.STATE_CHANGE,(e,i)=>{this._innerConnectionState=e,m.debug("[".concat(this._inspectId,"] Inspect operation :").concat(ii[e]," ").concat(i||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new tc("worker-"+this._inspectId,Ce),this.handleWorkerEvents()}async init(t,e){this.emit(ke.STATE_CHANGE,ii.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new F((r,s)=>{this.on(ke.CONNECTION_STATE_CHANGE,(o,a)=>{a===ni.CONNECTED&&r()}),this.requestAP(t,i,e).then(o=>{this.connectWorkerManager(o)}).catch(o=>{s(o)})})}async requestAP(t,e,i){const r=O("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),s=await function(a,c,d,u){let{appId:l,areaCode:p,cname:_,sid:R,token:f,uid:T}=c;qo++;const A="image_moderation_api",N={service_name:A,json_body:JSON.stringify({appId:l,areaCode:p,cname:_,command:"allocateEdge",requestId:qo,seq:qo,sid:R,token:f,ts:Date.now(),uid:T+""})};let P,j,M=a[0];return Ki(async()=>{P=Date.now();const U=await wr(M,{data:N,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(j=Date.now()-P,U.code!==0){const z=new k(v.UNEXPECTED_RESPONSE,"image inspect ap error, code"+U.code,{retry:!0,responseTime:j});throw m.error(z.toString()),z}const B=JSON.parse(U.json_body);if(B.code!==200){const z=new k(v.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(B.code,", reason: ").concat(B.reason),{code:B.code,responseTime:j});throw m.error(z.toString()),z}if(!B.servers||!Array.isArray(B.servers)||B.servers.length===0){const z=new k(v.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:B.code,responseTime:j});throw m.error(z.toString()),z}const V=O("VIDEO_INSPECT_WORKER_MANAGER_HOST"),q=O("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:B.servers.map(z=>{let{address:mt,wss:Rt}=z;if(mt&&Rt)return"wss://".concat(mt.replace(/\./g,"-"),".").concat(V,":").concat(q||Rt)}).filter(z=>!!z),workerToken:B.workerToken,vid:B.vid,responseTime:j}},(U,B)=>(st.apworkerEvent(R,{success:!0,sc:200,serviceName:A,responseDetail:JSON.stringify(U.addressList),firstSuccess:B===0,responseTime:j,serverIp:a[B%a.length]}),!1),(U,B)=>(st.apworkerEvent(R,{success:!1,sc:U.data&&U.data.code||200,serviceName:A,responseTime:j,serverIp:a[B%a.length]}),!!(U.code!==v.OPERATION_ABORTED&&U.code!==v.UNEXPECTED_RESPONSE||U.data&&U.data.retry)&&(M=a[(B+1)%a.length],!0)),u)}(r,t,e,i);this.emit(ke.STATE_CHANGE,ii.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=e,this.emit(ke.STATE_CHANGE,ii.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(pt.CONNECTED,async()=>{this.emit(ke.STATE_CHANGE,ii.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(pt.CLOSED,()=>{this._innerConnectionState<ii.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(pt.FAILED,()=>{this._innerConnectionState<ii.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(pt.RECONNECTING,()=>{this._innerConnectionState<ii.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(pt.ON_MESSAGE,async t=>{this.emit(ke.STATE_CHANGE,ii.GET_WORKER_MANAGER_RESPONSE);const e=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(i.code!==200)throw m.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new k(v.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&e))throw m.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new k(v.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=O("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,s=e.replace(/:\d+\/?$/,":".concat(r));this.emit(ke.STATE_CHANGE,ii.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(ke.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}}),this.workerManagerConnection.on(pt.WILL_RECONNECT,(t,e,i)=>{i(t)}),this.workerManagerConnection.on(pt.REQUEST_NEW_URLS,(t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)})}handleWorkerEvents(){this.workerConnection.on(pt.CONNECTED,async()=>{this.emit(ke.STATE_CHANGE,ii.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=ni.CONNECTED}),this.workerConnection.on(pt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const i=A2(new Uint8Array(t.data));if(O("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&m.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(ke.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var e;const r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},s=Hs(e=Object.keys(r)).call(e,(a,c)=>r[a]>r[c]?a:c,"porn"),o=Object.keys(r).find(a=>a===s);this.emit(ke.INSPECT_RESULT,o)}else this.emit(ke.INSPECT_RESULT,void 0,new k(v.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(ke.INSPECT_RESULT,void 0,new k(v.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else m.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ke.INSPECT_RESULT,void 0,new k(v.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(pt.CLOSED,()=>{this.connectionState=ni.CLOSED}),this.workerConnection.on(pt.FAILED,()=>{this.connectionState=ni.CLOSED}),this.workerConnection.on(pt.RECONNECTING,()=>{this.connectionState=this.connectionState===ni.CONNECTED?ni.RECONNECTING:ni.CONNECTING}),this.workerConnection.on(pt.WILL_RECONNECT,(t,e,i)=>{t==="recover"&&i(t),i("tryNext")}),this.workerConnection.on(pt.REQUEST_NEW_URLS,(t,e)=>{this.workerManagerConnection.close(),this.once(ke.REQUEST_NEW_WORKER_URL,i=>{t([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{e(i)})})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;const t=Wn(this,ke.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(ke.INSPECT_RESULT,void 0,new k(v.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,e);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(ke.INSPECT_RESULT,void 0,new k(v.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,e){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=e;const d=Date.now(),u=await t.getCurrentFrameImage("image/jpeg",this.quality),l=await dv(u,i,r),p=this.sequence+"-"+s+"-"+c+"-"+d+"-"+Qt(12,""),_={appId:i,cid:s,cname:r,deviceId:"",elapse:Vu.intToLong(Number(d-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:u.height,width:u.width,jpg:l,networkType:6,osType:7,requestId:p,sdkVersion:"4.20.0",sequence:this.sequence,sid:a,timestamp:Vu.intToLong(d),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete _.callbackData,this.ossFilePrefix===void 0&&delete _.ossFilePrefix;const R=I2(_);if(R.byteLength<this.workerMessageLengthLimit){if(O("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const f=function(T){for(var A=1;A<arguments.length;A++){var N=arguments[A]!=null?arguments[A]:{};A%2?eI(Object(N),!0).forEach(function(P){h(T,P,N[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(N)):eI(Object(N)).forEach(function(P){Object.defineProperty(T,P,Object.getOwnPropertyDescriptor(N,P))})}return T}({},_);delete f.jpg,m.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return R}{const f=this.quality*this.qualityRatio;return this.quality=f,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Pn.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=ni.CLOSED,this.emit(ke.STATE_CHANGE,ii.CLOSED)}}function k2(n){let t=function(){const e=x2.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,i){let r=e.appId;r!==void 0&&(Te(i,10),Ss(i,r));let s=e.cid;s!==void 0&&(Te(i,16),Te(i,s));let o=e.cname;o!==void 0&&(Te(i,26),Ss(i,o));let a=e.deviceId;a!==void 0&&(Te(i,34),Ss(i,a));let c=e.elapse;c!==void 0&&(Te(i,40),Rs(i,c));let d=e.fileSize;d!==void 0&&(Te(i,48),Rs(i,pa(d)));let u=e.height;u!==void 0&&(Te(i,56),Rs(i,pa(u)));let l=e.jpg;l!==void 0&&(Te(i,66),Te(i,l.length),iI(i,l));let p=e.networkType;p!==void 0&&(Te(i,72),Rs(i,pa(p)));let _=e.osType;_!==void 0&&(Te(i,80),Rs(i,pa(_)));let R=e.requestId;R!==void 0&&(Te(i,90),Ss(i,R));let f=e.sdkVersion;f!==void 0&&(Te(i,98),Ss(i,f));let T=e.sequence;T!==void 0&&(Te(i,104),Rs(i,pa(T)));let A=e.sid;A!==void 0&&(Te(i,114),Ss(i,A));let N=e.timestamp;N!==void 0&&(Te(i,120),Rs(i,N));let P=e.uid;P!==void 0&&(Te(i,128),Te(i,P));let j=e.vid;j!==void 0&&(Te(i,136),Te(i,j));let M=e.width;M!==void 0&&(Te(i,144),Rs(i,pa(M)));let U=e.service;U!==void 0&&(Te(i,152),Te(i,U));let B=e.callbackData;B!==void 0&&(Te(i,162),Te(i,B.length),iI(i,B));let V=e.ticket;V!==void 0&&(Te(i,170),Ss(i,V));let q=e.vendorConfigs;q!==void 0&&(Te(i,178),Ss(i,q))}(n,t),function(e){let i=e.bytes,r=e.limit;return i.length===r?i:i.subarray(0,r)}(t)}function M2(n){return function(e){let i={};t:for(;!V2(e);){let r=wc(e);switch(r>>>3){case 0:break t;case 1:i.code=wc(e);break;case 2:i.msg=rI(e,wc(e));break;case 3:i.requestId=rI(e,wc(e));break;case 4:i.timestamp=F2(e,!1);break;default:U2(e,7&r)}}return i}({bytes:t=n,offset:0,limit:t.length});var t}function U2(n,t){switch(t){case 0:for(;128&Bi(n););break;case 2:J_(n,wc(n));break;case 5:J_(n,4);break;case 1:J_(n,8);break;default:throw new Error("Unimplemented type: "+t)}}function pa(n){return{low:n|=0,high:n>>31,unsigned:n>=0}}let x2=[];function J_(n,t){if(n.offset+t>n.limit)throw new Error("Skip past limit");n.offset+=t}function V2(n){return n.offset>=n.limit}function Fu(n,t){let e=n.bytes,i=n.offset,r=n.limit,s=i+t;if(s>e.length){let o=new Uint8Array(2*s);o.set(e),n.bytes=o}return n.offset=s,s>r&&(n.limit=s),i}function nI(n,t){let e=n.offset;if(e+t>n.limit)throw new Error("Read past limit");return n.offset+=t,e}function iI(n,t){let e=Fu(n,t.length);n.bytes.set(t,e)}function rI(n,t){let e=nI(n,t),i=String.fromCharCode,r=n.bytes,s="�",o="";for(let a=0;a<t;a++){let c,d,u,l,p=r[a+e];128&p?(224&p)==192?a+1>=t?o+=s:(c=r[a+e+1],(192&c)!=128?o+=s:(l=(31&p)<<6|63&c,l<128?o+=s:(o+=i(l),a++))):(240&p)==224?a+2>=t?o+=s:(c=r[a+e+1],d=r[a+e+2],(49344&(c|d<<8))!=32896?o+=s:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?o+=s:(o+=i(l),a+=2))):(248&p)==240?a+3>=t?o+=s:(c=r[a+e+1],d=r[a+e+2],u=r[a+e+3],(12632256&(c|d<<8|u<<16))!=8421504?o+=s:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?o+=s:(l-=65536,o+=i(55296+(l>>10),56320+(1023&l)),a+=3))):o+=s:o+=i(p)}return o}function Ss(n,t){let e=t.length,i=0;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}Te(n,i);let r=Fu(n,i),s=n.bytes;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function Bi(n){return n.bytes[nI(n,1)]}function sI(n,t){let e=Fu(n,1);n.bytes[e]=t}function wc(n){let t,e=0,i=0;do t=Bi(n),e<32&&(i|=(127&t)<<e),e+=7;while(128&t);return i}function Te(n,t){for(t>>>=0;t>=128;)sI(n,127&t|128),t>>>=7;sI(n,t)}function F2(n,t){let e,i=0,r=0,s=0;return e=Bi(n),i=127&e,128&e&&(e=Bi(n),i|=(127&e)<<7,128&e&&(e=Bi(n),i|=(127&e)<<14,128&e&&(e=Bi(n),i|=(127&e)<<21,128&e&&(e=Bi(n),r=127&e,128&e&&(e=Bi(n),r|=(127&e)<<7,128&e&&(e=Bi(n),r|=(127&e)<<14,128&e&&(e=Bi(n),r|=(127&e)<<21,128&e&&(e=Bi(n),s=127&e,128&e&&(e=Bi(n),s|=(127&e)<<7))))))))),{low:i|r<<28,high:r>>>4|s<<24,unsigned:t}}function Rs(n,t){let e=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?e<16384?e<128?1:2:e<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=Fu(n,s),a=n.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?e>>>21|128:e>>>21&127;case 3:a[o+2]=s!==3?e>>>14|128:e>>>14&127;case 2:a[o+1]=s!==2?e>>>7|128:e>>>7&127;case 1:a[o]=s!==1?128|e:127&e}}const oI={},aI={},Bu=4294967296,cI=Bu*Bu,dI=cI/2,z_=lI(0,!0),uI=lI(0),B2=_a(0,-2147483648,!1),j2=_a(-1,2147483647,!1),G2=_a(-1,-1,!0);function lI(n,t){let e,i,r;return t?(r=0<=(n>>>=0)&&n<256)&&(i=aI[n],i)?i:(e=_a(n,0,!0),r&&(aI[n]=e),e):(r=-128<=(n|=0)&&n<128)&&(i=oI[n],i)?i:(e=_a(n,n<0?-1:0,!1),r&&(oI[n]=e),e)}function _a(n,t,e){return{low:0|n,high:0|t,unsigned:!!e}}function W2(n,t){if(isNaN(n))return t?z_:uI;if(t){if(n<0)return z_;if(n>=cI)return G2}else{if(n<=-dI)return B2;if(n+1>=dI)return j2}return n<0?t?z_:uI:_a(n%Bu|0,n/Bu|0,t)}function hI(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}class X_ extends se{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(Ti.CONNECTION_STATE_CHANGE,t,e)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var e;super(),h(this,"name","AgoraRTCImageModeration"),h(this,"_connectionState",Hn.CONNECTING),h(this,"_sequence",0),h(this,"_moderationStartTime",void 0),h(this,"_workerConnection",void 0),h(this,"_workerMessageLengthLimit",void 0),h(this,"_qualityRatio",void 0),h(this,"_connectInfo",void 0),h(this,"_cancelTokenSource",Pn.CancelToken.source()),h(this,"_retryConfig",void 0),h(this,"_moderationInterval",void 0),h(this,"_moderationTimer",null),h(this,"_moderationMode",1),h(this,"_quality",1),h(this,"_qualityTimer",null),h(this,"_ticket",void 0),h(this,"_moderationIntervalMinimum",void 0),h(this,"_uploadFailedNum",0),h(this,"_uploadNum",0),h(this,"_uploadTimer",null),h(this,"_extraInfo",void 0),h(this,"_vendor",""),h(this,"_encoder",new TextEncoder),h(this,"_moderationId",void 0),h(this,"inspectImage",()=>{if(this.connectionState!==Hn.CONNECTED)throw new k(v.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Hn.CONNECTED?this.requestToInspectImage():m.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Qt(5,"image-moderation-"),this._workerMessageLengthLimit=O("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=O("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(e=t.interval)!==null&&e!==void 0?e:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=O("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new tc("worker-"+this._moderationId,Ce),this.on(Ti.STATE_CHANGE,(i,r)=>{m.debug("[".concat(this._moderationId,"] Moderation operation :").concat(ns[i]," ").concat(r||""))}),this.handleWorkerEvents()}async init(t,e){this.emit(Ti.STATE_CHANGE,ns.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new F((r,s)=>{this.on(Ti.CONNECTION_STATE_CHANGE,(o,a)=>{o===Hn.CONNECTED&&r()}),this.requestAP(t,i,e).then(o=>{this.connectWorker(o)}).catch(o=>{s(o)})})}updateConfig(t){var e;this._moderationInterval=(e=t.interval)!==null&&e!==void 0?e:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),m.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===Hn.CONNECTED&&this.inspectImage()}async requestAP(t,e,i){const r=O("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),s=await function(c,d,u,l){let{appId:p,areaCode:_,cname:R,sid:f,token:T,uid:A}=d;qo++;const N="moderation_plugin",P={service_name:N,json_body:JSON.stringify({appId:p,areaCode:_,cname:R,command:"allocateEdge",requestId:qo,seq:qo,sid:f,appToken:T,ts:Date.now(),uid:A+""})};let j,M,U=c[0];return Ki(async()=>{j=Date.now();const B=await wr(U,{data:P,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(M=Date.now()-j,B.code!==0){const z=new k(v.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+B.code,{retry:!0,responseTime:M});throw m.error(z.toString()),z}const V=JSON.parse(B.json_body);if(V.code!==200){const z=new k(v.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(V.code,", reason: ").concat(V.reason),{code:V.code,responseTime:M});throw m.error(z.toString()),z}if(!V.servers||!Array.isArray(V.servers)||V.servers.length===0){const z=new k(v.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:V.code,responseTime:M});throw m.error(z.toString()),z}if(!V.servers.some(z=>!!z.wss)){const z=new k(v.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:V.code,responseTime:M});throw m.error(z.toString()),z}const q=O("IMAGE_MODERATION_WORKER_HOST");return{addressList:V.servers.map(z=>{let{address:mt,wss:Rt}=z;if(mt&&Rt)return"wss://".concat(mt.replace(/\./g,"-"),".").concat(q,":").concat(Rt,"/moderation")}).filter(z=>!!z),workerToken:V.workerToken,vid:V.vid,ticket:V.appTicket,responseTime:M}},(B,V)=>(st.apworkerEvent(f,{success:!0,sc:200,serviceName:N,responseDetail:JSON.stringify(B.addressList),firstSuccess:V===0,responseTime:M,serverIp:c[V%c.length]}),!1),(B,V)=>(st.apworkerEvent(f,{success:!1,sc:B.data&&B.data.code||200,serviceName:N,responseTime:M,serverIp:c[V%c.length]}),!!(B.code!==v.OPERATION_ABORTED&&B.code!==v.UNEXPECTED_RESPONSE||B.data&&B.data.retry)&&(U=c[(V+1)%c.length],!0)),l)}(r,t,e,i);this.emit(Ti.STATE_CHANGE,ns.AP_CONNECTED);const{addressList:o,ticket:a}=s;return this._ticket=a,o}async connectWorker(t){this.emit(Ti.STATE_CHANGE,ns.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(pt.CONNECTED,async()=>{this.emit(Ti.STATE_CHANGE,ns.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Hn.CONNECTED}),this._workerConnection.on(pt.CLOSED,()=>{this.connectionState=Hn.CLOSED}),this._workerConnection.on(pt.FAILED,()=>{this.connectionState=Hn.CLOSED}),this._workerConnection.on(pt.RECONNECTING,()=>{this.connectionState=this.connectionState===Hn.CONNECTED?Hn.RECONNECTING:Hn.CONNECTING}),this._workerConnection.on(pt.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const e=M2(new Uint8Array(t.data));O("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(e)),this._uploadNum++,e.code===void 0||e.code===0||(this._uploadFailedNum++,m.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(e.code,", msg is ").concat(e.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{st.reportApiInvoke(this._connectInfo.sid||null,{name:Ae.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,e.code],tag:ce.TRACER}).onError(new k(v.IMAGE_MODERATION_UPLOAD_FAILED,e.msg)),this._uploadTimer=null},O("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else m.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(pt.WILL_RECONNECT,(t,e,i)=>{t==="recover"&&i(t),i("tryNext")}),this._workerConnection.on(pt.REQUEST_NEW_URLS,(t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=Wn(this,Ti.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(O("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,e);this._workerConnection.sendMessage(i,!0,!0)}else O("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("Only the track being published can be inspected")}async generateRequestData(t,e){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=e;const d=Date.now(),u=await t.getCurrentFrameImage("image/jpeg",this.quality),l=await dv(u,i,r),p=this._sequence+"-"+s+"-"+c+"-"+d+"-"+Qt(12,""),_={appId:i,cid:s,cname:r,deviceId:"",elapse:X_.intToLong(Number(d-this._moderationStartTime)),fileSize:u.buffer.byteLength,height:u.height,width:u.width,jpg:l,networkType:6,osType:7,requestId:p,sdkVersion:"4.20.0",sequence:this._sequence,sid:a,timestamp:W2(d),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete _.callbackData;const R=k2(_);if(R.byteLength<this._workerMessageLengthLimit){if(O("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const f=function(T){for(var A=1;A<arguments.length;A++){var N=arguments[A]!=null?arguments[A]:{};A%2?hI(Object(N),!0).forEach(function(P){h(T,P,N[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(N)):hI(Object(N)).forEach(function(P){Object.defineProperty(T,P,Object.getOwnPropertyDescriptor(N,P))})}return T}({},_);delete f.jpg,m.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(f))}return R}{const f=this.quality*this._qualityRatio;return this.quality=f,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Pn.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Hn.CLOSED,this.emit(Ti.STATE_CHANGE,ns.CLOSED)}}function pI(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function _I(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?pI(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):pI(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}const H2=Date.now(),K2=20,Q_=new Map,ju=new Map;async function mI(n){const t=Q_.get(n),e=Array.isArray(t)&&t[t.length-1],i=ju.get(n);if(!e)return void(i.isSyncing=!1);const r={uid:e.uid,payload:kd(e.payload)};i.firstRecvTs===0&&(i.firstRecvTs=e.recvTs,i.firstSendTs=e.sendTs);const s=e.sendTs-i.firstSendTs,o=s-(Date.now()-i.firstRecvTs);o>0&&(i.firstRecvTs=Date.now()-s);let a=e.mediaDelay+o;a<=0?(t.pop(),EI(e.context,r),a=0):a=Math.min(a,K2),setTimeout(()=>t.length&&mI(n),a)}function EI(n,t){n.safeEmit(Nt.STREAM_MESSAGE,t.uid,t.payload),n.onStreamMessage&&n.onStreamMessage(t)}function Y2(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=arguments.length>2?arguments[2]:void 0;if(!n.syncWithAudio)return EI(e,{uid:n.uid,payload:kd(n.payload)});const i="".concat(e.id,"-").concat(n.uid),r=Q_.get(i)||[],s=r.findIndex(d=>n.sendTs>=d.sendTs),o=_I(_I({},n),{},{context:e,mediaDelay:t,recvTs:Date.now()});s===-1?r.push(o):r.splice(s,0,o),Q_.set(i,r);let a=!1;var c;ju.has(i)?a=!((c=ju.get(i))===null||c===void 0||!c.isSyncing):ju.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||mI(i)}const q2=Lt().name;function J2(){return!function(n,t,e){const i=Lt();if(i.os!==Ne.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return e?t&&Number(r[0])===n&&Number(r[1])<t||Number(r[0])<n:t?Number(r[0])===n&&Number(r[1])<=t||Number(r[0])<n:Number(r[0])<=n}(16,0,!0)&&!function(n,t,e){const i=Lt();if(i.name!==xt.SAFARI||!i.osVersion)return!1;const r=i.version.split(".");return e?t&&Number(r[0])===n&&Number(r[1])<t||Number(r[0])<n:t?Number(r[0])===n&&Number(r[1])<=t||Number(r[0])<n:Number(r[0])<=n}(16,0,!0)}function fI(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function Ur(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?fI(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):fI(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}He.setLogger(m);class Gt extends se{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),h(this,"store",void 0),h(this,"_uid",void 0),h(this,"_channelName",void 0),h(this,"_uintUid",void 0),h(this,"_users",[]),h(this,"_config",void 0),h(this,"_clientId",void 0),h(this,"_appId",void 0),h(this,"_sessionId",null),h(this,"_key",void 0),h(this,"_rtmConfig",{}),h(this,"_joinInfo",void 0),h(this,"_gateway",void 0),h(this,"_statsCollector",void 0),h(this,"_configDistribute",void 0),h(this,"_leaveMutex",new He("client-leave")),h(this,"_publishMutex",new He("client-publish")),h(this,"_renewTokenMutex",new He("client-renewtoken")),h(this,"_subscribeMutex",new He("client-subscribe")),h(this,"_encryptionMode","none"),h(this,"_encryptionSecret",null),h(this,"_encryptionSalt",null),h(this,"_proxyServer",void 0),h(this,"_turnServer",{servers:[],mode:"auto"}),h(this,"_cloudProxyServerMode","disabled"),h(this,"_isDualStreamEnabled",!1),h(this,"_defaultStreamFallbackType",void 0),h(this,"_lowStreamParameter",void 0),h(this,"_streamFallbackTypeCacheMap",new Map),h(this,"_remoteStreamTypeCacheMap",new Map),h(this,"_axiosCancelSource",Pn.CancelToken.source()),h(this,"_audioVolumeIndicationInterval",void 0),h(this,"_networkQualityInterval",void 0),h(this,"_userOfflineTimeout",void 0),h(this,"_streamRemovedTimeout",void 0),h(this,"_injectStreamingClient",void 0),h(this,"_liveTranscodeStreamingClient",void 0),h(this,"_liveRawStreamingClient",void 0),h(this,"_channelMediaRelayClient",void 0),h(this,"_networkQualitySensitivity","normal"),h(this,"_p2pChannel",void 0),h(this,"_useLocalAccessPoint",!1),h(this,"_setLocalAPVersion",void 0),h(this,"_joinAndNotLeaveYet",!1),h(this,"_numberOfJoinCount",0),h(this,"_remoteDefaultVideoStreamType",void 0),h(this,"_inspect",void 0),h(this,"_moderation",void 0),h(this,"_license",void 0),h(this,"_pendingPublishedUsers",[]),h(this,"ntpAlignErrorCount",0),h(this,"remoteInboundOffset",0),h(this,"_handleLocalTrackEnable",(i,r,s)=>{this.publish(i,!1).then(r).catch(s)}),h(this,"_handleLocalTrackDisable",(i,r,s)=>{this.unpublish(i).then(r).catch(s)}),h(this,"_handleUserOnline",i=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(i.uid,this.channelName))return void m.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&typeof i.uid!="string"&&m.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const r=this._users.find(s=>s.uid===i.uid);if(r)r._trust_in_room_=!0,r._is_pre_created&&(r._is_pre_created=!1,this.safeEmit(Nt.USER_JOINED,r));else{const s=new $e(i.uid,i.uint_id||i.uid);this._users.push(s),m.debug("[".concat(this._clientId,"] user online"),i.uid),this.safeEmit(Nt.USER_JOINED,s)}}),h(this,"_handleUserOffline",i=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(i.uid,this.channelName))return;const r=this._users.find(s=>s.uid===i.uid);r&&(this._handleRemoveStream(i),this._handleRemoveDataChannels(i),r._audio_pre_subscribed||r._video_pre_subscribed?r._is_pre_created=!0:Pd(this._users,r),this._remoteStreamTypeCacheMap.delete(r.uid),this._streamFallbackTypeCacheMap.delete(r.uid),m.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.safeEmit(Nt.USER_LEAVED,r,i.reason))}),h(this,"_handleAddAudioOrVideoStream",(i,r,s,o,a,c,d)=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(r,this.channelName))return;const u=this._users.find(p=>p.uid===r);if(!u)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));m.debug("[".concat(this._clientId,"] stream added with uid ").concat(r,", type ").concat(i)),this.store.subscribe(u.uid,i,void 0,void 0,void 0,Date.now());const l=i==="audio"?u.hasAudio:u.hasVideo;u._uintid||(u._uintid=a||r),i==="audio"?u._trust_audio_stream_added_state_=!0:u._trust_video_stream_added_state_=!0,i==="audio"?(u._audio_added_=!0,s!==void 0&&(u._audioSSRC=s),o!==void 0&&(u._cname=o),c&&(u._audioOrtc=c)):(u._video_added_=!0,s!==void 0&&(u._videoSSRC=s),o!==void 0&&(u._cname=o),d!==void 0&&(u._rtxSsrcId=d),c&&(u._videoOrtc=c)),(i==="audio"?u.hasAudio:u.hasVideo)&&!l&&(m.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published ").concat(i)),this.safeEmit(Nt.USER_PUBLISHED,u,i)),i==="video"?st.onGatewayStream(this._sessionId,Pe.ON_ADD_VIDEO_STREAM,ne.ON_ADD_VIDEO_STREAM,{peer:a||r,ssrc:u._videoSSRC}):st.onGatewayStream(this._sessionId,Pe.ON_ADD_AUDIO_STREAM,ne.ON_ADD_AUDIO_STREAM,{peer:a||r,ssrc:u._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(u,i,s).then(p=>{if(p&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(u.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Je))return this._p2pChannel.unsubscribe(u,i,!0).then(()=>this._subscribe(u,i,!0).catch(_=>{m.error("[".concat(this._clientId,"] resubscribe error"),_.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(u,i)&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(u.uid," after reconnect.")),this._subscribe(u,i,!0).catch(p=>{m.error("[".concat(this._clientId,"] resubscribe error"),p.toString())}))}),h(this,"_handleRemoveStream",i=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(i.uid,this.channelName))return;const r=this._users.find(o=>o.uid===i.uid);if(!r)return void m.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));m.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let s=()=>{};r.hasAudio&&r.hasVideo?s=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished audio track")),this.safeEmit(Nt.USER_UNPUBLISHED,r,"audio"),m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished video track")),this.safeEmit(Nt.USER_UNPUBLISHED,r,"video")}:r.hasVideo?s=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished video track")),this.safeEmit(Nt.USER_UNPUBLISHED,r,"video")}:r.hasAudio&&(s=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished audio track")),this.safeEmit(Nt.USER_UNPUBLISHED,r,"audio")}),r._video_pre_subscribed||r._audio_pre_subscribed||(r._trust_audio_stream_added_state_=!0,r._trust_video_stream_added_state_=!0,r._audio_added_=!1,r._video_added_=!1,this._p2pChannel instanceof Je&&this._p2pChannel.unsubscribe(r).then(o=>{if(o)return this._gateway.unsubscribe(o,r.uid)}),r._audioSSRC=void 0,r._videoSSRC=void 0,r._audioOrtc=void 0,r._videoOrtc=void 0,r._rtxSsrcId=void 0),st.onGatewayStream(this._sessionId,Pe.ON_REMOVE_STREAM,ne.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),s()}),h(this,"_handleSetStreamLocalEnable",(i,r,s)=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(r,this.channelName))return;const o=this._users.find(d=>d.uid===r);if(!o)return void m.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));m.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(s?"enabled":"disabled"," with uid ").concat(r));const a=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_enabled_state_=!0;const d=o._audio_enabled_;if(o._audio_enabled_=s,o._audio_enabled_===d)return;{const u=o._audio_enabled_?"enable-local-audio":"disable-local-audio";m.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(Nt.USER_INFO_UPDATED,r,u)}}else{o._trust_video_enabled_state_=!0;const d=o._video_enabled_;if(o._video_enabled_=s,o._video_enabled_===d)return;{const u=o._video_enabled_?"enable-local-video":"disable-local-video";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(Nt.USER_INFO_UPDATED,r,u)}}const c=i==="audio"?o.hasAudio:o.hasVideo;return a!==c?!a&&c?(m.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(i)),void this.safeEmit(Nt.USER_PUBLISHED,o,i)):(i==="video"&&o._videoTrack&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),m.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(i)),void this.safeEmit(Nt.USER_UNPUBLISHED,o,i)):void 0}),h(this,"_handleMuteStream",(i,r,s)=>{if(O("BLOCK_LOCAL_CLIENT")&&Ys(i,this.channelName))return;m.debug("[".concat(this._clientId,"] receive mute message"),i,r,s);const o=this._users.find(d=>d.uid===i);if(!o)return void m.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));const a=r==="audio"?o.hasAudio:o.hasVideo;if(r==="audio"){o._trust_audio_mute_state_=!0;const d=o._audio_muted_;if(o._audio_muted_=s,o._audio_muted_===d)return;{const u=o._audio_muted_?"mute-audio":"unmute-audio";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(u)),this.safeEmit(Nt.USER_INFO_UPDATED,i,u)}}else{o._trust_video_mute_state_=!0;const d=o._video_muted_;if(o._video_muted_=s,o._video_muted_===d)return;{const u=o._video_muted_?"mute-video":"unmute-video";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(u)),this.safeEmit(Nt.USER_INFO_UPDATED,i,u)}}const c=r==="audio"?o.hasAudio:o.hasVideo;if(a!==c){if(!a&&c)return(r==="audio"?o._audioSSRC:o._videoSSRC)?(m.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(r)),void this.safeEmit(Nt.USER_PUBLISHED,o,r)):void m.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(r," unmute message  before add stream message, ").concat(r," SSRC doesn't exist yet."));r==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),r==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,r),m.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(r)),this.safeEmit(Nt.USER_UNPUBLISHED,o,r)}}),h(this,"_handleP2PLost",async i=>{m.debug("[".concat(this._clientId,"] receive p2p lost"),i),parseInt(i.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():m.warning("[".concat(this._clientId,"] P2PLost stream not found"),i)}),h(this,"_handleTokenWillExpire",()=>{m.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Nt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),h(this,"_handleBeforeUnload",i=>{i.type==="beforeunload"&&i.returnValue!==void 0&&i.returnValue!==""||(this.leave(),m.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),h(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Nt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Nt.NETWORK_QUALITY,i)}),h(this,"_handleP2PAddAudioOrVideoStream",(i,r,s,o)=>{const a=this._users.find(d=>d.uid===r);if(!a)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));m.debug("[".concat(this._clientId,"] stream added with uid ").concat(r,", type ").concat(i)),this.store.subscribe(a.uid,i,void 0,void 0,void 0,Date.now());const c=i==="audio"?a.hasAudio:a.hasVideo;i==="audio"?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,i==="audio"?(a._audio_added_=!0,s!==void 0&&(a._audioSSRC=s),o!==void 0&&(a._audioMid=o)):(a._video_added_=!0,s!==void 0&&(a._videoSSRC=s),o!==void 0&&(a._videoMid=o)),(i==="audio"?a.hasAudio:a.hasVideo)&&!c&&(m.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(i)),this.safeEmit(Nt.USER_PUBLISHED,a,i)),this._p2pChannel.hasPendingRemoteMedia(a,i)&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,i,!0).catch(d=>{m.error("[".concat(this._clientId,"] resubscribe error"),d.toString())}))}),this._config=t,this._clientId=Qt(5,"client-"),this.store=new G1(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),m.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(fi," build: ").concat(gp,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{LS(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(i){m.warning("[".concat(this._clientId,"] ").concat(i.toString()))}this._statsCollector=new Ic(this.store),this._statsCollector.onStatsException=(i,r,s)=>{m.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(r,", uid: ").concat(s)),this.safeEmit(Nt.EXCEPTION,{code:i,msg:r,uid:s})},this._statsCollector.onUploadPublishDuration=(i,r,s,o)=>{const a=this._users.find(c=>c.uid===i);a&&st.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:r,videoPublishDuration:s,peer:a._uintid})},this.store.useDataChannel=Kt().supportDataChannel&&O("SIGNAL_CHANNEL"),this.store.useP2P=t.mode==="p2p",this._gateway=new yM(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Ce,httpRetryConfig:t.httpRetryConfig||Ce,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new LM,this.store.useP2P?(this._p2pChannel=new Me(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Je(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,i,r,s){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],a=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Ht("JOIN_GATEWAY_USE_443PORT_ONLY",o),Ht("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const c=this._gateway.signal.websocket;return c instanceof $a&&(c.use443PortOnly=o,c.tryDoubleDomain=a),async function(d,u,l){Ad.get(d)||Ad.set(d,[]),bd.get(d)||bd.set(d,u),rr.get(d)||rr.set(d,0);const p=Ad.get(d),_=bd.get(d);if(!p||!_)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(rr.get(d)===_){const N=Ha();p.push(N),await N.promise}rr.set(d,rr.get(d)+1);for(var R=arguments.length,f=new Array(R>3?R-3:0),T=3;T<R;T++)f[T-3]=arguments[T];const A=await l(...f);return rr.set(d,rr.get(d)-1),rr.get(d)===_-1&&p.length>0&&(p[0].resolve(),p.shift()),rr.get(d)===0&&(Ad.set(d,[]),bd.set(d,0),rr.set(d,0)),A}("client.join",O("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,i,r,s)}async join(t,e,i,r,s){const o=++this._numberOfJoinCount;this.store.joinStart(),r&&(this.store.uid=r);const a=j1(),c=xR()?window.isSecureContext:"Browser Not Support";if(!xR()&&!a||!window.isSecureContext){const f="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";m.warning(f)}const d=zh();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),m.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const u=st.reportApiInvoke(d,{name:Ae.JOIN,options:[t,e,i,r],states:{isHttps:a,isSecureContext:c},tag:ce.TRACER});st.setAppId(t);try{if(!i&&i!==null)throw new k(v.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&en(i,"token",1,2047),en(t,"appid",1,2047),Cp(e),r&&vp(r),s&&en(s,"optionalInfo",1,2047)}catch(f){throw u.onError(f),f}if(m.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(m.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),m.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const f=new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw u.onError(f),f}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=Ur(Ur({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof r!="string"?r:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:s,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),typeof r=="string"&&(l.stringUid=r,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await Xk(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:e,appId:t,stringUid:l.stringUid});const p=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&p===this._sessionId&&st.joinChannelTimeout(this._sessionId,5)},5e3);try{var _;let f;const T=l.cloudProxyServer;if(nt(_=["proxy3","proxy4","proxy5"]).call(_,T)){const M=O("PROXY_SERVER_TYPE3");Array.isArray(M)?l.proxyServer=M[0]:l.proxyServer=M}if(st.setProxyServer(l.proxyServer),m.setProxyServer(l.proxyServer),this.store.requestAPStart(),l.stringUid&&!l.uid){let M;[M,f]=await F.all([wC(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||Ce,this.store),bC(l,this._axiosCancelSource.token,this._config.httpRetryConfig||Ce,!0,this.store)]),m.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(l.stringUid," => ").concat(M)),l.uid=M,f.gatewayInfo.uid=M,f.gatewayInfo.res.uid=M}else f=await bC(l,this._axiosCancelSource.token,this._config.httpRetryConfig||Ce,!0,this.store);if(!this._joinAndNotLeaveYet)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(Za.UPDATE_BITRATE_LIMIT,M=>{this._p2pChannel.updateBitrateLimit(M)})},0),this._key=i||t;const A=f.gatewayInfo,N=l.uid?l.uid:A.uid;this._joinInfo=Ur(Ur({},l),{},{cid:A.cid,uid:N,vid:A.vid,apResponse:A.res,uni_lbs_ip:A.uni_lbs_ip,gatewayAddrs:A.gatewayAddrs}),this.store.intUid=N;const P=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(P),this._appId=t,this._channelName=l.cname,this._uid=P,this.store.uid=P,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(fn()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);const j=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return m.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(j)),setTimeout(()=>{m.startUpload()},5e3),this.store.joinEnd(),R=this,nt($r).call($r,R)||$r.push(R),P}catch(f){const T=Array.isArray(f)?f[0]:f;throw T&&T.code===v.OPERATION_ABORTED?m.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),T):m.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),T),T.code!==v.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(T),T}var R}_joinGateway(){if(!this._joinInfo||!this._key)throw new k(v.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!O("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===v.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Ot.FALLBACK),t;if(t.code===v.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Ot.FALLBACK),t;throw t}).then(t=>{if(t instanceof k){if(t.code===v.INIT_WEBSOCKET_TIMEOUT){if(m.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new k(v.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=O("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const r=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),s=r.slice(r.length-2).join(".");e.forEach(o=>{this._joinInfo&&nt(o).call(o,s)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const i=O("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return i&&i[1]&&i[1]!=="443"&&m.setProxyServer(this._joinInfo.proxyServer),O("STATS_COLLECTOR_PORT").toString()!=="443"&&st.setProxyServer(this._joinInfo.proxyServer),st.reportApiInvoke(this._sessionId,{name:Ae.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:ce.TRACER}).onSuccess(),this.safeEmit(Nt.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),O("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(r=>{"forceturn"in r&&(r.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(m.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new k(v.INVALID_OPERATION);return st.reportApiInvoke(this._sessionId,{name:Ae.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:ce.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){m.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(fn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const i=$r.indexOf(e);i!==-1&&$r.splice(i,1)}(this);const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return m.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),m.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof rn))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new k(v.INVALID_PARAMS,"param list is empty");const i=t;if(this._gateway.role==="audience")throw new k(v.INVALID_OPERATION,"audience can not publish stream");for(const s of i){if(!(s instanceof rn))throw new k(v.INVALID_PARAMS,"parameter is not local track");if(!s._enabled&&e)throw new k(v.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(s.getTrackId()))}m.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map(s=>"".concat(s.getTrackId()," "))));const r=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&i.forEach(s=>{const o=this._configDistribute.getBitrateLimit();s instanceof Ct&&o&&s.setBitrateLimit(o.uplink)});try{await this._publishHighStream(i),m.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map(s=>"".concat(s.getTrackId()," "))))}catch(s){throw m.error("[".concat(this._clientId,"] publish error"),s.toString()),s}finally{r()}}async _publishDataChannel(t){Wt(t.id,"id",0,65535,!0),zr(t.ordered,"ordered"),en(t.metadata,"metadata",0,512),m.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===t.id)!==-1)throw new k(v.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new k(v.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&O("FORCE_TURN")&&!O("TURN_ENABLE_TCP")&&!O("TURN_ENABLE_UDP"))throw new k(v.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=new ey(t);await this._p2pChannel.publishDataChannel([i]);try{const r={streamId:t.id,ordered:t.ordered,maxRetransmits:O("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,r,!0)}catch(r){if(r.code!==v.DISCONNECT_P2P)throw r}return await i._waitTillOpen(),m.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(i){throw m.error("[".concat(this._clientId,"] publish datachannels error"),i.toString()),i}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new k(v.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof rn))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);m.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(r=>"".concat(r.getTrackId()," "))," "));const i=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Me){const r=await this._p2pChannel.unpublish(e);r&&await this._gateway.sendExtensionMessage(ue.UNPUBLISH,{unpubMsg:r},!0)}else{const r=await this._p2pChannel.unpublish(e);r&&await this._gateway.unpublish(r,this._uid),m.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(s=>"".concat(s.getTrackId()))))}}catch(r){throw m.error("[".concat(this._clientId,"] unpublish error"),r.toString()),r}finally{i&&i()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),m.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(i=>"".concat(i.id," "))," "));const e=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(t);i&&await this._gateway.unpublishDataChannel(i),m.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(r=>"".concat(r.id))))}catch(i){throw m.error("[".concat(this._clientId,"] unpublish dataChannel error"),i.toString()),i}finally{e&&e()}}async subscribe(t,e,i){return e==="datachannel"?this._subscribeDataChannel(t,i):this._subscribe(t,e)}async presubscribe(t,e){if(De(e,"mediaType",["audio","video"]),this._p2pChannel instanceof Me)throw new k(v.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new k(v.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const i=e===rt.AUDIO,r=e===rt.VIDEO,s=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:a,rtxSsrcId:c,cname:d,uint_id:u}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new k(v.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(_=>_.uid===t);l||(l=new $e(t,u||t),l._is_pre_created=!0,this._users.push(l)),d&&(l._cname=d),l._uintid||(l._uintid=u||t),i&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,a&&(l._audioOrtc=a)),r&&(l._videoSSRC=o,l._video_pre_subscribed=!0,a&&(l._videoOrtc=a),c!=null&&(l._rtxSsrcId=c)),m.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(l,e,o,c,a);const p=i?l._audioTrack:l._videoTrack;if(!p)throw new k(v.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),r&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),p}catch(o){throw m.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{s()}}async _subscribeDataChannel(t,e){var i;if(Wt(e,"channelId",0,65535,!0),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new k(v.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new k(v.INVALID_REMOTE_USER,"user is not published");const r=(i=t._dataChannels)===null||i===void 0?void 0:i.find(a=>a.id===e);if(!r)throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new k(v.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&nt(a).call(a,r.id))try{var o;if(!r._originDataChannelId)throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new k(v.REMOTE_USER_IS_NOT_PUBLISHED);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(t.uid,c,!0)}catch(c){if((c==null?void 0:c.code)!==v.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return await r._waitTillOpen(),m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{s()}}async _p2pSubscribe(t,e,i){if(De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(s=>s===t)){const s=new k(v.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),s}if(!t.hasAudio&&!t.hasVideo){const s=new k(v.INVALID_REMOTE_USER,"user is not published");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),s}if(!i&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const s=new k(v.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),s}const r=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const o=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this._p2pChannel instanceof Me&&await this._p2pChannel.subscribe(t,e,o,a)}catch(o){throw o}m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(o=>{m.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});const s=e==="audio"?t._audioTrack:t._videoTrack;if(!s)throw new k(v.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw m.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),s),s}finally{r()}}async _subscribe(t,e,i){if(this._p2pChannel instanceof Me)return this._p2pSubscribe(t,e);if(De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){const d=new k(v.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){const d=new k(v.INVALID_REMOTE_USER,"user is not published");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(i||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const d=new k(v.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?rt.AUDIO:rt.VIDEO,ssrcId:r};const c=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const u=e==="audio"?t._audioSSRC:t._videoSSRC;u!==void 0&&u!==r&&(r=u,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?rt.AUDIO:rt.VIDEO,ssrcId:r}),sn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,o,s);try{await this._gateway.subscribe(t.uid,a,!0)}catch(l){if((l==null?void 0:l.code)!==v.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),l;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(u){throw this._p2pChannel.reportSubscribeEvent(!1,u==null?void 0:u.code,t,e),u}m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(u=>{m.warning("[".concat(this._clientId,"] auto set fallback failed"),u)});const d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new k(v.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw m.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if(vr(t,"subscribeList"),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),i=new Map,r=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(c=>{let{user:d,mediaType:u}=c;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(u)}).join("; ")));const s=(t=[...t]).map(c=>{let{user:d,mediaType:u}=c;return{user:d,mediaType:u}}),o=await this._p2pChannel.globalLock();try{var a;for(let d=t.length-1;d>=0;d--){const u=t[d],{user:l,mediaType:p}=u;if(De(p,"mediaType",["audio","video"]),!l){const f=new k(v.INVALID_PARAMS,"user property does not exist in subscribeList item");throw m.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),f}if(!this._users.find(f=>f===l)){const f=new k(v.INVALID_REMOTE_USER,"user is not in the channel");m.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),s[d].error=f,t.splice(d,1);continue}if(p==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||p==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){const f=new k(v.REMOTE_USER_IS_NOT_PUBLISHED);m.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(p,", remote user is not published")),s[d].error=f,t.splice(d,1);continue}const _=be.Video|be.LwoVideo,R=i.get(l);if(R){if(p==="video"?R&_:R&be.Audio){t.splice(d,1),m.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(p," twice"));continue}i.set(l,R|(p==="video"?_:be.Audio))}else i.set(l,p==="video"?_:be.Audio)}for(let d=t.length-1;d>=0;d--){const u=t[d],{user:l,mediaType:p}=u,_=be.Video|be.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,p)){await this._p2pChannel.unmuteRemoteNoLock(l,p);const R=i.get(l);i.set(l,p==="video"?R^_:R^be.Audio),t.splice(d,1)}}this.store.massSubscribe(t.map(d=>({userId:d.user.uid,type:d.mediaType})),e);const c=Hs(a=Array.from(i.entries())).call(a,(d,u)=>{let[l,p]=u;if(p===0)return d;const _={stream_id:l.uid,stream_type:p};return p&be.Audio&&(_.audio_ssrc=l._audioSSRC),p&be.Video&&(_.video_ssrc=l._videoSSRC),d.push(_),d},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(u=>{let{user:l,mediaType:p}=u;return{user:l,mediaType:p,ssrcId:p===rt.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:p===rt.VIDEO?l._rtxSsrcId:void 0}}));const d=new Map;if(c.length>0){const u=await this._gateway.subscribeAll(c,!0);((u==null?void 0:u.users)||[]).forEach(l=>{let{stream_id:p,video_error_code:_,audio_error_code:R,error_code:f}=l;(_||R||f)&&d.set(p,{video_error_code:_,audio_error_code:R,error_code:f})})}if(Array.from(d.entries()).length>0){const u=Array.from(d.entries()).map(l=>{let p,[_,R]=l;return R.error_code||R.video_error_code&&R.audio_error_code?p=void 0:R.video_error_code?p=rt.VIDEO:R.audio_error_code&&(p=rt.AUDIO),{user:this.remoteUsers.find(f=>f.uid===_),mediaType:p}});await this._p2pChannel.massUnsubscribeNoLock(u)}for(const u of s){const l=d.get(u.user.uid);if(l){const p=l.error_code||u.mediaType==="audio"&&l.audio_error_code||u.mediaType==="video"&&l.video_error_code;if(p){const _=Js(p);m.error("user:".concat(u.user.uid," mediaType:").concat(u.mediaType," has massSubscribe error ").concat(_.desc)),u.error=new k(v.SUBSCRIBE_FAILED,"code ".concat(p,": ").concat(_.desc))}}u.error||(u.mediaType==="video"?u.track=u.user.videoTrack:u.track=u.user.audioTrack)}return this.store.massSubscribe(s.filter(u=>!u.error).map(u=>({userId:u.user.uid,type:u.mediaType})),void 0,Date.now()),s.forEach(u=>{var l;st.subscribe(this.store.sessionId,{succ:!!u.error,ec:((l=u.error)===null||l===void 0?void 0:l.code)||null,video:u.mediaType===rt.VIDEO,audio:u.mediaType===rt.AUDIO,peerid:u.user.uid,subscribeRequestid:u.mediaType===rt.VIDEO?u.user._videoSSRC:u.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)}),m.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(u=>{let{user:l,mediaType:p}=u;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(p)}).join("; "))),s}catch(d){throw await this._p2pChannel.massUnsubscribeNoLock(t),d}}finally{o(),r()}}async unsubscribe(t,e,i){if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,i)}else await this._unsubscribeDataChannel(t,i);if(e&&De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(s=>s===t)){const s=new k(v.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),s}m.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const r=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Me)await this._p2pChannel.unsubscribe(t,e);else{const s=await this._p2pChannel.unsubscribe(t,e);s&&await this._gateway.unsubscribe(s,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&Pd(this._users,t),m.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(s){if(s.code===v.DISCONNECT_P2P)return void m.warning("disconnecting p2p, abort unsubscribe request.");throw m.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),s.toString()),s}finally{r()}}async _unsubscribeDataChannel(t,e){if(e&&Wt(e,"id",0,65535,!0),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){const r=new k(v.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let i;if(typeof e=="number"){const r=t._dataChannels.find(s=>s.id===e);r&&(i=[r])}else i=t._dataChannels;if(i===void 0){const r=new k(v.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}m.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map(r=>r.id)));try{const r=await this._p2pChannel.unsubscribeDataChannel(t,i);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),m.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===v.DISCONNECT_P2P)return void m.warning("disconnecting p2p, abort unsubscribe request.");throw m.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(vr(t,"unsubscribeList"),!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");m.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(i=>{let{user:r,mediaType:s}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(s,";")}).join())),t=[...t];const e=new Map;for(let i=t.length-1;i>=0;i--){const{user:r,mediaType:s}=t[i];if(!r){const a=new k(v.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw m.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(De(s,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===r)){m.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(r.uid,", user is not in the channel")),t.splice(i,1);continue}const o=be.Video|be.LwoVideo;if(e.has(r)){const a=e.get(r);let c;switch(s){case"video":c=a&o;break;case"audio":c=a&be.Audio;break;default:c=a&(be.Audio|o)}if(c){m.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(r.uid,",mediaType:").concat(s," twice.")),t.splice(i,1);continue}s?s==="audio"?e.set(r,a|be.Audio):s==="video"&&e.set(r,a|o):e.set(r,a|be.Audio|o)}else s?s==="audio"?e.set(r,be.Audio):s==="video"&&e.set(r,o):e.set(r,be.Audio|o)}try{const i=await this._p2pChannel.massUnsubscribe(t);i&&await this._gateway.massUnsubscribe(i),m.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(r=>{let{user:s,mediaType:o}=r;return"user: ".concat(s==null?void 0:s.uid,", mediaType: ").concat(o,";")}).join()))}catch(i){if(i.code===v.DISCONNECT_P2P)return void m.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw m.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}}async setLowStreamParameter(t){(function(i){if(!i)throw new G(v.INVALID_PARAMS);ae(i.width)||Kh(i.width,"streamParameter.width"),ae(i.height)||Kh(i.height,"streamParameter.height"),ae(i.framerate)||Kh(i.framerate,"streamParameter.framerate"),ae(i.bitrate)||Wt(i.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&m.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),m.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,Y.LocalVideoLowTrack)}async enableDualStream(){if(!Kt().supportDualStream)throw st.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new k(v.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new k(v.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw st.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,st.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),m.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new k(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Y.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw st.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,st.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),m.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(i){De(i,"role",["audience","host"])}(t),e&&LS(e),this.mode==="rtc"||this.mode==="p2p")throw m.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new k(v.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new k(v.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new k(v.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,m.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const i=e.timestamp-Date.now();return Math.abs(i)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(en(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new k(v.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new k(v.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,st.setProxyServer(this._proxyServer),m.setProxyServer(this._proxyServer),m.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new k(v.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new k(v.INVALID_OPERATION,"You have already set the proxy")}if(xo(t))return this._turnServer={servers:t,mode:"original-manual"},void m.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(i=>i.urls).join(","),"."));t.forEach(i=>PS(i)),this._turnServer={servers:t,mode:"manual"},m.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new k(v.INVALID_OPERATION,"you should set license before join channel");if(en(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new k(v.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,m.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new k(v.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new k(v.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let i;switch(t===void 0&&(t=3),t){case 1:case 2:throw new k(v.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new k(v.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,m.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new k(v.INVALID_OPERATION,"Stop proxy server after leave channel");st.setProxyServer(),m.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",m.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new k(v.INVALID_PARAMS,"accessPoints is required.");vr(t.accessPoints.serverList,"accessPoints.serverList"),en(t.accessPoints.domain,"accessPoints.domain");const e=(_,R)=>{Wt(_,R,0,65535,!0)};let i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new k(v.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");O("CLOSE_AFB_FOR_LOCAL_AP")&&(Ht("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Ht("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,s=t.accessPoints.domain,o=t.accessPoints.serverList.map(_=>r.test(_)?"".concat(_.replace(/\./g,"-"),".").concat(s):_),a=o.map(_=>"".concat(_,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Ht("WEBCS_DOMAIN",a),Ht("WEBCS_DOMAIN_BACKUP_LIST",a),Ht("GATEWAY_DOMAINS",[s]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(vr(t.report.hostname,"report.hostname"),Ht("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Ht("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Ht("EVENT_REPORT_DOMAIN",o[0]),Ht("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let c=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),c=t.report.port),Ht("STATS_COLLECTOR_PORT",c),t.report?Ht("ENABLE_EVENT_REPORT",!0):Ht("ENABLE_EVENT_REPORT",!1);let d="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(vr(t.log.hostname,"log.hostname"),d=t.log.hostname[0]):d=o[0];let u=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),u=t.log.port),Ht("LOG_UPLOAD_SERVER","".concat(d,":").concat(u));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(vr(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=o;let p=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),p=t.cds.port),Ht("CDS_AP",l.map(_=>"".concat(_,":").concat(p))),t.cds?Ht("ENABLE_CONFIG_DISTRIBUTE",!0):Ht("ENABLE_CONFIG_DISTRIBUTE",!1),m.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(vr(t,"serverList"),en(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new k(v.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(r=>i.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(e):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Ht("WEBCS_DOMAIN",t),Ht("WEBCS_DOMAIN_BACKUP_LIST",t),Ht("GATEWAY_DOMAINS",[e]),Ht("EVENT_REPORT_DOMAIN",t[0]),Ht("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Ht("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),m.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(De(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw m.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else m.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){De(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const i=this._users.find(r=>r.uid===t);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw m.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}m.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){De(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(i){throw m.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}m.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,i){(function(s){De(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),en(e,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(nt(r).call(r,t)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new k(v.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new k(v.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||m.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=Fo(i))}async renewToken(t){if(en(t,"token",1,2047),!this._key||!this._joinInfo)throw new k(v.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const i=await this._renewTokenMutex.lock();try{if(O("USE_NEW_TOKEN")){m.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const r=await PM(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ce);m.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:r})}else m.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});m.debug("[".concat(this._clientId,"] renewToken success"))}catch(r){throw this._key=e,this._joinInfo.token=e,m.error("[".concat(this._clientId,"] renewToken failed"),r.toString()),r}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?m.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(Nt.VOLUME_INDICATOR,t)},O("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new k(v.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new k(v.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new k(v.LIVE_STREAMING_TASK_CONFLICT);const i=e?Le.TRANSCODE:Le.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)}setLiveTranscoding(t){return this._createLiveStreamingClient(Le.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(t));if(!e.length)throw new k(v.INVALID_PARAMS,"can not find live streaming url to stop");await F.all(e.map(i=>i&&i.stopLiveStreamingTask(t)))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new k(v.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(Le.INJECT);i.setInjectStreamConfig(e,0),await i.startLiveStreamingTask(t,Le.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(Le.INJECT),i=Array.from(Yi(t=e.streamingTasks).call(t)).find(r=>r.mode===Le.INJECT);if(!this._joinInfo||!i)throw new k(v.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(t){Py(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){Py(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new k(v.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const i=new TextEncoder;t.payload=i.encode(t.payload)}if(new Blob([t.payload]).size>1024)throw new k(v.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(at.DATA_STREAM,{payload:Fo(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-H2},!e)}sendMetadata(t){if(!this._joinInfo)throw new k(v.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new k(v.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(at.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Fo(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(H1),!this._joinInfo)throw new k(v.INVALID_OPERATION,"can not send custom report, not joined");await st.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){De(e.spatialLayer,"spatialLayer",[0,1,2,3]),De(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(i){throw m.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:i}=t;if(zr(e,"apRTM"),Wt(i,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=i,m.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)}_reset(){if(m.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Pn.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new He("client-publish"),this._subscribeMutex=new He("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var i;const r=t||zh();t?m.debug("[".concat(this._clientId,"] new Session ").concat(r)):m.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));const s=t?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r;const o={lts:new Date().getTime(),mode:this.mode,stringUid:(e==null?void 0:e.stringUid)||((i=this._joinInfo)===null||i===void 0?void 0:i.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:s,clientRole:this.role==="audience"?2:1};e?st.sessionInit(this._sessionId,Ur({cname:e.channel,appid:e.appId},o)):this._joinInfo?st.sessionInit(this._sessionId,Ur({cname:this._joinInfo.cname,appid:this._joinInfo.appId},o)):this._gateway.joinInfo&&st.sessionInit(this._sessionId,Ur({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new k(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&O("FORCE_TURN")&&!O("TURN_ENABLE_TCP")&&!O("TURN_ENABLE_UDP"))throw new k(v.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");m.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Me){const r=(await i.next()).value;if(r){try{await this._gateway.sendExtensionMessage(ue.PUBLISH,r,!0)}catch(s){throw i.throw(s),s}await i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const r=(await i.next()).value;if(r){var e;let s;try{s=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==v.DISCONNECT_P2P)throw i.throw(o),o}await i.next(((e=s)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const s of t)s instanceof Ct&&s._encoderConfig&&this._gateway.setVideoProfile(s._encoderConfig),!s.muted&&s.enabled||await this._p2pChannel.muteLocalTrack(s)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,t),(i==null?void 0:i.code)===v.WS_ABORT)return;throw i}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new k(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new k(v.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));m.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const i=await this._p2pChannel.publishLowStream(this._lowStreamParameter),r=(await i.next()).value;if(r){var e;let s;try{s=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==v.DISCONNECT_P2P)throw i.throw(o),o}i.next(((e=s)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,void 0,!0),(i==null?void 0:i.code)===v.WS_ABORT)return;throw i}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new k(v.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new R2(this._joinInfo,this._config.websocketRetryConfig||Ce,this._config.httpRetryConfig||Ce),i=r=>{r.onLiveStreamError=(s,o)=>{st.reportApiInvoke(this._sessionId,{name:Ae.ON_LIVE_STREAM_ERROR,options:[s,o],tag:ce.TRACER}).onSuccess(),this.safeEmit(Nt.LIVE_STREAMING_ERROR,s,o)},r.onLiveStreamWarning=(s,o)=>{st.reportApiInvoke(this._sessionId,{name:Ae.ON_LIVE_STREAM_WARNING,options:[s,o],tag:ce.TRACER}).onSuccess(),this.safeEmit(Nt.LIVE_STREAMING_WARNING,s,o)},r.on(Yo.REQUEST_WORKER_MANAGER_LIST,(s,o,a)=>{if(!this._joinInfo)return a(new k(v.INVALID_OPERATION,"can not find join info to get worker manager"));NC(s,this._joinInfo,this._axiosCancelSource.token,Ce).then(o).catch(a)})};switch(t){case Le.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Le.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Le.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(Yo.REQUEST_WORKER_MANAGER_LIST,(r,s,o)=>{if(!this._joinInfo)return o(new k(v.INVALID_OPERATION,"can not find join info to get worker manager"));NC(r,this._joinInfo,this._axiosCancelSource.token,Ce).then(s).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(r,s,o)=>{this.safeEmit(Nt.INJECT_STREAM_STATUS,r,s,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new k(v.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),i={width:t,height:e};this._channelMediaRelayClient=new v2(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Ce,this._config.httpRetryConfig||Ce,i),this._channelMediaRelayClient.on("state",r=>{r===In.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(Nt.CHANNEL_MEDIA_RELAY_STATE,r)}),this._channelMediaRelayClient.on("event",r=>{this.safeEmit(Nt.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._statsCollector.onStatsChanged=(r,s)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(s))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:i,deleted:r}=t,s=[];Array.isArray(i)&&i.length>0&&i.forEach(o=>{const{uid:a,stream_id:c,ordered:d,max_retrans_times:u,metadata:l}=o,p=this._users.find(_=>_._uintid===a);if(!p)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(m.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(a)),nt(s).call(s,p)||s.push(p),p._uintid||(p._uintid=a),p._dataChannels.findIndex(_=>_.id===o.stream_id)===-1){const _={id:c,ordered:!!d,maxRetransmits:u,metadata:l},R=new $U(_);p._dataChannels.push(R),m.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published datachannel")),e||this.safeEmit(Nt.USER_PUBLISHED,p,"datachannel",_)}this._p2pChannel.hasPendingRemoteDataChannel(p,o.stream_id)&&(m.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(p.uid," after reconnect.")),this._subscribeDataChannel(p,o.stream_id).catch(_=>{m.error("[".concat(this._clientId,"] resubscribe datachannel error"),_.toString())}))}),e&&(this.safeEmit(Nt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(o=>{const{uid:a,stream_id:c}=o,d=this._users.find(l=>l._uintid===a);if(!d)return void m.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const u=d._dataChannels.find(l=>l.id===o.stream_id);u&&(m.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(a)),this._p2pChannel.unsubscribeDataChannel(d,[u]).then(l=>{if(d._dataChannels=d._dataChannels.filter(p=>p!==u),l)return this._gateway.unsubscribeDataChannel(l,d.uid)}),m.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished datachannel ,id:").concat(u.id)),this.safeEmit(Nt.USER_UNPUBLISHED,d,"datachannel",u._config))})}_handleRemoveDataChannels(t){const e=this._users.find(i=>i.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){m.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const i=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(r=>{this.safeEmit(Nt.USER_UNPUBLISHED,e,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,e.uid)}),i()}}else m.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(de.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(de.CONNECTION_STATE_CHANGE,(t,e,i)=>{var r;if(i===Ot.FALLBACK)return;const s=()=>{this.safeEmit(Nt.CONNECTION_STATE_CHANGE,t,e,i)};if(st.reportApiInvoke(this._sessionId||((r=this._gateway.joinInfo)===null||r===void 0?void 0:r.sid)||null,{name:Ae.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:ce.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),m.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void s();if(t==="RECONNECTING")this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((a,c)=>{this._gateway.setStreamFallbackOption(c,a).catch(d=>{m.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),d)})}),this._remoteStreamTypeCacheMap.forEach((a,c)=>{this._gateway.setRemoteVideoStreamType(c,a).catch(d=>{m.warning("[".concat(this._clientId,"] auto set remote stream type failed"),d)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{m.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{m.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{m.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(m.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,rt.AUDIO,!1)),a._trust_video_mute_state_||(m.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,rt.VIDEO,!1)),a._trust_audio_enabled_state_||(m.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(m.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(m.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(m.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(m.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}s()}),this._gateway.on(de.REQUEST_NEW_GATEWAY_LIST,(t,e)=>{if(!this._joinInfo)return e(new k(v.UNEXPECTED_ERROR,"can not recover, no join info"));jp(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ce,this.store).then(i=>{this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);const r=[];i.gatewayInfo.gatewayAddrs.forEach(s=>{let{address:o}=s;const[a,c]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:a,port:c}):r.push({host:a,port:c})}),t(r)}).catch(e)}),this._gateway.on(de.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Nt.NETWORK_QUALITY,t)}),this._gateway.on(de.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(Nt.STREAM_TYPE_CHANGED,t,e),st.reportApiInvoke(this._sessionId,{name:Ae.STREAM_TYPE_CHANGE,options:[t,e],tag:ce.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(de.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(de.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(de.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,i)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(r){i(r)}}),this._gateway.on(de.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:r,candidates:s,rtpCapabilities:o,setup:a,cname:c}=Ry(t.ortc,e);this._p2pChannel.connect(r,i,s,o,a,c)}),this._gateway.on(de.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams())}),this._gateway.on(de.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()}),this._gateway.on(de.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(de.DATACHANNEL_PRECONNECT,async(t,e,i,r)=>{var s,o,a,c,d,u;await this._p2pChannel.startP2PConnection({turnServer:(s=this._joinInfo)===null||s===void 0?void 0:s.turnServer},!0);const l=function(p,_){let R;return _&&_.ip&&typeof _.port=="number"?(R=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:_.ip,port:_.port.toString(),type:"host",extension:{}}],m.debug("Using remote candidate from AP ".concat(_.ip,":").concat(_.port)),_.ip6&&(R.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:_.ip6,port:_.port.toString(),type:"host",extension:{}}),m.debug("Using IPV6 remote candidate from AP ".concat(_.ip6,":").concat(_.port)))):R=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:p.ip,port:p.port.toString(),type:"host",extension:{}}],R}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cert),icePwd:"".concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cid,"_").concat((d=this._joinInfo)===null||d===void 0?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(u=O("FINGERPRINT"))!==null&&u!==void 0?u:t.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(r)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Et.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Et.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Et.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(Et.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(Et.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(Et.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Et.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Et.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Et.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,rt.AUDIO,!0)),this._gateway.signal.on(Et.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,rt.AUDIO,!1)),this._gateway.signal.on(Et.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,rt.VIDEO,!0)),this._gateway.signal.on(Et.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,rt.VIDEO,!1)),this._gateway.signal.on(Et.RECEIVE_METADATA,t=>{const e=kd(t.metadata);this.safeEmit(Nt.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(Et.ON_DATA_STREAM,async t=>{if(!t)return;let e=0;if(t.ordered||t.syncWithAudio){const i=this._p2pChannel.getStats(),r=this.remoteUsers.find(o=>o.uid===t.uid),s=i==null?void 0:i.audioRecv.find(o=>o.ssrc===(r==null?void 0:r._audioSSRC));e=s==null?void 0:s.jitterBufferMs}e==null&&(e=0),Y2(t,e,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Et.ON_CRYPT_ERROR,()=>{Ja(()=>{m.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Nt.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Et.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Et.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{m.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ot.TOKEN_EXPIRE),this.safeEmit(Nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Et.ON_STREAM_FALLBACK_UPDATE,t=>{m.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(Nt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Et.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),m.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(Et.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(Et.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on($.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case at.PUBLISH:{if(!e)return;const s=e.ortc;if(s){var i,r;const o=s.some(d=>{let{stream_type:u}=d;return u===Ut.Audio}),a=s.some(d=>{let{stream_type:u}=d;return u!==Ut.Audio}),c=s.some(d=>{let{stream_type:u}=d;return u===Ut.Screen||u===Ut.ScreenLow});e.state==="offer"&&st.publish(this._joinInfo.sid,{eventElapse:sn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:v.TIMEOUT,audio:o,video:a,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:o?(i=s.find(d=>{let{stream_type:u}=d;return u===Ut.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0,videoName:a?(r=s.find(d=>{let{stream_type:u}=d;return u!==Ut.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0})}break}case at.SUBSCRIBE:e&&st.subscribe(this._joinInfo.sid,{succ:!1,ec:v.TIMEOUT,audio:e.stream_type===rt.AUDIO,video:e.stream_type===rt.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:sn.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}}),this._gateway.signal.on(Et.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(Et.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;O("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(r=>!Ys(r.string_id||r.stream_id,this.channelName)));const e=[],i=[];for(const r of t.users){let s=this._users.find(l=>l._uintid===r.stream_id);s?s._trust_in_room_=!0:(s=new $e(r.string_id||r.stream_id,r.stream_id),this._users.push(s),this.getListeners(Nt.PUBLISHED_USER_LIST).length===0&&(m.debug("[".concat(this._clientId,"] user online"),r.stream_id),this.safeEmit(Nt.USER_JOINED,s)));const o=be.Audio&r.stream_type,a=(be.Video|be.LwoVideo)&r.stream_type,c=(65280&r.stream_type)!=0,d=o&&s.hasAudio,u=a&&s.hasVideo;a&&(s._trust_video_stream_added_state_=!0,s._video_added_=!0,s._videoSSRC=r.video_ssrc,s._rtxSsrcId=r.video_rtx),o&&(s._trust_audio_stream_added_state_=!0,s._audio_added_=!0,s._audioSSRC=r.audio_ssrc),o&&!d&&this.getListeners(Nt.PUBLISHED_USER_LIST).length===0&&(m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published audio")),this.safeEmit(Nt.USER_PUBLISHED,s,"audio")),a&&!u&&this.getListeners(Nt.PUBLISHED_USER_LIST).length===0&&(m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published video")),this.safeEmit(Nt.USER_PUBLISHED,s,"video")),(o&&!d||a&&!u||c)&&e.push(s),a&&this._p2pChannel.hasPendingRemoteMedia(s,"video")&&i.push({user:s,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(s,"audio")&&i.push({user:s,mediaType:"audio"})}i.length>0&&(m.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(r=>"user: ".concat(r.user.uid,", mediaType: ").concat(r.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(r=>{m.error("[".concat(this._clientId,"] mass resubscribe error"),r.toString())})),this.getListeners(Nt.PUBLISHED_USER_LIST).length>0?O("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(m.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(r=>r.uid).join(", "))),this.safeEmit(Nt.PUBLISHED_USER_LIST,e)):m.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(r=>r.uid).join(", ")))}),this._gateway.signal.on(Et.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:e}=t;this._p2pChannel instanceof Je&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(i=>i.toLowerCase()).filter(i=>{var r;return nt(r=Object.keys(Zr)).call(r,i)}))})}_handleP2PEvents(){this._gateway.signal.on(Et.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(ue.PUBLISH,(t,e,i)=>{const{uid:r}=t;t.forEach(s=>{const{kind:o,ssrcs:a,mid:c,isMuted:d}=s;this._handleP2PAddAudioOrVideoStream(o,r,a[0].ssrcId,c);const u=this._users.find(l=>l.uid===r);return u&&this._p2pChannel instanceof Me?this._p2pChannel.mockSubscribe(u,o,a[0].ssrcId,c).then(()=>{e()}).catch(i):e(),this._handleMuteStream(r,o,!!d)})}),this._gateway.signal.on(ue.CALL,async(t,e,i)=>{if(this._p2pChannel instanceof Me)try{var r;e(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},t))}catch(s){i(s)}}),this._gateway.signal.on($.P2P_CONNECTION,async t=>{this._p2pChannel instanceof Me&&await this._p2pChannel.p2pConnect(t)}),this._gateway.signal.on(ue.UNPUBLISH,async(t,e,i)=>{if(this._p2pChannel instanceof Me){const{unpubMsg:r,uid:s}=t,o=this._users.find(a=>a.uid===s);if(!o)return m.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(s)),void e();try{r.forEach(async a=>{let{stream_type:c}=a;const d=c===Ut.Audio?rt.AUDIO:rt.VIDEO;await this._p2pChannel.unsubscribe(o,d),this._handleMuteStream(s,d,!0)}),e()}catch(a){i(a)}}}),this._gateway.signal.on(ue.CONTROL,async(t,e)=>{const{action:i}=t;switch(i){case cr.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,rt.VIDEO,!0);break;case cr.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,rt.AUDIO,!0);break;case cr.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,rt.VIDEO,!1);break;case cr.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,rt.AUDIO,!1)}}),this._gateway.signal.on(ue.RESTART_ICE,async(t,e,i)=>{if(this._p2pChannel instanceof Me)try{const{direction:r,iceParameter:s}=t;r!==ln.SEND_ONLY||s?e(await this._p2pChannel.restartICE(r,s)):(this._p2pChannel.handleDisconnect(r),e())}catch(r){i(r)}}),this._gateway.signal.on(ue.CANDIDATE,t=>{if(this._p2pChannel instanceof Me){const{candidate:e,direction:i}=t;this._p2pChannel.addRemoteCandidate(e,i)}}),this._p2pChannel.on(lt.RequestP2PRestartICE,async(t,e,i)=>{try{const{direction:r}=t;e(await this._gateway.sendExtensionMessage(ue.RESTART_ICE,t,r===ln.SEND_ONLY))}catch(r){i(r)}}),this._p2pChannel.on(lt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(ue.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(lt.RequestP2PMuteLocal,async(t,e,i)=>{try{await this._gateway.sendExtensionMessage(ue.CONTROL,t,!0),e()}catch(r){i(r)}}),this._p2pChannel.on(lt.RequestP2PUnmuteRemote,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===v.DISCONNECT_P2P?e():i(r)}else e()}),this._p2pChannel.on(lt.RequestP2PMuteRemote,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===v.DISCONNECT_P2P?e():i(r)}else e()}),this._p2pChannel.on(lt.StateChange,(t,e)=>{e===Bt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(lt.RequestMuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===v.DISCONNECT_P2P?e():i(r)}else e()}),this._p2pChannel.on(lt.RequestUnmuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(r){r.code===v.DISCONNECT_P2P?e():i(r)}else e()}),this._p2pChannel.on(lt.RequestRePublish,(t,e,i)=>{this.publish(t,!1).then(e).catch(i)}),this._p2pChannel.on(lt.RequestRePublishDataChannel,(t,e,i)=>{F.all(t.map(async r=>{await this._p2pChannel.publishDataChannel([r]);const s={streamId:r.id,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:r.metadata,channelId:r._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,s,!0)}catch(o){if(o.code!==v.DISCONNECT_P2P)throw o}})).then(e).catch(i)}),this._p2pChannel.on(lt.RequestReSubscribe,async(t,e,i)=>{try{for(const{user:r,kind:s}of t)s===rt.VIDEO?await this.subscribe(r,"video"):await this.subscribe(r,"audio");e()}catch(r){i(r)}}),this._p2pChannel.on(lt.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(lt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(lt.MediaReconnectStart,t=>{this.safeEmit(Nt.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(lt.MediaReconnectEnd,t=>{this.safeEmit(Nt.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(lt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(lt.RequestRestartICE,async t=>{if(this._p2pChannel instanceof Me)return;const e=await this._p2pChannel.restartICE(t),i=await e.next();if(i.done)return;const r=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:r})}catch(a){return void e.throw(a)}const{iceParameters:o}=function(a){const c=a.iceParameters;return{iceParameters:{iceUfrag:c.iceUfrag,icePwd:c.icePwd}}}(s);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(lt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(lt.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:i,rtpCapabilities:r}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:r}),{dtlsParameters:a,iceParameters:c,candidates:d,rtpCapabilities:u,setup:l,cname:p}=Ry(s,o);await this._p2pChannel.connect(c,a,d,u,l,p),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(lt.RequestUnpublishForReconnectPC,async(t,e,i)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):i()}),this._p2pChannel.on(lt.P2PLost,()=>{this.safeEmit(Nt.P2P_LOST,this.store.uid)}),this._p2pChannel.on(lt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(lt.ConnectionTypeChange,t=>{this.safeEmit(Nt.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(lt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(lt.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach(i=>{var r;if(!nt(r=["supervise","moderation"]).call(r,i))throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(i," is not a valid inspect type."))}),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new Vu(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Ce)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(zr(t,"enabled"),t){if(!e)throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(Wt(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(e&&e.vendor&&e.vendor.length>1024)throw new k(v.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);const i=new X_(e);this._moderation=i,this.handleImageModerationEvents(this._moderation),await i.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Ce)}catch(i){throw Array.isArray(i)?i[0]:i}}else{if(!this._moderation)throw new k(v.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}setP2PTransport(t){if(function(e){De(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new k(v.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,m.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}handleImageModerationEvents(t){t.on(Ti.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(Nt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,i),e===Hn.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new k(v.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(Ti.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}handleVideoInspectEvents(t){t.on(ke.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(Nt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===ni.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Nt.CONTENT_INSPECT_ERROR,new k(v.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(ke.INSPECT_RESULT,(e,i)=>{var r;if((i==null?void 0:i.code)===v.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return m.debug("Stop inspect content because that has left channel"),this==null||(r=this._inspect)===null||r===void 0||r.close(),void(this._inspect=void 0);this.safeEmit(Nt.CONTENT_INSPECT_RESULT,e,i)}),t.on(ke.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return m.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){zr(t,"enabled"),Ht("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"leave",null),W([dt({argsMap:(n,t)=>{if(!Array.isArray(t)){if(!(t instanceof rn))return[t];t=[t]}return t.map(e=>e?Object(e).toString():"null")}}),S("design:type",Function),S("design:paramtypes",[Object,Boolean]),S("design:returntype",F)],Gt.prototype,"publish",null),W([dt({argsMap:(n,t)=>(t||(t=[]),t instanceof ey?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map(e=>e.getTrackId())))}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"unpublish",null),W([dt({argsMap:(n,t,e,i)=>[t.uid,e,i]}),S("design:type",Function),S("design:paramtypes",[$e,String,Number]),S("design:returntype",F)],Gt.prototype,"subscribe",null),W([dt({argsMap:(n,t,e)=>[t,e]}),S("design:type",Function),S("design:paramtypes",[Object,String]),S("design:returntype",F)],Gt.prototype,"presubscribe",null),W([dt({argsMap:(n,t)=>t.map(e=>{let{user:i,mediaType:r}=e;return[i==null?void 0:i.uid,r]})}),S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Gt.prototype,"massSubscribe",null),W([dt({argsMap:(n,t,e,i)=>[t.uid,e,i]}),S("design:type",Function),S("design:paramtypes",[$e,String,Number]),S("design:returntype",F)],Gt.prototype,"unsubscribe",null),W([dt({argsMap:(n,t)=>t.map(e=>{let{user:i,mediaType:r}=e;return{uid:i==null?void 0:i.uid,mediaType:r}})}),S("design:type",Function),S("design:paramtypes",[Array]),S("design:returntype",F)],Gt.prototype,"massUnsubscribe",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"setLowStreamParameter",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"enableDualStream",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"disableDualStream",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String,Object]),S("design:returntype",F)],Gt.prototype,"setClientRole",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String,Boolean]),S("design:returntype",void 0)],Gt.prototype,"setProxyServer",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object,Boolean]),S("design:returntype",void 0)],Gt.prototype,"setTurnServer",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",void 0)],Gt.prototype,"setLicense",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",void 0)],Gt.prototype,"startProxyServer",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Gt.prototype,"stopProxyServer",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",void 0)],Gt.prototype,"setLocalAccessPointsV2",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Array,String]),S("design:returntype",void 0)],Gt.prototype,"setLocalAccessPoints",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Number]),S("design:returntype",F)],Gt.prototype,"setRemoteDefaultVideoStreamType",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object,Number]),S("design:returntype",F)],Gt.prototype,"setRemoteVideoStreamType",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object,Number]),S("design:returntype",F)],Gt.prototype,"setStreamFallbackOption",null),W([dt({argsMap:(n,t)=>[t]}),S("design:type",Function),S("design:paramtypes",[String,String,Uint8Array]),S("design:returntype",void 0)],Gt.prototype,"setEncryptionConfig",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Gt.prototype,"renewToken",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",void 0)],Gt.prototype,"enableAudioVolumeIndicator",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String,Boolean]),S("design:returntype",F)],Gt.prototype,"startLiveStreaming",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"setLiveTranscoding",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",F)],Gt.prototype,"stopLiveStreaming",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String,Object]),S("design:returntype",F)],Gt.prototype,"addInjectStreamUrl",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"removeInjectStreamUrl",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Pu]),S("design:returntype",F)],Gt.prototype,"startChannelMediaRelay",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Pu]),S("design:returntype",F)],Gt.prototype,"updateChannelMediaRelay",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"stopChannelMediaRelay",null),W([dt({argsMap:(n,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"sendCustomReportMessage",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object,Object]),S("design:returntype",F)],Gt.prototype,"pickSVCLayer",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"setRTMConfig",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Object]),S("design:returntype",F)],Gt.prototype,"enableContentInspect",null),W([dt(),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",F)],Gt.prototype,"disableContentInspect",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Boolean,Object]),S("design:returntype",F)],Gt.prototype,"setImageModeration",null),W([dt(),S("design:type",Function),S("design:paramtypes",[String]),S("design:returntype",void 0)],Gt.prototype,"setP2PTransport",null),W([dt({reportResult:!0}),S("design:type",Function),S("design:paramtypes",[]),S("design:returntype",Array)],Gt.prototype,"getJoinChannelServiceRecords",null),W([dt(),S("design:type",Function),S("design:paramtypes",[Boolean]),S("design:returntype",F)],Gt.prototype,"setPublishAudioFilterEnabled",null);class Oc{constructor(t,e){h(this,"id",0),h(this,"element",void 0),h(this,"peerPair",void 0),h(this,"context",void 0),h(this,"audioPlayerElement",void 0),h(this,"audioTrack",void 0),Oc.count+=1,this.id=Oc.count,this.element=t,this.context=e}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const e=document.createElement("audio");e.srcObject=new MediaStream([t.track]),e.play(),this.audioPlayerElement=e}}async switchSdp(){if(!this.peerPair)return;const t=async(i,r)=>{const s=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(s),i.iceGatheringState==="complete"?i.localDescription:new F(o=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&o(i.localDescription)}})},e=async(i,r)=>await i.setRemoteDescription(r);try{const i=await t(this.peerPair[0],"offer");await e(this.peerPair[1],i);const r=await t(this.peerPair[1],"answer");await e(this.peerPair[0],r)}catch(i){throw new k(v.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let e;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),e=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(e)}catch(r){throw new k(v.LOCAL_AEC_ERROR,r.toString()).print()}if(!e)throw new k(v.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=e.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,e=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(e),await this.switchSdp()}close(){m.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}h(Oc,"count",0);const z2=window.AudioContext||window.webkitAudioContext;class gI{constructor(){h(this,"units",[]),h(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return m.debug("the system does not need to process local aec"),-1;this.context||(this.context=new z2);let e=this.units.find(i=>i&&i.getElement()===t);return e||(e=new Oc(t,this.context),this.units.push(e)),e.startEchoCancellation(),m.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Lt().name!==xt.SAFARI}}W([dt({report:st}),S("design:type",Function),S("design:paramtypes",[HTMLAudioElement]),S("design:returntype",Number)],gI.prototype,"processExternalMediaAEC",null);const X2=new gI;function TI(n,t){var e=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(n,r).enumerable})),e.push.apply(e,i)}return e}function SI(n){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?TI(Object(e),!0).forEach(function(i){h(n,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)):TI(Object(e)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(e,i))})}return n}const Z_=window||document;function RI(n){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Z_)return;const e=ye._cspEventHandlerPointer;if(e&&t)return void console.error(e,t);const i=r=>{if(!(r&&r.blockedURI&&(ye.onSecurityPolicyViolation||ye.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0)))return;const s=r.blockedURI;O("CSP_DETECTED_HOSTNAME_LIST").some(o=>nt(s).call(s,o))&&(ye.onSecurityPolicyViolation&&typeof ye.onSecurityPolicyViolation=="function"&&ye.onSecurityPolicyViolation(r),ye.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0&&ye.safeEmit(Di.SECURITY_POLICY_VIOLATION,r))};e&&Z_.removeEventListener("securitypolicyviolation",e),(t||n&&typeof n=="function"||ye.getListeners(Di.SECURITY_POLICY_VIOLATION).length>0)&&Z_.addEventListener("securitypolicyviolation",i),ye._cspEventHandlerPointer=i}Ht("PROCESS_ID","process-".concat(Qt(8,""),"-").concat(Qt(4,""),"-").concat(Qt(4,""),"-").concat(Qt(4,""),"-").concat(Qt(12,""))),function(){let n;try{n=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void m.error("Error loading sdk config",t.message)}if(n)try{const t=JSON.parse(window.atob(n)),e=Date.now();m.debug("Loading global parameters from cache",t),Object.keys(t).forEach(i=>{if(Object.prototype.hasOwnProperty.call(vn,i)){const{value:r,expires:s}=t[i];if(s&&s<=e)return;Qr[i]=r,vn[i]=r}})}catch(t){m.error("Error loading mutableParamsCache: ".concat(n),t.message)}}(),Array.isArray(Qr.AREAS)&&Qr.AREAS.length>0&&xp(Qr.AREAS,!0);const CI=(n,t,e)=>{m.debug("setParameter key:".concat(n,", value:").concat(JSON.stringify(t))),Ht(n,t,e)},ye=function(n){const t=new se,e=n,i={getListeners:t.getListeners.bind(t),on:(r,s)=>(function(o,a){o===Di.SECURITY_POLICY_VIOLATION&&RI(a,!0)}(r,s),t.on.bind(t)(r,s)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return SI(SI({},e),i)}({__TRACK_LIST__:Xo,VERSION:fi,BUILD:gp,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:CI,getParameter:O,getSupportedCodec:async function(){let n={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const e=(await t.createOffer()).sdp;if(!e)return n;t.close(),t=null,n=function(i){const r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r}(e)}catch(t){throw new k(v.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return n},checkSystemRequirements:function(){const n=st.reportApiInvoke(null,{name:Ae.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:ce.TRACER});let t=!1;try{const s=window.RTCPeerConnection,o=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;t=!!(s&&o&&a)}catch(s){return m.error("check system requirement failed: ",s),!1}let e=!1;const i=Lt();i.name===xt.CHROME&&Number(i.version)>=58&&(!zk()||Jk())&&(e=!0),i.name===xt.FIREFOX&&Number(i.version)>=56&&(e=!0),i.name===xt.OPERA&&Number(i.version)>=45&&(e=!0),i.name===xt.SAFARI&&Number(i.version)>=11&&(e=!0),(vS()||Lt().name===xt.QQ)&&(e=!0),m.debug("checkSystemRequirements, api:",t,"browser",e);const r=t&&e;return n.onSuccess(r),r},getDevices:function(n){return ai.enumerateDevices(!0,!0,n)},getMicrophones:function(n){return ai.getRecordingDevices(n)},getCameras:function(n){return ai.getCamerasDevices(n)},getElectronScreenSources:WC,getPlaybackDevices:function(n){return ai.getSpeakers(n)},createClient:function(){var n;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const e=st.reportApiInvoke(null,{name:Ae.CREATE_CLIENT,options:[t],tag:ce.TRACER});try{(function(i){De(i.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),De(i.mode,"config.mode",["rtc","live","p2p"]),i.audioCodec!==void 0&&De(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),i.proxyServer!==void 0&&en(i.proxyServer,"config.proxyServer",1,1e4),i.turnServer!==void 0&&PS(i.turnServer),i.httpRetryConfig!==void 0&&DS(i.httpRetryConfig),i.websocketRetryConfig!==void 0&&DS(i.websocketRetryConfig)})(t)}catch(i){throw e.onError(i),i}return J2()||(t.codec==="vp9"&&(t.codec="vp8",m.debug("browser not support vp9, force use vp8")),Ht("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),e.onSuccess(),new Gt(Ur(Ur({forceWaitGatewayResponse:!0},t),{},{role:nt(n=["rtc","p2p"]).call(n,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_CAM_VIDEO_TRACK,options:[pu({},n)]}),e=hu(n),i=Qt(8,"track-cam-");let r=null;const s=n.encoderConfig==="720p_auto";m.info("start create camera video track with config",JSON.stringify(n),"trackId",i);try{r=(await oi({video:e},i)).getVideoTracks()[0]||null}catch(a){throw t.onError(a),a}if(!r){const a=new G(v.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(a),a.throw(m)}n.optimizationMode&&s_(i,r,n,dr(n.encoderConfig));const o=new ds(r,n,e,n.scalabiltyMode?su(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,i);return s&&o.startMonitorStats(),t.onSuccess(o.getTrackId()),m.info("create camera video success, trackId:",i),o},createCustomVideoTrack:function(n){const t=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_CUSTOM_VIDEO_TRACK,options:[n]}),e=new Ct(n.mediaStreamTrack,{width:n.width,height:n.height,frameRate:n.frameRate,bitrateMax:n.bitrateMax,bitrateMin:n.bitrateMin},n.scalabiltyMode?su(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,Qt(8,"track-cus-"),[$t.CUSTOM_TRACK]);return t.onSuccess(e.getTrackId()),m.info("create custom video track success with config",n,"trackId",e.getTrackId()),e},createScreenVideoTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const e=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_SCREEN_VIDEO_TRACK,options:[pu({},n),t]}),i=n.encoderConfig==="720p_auto";n.encoderConfig?typeof n.encoderConfig=="string"||n.encoderConfig.width&&n.encoderConfig.height||(n.encoderConfig.width={max:1920},n.encoderConfig.height={max:1080}):n.encoderConfig="1080p_2";const r=function(l){const p={};l.screenSourceType&&(p.mediaSource=l.screenSourceType),l.extensionId&&Ka()&&(p.extensionId=l.extensionId);const{displaySurface:_,selfBrowserSurface:R,surfaceSwitching:f,systemAudio:T}=l;(Wh(107)||gS(107)||TS(93))&&(_&&(De(_,"displaySurface",["browser","window","monitor"]),p.displaySurface=_),R?(De(R,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=R):p.selfBrowserSurface="include",f&&(De(f,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=f)),(Wh(105)||gS(105)||TS(91))&&T&&(De(T,"systemAudio",["exclude","include"]),p.systemAudio=T),l.electronScreenSourceId&&(p.sourceId=l.electronScreenSourceId);const A=l.encoderConfig?Wp(l.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:A?A.width:void 0,maxHeight:A?A.height:void 0},A&&(A.frameRate&&(typeof A.frameRate=="number"?(p.mandatory.maxFrameRate=A.frameRate,p.mandatory.minFrameRate=A.frameRate):(p.mandatory.maxFrameRate=A.frameRate.max||A.frameRate.ideal||A.frameRate.exact||void 0,p.mandatory.minFrameRate=A.frameRate.min||A.frameRate.ideal||A.frameRate.exact||void 0),p.frameRate=A.frameRate),A.width&&(p.width=A.width),A.height&&(p.height=A.height)),p}(n),s=Qt(8,"track-scr-v-");let o=null,a=null;const c=Kt();if(!c.supportShareAudio&&t==="enable"){const l=new G(v.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return e.onError(l),l.throw(m)}m.info("start create screen video track with config",n,"withAudio",t,"trackId",s);try{const l=await oi({screen:r,screenAudio:t==="auto"?c.supportShareAudio:t==="enable"},s);o=l.getVideoTracks()[0]||null,a=l.getAudioTracks()[0]||null}catch(l){throw e.onError(l),l}if(!o){const l=new G(v.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(l),l.throw(m)}if(!a&&t==="enable"){o&&o.stop();const l=new G(v.SHARE_AUDIO_NOT_ALLOWED);return e.onError(l),l.throw(m)}n.optimizationMode||(n.optimizationMode="detail"),n.optimizationMode&&(s_(s,o,n,n.encoderConfig&&Wp(n.encoderConfig)||void 0),n.encoderConfig&&typeof n.encoderConfig!="string"&&(n.encoderConfig.bitrateMin=n.encoderConfig.bitrateMax));const d=new Ct(o,n.encoderConfig?Wp(n.encoderConfig):{},n.scalabiltyMode?su(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,s,[$t.SCREEN_TRACK]);if(i&&d.startMonitorStats(),!a)return e.onSuccess(d.getTrackId()),m.info("create screen video track success","video:",d.getTrackId()),d;const u=new Vt(a,void 0,Qt(8,"track-scr-a-"),!1,!0);return e.onSuccess([d.getTrackId(),u.getTrackId()]),m.info("create screen video track success","video:",d.getTrackId(),"audio:",u.getTrackId()),[d,u]},createMicrophoneAndCameraTracks:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_MIC_AND_CAM_TRACKS,options:[n,t]}),i=t.encoderConfig==="720p_auto",r=hu(t),s=ev(n),o=Qt(8,"track-mic-"),a=Qt(8,"track-cam-");let c=null,d=null;m.info("start create camera video track(".concat(a,") and microphone audio track(").concat(o,") with config, audio: ").concat(JSON.stringify(n),", video: ").concat(JSON.stringify(t)));try{const p=await oi({audio:s,video:r},"".concat(o,"-").concat(a));c=p.getAudioTracks()[0],d=p.getVideoTracks()[0]}catch(p){throw e.onError(p),p}if(!c||!d){const p=new G(v.UNEXPECTED_ERROR,"can not find tracks in media stream");return e.onError(p),p.throw(m)}t.optimizationMode&&s_(a,d,t,dr(t.encoderConfig));const u=new $s(c,n,s,o),l=new ds(d,t,r,t.scalabiltyMode?su(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,a);return i&&l.startMonitorStats(),e.onSuccess([u.getTrackId(),l.getTrackId()]),m.info("create camera video track(".concat(a,") and microphone audio track(").concat(o,") success")),[u,l]},createMicrophoneAudioTrack:async function(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_MIC_AUDIO_TRACK,options:[n]}),e=ev(n),i=Qt(8,"track-mic-");let r=null;m.info("start create microphone audio track with config",JSON.stringify(n),"trackId",i);try{r=(await oi({audio:e},i)).getAudioTracks()[0]||null}catch(o){throw t.onError(o),o}if(!r){const o=new G(v.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(o),o.throw(m)}const s=new $s(r,n,e,i);return t.onSuccess(s.getTrackId()),m.info("create microphone audio track success, trackId:",i),s},createCustomAudioTrack:function(n){const t=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_CUSTOM_AUDIO_TRACK,options:[n]}),e=new Vt(n.mediaStreamTrack,n.encoderConfig?ou(n.encoderConfig):{},Qt(8,"track-cus-"),!1,!0);return m.info("create custom audio track success with config",n,"trackId",e.getTrackId()),t.onSuccess(e.getTrackId()),e},createBufferSourceAudioTrack:async function(n){var t;const{cacheOnlineFile:e,encoderConfig:i}=n;let{source:r}=n;const s={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":r,cacheOnlineFile:e,encoderConfig:i},o=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(O("DISABLE_WEBAUDIO"))throw new G(v.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=Qt(8,"track-buf-");m.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",a);const c=r;if(!(r instanceof AudioBuffer))try{r=await YM(r,e)}catch(l){return o.onError(l),l.throw(m)}const d=new KM(r),u=new cs(c,d,i?ou(i):{},a);return m.info("create buffer source audio track success, trackId:",a),o.onSuccess(u.getTrackId()),u},setAppType:function(n){if(m.debug("setAppType: ".concat(n)),!(Number.isInteger(n)&&n>=0))throw m.debug("Invalid appType"),new k(v.INVALID_PARAMS,"invalid app type",n);Ht("APP_TYPE",Math.floor(n))},setLogLevel:function(n){m.setLogLevel(n)},enableLogUpload:function(){O("USE_NEW_LOG")?Ht("UPLOAD_LOG",!0):m.enableLogUpload()},disableLogUpload:function(){O("USE_NEW_LOG")?Ht("UPLOAD_LOG",!1):m.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Pu},checkAudioTrackIsActive:async function(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const e=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(n instanceof Vt||n instanceof ki)){const c=new k(v.INVALID_TRACK,"the parameter is not a audio track");return e.onError(c),c.throw()}t&&t<1e3&&(t=1e3);const i=n instanceof Vt?n.getTrackLabel():"remote_track",r=n.getVolumeLevel();let s=r,o=r;const a=Date.now();return new F(c=>{const d=setInterval(()=>{const u=n.getVolumeLevel();s=u>s?u:s,o=u<o?u:o;const l=s-o>1e-4,p=Date.now()-a;if(l||p>t){clearInterval(d);const _=l,R={duration:p,deviceLabel:i,maxVolumeLevel:s,result:_};m.info("[track-".concat(n.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(R))),e.onSuccess(R),c(_)}},200)})},checkVideoTrackIsActive:async function(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const e=st.reportApiInvoke(null,{tag:ce.TRACER,name:Ae.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(n instanceof Ct||n instanceof ur)){const l=new k(v.INVALID_TRACK,"the parameter is not a video track");return e.onError(l),l.throw()}t&&t<1e3&&(t=1e3);const i=n instanceof Ct?n.getTrackLabel():"remote_track",r=n.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(fn()||Od())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([r]),s.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const l=Date.now();a=await function(p,_,R,f){let T,A=0,N=null;return new F((P,j)=>{function M(){A>f&&T&&(T(),P(A));const U=R.getContext("2d");if(!U){const q=new k(v.UNEXPECTED_ERROR,"can not get canvas 2d context.");return m.error(q.toString()),void j(q)}U.drawImage(p,0,0,160,120);const B=U.getImageData(0,0,R.width,R.height),V=Math.floor(B.data.length/3);if(N){for(let q=0;q<V;q+=3)if(B.data[q]!==N[q])return A+=1,void(N=B.data);N=B.data}else N=B.data}setTimeout(()=>{T&&(T(),P(A))},_),T=Xp(()=>{M()},30)})}(s,t,o,4),c=Date.now()-l}catch(l){throw e.onError(l),l}q2===xt.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const d=a>4,u={duration:c,changedPicNum:a,deviceLabel:i,result:d};return m.info("[track-".concat(n.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(u))),e.onSuccess(u),d},setArea:xp,audioElementPlayCenter:Un,resumeAudioContext:function(){Un.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(n){X2.processExternalMediaAEC(n)},registerExtensions:function(n){const t=O("PLUGIN_INFO")||[];n.forEach(e=>{"name"in e&&!nt(t).call(t,e.name)&&t.push(e.name);const i=e;i.__registered__=!0,i.logger.hookLog=m.extLog,i.reporter.hookApiInvoke=st.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(r=>{i.parameters[r]=O(r)})}),CI("PLUGIN_INFO",t)},ChannelMediaRelayError:es,ChannelMediaRelayEvent:qi,ChannelMediaRelayState:In,RemoteStreamFallbackType:Kp,RemoteStreamType:Hp,ConnectionDisconnectedReason:Ot,AudienceLatencyLevelType:Jh,AREAS:Pt});return Object.defineProperties(ye,{onAudioAutoplayFailed:{get:()=>ci.onAudioAutoplayFailed,set:n=>{ci.onAudioAutoplayFailed=n}},onAutoplayFailed:{get:()=>ci.onAutoplayFailed,set:n=>{ci.onAutoplayFailed=n}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>ye._onSecurityPolicyViolation,set(n){ye._onSecurityPolicyViolation=n,RI(n)}},__CLIENT_LIST__:{get:()=>O("SHOW_GLOBAL_CLIENT_LIST")?$r:[]}}),ai.on(Or.CAMERA_DEVICE_CHANGED,n=>{m.info("camera device changed",JSON.stringify(n)),ye.onCameraChanged&&ye.onCameraChanged(n),ye.safeEmit(Di.CAMERA_CHANGED,n)}),ai.on(Or.RECORDING_DEVICE_CHANGED,n=>{m.info("microphone device changed",JSON.stringify(n)),ye.onMicrophoneChanged&&ye.onMicrophoneChanged(n),ye.safeEmit(Di.MICROPHONE_CHANGED,n)}),ai.on(Or.PLAYOUT_DEVICE_CHANGED,n=>{m.debug("playout device changed",JSON.stringify(n)),ye.onPlaybackDeviceChanged&&ye.onPlaybackDeviceChanged(n),ye.safeEmit(Di.PLAYBACK_DEVICE_CHANGED,n)}),Un.onAutoplayFailed=()=>{m.info("detect audio element autoplay failed"),ci.onAudioAutoplayFailed&&ci.onAudioAutoplayFailed()},jt.on("autoplay-failed",()=>{m.info("detect webaudio autoplay failed"),ci.onAudioAutoplayFailed&&ci.onAudioAutoplayFailed(),ye.safeEmit(Di.AUTOPLAY_FAILED)}),jt.on(xe.STATE_CHANGE,(n,t)=>{m.info("audio context state changed: ".concat(t," => ").concat(n)),ye.onAudioContextStateChanged&&ye.onAudioContextStateChanged(n,t),ye.safeEmit(Di.AUDIO_CONTEXT_STATE_CHANGED,n,t)}),Re.on(yr.NETWORK_STATE_CHANGE,(n,t)=>{m.info("[network-indicator] network state changed, ".concat(t," => ").concat(n))}),window&&(window.__ARTC__=ye),ye})})(mA);var ZF=mA.exports;const lB=Z2(ZF);export{lB as A,uB as G,Vr as _,Ox as a,dB as b,FF as c,Sm as f,HF as w};
